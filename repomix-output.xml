This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: app/Models, app/Http/Controllers, routes, database/migrations
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/Http/Controllers/ActivityLogController.php
app/Http/Controllers/ApplicationTypesController.php
app/Http/Controllers/AttributeController.php
app/Http/Controllers/AttributeValueController.php
app/Http/Controllers/Auth/ConfirmPasswordController.php
app/Http/Controllers/Auth/ForgotPasswordController.php
app/Http/Controllers/Auth/LoginController.php
app/Http/Controllers/Auth/RegisterController.php
app/Http/Controllers/Auth/ResetPasswordController.php
app/Http/Controllers/Auth/VerificationController.php
app/Http/Controllers/CategoryController.php
app/Http/Controllers/ClienteController.php
app/Http/Controllers/Controller.php
app/Http/Controllers/DesignController.php
app/Http/Controllers/DesignExportController.php
app/Http/Controllers/DesignPreviewController.php
app/Http/Controllers/DesignVariantController.php
app/Http/Controllers/EstadoController.php
app/Http/Controllers/GiroController.php
app/Http/Controllers/HomeController.php
app/Http/Controllers/ImageController.php
app/Http/Controllers/InventoryMovementController.php
app/Http/Controllers/MaterialCategoryController.php
app/Http/Controllers/MaterialController.php
app/Http/Controllers/MaterialUnitConversionController.php
app/Http/Controllers/MaterialVariantController.php
app/Http/Controllers/ProduccionController.php
app/Http/Controllers/ProductCategoryController.php
app/Http/Controllers/ProductController.php
app/Http/Controllers/ProductExtraController.php
app/Http/Controllers/ProductVariantController.php
app/Http/Controllers/ProveedorController.php
app/Http/Controllers/PurchaseController.php
app/Http/Controllers/PurchaseItemController.php
app/Http/Controllers/PurchaseReceptionController.php
app/Http/Controllers/PurchaseReceptionItemController.php
app/Http/Controllers/RecomendacionController.php
app/Http/Controllers/SearchController.php
app/Http/Controllers/SystemSettingController.php
app/Http/Controllers/UnitController.php
app/Models/ActivityLog.php
app/Models/Application_types.php
app/Models/Attribute.php
app/Models/AttributeValue.php
app/Models/Category.php
app/Models/Cliente.php
app/Models/Design.php
app/Models/DesignExport.php
app/Models/DesignVariant.php
app/Models/DesignVariantImage.php
app/Models/Estado.php
app/Models/Giro.php
app/Models/Image.php
app/Models/InventoryMovement.php
app/Models/Material.php
app/Models/MaterialCategory.php
app/Models/MaterialUnitConversion.php
app/Models/MaterialVariant.php
app/Models/Product.php
app/Models/ProductCategory.php
app/Models/ProductExtra.php
app/Models/ProductMaterial.php
app/Models/ProductVariant.php
app/Models/Proveedor.php
app/Models/Purchase.php
app/Models/PurchaseItem.php
app/Models/PurchaseReception.php
app/Models/PurchaseReceptionItem.php
app/Models/Recomendacion.php
app/Models/SearchIndex.php
app/Models/SystemSetting.php
app/Models/Unit.php
app/Models/User.php
database/migrations/0001_01_01_000000_create_users_table.php
database/migrations/0001_01_01_000001_create_cache_table.php
database/migrations/0001_01_01_000002_create_jobs_table.php
database/migrations/2025_12_16_174359_create_permission_tables.php
database/migrations/2025_12_16_174450_create_giros_table.php
database/migrations/2025_12_16_174451_create_estados_table.php
database/migrations/2025_12_16_175802_create_proveedors_table.php
database/migrations/2025_12_18_045304_create_recomendacions_table.php
database/migrations/2025_12_18_055620_create_clientes_table.php
database/migrations/2025_12_19_172828_create_categories_table.php
database/migrations/2025_12_19_172849_create_designs_table.php
database/migrations/2025_12_19_172856_create_design_variants_table.php
database/migrations/2025_12_19_172905_create_attributes_table.php
database/migrations/2025_12_19_172911_create_attribute_values_table.php
database/migrations/2025_12_19_172926_create_images_table.php
database/migrations/2025_12_19_172936_create_category_design_table.php
database/migrations/2025_12_19_172942_create_design_variant_attributes_table.php
database/migrations/2025_12_20_150609_create_design_variant_images_table.php
database/migrations/2025_12_24_160930_create_application_types_table.php
database/migrations/2025_12_24_161013_create_design_exports_table.php
database/migrations/2025_12_27_000001_add_image_id_to_design_exports_table.php
database/migrations/2025_12_27_000001_create_search_index_table.php
database/migrations/2025_12_27_153719_add_thumbnail_fields_to_images_table.php
database/migrations/2025_12_30_120441_create_product_categories_table.php
database/migrations/2025_12_30_120458_create_product_extras_table.php
database/migrations/2025_12_30_121830_create_products_table.php
database/migrations/2025_12_30_121919_create_product_design_table.php
database/migrations/2025_12_30_122410_create_product_variants_table.php
database/migrations/2025_12_30_122508_create_product_variant_design_table.php
database/migrations/2025_12_30_122818_create_product_extra_assignment_table.php
database/migrations/2025_12_30_124341_create_product_variant_attribute_table.php
database/migrations/2026_01_02_191615_create_units_table.php
database/migrations/2026_01_03_013052_create_system_settings_table.php
database/migrations/2026_01_03_094357_create_activity_logs_table.php
database/migrations/2026_01_03_102946_create_material_categories.php
database/migrations/2026_01_03_103133_create_materials.php
database/migrations/2026_01_03_103227_create_material_variants.php
database/migrations/2026_01_03_103255_create_material_unit_conversions.php
database/migrations/2026_01_03_142851_add_compatible_base_unit_to_units_table.php
database/migrations/2026_01_03_150526_create_purchases_table.php
database/migrations/2026_01_03_150553_create_purchase_items_table.php
database/migrations/2026_01_03_150625_create_inventory_movements_table.php
database/migrations/2026_01_04_090517_create_purchase_receptions_table.php
database/migrations/2026_01_04_090551_create_purchase_reception_items_table.php
database/migrations/2026_01_05_000000_create_product_materials_table.php
routes/api.php
routes/console.php
routes/search.php
routes/web.php
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/Http/Controllers/ActivityLogController.php">
<?php

namespace App\Http\Controllers;

use App\Models\ActivityLog;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Exception;

class ActivityLogController extends Controller
{
    private const ALLOWED_ACTIONS = ['created', 'updated', 'deleted', 'restored', 'login', 'logout'];
    private const MAX_PER_PAGE = 50;

    public function __construct(
        private readonly ActivityLog $activityLog
    ) {}

    public function index(Request $request): View
    {
        try {
            $validated = $request->validate([
                'user_id'   => ['nullable', 'integer', 'exists:users,id'],
                'action'    => ['nullable', 'string', 'in:' . implode(',', self::ALLOWED_ACTIONS)],
                'date_from' => ['nullable', 'date', 'date_format:Y-m-d'],
                'date_to'   => ['nullable', 'date', 'date_format:Y-m-d', 'after_or_equal:date_from'],
                'search'    => ['nullable', 'string', 'max:100'],
            ]);

            $query = $this->activityLog->newQuery()
                ->with('user')
                ->latest();

            $query->when($request->filled('user_id'), fn($q) => $q->where('user_id', $validated['user_id']))
                ->when($request->filled('action'), fn($q) => $q->where('action', $validated['action']))
                ->when($request->filled('date_from'), fn($q) => $q->whereDate('created_at', '>=', $validated['date_from']))
                ->when($request->filled('date_to'), fn($q) => $q->whereDate('created_at', '<=', $validated['date_to']));

            if ($request->filled('search')) {
                $search = $validated['search'];
                $query->where(function ($q) use ($search) {
                    $q->where('model_name', 'like', "%{$search}%")
                        ->orWhere('description', 'like', "%{$search}%")
                        ->orWhere('user_name', 'like', "%{$search}%")
                        ->orWhere('ip_address', 'like', "%{$search}%");
                });
            }

            return view('admin.activity-logs.index', [
                'logs'    => $query->paginate(self::MAX_PER_PAGE)->withQueryString(),
                'users'   => User::orderBy('name')->pluck('name', 'id'),
                'actions' => self::ALLOWED_ACTIONS
            ]);
        } catch (Exception $e) {
            Log::error("Error en ActivityLogController@index: " . $e->getMessage(), [
                'user_id' => Auth::id(),
                'trace'   => $e->getTraceAsString()
            ]);

            return view('admin.activity-logs.index', [
                'logs'    => $this->activityLog->newQuery()->paginate(self::MAX_PER_PAGE),
                'users'   => collect(),
                'actions' => self::ALLOWED_ACTIONS
            ])->with('error', 'Error interno al cargar la auditoría.');
        }
    }

    /**
     * Muestra el detalle de un log específico por UUID.
     */
    public function show(string $uuid): View|RedirectResponse
    {
        try {
            // Buscamos el registro asegurando limpieza del input
            $log = $this->activityLog->where('uuid', trim($uuid))->first();

            if (!$log) {
                Log::warning("Actividad no encontrada: UUID '{$uuid}'", [
                    'ip'      => request()->ip(),
                    'user_id' => Auth::id()
                ]);

                return redirect()->route('activity-logs.index')
                    ->with('error', 'El registro de actividad solicitado no existe.');
            }

            return view('admin.activity-logs.show', compact('log'));
        } catch (Exception $e) {
            Log::error("Fallo crítico en ActivityLogController@show: " . $e->getMessage(), [
                'uuid'    => $uuid,
                'user_id' => Auth::id()
            ]);

            return redirect()->route('activity-logs.index')
                ->with('error', 'Ocurrió un error al procesar la solicitud.');
        }
    }
}
</file>

<file path="app/Http/Controllers/ApplicationTypesController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Application_types;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;

class ApplicationTypesController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $aplication_types = Application_types::all()->where('activo', true);
        return view('admin.tipos_aplicacion.index', compact('aplication_types'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.tipos_aplicacion.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre_aplicacion' => ['required', 'string', 'max:255', 'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/'],
        ]);
        try {
            $aplication_types = new Application_types();
            $aplication_types->nombre_aplicacion = strtoupper(trim($request->nombre_aplicacion));
            $aplication_types->slug = Str::slug($request->nombre_aplicacion);
            $aplication_types->save();
            return redirect()->route('admin.tipos_aplicacion.index')->with('success', 'Tipo de aplicación guardado exitosamente');
        } catch (\Exception $e) {
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Error al guardar el tipo de aplicación: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Application_types $application_types)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $aplication_types = Application_types::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$aplication_types) {
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Tipo de aplicación no encontrado');
        }
        return view('admin.tipos_aplicacion.edit', compact('aplication_types'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_aplicacion' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:application_types,nombre_aplicacion,' . $id,
            ],
        ]);
        try {
            $aplication_types = Application_types::where('id', $id)
                ->where('activo', true)
                ->firstOrFail();
            $aplication_types->nombre_aplicacion = strtoupper(trim($request->nombre_aplicacion));

            //validamos si hubo algun cambio o modificacion en el valor del campo nombre_estado, si no hubo cambios, no se actualiza
            if (! $aplication_types->isDirty()) {
                // return back()->with('info', 'No se realizaron cambios');
                return redirect()->route('admin.tipos_aplicacion.index')->with('info', 'No se realizaron cambios');
            }

            $aplication_types->save();
            return redirect()->route('admin.tipos_aplicacion.index')->with('success', 'Tipo de aplicación actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el tipo de aplicación: ' . $e->getMessage());
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Error al actualizar el tipo de aplicación');
        }
    }

    public function confirm_delete($id)
    {
        //validando que existe el giro
        $aplication_types = Application_types::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$aplication_types) {
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Tipo de aplicación no encontrado');
        }
        return view('admin.tipos_aplicacion.delete', compact('aplication_types'));
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy($id)
    {
        $aplication_types = Application_types::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$aplication_types) {
            return redirect()->route('admin.tipos_aplicacion.confirm_delete', $id)->with('error', 'Tipo de aplicación no encontrado');
        }
        try {
            $aplication_types->activo = false;
            $aplication_types->save();
            return redirect()->route('admin.tipos_aplicacion.index')->with('success', 'Tipo de aplicación eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el tipo de aplicación: ' . $e->getMessage());
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Error al eliminar el tipo de aplicación');
        }
    }
}
</file>

<file path="app/Http/Controllers/Auth/ConfirmPasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\ConfirmsPasswords;

class ConfirmPasswordController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Confirm Password Controller
    |--------------------------------------------------------------------------
    |
    | This controller is responsible for handling password confirmations and
    | uses a simple trait to include the behavior. You're free to explore
    | this trait and override any functions that require customization.
    |
    */

    use ConfirmsPasswords;

    /**
     * Where to redirect users when the intended url fails.
     *
     * @var string
     */
    protected $redirectTo = '/home';

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('auth');
    }
}
</file>

<file path="app/Http/Controllers/Auth/ForgotPasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\SendsPasswordResetEmails;

class ForgotPasswordController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Password Reset Controller
    |--------------------------------------------------------------------------
    |
    | This controller is responsible for handling password reset emails and
    | includes a trait which assists in sending these notifications from
    | your application to your users. Feel free to explore this trait.
    |
    */

    use SendsPasswordResetEmails;
}
</file>

<file path="app/Http/Controllers/Auth/LoginController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\AuthenticatesUsers;

class LoginController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Login Controller
    |--------------------------------------------------------------------------
    |
    | This controller handles authenticating users for the application and
    | redirecting them to your home screen. The controller uses a trait
    | to conveniently provide its functionality to your applications.
    |
    */

    use AuthenticatesUsers;

    /**
     * Where to redirect users after login.
     *
     * @var string
     */
    protected $redirectTo = '/home';

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('guest')->except('logout');
        $this->middleware('auth')->only('logout');
    }
}
</file>

<file path="app/Http/Controllers/Auth/RegisterController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Foundation\Auth\RegistersUsers;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Validator;

class RegisterController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Register Controller
    |--------------------------------------------------------------------------
    |
    | This controller handles the registration of new users as well as their
    | validation and creation. By default this controller uses a trait to
    | provide this functionality without requiring any additional code.
    |
    */

    use RegistersUsers;

    /**
     * Where to redirect users after registration.
     *
     * @var string
     */
    protected $redirectTo = '/home';

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('guest');
    }

    /**
     * Get a validator for an incoming registration request.
     *
     * @param  array  $data
     * @return \Illuminate\Contracts\Validation\Validator
     */
    protected function validator(array $data)
    {
        return Validator::make($data, [
            'name' => ['required', 'string', 'max:255'],
            'email' => ['required', 'string', 'email', 'max:255', 'unique:users'],
            'password' => ['required', 'string', 'min:8', 'confirmed'],
        ]);
    }

    /**
     * Create a new user instance after a valid registration.
     *
     * @param  array  $data
     * @return \App\Models\User
     */
    protected function create(array $data)
    {
        return User::create([
            'name' => $data['name'],
            'email' => $data['email'],
            'password' => Hash::make($data['password']),
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/ResetPasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\ResetsPasswords;

class ResetPasswordController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Password Reset Controller
    |--------------------------------------------------------------------------
    |
    | This controller is responsible for handling password reset requests
    | and uses a simple trait to include this behavior. You're free to
    | explore this trait and override any methods you wish to tweak.
    |
    */

    use ResetsPasswords;

    /**
     * Where to redirect users after resetting their password.
     *
     * @var string
     */
    protected $redirectTo = '/home';
}
</file>

<file path="app/Http/Controllers/Auth/VerificationController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\VerifiesEmails;

class VerificationController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Email Verification Controller
    |--------------------------------------------------------------------------
    |
    | This controller is responsible for handling email verification for any
    | user that recently registered with the application. Emails may also
    | be re-sent if the user didn't receive the original email message.
    |
    */

    use VerifiesEmails;

    /**
     * Where to redirect users after verification.
     *
     * @var string
     */
    protected $redirectTo = '/home';

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('auth');
        $this->middleware('signed')->only('verify');
        $this->middleware('throttle:6,1')->only('verify', 'resend');
    }
}
</file>

<file path="app/Http/Controllers/ClienteController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Cliente;
use App\Models\Recomendacion;
use App\Models\Estado;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class ClienteController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $clientes = Cliente::where('activo', true)->with('estado', 'recomendacion')->get();
        return view('admin.clientes.index', compact('clientes'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        $recomendaciones = Recomendacion::all();
        $estados = Estado::all();
        return view('admin.clientes.create', compact('recomendaciones', 'estados'));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre' => ['required', 'string', 'max:255'],
            'apellidos' => ['required', 'string', 'max:255'],
            'telefono' => ['required', 'regex:/^[0-9]{10}$/', 'unique:clientes,telefono'],
            'email' => ['nullable', 'email', 'unique:clientes,email'],
            'direccion' => ['nullable', 'string', 'max:255'],
            'ciudad' => ['required', 'string', 'max:255'],
            'codigo_postal' => ['nullable', 'max:5', 'regex:/^[0-9]{5}$/'],
            'fecha_baja' => 'nullable',
            'motivo_baja' => ['nullable', 'string', 'max:255'],
            'observaciones' => ['nullable', 'string'],
            'estado_id' => ['required', 'exists:estados,id'],
            'recomendacion_id' => ['required', 'exists:recomendacion,id'],
            'busto' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'alto_cintura' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'cintura' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'cadera' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'largo' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
        ]);

        try {
            $cliente = new Cliente();
            $cliente->nombre = mb_strtoupper(trim($request->nombre), 'UTF-8');
            $cliente->apellidos = mb_strtoupper(trim($request->apellidos), 'UTF-8');
            $cliente->telefono = $request->telefono;
            $cliente->email = $request->email;
            $cliente->direccion = mb_strtoupper(trim($request->direccion), 'UTF-8');
            $cliente->ciudad = mb_strtoupper(trim($request->ciudad), 'UTF-8');
            $cliente->codigo_postal = $request->codigo_postal;
            $cliente->observaciones = mb_strtoupper(trim($request->observaciones), 'UTF-8');
            $cliente->estado_id = $request->estado_id;
            $cliente->recomendacion_id = $request->recomendacion_id;
            $cliente->busto = $request->busto;
            $cliente->alto_cintura = $request->alto_cintura;
            $cliente->cintura = $request->cintura;
            $cliente->cadera = $request->cadera;
            $cliente->largo = $request->largo;
            $cliente->save();
            return redirect()->route('admin.clientes.index')->with('success', 'Cliente creado correctamente');
        } catch (\Exception $e) {
            Log::error('Error al crear el cliente: ' . $e->getMessage());
            return redirect()->route('admin.clientes.index')->with('error', 'Error al crear el cliente: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Cliente $cliente)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $cliente = Cliente::where('activo', true)->with('estado', 'recomendacion')->findOrFail($id);
        $recomendaciones = Recomendacion::all();
        $estados = Estado::all();
        return view('admin.clientes.edit', compact('cliente', 'recomendaciones', 'estados'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {


        $request->validate([
            'nombre' => ['required', 'string', 'max:255'],
            'apellidos' => ['required', 'string', 'max:255'],
            'telefono' => ['required', 'regex:/^[0-9]{10}$/', 'unique:clientes,telefono,' . $id],
            'email' => ['nullable', 'email', 'unique:clientes,email,' . $id],
            'direccion' => ['nullable', 'string', 'max:255'],
            'codigo_postal' => ['nullable', 'max:5', 'regex:/^[0-9]{5}$/'],
            'ciudad' => ['required', 'string', 'max:255'],
            'fecha_baja' => 'nullable',
            'motivo_baja' => ['nullable', 'string', 'max:255'],
            'observaciones' => ['nullable', 'string'],
            'estado_id' => ['required', 'exists:estados,id'],
            'recomendacion_id' => ['required', 'exists:recomendacion,id'],
            'busto' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'alto_cintura' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'cintura' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'cadera' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'largo' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
        ]);

        try {
            $cliente = Cliente::where('activo', true)->with('estado', 'recomendacion')->findOrFail($id);
            $cliente->nombre = mb_strtoupper(trim($request->nombre), 'UTF-8');
            $cliente->apellidos = mb_strtoupper(trim($request->apellidos), 'UTF-8');
            $cliente->telefono = $request->telefono;
            $cliente->email = $request->email;
            $cliente->direccion = mb_strtoupper(trim($request->direccion), 'UTF-8');
            $cliente->ciudad = mb_strtoupper(trim($request->ciudad), 'UTF-8');
            $cliente->codigo_postal = $request->codigo_postal;
            $cliente->observaciones = mb_strtoupper(trim($request->observaciones ?? ''), 'UTF-8');
            $cliente->estado_id = $request->estado_id;
            $cliente->recomendacion_id = $request->recomendacion_id;
            $cliente->busto = $request->busto;
            $cliente->alto_cintura = $request->alto_cintura;
            $cliente->cintura = $request->cintura;
            $cliente->cadera = $request->cadera;
            $cliente->largo = $request->largo;

            if (!$cliente->isDirty()) {
                return redirect()->route('admin.clientes.index')->with('warning', 'No se realizaron cambios');
            }

            $cliente->save();
            return redirect()->route('admin.clientes.index')->with('success', 'Cliente actualizado correctamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el cliente: ' . $e->getMessage());
            return redirect()->route('admin.clientes.index')->with('error', 'Error al actualizar el cliente: ' . $e->getMessage());
        }
    }

    /**
     * Remove the specified resource from storage.
     */

    public function confirm_delete($id)
    {
        $cliente = Cliente::where('activo', true)->with('estado', 'recomendacion')->findOrFail($id);
        $estados = Estado::all();
        $recomendaciones = Recomendacion::all();
        return view('admin.clientes.delete', compact('cliente', 'estados', 'recomendaciones'));
    }

    public function destroy($id)
    {
        try {
            $cliente = Cliente::where('activo', true)->with('estado', 'recomendacion')->findOrFail($id);
            $cliente->activo = false;
            $cliente->fecha_baja = now();
            $cliente->save();
            return redirect()->route('admin.clientes.index')->with('success', 'Cliente eliminado correctamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el cliente: ' . $e->getMessage());
            return redirect()->route('admin.clientes.index')->with('error', 'Error al eliminar el cliente: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/DesignPreviewController.php">
<?php

namespace App\Http\Controllers;

use App\Models\DesignExport;
use App\Services\EmbroideryAnalyzerService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;

class DesignPreviewController extends Controller
{
    protected EmbroideryAnalyzerService $analyzer;

    public function __construct(EmbroideryAnalyzerService $analyzer)
    {
        $this->analyzer = $analyzer;
    }

    /**
     * Retorna la vista previa SVG de una exportación de diseño.
     * Utiliza cache para evitar ejecuciones repetidas de Python.
     */
    public function preview(Request $request, DesignExport $export)
    {
        // El cache se basa en el ID de la exportación y la fecha de actualización
        // para asegurar que si el archivo cambia, la vista previa se regenere.
        // v2: Agregado viewBox ajustado y padding.
        $cacheKey = "embroidery_preview_svg_v2_{$export->id}_{$export->updated_at->timestamp}";

        try {
            $svgContent = Cache::remember($cacheKey, now()->addDays(7), function () use ($export) {
                if (!$export->file_path || !Storage::disk('public')->exists($export->file_path)) {
                    return null;
                }

                $fullPath = Storage::disk('public')->path($export->file_path);

                Log::info("Generando preview SVG para exportación #{$export->id}");
                return $this->analyzer->generateSvg($fullPath);
            });

            if (!$svgContent) {
                return response()->json(['error' => 'No se pudo generar la vista previa'], 404);
            }

            // --- Soporte Especial para Explorador Interactivo ---

            // 1. Si se solicita descarga
            if ($request->has('download')) {
                return response($svgContent, 200)
                    ->header('Content-Type', 'image/svg+xml')
                    ->header('Content-Disposition', 'attachment; filename="diseno_' . $export->id . '.svg"');
            }

            // 2. DetecciÃ³n de Explorador (PÃ¡gina con herramientas)
            // Se activa si tiene ?explorer=1 o si es una navegaciÃ³n directa del navegador (Sec-Fetch-Dest: document)
            $fetchDest = $request->header('Sec-Fetch-Dest');
            $isDirectVisit = ($fetchDest === 'document') || ($request->has('explorer'));

            if ($isDirectVisit && !$request->ajax()) {
                return view('admin.produccion.preview_explorer', [
                    'export' => $export,
                    'svgContent' => $svgContent
                ]);
            }

            // 3. Respuesta estÃ¡ndar: Imagen SVG pura (para tags <img>)
            return response($svgContent, 200)
                ->header('Content-Type', 'image/svg+xml')
                ->header('Cache-Control', 'public, max-age=604800, immutable'); // Cache del navegador por 7 dÃ­as

        } catch (\Exception $e) {
            Log::error("Error en DesignPreviewController: " . $e->getMessage());
            return response()->json(['error' => 'Error interno al procesar la vista previa'], 500);
        }
    }
}
</file>

<file path="app/Http/Controllers/HomeController.php">
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class HomeController extends Controller
{
    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('auth');
    }

    /**
     * Show the application dashboard.
     *
     * @return \Illuminate\Contracts\Support\Renderable
     */
    public function index()
    {
        return view('home');
    }
}
</file>

<file path="app/Http/Controllers/InventoryMovementController.php">
<?php

namespace App\Http\Controllers;

use App\Models\InventoryMovement;
use Illuminate\Http\Request;

class InventoryMovementController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(InventoryMovement $inventoryMovement)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(InventoryMovement $inventoryMovement)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, InventoryMovement $inventoryMovement)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(InventoryMovement $inventoryMovement)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/MaterialCategoryController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\MaterialCategoryRequest;
use App\Models\MaterialCategory;
use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class MaterialCategoryController extends Controller
{
    public function index()
    {
        try {
            $categories = MaterialCategory::where('activo', true)
                ->with('baseUnit')
                ->withCount(['materials' => fn($q) => $q->where('activo', true)])
                ->ordered()
                ->get();

            return view('admin.material-categories.index', compact('categories'));
        } catch (\Exception $e) {
            Log::error('Error al listar categorías de materiales: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return view('admin.material-categories.index', ['categories' => collect()])
                ->with('error', 'Error al cargar las categorías');
        }
    }

    public function create()
    {
        try {
            $units = Unit::where('activo', true)
                ->where('is_base', true)
                ->ordered()
                ->get();

            return view('admin.material-categories.create', compact('units'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de categoría: ' . $e->getMessage());
            return redirect()->route('material-categories.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    public function store(MaterialCategoryRequest $request)
    {
        try {
            DB::beginTransaction();

            $category = new MaterialCategory();
            $category->name = mb_strtoupper(trim($request->name));
            $category->slug = Str::slug($request->name);
            $category->description = $request->filled('description')
                ? trim($request->description)
                : null;
            $category->base_unit_id = (int) $request->base_unit_id;
            $category->has_color = $request->boolean('has_color');
            $category->activo = true;
            $category->save();

            DB::commit();

            Log::info('Categoría de material creada', [
                'category_id' => $category->id,
                'name' => $category->name,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('material-categories.index')
                ->with('success', 'Categoría creada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al crear categoría de material: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'request' => $request->validated(),
            ]);

            return redirect()->route('material-categories.index')
                ->with('error', 'Error al crear la categoría');
        }
    }

    public function edit($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('material-categories.index')
                    ->with('error', 'Categoría no válida');
            }

            $category = MaterialCategory::where('activo', true)->findOrFail((int) $id);

            $units = Unit::where('activo', true)
                ->where('is_base', true)
                ->ordered()
                ->get();

            return view('admin.material-categories.edit', compact('category', 'units'));
        } catch (\Exception $e) {
            Log::error('Error al cargar categoría para editar: ' . $e->getMessage());
            return redirect()->route('material-categories.index')
                ->with('error', 'Categoría no encontrada');
        }
    }

    public function update(MaterialCategoryRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('material-categories.index')
                    ->with('error', 'Categoría no válida');
            }

            DB::beginTransaction();

            $category = MaterialCategory::where('activo', true)->findOrFail((int) $id);

            $category->name = mb_strtoupper(trim($request->name));
            $category->slug = Str::slug($request->name);
            $category->description = $request->filled('description')
                ? trim($request->description)
                : null;
            $category->base_unit_id = (int) $request->base_unit_id;
            $category->has_color = $request->boolean('has_color');

            if (!$category->isDirty()) {
                return redirect()->route('material-categories.index')
                    ->with('info', 'No se realizaron cambios');
            }

            $category->save();

            DB::commit();

            Log::info('Categoría de material actualizada', [
                'category_id' => $category->id,
                'name' => $category->name,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('material-categories.index')
                ->with('success', 'Categoría actualizada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar categoría: ' . $e->getMessage(), [
                'category_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('material-categories.index')
                ->with('error', 'Error al actualizar la categoría');
        }
    }

    public function confirmDelete($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('material-categories.index')
                    ->with('error', 'Categoría no válida');
            }

            $category = MaterialCategory::where('activo', true)
                ->with('baseUnit')
                ->findOrFail((int) $id);

            return view('admin.material-categories.delete', compact('category'));
        } catch (\Exception $e) {
            Log::error('Error al cargar categoría para eliminar: ' . $e->getMessage());
            return redirect()->route('material-categories.index')
                ->with('error', 'Categoría no encontrada');
        }
    }

    public function destroy($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('material-categories.index')
                    ->with('error', 'Categoría no válida');
            }

            DB::beginTransaction();

            $category = MaterialCategory::where('activo', true)->findOrFail((int) $id);

            $validation = $category->canDelete();
            if (!$validation['can_delete']) {
                return redirect()->route('material-categories.index')
                    ->with('error', $validation['message']);
            }

            $category->activo = false;
            $category->save();

            DB::commit();

            Log::info('Categoría de material eliminada', [
                'category_id' => $category->id,
                'name' => $category->name,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('material-categories.index')
                ->with('success', 'Categoría eliminada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al eliminar categoría: ' . $e->getMessage(), [
                'category_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('material-categories.index')
                ->with('error', 'Error al eliminar la categoría');
        }
    }
}
</file>

<file path="app/Http/Controllers/MaterialController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\MaterialRequest;
use App\Models\Material;
use App\Models\MaterialCategory;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class MaterialController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | INDEX
    |--------------------------------------------------------------------------
    */

    public function index(Request $request)
    {
        try {
            $request->validate([
                'category' => ['nullable', 'integer', 'min:1', 'max:999999'],
                'search' => ['nullable', 'string', 'max:100', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s\-\_]+$/u'],
            ]);

            $query = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->withCount(['activeVariants']);

            if ($request->filled('category')) {
                $query->where('material_category_id', (int) $request->input('category'));
            }

            if ($request->filled('search')) {
                $search = $request->input('search');
                $query->where(function ($q) use ($search) {
                    $q->where('name', 'like', "%{$search}%")
                        ->orWhere('composition', 'like', "%{$search}%");
                });
            }

            $materials = $query->ordered()->get();

            $categories = MaterialCategory::where('activo', true)
                ->ordered()
                ->get();

            return view('admin.materials.index', compact('materials', 'categories'));
        } catch (\Exception $e) {
            Log::error('Error al listar materiales: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return view('admin.materials.index', [
                'materials' => collect(),
                'categories' => collect(),
            ])->with('error', 'Error al cargar los materiales');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create()
    {
        try {
            $categories = MaterialCategory::where('activo', true)
                ->with('baseUnit')
                ->ordered()
                ->get();

            if ($categories->isEmpty()) {
                return redirect()->route('materials.index')
                    ->with('error', 'Debe crear al menos una categoría de material primero');
            }

            return view('admin.materials.create', compact('categories'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de material: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(MaterialRequest $request)
    {
        try {
            DB::beginTransaction();

            $material = new Material();
            $material->uuid = (string) Str::uuid();
            $material->material_category_id = (int) $request->material_category_id;
            $material->name = mb_strtoupper(trim($request->name));
            $material->slug = Str::slug($request->name);
            $material->composition = $request->filled('composition')
                ? mb_strtoupper(trim($request->composition))
                : null;
            $material->description = $request->filled('description')
                ? trim($request->description)
                : null;
            $material->activo = true;
            $material->save();

            DB::commit();

            Log::info('Material creado', [
                'material_id' => $material->id,
                'name' => $material->name,
                'category_id' => $material->material_category_id,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('materials.index')
                ->with('success', 'Material creado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al crear material: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'request' => $request->validated(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('materials.create')
                ->withInput()
                ->with('error', 'Error al crear el material');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with('category')
                ->findOrFail((int) $id);

            $categories = MaterialCategory::where('activo', true)
                ->with('baseUnit')
                ->ordered()
                ->get();

            return view('admin.materials.edit', compact('material', 'categories'));
        } catch (\Exception $e) {
            Log::error('Error al cargar material para editar: ' . $e->getMessage(), [
                'material_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Material no encontrado');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(MaterialRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            DB::beginTransaction();

            $material = Material::where('activo', true)->findOrFail((int) $id);

            $oldName = $material->name;

            $material->material_category_id = (int) $request->material_category_id;
            $material->name = mb_strtoupper(trim($request->name));
            $material->slug = Str::slug($request->name);
            $material->composition = $request->filled('composition')
                ? mb_strtoupper(trim($request->composition))
                : null;
            $material->description = $request->filled('description')
                ? trim($request->description)
                : null;

            if (!$material->isDirty()) {
                return redirect()->route('materials.index')
                    ->with('info', 'No se realizaron cambios');
            }

            $material->save();

            DB::commit();

            Log::info('Material actualizado', [
                'material_id' => $material->id,
                'old_name' => $oldName,
                'new_name' => $material->name,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('materials.index')
                ->with('success', 'Material actualizado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar material: ' . $e->getMessage(), [
                'material_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('materials.edit', $id)
                ->withInput()
                ->with('error', 'Error al actualizar el material');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM DELETE
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->withCount('activeVariants')
                ->findOrFail((int) $id);

            return view('admin.materials.delete', compact('material'));
        } catch (\Exception $e) {
            Log::error('Error al cargar material para eliminar: ' . $e->getMessage(), [
                'material_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Material no encontrado');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DESTROY
    |--------------------------------------------------------------------------
    */

    public function destroy($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            DB::beginTransaction();

            $material = Material::where('activo', true)->findOrFail((int) $id);

            $validation = $material->canDelete();
            if (!$validation['can_delete']) {
                return redirect()->route('materials.index')
                    ->with('error', $validation['message']);
            }

            $materialName = $material->name;

            $material->activo = false;
            $material->save();

            DB::commit();

            Log::info('Material eliminado', [
                'material_id' => $material->id,
                'name' => $materialName,
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return redirect()->route('materials.index')
                ->with('success', 'Material eliminado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al eliminar material: ' . $e->getMessage(), [
                'material_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Error al eliminar el material');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX: Obtener materiales por categoría
    |--------------------------------------------------------------------------
    */

    public function getByCategory(Request $request, $categoryId)
    {
        try {
            if (!is_numeric($categoryId) || $categoryId < 1) {
                return response()->json(['error' => 'Categoría no válida'], 400);
            }

            $materials = Material::where('activo', true)
                ->where('material_category_id', (int) $categoryId)
                ->ordered()
                ->get(['id', 'name', 'composition']);

            return response()->json($materials);
        } catch (\Exception $e) {
            Log::error('Error AJAX getByCategory: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener materiales'], 500);
        }
    }
}
</file>

<file path="app/Http/Controllers/MaterialUnitConversionController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\MaterialUnitConversionRequest;
use App\Models\Material;
use App\Models\MaterialUnitConversion;
use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;

class MaterialUnitConversionController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | INDEX - Listar conversiones de un material
    |--------------------------------------------------------------------------
    */

    public function index($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->findOrFail((int) $materialId);

            $conversions = MaterialUnitConversion::where('material_id', $material->id)
                ->with(['fromUnit', 'toUnit'])
                ->orderBy('id')
                ->get();

            return view('admin.material-conversions.index', compact('material', 'conversions'));
        } catch (\Exception $e) {
            Log::error('Error al listar conversiones de material: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Error al cargar las conversiones');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->findOrFail((int) $materialId);

            $baseUnitId = $material->category->base_unit_id;

            // Solo unidades de compra compatibles con la unidad base
            $purchaseUnits = Unit::getPurchaseUnitsFor($baseUnitId);

            if ($purchaseUnits->isEmpty()) {
                return redirect()->route('material-conversions.index', $material->id)
                    ->with('error', 'No hay unidades de compra configuradas para ' . ($material->category->baseUnit->name ?? 'esta unidad base'));
            }

            // Unidades ya usadas
            $usedUnitIds = MaterialUnitConversion::where('material_id', $material->id)
                ->pluck('from_unit_id')
                ->toArray();

            return view('admin.material-conversions.create', compact(
                'material',
                'purchaseUnits',
                'usedUnitIds'
            ));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de conversión: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(MaterialUnitConversionRequest $request, $materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $conversion = new MaterialUnitConversion();
            $conversion->material_id = $material->id;
            $conversion->from_unit_id = (int) $request->from_unit_id;
            $conversion->to_unit_id = (int) $request->to_unit_id;
            $conversion->conversion_factor = (float) $request->conversion_factor;
            $conversion->save();

            DB::commit();

            Log::info('Conversión de unidad creada', [
                'conversion_id' => $conversion->id,
                'material_id' => $material->id,
                'material_name' => $material->name,
                'from_unit_id' => $conversion->from_unit_id,
                'to_unit_id' => $conversion->to_unit_id,
                'factor' => $conversion->conversion_factor,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('material-conversions.index', $material->id)
                ->with('success', 'Conversión creada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al crear conversión de unidad: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('material-conversions.create', $materialId)
                ->withInput()
                ->with('error', 'Error al crear la conversión');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->findOrFail((int) $materialId);

            $conversion = MaterialUnitConversion::where('material_id', $material->id)
                ->with(['fromUnit', 'toUnit'])
                ->findOrFail((int) $id);

            $baseUnitId = $material->category->base_unit_id;

            // Solo unidades de compra compatibles
            $purchaseUnits = Unit::getPurchaseUnitsFor($baseUnitId);

            // Unidades ya usadas (excepto la actual)
            $usedUnitIds = MaterialUnitConversion::where('material_id', $material->id)
                ->where('id', '!=', $conversion->id)
                ->pluck('from_unit_id')
                ->toArray();

            return view('admin.material-conversions.edit', compact(
                'material',
                'conversion',
                'purchaseUnits',
                'usedUnitIds'
            ));
        } catch (\Exception $e) {
            Log::error('Error al cargar conversión para editar: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'conversion_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Conversión no encontrada');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(MaterialUnitConversionRequest $request, $materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $conversion = MaterialUnitConversion::where('material_id', $material->id)
                ->findOrFail((int) $id);

            $oldFactor = $conversion->conversion_factor;

            $conversion->from_unit_id = (int) $request->from_unit_id;
            $conversion->to_unit_id = (int) $request->to_unit_id;
            $conversion->conversion_factor = (float) $request->conversion_factor;

            if (!$conversion->isDirty()) {
                return redirect()->route('material-conversions.index', $material->id)
                    ->with('info', 'No se realizaron cambios');
            }

            $conversion->save();

            DB::commit();

            Log::info('Conversión de unidad actualizada', [
                'conversion_id' => $conversion->id,
                'material_id' => $material->id,
                'old_factor' => $oldFactor,
                'new_factor' => $conversion->conversion_factor,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('material-conversions.index', $material->id)
                ->with('success', 'Conversión actualizada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar conversión: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'conversion_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('material-conversions.edit', [$materialId, $id])
                ->withInput()
                ->with('error', 'Error al actualizar la conversión');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM DELETE
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->findOrFail((int) $materialId);

            $conversion = MaterialUnitConversion::where('material_id', $material->id)
                ->with(['fromUnit', 'toUnit'])
                ->findOrFail((int) $id);

            return view('admin.material-conversions.delete', compact('material', 'conversion'));
        } catch (\Exception $e) {
            Log::error('Error al cargar conversión para eliminar: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'conversion_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Conversión no encontrada');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DESTROY
    |--------------------------------------------------------------------------
    */

    public function destroy($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $conversion = MaterialUnitConversion::where('material_id', $material->id)
                ->with(['fromUnit', 'toUnit'])
                ->findOrFail((int) $id);

            $conversionInfo = $conversion->display_conversion;

            $conversion->delete();

            DB::commit();

            Log::info('Conversión de unidad eliminada', [
                'conversion_id' => $id,
                'material_id' => $material->id,
                'material_name' => $material->name,
                'conversion_info' => $conversionInfo,
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return redirect()->route('material-conversions.index', $material->id)
                ->with('success', 'Conversión eliminada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al eliminar conversión: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'conversion_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('material-conversions.index', $materialId)
                ->with('error', 'Error al eliminar la conversión');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX: Obtener factor de conversión
    |--------------------------------------------------------------------------
    */

    public function getConversionFactor(Request $request, $materialId, $fromUnitId)
    {
        try {
            if (!is_numeric($materialId) || !is_numeric($fromUnitId)) {
                return response()->json(['error' => 'Parámetros no válidos'], 400);
            }

            $conversion = MaterialUnitConversion::where('material_id', (int) $materialId)
                ->where('from_unit_id', (int) $fromUnitId)
                ->with(['fromUnit', 'toUnit'])
                ->first();

            if (!$conversion) {
                return response()->json([
                    'found' => false,
                    'message' => 'No existe conversión configurada',
                ]);
            }

            return response()->json([
                'found' => true,
                'conversion_factor' => $conversion->conversion_factor,
                'from_unit' => $conversion->fromUnit->symbol ?? '',
                'to_unit' => $conversion->toUnit->symbol ?? '',
                'display' => $conversion->display_conversion,
            ]);
        } catch (\Exception $e) {
            Log::error('Error AJAX getConversionFactor: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener conversión'], 500);
        }
    }
}
</file>

<file path="app/Http/Controllers/ProduccionController.php">
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\DesignExport;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class ProduccionController extends Controller
{
    /**
     * Muestra la lista de todas las producciones.
     * Este método obtiene los registros de la base de datos y los envía a la vista principal.
     */
    public function index()
    {
        try {
            // Obtenemos las exportaciones que no han sido eliminadas, con sus relaciones
            $exportaciones = DesignExport::whereNull('deleted_at')
                ->with(['design', 'variant', 'creator'])
                ->orderBy('created_at', 'desc')
                ->get();

            // Retornamos la vista con los datos
            return view('admin.produccion.index', compact('exportaciones'));
        } catch (\Exception $e) {
            // Si ocurre un error, lo registramos y notificamos al usuario
            Log::error('Error en index de producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al cargar las producciones: ' . $e->getMessage());
        }
    }

    /**
     * Muestra el formulario para crear una nueva producción.
     * Aquí cargamos los diseños disponibles para que el usuario pueda elegir uno.
     */
    public function create()
    {
        try {
            // Obtenemos todos los diseños ordenados por nombre
            $designs = \App\Models\Design::orderBy('name')->get();
            return view('admin.produccion.create', compact('designs'));
        } catch (\Exception $e) {
            Log::error('Error en create de producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al cargar el formulario: ' . $e->getMessage());
        }
    }

    /**
     * Guarda la nueva producción en la base de datos.
     * Este método valida los datos del formulario y crea el registro.
     */
    public function store(Request $request)
    {
        try {
            // Validamos que los datos sean correctos
            $request->validate([
                'design_id' => 'required|exists:designs,id',
                'file' => 'nullable|file|max:51200', // Máximo 50MB
                'notes' => 'nullable|string',
            ]);

            // Preparamos los datos básicos
            $data = [
                'design_id' => $request->design_id,
                'status' => 'borrador', // Estado inicial
                'notes' => $request->notes,
                'created_by' => Auth::id(),
            ];

            // Si se subió un archivo, lo procesamos
            if ($request->hasFile('file')) {
                $file = $request->file('file');
                $path = $file->store('exports', 'public'); // Guardamos en la carpeta 'exports'

                // Agregamos la información del archivo a los datos
                $data['file_path'] = $path;
                $data['file_name'] = $file->getClientOriginalName();
                $data['mime_type'] = $file->getClientMimeType();
                $data['file_size'] = $file->getSize();
            }

            // Creamos el registro en la base de datos
            DesignExport::create($data);

            // Redirigimos al usuario con un mensaje de éxito
            return redirect()->route('admin.produccion.index')
                ->with('success', 'Producción creada correctamente en estado Borrador.');
        } catch (\Exception $e) {
            Log::error('Error al guardar producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al guardar la producción: ' . $e->getMessage())->withInput();
        }
    }

    /**
     * Muestra los detalles de una producción específica.
     * Si la petición es AJAX (modal), devuelve una vista parcial.
     */
    public function show(string $id)
    {
        try {
            // Buscamos la producción por su ID
            $export = DesignExport::findOrFail($id);

            // Si la petición viene de un modal (AJAX), devolvemos solo la vista parcial
            if (request()->ajax()) {
                $type = request('type');
                if ($type === 'details') {
                    return view('admin.produccion.show_modal', compact('export'));
                }
                return view('admin.produccion.show_modal_especificaciones', compact('export'));
            }

            // Si es una visita normal, devolvemos la vista completa
            return view('admin.produccion.show', compact('export'));
        } catch (\Exception $e) {
            Log::error('Error al mostrar producción: ' . $e->getMessage());
            // Si es ajax, devolvemos error texto plano o json, si no, redirect
            if (request()->ajax()) {
                return response('Error al cargar detalles: ' . $e->getMessage(), 500);
            }
            return back()->with('error', 'Ocurrió un error al cargar los detalles: ' . $e->getMessage());
        }
    }

    /**
     * Muestra el formulario para editar una producción existente.
     */
    public function edit(string $id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            return view('admin.produccion.edit', compact('export'));
        } catch (\Exception $e) {
            Log::error('Error en edit de producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al cargar el formulario de edición: ' . $e->getMessage());
        }
    }

    /**
     * Actualiza los datos de la producción en la base de datos.
     * Permite cambiar notas y reemplazar el archivo adjunto.
     */
    public function update(Request $request, string $id)
    {
        try {
            // Validamos los datos
            $request->validate([
                'file' => 'nullable|file|max:51200',
                'notes' => 'nullable|string',
            ]);

            // Buscamos el registro
            $export = DesignExport::findOrFail($id);

            $data = [
                'notes' => $request->notes,
            ];

            // Si se sube un nuevo archivo, reemplazamos el anterior
            if ($request->hasFile('file')) {
                // Borrar archivo viejo del almacenamiento
                if ($export->file_path && Storage::disk('public')->exists($export->file_path)) {
                    Storage::disk('public')->delete($export->file_path);
                }

                // Guardar nuevo archivo
                $file = $request->file('file');
                $path = $file->store('exports', 'public');

                $data['file_path'] = $path;
                $data['file_name'] = $file->getClientOriginalName();
                $data['mime_type'] = $file->getClientMimeType();
                $data['file_size'] = $file->getSize();
            }

            // Actualizamos el registro
            $export->update($data);

            return redirect()->route('admin.produccion.index')
                ->with('success', 'Producción actualizada correctamente.');
        } catch (\Exception $e) {
            Log::error('Error al actualizar producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al actualizar: ' . $e->getMessage());
        }
    }

    /**
     * Elimina una producción de la base de datos.
     */
    public function destroy(string $id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            // Si tuviera archivo físico, idealmente se borra también o se mantiene según política.
            // Aquí usamos SoftDeletes o delete normal.
            $export->delete();
            return back()->with('success', 'Producción eliminada correctamente.');
        } catch (\Exception $e) {
            Log::error('Error al eliminar producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al eliminar: ' . $e->getMessage());
        }
    }

    // --- ACCIONES DE ESTADO ---

    /**
     * Cambia el estado a 'pendiente' para solicitar revisión.
     */
    public function requestApproval($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $export->update(['status' => 'pendiente']);
            return back()->with('success', 'Solicitud de aprobación enviada.');
        } catch (\Exception $e) {
            Log::error('Error al solicitar aprobación: ' . $e->getMessage());
            return back()->with('error', 'Error al procesar solicitud: ' . $e->getMessage());
        }
    }

    /**
     * Aprueba la producción, registrando quién y cuándo aprobó.
     */
    public function approve($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $export->update([
                'status' => 'aprobado',
                'approved_by' => Auth::id(),
                'approved_at' => now(),
            ]);
            return back()->with('success', 'Producción aprobada correctamente.');
        } catch (\Exception $e) {
            Log::error('Error al aprobar producción: ' . $e->getMessage());
            return back()->with('error', 'Error al aprobar: ' . $e->getMessage());
        }
    }

    /**
     * Archiva la producción (estado final).
     */
    public function archive($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $export->update(['status' => 'archivado']);
            return back()->with('success', 'Producción archivada correctamente.');
        } catch (\Exception $e) {
            Log::error('Error al archivar producción: ' . $e->getMessage());
            return back()->with('error', 'Error al archivar: ' . $e->getMessage());
        }
    }

    /**
     * Revierte la producción a estado 'pendiente' (útil para correcciones).
     */
    public function revert($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $export->update(['status' => 'pendiente']);
            return back()->with('success', 'Estado revertido a pendiente.');
        } catch (\Exception $e) {
            Log::error('Error al revertir producción: ' . $e->getMessage());
            return back()->with('error', 'Error al revertir: ' . $e->getMessage());
        }
    }

    /**
     * Restaura una producción archivada a estado 'aprobado'.
     */
    public function restore($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $export->update(['status' => 'aprobado']);
            return back()->with('success', 'Producción restaurada a aprobado.');
        } catch (\Exception $e) {
            Log::error('Error al restaurar producción: ' . $e->getMessage());
            return back()->with('error', 'Error al restaurar: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/ProductCategoryController.php">
<?php

namespace App\Http\Controllers;

use App\Models\ProductCategory;
use Illuminate\Http\Request;

class ProductCategoryController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(ProductCategory $productCategory)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(ProductCategory $productCategory)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, ProductCategory $productCategory)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(ProductCategory $productCategory)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/ProductExtraController.php">
<?php

namespace App\Http\Controllers;

use App\Models\ProductExtra;
use Illuminate\Http\Request;

class ProductExtraController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(ProductExtra $productExtra)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(ProductExtra $productExtra)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, ProductExtra $productExtra)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(ProductExtra $productExtra)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/ProductVariantController.php">
<?php

namespace App\Http\Controllers;

use App\Models\ProductVariant;
use Illuminate\Http\Request;

class ProductVariantController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(ProductVariant $productVariant)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(ProductVariant $productVariant)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, ProductVariant $productVariant)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(ProductVariant $productVariant)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/PurchaseItemController.php">
<?php

namespace App\Http\Controllers;

use App\Models\PurchaseItem;
use Illuminate\Http\Request;

class PurchaseItemController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(PurchaseItem $purchaseItem)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(PurchaseItem $purchaseItem)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, PurchaseItem $purchaseItem)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(PurchaseItem $purchaseItem)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/PurchaseReceptionController.php">
<?php

namespace App\Http\Controllers;

use App\Models\PurchaseReception;
use Illuminate\Http\Request;

class PurchaseReceptionController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(PurchaseReception $purchaseReception)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(PurchaseReception $purchaseReception)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, PurchaseReception $purchaseReception)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(PurchaseReception $purchaseReception)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/PurchaseReceptionItemController.php">
<?php

namespace App\Http\Controllers;

use App\Models\PurchaseReceptionItem;
use Illuminate\Http\Request;

class PurchaseReceptionItemController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(PurchaseReceptionItem $purchaseReceptionItem)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(PurchaseReceptionItem $purchaseReceptionItem)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, PurchaseReceptionItem $purchaseReceptionItem)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(PurchaseReceptionItem $purchaseReceptionItem)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/RecomendacionController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Recomendacion;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class RecomendacionController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $recomendaciones = Recomendacion::where('activo', true)->get();
        return view('admin.recomendaciones.index', compact('recomendaciones'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.recomendaciones.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre_recomendacion' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:recomendacion,nombre_recomendacion',
            ],
        ]);
        try {
            $recomendacion = new Recomendacion();
            $recomendacion->nombre_recomendacion = strtoupper(trim($request->nombre_recomendacion));
            $recomendacion->save();
            return redirect()->route('admin.recomendaciones.index')->with('success', 'Recomendación guardada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al guardar la recomendación: ' . $e->getMessage());
            return redirect()->route('admin.recomendaciones.index')->with('error', 'Error al guardar la recomendación: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Recomendacion $recomendacion)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $recomendacion = Recomendacion::where('activo', true)->findOrFail($id);
        return view('admin.recomendaciones.edit', compact('recomendacion'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_recomendacion' => ['required', 'string', 'max:255', 'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/', 'unique:recomendacion,nombre_recomendacion,' . $id],
        ]);
        try {
            $recomendacion = Recomendacion::where('activo', true)->findOrFail($id);
            $recomendacion->nombre_recomendacion = strtoupper(trim($request->nombre_recomendacion));
            if (!$recomendacion->isDirty()) {
                return redirect()->route('admin.recomendaciones.index')->with('info', 'No se realizaron cambios');
            }
            $recomendacion->save();
            return redirect()->route('admin.recomendaciones.index')->with('success', 'Recomendación guardada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al guardar la recomendación: ' . $e->getMessage());
            return redirect()->route('admin.recomendaciones.index')->with('error', 'Error al guardar la recomendación: ' . $e->getMessage());
        }
    }

    /**
     * Remove the specified resource from storage.
     */

    public function confirm_delete($id)
    {
        $recomendacion = Recomendacion::where('activo', true)->findOrFail($id);
        return view('admin.recomendaciones.delete', compact('recomendacion'));
    }

    public function destroy($id)
    {
        try {
            $recomendacion = Recomendacion::where('activo', true)->findOrFail($id);
            $recomendacion->activo = false;
            $recomendacion->fecha_baja = now();
            $recomendacion->save();
            return redirect()->route('admin.recomendaciones.index')->with('success', 'Recomendación eliminada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar la recomendación: ' . $e->getMessage());
            return redirect()->route('admin.recomendaciones.index')->with('error', 'Error al eliminar la recomendación: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/UnitController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;

class UnitController extends Controller
{
    public function index()
    {
        try {
            $units = Unit::where('activo', true)->ordered()->get();
            return view('admin.units.index', compact('units'));
        } catch (\Exception $e) {
            Log::error('Error al listar unidades: ' . $e->getMessage());
            return view('admin.units.index', ['units' => collect()])
                ->with('error', 'Error al cargar las unidades');
        }
    }

    public function create()
    {
        return view('admin.units.create');
    }

    public function store(Request $request)
    {
        $request->validate([
            'name' => ['required', 'string', 'min:2', 'max:50', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/'],
            'symbol' => ['required', 'string', 'min:1', 'max:10', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑ]+$/'],
            'is_base' => ['sometimes', 'boolean'],
        ], [
            'name.required' => 'El nombre es obligatorio.',
            'name.regex' => 'El nombre solo puede contener letras y espacios.',
            'name.max' => 'El nombre no puede exceder 50 caracteres.',
            'symbol.required' => 'El símbolo es obligatorio.',
            'symbol.regex' => 'El símbolo solo puede contener letras.',
            'symbol.max' => 'El símbolo no puede exceder 10 caracteres.',
        ]);

        try {
            $unit = new Unit();
            $unit->uuid = (string) Str::uuid();
            $unit->name = mb_strtoupper(trim($request->name));
            $unit->slug = Str::slug($request->name);
            $unit->symbol = mb_strtolower(trim($request->symbol));
            $unit->is_base = $request->boolean('is_base');
            $unit->activo = true;
            $unit->save();

            return redirect()->route('units.index')->with('success', 'Unidad creada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al crear unidad: ' . $e->getMessage());
            return redirect()->route('units.index')->with('error', 'Error al crear la unidad');
        }
    }

    public function edit($id)
    {
        try {
            $unit = Unit::where('activo', true)->findOrFail($id);
            return view('admin.units.edit', compact('unit'));
        } catch (\Exception $e) {
            Log::error('Error al cargar unidad para editar: ' . $e->getMessage());
            return redirect()->route('units.index')->with('error', 'Unidad no encontrada');
        }
    }

    public function update(Request $request, $id)
    {
        $request->validate([
            'name' => ['required', 'string', 'min:2', 'max:50', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+$/'],
            'symbol' => ['required', 'string', 'min:1', 'max:10', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑ]+$/'],
            'is_base' => ['sometimes', 'boolean'],
        ], [
            'name.required' => 'El nombre es obligatorio.',
            'name.regex' => 'El nombre solo puede contener letras y espacios.',
            'name.max' => 'El nombre no puede exceder 50 caracteres.',
            'symbol.required' => 'El símbolo es obligatorio.',
            'symbol.regex' => 'El símbolo solo puede contener letras.',
            'symbol.max' => 'El símbolo no puede exceder 10 caracteres.',
        ]);

        try {
            $unit = Unit::where('activo', true)->findOrFail($id);

            $unit->name = mb_strtoupper(trim($request->name));
            $unit->slug = Str::slug($request->name);
            $unit->symbol = mb_strtolower(trim($request->symbol));
            $unit->is_base = $request->boolean('is_base');

            if (!$unit->isDirty()) {
                return redirect()->route('units.index')->with('info', 'No se realizaron cambios');
            }

            $unit->save();
            return redirect()->route('units.index')->with('success', 'Unidad actualizada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar unidad: ' . $e->getMessage());
            return redirect()->route('units.index')->with('error', 'Error al actualizar la unidad');
        }
    }

    public function confirmDelete($id)
    {
        try {
            $unit = Unit::where('activo', true)->findOrFail($id);
            return view('admin.units.delete', compact('unit'));
        } catch (\Exception $e) {
            Log::error('Error al cargar unidad para eliminar: ' . $e->getMessage());
            return redirect()->route('units.index')->with('error', 'Unidad no encontrada');
        }
    }

    public function destroy($id)
    {
        try {
            $unit = Unit::where('activo', true)->findOrFail($id);
            $unit->activo = false;
            $unit->save();

            return redirect()->route('units.index')->with('success', 'Unidad eliminada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar unidad: ' . $e->getMessage());
            return redirect()->route('units.index')->with('error', 'Error al eliminar la unidad');
        }
    }
}
</file>

<file path="app/Models/ActivityLog.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class ActivityLog extends Model
{
    /**
     * Inhabilitar la columna updated_at ya que los logs son inmutables.
     */
    public const UPDATED_AT = null;

    protected $table = 'activity_logs';

    protected $fillable = [
        'uuid',
        'user_id',
        'user_name',
        'action',
        'model_type',
        'model_id',
        'model_name',
        'old_values',
        'new_values',
        'changed_fields',
        'ip_address',
        'user_agent',
        'url',
        'method',
        'description',
        'metadata',
    ];

    protected $casts = [
        'old_values'     => 'array',
        'new_values'     => 'array',
        'changed_fields' => 'array',
        'metadata'       => 'array',
        'created_at'     => 'datetime',
    ];

    /**
     * Boot del modelo para lรณgica automรกtica.
     */
    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (ActivityLog $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
        });
    }

    /**
     * Relaciรณn con el usuario responsable.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class, 'user_id');
    }

    /**
     * Mรฉtodo estรกtico de registro centralizado de actividad.
     */
    public static function register(
        string $action,
        string $modelType,
        ?int $modelId = null,
        ?string $modelName = null,
        ?array $oldValues = null,
        ?array $newValues = null,
        ?string $description = null,
        ?array $metadata = null
    ): self {
        $user = Auth::user();
        $request = request();

        $changedFields = null;
        if ($oldValues && $newValues) {
            $changedFields = array_keys(array_diff_assoc(
                array_map('strval', $newValues),
                array_map('strval', $oldValues)
            ));
        }

        return self::create([
            'user_id'        => $user?->id,
            'user_name'      => $user ? Str::limit($user->name, 100, '') : 'Sistema',
            'action'         => Str::limit($action, 30, ''),
            'model_type'     => Str::limit($modelType, 100, ''),
            'model_id'       => $modelId,
            'model_name'     => $modelName ? Str::limit($modelName, 150, '') : null,
            'old_values'     => $oldValues,
            'new_values'     => $newValues,
            'changed_fields' => $changedFields,
            'ip_address'     => $request?->ip(),
            'user_agent'     => $request ? Str::limit($request->userAgent() ?? '', 500, '') : null,
            'url'            => $request ? Str::limit($request->fullUrl(), 500, '') : null,
            'method'         => $request?->method(),
            'description'    => $description,
            'metadata'       => $metadata,
        ]);
    }

    /**
     * Accesors modernos utilizando la clase Attribute de Laravel.
     */

    protected function shortModelType(): Attribute
    {
        return Attribute::make(
            get: fn() => class_basename($this->model_type)
        );
    }

    protected function actionIcon(): Attribute
    {
        return Attribute::make(
            get: fn() => match ($this->action) {
                'created'  => 'fas fa-plus-circle text-success',
                'updated'  => 'fas fa-edit text-warning',
                'deleted'  => 'fas fa-trash text-danger',
                'restored' => 'fas fa-undo text-info',
                'login'    => 'fas fa-sign-in-alt text-primary',
                'logout'   => 'fas fa-sign-out-alt text-secondary',
                default    => 'fas fa-circle text-muted',
            }
        );
    }

    protected function actionLabel(): Attribute
    {
        return Attribute::make(
            get: fn() => match ($this->action) {
                'created'  => 'Creรณ',
                'updated'  => 'Actualizรณ',
                'deleted'  => 'Eliminรณ',
                'restored' => 'Restaurรณ',
                'login'    => 'Iniciรณ sesiรณn',
                'logout'   => 'Cerrรณ sesiรณn',
                default    => Str::ucfirst($this->action),
            }
        );
    }

    public function getRouteKeyName(): string
    {
        return 'uuid';
    }
}
</file>

<file path="app/Models/Application_types.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;

class Application_types extends Model
{
    protected $table = 'application_types';
    protected $fillable = [
        'slug',
        'nombre_aplicacion',
        'descripcion',
        'activo',
        'fecha_baja',
    ];

    /**
     * Boot del modelo para generar slug automáticamente
     */
    protected static function boot()
    {
        parent::boot();

        // Generar slug automáticamente al crear
        static::creating(function ($model) {
            if (empty($model->slug) && !empty($model->nombre_aplicacion)) {
                $model->slug = self::generateSlug($model->nombre_aplicacion);
            }
        });

        // Actualizar slug si cambia el nombre
        static::updating(function ($model) {
            if ($model->isDirty('nombre_aplicacion') && !empty($model->nombre_aplicacion)) {
                $model->slug = self::generateSlug($model->nombre_aplicacion);
            }
        });
    }

    /**
     * Genera un slug a partir del nombre
     * Ejemplo: "Brazo Izquierdo" → "brazo_izquierdo"
     */
    public static function generateSlug(string $nombre): string
    {
        // Convertir a minúsculas
        $slug = Str::lower($nombre);

        // Reemplazar caracteres especiales y acentos
        $slug = Str::ascii($slug);

        // Reemplazar espacios y guiones por guiones bajos
        $slug = preg_replace('/[\s\-]+/', '_', $slug);

        // Eliminar caracteres no alfanuméricos excepto guión bajo
        $slug = preg_replace('/[^a-z0-9_]/', '', $slug);

        // Eliminar guiones bajos múltiples
        $slug = preg_replace('/_+/', '_', $slug);

        // Eliminar guiones bajos al inicio y final
        return trim($slug, '_');
    }

    /**
     * Scope para obtener solo los activos
     */
    public function scopeActivos($query)
    {
        return $query->where('activo', true)->whereNull('fecha_baja');
    }

    /**
     * Relación con diseños
     */
    public function designs()
    {
        return $this->hasMany(Design::class);
    }

    /**
     * Relación con exportaciones de diseño
     */
    public function designExports()
    {
        return $this->hasMany(DesignExport::class, 'application_type', 'slug');
    }
}
</file>

<file path="app/Models/Category.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Category extends Model
{
    protected $fillable = [
        'name',
        'slug',
        'description',
        'parent_id',
        'order',
        'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean',
        'order' => 'integer'
    ];

    // Relación: Una categoría puede tener muchas subcategorías
    public function children()
    {
        return $this->hasMany(Category::class, 'parent_id');
    }

    // Relación: Una categoría pertenece a una categoría padre
    public function parent()
    {
        return $this->belongsTo(Category::class, 'parent_id');
    }

    // Relación: Una categoría tiene muchos diseños
    public function designs()
    {
        return $this->belongsToMany(Design::class);
    }
    /*
    fillable: Campos que se pueden asignar masivamente
    casts: Convierte automáticamente tipos de datos
    Las relaciones permiten acceder a datos relacionados fácilmente */
}
</file>

<file path="app/Models/Cliente.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Cliente extends Model
{
    use HasFactory;
    protected $table = 'clientes';
    protected $fillable = [
        'nombre',
        'apellidos',
        'telefono',
        'email',
        'direccion',
        'ciudad',
        'codigo_postal',
        'activo',
        'fecha_baja',
        'motivo_baja',
        'observaciones',
        'estado_id',
        'recomendacion_id',
        'busto',
        'alto_cintura',
        'cintura',
        'cadera',
        'largo',
    ];
    public function estado()
    {
        return $this->belongsTo(Estado::class);
    }
    public function recomendacion()
    {
        return $this->belongsTo(Recomendacion::class);
    }
}
</file>

<file path="app/Models/DesignVariantImage.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class DesignVariantImage extends Model
{
    protected $fillable = [
        'design_variant_id',
        'path',
        'original_name',
        'mime_type',
        'size',
        'is_primary',
        'order'
    ];

    protected $casts = [
        'is_primary' => 'boolean',
        'order' => 'integer',
        'size' => 'integer',
    ];

    public function variant()
    {
        return $this->belongsTo(DesignVariant::class, 'design_variant_id');
    }
}
</file>

<file path="app/Models/Giro.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class Giro extends Model
{
    use HasFactory;
    protected $table = 'giros';
    protected $fillable = [
        'nombre_giro',
        'descripcion',
        'activo',
        'fecha_baja',
    ];

    public function proveedores()
    {
        return $this->hasMany(Proveedor::class);
    }
}
</file>

<file path="app/Models/InventoryMovement.php">
<?php

namespace App\Models;

use App\Enums\MovementType;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class InventoryMovement extends Model
{
    protected $table = 'inventory_movements';

    protected $fillable = [
        'uuid',
        'material_variant_id',
        'type',
        'reference_type',
        'reference_id',
        'quantity',
        'unit_cost',
        'total_cost',
        'stock_before',
        'stock_after',
        'average_cost_before',
        'average_cost_after',
        'value_before',
        'value_after',
        'notes',
        'created_by',
    ];

    protected $casts = [
        'type' => MovementType::class,
        'quantity' => 'decimal:4',
        'unit_cost' => 'decimal:4',
        'total_cost' => 'decimal:4',
        'stock_before' => 'decimal:4',
        'stock_after' => 'decimal:4',
        'average_cost_before' => 'decimal:4',
        'average_cost_after' => 'decimal:4',
        'value_before' => 'decimal:4',
        'value_after' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->created_by)) {
                $model->created_by = Auth::id();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function materialVariant()
    {
        return $this->belongsTo(MaterialVariant::class, 'material_variant_id');
    }

    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeByVariant(Builder $query, int $variantId): Builder
    {
        return $query->where('material_variant_id', $variantId);
    }

    public function scopeByType(Builder $query, MovementType $type): Builder
    {
        return $query->where('type', $type->value);
    }

    public function scopeEntries(Builder $query): Builder
    {
        return $query->where('type', MovementType::ENTRY->value);
    }

    public function scopeExits(Builder $query): Builder
    {
        return $query->where('type', MovementType::EXIT->value);
    }

    public function scopeDateRange(Builder $query, ?string $from, ?string $to): Builder
    {
        if ($from) {
            $query->whereDate('created_at', '>=', $from);
        }
        if ($to) {
            $query->whereDate('created_at', '<=', $to);
        }
        return $query;
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getTypeLabelAttribute(): string
    {
        return $this->type->label();
    }

    public function getTypeColorAttribute(): string
    {
        return $this->type->color();
    }

    public function getTypeIconAttribute(): string
    {
        return $this->type->icon();
    }

    public function getFormattedQuantityAttribute(): string
    {
        $sign = $this->type->affectsStock() > 0 ? '+' : '-';
        return $sign . number_format(abs($this->quantity), 2);
    }

    public function getFormattedUnitCostAttribute(): string
    {
        return '$' . number_format($this->unit_cost, 4);
    }

    public function getFormattedTotalCostAttribute(): string
    {
        return '$' . number_format($this->total_cost, 2);
    }
}
</file>

<file path="app/Models/MaterialCategory.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use App\Traits\HasActivityLog;

class MaterialCategory extends Model
{
    use HasActivityLog;

    protected $table = 'material_categories';

    protected $activityLogNameField = 'name';

    protected $fillable = [
        'name',
        'slug',
        'description',
        'base_unit_id',
        'has_color',
        'activo',
    ];

    protected $casts = [
        'has_color' => 'boolean',
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->slug) && !empty($model->name)) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::updating(function (self $model): void {
            if ($model->isDirty('name')) {
                $model->slug = Str::slug($model->name);
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function baseUnit()
    {
        return $this->belongsTo(Unit::class, 'base_unit_id');
    }

    public function materials()
    {
        return $this->hasMany(Material::class, 'material_category_id');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name');
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canDelete(): array
    {
        if ($this->materials()->where('activo', true)->exists()) {
            return [
                'can_delete' => false,
                'message' => 'No se puede eliminar: tiene materiales activos asociados.',
            ];
        }

        return ['can_delete' => true, 'message' => ''];
    }
}
</file>

<file path="app/Models/MaterialUnitConversion.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class MaterialUnitConversion extends Model
{
    protected $table = 'material_unit_conversions';

    protected $fillable = [
        'material_id',
        'from_unit_id',
        'to_unit_id',
        'conversion_factor',
    ];

    protected $casts = [
        'conversion_factor' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function material()
    {
        return $this->belongsTo(Material::class, 'material_id');
    }

    public function fromUnit()
    {
        return $this->belongsTo(Unit::class, 'from_unit_id');
    }

    public function toUnit()
    {
        return $this->belongsTo(Unit::class, 'to_unit_id');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getDisplayConversionAttribute(): string
    {
        $from = $this->fromUnit?->name ?? '';
        $to = $this->toUnit?->symbol ?? '';
        return "1 {$from} = {$this->conversion_factor} {$to}";
    }
}
</file>

<file path="app/Models/MaterialVariant.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use App\Traits\HasActivityLog;

class MaterialVariant extends Model
{
    use HasActivityLog;

    protected $table = 'material_variants';

    protected $activityLogNameField = 'sku';

    protected $fillable = [
        'uuid',
        'material_id',
        'color',
        'sku',
        'current_stock',
        'min_stock_alert',
        'current_value',
        'average_cost',
        'last_purchase_cost',
        'activo',
    ];

    protected $casts = [
        'current_stock' => 'decimal:4',
        'min_stock_alert' => 'decimal:4',
        'current_value' => 'decimal:4',
        'average_cost' => 'decimal:4',
        'last_purchase_cost' => 'decimal:4',
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function material()
    {
        return $this->belongsTo(Material::class, 'material_id');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('color')->orderBy('sku');
    }

    public function scopeLowStock(Builder $query): Builder
    {
        return $query->whereColumn('current_stock', '<=', 'min_stock_alert');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getDisplayNameAttribute(): string
    {
        $name = $this->material?->name ?? '';
        if ($this->color) {
            $name .= " - {$this->color}";
        }
        return $name;
    }

    public function getFormattedStockAttribute(): string
    {
        $unit = $this->material?->category?->baseUnit;
        $symbol = $unit?->symbol ?? '';
        return number_format($this->current_stock, 2) . ' ' . $symbol;
    }

    public function getFormattedAverageCostAttribute(): string
    {
        return '$' . number_format($this->average_cost, 2);
    }

    public function getIsLowStockAttribute(): bool
    {
        return $this->current_stock <= $this->min_stock_alert;
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS DE INVENTARIO
    |--------------------------------------------------------------------------
    */

    public function addStock(float $quantity, float $unitCost): void
    {
        $newValue = $this->current_value + ($quantity * $unitCost);
        $newStock = $this->current_stock + $quantity;

        $this->current_value = $newValue;
        $this->current_stock = $newStock;
        $this->average_cost = $newStock > 0 ? ($newValue / $newStock) : 0;
        $this->last_purchase_cost = $unitCost;
        $this->save();
    }

    public function reduceStock(float $quantity): float
    {
        $costConsumed = $quantity * $this->average_cost;

        $this->current_stock -= $quantity;
        $this->current_value -= $costConsumed;

        if ($this->current_stock < 0) {
            $this->current_stock = 0;
            $this->current_value = 0;
        }

        $this->save();

        return $costConsumed;
    }
}
</file>

<file path="app/Models/ProductMaterial.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Relations\Pivot;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class ProductMaterial extends Pivot
{
    protected $table = 'product_materials';

    public $incrementing = true;

    protected $fillable = [
        'product_id',
        'material_variant_id',
        'quantity',
        'is_primary',
        'notes',
    ];

    protected $casts = [
        'quantity' => 'decimal:4',
        'is_primary' => 'boolean',
    ];

    /**
     * Relación con el material (Variante)
     */
    public function materialVariant()
    {
        return $this->belongsTo(MaterialVariant::class, 'material_variant_id');
    }

    /**
     * Relación con el producto
     */
    public function product()
    {
        return $this->belongsTo(Product::class, 'product_id');
    }
}
</file>

<file path="app/Models/Purchase.php">
<?php

namespace App\Models;

use App\Enums\PurchaseStatus;
use App\Traits\HasActivityLog;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth; // <--- IMPORTACIÓN DE LA FACADE


class Purchase extends Model
{
    use SoftDeletes, HasActivityLog;

    protected $table = 'purchases';

    protected $activityLogNameField = 'purchase_number';

    protected $fillable = [
        'uuid',
        'purchase_number',
        'proveedor_id',
        'status',
        'subtotal',
        'tax_rate',
        'tax_amount',
        'discount_amount',
        'total',
        'notes',
        'reference',
        'ordered_at',
        'expected_at',
        'received_at',
        'created_by',
        'updated_by',
        'received_by',
        'cancelled_by',
        'cancelled_at',
        'cancellation_reason',
        'activo',
    ];

    protected $casts = [
        'status' => PurchaseStatus::class,
        'subtotal' => 'decimal:4',
        'tax_rate' => 'decimal:2',
        'tax_amount' => 'decimal:4',
        'discount_amount' => 'decimal:4',
        'total' => 'decimal:4',
        'ordered_at' => 'date',
        'expected_at' => 'date',
        'received_at' => 'datetime',
        'cancelled_at' => 'datetime',
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->purchase_number)) {
                $model->purchase_number = self::generatePurchaseNumber();
            }
            if (empty($model->status)) {
                $model->status = PurchaseStatus::DRAFT;
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function proveedor()
    {
        return $this->belongsTo(Proveedor::class, 'proveedor_id');
    }

    public function items()
    {
        return $this->hasMany(PurchaseItem::class, 'purchase_id');
    }

    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    public function updater()
    {
        return $this->belongsTo(User::class, 'updated_by');
    }

    public function receiver()
    {
        return $this->belongsTo(User::class, 'received_by');
    }

    public function canceller()
    {
        return $this->belongsTo(User::class, 'cancelled_by');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeByStatus(Builder $query, PurchaseStatus $status): Builder
    {
        return $query->where('status', $status->value);
    }

    public function scopePending(Builder $query): Builder
    {
        return $query->whereIn('status', [
            PurchaseStatus::PENDING->value,
            PurchaseStatus::PARTIAL->value,
        ]);
    }

    public function scopeByProveedor(Builder $query, int $proveedorId): Builder
    {
        return $query->where('proveedor_id', $proveedorId);
    }

    public function scopeDateRange(Builder $query, ?string $from, ?string $to): Builder
    {
        if ($from) {
            $query->whereDate('ordered_at', '>=', $from);
        }
        if ($to) {
            $query->whereDate('ordered_at', '<=', $to);
        }
        return $query;
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getStatusLabelAttribute(): string
    {
        return $this->status->label();
    }

    public function getStatusColorAttribute(): string
    {
        return $this->status->color();
    }

    public function getStatusIconAttribute(): string
    {
        return $this->status->icon();
    }

    public function getFormattedTotalAttribute(): string
    {
        return '$' . number_format($this->total, 2);
    }

    public function getFormattedSubtotalAttribute(): string
    {
        return '$' . number_format($this->subtotal, 2);
    }

    public function getItemsCountAttribute(): int
    {
        return $this->items()->count();
    }

    public function getCanEditAttribute(): bool
    {
        return $this->status->canEdit();
    }

    public function getCanReceiveAttribute(): bool
    {
        return $this->status->canReceive();
    }

    public function getCanCancelAttribute(): bool
    {
        return $this->status->canCancel();
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS DE NEGOCIO
    |--------------------------------------------------------------------------
    */

    public function recalculateTotals(): void
    {
        $subtotal = $this->items()->sum('subtotal');
        $taxAmount = $subtotal * ($this->tax_rate / 100);
        $total = $subtotal + $taxAmount - $this->discount_amount;

        $this->subtotal = $subtotal;
        $this->tax_amount = $taxAmount;
        $this->total = max(0, $total);
        $this->save();
    }

    public function markAsPending(): void
    {
        $this->status = PurchaseStatus::PENDING;
        $this->ordered_at = $this->ordered_at ?? now();
        $this->save();
    }

    public function markAsReceived(): void
    {
        $this->status = PurchaseStatus::RECEIVED;
        $this->received_at = now();
        $this->received_by = Auth::id();
        $this->save();
    }

    public function markAsPartial(): void
    {
        $this->status = PurchaseStatus::PARTIAL;
        $this->save();
    }

    public function markAsCancelled(string $reason): void
    {
        $this->status = PurchaseStatus::CANCELLED;
        $this->cancelled_at = now();
        $this->cancelled_by = Auth::id();
        $this->cancellation_reason = $reason;
        $this->save();
    }

    public function isFullyReceived(): bool
    {
        foreach ($this->items as $item) {
            if ($item->quantity_received < $item->quantity) {
                return false;
            }
        }
        return true;
    }

    public function hasReceivedItems(): bool
    {
        return $this->items()->where('quantity_received', '>', 0)->exists();
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS ESTÁTICOS
    |--------------------------------------------------------------------------
    */

    public static function generatePurchaseNumber(): string
    {
        $prefix = 'OC';
        $year = now()->format('y');
        $month = now()->format('m');

        $lastPurchase = self::whereYear('created_at', now()->year)
            ->whereMonth('created_at', now()->month)
            ->orderBy('id', 'desc')
            ->first();

        if ($lastPurchase && preg_match('/(\d+)$/', $lastPurchase->purchase_number, $matches)) {
            $sequence = (int) $matches[1] + 1;
        } else {
            $sequence = 1;
        }

        return sprintf('%s%s%s-%04d', $prefix, $year, $month, $sequence);
    }
}
</file>

<file path="app/Models/PurchaseItem.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;

class PurchaseItem extends Model
{
    protected $table = 'purchase_items';

    protected $fillable = [
        'uuid',
        'purchase_id',
        'material_variant_id',
        'unit_id',
        'quantity',
        'unit_price',
        'conversion_factor',
        'converted_quantity',
        'converted_unit_cost',
        'subtotal',
        'quantity_received',
        'converted_quantity_received',
        'notes',
    ];

    protected $casts = [
        'quantity' => 'decimal:4',
        'unit_price' => 'decimal:4',
        'conversion_factor' => 'decimal:4',
        'converted_quantity' => 'decimal:4',
        'converted_unit_cost' => 'decimal:4',
        'subtotal' => 'decimal:4',
        'quantity_received' => 'decimal:4',
        'converted_quantity_received' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            $model->calculateConversions();
        });

        static::updating(function (self $model): void {
            if ($model->isDirty(['quantity', 'unit_price', 'conversion_factor'])) {
                $model->calculateConversions();
            }
        });

        static::saved(function (self $model): void {
            $model->purchase->recalculateTotals();
        });

        static::deleted(function (self $model): void {
            $model->purchase->recalculateTotals();
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function purchase()
    {
        return $this->belongsTo(Purchase::class, 'purchase_id');
    }

    public function materialVariant()
    {
        return $this->belongsTo(MaterialVariant::class, 'material_variant_id');
    }

    public function unit()
    {
        return $this->belongsTo(Unit::class, 'unit_id');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFormattedSubtotalAttribute(): string
    {
        return '$' . number_format($this->subtotal, 2);
    }

    public function getFormattedUnitPriceAttribute(): string
    {
        return '$' . number_format($this->unit_price, 2);
    }

    public function getFormattedConvertedUnitCostAttribute(): string
    {
        return '$' . number_format($this->converted_unit_cost, 4);
    }

    public function getPendingQuantityAttribute(): float
    {
        return max(0, $this->quantity - $this->quantity_received);
    }

    public function getPendingConvertedQuantityAttribute(): float
    {
        return max(0, $this->converted_quantity - $this->converted_quantity_received);
    }

    public function getIsFullyReceivedAttribute(): bool
    {
        return $this->quantity_received >= $this->quantity;
    }

    public function getReceivedPercentageAttribute(): float
    {
        if ($this->quantity <= 0) {
            return 0;
        }
        return min(100, ($this->quantity_received / $this->quantity) * 100);
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    protected function calculateConversions(): void
    {
        $this->converted_quantity = $this->quantity * $this->conversion_factor;
        $this->subtotal = $this->quantity * $this->unit_price;

        if ($this->converted_quantity > 0) {
            $this->converted_unit_cost = $this->subtotal / $this->converted_quantity;
        } else {
            $this->converted_unit_cost = 0;
        }
    }

    public function recalculate(): void
    {
        $this->calculateConversions();
        $this->save();
    }

    public function addReceivedQuantity(float $quantity): void
    {
        $convertedQty = $quantity * $this->conversion_factor;

        $this->quantity_received += $quantity;
        $this->converted_quantity_received += $convertedQty;
        $this->save();
    }
}
</file>

<file path="app/Models/PurchaseReception.php">
<?php

namespace App\Models;

use App\Enums\ReceptionStatus;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class PurchaseReception extends Model
{
    protected $table = 'purchase_receptions';

    protected $fillable = [
        'uuid',
        'purchase_id',
        'reception_number',
        'status',
        'delivery_note',
        'notes',
        'received_at',
        'received_by',
        'voided_at',
        'voided_by',
        'void_reason',
    ];

    protected $casts = [
        'status' => ReceptionStatus::class,
        'received_at' => 'datetime',
        'voided_at' => 'datetime',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->reception_number)) {
                $model->reception_number = self::generateReceptionNumber($model->purchase_id);
            }
            if (empty($model->received_at)) {
                $model->received_at = now();
            }
            if (empty($model->received_by)) {
                $model->received_by = Auth::id();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function purchase()
    {
        return $this->belongsTo(Purchase::class, 'purchase_id');
    }

    public function items()
    {
        return $this->hasMany(PurchaseReceptionItem::class, 'purchase_reception_id');
    }

    public function receiver()
    {
        return $this->belongsTo(User::class, 'received_by');
    }

    public function voidedByUser()
    {
        return $this->belongsTo(User::class, 'voided_by');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeCompleted(Builder $query): Builder
    {
        return $query->where('status', ReceptionStatus::COMPLETED->value);
    }

    public function scopeVoided(Builder $query): Builder
    {
        return $query->where('status', ReceptionStatus::VOIDED->value);
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getStatusLabelAttribute(): string
    {
        return $this->status->label();
    }

    public function getStatusColorAttribute(): string
    {
        return $this->status->color();
    }

    public function getStatusIconAttribute(): string
    {
        return $this->status->icon();
    }

    public function getIsVoidedAttribute(): bool
    {
        return $this->status === ReceptionStatus::VOIDED;
    }

    public function getCanVoidAttribute(): bool
    {
        return $this->status === ReceptionStatus::COMPLETED;
    }

    public function getTotalItemsAttribute(): int
    {
        return $this->items()->count();
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public static function generateReceptionNumber(int $purchaseId): string
    {
        $purchase = Purchase::find($purchaseId);
        $prefix = $purchase ? $purchase->purchase_number : 'REC';

        $count = self::where('purchase_id', $purchaseId)->count() + 1;

        return sprintf('%s-R%02d', $prefix, $count);
    }
}
</file>

<file path="app/Models/PurchaseReceptionItem.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class PurchaseReceptionItem extends Model
{
    protected $table = 'purchase_reception_items';

    protected $fillable = [
        'purchase_reception_id',
        'purchase_item_id',
        'material_variant_id',
        'quantity_received',
        'converted_quantity',
        'unit_cost',
        'inventory_movement_id',
    ];

    protected $casts = [
        'quantity_received' => 'decimal:4',
        'converted_quantity' => 'decimal:4',
        'unit_cost' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function reception()
    {
        return $this->belongsTo(PurchaseReception::class, 'purchase_reception_id');
    }

    public function purchaseItem()
    {
        return $this->belongsTo(PurchaseItem::class, 'purchase_item_id');
    }

    public function materialVariant()
    {
        return $this->belongsTo(MaterialVariant::class, 'material_variant_id');
    }

    public function inventoryMovement()
    {
        return $this->belongsTo(InventoryMovement::class, 'inventory_movement_id');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFormattedQuantityAttribute(): string
    {
        return number_format($this->quantity_received, 2);
    }

    public function getTotalCostAttribute(): float
    {
        return $this->converted_quantity * $this->unit_cost;
    }
}
</file>

<file path="app/Models/SearchIndex.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\MorphTo;
use Illuminate\Database\Eloquent\Builder;

/**
 * SearchIndex Model
 * 
 * Representa una entrada en el índice de búsqueda.
 * Cada registro es una copia denormalizada de un modelo searchable.
 * 
 * @package App\Models
 * @property int $id
 * @property string $searchable_type
 * @property int $searchable_id
 * @property string $original_title
 * @property string|null $original_content
 * @property string $normalized_title
 * @property string|null $normalized_content
 * @property string $stemmed_tokens
 * @property array|null $metadata
 * @property bool $is_active
 * @property float $boost
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 */
class SearchIndex extends Model
{
    protected $table = 'search_index';

    protected $fillable = [
        'searchable_type',
        'searchable_id',
        'original_title',
        'original_content',
        'normalized_title',
        'normalized_content',
        'stemmed_tokens',
        'metadata',
        'is_active',
        'boost',
    ];

    protected $casts = [
        'metadata' => 'array',
        'is_active' => 'boolean',
        'boost' => 'float',
        'searchable_id' => 'integer',
    ];

    /**
     * Relación polimórfica al modelo indexado.
     */
    public function searchable(): MorphTo
    {
        return $this->morphTo();
    }

    /**
     * Scope: Solo entradas activas.
     */
    public function scopeActive(Builder $query): Builder
    {
        return $query->where('is_active', true);
    }

    /**
     * Scope: Filtrar por tipo de modelo.
     */
    public function scopeOfType(Builder $query, string $type): Builder
    {
        return $query->where('searchable_type', $type);
    }

    /**
     * Scope: Búsqueda FULLTEXT en tokens stemmed.
     * Este es el método principal de búsqueda.
     */
    public function scopeSearchStemmed(Builder $query, string $searchTerms): Builder
    {
        if (empty(trim($searchTerms))) {
            return $query;
        }

        return $query->whereRaw(
            'MATCH(stemmed_tokens) AGAINST(? IN BOOLEAN MODE)',
            [$searchTerms]
        );
    }

    /**
     * Scope: Búsqueda FULLTEXT en texto normalizado.
     */
    public function scopeSearchNormalized(Builder $query, string $searchTerms): Builder
    {
        if (empty(trim($searchTerms))) {
            return $query;
        }

        return $query->whereRaw(
            'MATCH(normalized_title, normalized_content) AGAINST(? IN BOOLEAN MODE)',
            [$searchTerms]
        );
    }

    /**
     * Scope: Búsqueda solo en título.
     */
    public function scopeSearchTitle(Builder $query, string $searchTerms): Builder
    {
        if (empty(trim($searchTerms))) {
            return $query;
        }

        return $query->whereRaw(
            'MATCH(normalized_title) AGAINST(? IN BOOLEAN MODE)',
            [$searchTerms]
        );
    }

    /**
     * Scope: Búsqueda con LIKE (fallback).
     */
    public function scopeSearchLike(Builder $query, string $term): Builder
    {
        $term = '%' . $term . '%';
        
        return $query->where(function ($q) use ($term) {
            $q->where('normalized_title', 'LIKE', $term)
              ->orWhere('normalized_content', 'LIKE', $term)
              ->orWhere('stemmed_tokens', 'LIKE', $term);
        });
    }

    /**
     * Scope: Ordenar por relevancia FULLTEXT.
     */
    public function scopeOrderByRelevance(Builder $query, string $searchTerms): Builder
    {
        if (empty(trim($searchTerms))) {
            return $query->orderByDesc('updated_at');
        }

        return $query->selectRaw(
            '*, MATCH(stemmed_tokens) AGAINST(? IN BOOLEAN MODE) AS relevance_score',
            [$searchTerms]
        )->orderByDesc('relevance_score')->orderByDesc('boost');
    }

    /**
     * Scope: Filtrar por metadata.
     */
    public function scopeWithMetadata(Builder $query, string $key, $value): Builder
    {
        return $query->whereRaw(
            'JSON_EXTRACT(metadata, ?) = ?',
            ['$.' . $key, json_encode($value)]
        );
    }

    /**
     * Scope: Filtrar por categorías en metadata.
     */
    public function scopeInCategories(Builder $query, array $categoryIds): Builder
    {
        if (empty($categoryIds)) {
            return $query;
        }

        return $query->where(function ($q) use ($categoryIds) {
            foreach ($categoryIds as $catId) {
                $q->orWhereRaw(
                    'JSON_CONTAINS(metadata, ?, "$.category_ids")',
                    [json_encode((int)$catId)]
                );
            }
        });
    }

    /**
     * Obtener el modelo original indexado.
     */
    public function getOriginalModel(): ?Model
    {
        $class = $this->searchable_type;
        
        if (!class_exists($class)) {
            return null;
        }

        return $class::find($this->searchable_id);
    }

    /**
     * Verificar si el índice está desactualizado.
     */
    public function isStale(): bool
    {
        $model = $this->getOriginalModel();
        
        if (!$model) {
            return true; // El modelo ya no existe
        }

        return $model->updated_at > $this->updated_at;
    }

    /**
     * Obtener extracto con highlight de términos.
     */
    public function getHighlightedExcerpt(string $query, int $length = 150): string
    {
        $content = $this->original_content ?? $this->original_title;
        
        if (empty($content)) {
            return '';
        }

        // Truncar si es muy largo
        if (mb_strlen($content) > $length) {
            $content = mb_substr($content, 0, $length) . '...';
        }

        // Destacar términos de búsqueda
        $terms = preg_split('/\s+/', $query, -1, PREG_SPLIT_NO_EMPTY);
        
        foreach ($terms as $term) {
            $content = preg_replace(
                '/(' . preg_quote($term, '/') . ')/iu',
                '<mark>$1</mark>',
                $content
            );
        }

        return $content;
    }

    /**
     * Crear o actualizar índice para un modelo.
     */
    public static function indexModel(
        Model $model,
        string $title,
        ?string $content,
        string $normalizedTitle,
        ?string $normalizedContent,
        string $stemmedTokens,
        array $metadata = [],
        float $boost = 1.0
    ): self {
        return self::updateOrCreate(
            [
                'searchable_type' => get_class($model),
                'searchable_id' => $model->getKey(),
            ],
            [
                'original_title' => $title,
                'original_content' => $content,
                'normalized_title' => $normalizedTitle,
                'normalized_content' => $normalizedContent,
                'stemmed_tokens' => $stemmedTokens,
                'metadata' => $metadata,
                'is_active' => true,
                'boost' => $boost,
            ]
        );
    }

    /**
     * Eliminar índice de un modelo.
     */
    public static function removeModel(Model $model): bool
    {
        return self::where('searchable_type', get_class($model))
            ->where('searchable_id', $model->getKey())
            ->delete() > 0;
    }

    /**
     * Desactivar índice de un modelo (soft).
     */
    public static function deactivateModel(Model $model): bool
    {
        return self::where('searchable_type', get_class($model))
            ->where('searchable_id', $model->getKey())
            ->update(['is_active' => false]) > 0;
    }
}
</file>

<file path="app/Models/Unit.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use App\Traits\HasActivityLog;

class Unit extends Model
{
    use SoftDeletes, HasActivityLog;

    protected $table = 'units';

    protected $activityLogNameField = 'name';

    protected $fillable = [
        'uuid',
        'name',
        'slug',
        'symbol',
        'is_base',
        'compatible_base_unit_id',
        'activo',
    ];

    protected $casts = [
        'is_base' => 'boolean',
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->slug) && !empty($model->name)) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::updating(function (self $model): void {
            if ($model->isDirty('name')) {
                $model->slug = Str::slug($model->name);
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function compatibleBaseUnit()
    {
        return $this->belongsTo(Unit::class, 'compatible_base_unit_id');
    }

    public function purchaseUnits()
    {
        return $this->hasMany(Unit::class, 'compatible_base_unit_id');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeBase(Builder $query): Builder
    {
        return $query->where('is_base', true);
    }

    public function scopePurchase(Builder $query): Builder
    {
        return $query->where('is_base', false);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name');
    }

    public function scopeCompatibleWith(Builder $query, int $baseUnitId): Builder
    {
        return $query->where('compatible_base_unit_id', $baseUnitId);
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS ESTÁTICOS
    |--------------------------------------------------------------------------
    */

    public static function getPurchaseUnitsFor(int $baseUnitId): \Illuminate\Database\Eloquent\Collection
    {
        return static::where('activo', true)
            ->where('is_base', false)
            ->where('compatible_base_unit_id', $baseUnitId)
            ->ordered()
            ->get();
    }

    public static function getBaseUnits(): \Illuminate\Database\Eloquent\Collection
    {
        return static::where('activo', true)
            ->where('is_base', true)
            ->ordered()
            ->get();
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getDisplayNameAttribute(): string
    {
        return "{$this->name} ({$this->symbol})";
    }
}
</file>

<file path="database/migrations/0001_01_01_000001_create_cache_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('cache', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->mediumText('value');
            $table->integer('expiration');
        });

        Schema::create('cache_locks', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->string('owner');
            $table->integer('expiration');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('cache');
        Schema::dropIfExists('cache_locks');
    }
};
</file>

<file path="database/migrations/0001_01_01_000002_create_jobs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('jobs', function (Blueprint $table) {
            $table->id();
            $table->string('queue')->index();
            $table->longText('payload');
            $table->unsignedTinyInteger('attempts');
            $table->unsignedInteger('reserved_at')->nullable();
            $table->unsignedInteger('available_at');
            $table->unsignedInteger('created_at');
        });

        Schema::create('job_batches', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->string('name');
            $table->integer('total_jobs');
            $table->integer('pending_jobs');
            $table->integer('failed_jobs');
            $table->longText('failed_job_ids');
            $table->mediumText('options')->nullable();
            $table->integer('cancelled_at')->nullable();
            $table->integer('created_at');
            $table->integer('finished_at')->nullable();
        });

        Schema::create('failed_jobs', function (Blueprint $table) {
            $table->id();
            $table->string('uuid')->unique();
            $table->text('connection');
            $table->text('queue');
            $table->longText('payload');
            $table->longText('exception');
            $table->timestamp('failed_at')->useCurrent();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('jobs');
        Schema::dropIfExists('job_batches');
        Schema::dropIfExists('failed_jobs');
    }
};
</file>

<file path="database/migrations/2025_12_16_174359_create_permission_tables.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        $teams = config('permission.teams');
        $tableNames = config('permission.table_names');
        $columnNames = config('permission.column_names');
        $pivotRole = $columnNames['role_pivot_key'] ?? 'role_id';
        $pivotPermission = $columnNames['permission_pivot_key'] ?? 'permission_id';

        throw_if(empty($tableNames), Exception::class, 'Error: config/permission.php not loaded. Run [php artisan config:clear] and try again.');
        throw_if($teams && empty($columnNames['team_foreign_key'] ?? null), Exception::class, 'Error: team_foreign_key on config/permission.php not loaded. Run [php artisan config:clear] and try again.');

        Schema::create($tableNames['permissions'], static function (Blueprint $table) {
            // $table->engine('InnoDB');
            $table->bigIncrements('id'); // permission id
            $table->string('name');       // For MyISAM use string('name', 225); // (or 166 for InnoDB with Redundant/Compact row format)
            $table->string('guard_name'); // For MyISAM use string('guard_name', 25);
            $table->timestamps();

            $table->unique(['name', 'guard_name']);
        });

        Schema::create($tableNames['roles'], static function (Blueprint $table) use ($teams, $columnNames) {
            // $table->engine('InnoDB');
            $table->bigIncrements('id'); // role id
            if ($teams || config('permission.testing')) { // permission.testing is a fix for sqlite testing
                $table->unsignedBigInteger($columnNames['team_foreign_key'])->nullable();
                $table->index($columnNames['team_foreign_key'], 'roles_team_foreign_key_index');
            }
            $table->string('name');       // For MyISAM use string('name', 225); // (or 166 for InnoDB with Redundant/Compact row format)
            $table->string('guard_name'); // For MyISAM use string('guard_name', 25);
            $table->timestamps();
            if ($teams || config('permission.testing')) {
                $table->unique([$columnNames['team_foreign_key'], 'name', 'guard_name']);
            } else {
                $table->unique(['name', 'guard_name']);
            }
        });

        Schema::create($tableNames['model_has_permissions'], static function (Blueprint $table) use ($tableNames, $columnNames, $pivotPermission, $teams) {
            $table->unsignedBigInteger($pivotPermission);

            $table->string('model_type');
            $table->unsignedBigInteger($columnNames['model_morph_key']);
            $table->index([$columnNames['model_morph_key'], 'model_type'], 'model_has_permissions_model_id_model_type_index');

            $table->foreign($pivotPermission)
                ->references('id') // permission id
                ->on($tableNames['permissions'])
                ->onDelete('cascade');
            if ($teams) {
                $table->unsignedBigInteger($columnNames['team_foreign_key']);
                $table->index($columnNames['team_foreign_key'], 'model_has_permissions_team_foreign_key_index');

                $table->primary([$columnNames['team_foreign_key'], $pivotPermission, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_permissions_permission_model_type_primary');
            } else {
                $table->primary([$pivotPermission, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_permissions_permission_model_type_primary');
            }

        });

        Schema::create($tableNames['model_has_roles'], static function (Blueprint $table) use ($tableNames, $columnNames, $pivotRole, $teams) {
            $table->unsignedBigInteger($pivotRole);

            $table->string('model_type');
            $table->unsignedBigInteger($columnNames['model_morph_key']);
            $table->index([$columnNames['model_morph_key'], 'model_type'], 'model_has_roles_model_id_model_type_index');

            $table->foreign($pivotRole)
                ->references('id') // role id
                ->on($tableNames['roles'])
                ->onDelete('cascade');
            if ($teams) {
                $table->unsignedBigInteger($columnNames['team_foreign_key']);
                $table->index($columnNames['team_foreign_key'], 'model_has_roles_team_foreign_key_index');

                $table->primary([$columnNames['team_foreign_key'], $pivotRole, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_roles_role_model_type_primary');
            } else {
                $table->primary([$pivotRole, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_roles_role_model_type_primary');
            }
        });

        Schema::create($tableNames['role_has_permissions'], static function (Blueprint $table) use ($tableNames, $pivotRole, $pivotPermission) {
            $table->unsignedBigInteger($pivotPermission);
            $table->unsignedBigInteger($pivotRole);

            $table->foreign($pivotPermission)
                ->references('id') // permission id
                ->on($tableNames['permissions'])
                ->onDelete('cascade');

            $table->foreign($pivotRole)
                ->references('id') // role id
                ->on($tableNames['roles'])
                ->onDelete('cascade');

            $table->primary([$pivotPermission, $pivotRole], 'role_has_permissions_permission_id_role_id_primary');
        });

        app('cache')
            ->store(config('permission.cache.store') != 'default' ? config('permission.cache.store') : null)
            ->forget(config('permission.cache.key'));
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        $tableNames = config('permission.table_names');

        throw_if(empty($tableNames), Exception::class, 'Error: config/permission.php not found and defaults could not be merged. Please publish the package configuration before proceeding, or drop the tables manually.');

        Schema::drop($tableNames['role_has_permissions']);
        Schema::drop($tableNames['model_has_roles']);
        Schema::drop($tableNames['model_has_permissions']);
        Schema::drop($tableNames['roles']);
        Schema::drop($tableNames['permissions']);
    }
};
</file>

<file path="database/migrations/2025_12_18_045304_create_recomendacions_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('recomendacion', function (Blueprint $table) {
            $table->id();
            $table->string('nombre_recomendacion');
            $table->string('descripcion_recomendacion')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->string('motivo_baja')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('recomendacion');
    }
};
</file>

<file path="database/migrations/2025_12_18_055620_create_clientes_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('clientes', function (Blueprint $table) {
            $table->id();
            $table->string('nombre');
            $table->string('apellidos');
            $table->string('telefono');
            $table->string('email')->nullable();
            $table->string('direccion')->nullable();
            $table->string('ciudad')->nullable();
            $table->string('codigo_postal')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->string('motivo_baja')->nullable();
            $table->string('observaciones')->nullable();
            $table->string('busto')->nullable();
            $table->string('alto_cintura')->nullable();
            $table->string('cintura')->nullable();
            $table->string('cadera')->nullable();
            $table->string('largo')->nullable();
            $table->foreignId('estado_id')->constrained('estados')->restrictOnDelete();
            $table->foreignId('recomendacion_id')->constrained('recomendacion')->restrictOnDelete();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('clientes');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_19_172828_create_categories_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('categories', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('slug')->unique();
            $table->text('description')->nullable();
            $table->foreignId('parent_id')->nullable()->constrained('categories')->onDelete('cascade');
            $table->integer('order')->default(0);
            $table->boolean('is_active')->default(true);
            $table->timestamps();

            // Índices para optimización
            $table->index('slug');
            $table->index('parent_id');
            $table->index('is_active');
        });
        /*Explicación de campos importantes:
        foreignId('parent_id'): Permite categorías anidadas (subcategorías)
        constrained('categories'): Crea la relación con la misma tabla
        onDelete('cascade'): Si se elimina una categoría padre, se eliminan sus hijas
        index(): Mejora velocidad de búsqueda en estos campos */
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('categories');
    }
};
</file>

<file path="database/migrations/2025_12_19_172926_create_images_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('images', function (Blueprint $table) {
            $table->id();
            $table->morphs('imageable'); // Ya crea el índice automáticamente
            $table->string('file_name');
            $table->string('file_path');
            $table->integer('file_size');
            $table->string('mime_type');
            $table->integer('width')->nullable();
            $table->integer('height')->nullable();
            $table->string('alt_text')->nullable();
            $table->integer('order')->default(0);
            $table->boolean('is_primary')->default(false);
            $table->timestamps();

            // Este índice está duplicado - ELIMINAR esta línea
            //  $table->index(['imageable_type', 'imageable_id']);
        });
        //morphs('imageable'): Crea dos campos para relación polimórfica (permite asociar a múltiples modelos)
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('images');
    }
};
</file>

<file path="database/migrations/2025_12_19_172936_create_category_design_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('category_design', function (Blueprint $table) {
            $table->id();
            $table->foreignId('category_id')->constrained()->onDelete('cascade');
            $table->foreignId('design_id')->constrained()->onDelete('cascade');
            $table->timestamps();

            // Índice compuesto para búsquedas eficientes
            $table->unique(['category_id', 'design_id']);
            $table->index('design_id');
        });
        //unique(['category_id', 'design_id']): Evita duplicados de la misma relación
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('category_design');
    }
};
</file>

<file path="database/migrations/2025_12_19_172942_create_design_variant_attributes_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('design_variant_attributes', function (Blueprint $table) {
            $table->id();
            $table->foreignId('design_variant_id')->constrained()->onDelete('cascade');
            $table->foreignId('attribute_value_id')->constrained()->onDelete('cascade');
            $table->timestamps();

            // Índice compuesto
            $table->unique(['design_variant_id', 'attribute_value_id'], 'variant_attribute_unique');
            $table->index('attribute_value_id');
        });
        //Se especifica nombre corto del índice único porque el nombre automático sería muy largo
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('design_variant_attributes');
    }
};
</file>

<file path="database/migrations/2025_12_20_150609_create_design_variant_images_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('design_variant_images', function (Blueprint $table) {
            $table->id();

            // Relación con variante
            $table->foreignId('design_variant_id')
                ->constrained('design_variants')
                ->onDelete('cascade');

            // Archivo
            $table->string('path');           // storage path
            $table->string('original_name')->nullable();
            $table->string('mime_type')->nullable();
            $table->unsignedBigInteger('size')->nullable();

            // Control visual
            $table->boolean('is_primary')->default(false);
            $table->integer('order')->default(0);

            $table->timestamps();

            // Índices
            $table->index(['design_variant_id', 'is_primary']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('design_variant_images');
    }
};
</file>

<file path="database/migrations/2025_12_24_160930_create_application_types_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('application_types', function (Blueprint $table) {
            $table->id();
            $table->string('slug')->unique(); // Ej: 'manga_izquierda'
            $table->string('nombre_aplicacion');
            $table->string('descripcion')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('application_types');
    }
};
</file>

<file path="database/migrations/2025_12_24_161013_create_design_exports_table.php">
<?php
// Nombre del archivo: 2025_12_25_000001_create_design_exports_table.php
// Ubicación: database/migrations/2025_12_25_000001_create_design_exports_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('design_exports', function (Blueprint $table) {
            $table->id();

            // Relaciones principales
            $table->foreignId('design_id')->constrained()->onDelete('cascade');
            $table->foreignId('design_variant_id')->nullable()->constrained('design_variants')->onDelete('cascade');

            // Información de aplicación
            $table->string('application_type', 50)->default('general');
            $table->string('application_label', 100);
            $table->string('placement_description', 255)->nullable();

            // Archivo técnico
            $table->string('file_name');
            $table->string('file_path');
            $table->string('file_format', 10);
            $table->unsignedBigInteger('file_size')->nullable();
            $table->string('mime_type')->nullable();

            // Datos técnicos
            $table->unsignedInteger('stitches_count')->nullable();
            $table->unsignedInteger('width_mm')->nullable();
            $table->unsignedInteger('height_mm')->nullable();
            $table->unsignedInteger('colors_count')->nullable();
            $table->json('colors_detected')->nullable();

            // Estado
            $table->enum('status', ['borrador', 'pendiente', 'aprobado', 'archivado'])->default('borrador');
            $table->boolean('auto_read_success')->default(false);
            $table->text('notes')->nullable();

            // Auditoría
            $table->foreignId('created_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('approved_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamp('approved_at')->nullable();
            $table->foreignId('application_type_id')->nullable()->constrained('application_types')->nullOnDelete();

            // Timestamps
            $table->timestamps();
            $table->softDeletes();

            // Índices
            $table->index(['design_id']);
            $table->index(['design_variant_id']);
            $table->index(['status']);
            $table->index(['application_type_id']);
            $table->index(['created_by']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('design_exports');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_27_000001_add_image_id_to_design_exports_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Agrega campo image_id para vincular producción con imagen específica.
     */
    public function up(): void
    {
        Schema::table('design_exports', function (Blueprint $table) {
            // Campo para vincular producción a una imagen específica
            // Nullable porque puede ser producción general sin imagen específica
            $table->foreignId('image_id')
                ->nullable()
                ->after('design_variant_id')
                ->constrained('images')
                ->nullOnDelete();

            // Índice para búsquedas por imagen
            $table->index('image_id');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('design_exports', function (Blueprint $table) {
            $table->dropForeign(['image_id']);
            $table->dropIndex(['image_id']);
            $table->dropColumn('image_id');
        });
    }
};
</file>

<file path="database/migrations/2025_12_27_000001_create_search_index_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    /**
     * Run the migrations.
     * 
     * Tabla de índice de búsqueda denormalizado.
     * Permite búsquedas rápidas con texto normalizado y stemmed.
     */
    public function up(): void
    {
        Schema::create('search_index', function (Blueprint $table) {
            $table->id();
            
            // Referencia polimórfica al modelo indexado
            $table->string('searchable_type', 100); // 'Design', 'Category', etc.
            $table->unsignedBigInteger('searchable_id');
            
            // Texto original (para mostrar en resultados)
            $table->string('original_title', 500);
            $table->text('original_content')->nullable();
            
            // Texto normalizado para búsqueda
            // (lowercase, sin acentos, sin caracteres especiales)
            $table->string('normalized_title', 500);
            $table->text('normalized_content')->nullable();
            
            // Tokens stemmed (raíces de palabras)
            // Ejemplo: "perros dorados" → "perr dorad"
            $table->text('stemmed_tokens');
            
            // Metadata para filtros y ordenamiento
            $table->json('metadata')->nullable(); // categorías, tags, etc.
            $table->boolean('is_active')->default(true);
            $table->float('boost', 3, 2)->default(1.00); // Factor de relevancia
            
            // Auditoría
            $table->timestamps();
            
            // Índices compuestos para queries eficientes
            $table->unique(['searchable_type', 'searchable_id'], 'search_idx_unique_model');
            $table->index(['searchable_type', 'is_active'], 'search_idx_type_active');
            $table->index('is_active', 'search_idx_active');
            $table->index('updated_at', 'search_idx_updated');
        });

        // Crear índice FULLTEXT para búsqueda de texto
        // MySQL 5.7+ / MariaDB 10.0.5+ soporta FULLTEXT en InnoDB
        DB::statement('ALTER TABLE search_index ADD FULLTEXT search_ft_normalized (normalized_title, normalized_content)');
        DB::statement('ALTER TABLE search_index ADD FULLTEXT search_ft_stemmed (stemmed_tokens)');
        DB::statement('ALTER TABLE search_index ADD FULLTEXT search_ft_title (normalized_title)');
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('search_index');
    }
};
</file>

<file path="database/migrations/2025_12_27_153719_add_thumbnail_fields_to_images_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Agrega campos para thumbnails optimizados manteniendo la imagen original.
     */
    public function up(): void
    {
        Schema::table('images', function (Blueprint $table) {
            // Thumbnail pequeño para listados/grids (150px)
            $table->string('thumbnail_small')->nullable()->after('file_path');
            // Thumbnail mediano para galerías/modales (400px)
            $table->string('thumbnail_medium')->nullable()->after('thumbnail_small');
            // Indicador de si la imagen ha sido optimizada
            $table->boolean('is_optimized')->default(false)->after('thumbnail_medium');
            // Tamaño original del archivo (para referencia)
            $table->unsignedBigInteger('original_size')->nullable()->after('is_optimized');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('images', function (Blueprint $table) {
            $table->dropColumn(['thumbnail_small', 'thumbnail_medium', 'is_optimized', 'original_size']);
        });
    }
};
</file>

<file path="database/migrations/2025_12_30_120441_create_product_categories_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_categories', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            // Relación con tu tabla de empresas existente
            $table->string('name');
            $table->string('slug');
            $table->text('description')->nullable();
            $table->boolean('is_active')->default(true);
            $table->timestamps();
            $table->softDeletes(); // Para auditoría industrial
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('product_categories');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_30_120458_create_product_extras_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_extras', function (Blueprint $table) {
            $table->id();
            //   $table->foreignId('company_id')->constrained();
            $table->uuid('uuid')->unique();
            $table->string('name'); // Ej: "Encaje de Algodón", "Alforza Triple"
            $table->decimal('cost_addition', 15, 4)->default(0); // Cuánto suma al costo
            $table->decimal('price_addition', 15, 4)->default(0);
            $table->integer('minutes_addition')->default(0); // Tiempo extra de mano de obra
            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_extras');
    }
};
</file>

<file path="database/migrations/2025_12_30_121830_create_products_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();

            // Preparado para futuro SaaS/Sucursales (por ahora puede ser null o defecto 1)
            $table->unsignedBigInteger('tenant_id')->default(1)->index();

            // Relación con la categoría que creamos en el Paso 1
            $table->foreignId('product_category_id')->constrained()->onDelete('cascade');

            $table->string('name'); // Ej: Hipil Tradicional, Cosmetiquera Mezclilla
            $table->string('sku')->unique(); // Código único industrial
            $table->text('description')->nullable();

            // Metadata Industrial: Aquí guardamos tipo de tela base, material interior, etc.
            // Usamos JSON para tener flexibilidad total sin crear mil columnas.
            $table->json('specifications')->nullable();

            $table->enum('status', ['draft', 'active', 'discontinued'])->default('active');

            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('products');
    }
};
</file>

<file path="database/migrations/2025_12_30_121919_create_product_design_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_design', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained()->onDelete('cascade');
            $table->foreignId('design_id')->constrained('designs')->onDelete('cascade');

            // Muy importante: ¿En qué parte del producto va el bordado?
            // Usamos tu tabla existente 'application_types' (Pecho, Manga, etc.)
            $table->foreignId('application_type_id')->constrained('application_types');

            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_design');
    }
};
</file>

<file path="database/migrations/2025_12_30_122410_create_product_variants_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_variants', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('product_id')->constrained()->onDelete('cascade');

            $table->string('sku_variant')->unique(); // Ej: BLU-LIN-BLA-M
            $table->decimal('price', 15, 4)->default(0); // Precio específico de esta combinación

            // Metadata para almacenar los IDs de los atributos (Color: Azul, Tela: Lino)
            // Esto se vincula con tus tablas actuales 'attribute_values'
            $table->json('attribute_combinations')->nullable();

            $table->integer('stock_alert')->default(5); // Alerta de inventario bajo
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_variants');
    }
};
</file>

<file path="database/migrations/2025_12_30_122508_create_product_variant_design_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_variant_design', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_variant_id')->constrained()->onDelete('cascade');

            // Vínculo directo a la tabla que mencionaste: design_exports
            $table->foreignId('design_export_id')->constrained('design_exports')->onDelete('cascade');

            // Posición técnica (Pecho, Espalda, etc.)
            $table->foreignId('application_type_id')->constrained('application_types');
            $table->text('notes')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_variant_design');
    }
};
</file>

<file path="database/migrations/2025_12_30_122818_create_product_extra_assignment_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_extra_assignment', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained()->onDelete('cascade');
            $table->foreignId('product_extra_id')->constrained('product_extras')->onDelete('cascade');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_extra_assignment');
    }
};
</file>

<file path="database/migrations/2025_12_30_124341_create_product_variant_attribute_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_variant_attribute', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_variant_id')->constrained()->onDelete('cascade');
            $table->foreignId('attribute_id')->constrained('attributes');
            $table->foreignId('attribute_value_id')->constrained('attribute_values');
            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_variant_attribute');
    }
};
</file>

<file path="database/migrations/2026_01_02_191615_create_units_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * 
     * Tabla de unidades de medida para el sistema de inventario.
     * Soporta unidades base (metro, pieza) y unidades de compra (rollo, cono, caja).
     */
    public function up(): void
    {
        Schema::create('units', function (Blueprint $table) {
            // Llave primaria
            $table->id();

            // UUID para exposición externa (APIs, URLs públicas)
            $table->uuid('uuid')->unique();

            // Datos principales
            $table->string('name', 50);                    // "Metro", "Rollo", "Cono"
            $table->string('slug', 50)->unique();          // "metro", "rollo", "cono"
            $table->string('symbol', 10);                  // "m", "pz", "cono"

            // Clasificación
            $table->boolean('is_base')->default(false);    // true = unidad de consumo (metro, pieza)
            $table->boolean('activo')->default(true);   // Soft toggle sin eliminar


            // Auditoría
            $table->timestamps();
            $table->softDeletes();

            // Índices para performance
            $table->index('activo');
            $table->index('is_base');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('units');
    }
};
</file>

<file path="database/migrations/2026_01_03_013052_create_system_settings_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('system_settings', function (Blueprint $table) {
            $table->id();
            $table->string('key', 100)->unique();
            $table->text('value')->nullable();
            $table->string('type', 20)->default('string'); // string, integer, boolean, json, select
            $table->string('group', 50)->default('general'); // general, inventario, facturacion, produccion
            $table->string('label', 100);
            $table->string('description', 255)->nullable();
            $table->json('options')->nullable(); // Para tipo select
            $table->foreignId('updated_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamps();

            $table->index('group');
            $table->index('type');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('system_settings');
    }
};
</file>

<file path="database/migrations/2026_01_03_094357_create_activity_logs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('activity_logs', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('user_id')->nullable()->constrained('users')->nullOnDelete();
            $table->string('user_name', 100)->nullable();
            $table->string('action', 30);
            $table->string('model_type', 100);
            $table->unsignedBigInteger('model_id')->nullable();
            $table->string('model_name', 150)->nullable();
            $table->json('old_values')->nullable();
            $table->json('new_values')->nullable();
            $table->json('changed_fields')->nullable();
            $table->string('ip_address', 45)->nullable();
            $table->string('user_agent', 500)->nullable();
            $table->string('url', 500)->nullable();
            $table->string('method', 10)->nullable();
            $table->text('description')->nullable();
            $table->json('metadata')->nullable();
            $table->timestamp('created_at')->useCurrent();

            $table->index('user_id');
            $table->index('action');
            $table->index('model_type');
            $table->index(['model_type', 'model_id']);
            $table->index('created_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('activity_logs');
    }
};
</file>

<file path="database/migrations/2026_01_03_102946_create_material_categories.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('material_categories', function (Blueprint $table) {
            $table->id();
            $table->string('name', 50);
            $table->string('slug', 50)->unique();
            $table->text('description')->nullable();
            $table->foreignId('base_unit_id')->constrained('units')->restrictOnDelete();
            $table->boolean('has_color')->default(true);
            $table->boolean('activo')->default(true);
            $table->timestamps();

            $table->index('activo');
            $table->index('slug');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('material_categories');
    }
};
</file>

<file path="database/migrations/2026_01_03_103133_create_materials.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('materials', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('material_category_id')->constrained('material_categories')->restrictOnDelete();
            $table->string('name', 100);
            $table->string('slug', 100)->unique();
            $table->string('composition', 100)->nullable();
            $table->text('description')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamps();

            $table->index('activo');
            $table->index('slug');
            $table->index('material_category_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('materials');
    }
};
</file>

<file path="database/migrations/2026_01_03_103227_create_material_variants.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('material_variants', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('material_id')->constrained('materials')->cascadeOnDelete();
            $table->string('color', 50)->nullable();
            $table->string('sku', 30)->unique();
            $table->decimal('current_stock', 12, 4)->default(0);
            $table->decimal('min_stock_alert', 12, 4)->default(0);
            $table->decimal('current_value', 14, 4)->default(0);
            $table->decimal('average_cost', 14, 4)->default(0);
            $table->decimal('last_purchase_cost', 14, 4)->default(0);
            $table->boolean('activo')->default(true);
            $table->timestamps();

            $table->index('activo');
            $table->index('sku');
            $table->index('material_id');
            $table->index(['material_id', 'color']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('material_variants');
    }
};
</file>

<file path="database/migrations/2026_01_03_103255_create_material_unit_conversions.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('material_unit_conversions', function (Blueprint $table) {
            $table->id();
            $table->foreignId('material_id')->constrained('materials')->cascadeOnDelete();
            $table->foreignId('from_unit_id')->constrained('units')->restrictOnDelete();
            $table->foreignId('to_unit_id')->constrained('units')->restrictOnDelete();
            $table->decimal('conversion_factor', 12, 4);
            $table->timestamps();

            $table->unique(['material_id', 'from_unit_id'], 'material_unit_unique');
            $table->index('material_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('material_unit_conversions');
    }
};
</file>

<file path="database/migrations/2026_01_03_142851_add_compatible_base_unit_to_units_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('units', function (Blueprint $table) {
            $table->foreignId('compatible_base_unit_id')
                ->nullable()
                ->after('is_base')
                ->constrained('units')
                ->nullOnDelete();
        });
    }

    public function down(): void
    {
        Schema::table('units', function (Blueprint $table) {
            $table->dropForeign(['compatible_base_unit_id']);
            $table->dropColumn('compatible_base_unit_id');
        });
    }
};
</file>

<file path="database/migrations/2026_01_03_150526_create_purchases_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('purchases', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->string('purchase_number', 20)->unique();
            $table->foreignId('proveedor_id')->constrained('proveedors')->restrictOnDelete();
            $table->string('status', 20)->default('borrador');
            $table->decimal('subtotal', 14, 4)->default(0);
            $table->decimal('tax_rate', 5, 2)->default(0);
            $table->decimal('tax_amount', 14, 4)->default(0);
            $table->decimal('discount_amount', 14, 4)->default(0);
            $table->decimal('total', 14, 4)->default(0);
            $table->text('notes')->nullable();
            $table->string('reference', 100)->nullable();
            $table->date('ordered_at')->nullable();
            $table->date('expected_at')->nullable();
            $table->timestamp('received_at')->nullable();
            $table->foreignId('created_by')->constrained('users')->restrictOnDelete();
            $table->foreignId('updated_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('received_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('cancelled_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamp('cancelled_at')->nullable();
            $table->text('cancellation_reason')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamps();
            $table->softDeletes();

            $table->index('status');
            $table->index('proveedor_id');
            $table->index('created_by');
            $table->index('ordered_at');
            $table->index('activo');
            $table->index(['status', 'activo']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('purchases');
    }
};
</file>

<file path="database/migrations/2026_01_03_150553_create_purchase_items_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('purchase_items', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('purchase_id')->constrained('purchases')->cascadeOnDelete();
            $table->foreignId('material_variant_id')->constrained('material_variants')->restrictOnDelete();
            $table->foreignId('unit_id')->constrained('units')->restrictOnDelete();
            $table->decimal('quantity', 12, 4);
            $table->decimal('unit_price', 14, 4);
            $table->decimal('conversion_factor', 12, 4)->default(1);
            $table->decimal('converted_quantity', 12, 4);
            $table->decimal('converted_unit_cost', 14, 4);
            $table->decimal('subtotal', 14, 4);
            $table->decimal('quantity_received', 12, 4)->default(0);
            $table->decimal('converted_quantity_received', 12, 4)->default(0);
            $table->text('notes')->nullable();
            $table->timestamps();

            $table->index('purchase_id');
            $table->index('material_variant_id');
            $table->unique(['purchase_id', 'material_variant_id', 'unit_id'], 'purchase_item_unique');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('purchase_items');
    }
};
</file>

<file path="database/migrations/2026_01_03_150625_create_inventory_movements_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('inventory_movements', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('material_variant_id')->constrained('material_variants')->restrictOnDelete();
            $table->string('type', 30);
            $table->string('reference_type', 50)->nullable();
            $table->unsignedBigInteger('reference_id')->nullable();
            $table->decimal('quantity', 12, 4);
            $table->decimal('unit_cost', 14, 4);
            $table->decimal('total_cost', 14, 4);
            $table->decimal('stock_before', 12, 4);
            $table->decimal('stock_after', 12, 4);
            $table->decimal('average_cost_before', 14, 4);
            $table->decimal('average_cost_after', 14, 4);
            $table->decimal('value_before', 14, 4);
            $table->decimal('value_after', 14, 4);
            $table->text('notes')->nullable();
            $table->foreignId('created_by')->constrained('users')->restrictOnDelete();
            $table->timestamps();

            $table->index('material_variant_id');
            $table->index('type');
            $table->index(['reference_type', 'reference_id']);
            $table->index('created_at');
            $table->index('created_by');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('inventory_movements');
    }
};
</file>

<file path="database/migrations/2026_01_04_090517_create_purchase_receptions_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('purchase_receptions', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('purchase_id')->constrained('purchases')->cascadeOnDelete();
            $table->string('reception_number', 30)->unique();
            $table->string('status', 20)->default('completed');
            $table->string('delivery_note', 100)->nullable();
            $table->text('notes')->nullable();
            $table->timestamp('received_at');
            $table->foreignId('received_by')->constrained('users')->restrictOnDelete();
            $table->timestamp('voided_at')->nullable();
            $table->foreignId('voided_by')->nullable()->constrained('users')->nullOnDelete();
            $table->text('void_reason')->nullable();
            $table->timestamps();

            $table->index('purchase_id');
            $table->index('status');
            $table->index('received_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('purchase_receptions');
    }
};
</file>

<file path="database/migrations/2026_01_04_090551_create_purchase_reception_items_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('purchase_reception_items', function (Blueprint $table) {
            $table->id();
            $table->foreignId('purchase_reception_id')->constrained('purchase_receptions')->cascadeOnDelete();
            $table->foreignId('purchase_item_id')->constrained('purchase_items')->cascadeOnDelete();
            $table->foreignId('material_variant_id')->constrained('material_variants')->restrictOnDelete();
            $table->decimal('quantity_received', 12, 4);
            $table->decimal('converted_quantity', 12, 4);
            $table->decimal('unit_cost', 14, 4);
            $table->foreignId('inventory_movement_id')->nullable()->constrained('inventory_movements')->nullOnDelete();
            $table->timestamps();

            $table->index('purchase_reception_id');
            $table->index('purchase_item_id');
            $table->index('material_variant_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('purchase_reception_items');
    }
};
</file>

<file path="database/migrations/2026_01_05_000000_create_product_materials_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('product_materials', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained('products')->onDelete('cascade');
            // restrict evita que borren un hilo si ya está en una receta
            $table->foreignId('material_variant_id')->constrained('material_variants')->onDelete('restrict');

            // CANTIDAD: Lo que consume 1 unidad de producto
            $table->decimal('quantity', 12, 4);

            // SNAPSHOT FINANCIERO: Guardamos el costo promedio al momento de crear la ficha
            // Esto permite saber cuánto costaba producir el producto hoy, aunque mañana suba el hilo.
            $table->decimal('unit_cost', 14, 4)->default(0);
            $table->decimal('total_cost', 14, 4)->storedAs('quantity * unit_cost');

            $table->boolean('is_primary')->default(false);
            $table->string('notes')->nullable();

            $table->softDeletes(); // Implementación de SoftDeletes
            $table->timestamps();

            // Índices para velocidad de reportes
            $table->index(['product_id', 'is_primary']);
            $table->index('deleted_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('product_materials');
    }
};
</file>

<file path="routes/console.php">
<?php

use Illuminate\Foundation\Inspiring;
use Illuminate\Support\Facades\Artisan;

Artisan::command('inspire', function () {
    $this->comment(Inspiring::quote());
})->purpose('Display an inspiring quote');
</file>

<file path="routes/search.php">
<?php

/*
|--------------------------------------------------------------------------
| RUTAS DE BÚSQUEDA AVANZADA
|--------------------------------------------------------------------------
| 
| Agregar estas rutas a routes/web.php
|
*/

use App\Http\Controllers\SearchController;

// Grupo de rutas de búsqueda con autenticación
Route::middleware(['auth'])->prefix('admin')->group(function () {
    
    // Búsqueda principal (página y AJAX)
    Route::get('search', [SearchController::class, 'index'])
        ->name('admin.search.index');
    
    // Endpoint AJAX para búsqueda en tiempo real
    Route::get('search/ajax', [SearchController::class, 'searchAjax'])
        ->name('admin.search.ajax');
    
    // Autocompletado
    Route::get('search/autocomplete', [SearchController::class, 'autocomplete'])
        ->name('admin.search.autocomplete');
    
    // Health check del sistema de búsqueda (para monitoreo)
    Route::get('search/health', [SearchController::class, 'healthCheck'])
        ->name('admin.search.health');
    
    // Estadísticas del índice (solo admin)
    Route::get('search/stats', [SearchController::class, 'stats'])
        ->name('admin.search.stats');
});

/*
|--------------------------------------------------------------------------
| RUTAS PARA API (opcional, para apps móviles o SPA)
|--------------------------------------------------------------------------
*/

Route::middleware(['auth:sanctum'])->prefix('api/v1')->group(function () {
    
    Route::get('search', [SearchController::class, 'searchAjax'])
        ->name('api.search');
    
    Route::get('search/autocomplete', [SearchController::class, 'autocomplete'])
        ->name('api.search.autocomplete');
});
</file>

<file path="app/Http/Controllers/AttributeController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Attribute;
use App\Models\AttributeValue;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class AttributeController extends Controller
{
    /**
     * Display a listing of the resource.
     * Muestra atributos y valores en la misma vista con dos DataTables
     */
    public function index()
    {
        try {
            $attributes = Attribute::orderBy('order', 'asc')->get();
            $attributeValues = AttributeValue::with('attribute')->orderBy('order', 'asc')->get();

            return view('admin.attributes.index', compact('attributes', 'attributeValues'));
        } catch (\Exception $e) {
            Log::error('Error al cargar atributos: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Error al cargar los atributos');
        }
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.attributes.create');
    }

    /**
     * Store a newly created resource in storage.
     * Validaciones empresariales con protección contra XSS y SQL injection
     */
    public function store(Request $request)
    {
        // Validación con regex para prevenir inyecciones
        $validated = $request->validate([
            'name' => [
                'required',
                'string',
                'max:100',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:attributes,name'
            ],
            'type' => ['nullable', 'in:select,color,text'],
            'is_required' => ['nullable', 'boolean'],
            'order' => ['nullable', 'integer', 'min:0', 'max:9999']
        ], [
            'name.required' => 'El nombre del atributo es obligatorio.',
            'name.regex' => 'El nombre solo puede contener letras y espacios.',
            'name.unique' => 'Ya existe un atributo con este nombre.',
            'name.max' => 'El nombre no puede exceder 100 caracteres.',
            'type.required' => 'El tipo de atributo es obligatorio.',
            'type.in' => 'El tipo de atributo no es válido.',
            'order.integer' => 'El orden debe ser un número entero.',
            'order.min' => 'El orden debe ser mayor o igual a 0.'
        ]);

        DB::beginTransaction();
        try {
            $attribute = new Attribute();
            $attribute->name = mb_strtoupper(trim(htmlspecialchars($request->name, ENT_QUOTES, 'UTF-8')));
            $attribute->slug = Str::slug($request->name);
            $attribute->type = 'select';
            $attribute->is_required = $request->has('is_required') ? true : false;
            $attribute->order = $request->order ?? 0;
            $attribute->save();

            DB::commit();

            Log::info('Atributo creado exitosamente: ' . $attribute->id);
            return redirect()->route('admin.attributes.index')->with('success', 'Atributo creado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al crear atributo: ' . $e->getMessage() . ' | Trace: ' . $e->getTraceAsString());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al crear el atributo. Por favor intente nuevamente.');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Attribute $attribute)
    {
        return redirect()->route('admin.attributes.index');
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        try {
            $attribute = Attribute::findOrFail($id);
            return view('admin.attributes.edit', compact('attribute'));
        } catch (\Exception $e) {
            Log::error('Error al cargar atributo para edición: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Atributo no encontrado');
        }
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        // Validación con regex para prevenir inyecciones
        $validated = $request->validate([
            'name' => [
                'required',
                'string',
                'max:100',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:attributes,name,' . $id
            ],
            'type' => ['in:select,color,text'],
            'is_required' => ['nullable', 'boolean'],
            'order' => ['nullable', 'integer', 'min:0', 'max:9999']
        ], [
            'name.required' => 'El nombre del atributo es obligatorio.',
            'name.regex' => 'El nombre solo puede contener letras y espacios.',
            'name.unique' => 'Ya existe un atributo con este nombre.',
            'name.max' => 'El nombre no puede exceder 100 caracteres.',
            'type.required' => 'El tipo de atributo es obligatorio.',
            'type.in' => 'El tipo de atributo no es válido.',
            'order.integer' => 'El orden debe ser un número entero.',
            'order.min' => 'El orden debe ser mayor o igual a 0.'
        ]);

        DB::beginTransaction();
        try {
            $attribute = Attribute::findOrFail($id);

            $attribute->name = mb_strtoupper(trim(htmlspecialchars($request->name, ENT_QUOTES, 'UTF-8')));
            $attribute->slug = Str::slug($request->name);
            $attribute->type = 'select';
            $attribute->is_required = $request->has('is_required') ? true : false;
            $attribute->order = $request->order ?? 0;

            if (!$attribute->isDirty()) {
                return redirect()->route('admin.attributes.index')->with('info', 'No se realizaron cambios');
            }

            $attribute->save();
            DB::commit();

            Log::info('Atributo actualizado exitosamente: ' . $attribute->id);
            return redirect()->route('admin.attributes.index')->with('success', 'Atributo actualizado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al actualizar atributo: ' . $e->getMessage() . ' | Trace: ' . $e->getTraceAsString());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al actualizar el atributo. Por favor intente nuevamente.');
        }
    }

    /**
     * Show confirmation page before deletion.
     */
    public function confirm_delete($id)
    {
        try {
            $attribute = Attribute::with('values')->findOrFail($id);
            return view('admin.attributes.delete', compact('attribute'));
        } catch (\Exception $e) {
            Log::error('Error al cargar atributo para eliminación: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Atributo no encontrado');
        }
    }

    /**
     * Remove the specified resource from storage.
     * Elimina el atributo y sus valores en cascada (definido en la migración)
     */
    public function destroy($id)
    {
        DB::beginTransaction();
        try {
            // 1. Obtener el atributo con sus valores cargados para optimizar
            $attribute = Attribute::with('values')->findOrFail($id);
            $attributeName = $attribute->name;

            // 2. BLINDAJE DE INTEGRIDAD EMPRESARIAL
            // Verificamos si alguno de los valores de este atributo está en uso 
            // en la tabla pivote de variantes (usando la relación que vimos antes)
            $valuesIds = $attribute->values->pluck('id');

            $isInUse = DB::table('design_variant_attributes')
                ->whereIn('attribute_value_id', $valuesIds)
                ->exists();

            if ($isInUse) {
                DB::rollBack();
                return redirect()->route('admin.attributes.index')
                    ->with('error', "No se puede eliminar '$attributeName' porque sus valores están asignados a variantes de diseño activas.");
            }

            /**
             * 3. CASCADA MANUAL PARA SOFT DELETES
             * Al usar Eloquent sobre la relación, Laravel marca cada hijo con deleted_at
             */
            if ($attribute->values()->exists()) {
                $attribute->values()->delete();
            }

            // 4. Soft Delete del padre
            $attribute->delete();

            DB::commit();

            // 5. Logging Detallado
            Log::info("Atributo y valores eliminados (Soft Delete) por usuario ID: " . Auth::id(), [
                'attribute_id' => $id,
                'name' => $attributeName,
                'affected_values_count' => $valuesIds->count()
            ]);

            return redirect()->route('admin.attributes.index')
                ->with('success', 'Atributo y sus valores asociados eliminados correctamente.');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error("Fallo al eliminar Atributo ID {$id}: " . $e->getMessage());

            return redirect()->route('admin.attributes.index')
                ->with('error', 'Error técnico al intentar eliminar el atributo.');
        }
    }
}
</file>

<file path="app/Http/Controllers/AttributeValueController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Attribute;
use App\Models\AttributeValue;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;

class AttributeValueController extends Controller
{
    /**
     * Display a listing of the resource.
     * Redirige al index principal de atributos
     */
    public function index()
    {
        return redirect()->route('admin.attributes.index');
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        try {
            $attributes = Attribute::orderBy('name', 'asc')->get();
            return view('admin.attributes.values.create', compact('attributes'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de valor de atributo: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al cargar el formulario');
        }
    }

    /**
     * Store a newly created resource in storage.
     * Validaciones empresariales con protección contra XSS y SQL injection
     */
    public function store(Request $request)
    {
        // Obtener el tipo de atributo para validación condicional
        $attribute = Attribute::find($request->attribute_id);
        $isColorType = $attribute && $attribute->slug === 'color';

        // Reglas de validación base
        $rules = [
            'attribute_id' => ['required', 'exists:attributes,id'],
            'value' => [
                'required',
                'string',
                'max:100',
                'regex:/^[a-zA-Z0-9ñÑáéíóúÁÉÍÓÚ\s\-]+$/'
            ],
            'order' => ['nullable', 'integer', 'min:0', 'max:9999']
        ];

        // Agregar validación de hex_color si el atributo es tipo color
        if ($isColorType) {
            $rules['hex_color'] = ['required', 'regex:/^#[0-9A-Fa-f]{6}$/'];
        } else {
            $rules['hex_color'] = ['nullable', 'regex:/^#[0-9A-Fa-f]{6}$/'];
        }

        $validated = $request->validate($rules, [
            'attribute_id.required' => 'Debe seleccionar un atributo.',
            'attribute_id.exists' => 'El atributo seleccionado no existe.',
            'value.required' => 'El valor es obligatorio.',
            'value.regex' => 'El valor solo puede contener letras, números, espacios y guiones.',
            'value.max' => 'El valor no puede exceder 100 caracteres.',
            'hex_color.required' => 'El código de color es obligatorio para atributos tipo color.',
            'hex_color.regex' => 'El código de color debe tener formato hexadecimal válido (#RRGGBB).',
            'order.integer' => 'El orden debe ser un número entero.',
            'order.min' => 'El orden debe ser mayor o igual a 0.'
        ]);

        DB::beginTransaction();
        try {
            $attributeValue = new AttributeValue();
            $attributeValue->attribute_id = $request->attribute_id;
            $attributeValue->value = mb_strtoupper(trim(htmlspecialchars($request->value, ENT_QUOTES, 'UTF-8')));
            $attributeValue->hex_color = $isColorType ? strtoupper(trim($request->hex_color)) : null;
            $attributeValue->order = $request->order ?? 0;
            $attributeValue->save();

            DB::commit();

            Log::info('Valor de atributo creado exitosamente: ' . $attributeValue->id);
            return redirect()->route('admin.attributes.index')->with('success', 'Valor de atributo creado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al crear valor de atributo: ' . $e->getMessage() . ' | Trace: ' . $e->getTraceAsString());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al crear el valor de atributo. Por favor intente nuevamente.');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(AttributeValue $attributeValue)
    {
        return redirect()->route('admin.attributes.index');
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        try {
            $attributeValue = AttributeValue::with('attribute')->findOrFail($id);
            $attributes = Attribute::orderBy('name', 'asc')->get();
            return view('admin.attributes.values.edit', compact('attributeValue', 'attributes'));
        } catch (\Exception $e) {
            Log::error('Error al cargar valor de atributo para edición: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Valor de atributo no encontrado');
        }
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        // 1. Verificación previa de existencia para ahorrar recursos
        $attributeValue = AttributeValue::findOrFail($id);

        // 2. Obtener el Atributo PADRE desde la BD (Fuente de verdad única)
        // No confiamos en lo que el front diga que es el atributo
        $attribute = Attribute::findOrFail($request->attribute_id);
        $isColorType = ($attribute->slug === 'color');

        // 3. Definición dinámica de Reglas de Validación
        $rules = [
            'attribute_id' => ['required', 'exists:attributes,id'],
            'value' => [
                'required',
                'string',
                'max:100',
                // Regex empresarial: permite letras, números, espacios, guiones y tildes
                'regex:/^[a-zA-Z0-9ñÑáéíóúÁÉÍÓÚ\s\-]+$/'
            ],
            'order' => ['nullable', 'integer', 'min:0', 'max:9999']
        ];

        // Lógica de validación cruzada: El HEX es obligatorio SI Y SOLO SI el atributo es Color
        if ($isColorType) {
            $rules['hex_color'] = ['required', 'regex:/^#[0-9A-Fa-f]{6}$/'];
        } else {
            // Si no es color, nos aseguramos de que no envíen basura
            $rules['hex_color'] = ['nullable'];
        }

        // Mensajes personalizados para una UX profesional
        $messages = [
            'value.regex' => 'El formato del nombre no es válido.',
            'hex_color.required' => 'El código de color es obligatorio para este tipo de atributo.',
            'hex_color.regex' => 'El formato de color hexadecimal es inválido.',
        ];

        $request->validate($rules, $messages);

        DB::beginTransaction();
        try {
            // 4. Asignación de Datos con Sanitización Profesional
            $attributeValue->attribute_id = $request->attribute_id;

            // Trim y Capitalización limpia (sin codificar HTML en BD para permitir búsquedas)
            $attributeValue->value = (mb_strtoupper(trim($request->value), 'UTF-8'));

            /** * BLINDAJE DE INTEGRIDAD:
             * Aunque el usuario manipule el HTML y envíe un HEX en una Talla, 
             * aquí forzamos la nulidad basándonos en la BD del servidor.
             */
            $attributeValue->hex_color = $isColorType ? strtoupper(trim($request->hex_color)) : null;

            $attributeValue->order = $request->order ?? 0;

            // 5. Verificación de cambios (isDirty) antes de persistir
            if (!$attributeValue->isDirty()) {
                DB::rollBack(); // Cerramos transacción sin cambios
                return redirect()->route('admin.attributes.index')->with('info', 'No se detectaron cambios en el valor.');
            }

            $attributeValue->save();

            DB::commit();

            Log::info("Valor de atributo actualizado por usuario ID: " . Auth::id(), [
                'value_id' => $attributeValue->id,
                'new_data' => $attributeValue->getChanges()
            ]);

            return redirect()->route('admin.attributes.index')->with('success', 'Valor de atributo actualizado exitosamente.');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error("Fallo crítico en actualización de AttributeValue ID {$id}: " . $e->getMessage());

            return redirect()->back()
                ->withInput()
                ->with('error', 'Hubo un problema técnico. La operación fue abortada para proteger los datos.');
        }
    }

    /**
     * Show confirmation page before deletion.
     */
    public function confirm_delete($id)
    {
        try {
            $attributeValue = AttributeValue::with('attribute')->findOrFail($id);
            return view('admin.attributes.values.delete', compact('attributeValue'));
        } catch (\Exception $e) {
            Log::error('Error al cargar valor de atributo para eliminación: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Valor de atributo no encontrado');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy($id)
    {
        DB::beginTransaction();
        try {
            $attributeValue = AttributeValue::findOrFail($id);
            $valueName = $attributeValue->value;

            $attributeValue->delete();

            DB::commit();

            Log::info('Valor de atributo eliminado exitosamente: ' . $valueName . ' (ID: ' . $id . ')');
            return redirect()->route('admin.attributes.index')->with('success', 'Valor de atributo eliminado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al eliminar valor de atributo: ' . $e->getMessage() . ' | Trace: ' . $e->getTraceAsString());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al eliminar el valor de atributo. Por favor intente nuevamente.');
        }
    }

    /**
     * Get attribute type via AJAX for conditional color picker display
     * @param int $attributeId
     * @return \Illuminate\Http\JsonResponse
     */
    public function getAttributeType($attributeId)
    {
        try {
            $attribute = Attribute::findOrFail($attributeId);
            return response()->json([
                'success' => true,
                'type' => $attribute->type
            ]);
        } catch (\Exception $e) {
            Log::error('Error al obtener tipo de atributo: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Atributo no encontrado'
            ], 404);
        }
    }
}
</file>

<file path="app/Http/Controllers/CategoryController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Category;
use Illuminate\Http\Request;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;

class CategoryController extends Controller
{
    /**
     * Mostrar listado de categorías
     */
    public function index()
    {
        // Obtener categorías con sus padres e hijos
        $categories = Category::with(['parent', 'children'])
            ->where('is_active', true)
            ->whereNull('parent_id') // Solo categorías raíz
            ->orderBy('order')
            ->orderBy('name')
            ->get();

        return view('admin.categorias.index', compact('categories'));
    }

    /**
     * Mostrar formulario para crear categoría
     */
    public function create()
    {
        // Obtener categorías para seleccionar como padre
        $parentCategories = Category::where('is_active', true)
            ->orderBy('name')
            ->get();

        return view('admin.categorias.create', compact('parentCategories'));
    }

    /**
     * Guardar nueva categoría
     */
    public function store(Request $request)
    {

        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:categories,name',
            'description' => 'nullable|string',
            'parent_id' => 'nullable|exists:categories,id',
            'order' => 'nullable|integer|min:0',
            'is_active' => 'boolean'
        ]);

        $validated['slug'] = Str::slug($validated['name']);
        try {
            // Si no se proporciona orden, usar el siguiente disponible
            if (!isset($validated['order'])) {
                $validated['order'] = Category::max('order') + 1;
            }

            $category = Category::create($validated);

            return redirect()
                ->route('admin.categorias.index')
                ->with('success', 'Categoría creada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al crear la categoría: ' . $e->getMessage());
            return redirect()
                ->back()
                ->with('error', 'Error al crear la categoría: ' . $e->getMessage());
        }
    }

    /**
     * Mostrar formulario para editar
     */
    public function edit(Category $category)
    {
        try {
            $parentCategories = Category::where('is_active', true)
                ->where('id', '!=', $category->id) // Evitar seleccionarse a sí misma
                ->orderBy('name')
                ->get();

            return view('admin.categorias.edit', compact('category', 'parentCategories'));
        } catch (\Exception $e) {
            Log::error('Error al editar la categoría: ' . $e->getMessage());
            return redirect()
                ->back()
                ->with('error', 'Error al editar la categoría: ' . $e->getMessage());
        }
    }

    /**
     * Mostrar una categoría con sus diseños
     */
    public function show(Category $category)
    {
        $category->load([
            'designs.primaryImage',
            'children',
            'parent'
        ]);

        return view('admin.categorias.show', compact('category'));
    }



    /**
     * Actualizar categoría
     */
    public function update(Request $request, Category $category)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:categories,name,' . $category->id,
            'description' => 'nullable|string',
            'parent_id' => 'nullable|exists:categories,id',
            'order' => 'nullable|integer|min:0',
            'is_active' => 'boolean'
        ]);
        try {

            // Validar que no se seleccione a sí misma como padre
            if (isset($validated['parent_id']) && $validated['parent_id'] == $category->id) {
                return back()
                    ->with('error', 'Una categoría no puede ser su propia categoría padre')
                    ->withInput();
            }

            if ($category->name !== $validated['name']) {
                $validated['slug'] = Str::slug($validated['name']);
            }

            $category->update($validated);

            return redirect()
                ->route('admin.categorias.index')
                ->with('success', 'Categoría actualizada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar la categoría: ' . $e->getMessage());
            return redirect()
                ->back()
                ->with('error', 'Error al actualizar la categoría: ' . $e->getMessage());
        }
    }

    /**
     * Eliminar categoría
     */
    public function confirm_delete(Category $category)
    {
        //validando que existe el giro
        $category = Category::where('id', $category->id)
            ->where('is_active', true)
            ->firstOrFail();
        if (!$category) {
            return redirect()->route('admin.categorias.index')->with('error', 'Categoría no encontrada');
        }

        return view('admin.categorias.delete', compact('category'));
    }
    public function destroy(Category $category)
    {
        try {

            // Verificar si tiene diseños asociados
            if ($category->designs()->count() > 0) {
                return back()
                    ->with('error', 'No se puede eliminar la categoría porque tiene diseños asociados');
            }

            // Verificar si tiene subcategorías
            if ($category->children()->count() > 0) {
                return back()
                    ->with('error', 'No se puede eliminar la categoría porque tiene subcategorías');
            }

            $category->delete();

            return redirect()
                ->route('admin.categorias.index')
                ->with('success', 'Categoría eliminada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar la categoría: ' . $e->getMessage());
            return redirect()
                ->back()
                ->with('error', 'Error al eliminar la categoría: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/Controller.php">
<?php

namespace App\Http\Controllers;

use Illuminate\Foundation\Auth\Access\AuthorizesRequests;
use Illuminate\Foundation\Validation\ValidatesRequests;
use Illuminate\Routing\Controller as BaseController;

class Controller extends BaseController
{
    use AuthorizesRequests, ValidatesRequests;
}
</file>

<file path="app/Http/Controllers/DesignExportController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Design;
use App\Models\DesignVariant;
use App\Models\DesignExport;
use App\Models\Application_types;
use App\Services\EmbroideryAnalyzerService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;

class DesignExportController extends Controller
{
    protected EmbroideryAnalyzerService $analyzer;

    public function __construct(EmbroideryAnalyzerService $analyzer)
    {
        $this->analyzer = $analyzer;
    }

    // =====================================================================
    // MÉTODOS CRUD ESTÁNDAR (MÓDULO INDEPENDIENTE)
    // =====================================================================

    public function index()
    {
        $exports = DesignExport::with(['design', 'variant', 'creator'])
            ->latest()
            ->paginate(20);
        $tipo_aplicacion = Application_types::activos()->orderBy('nombre_aplicacion')->get();

        return view('admin.production.index', compact('exports', 'tipo_aplicacion'));
    }

    public function create()
    {
        $designs = Design::where('is_active', true)->orderBy('name')->get();
        $applicationTypes = Application_types::activos()->orderBy('nombre_aplicacion')->get();
        return view('admin.production.create', compact('designs', 'applicationTypes'));
    }

    /**
     * Formulario de creación para un diseño específico
     */
    public function createForDesign(Design $design)
    {
        $applicationTypes = Application_types::activos()->orderBy('nombre_aplicacion')->get();
        return view('admin.designs.exports.create', compact('design', 'applicationTypes'));
    }

    /**
     * Formulario de creación para una variante específica
     */
    public function createForVariant(Design $design, DesignVariant $variant)
    {
        // Verificar que la variante pertenece al diseño
        if ($variant->design_id !== $design->id) {
            abort(404, 'Variante no encontrada para este diseño.');
        }

        $applicationTypes = Application_types::activos()->orderBy('nombre_aplicacion')->get();
        return view('admin.design-variants.exports.create', compact('design', 'variant', 'applicationTypes'));
    }

    /**
     * Guardar exportación para un diseño específico
     */
    public function storeForDesign(Request $request, Design $design)
    {
        $validated = $request->validate([
            'application_type' => 'required|string|max:50',
            'application_label' => 'required|string|max:100',
            'placement_description' => 'nullable|string|max:255',
            'file' => 'required|file|mimes:pes,dst,exp,jef,vip,vp3,xxx|max:10240',
            'notes' => 'nullable|string',
        ]);

        $file = $request->file('file');
        $fileName = $this->generateFileName(['design_id' => $design->id, 'application_label' => $validated['application_label']], $file);
        $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

        // Analizar archivo si es posible
        $analysisData = [];
        try {
            $result = $this->analyzer->analyzeFromUpload($file);
            if ($result['success']) {
                $analysisData = [
                    'stitches_count' => $result['total_stitches'] ?? null,
                    'width_mm' => $result['width_mm'] ?? null,
                    'height_mm' => $result['height_mm'] ?? null,
                    'colors_count' => $result['colors_count'] ?? null,
                    'colors_detected' => isset($result['colors']) ? json_encode($result['colors']) : null,
                    'auto_read_success' => true,
                ];
            }
        } catch (\Exception $e) {
            Log::warning('No se pudo analizar el archivo: ' . $e->getMessage());
        }

        DesignExport::create(array_merge([
            'design_id' => $design->id,
            'design_variant_id' => null,
            'application_type' => $validated['application_type'],
            'application_label' => $validated['application_label'],
            'placement_description' => $validated['placement_description'] ?? null,
            'file_name' => $file->getClientOriginalName(),
            'file_path' => $filePath,
            'file_format' => strtoupper($file->getClientOriginalExtension()),
            'file_size' => $file->getSize(),
            'mime_type' => $file->getMimeType(),
            'notes' => $validated['notes'] ?? null,
            'status' => 'borrador',
            'created_by' => Auth::id(),
        ], $analysisData));

        return redirect()->route('admin.designs.index')
            ->with('success', 'Exportación creada correctamente para el diseño.');
    }

    /**
     * Guardar exportación para una variante específica
     */
    public function storeForVariant(Request $request, Design $design, DesignVariant $variant)
    {
        if ($variant->design_id !== $design->id) {
            abort(404, 'Variante no encontrada para este diseño.');
        }

        $validated = $request->validate([
            'application_type' => 'required|string|max:50',
            'application_label' => 'required|string|max:100',
            'placement_description' => 'nullable|string|max:255',
            'file' => 'required|file|mimes:pes,dst,exp,jef,vip,vp3,xxx|max:10240',
            'notes' => 'nullable|string',
        ]);

        $file = $request->file('file');
        $fileName = $this->generateFileName([
            'design_id' => $design->id,
            'design_variant_id' => $variant->id,
            'application_label' => $validated['application_label']
        ], $file);
        $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

        // Analizar archivo si es posible
        $analysisData = [];
        try {
            $result = $this->analyzer->analyzeFromUpload($file);
            if ($result['success']) {
                $analysisData = [
                    'stitches_count' => $result['total_stitches'] ?? null,
                    'width_mm' => $result['width_mm'] ?? null,
                    'height_mm' => $result['height_mm'] ?? null,
                    'colors_count' => $result['colors_count'] ?? null,
                    'colors_detected' => isset($result['colors']) ? json_encode($result['colors']) : null,
                    'auto_read_success' => true,
                ];
            }
        } catch (\Exception $e) {
            Log::warning('No se pudo analizar el archivo: ' . $e->getMessage());
        }

        DesignExport::create(array_merge([
            'design_id' => $design->id,
            'design_variant_id' => $variant->id,
            'application_type' => $validated['application_type'],
            'application_label' => $validated['application_label'],
            'placement_description' => $validated['placement_description'] ?? null,
            'file_name' => $file->getClientOriginalName(),
            'file_path' => $filePath,
            'file_format' => strtoupper($file->getClientOriginalExtension()),
            'file_size' => $file->getSize(),
            'mime_type' => $file->getMimeType(),
            'notes' => $validated['notes'] ?? null,
            'status' => 'borrador',
            'created_by' => Auth::id(),
        ], $analysisData));

        return redirect()->route('admin.designs.index')
            ->with('success', 'Exportación creada correctamente para la variante.');
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'design_id' => 'required|exists:designs,id',
            'design_variant_id' => 'nullable|exists:design_variants,id',
            'application_type' => 'required|exists:application_types,id',
            'application_label' => 'required|string|max:100',
            'placement_description' => 'nullable|string|max:255',
            'file' => 'required|file|mimes:pes,dst,exp,jef,vip,vp3,xxx|max:10240',
            'stitches_count' => 'nullable|integer|min:0',
            'width_mm' => 'nullable|integer|min:0',
            'height_mm' => 'nullable|integer|min:0',
            'colors_count' => 'nullable|integer|min:0',
            'colors_detected' => 'nullable|json',
            'notes' => 'nullable|string',
        ]);

        if ($request->hasFile('file')) {
            $file = $request->file('file');
            $fileName = $this->generateFileName($validated, $file);
            $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

            $validated['file_name'] = $file->getClientOriginalName();
            $validated['file_path'] = $filePath;
            $validated['file_format'] = strtoupper($file->getClientOriginalExtension());
            $validated['file_size'] = $file->getSize();
            $validated['mime_type'] = $file->getMimeType();
        }

        $validated['created_by'] = Auth::id();
        $validated['status'] = 'borrador';

        DesignExport::create($validated);

        return redirect()->route('admin.production.index')
            ->with('success', 'Exportación creada correctamente.');
    }

    public function show(DesignExport $export)
    {
        $export->load(['design', 'variant', 'creator', 'approver']);
        return view('admin.production.show', compact('export'));
    }

    public function edit(DesignExport $export)
    {
        $export->load(['design', 'variant']);
        $designs = Design::where('is_active', true)->orderBy('name')->get();
        $variants = $export->design ? $export->design->variants : collect();

        return view('admin.production.edit', compact('export', 'designs', 'variants'));
    }

    public function update(Request $request, DesignExport $export)
    {
        $validated = $request->validate([
            'design_id' => 'required|exists:designs,id',
            'design_variant_id' => 'nullable|exists:design_variants,id',
            'application_type' => 'required|string|max:50',
            'application_label' => 'required|string|max:100',
            'placement_description' => 'nullable|string|max:255',
            'file' => 'nullable|file|mimes:pes,dst,exp,jef,vip,vp3,xxx|max:10240',
            'stitches_count' => 'nullable|integer|min:0',
            'width_mm' => 'nullable|integer|min:0',
            'height_mm' => 'nullable|integer|min:0',
            'colors_count' => 'nullable|integer|min:0',
            'colors_detected' => 'nullable|json',
            'status' => 'required|in:borrador,pendiente,aprobado,archivado',
            'notes' => 'nullable|string',
        ]);

        if ($request->hasFile('file')) {
            if ($export->file_path && Storage::disk('public')->exists($export->file_path)) {
                Storage::disk('public')->delete($export->file_path);
            }

            $file = $request->file('file');
            $fileName = $this->generateFileName($validated, $file);
            $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

            $validated['file_name'] = $file->getClientOriginalName();
            $validated['file_path'] = $filePath;
            $validated['file_format'] = strtoupper($file->getClientOriginalExtension());
            $validated['file_size'] = $file->getSize();
            $validated['mime_type'] = $file->getMimeType();
            $validated['auto_read_success'] = false;
        }

        if ($validated['status'] === 'aprobado' && $export->status !== 'aprobado') {
            $validated['approved_by'] = Auth::id();
            $validated['approved_at'] = now();
        } elseif ($validated['status'] !== 'aprobado') {
            $validated['approved_by'] = null;
            $validated['approved_at'] = null;
        }

        $export->update($validated);

        return redirect()->route('admin.production.index')
            ->with('success', 'Exportación actualizada correctamente.');
    }

    public function destroy(DesignExport $export)
    {
        if ($export->file_path && Storage::disk('public')->exists($export->file_path)) {
            Storage::disk('public')->delete($export->file_path);
        }

        $export->delete();

        return redirect()->route('admin.production.index')
            ->with('success', 'Exportación eliminada correctamente.');
    }

    public function download(DesignExport $export)
    {
        if (!$export->file_path || !Storage::disk('public')->exists($export->file_path)) {
            return back()->with('error', 'Archivo no encontrado.');
        }

        return Storage::disk('public')->download($export->file_path, $export->file_name);
    }

    // =====================================================================
    // MÉTODOS AJAX PARA EL MODAL
    // =====================================================================

    public function analyzeFile(Request $request)
    {
        try {
            $request->validate(['file' => 'required|file|max:10240']);

            $file = $request->file('file');
            $extension = strtolower($file->getClientOriginalExtension());

            if (!$this->analyzer->isValidExtension($extension)) {
                return response()->json([
                    'success' => false,
                    'error' => "Formato no soportado: .{$extension}. Formatos permitidos: " .
                        $this->analyzer->getAllowedExtensionsString()
                ], 400);
            }

            $result = $this->analyzer->analyzeFromUpload($file);

            if ($result['success']) {
                return response()->json([
                    'success' => true,
                    'data' => [
                        'file_name' => $result['original_name'] ?? $result['file_name'],
                        'file_format' => $result['file_format'],
                        'file_size' => $result['file_size'],
                        'total_stitches' => $result['total_stitches'],
                        'stitches_count' => $result['total_stitches'],
                        'colors_count' => $result['colors_count'],
                        'width_mm' => $result['width_mm'],
                        'height_mm' => $result['height_mm'],
                        'colors' => $result['colors'],
                        'dimensions_formatted' => "{$result['width_mm']} x {$result['height_mm']} mm",
                        'stitches_formatted' => number_format($result['total_stitches'], 0, '.', ','),
                    ]
                ]);
            } else {
                return response()->json([
                    'success' => false,
                    'error' => $result['error'] ?? 'Error al analizar el archivo.',
                    'allow_manual' => true
                ], 400);
            }
        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'error' => 'Archivo no válido o demasiado grande (máximo 10MB).'
            ], 400);
        } catch (\Exception $e) {
            Log::error('Error en analyzeFile: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error interno al procesar el archivo.',
                'allow_manual' => true
            ], 500);
        }
    }

    public function storeAjax(Request $request)
    {
        try {
            $validated = $request->validate([
                'design_id' => 'required|exists:designs,id',
                'design_variant_id' => 'nullable|exists:design_variants,id',
                'image_id' => 'nullable|exists:images,id',
                'application_type' => ['required', 'string', 'max:50', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_]+$/'],
                'application_label' => ['required', 'string', 'max:100', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/#]+$/'],
                'placement_description' => ['nullable', 'string', 'max:255', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/#]*$/'],
                'file' => 'required|file|max:10240',
                'stitches_count' => 'nullable|integer|min:0',
                'width_mm' => 'nullable|numeric|min:0',
                'height_mm' => 'nullable|numeric|min:0',
                'colors_count' => 'nullable|integer|min:0',
                'colors_detected' => 'nullable',
                'notes' => ['nullable', 'string', 'max:1000', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/\n\r#@!?]*$/'],
                'auto_read_success' => 'nullable|boolean',
            ], [
                'application_type.regex' => 'El tipo de aplicación contiene caracteres no permitidos.',
                'application_label.regex' => 'La etiqueta contiene caracteres no permitidos (evita: ´¨{}|<>\\`)',
                'placement_description.regex' => 'La descripción contiene caracteres no permitidos.',
                'notes.regex' => 'Las notas contienen caracteres no permitidos.',
            ]);

            $file = $request->file('file');
            $extension = strtolower($file->getClientOriginalExtension());

            if (!$this->analyzer->isValidExtension($extension)) {
                return response()->json([
                    'success' => false,
                    'error' => "Formato no soportado: .{$extension}"
                ], 400);
            }

            $fileName = $this->generateFileName($validated, $file);
            $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

            $exportData = [
                'design_id' => $validated['design_id'],
                'design_variant_id' => $validated['design_variant_id'] ?? null,
                'image_id' => $validated['image_id'] ?? null,
                'application_type' => $this->sanitizeText($validated['application_type']),
                'application_label' => $this->sanitizeText($validated['application_label']),
                'placement_description' => $this->sanitizeText($validated['placement_description'] ?? null),
                'file_name' => $file->getClientOriginalName(),
                'file_path' => $filePath,
                'file_format' => strtoupper($extension),
                'file_size' => $file->getSize(),
                'mime_type' => $file->getMimeType(),
                'stitches_count' => $validated['stitches_count'] ?? null,
                'width_mm' => isset($validated['width_mm']) ? round($validated['width_mm']) : null,
                'height_mm' => isset($validated['height_mm']) ? round($validated['height_mm']) : null,
                'colors_count' => $validated['colors_count'] ?? null,
                'colors_detected' => isset($validated['colors_detected']) ?
                    (is_string($validated['colors_detected']) ? $validated['colors_detected'] : json_encode($validated['colors_detected'])) : null,
                'notes' => $this->sanitizeText($validated['notes'] ?? null),
                'status' => 'borrador',
                'created_by' => Auth::id(),
                'auto_read_success' => $request->boolean('auto_read_success', false),
            ];

            $export = DesignExport::create($exportData);
            $export->load(['creator:id,name']);

            return response()->json([
                'success' => true,
                'message' => 'Exportación creada correctamente.',
                'data' => $this->formatExportForJson($export)
            ]);
        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'error' => $e->errors()[array_key_first($e->errors())][0] ?? 'Datos inválidos.',
                'errors' => $e->errors()
            ], 422);
        } catch (\Exception $e) {
            Log::error('Error en storeAjax: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error al guardar: ' . $e->getMessage()
            ], 500);
        }
    }

    public function updateAjax(Request $request, DesignExport $export)
    {
        try {
            $validated = $request->validate([
                'application_type' => ['required', 'string', 'max:50', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_]+$/'],
                'application_label' => ['required', 'string', 'max:100', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/#]+$/'],
                'placement_description' => ['nullable', 'string', 'max:255', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/#]*$/'],
                'notes' => ['nullable', 'string', 'max:1000', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/\n\r#@!?]*$/'],
                'stitches_count' => 'nullable|integer|min:0',
                'width_mm' => 'nullable|numeric|min:0',
                'height_mm' => 'nullable|numeric|min:0',
                'colors_count' => 'nullable|integer|min:0',
            ], [
                'application_type.regex' => 'El tipo de aplicación contiene caracteres no permitidos.',
                'application_label.regex' => 'La etiqueta contiene caracteres no permitidos. Evita usar: ´ ¨ { } | < > \\ `',
                'placement_description.regex' => 'La descripción contiene caracteres no permitidos.',
                'notes.regex' => 'Las notas contienen caracteres no permitidos.',
            ]);

            $export->update([
                'application_type' => $this->sanitizeText($validated['application_type']),
                'application_label' => $this->sanitizeText($validated['application_label']),
                'placement_description' => $this->sanitizeText($validated['placement_description'] ?? null),
                'notes' => $this->sanitizeText($validated['notes'] ?? null),
                'stitches_count' => $validated['stitches_count'] ?? $export->stitches_count,
                'width_mm' => $validated['width_mm'] ?? $export->width_mm,
                'height_mm' => $validated['height_mm'] ?? $export->height_mm,
                'colors_count' => $validated['colors_count'] ?? $export->colors_count,
            ]);

            $export->load(['creator:id,name', 'approver:id,name']);

            return response()->json([
                'success' => true,
                'message' => 'Exportación actualizada.',
                'data' => $this->formatExportForJson($export)
            ]);
        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'error' => $e->errors()[array_key_first($e->errors())][0] ?? 'Datos inválidos.',
                'errors' => $e->errors()
            ], 422);
        } catch (\Exception $e) {
            Log::error('Error en updateAjax: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error al actualizar.'
            ], 500);
        }
    }

    public function updateStatus(Request $request, DesignExport $export)
    {
        try {
            $validated = $request->validate([
                'status' => 'required|in:borrador,pendiente,aprobado,archivado',
            ]);

            $newStatus = $validated['status'];
            $updateData = ['status' => $newStatus];

            if ($newStatus === 'aprobado' && $export->status !== 'aprobado') {
                $updateData['approved_by'] = Auth::id();
                $updateData['approved_at'] = now();
            } elseif ($newStatus !== 'aprobado' && $export->status === 'aprobado') {
                $updateData['approved_by'] = null;
                $updateData['approved_at'] = null;
            }

            $export->update($updateData);
            $export->load(['approver:id,name']);

            return response()->json([
                'success' => true,
                'message' => 'Estado actualizado.',
                'data' => [
                    'id' => $export->id,
                    'status' => $export->status,
                    'status_label' => $this->getStatusLabel($export->status),
                    'status_color' => $this->getStatusColor($export->status),
                    'approved_by' => $export->approver?->name,
                    'approved_at' => $export->approved_at?->format('d/m/Y H:i'),
                ]
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'error' => 'Error al actualizar estado.'], 500);
        }
    }

    public function getExportsCount(Design $design)
    {
        try {
            $count = DesignExport::where('design_id', $design->id)->count();
            return response()->json(['success' => true, 'count' => $count, 'design_id' => $design->id]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'count' => 0], 500);
        }
    }

    /**
     * Obtener contador de exportaciones del diseño que NO tienen image_id específico.
     * Esto es para mostrar en el badge de la imagen principal del diseño.
     */
    public function getExportsWithoutImageCount(Design $design)
    {
        try {
            // Contar producciones del diseño que no tienen image_id (diseño general)
            $count = DesignExport::where('design_id', $design->id)
                ->whereNull('image_id')
                ->whereNull('design_variant_id')
                ->count();

            return response()->json([
                'success' => true,
                'count' => $count,
                'design_id' => $design->id
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'count' => 0], 500);
        }
    }

    /**
     * Obtener contador de exportaciones para una imagen específica.
     */
    public function getImageExportsCount($imageId)
    {
        try {
            $count = DesignExport::where('image_id', $imageId)->count();
            return response()->json([
                'success' => true,
                'count' => $count,
                'image_id' => $imageId
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'count' => 0], 500);
        }
    }

    /**
     * Obtener contadores de exportaciones para múltiples imágenes (batch).
     * Reduce múltiples peticiones AJAX a una sola.
     */
    public function getImagesExportsCounts(Request $request)
    {
        try {
            $imageIds = $request->input('image_ids', []);

            if (empty($imageIds)) {
                return response()->json(['success' => true, 'counts' => []]);
            }

            // Una sola consulta para todos los contadores
            $counts = DesignExport::whereIn('image_id', $imageIds)
                ->selectRaw('image_id, COUNT(*) as count')
                ->groupBy('image_id')
                ->pluck('count', 'image_id')
                ->toArray();

            // Asegurar que todas las imágenes tengan un contador (0 si no hay)
            $result = [];
            foreach ($imageIds as $id) {
                $result[$id] = $counts[$id] ?? 0;
            }

            return response()->json([
                'success' => true,
                'counts' => $result
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'counts' => []], 500);
        }
    }

    /**
     * Obtener exportaciones vinculadas a una imagen específica.
     */
    public function getImageExports($imageId)
    {
        try {
            $exports = DesignExport::where('image_id', $imageId)
                ->with(['creator:id,name', 'design:id,name', 'variant:id,name'])
                ->orderByDesc('created_at')
                ->get()
                ->map(fn($e) => $this->formatExportForJson($e));

            return response()->json([
                'success' => true,
                'data' => $exports,
                'count' => $exports->count(),
                'image_id' => $imageId
            ]);
        } catch (\Exception $e) {
            Log::error('Error al obtener exportaciones de imagen: ' . $e->getMessage());
            return response()->json(['success' => false, 'data' => [], 'count' => 0], 500);
        }
    }

    public function getExport(DesignExport $export)
    {
        try {
            $export->load(['creator:id,name', 'approver:id,name', 'design:id,name', 'variant:id,name']);
            return response()->json(['success' => true, 'data' => $this->formatExportForJson($export)]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'error' => 'Error al cargar.'], 500);
        }
    }

    public function destroyAjax(DesignExport $export)
    {
        try {
            if ($export->file_path && Storage::disk('public')->exists($export->file_path)) {
                Storage::disk('public')->delete($export->file_path);
            }
            $export->delete();
            return response()->json(['success' => true, 'message' => 'Exportación eliminada.']);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'error' => 'Error al eliminar.'], 500);
        }
    }

    public function getApplicationTypes()
    {
        try {
            $tipos = Application_types::activos()
                ->orderBy('nombre_aplicacion')
                ->get()
                ->map(function ($tipo) {
                    return [
                        'value' => $tipo->slug,
                        'label' => $tipo->nombre_aplicacion,
                        'id' => $tipo->id,
                    ];
                });

            return response()->json([
                'success' => true,
                'data' => $tipos
            ]);
        } catch (\Exception $e) {
            Log::error('Error al obtener tipos de aplicación: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error al cargar tipos de aplicación',
                'data' => []
            ], 500);
        }
    }

    public function getAllowedExtensions()
    {
        return response()->json([
            'success' => true,
            'data' => $this->analyzer->getAllowedExtensions(),
            'string' => $this->analyzer->getAllowedExtensionsString()
        ]);
    }

    /**
     * Obtener exportaciones de un diseño (sin variante específica)
     * Usado cuando se ve una variante específica
     */
    public function getDesignExports(Design $design)
    {
        try {
            $exports = DesignExport::where('design_id', $design->id)
                ->whereNull('design_variant_id')
                ->with(['creator:id,name', 'approver:id,name'])
                ->latest()
                ->get()
                ->map(fn($export) => $this->formatExportForJson($export));

            return response()->json(['success' => true, 'data' => $exports, 'count' => $exports->count()]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'data' => []], 500);
        }
    }

    /**
     * Obtener exportaciones de una variante específica
     */
    public function getVariantExports(Design $design, DesignVariant $variant)
    {
        try {
            if ($variant->design_id != $design->id) {
                return response()->json(['success' => false, 'message' => 'Variante inválida.', 'data' => []], 400);
            }

            $exports = DesignExport::where('design_variant_id', $variant->id)
                ->with(['creator:id,name', 'approver:id,name'])
                ->latest()
                ->get()
                ->map(fn($export) => $this->formatExportForJson($export));

            // Calcular resumen de estados
            $summary = [
                'borrador' => $exports->where('status', 'borrador')->count(),
                'pendiente' => $exports->where('status', 'pendiente')->count(),
                'aprobado' => $exports->where('status', 'aprobado')->count(),
                'archivado' => $exports->where('status', 'archivado')->count(),
            ];

            return response()->json([
                'success' => true,
                'data' => $exports,
                'count' => $exports->count(),
                'summary' => $summary,
                'context' => 'variant',
                'context_name' => $variant->name,
                'context_id' => $variant->id
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'data' => []], 500);
        }
    }

    /**
     * ⭐ NUEVO MÉTODO: Obtener TODAS las exportaciones de un diseño agrupadas por variante
     * Usado cuando se está en la imagen principal del diseño
     */
    public function getAllDesignExportsGrouped(Design $design)
    {
        try {
            $design->load(['variants' => function ($query) {
                $query->with(['images' => function ($q) {
                    $q->orderBy('order')->limit(1);
                }]);
            }]);

            // Obtener TODAS las exportaciones del diseño
            $allExports = DesignExport::where('design_id', $design->id)
                ->with([
                    'creator:id,name',
                    'approver:id,name',
                    'variant:id,name',
                    'variant.images',
                    'image',
                    'design.primaryImage'
                ])
                ->latest()
                ->get();

            // Calcular resumen global de estados
            $summary = [
                'borrador' => $allExports->where('status', 'borrador')->count(),
                'pendiente' => $allExports->where('status', 'pendiente')->count(),
                'aprobado' => $allExports->where('status', 'aprobado')->count(),
                'archivado' => $allExports->where('status', 'archivado')->count(),
            ];

            // Agrupar por variante
            $groups = [];

            // Grupo 1: Exportaciones del diseño principal (sin variante)
            $designExports = $allExports->whereNull('design_variant_id')->values();
            if ($designExports->count() > 0) {
                $groups[] = [
                    'type' => 'design',
                    'name' => 'Diseño Principal',
                    'variant_id' => null,
                    'thumbnail' => $design->primaryImage ? asset('storage/' . $design->primaryImage->file_path) : null,
                    'count' => $designExports->count(),
                    'exports' => $designExports->map(fn($export) => $this->formatExportForJson($export))->values()
                ];
            }

            // Grupos por cada variante
            foreach ($design->variants as $variant) {
                $variantExports = $allExports->where('design_variant_id', $variant->id)->values();
                if ($variantExports->count() > 0) {
                    $thumbnail = null;
                    if ($variant->images && $variant->images->count() > 0) {
                        $thumbnail = asset('storage/' . $variant->images->first()->file_path);
                    }

                    $groups[] = [
                        'type' => 'variant',
                        'name' => $variant->name,
                        'variant_id' => $variant->id,
                        'thumbnail' => $thumbnail,
                        'count' => $variantExports->count(),
                        'exports' => $variantExports->map(fn($export) => $this->formatExportForJson($export))->values()
                    ];
                }
            }

            // Lista de variantes para el filtro
            $variantsList = $design->variants->map(function ($v) use ($allExports) {
                return [
                    'id' => $v->id,
                    'name' => $v->name,
                    'count' => $allExports->where('design_variant_id', $v->id)->count()
                ];
            })->values();

            return response()->json([
                'success' => true,
                'context' => 'design',
                'design_id' => $design->id,
                'design_name' => $design->name,
                'total_count' => $allExports->count(),
                'summary' => $summary,
                'groups' => $groups,
                'variants_list' => $variantsList
            ]);
        } catch (\Exception $e) {
            Log::error('Error en getAllDesignExportsGrouped: ' . $e->getMessage());
            return response()->json(['success' => false, 'error' => 'Error al cargar exportaciones.'], 500);
        }
    }

    // =====================================================================
    // MÉTODOS PRIVADOS
    // =====================================================================

    private function sanitizeText(?string $text): ?string
    {
        if ($text === null) return null;

        $text = strip_tags($text);
        $dangerousChars = ['<', '>', '"', "'", '&', '\\', '`', '{', '}', '|', '´', '¨', '^', '~'];
        $text = str_replace($dangerousChars, '', $text);
        $text = preg_replace('/\s+/', ' ', $text);

        return trim($text);
    }

    private function formatExportForJson(DesignExport $export): array
    {
        $colors = [];
        if ($export->colors_detected) {
            try {
                $colors = is_string($export->colors_detected)
                    ? json_decode($export->colors_detected, true)
                    : $export->colors_detected;
            } catch (\Exception $e) {
                $colors = [];
            }
        }

        // Determinar la imagen a mostrar (vinculada, de variante o del diseño)
        $imageUrl = null;
        if ($export->image_id && $export->image) {
            // Imagen vinculada directamente
            $imageUrl = asset('storage/' . $export->image->file_path);
        } elseif ($export->variant && $export->variant->images->count() > 0) {
            // Primera imagen de la variante
            $imageUrl = asset('storage/' . $export->variant->images->first()->file_path);
        } elseif ($export->design && $export->design->primaryImage) {
            // Imagen principal del diseño
            $imageUrl = asset('storage/' . $export->design->primaryImage->file_path);
        }

        return [
            'id' => $export->id,
            'design_id' => $export->design_id,
            'design_variant_id' => $export->design_variant_id,
            'image_id' => $export->image_id,
            'image_url' => $imageUrl,
            'variant_name' => $export->variant?->name ?? null,
            'application_label' => $export->application_label ?? 'Sin nombre',
            'application_type' => $export->application_type,
            'application_type_label' => $this->getApplicationTypeLabel($export->application_type),
            'placement_description' => $export->placement_description,
            'file_name' => $export->file_name,
            'file_format' => $export->file_format,
            'file_size' => $export->file_size,
            'file_size_formatted' => $this->formatFileSize($export->file_size),
            'stitches_count' => $export->stitches_count ?? 0,
            'stitches_formatted' => $export->stitches_count ? number_format($export->stitches_count, 0, '.', ',') : '--',
            'dimensions_formatted' => ($export->width_mm && $export->height_mm)
                ? "{$export->width_mm} x {$export->height_mm} mm" : '--',
            'width_mm' => $export->width_mm,
            'height_mm' => $export->height_mm,
            'colors_count' => $export->colors_count ?? 0,
            'colors_detected' => $colors,
            'status' => $export->status ?? 'borrador',
            'status_label' => $this->getStatusLabel($export->status),
            'status_color' => $this->getStatusColor($export->status),
            'auto_read_success' => (bool) $export->auto_read_success,
            'notes' => $export->notes,
            'created_at' => $export->created_at->format('d/m/Y H:i'),
            'updated_at' => $export->updated_at->format('d/m/Y H:i'),
            'creator_name' => $export->creator->name ?? 'Sistema',
            'approver_name' => $export->approver->name ?? null,
            'approved_at' => $export->approved_at?->format('d/m/Y H:i'),
            'download_url' => route('admin.production.download', $export),
            'edit_url' => route('admin.production.edit', $export),
        ];
    }

    private function generateFileName(array $data, $file): string
    {
        $designId = $data['design_id'] ?? '0';
        $variantId = $data['design_variant_id'] ?? '0';
        $application = Str::slug(substr($data['application_label'] ?? 'export', 0, 30));
        $timestamp = time();
        $extension = $file->getClientOriginalExtension();
        return "d{$designId}_v{$variantId}_{$application}_{$timestamp}.{$extension}";
    }

    private function getApplicationTypeLabel(?string $type): string
    {
        $labels = [
            'pecho'           => 'Pecho',
            'espalda'         => 'Espalda',
            'manga_izquierda' => 'Manga Izquierda',
            'manga_izq'       => 'Manga Izquierda', // Alias
            'manga_derecha'   => 'Manga Derecha',
            'manga_der'       => 'Manga Derecha',   // Alias
            'gorra'           => 'Gorra',
            'bolsillo'        => 'Bolsillo',
            'cuello'          => 'Cuello',
            'nuca'            => 'Nuca (Espalda)',
            'parche'          => 'Parche',
            'otro'            => 'Otro',
        ];
        return $labels[$type] ?? ucfirst($type ?? 'Desconocido');
    }

    private function getStatusLabel(?string $status): string
    {
        $labels = ['borrador' => 'Borrador', 'pendiente' => 'Pendiente', 'aprobado' => 'Aprobado', 'archivado' => 'Archivado'];
        return $labels[$status] ?? 'Desconocido';
    }

    private function getStatusColor(?string $status): string
    {
        $colors = ['borrador' => '#6b7280', 'pendiente' => '#f59e0b', 'aprobado' => '#10b981', 'archivado' => '#1f2937'];
        return $colors[$status] ?? '#6b7280';
    }

    private function formatFileSize(?int $bytes): string
    {
        if (!$bytes) return '0 B';
        $units = ['B', 'KB', 'MB', 'GB'];
        $factor = floor((strlen($bytes) - 1) / 3);
        return sprintf("%.1f %s", $bytes / pow(1024, $factor), $units[$factor]);
    }
}
</file>

<file path="app/Http/Controllers/GiroController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Giro;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class GiroController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $giros = Giro::all()->where('activo', true);
        return view('admin.giros.index', compact('giros'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.giros.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre_giro' => ['required', 'string', 'max:255', 'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/'],
        ]);
        try {
            $giro = new Giro();
            $giro->nombre_giro = strtoupper(trim($request->nombre_giro));
            $giro->save();
            return redirect()->route('admin.giros.index')->with('success', 'Giro guardado exitosamente');
        } catch (\Exception $e) {
            return redirect()->route('admin.giros.index')->with('error', 'Error al guardar el giro: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Giro $giro)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $giro = Giro::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$giro) {
            return redirect()->route('admin.giros.index')->with('error', 'Giro no encontrado');
        }
        return view('admin.giros.edit', compact('giro'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_giro' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:giros,nombre_giro,' . $id,
            ],
        ]);
        try {
            $giro = Giro::where('id', $id)
                ->where('activo', true)
                ->firstOrFail();
            $giro->nombre_giro = strtoupper(trim($request->nombre_giro));

            //validamos si hubo algun cambio o modificacion en el valor del campo nombre_estado, si no hubo cambios, no se actualiza
            if (! $giro->isDirty()) {
                // return back()->with('info', 'No se realizaron cambios');
                return redirect()->route('admin.giros.index')->with('info', 'No se realizaron cambios');
            }

            $giro->save();
            return redirect()->route('admin.giros.index')->with('success', 'Giro actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el giro: ' . $e->getMessage());
            return redirect()->route('admin.giros.index')->with('error', 'Error al actualizar el giro');
        }
    }
    public function confirm_delete($id)
    {
        //validando que existe el giro
        $giro = Giro::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$giro) {
            return redirect()->route('admin.giros.index')->with('error', 'Giro no encontrado');
        }
        return view('admin.giros.delete', compact('giro'));
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy($id)
    {
        $giro = Giro::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$giro) {
            return redirect()->route('admin.giros.confirm_delete', $id)->with('error', 'Giro no encontrado');
        }
        try {
            $giro->activo = false;
            $giro->save();
            return redirect()->route('admin.giros.index')->with('success', 'Giro eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el giro: ' . $e->getMessage());
            return redirect()->route('admin.giros.index')->with('error', 'Error al eliminar el giro');
        }
    }
}
</file>

<file path="app/Http/Controllers/ImageController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Image;
use App\Services\ImageService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class ImageController extends Controller
{
    protected $imageService;

    public function __construct(ImageService $imageService)
    {
        $this->imageService = $imageService;
    }

    /**
     * Subir imagen
     */
    public function upload(Request $request)
    {
        $validated = $request->validate([
            'image' => 'required|file|max:51200',
            'imageable_type' => 'required|string|in:App\Models\Design,App\Models\DesignVariant',
            'imageable_id' => 'required|integer',
            'alt_text' => 'nullable|string|max:255',
            'is_primary' => 'boolean'
        ]);

        $image = $this->imageService->uploadImage(
            $request->file('image'),
            $validated['imageable_type'],
            $validated['imageable_id'],
            [
                'alt_text' => $validated['alt_text'] ?? null,
                'is_primary' => $validated['is_primary'] ?? false,
            ]
        );

        return response()->json([
            'success' => true,
            'message' => 'Archivo subido exitosamente',
            'image' => [
                'id' => $image->id,
                'url' => Storage::url($image->file_path),
                'file_name' => $image->file_name,
            ]
        ]);
    }

    /**
     * Actualizar metadatos de imagen
     */
    public function update(Request $request, Image $image)
    {
        $validated = $request->validate([
            'alt_text' => 'nullable|string|max:255',
            'is_primary' => 'boolean',
            'order' => 'nullable|integer|min:0'
        ]);

        $image->update($validated);

        return response()->json([
            'success' => true,
            'message' => 'Imagen actualizada exitosamente',
        ]);
    }

    /**
     * Eliminar imagen
     */
    public function destroy(Image $image)
    {
        $this->imageService->deleteImage($image);

        return response()->json([
            'success' => true,
            'message' => 'Imagen eliminada exitosamente'
        ]);
    }

    /**
     * Reordenar imágenes
     */
    public function reorder(Request $request)
    {
        $validated = $request->validate([
            'images' => 'required|array',
            'images.*.id' => 'required|exists:images,id',
            'images.*.order' => 'required|integer|min:0'
        ]);

        $this->imageService->reorderImages($validated['images']);

        return response()->json([
            'success' => true,
            'message' => 'Orden actualizado exitosamente'
        ]);
    }
}
</file>

<file path="app/Http/Controllers/MaterialVariantController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\MaterialVariantRequest;
use App\Models\Material;
use App\Models\MaterialVariant;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class MaterialVariantController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | INDEX - Listar variantes de un material
    |--------------------------------------------------------------------------
    */

    public function index($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->findOrFail((int) $materialId);

            $variants = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->ordered()
                ->get();

            return view('admin.material-variants.index', compact('material', 'variants'));
        } catch (\Exception $e) {
            Log::error('Error al listar variantes de material: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Error al cargar las variantes');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->findOrFail((int) $materialId);

            $suggestedSku = $this->generateSku($material);

            return view('admin.material-variants.create', compact('material', 'suggestedSku'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de variante: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(MaterialVariantRequest $request, $materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $variant = new MaterialVariant();
            $variant->uuid = (string) Str::uuid();
            $variant->material_id = $material->id;
            $variant->color = $request->filled('color') ? mb_strtoupper(trim($request->color)) : null;
            $variant->sku = mb_strtoupper(trim($request->sku));
            $variant->current_stock = 0;
            $variant->min_stock_alert = (float) $request->min_stock_alert;
            $variant->current_value = 0;
            $variant->average_cost = 0;
            $variant->last_purchase_cost = 0;
            $variant->activo = true;
            $variant->save();

            DB::commit();

            Log::info('Variante de material creada', [
                'variant_id' => $variant->id,
                'material_id' => $material->id,
                'sku' => $variant->sku,
                'color' => $variant->color,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('material-variants.index', $material->id)
                ->with('success', 'Variante creada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al crear variante de material: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('material-variants.create', $materialId)
                ->withInput()
                ->with('error', 'Error al crear la variante');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->findOrFail((int) $materialId);

            $variant = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->findOrFail((int) $id);

            return view('admin.material-variants.edit', compact('material', 'variant'));
        } catch (\Exception $e) {
            Log::error('Error al cargar variante para editar: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'variant_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Variante no encontrada');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(MaterialVariantRequest $request, $materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $variant = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->findOrFail((int) $id);

            $oldSku = $variant->sku;

            $variant->color = $request->filled('color') ? mb_strtoupper(trim($request->color)) : null;
            $variant->sku = mb_strtoupper(trim($request->sku));
            $variant->min_stock_alert = (float) $request->min_stock_alert;

            if (!$variant->isDirty()) {
                return redirect()->route('material-variants.index', $material->id)
                    ->with('info', 'No se realizaron cambios');
            }

            $variant->save();

            DB::commit();

            Log::info('Variante de material actualizada', [
                'variant_id' => $variant->id,
                'material_id' => $material->id,
                'old_sku' => $oldSku,
                'new_sku' => $variant->sku,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('material-variants.index', $material->id)
                ->with('success', 'Variante actualizada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar variante: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'variant_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('material-variants.edit', [$materialId, $id])
                ->withInput()
                ->with('error', 'Error al actualizar la variante');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM DELETE
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'category.baseUnit'])
                ->findOrFail((int) $materialId);

            $variant = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->findOrFail((int) $id);

            return view('admin.material-variants.delete', compact('material', 'variant'));
        } catch (\Exception $e) {
            Log::error('Error al cargar variante para eliminar: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'variant_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('materials.index')
                ->with('error', 'Variante no encontrada');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DESTROY
    |--------------------------------------------------------------------------
    */

    public function destroy($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $variant = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->findOrFail((int) $id);

            // Validar que no tenga stock
            if ($variant->current_stock > 0) {
                return redirect()->route('material-variants.index', $material->id)
                    ->with('error', 'No se puede eliminar: la variante tiene stock disponible (' . number_format($variant->current_stock, 2) . ')');
            }

            $variantSku = $variant->sku;

            $variant->activo = false;
            $variant->save();

            DB::commit();

            Log::info('Variante de material eliminada', [
                'variant_id' => $variant->id,
                'material_id' => $material->id,
                'sku' => $variantSku,
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return redirect()->route('material-variants.index', $material->id)
                ->with('success', 'Variante eliminada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al eliminar variante: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'variant_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('material-variants.index', $materialId)
                ->with('error', 'Error al eliminar la variante');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX: Obtener variantes por material
    |--------------------------------------------------------------------------
    */

    public function getByMaterial($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1) {
                return response()->json(['error' => 'Material no válido'], 400);
            }

            $variants = MaterialVariant::where('material_id', (int) $materialId)
                ->where('activo', true)
                ->ordered()
                ->get(['id', 'color', 'sku', 'current_stock', 'average_cost']);

            return response()->json($variants);
        } catch (\Exception $e) {
            Log::error('Error AJAX getByMaterial: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener variantes'], 500);
        }
    }

    public function getByMaterial2($materialId)
    {
        try {
            $variants = MaterialVariant::where('material_id', (int) $materialId)
                ->where('activo', true)
                ->with([
                    'material.category.baseUnit',
                    'material.conversions' // Ahora sí funcionará porque agregaste la relación
                ])
                ->ordered()
                ->get();

            $results = $variants->map(function ($v) {
                // 1. Obtener la unidad base (ej: ID de "Metros")
                $baseUnitId = $v->material->category->base_unit_id;

                // 2. Buscar la conversión hacia esa unidad base
                $conversion = $v->material->conversions
                    ->where('to_unit_id', $baseUnitId)
                    ->first();

                // 3. El factor: si existe es el valor (ej: 50.00), si no, es 1
                $factor = $conversion ? (float) $conversion->conversion_factor : 1.0;

                // 4. Cálculos: Stock total en metros y Costo prorrateado por metro
                $stockReal = (float) $v->current_stock;
                $costoBase = (float) $v->average_cost;
                $simbolo = $v->material->category->baseUnit->symbol ?? 'unid';

                return [
                    'id' => $v->id,
                    // Texto: "SKU - Color (50.00 m)"
                    'text' => "{$v->sku} - {$v->color} (" . number_format($stockReal, 2) . " {$simbolo})",
                    'stock_real' => number_format($stockReal, 4, '.', ''),
                    'cost_base' => number_format($costoBase, 4, '.', ''),
                    'symbol' => $simbolo,
                    'full_name' => "{$v->sku} - {$v->color}"
                ];
            });

            return response()->json($results);
        } catch (\Exception $e) {
            Log::error('Error en getByMaterial: ' . $e->getMessage());
            return response()->json(['error' => 'Error al procesar conversiones'], 500);
        }
    }

    /*
    |--------------------------------------------------------------------------
    | PRIVATE: Generar SKU sugerido
    |--------------------------------------------------------------------------
    */

    private function generateSku(Material $material): string
    {
        $categoryPrefix = mb_strtoupper(mb_substr($material->category->slug ?? 'MAT', 0, 3));
        $materialPrefix = mb_strtoupper(mb_substr(Str::slug($material->name), 0, 4));

        $lastVariant = MaterialVariant::where('material_id', $material->id)
            ->orderBy('id', 'desc')
            ->first();

        $sequence = 1;
        if ($lastVariant) {
            preg_match('/(\d+)$/', $lastVariant->sku, $matches);
            if (!empty($matches[1])) {
                $sequence = (int) $matches[1] + 1;
            }
        }

        return strtoupper("{$categoryPrefix}-{$materialPrefix}-" . str_pad($sequence, 3, '0', STR_PAD_LEFT));
    }
}
</file>

<file path="app/Http/Controllers/PurchaseController.php">
<?php

namespace App\Http\Controllers;

use App\Enums\PurchaseStatus;
use App\Exceptions\PurchaseException;
use App\Http\Requests\ReceivePurchaseRequest;
use App\Http\Requests\StorePurchaseRequest;
use App\Http\Requests\UpdatePurchaseRequest;
use App\Models\Material;
use App\Models\MaterialCategory;
use App\Models\MaterialVariant;
use App\Models\Proveedor;
use App\Models\Purchase;
use App\Models\Unit;
use App\Services\PurchaseService;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\ValidationException;
use Illuminate\Support\Facades\Auth;
use App\Models\MaterialUnitConversion;
use App\Services\ReceptionService;
use App\Exceptions\InventoryException;
use App\Models\PurchaseReception;

class PurchaseController extends Controller
{
    protected PurchaseService $purchaseService;

    public function __construct(PurchaseService $purchaseService)
    {
        $this->purchaseService = $purchaseService;
    }

    /*
    |--------------------------------------------------------------------------
    | INDEX
    |--------------------------------------------------------------------------
    */

    public function index(Request $request)
    {
        try {
            $validated = $request->validate([
                'status' => ['nullable', 'string', 'in:' . implode(',', PurchaseStatus::values())],
                'proveedor_id' => ['nullable', 'integer', 'min:1', 'max:999999999'],
                'date_from' => ['nullable', 'date', 'date_format:Y-m-d'],
                'date_to' => ['nullable', 'date', 'date_format:Y-m-d', 'after_or_equal:date_from'],
                'search' => ['nullable', 'string', 'max:100', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s\-\_\#]+$/u'],
            ]);

            $query = Purchase::with(['proveedor', 'creator'])
                ->where('activo', true)
                ->orderBy('created_at', 'desc');

            // Filtro por estado
            if (!empty($validated['status'])) {
                $query->where('status', $validated['status']);
            }

            // Filtro por proveedor
            if (!empty($validated['proveedor_id'])) {
                $query->where('proveedor_id', (int) $validated['proveedor_id']);
            }

            // Filtro por rango de fechas
            if (!empty($validated['date_from'])) {
                $query->whereDate('ordered_at', '>=', $validated['date_from']);
            }
            if (!empty($validated['date_to'])) {
                $query->whereDate('ordered_at', '<=', $validated['date_to']);
            }

            // Búsqueda
            if (!empty($validated['search'])) {
                $search = $validated['search'];
                $query->where(function ($q) use ($search) {
                    $q->where('purchase_number', 'like', "%{$search}%")
                        ->orWhere('reference', 'like', "%{$search}%")
                        ->orWhereHas('proveedor', function ($pq) use ($search) {
                            $pq->where('nombre_proveedor', 'like', "%{$search}%");
                        });
                });
            }

            $purchases = $query->paginate(15)->withQueryString();

            $proveedores = Proveedor::where('activo', true)
                ->orderBy('nombre_proveedor')
                ->get(['id', 'nombre_proveedor']);

            $statuses = PurchaseStatus::options();

            return view('admin.purchases.index', compact('purchases', 'proveedores', 'statuses'));
        } catch (ValidationException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Parámetros de filtro no válidos');
        } catch (\Exception $e) {
            Log::error('Error al listar compras: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
                'trace' => $e->getTraceAsString(),
            ]);

            return view('admin.purchases.index', [
                'purchases' => collect(),
                'proveedores' => collect(),
                'statuses' => [],
            ])->with('error', 'Error al cargar las compras');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create()
    {
        try {
            $proveedores = Proveedor::where('activo', true)
                ->orderBy('nombre_proveedor')
                ->get(['id', 'nombre_proveedor']);

            if ($proveedores->isEmpty()) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Debe registrar al menos un proveedor antes de crear compras');
            }

            $categories = MaterialCategory::where('activo', true)
                ->with('baseUnit')
                ->ordered()
                ->get();

            // Preparar items desde old() para recuperar después de error de validación
            $oldItemsForJs = [];
            if (old('items')) {
                foreach (old('items') as $idx => $item) {
                    $variant = MaterialVariant::with(['material.category.baseUnit'])
                        ->find($item['material_variant_id']);

                    if ($variant) {
                        $unit = Unit::find($item['unit_id']);
                        $conversion = MaterialUnitConversion::where('material_id', $variant->material_id)
                            ->where('from_unit_id', $item['unit_id'])
                            ->first();

                        $conversionFactor = $conversion ? $conversion->conversion_factor : 1;
                        $quantity = (float) $item['quantity'];
                        $unitPrice = (float) $item['unit_price'];
                        $subtotal = $quantity * $unitPrice;
                        $convertedQuantity = $quantity * $conversionFactor;

                        $oldItemsForJs[] = [
                            'variant_id' => $variant->id,
                            'variant_sku' => $variant->sku,
                            'variant_color' => $variant->color ?? '',
                            'material_name' => $variant->material->name ?? '',
                            'category_name' => $variant->material->category->name ?? '',
                            'unit_id' => $item['unit_id'],
                            'unit_symbol' => $unit->symbol ?? '',
                            'quantity' => $quantity,
                            'unit_price' => $unitPrice,
                            'conversion_factor' => $conversionFactor,
                            'converted_quantity' => $convertedQuantity,
                            'base_unit_symbol' => $variant->material->category->baseUnit->symbol ?? '',
                            'subtotal' => $subtotal,
                        ];
                    }
                }
            }

            return view('admin.purchases.create', compact('proveedores', 'categories', 'oldItemsForJs'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de compra: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(StorePurchaseRequest $request)
    {
        try {
            $validated = $request->validated();

            $purchase = $this->purchaseService->create(
                data: [
                    'proveedor_id' => $validated['proveedor_id'],
                    'tax_rate' => $validated['tax_rate'] ?? 0,
                    'discount_amount' => $validated['discount_amount'] ?? 0,
                    'notes' => $validated['notes'] ?? null,
                    'reference' => $validated['reference'] ?? null,
                    'ordered_at' => $validated['ordered_at'] ?? null,
                    'expected_at' => $validated['expected_at'] ?? null,
                ],
                items: $validated['items']
            );

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Compra {$purchase->purchase_number} creada exitosamente");
        } catch (PurchaseException $e) {
            Log::warning('Error de negocio al crear compra: ' . $e->getMessage(), [
                'context' => $e->getContext(),
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.create')
                ->withInput()
                ->with('error', $e->getMessage());
        } catch (\Exception $e) {
            Log::error('Error al crear compra: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.purchases.create')
                ->withInput()
                ->with('error', 'Error al crear la compra. Intente nuevamente.');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | SHOW
    |--------------------------------------------------------------------------
    */

    public function show($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with([
                'proveedor',
                'items.materialVariant.material.category.baseUnit',
                'items.unit',
                'creator',
                'receiver',
            ])->where('activo', true)->findOrFail((int) $id);

            // Cargar historial de recepciones
            $receptionService = app(ReceptionService::class);
            $receptions = $receptionService->getReceptionHistory($purchase);

            return view('admin.purchases.show', compact('purchase', 'receptions'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al mostrar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with([
                'proveedor',
                'items.materialVariant.material.category.baseUnit',
                'items.unit',
            ])->where('activo', true)->findOrFail((int) $id);

            if (!$purchase->can_edit) {
                return redirect()->route('admin.purchases.show', $purchase->id)
                    ->with('error', "No se puede editar la compra en estado: {$purchase->status->label()}");
            }

            // --- NUEVA LÓGICA PARA EVITAR ParseError EN BLADE ---
            $itemsForJs = $purchase->items->map(function ($item) {
                return [
                    'variant_id'         => $item->material_variant_id,
                    'variant_sku'        => $item->materialVariant->sku ?? '',
                    'variant_color'      => $item->materialVariant->color ?? '',
                    'material_name'      => $item->materialVariant->material->name ?? '',
                    'category_name'      => $item->materialVariant->material->category->name ?? '',
                    'unit_id'            => $item->unit_id,
                    'unit_symbol'        => $item->unit->symbol ?? '',
                    'quantity'           => (float) $item->quantity,
                    'unit_price'         => (float) $item->unit_price,
                    'conversion_factor'  => (float) $item->conversion_factor,
                    'converted_quantity' => (float) $item->converted_quantity,
                    'base_unit_symbol'   => $item->materialVariant->material->category->baseUnit->symbol ?? '',
                    'subtotal'           => (float) $item->subtotal,
                ];
            })->values();
            // ----------------------------------------------------

            $proveedores = Proveedor::where('activo', true)
                ->orderBy('nombre_proveedor')
                ->get(['id', 'nombre_proveedor']);

            $categories = MaterialCategory::where('activo', true)
                ->with('baseUnit')
                ->ordered()
                ->get();

            // Agregamos 'itemsForJs' al compact
            return view('admin.purchases.edit', compact('purchase', 'proveedores', 'categories', 'itemsForJs'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cargar compra para editar: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id'     => Auth::id(),
                'trace'       => $e->getTraceAsString(), // Agregué el trace para mejor depuración
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la compra');
        }
    }
    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(UpdatePurchaseRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);
            $validated = $request->validated();

            $purchase = $this->purchaseService->update(
                purchase: $purchase,
                data: [
                    'proveedor_id' => $validated['proveedor_id'],
                    'tax_rate' => $validated['tax_rate'] ?? $purchase->tax_rate,
                    'discount_amount' => $validated['discount_amount'] ?? $purchase->discount_amount,
                    'notes' => $validated['notes'] ?? null,
                    'reference' => $validated['reference'] ?? null,
                    'ordered_at' => $validated['ordered_at'] ?? null,
                    'expected_at' => $validated['expected_at'] ?? null,
                ],
                items: $validated['items']
            );

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Compra {$purchase->purchase_number} actualizada exitosamente");
        } catch (PurchaseException $e) {
            Log::warning('Error de negocio al actualizar compra: ' . $e->getMessage(), [
                'context' => $e->getContext(),
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.edit', $id)
                ->withInput()
                ->with('error', $e->getMessage());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al actualizar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.purchases.edit', $id)
                ->withInput()
                ->with('error', 'Error al actualizar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM (Borrador → Pendiente)
    |--------------------------------------------------------------------------
    */

    public function confirm($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);

            $purchase = $this->purchaseService->confirm($purchase);

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Compra {$purchase->purchase_number} confirmada exitosamente");
        } catch (PurchaseException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al confirmar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al confirmar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | RECEIVE
    |--------------------------------------------------------------------------
    */

    public function showReceive($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with([
                'proveedor',
                'items.materialVariant.material.category.baseUnit',
                'items.unit',
            ])->where('activo', true)->findOrFail((int) $id);

            if (!$purchase->can_receive) {
                return redirect()->route('admin.purchases.show', $purchase->id)
                    ->with('error', "No se puede recibir la compra en estado: {$purchase->status->label()}");
            }

            return view('admin.purchases.receive', compact('purchase'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cargar recepción de compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la recepción');
        }
    }

    public function receive(ReceivePurchaseRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);
            $validated = $request->validated();

            // Usar ReceptionService para crear registro de recepción con historial
            $receptionService = app(ReceptionService::class);

            // Preparar items para recepción
            $itemsData = [];

            if ($validated['receive_type'] === 'complete') {
                // Recepción completa: agregar todas las cantidades pendientes
                foreach ($purchase->items as $item) {
                    if ($item->pending_quantity > 0) {
                        $itemsData[] = [
                            'item_id' => $item->id,
                            'quantity' => $item->pending_quantity,
                        ];
                    }
                }
                $message = "Compra {$purchase->purchase_number} recibida completamente";
            } else {
                // Recepción parcial: usar las cantidades del formulario
                foreach ($validated['items'] as $itemData) {
                    if (!empty($itemData['quantity']) && $itemData['quantity'] > 0) {
                        $itemsData[] = [
                            'item_id' => $itemData['item_id'],
                            'quantity' => $itemData['quantity'],
                        ];
                    }
                }
                $message = "Recepción parcial registrada para {$purchase->purchase_number}";
            }

            // Crear la recepción si hay items
            if (!empty($itemsData)) {
                $reception = $receptionService->createReception(
                    purchase: $purchase,
                    itemsData: $itemsData,
                    deliveryNote: $validated['delivery_note'] ?? null,
                    notes: $validated['notes'] ?? null
                );
                $message = "Recepción {$reception->reception_number} registrada exitosamente";
            } else {
                return redirect()->route('admin.purchases.receive', $id)
                    ->with('error', 'Debe especificar al menos una cantidad a recibir');
            }

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', $message);
        } catch (PurchaseException $e) {
            Log::warning('Error de negocio al recibir compra: ' . $e->getMessage(), [
                'context' => $e->getContext(),
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.receive', $id)
                ->with('error', $e->getMessage());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al recibir compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.purchases.receive', $id)
                ->with('error', 'Error al procesar la recepción');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CANCEL
    |--------------------------------------------------------------------------
    */

    public function showCancel($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with(['proveedor'])
                ->where('activo', true)
                ->findOrFail((int) $id);

            if (!$purchase->can_cancel) {
                return redirect()->route('admin.purchases.show', $purchase->id)
                    ->with('error', "No se puede cancelar la compra en estado: {$purchase->status->label()}");
            }

            return view('admin.purchases.cancel', compact('purchase'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cargar cancelación de compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la cancelación');
        }
    }

    public function cancel(Request $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $validated = $request->validate([
                'cancellation_reason' => [
                    'required',
                    'string',
                    'min:10',
                    'max:500',
                    'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s\.\,\-\_]+$/u',
                ],
            ], [
                'cancellation_reason.required' => 'El motivo de cancelación es obligatorio.',
                'cancellation_reason.min' => 'El motivo debe tener al menos 10 caracteres.',
                'cancellation_reason.max' => 'El motivo no puede exceder 500 caracteres.',
                'cancellation_reason.regex' => 'El motivo contiene caracteres no permitidos.',
            ]);

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);

            $purchase = $this->purchaseService->cancel(
                purchase: $purchase,
                reason: strip_tags(trim($validated['cancellation_reason']))
            );

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Compra {$purchase->purchase_number} cancelada");
        } catch (PurchaseException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (ValidationException $e) {
            return redirect()->route('admin.purchases.cancel', $id)
                ->withInput()
                ->withErrors($e->errors());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cancelar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al cancelar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DELETE (Solo borradores)
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with(['proveedor', 'items'])
                ->where('activo', true)
                ->findOrFail((int) $id);

            if ($purchase->status !== PurchaseStatus::DRAFT) {
                return redirect()->route('admin.purchases.show', $purchase->id)
                    ->with('error', 'Solo se pueden eliminar compras en borrador');
            }

            return view('admin.purchases.delete', compact('purchase'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cargar eliminación de compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la eliminación');
        }
    }

    public function destroy($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);
            $purchaseNumber = $purchase->purchase_number;

            $this->purchaseService->delete($purchase);

            return redirect()->route('admin.purchases.index')
                ->with('success', "Compra {$purchaseNumber} eliminada exitosamente");
        } catch (PurchaseException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al eliminar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al eliminar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX ENDPOINTS
    |--------------------------------------------------------------------------
    */

    /**
     * Obtener materiales por categoría
     */
    public function getMaterialsByCategory(Request $request, $categoryId)
    {
        try {
            if (!is_numeric($categoryId) || $categoryId < 1) {
                return response()->json(['error' => 'Categoría no válida'], 400);
            }

            $materials = Material::where('activo', true)
                ->where('material_category_id', (int) $categoryId)
                ->with(['activeVariants:id,material_id,sku,color,current_stock'])
                ->ordered()
                ->get(['id', 'name', 'composition']);

            return response()->json($materials);
        } catch (\Exception $e) {
            Log::error('Error AJAX getMaterialsByCategory: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener materiales'], 500);
        }
    }

    /**
     * Obtener variantes por material
     */
    public function getVariantsByMaterial(Request $request, $materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1) {
                return response()->json(['error' => 'Material no válido'], 400);
            }

            $variants = MaterialVariant::where('activo', true)
                ->where('material_id', (int) $materialId)
                ->ordered()
                ->get(['id', 'sku', 'color', 'current_stock', 'average_cost']);

            return response()->json($variants);
        } catch (\Exception $e) {
            Log::error('Error AJAX getVariantsByMaterial: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener variantes'], 500);
        }
    }

    /**
     * Obtener unidades de compra para un material
     */
    public function getUnitsForMaterial(Request $request, $materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1) {
                return response()->json(['error' => 'Material no válido'], 400);
            }

            $material = Material::with(['category.baseUnit'])->findOrFail((int) $materialId);
            $baseUnitId = $material->category->base_unit_id;

            // Unidad base siempre disponible
            $units = collect();
            if ($material->category->baseUnit) {
                $units->push([
                    'id' => $material->category->baseUnit->id,
                    'name' => $material->category->baseUnit->name,
                    'symbol' => $material->category->baseUnit->symbol,
                    'conversion_factor' => 1,
                    'is_base' => true,
                ]);
            }

            // Unidades de compra con conversión configurada
            $conversions = MaterialUnitConversion::where('material_id', $material->id)
                ->with('fromUnit')
                ->get();

            foreach ($conversions as $conversion) {
                $units->push([
                    'id' => $conversion->from_unit_id,
                    'name' => $conversion->fromUnit->name,
                    'symbol' => $conversion->fromUnit->symbol,
                    'conversion_factor' => $conversion->conversion_factor,
                    'is_base' => false,
                ]);
            }

            return response()->json([
                'material_id' => $material->id,
                'material_name' => $material->name,
                'base_unit_id' => $baseUnitId,
                'base_unit_symbol' => $material->category->baseUnit->symbol ?? '',
                'units' => $units,
            ]);
        } catch (ModelNotFoundException $e) {
            return response()->json(['error' => 'Material no encontrado'], 404);
        } catch (\Exception $e) {
            Log::error('Error AJAX getUnitsForMaterial: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener unidades'], 500);
        }
    }

    /**
     * Anular una recepción
     */
    public function voidReception(Request $request, $id, $receptionId)
    {
        try {
            $validated = $request->validate([
                'void_reason' => [
                    'required',
                    'string',
                    'min:10',
                    'max:500',
                ],
            ], [
                'void_reason.required' => 'El motivo de anulación es obligatorio.',
                'void_reason.min' => 'El motivo debe tener al menos 10 caracteres.',
            ]);

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);
            $reception = PurchaseReception::where('purchase_id', $purchase->id)
                ->findOrFail((int) $receptionId);

            $receptionService = app(ReceptionService::class);
            $receptionService->voidReception($reception, strip_tags(trim($validated['void_reason'])));

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Recepción {$reception->reception_number} anulada exitosamente");
        } catch (InventoryException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (PurchaseException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (\Exception $e) {
            Log::error('Error al anular recepción: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'reception_id' => $receptionId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al anular la recepción');
        }
    }

    /**
     * Recalcular estado de una compra (útil para corregir inconsistencias)
     */
    public function recalculateStatus($id)
    {
        try {
            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);

            $receptionService = app(ReceptionService::class);
            $receptionService->recalculatePurchaseStatus($purchase);

            return redirect()->route('admin.purchases.show', $id)
                ->with('success', "Estado de {$purchase->purchase_number} recalculado: {$purchase->fresh()->status->label()}");
        } catch (\Exception $e) {
            Log::error('Error al recalcular estado: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al recalcular el estado');
        }
    }
}
</file>

<file path="app/Http/Controllers/SystemSettingController.php">
<?php

namespace App\Http\Controllers;

use App\Models\SystemSetting;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class SystemSettingController extends Controller
{
    private const ALLOWED_GROUPS = ['general', 'inventario', 'facturacion', 'produccion'];

    public function index(Request $request)
    {
        try {
            $request->validate([
                'group' => ['sometimes', 'string', 'max:50', 'regex:/^[a-z]+$/'],
            ]);

            $groups = SystemSetting::getGroups();
            $activeGroup = $request->get('group', 'general');

            if (!in_array($activeGroup, self::ALLOWED_GROUPS, true)) {
                $activeGroup = 'general';
            }

            $settings = SystemSetting::getByGroup($activeGroup);

            return view('admin.settings.index', compact('groups', 'activeGroup', 'settings'));
        } catch (\Exception $e) {
            Log::error('Error al cargar configuraciones: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);
            return view('admin.settings.index', [
                'groups' => [],
                'activeGroup' => 'general',
                'settings' => collect()
            ])->with('error', 'Error al cargar las configuraciones');
        }
    }

    public function update(Request $request)
    {
        $request->validate([
            'group' => [
                'required',
                'string',
                'max:50',
                'regex:/^[a-z]+$/',
                function ($attribute, $value, $fail) {
                    if (!in_array($value, self::ALLOWED_GROUPS, true)) {
                        $fail('Grupo de configuración no válido.');
                    }
                },
            ],
            'settings' => ['required', 'array', 'max:50'],
            'settings.*' => ['nullable'], // Quitamos la restricción de string para permitir archivos
        ]);

        $group = $request->input('group');

        try {
            DB::beginTransaction();

            $updated = 0;
            $settingsInput = $request->input('settings', []);

            // Obtener solo las keys válidas del grupo actual
            $validKeys = SystemSetting::where('group', $group)
                ->pluck('key')
                ->toArray();

            foreach ($settingsInput as $key => $value) {
                // 1. Validar que la key pertenezca al grupo
                if (!in_array($key, $validKeys, true)) {
                    continue;
                }

                $setting = SystemSetting::where('key', $key)
                    ->where('group', $group)
                    ->first();

                if (!$setting) {
                    continue;
                }

                // MANEJO DE ARCHIVOS (IMÁGENES)
                if ($setting->type === 'image') {
                    if ($request->hasFile("settings.$key")) {
                        $file = $request->file("settings.$key");

                        // Validación manual del archivo
                        if (!$file->isValid()) {
                            continue; // O lanzar error
                        }

                        $allowedMimes = ['image/jpeg', 'image/png', 'image/webp'];
                        if (!in_array($file->getMimeType(), $allowedMimes)) {
                            DB::rollBack();
                            return redirect()->back()->with('error', 'Formato de imagen no válido para ' . $setting->label);
                        }

                        // Eliminar imagen anterior si existe
                        if ($setting->value && Storage::disk('public')->exists($setting->value)) {
                            Storage::disk('public')->delete($setting->value);
                        }

                        // Guardar nueva imagen
                        $path = $file->store('settings', 'public');
                        $sanitizedValue = $path;
                    } else {
                        // Si no se subió archivo pero viene "null" o vacío, ¿borramos?
                        // Por UX del Dropzone, si el usuario da "eliminar", podríamos enviar un input hidden vacío.
                        // Asumiremos que si viene vacío string, es borrar. Si no viene nada, es mantener.
                        // Pero el request->input incluye todo. 

                        // Si el valor es una cadena vacía y antes había algo, significa borrar?
                        // Vamos a manejar que si viene texto "DELETE_IMAGE", borramos.
                        if ($value === '__DELETE__') {
                            if ($setting->value && Storage::disk('public')->exists($setting->value)) {
                                Storage::disk('public')->delete($setting->value);
                            }
                            $sanitizedValue = null;
                        } else {
                            // Si no es archivo ni flag de borrado, mantenemos el valor actual (no actualizar)
                            continue;
                        }
                    }
                } else {
                    // 2. Sanitizar y validar según tipo (NO IMAGEN)
                    $sanitizedValue = $this->sanitizeValue($value, $setting);
                }

                // CORRECCIÓN: Si el valor es inválido, informamos la causa exacta
                if ($sanitizedValue === false) {
                    DB::rollBack();
                    return redirect()->back()
                        ->withInput()
                        ->with('error', 'El formato para ' . $setting->label . ' es inválido o contiene caracteres no permitidos.');
                }

                if ($setting->value !== $sanitizedValue) {
                    $setting->value = $sanitizedValue;
                    $setting->updated_by = Auth::id();
                    $setting->save();

                    Cache::forget("setting_{$key}");
                    $updated++;

                    Log::info('Configuración actualizada', [
                        'key' => $key,
                        'old_value' => $setting->getOriginal('value'),
                        'new_value' => $sanitizedValue,
                        'user_id' => Auth::id(),
                    ]);
                }
            }

            DB::commit();

            if ($updated === 0) {
                return redirect()
                    ->route('settings.index', ['group' => $group])
                    ->with('info', 'No se detectaron cambios en la configuración.');
            }

            return redirect()
                ->route('settings.index', ['group' => $group])
                ->with('success', 'Se actualizaron ' . $updated . ' configuraciones correctamente.');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar configuraciones: ' . $e->getMessage());

            return redirect()
                ->back()
                ->with('error', 'Ocurrió un error inesperado al procesar la solicitud.');
        }
    }

    /**
     * Sanitiza y valida el valor según el tipo de configuración
     */
    private function sanitizeValue(?string $value, SystemSetting $setting): string|false
    {
        if ($value === null) {
            $value = '';
        }

        $value = strip_tags($value);
        $value = trim($value);

        switch ($setting->type) {
            case 'boolean':
                return in_array($value, ['1', '0', 'true', 'false', ''], true)
                    ? ($value === '1' || $value === 'true' ? '1' : '0')
                    : false;

            case 'integer':
                if ($value === '') return '0';
                if (!preg_match('/^[0-9]{1,10}$/', $value)) {
                    return false;
                }
                return (string) (int) $value;

            case 'select':
                $options = $setting->options ?? [];
                return array_key_exists($value, $options) ? $value : false;

            case 'string':
            default:
                if ($value === '') return '';

                // Regex actualizado: Acepta eñes, acentos, y caracteres como * . [ ] ( ) # @ $ % &
                // El flag /u es indispensable para soporte UTF-8
                $pattern = '/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s\-_.,\/()\[\]*#@$%&!]{1,255}$/u';

                if (!preg_match($pattern, $value)) {
                    return false;
                }
                if (!preg_match($pattern, $value)) {
                    return false;
                }
                return $value;

            case 'image':
                // Para tipos imagen, sanitizeValue no se usa para el upload, 
                // pero por seguridad retornamos null si llega aquí por error.
                return $value;
        }
    }
}
</file>

<file path="app/Models/Attribute.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes; // 1. Importar para borrado lógico
use Illuminate\Support\Str;

class Attribute extends Model
{
    use SoftDeletes; // 2. Usar el trait para borrado lógico

    protected $fillable = [
        'name',
        'slug',
        'type',
        'is_required',
        'order'
    ];

    protected $casts = [
        'is_required' => 'boolean',
        'order' => 'integer',
        'deleted_at' => 'datetime' // 3. Cast de fecha para Laravel 10/11/12
    ];
    /**
     * Boot del modelo para asegurar que el slug sea siempre correcto
     */
    protected static function boot()
    {
        parent::boot();
        static::creating(function ($attribute) {
            if (empty($attribute->slug)) {
                $attribute->slug = Str::slug($attribute->name);
            }
        });
    }

    /**
     * Relación: Un atributo tiene muchos valores 
     */
    public function values()
    {
        // Añadimos el orden por defecto para que los colores/tallas salgan siempre organizados
        return $this->hasMany(AttributeValue::class)->orderBy('order', 'asc');
    }
}
</file>

<file path="app/Models/Design.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

class Design extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'name',
        'slug',
        'description',
        'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean'
    ];

    // Relación: Un diseño tiene muchas variantes
    public function variants()
    {
        return $this->hasMany(DesignVariant::class);
    }

    // Relación: Un diseño pertenece a muchas categorías
    public function categories()
    {
        return $this->belongsToMany(Category::class);
    }

    // Relación polimórfica: Un diseño tiene muchas imágenes
    public function images()
    {
        return $this->morphMany(Image::class, 'imageable');
    }

    // Imagen principal
    public function primaryImage()
    {
        return $this->morphOne(Image::class, 'imageable')->where('is_primary', true);
    }

    /**
     * Relación con las exportaciones del diseño.
     */
    public function exports()
    {
        return $this->hasMany(DesignExport::class);
    }

    /**
     * Relación con las exportaciones sin variante (generales).
     * Esta relación es CRÍTICA para la funcionalidad de producción.
     * Filtra solo las exportaciones que no están asociadas a una variante específica.
     */
    public function generalExports()
    {
        return $this->hasMany(DesignExport::class)->whereNull('design_variant_id');
    }

    // NUEVA RELACIÓN: Usuario que creó el diseño (para auditoría)
    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    // NUEVO MÉTODO: Contador de exportaciones (para optimización en vistas)
    public function getExportsCountAttribute()
    {
        // Si ya existe el campo exports_count en la tabla (optimización), usarlo
        if (isset($this->attributes['exports_count'])) {
            return $this->attributes['exports_count'];
        }
        // Si no, contar sobre la relación
        return $this->exports()->count();
    }

    // NUEVO MÉTODO: Verifica si el diseño tiene exportaciones
    public function hasExports()
    {
        return $this->exports()->exists();
    }

    // NUEVO MÉTODO: Verifica si el diseño tiene exportaciones aprobadas
    public function hasApprovedExports()
    {
        return $this->exports()->where('status', 'aprobado')->exists();
    }
}
</file>

<file path="app/Models/DesignExport.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class DesignExport extends Model
{
    use HasFactory;

    /**
     * Los atributos que son asignables en masa.
     *
     * @var array<int, string>
     */
    protected $fillable = [
        'design_id',
        'design_variant_id',
        'image_id',
        'application_type',
        'application_label',
        'placement_description',
        'file_name',
        'file_path',
        'file_format',
        'file_size',
        'mime_type',
        'stitches_count',
        'width_mm',
        'height_mm',
        'colors_count',
        'colors_detected',
        'status',
        'notes',
        'created_by',
        'approved_by',
        'approved_at',
        'auto_read_success',
    ];

    /**
     * Los atributos que deben ser convertidos a tipos nativos.
     *
     * @var array<string, string>
     */
    protected $casts = [
        'approved_at' => 'datetime',
        'stitches_count' => 'integer',
        'width_mm' => 'integer',
        'height_mm' => 'integer',
        'colors_count' => 'integer',
        'file_size' => 'integer',
        'auto_read_success' => 'boolean',
        'colors_detected' => 'array',
    ];

    /**
     * Los atributos que deben ser transformados a fechas.
     *
     * @var array<int, string>
     */
    protected $dates = [
        'approved_at',
        'created_at',
        'updated_at',
    ];

    /**
     * Relación con el diseño.
     */
    public function design()
    {
        return $this->belongsTo(Design::class);
    }

    /**
     * Relación con la variante (opcional).
     */
    public function variant()
    {
        return $this->belongsTo(DesignVariant::class, 'design_variant_id');
    }

    /**
     * Relación con la imagen específica (opcional).
     * Permite vincular una producción a una imagen específica de la galería.
     */
    public function image()
    {
        return $this->belongsTo(Image::class);
    }

    /**
     * Relación con el creador.
     */
    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    /**
     * Relación con el aprobador (opcional).
     */
    public function approver()
    {
        return $this->belongsTo(User::class, 'approved_by');
    }

    /**
     * Accesor para las dimensiones formateadas.
     * IMPORTANTE: Este accesor ya existe, pero se verifica que funcione correctamente.
     * Formato esperado por el frontend: "100x150 mm"
     */
    public function getFormattedDimensionsAttribute()
    {
        if ($this->width_mm && $this->height_mm) {
            return "{$this->width_mm}×{$this->height_mm} mm";
        }
        return 'N/A';
    }

    /**
     * Accesor para el tamaño del archivo formateado.
     */
    public function getFormattedFileSizeAttribute()
    {
        if (!$this->file_size) return 'N/A';

        $units = ['B', 'KB', 'MB', 'GB'];
        $bytes = $this->file_size;
        $i = 0;

        while ($bytes >= 1024 && $i < count($units) - 1) {
            $bytes /= 1024;
            $i++;
        }

        return round($bytes, 2) . ' ' . $units[$i];
    }

    /**
     * Accesor para el estado traducido.
     */
    public function getTranslatedStatusAttribute()
    {
        $statuses = [
            'borrador' => 'Borrador',
            'pendiente' => 'Pendiente',
            'aprobado' => 'Aprobado',
            'archivado' => 'Archivado',
        ];

        return $statuses[$this->status] ?? $this->status;
    }

    /**
     * Accesor para la clase CSS del estado.
     */
    public function getStatusClassAttribute()
    {
        $classes = [
            'borrador' => 'secondary',
            'pendiente' => 'warning',
            'aprobado' => 'success',
            'archivado' => 'dark',
        ];

        return $classes[$this->status] ?? 'secondary';
    }

    /**
     * NUEVO ACCESOR: Obtiene las dimensiones en formato compatible con el frontend.
     * Este accesor asegura que el formato sea exactamente el que espera el JavaScript.
     * Formato: "100x150 mm" (sin el símbolo × especial, usando 'x' normal)
     */
    public function getDimensionsForFrontendAttribute()
    {
        if ($this->width_mm && $this->height_mm) {
            return $this->width_mm . 'x' . $this->height_mm . ' mm';
        }
        return 'N/A';
    }
    public function productVariants()
    {
        return $this->belongsToMany(ProductVariant::class, 'product_variant_design');
    }
}
</file>

<file path="app/Models/Image.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Image extends Model
{
    protected $fillable = [
        'imageable_type',
        'imageable_id',
        'file_name',
        'file_path',
        'thumbnail_small',
        'thumbnail_medium',
        'is_optimized',
        'original_size',
        'file_size',
        'mime_type',
        'width',
        'height',
        'alt_text',
        'order',
        'is_primary'
    ];

    protected $casts = [
        'file_size' => 'integer',
        'original_size' => 'integer',
        'width' => 'integer',
        'height' => 'integer',
        'order' => 'integer',
        'is_primary' => 'boolean',
        'is_optimized' => 'boolean'
    ];

    // Relación polimórfica inversa
    public function imageable()
    {
        return $this->morphTo();
    }

    /**
     * Relación con las producciones/exportaciones vinculadas a esta imagen.
     */
    public function exports()
    {
        return $this->hasMany(DesignExport::class);
    }

    /**
     * Contador de producciones para esta imagen.
     */
    public function getExportsCountAttribute()
    {
        return $this->exports()->count();
    }

    /**
     * Obtiene la URL del thumbnail pequeño (para listados).
     * Si no existe, devuelve la imagen original.
     */
    public function getThumbnailSmallUrlAttribute(): ?string
    {
        if ($this->thumbnail_small) {
            return asset('storage/' . $this->thumbnail_small);
        }
        return $this->file_path ? asset('storage/' . $this->file_path) : null;
    }

    /**
     * Obtiene la URL del thumbnail mediano (para galerías).
     * Si no existe, devuelve la imagen original.
     */
    public function getThumbnailMediumUrlAttribute(): ?string
    {
        if ($this->thumbnail_medium) {
            return asset('storage/' . $this->thumbnail_medium);
        }
        return $this->file_path ? asset('storage/' . $this->file_path) : null;
    }

    /**
     * Obtiene la URL de la imagen original (para descargas).
     */
    public function getOriginalUrlAttribute(): ?string
    {
        return $this->file_path ? asset('storage/' . $this->file_path) : null;
    }

    /**
     * Obtiene la mejor imagen disponible para visualización.
     * Prioridad: thumbnail_medium > thumbnail_small > original
     */
    public function getDisplayUrlAttribute(): ?string
    {
        if ($this->thumbnail_medium) {
            return asset('storage/' . $this->thumbnail_medium);
        }
        if ($this->thumbnail_small) {
            return asset('storage/' . $this->thumbnail_small);
        }
        return $this->file_path ? asset('storage/' . $this->file_path) : null;
    }
}
</file>

<file path="app/Models/Material.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use App\Traits\HasActivityLog;
use App\Models\MaterialCategory;
use App\Models\MaterialVariant;
use App\Models\MaterialUnitConversion;
use App\Models\Unit;

class Material extends Model
{
    use HasActivityLog;

    protected $table = 'materials';

    protected $activityLogNameField = 'name';

    protected $fillable = [
        'uuid',
        'material_category_id',
        'name',
        'slug',
        'composition',
        'description',
        'activo',
    ];

    protected $casts = [
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->slug) && !empty($model->name)) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::updating(function (self $model): void {
            if ($model->isDirty('name')) {
                $model->slug = Str::slug($model->name);
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function category()
    {
        return $this->belongsTo(MaterialCategory::class, 'material_category_id');
    }

    public function variants()
    {
        return $this->hasMany(MaterialVariant::class, 'material_id');
    }

    public function activeVariants()
    {
        return $this->hasMany(MaterialVariant::class, 'material_id')->where('activo', true);
    }

    public function unitConversions()
    {
        return $this->hasMany(MaterialUnitConversion::class, 'material_id');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name');
    }

    public function scopeByCategory(Builder $query, int $categoryId): Builder
    {
        return $query->where('material_category_id', $categoryId);
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFullNameAttribute(): string
    {
        $name = $this->name;
        if ($this->composition) {
            $name .= " ({$this->composition})";
        }
        return $name;
    }

    public function getTotalStockAttribute(): float
    {
        return $this->activeVariants()->sum('current_stock');
    }

    public function getTotalValueAttribute(): float
    {
        return $this->activeVariants()->sum('current_value');
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canDelete(): array
    {
        if ($this->variants()->where('activo', true)->exists()) {
            return [
                'can_delete' => false,
                'message' => 'No se puede eliminar: tiene variantes activas asociadas.',
            ];
        }

        return ['can_delete' => true, 'message' => ''];
    }

    public function hasColor(): bool
    {
        return $this->category?->has_color ?? false;
    }

    public function getBaseUnit(): ?Unit
    {
        return $this->category?->baseUnit;
    }

    public function conversions()
    {
        return $this->hasMany(MaterialUnitConversion::class, 'material_id');
    }
}
</file>

<file path="app/Models/ProductCategory.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;

class ProductCategory extends Model
{
    use SoftDeletes;

    protected $table = 'product_categories';

    protected $fillable = [
        'uuid',
        'name',
        'slug',
        'description',
        'is_active',
    ];

    protected $casts = [
        'is_active' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->slug)) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::updating(function (self $model): void {
            if ($model->isDirty('name')) {
                $model->slug = Str::slug($model->name);
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function products()
    {
        return $this->hasMany(Product::class, 'product_category_id');
    }

    public function activeProducts()
    {
        return $this->hasMany(Product::class, 'product_category_id')
            ->where('status', 'active');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('is_active', true);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name', 'asc');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getProductsCountAttribute(): int
    {
        return $this->products()->count();
    }

    public function getActiveProductsCountAttribute(): int
    {
        return $this->activeProducts()->count();
    }

    public function getStatusLabelAttribute(): string
    {
        return $this->is_active ? 'Activa' : 'Inactiva';
    }

    public function getStatusColorAttribute(): string
    {
        return $this->is_active ? 'success' : 'danger';
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canDelete(): bool
    {
        return $this->products()->count() === 0;
    }

    public function getSkuPrefix(): string
    {
        return Str::upper(Str::substr(Str::slug($this->name, ''), 0, 3));
    }
}
</file>

<file path="app/Models/ProductExtra.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;

class ProductExtra extends Model
{
    use SoftDeletes;

    protected $table = 'product_extras';

    protected $fillable = [
        'uuid',
        'name',
        'cost_addition',
        'price_addition',
        'minutes_addition',
    ];

    protected $casts = [
        'cost_addition' => 'decimal:4',
        'price_addition' => 'decimal:4',
        'minutes_addition' => 'integer',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function products()
    {
        return $this->belongsToMany(
            Product::class,
            'product_extra_assignment',
            'product_extra_id',
            'product_id'
        )->withTimestamps();
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name', 'asc');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFormattedCostAttribute(): string
    {
        return '$' . number_format($this->cost_addition, 2);
    }

    public function getFormattedPriceAttribute(): string
    {
        return '+$' . number_format($this->price_addition, 2);
    }

    public function getFormattedMinutesAttribute(): string
    {
        if ($this->minutes_addition <= 0) {
            return '-';
        }

        $hours = floor($this->minutes_addition / 60);
        $minutes = $this->minutes_addition % 60;

        if ($hours > 0) {
            return "{$hours}h {$minutes}m";
        }

        return "{$minutes}m";
    }

    public function getProductsCountAttribute(): int
    {
        return $this->products()->count();
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canDelete(): bool
    {
        return $this->products()->count() === 0;
    }
}
</file>

<file path="app/Models/ProductVariant.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;

class ProductVariant extends Model
{
    protected $table = 'product_variants';

    protected $fillable = [
        'uuid',
        'product_id',
        'sku_variant',
        'price',
        'attribute_combinations',
        'stock_alert',
    ];

    protected $casts = [
        'price' => 'decimal:4',
        'attribute_combinations' => 'array',
        'stock_alert' => 'integer',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function product()
    {
        return $this->belongsTo(Product::class, 'product_id');
    }

    public function attributes()
    {
        return $this->belongsToMany(
            AttributeValue::class,
            'product_variant_attribute',
            'product_variant_id',
            'attribute_value_id'
        )->withPivot('attribute_id');
    }

    public function designExports()
    {
        return $this->belongsToMany(
            DesignExport::class,
            'product_variant_design',
            'product_variant_id',
            'design_export_id'
        )->withPivot('application_type_id', 'notes')
            ->withTimestamps();
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('sku_variant', 'asc');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFormattedPriceAttribute(): string
    {
        return '$' . number_format($this->price, 2);
    }

    public function getTotalWithExtrasAttribute(): float
    {
        $extrasTotal = $this->product->extras->sum('price_addition');
        return (float) $this->price + $extrasTotal;
    }

    public function getFormattedTotalWithExtrasAttribute(): string
    {
        return '$' . number_format($this->total_with_extras, 2);
    }

    public function getAttributesDisplayAttribute(): string
    {
        $attrs = [];
        foreach ($this->attributes as $attrValue) {
            $attrs[] = $attrValue->value;
        }
        return implode(' / ', $attrs);
    }

    public function getAttributesDetailedAttribute(): array
    {
        $result = [];
        foreach ($this->attributes as $attrValue) {
            $result[] = [
                'attribute' => $attrValue->attribute->name ?? 'N/A',
                'value' => $attrValue->value,
            ];
        }
        return $result;
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public static function generateSkuVariant(Product $product, array $attributeValues): string
    {
        $productSku = $product->sku;
        $parts = [$productSku];

        foreach ($attributeValues as $value) {
            $parts[] = Str::upper(Str::substr(Str::slug($value, ''), 0, 3));
        }

        return implode('-', $parts);
    }
}
</file>

<file path="app/Models/Recomendacion.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Recomendacion extends Model
{
    use HasFactory;
    protected $table = 'recomendacion';

    protected $fillable = [
        'nombre_recomendacion',
        'detalles_recomendacion',
        'activo',
        'fecha_baja',
        'motivo_baja',
    ];
    public function clientes()
    {
        return $this->hasMany(Cliente::class);
    }
}
</file>

<file path="app/Models/SystemSetting.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Cache;
use App\Traits\HasActivityLog;

class SystemSetting extends Model
{
    use HasActivityLog;

    public $activityLogNameField = 'label'; // Usar el label (ej: "Nombre de la Empresa") en lugar del ID en los logs

    protected $table = 'system_settings';

    protected $fillable = [
        'key',
        'value',
        'type',
        'group',
        'label',
        'description',
        'options',
        'updated_by',
    ];

    protected $casts = [
        'options' => 'array',
    ];

    protected $hidden = [
        'created_at',
        'updated_at',
    ];

    public function updatedByUser()
    {
        return $this->belongsTo(User::class, 'updated_by');
    }

    public static function getValue(string $key, mixed $default = null): mixed
    {
        // Validar formato de key
        if (!preg_match('/^[a-z][a-z0-9_]{2,50}$/', $key)) {
            return $default;
        }

        return Cache::remember("setting_{$key}", 3600, function () use ($key, $default) {
            $setting = static::where('key', $key)->first();

            if (!$setting) {
                return $default;
            }

            return match ($setting->type) {
                'boolean' => $setting->value === '1',
                'integer' => (int) $setting->value,
                'json' => json_decode($setting->value, true) ?? $default,
                default => $setting->value,
            };
        });
    }

    public static function getByGroup(string $group): \Illuminate\Database\Eloquent\Collection
    {
        // Validar formato de grupo
        if (!preg_match('/^[a-z]{3,50}$/', $group)) {
            return collect();
        }

        return static::where('group', $group)->orderBy('id')->get();
    }

    public static function getGroups(): array
    {
        return static::distinct()->pluck('group')->toArray();
    }
}
</file>

<file path="app/Models/User.php">
<?php

namespace App\Models;

// use Illuminate\Contracts\Auth\MustVerifyEmail;
use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Spatie\Permission\Traits\HasRoles;

class User extends Authenticatable
{
    /** @use HasFactory<\Database\Factories\UserFactory> */
    use HasFactory, Notifiable, HasRoles;

    /**
     * The attributes that are mass assignable.
     *
     * @var list<string>
     */
    protected $fillable = [
        'name',
        'email',
        'password',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var list<string>
     */
    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * Get the attributes that should be cast.
     *
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
        ];
    }
}
</file>

<file path="database/migrations/0001_01_01_000000_create_users_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });

        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });

        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->foreignId('user_id')->nullable()->index();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->longText('payload');
            $table->integer('last_activity')->index();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('users');
        Schema::dropIfExists('password_reset_tokens');
        Schema::dropIfExists('sessions');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_16_174450_create_giros_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('giros', function (Blueprint $table) {
            $table->id();
            $table->string('nombre_giro');
            $table->string('descripcion')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('giros');
    }
};
</file>

<file path="database/migrations/2025_12_19_172849_create_designs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('designs', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('slug')->unique();
            $table->text('description')->nullable();
            $table->boolean('is_active')->default(true);
            $table->timestamps();
            $table->softDeletes(); // Para eliminación suave

            // Índices
            $table->index('slug');
            $table->index('name');
            $table->index('is_active');
        });
        //softDeletes(): Agrega campo deleted_at para no eliminar físicamente registros
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('designs');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_19_172905_create_attributes_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('attributes', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('slug')->unique();
            $table->enum('type', ['select', 'color', 'text'])->default('select');
            $table->boolean('is_required')->default(false);
            $table->integer('order')->default(0);
            $table->timestamps();
            $table->softDeletes(); // <--- ESTA LÍNEA ES OBLIGATORIA
            // Índices
            $table->index('slug');
        });
        //enum(): Campo que solo acepta valores específicos (select, color, text)
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('attributes');
    }
};
</file>

<file path="database/migrations/2025_12_19_172911_create_attribute_values_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('attribute_values', function (Blueprint $table) {
            $table->id();
            $table->foreignId('attribute_id')->constrained()->onDelete('cascade');
            $table->string('value');
            $table->string('hex_color', 7)->nullable();
            $table->integer('order')->default(0);
            $table->timestamps();
            $table->softDeletes();
            // Índices
            $table->index('attribute_id');
        });
        //hex_color: Almacena colores como #FF0000 (7 caracteres máximo)
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('attribute_values');
    }
};
</file>

<file path="routes/api.php">
<?php

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Route;
use App\Http\Controllers\ImageController;
use App\Http\Controllers\ProductController;
use App\Http\Controllers\SearchController;

/*
|--------------------------------------------------------------------------
| API Routes
|--------------------------------------------------------------------------
| Estas rutas retornan JSON y están pensadas para operaciones AJAX
| Automáticamente tienen prefijo /api y middleware 'api'
*/

// Rutas de imágenes (operaciones AJAX)
Route::post('images/upload', [ImageController::class, 'upload'])
    ->name('api.images.upload')
    ->middleware('auth:sanctum');

Route::put('images/{image}', [ImageController::class, 'update'])
    ->name('api.images.update')
    ->middleware('auth:sanctum');

Route::delete('images/{image}', [ImageController::class, 'destroy'])
    ->name('api.images.destroy')
    ->middleware('auth:sanctum');

Route::post('images/reorder', [ImageController::class, 'reorder'])
    ->name('api.images.reorder')
    ->middleware('auth:sanctum');

// Autocompletado de búsqueda
Route::get('search/autocomplete', [SearchController::class, 'autocomplete'])
    ->name('api.search.autocomplete');

// Esta línea crea automáticamente las rutas para index, store, show, update y destroy
Route::apiResource('products', ProductController::class);
</file>

<file path="app/Http/Controllers/DesignVariantController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Design;
use App\Models\DesignVariant;
use App\Models\Attribute;
use App\Services\ImageService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\DB;

class DesignVariantController extends Controller
{
    protected ImageService $imageService;

    public function __construct(ImageService $imageService)
    {
        $this->imageService = $imageService;
    }

    public function create(Design $design)
    {
        try {
            $attributes = Attribute::with('values')
                ->orderBy('order')
                ->get();

            return view('admin.design-variants.create', compact('design', 'attributes'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de creación de variante: ' . $e->getMessage());
            return redirect()->route('admin.designs.index')
                ->with('error', 'Error al cargar formulario de creación de variante')
                ->with('icon', 'error');
            abort(500);
        }
    }

    /**
     * ============================================================
     * GUARDAR VARIANTE (STORE)
     * ============================================================
     */
    public function store(Request $request, Design $design)
    {
        Log::info('=== [PASO 0] INICIO MÉTODO STORE ===', [
            'design_id' => $design->id,
            'all_data' => $request->except(['_token', 'variant_images'])
        ]);

        // 1. Verificación inmediata de archivos
        if ($request->hasFile('variant_images')) {
            Log::info('=== [PASO 1] ARCHIVOS DETECTADOS ===', [
                'count' => count($request->file('variant_images')),
                'details' => array_map(fn($f) => $f->getClientOriginalName(), $request->file('variant_images'))
            ]);
        } else {
            Log::warning('=== [PASO 1] ADVERTENCIA: No se detectaron archivos en "variant_images" ===');
        }

        /**
         * 1. LIMPIEZA DE ATRIBUTOS (si se proporcionan)
         */
        if ($request->has('attribute_values')) {
            $request->merge([
                'attribute_values' => array_values(array_filter(
                    (array) $request->input('attribute_values'),
                    fn($value) => !is_null($value) && $value !== ''
                ))
            ]);
        }

        /**
         * 2. VALIDACIÓN (Simplificada - sin precio ni atributos obligatorios)
         */
        $rules = [
            'sku' => 'required|string|max:255|unique:design_variants,sku',
            'name' => 'required|string|max:255|unique:design_variants,name',
            'price' => 'nullable|numeric|min:0',
            'stock' => 'nullable|integer|min:0',
            'is_default' => 'nullable',
            'attribute_values' => 'nullable|array',
            'attribute_values.*' => 'exists:attribute_values,id',
            'variant_images' => 'nullable|array',
            'variant_images.*' => 'file|mimes:jpg,jpeg,png,webp,avif|max:10240',
            'primary_image_index' => 'nullable|integer|min:0',
        ];

        // Si hay imágenes, el índice de imagen principal es requerido
        if ($request->hasFile('variant_images')) {
            $rules['primary_image_index'] = 'required|integer|min:0';
        }

        $messages = [
            'primary_image_index.required' => 'Debes seleccionar una imagen principal para la variante.',
        ];

        $validator = Validator::make($request->all(), $rules, $messages);

        if ($validator->fails()) {
            Log::error('=== [ERROR] FALLO DE VALIDACIÓN ===', [
                'errors' => $validator->errors()->toArray()
            ]);

            // Si es petición AJAX, devolver JSON
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error de validación',
                    'errors' => $validator->errors()->toArray()
                ], 422);
            }

            return back()->with('error', 'Error al cargar formulario de creación de variante')
                ->with('icon', 'error')
                ->withInput();
        }

        Log::info('=== [PASO 2] VALIDACIÓN EXITOSA ===');
        $validated = $validator->validated();

        DB::beginTransaction();
        try {
            /**
             * 3. MANEJO DE VARIANTE POR DEFECTO
             */
            $isDefault = $request->input('is_default') == "1";
            if ($isDefault) {
                Log::info('=== [PASO 3] RESETEANDO OTRAS VARIANTES DEFAULT ===');
                $design->variants()->update(['is_default' => false]);
            }

            /**
             * 4. CREAR VARIANTE
             */
            $variant = $design->variants()->create([
                'sku' => $validated['sku'],
                'name' => $validated['name'],
                'price' => $validated['price'] ?? 0,
                'stock' => $validated['stock'] ?? 0,
                'is_active' => $request->input('is_active', "1") == "1",
                'is_default' => $isDefault,
                'activated_at' => now(),
            ]);

            Log::info('=== [PASO 4] VARIANTE CREADA EN BD ===', ['variant_id' => $variant->id]);

            /**
             * 5. SINCRONIZAR ATRIBUTOS (si se proporcionan)
             */
            if (!empty($validated['attribute_values'])) {
                $variant->attributeValues()->sync($validated['attribute_values']);
                Log::info('=== [PASO 5] ATRIBUTOS SINCRONIZADOS ===');
            } else {
                Log::info('=== [PASO 5] SIN ATRIBUTOS PARA SINCRONIZAR ===');
            }

            /**
             * 6. SUBIDA DE IMÁGENES
             */
            if ($request->hasFile('variant_images')) {
                Log::info('=== [PASO 6] INICIANDO SUBIDA DE IMÁGENES ===');

                // Obtener índice de imagen principal (0 por defecto)
                $primaryIndex = (int) $request->input('primary_image_index', 0);

                foreach ($request->file('variant_images') as $index => $image) {
                    $this->imageService->uploadImage(
                        $image,
                        DesignVariant::class,
                        $variant->id,
                        [
                            'design_name'   => $design->name,
                            'variant_name'  => $variant->name,
                            'variant_sku'   => $variant->sku,
                            'alt_text'      => $variant->name,
                            'is_primary'    => $index === $primaryIndex,
                            'image_context' => 'variant',
                            'order'         => $index,
                        ]
                    );
                }
                Log::info('=== [PASO 6] TODAS LAS IMÁGENES PROCESADAS EXITOSAMENTE ===', [
                    'primary_index' => $primaryIndex
                ]);
            }

            DB::commit();
            Log::info('=== [ÉXITO FINAL] TRANSACCIÓN COMPLETADA ===');

            // Si es petición AJAX, devolver JSON
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Variante guardada correctamente',
                    'variant_id' => $variant->id,
                    'redirect' => route('admin.designs.index')
                ]);
            }

            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Variante guardada correctamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('=== [ERROR CRÍTICO] FALLO EN EL PROCESO STORE ===', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            // Si es petición AJAX, devolver JSON de error
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error al guardar la variante: ' . $e->getMessage(),
                    'errors' => []
                ], 500);
            }

            return back()
                ->with('error', 'Error al guardar la variante: ' . $e->getMessage())
                ->withInput()
                ->with('icon', 'error');
        }
    }

    public function edit(Design $design, DesignVariant $variant)
    {
        $variant->load('images');
        $attributes = Attribute::with('values')->orderBy('order')->get();
        $selectedAttributeValues = $variant->attributeValues->pluck('id')->toArray();

        return view('admin.design-variants.edit', compact('design', 'variant', 'attributes', 'selectedAttributeValues'));
    }

    /**
     * ============================================================
     * ACTUALIZAR VARIANTE (UPDATE)
     * ============================================================
     */
    public function update(Request $request, Design $design, DesignVariant $variant)
    {
        Log::info('=== INICIO ACTUALIZACIÓN DE VARIANTE ===', ['id' => $variant->id]);

        if ($request->has('attribute_values')) {
            $request->merge([
                'attribute_values' => array_values(array_filter(
                    (array) $request->input('attribute_values'),
                    fn($value) => !is_null($value) && $value !== ''
                ))
            ]);
        }

        $validator = Validator::make($request->all(), [
            'sku' => 'required|string|max:255|unique:design_variants,sku,' . $variant->id,
            'name' => 'required|string|max:255|unique:design_variants,name,' . $variant->id,
            'price' => 'nullable|numeric|min:0',
            'stock' => 'nullable|integer|min:0',
            'is_default' => 'nullable',
            'attribute_values' => 'nullable|array',
            'attribute_values.*' => 'exists:attribute_values,id',
            'variant_images' => 'nullable|array',
            'variant_images.*' => 'file|mimes:jpg,jpeg,png,webp,avif|max:10240',
            'primary_image_id' => 'nullable|integer|exists:images,id',
        ]);

        if ($validator->fails()) {
            Log::error('Error de validación en update:', $validator->errors()->toArray());
            return back()->with('error', 'Error al cargar formulario de actualización de variante')
                ->with('icon', 'error')
                ->withInput();
        }

        $validated = $validator->validated();
        DB::beginTransaction();

        try {
            $isDefault = $request->input('is_default') == "1";
            if ($isDefault) {
                $design->variants()->where('id', '!=', $variant->id)->update(['is_default' => false]);
            }

            $variant->update([
                'sku' => $validated['sku'],
                'name' => $validated['name'],
                'price' => $validated['price'] ?? $variant->price ?? 0,
                'stock' => $validated['stock'] ?? $variant->stock,
                'is_default' => $isDefault,
                'is_active' => $request->input('is_active', "1") == "1",
                'activated_at' => $variant->activated_at ?? now(),
            ]);

            // Sincronizar atributos solo si se proporcionan
            if (!empty($validated['attribute_values'])) {
                $variant->attributeValues()->sync($validated['attribute_values']);
            }

            // Actualizar imagen principal si se proporcionó
            if ($request->filled('primary_image_id')) {
                $primaryImageId = $request->input('primary_image_id');

                // Quitar is_primary de todas las imágenes de la variante
                $variant->images()->update(['is_primary' => false]);

                // Establecer la nueva imagen principal
                $variant->images()->where('id', $primaryImageId)->update(['is_primary' => true]);

                Log::info('Imagen principal actualizada', [
                    'variant_id' => $variant->id,
                    'primary_image_id' => $primaryImageId
                ]);
            }

            if ($request->hasFile('variant_images')) {
                Log::info('Subiendo nuevas imágenes en update...');
                // Buscamos el último orden para no sobrescribir posiciones
                $lastOrder = $variant->images()->max('order') ?? -1;

                foreach ($request->file('variant_images') as $index => $image) {
                    $this->imageService->uploadImage(
                        $image,
                        DesignVariant::class,
                        $variant->id,
                        [
                            'design_name'   => $design->name,
                            'variant_name'  => $variant->name,
                            'variant_sku'   => $variant->sku,
                            'alt_text'      => $variant->name,
                            'is_primary'    => false, // En update, las nuevas no suelen ser primarias por defecto
                            'image_context' => 'variant',
                            'order'         => $lastOrder + $index + 1,
                        ]
                    );
                }
            }

            DB::commit();
            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Variante actualizada correctamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error en update variante: ' . $e->getMessage());
            return back()->with('error', 'Error al actualizar: ' . $e->getMessage())->withInput();
        }
    }

    public function destroy(Design $design, DesignVariant $variant)
    {
        try {
            DB::beginTransaction();
            foreach ($variant->images as $image) {
                $this->imageService->deleteImage($image);
            }
            $variant->delete();
            DB::commit();

            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Variante eliminada exitosamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al eliminar variante: ' . $e->getMessage());
            return back()->with('error', 'Error al eliminar variante')
                ->with('icon', 'error');
        }
    }

    public function destroyImage(Design $design, DesignVariant $variant, $imageId)
    {
        try {
            $image = $variant->images()->findOrFail($imageId);
            $this->imageService->deleteImage($image);
            return back()->with('success', 'Imagen eliminada correctamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            Log::error('Error al eliminar imagen de variante: ' . $e->getMessage());
            return back()->with('error', 'Error al eliminar imagen')
                ->with('icon', 'error');
        }
    }
}
</file>

<file path="app/Http/Controllers/EstadoController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Estado;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class EstadoController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $estados = Estado::all()->where('activo', true);
        return view('admin.estados.index', compact('estados'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.estados.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre_estado' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:estados,nombre_estado'
            ],
        ]);

        try {
            $estado = new Estado();
            $estado->nombre_estado = strtoupper(trim($request->nombre_estado));
            $estado->save();

            return redirect()->route('admin.estados.index')->with('success', 'Estado creado exitosamente');
        } catch (\Exception $e) {
            return redirect()->route('admin.estados.index')->with('error', 'Error al crear el estado');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Estado $estado)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $estado = Estado::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$estado) {
            return redirect()->route('admin.estados.index')->with('error', 'Estado no encontrado');
        }
        return view('admin.estados.edit', compact('estado'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_estado' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:estados,nombre_estado,' . $id,
            ],
        ]);
        try {
            $estado = Estado::where('id', $id)
                ->where('activo', true)
                ->firstOrFail();
            $estado->nombre_estado = strtoupper(trim($request->nombre_estado));

            //validamos si hubo algun cambio o modificacion en el valor del campo nombre_estado, si no hubo cambios, no se actualiza
            if (! $estado->isDirty()) {
                // return back()->with('info', 'No se realizaron cambios');
                return redirect()->route('admin.estados.index')->with('info', 'No se realizaron cambios');
            }

            $estado->save();
            return redirect()->route('admin.estados.index')->with('success', 'Estado actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el estado: ' . $e->getMessage());
            return redirect()->route('admin.estados.index')->with('error', 'Error al actualizar el estado');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function confirm_delete($id)
    {
        //validando que existe el estado
        $estado = Estado::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$estado) {
            return redirect()->route('admin.estados.index')->with('error', 'Estado no encontrado');
        }
        return view('admin.estados.delete', compact('estado'));
    }

    public function destroy($id)
    {
        $estado = Estado::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$estado) {
            return redirect()->route('admin.estados.confirm_delete', $id)->with('error', 'Estado no encontrado');
        }
        try {
            $estado->activo = false;
            $estado->save();
            return redirect()->route('admin.estados.index')->with('success', 'Estado eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el estado: ' . $e->getMessage());
            return redirect()->route('admin.estados.index')->with('error', 'Error al eliminar el estado');
        }
    }
}
</file>

<file path="app/Http/Controllers/SearchController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Design;
use App\Models\Category;
use App\Services\Search\SearchService;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Log;

/**
 * SearchController
 * 
 * Controlador de búsqueda con soporte para:
 * - Búsqueda tradicional (form submit)
 * - Búsqueda AJAX en tiempo real
 * - Autocompletado
 * - Filtros avanzados
 * 
 * @package App\Http\Controllers
 */
class SearchController extends Controller
{
    private SearchService $searchService;

    public function __construct(SearchService $searchService)
    {
        $this->searchService = $searchService;
    }

    /**
     * Búsqueda principal de diseños (página completa).
     * Soporta tanto búsqueda tradicional como AJAX.
     */
    public function index(Request $request)
    {
        // Si es AJAX, delegar al método AJAX
        if ($request->ajax() || $request->wantsJson()) {
            return $this->searchAjax($request);
        }

        $query = Design::with(['categories', 'primaryImage', 'variants']);

        // Aplicar búsqueda avanzada si hay término
        if ($request->filled('q')) {
            $searchTerm = $request->q;
            
            // Obtener IDs que coinciden con búsqueda normalizada
            $matchingIds = $this->searchService->getMatchingIds(
                $searchTerm, 
                Design::class,
                ['limit' => 500] // Límite razonable
            );

            if (!empty($matchingIds)) {
                // Usar los IDs encontrados, mantener relevancia
                $idsString = implode(',', $matchingIds);
                $query->whereIn('id', $matchingIds)
                      ->orderByRaw("FIELD(id, {$idsString})");
            } else {
                // Fallback: búsqueda LIKE tradicional si el índice no tiene resultados
                $query->where(function ($q) use ($searchTerm) {
                    $q->where('name', 'like', "%{$searchTerm}%")
                      ->orWhere('description', 'like', "%{$searchTerm}%");
                });
            }
        }

        // Filtro por categorías
        if ($request->filled('categories')) {
            $categoryIds = is_array($request->categories)
                ? $request->categories
                : [$request->categories];

            $query->whereHas('categories', function ($q) use ($categoryIds) {
                $q->whereIn('categories.id', $categoryIds);
            });
        }

        // Filtro por atributos
        if ($request->filled('attributes')) {
            $attributeValueIds = is_array($request->attributes)
                ? $request->attributes
                : [$request->attributes];

            $query->whereHas('variants.attributeValues', function ($q) use ($attributeValueIds) {
                $q->whereIn('attribute_values.id', $attributeValueIds);
            });
        }

        // Filtro por rango de precio
        if ($request->filled('price_min')) {
            $query->whereHas('variants', function ($q) use ($request) {
                $q->where('price', '>=', $request->price_min);
            });
        }

        if ($request->filled('price_max')) {
            $query->whereHas('variants', function ($q) use ($request) {
                $q->where('price', '<=', $request->price_max);
            });
        }

        // Solo diseños activos
        $query->where('is_active', true);

        // Ordenamiento (si no hay búsqueda con relevancia)
        if (!$request->filled('q')) {
            $sortBy = $request->get('sort_by', 'created_at');
            $sortOrder = $request->get('sort_order', 'desc');

            if (in_array($sortBy, ['name', 'created_at'])) {
                $query->orderBy($sortBy, $sortOrder);
            }
        }

        // Resultados paginados
        $designs = $query->paginate(12)->withQueryString();

        // Datos para filtros
        $categories = Category::where('is_active', true)
            ->orderBy('name')
            ->get();

        return view('admin.search.index', compact('designs', 'categories'));
    }

    /**
     * Búsqueda AJAX en tiempo real.
     * Retorna JSON con resultados parciales.
     */
    public function searchAjax(Request $request): JsonResponse
    {
        $term = $request->get('q', $request->get('term', ''));
        $categoryId = $request->get('category_id');
        $limit = min($request->get('limit', 20), 50); // Máximo 50
        $page = max($request->get('page', 1), 1);
        $offset = ($page - 1) * $limit;

        if (mb_strlen(trim($term)) < 1) {
            return response()->json([
                'success' => true,
                'data' => [],
                'total' => 0,
                'message' => 'Ingresa al menos 1 caracter',
            ]);
        }

        try {
            // Opciones de búsqueda
            $options = [
                'model_type' => Design::class,
                'limit' => $limit,
                'offset' => $offset,
                'only_active' => true,
            ];

            if ($categoryId) {
                $options['category_ids'] = [$categoryId];
            }

            // Ejecutar búsqueda
            $results = $this->searchService->search($term, $options);

            // Obtener modelos completos con relaciones
            $designIds = $results->pluck('id')->toArray();
            
            $designs = Design::with(['primaryImage', 'categories', 'variants', 'exports'])
                ->whereIn('id', $designIds)
                ->get()
                ->keyBy('id');

            // Formatear respuesta manteniendo orden de relevancia
            $formattedResults = $results->map(function ($result) use ($designs, $term) {
                $design = $designs->get($result['id']);
                
                if (!$design) {
                    return null;
                }

                // Usar thumbnail_small para listados (carga rápida)
                $imageSrc = null;
                if ($design->primaryImage) {
                    $imageSrc = $design->primaryImage->thumbnail_small
                        ? asset('storage/' . $design->primaryImage->thumbnail_small)
                        : asset('storage/' . $design->primaryImage->file_path);
                }

                return [
                    'id' => $design->id,
                    'name' => $design->name,
                    'slug' => $design->slug,
                    'description' => $design->description,
                    'excerpt' => $result['excerpt'] ?? $this->truncate($design->description, 100),
                    'image' => $imageSrc,
                    'categories' => $design->categories->pluck('name')->toArray(),
                    'variants_count' => $design->variants->count(),
                    'exports_count' => $design->exports->count(),
                    'score' => $result['score'] ?? 1,
                    'url' => route('admin.designs.show', $design),
                ];
            })->filter()->values();

            return response()->json([
                'success' => true,
                'data' => $formattedResults,
                'total' => $results->count(),
                'query' => $term,
                'page' => $page,
                'has_more' => $results->count() >= $limit,
            ]);

        } catch (\Exception $e) {
            Log::error('SearchController::searchAjax error', [
                'term' => $term,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error en la búsqueda',
                'data' => [],
            ], 500);
        }
    }

    /**
     * Autocompletado rápido para campo de búsqueda.
     */
    public function autocomplete(Request $request): JsonResponse
    {
        $term = $request->get('term', $request->get('q', ''));
        $limit = min($request->get('limit', 10), 20);

        if (mb_strlen(trim($term)) < 2) {
            return response()->json([]);
        }

        try {
            $suggestions = $this->searchService->autocomplete($term, $limit);

            // Agregar imagen thumbnail si está disponible
            $designIds = $suggestions->pluck('id')->toArray();
            $designs = Design::with('primaryImage')
                ->whereIn('id', $designIds)
                ->get()
                ->keyBy('id');

            $formatted = $suggestions->map(function ($item) use ($designs) {
                $design = $designs->get($item['id']);

                // Usar thumbnail_small para autocompletado (carga rápida)
                $imageSrc = null;
                if ($design && $design->primaryImage) {
                    $imageSrc = $design->primaryImage->thumbnail_small
                        ? asset('storage/' . $design->primaryImage->thumbnail_small)
                        : asset('storage/' . $design->primaryImage->file_path);
                }

                return [
                    'id' => $item['id'],
                    'value' => $item['title'], // Para jQuery UI Autocomplete
                    'label' => $item['title'], // Para jQuery UI Autocomplete
                    'name' => $item['title'],
                    'slug' => $item['metadata']['slug'] ?? null,
                    'image' => $imageSrc,
                ];
            });

            return response()->json($formatted);

        } catch (\Exception $e) {
            Log::error('SearchController::autocomplete error', [
                'term' => $term,
                'error' => $e->getMessage(),
            ]);

            // Fallback a búsqueda simple
            return $this->autocompleteFallback($term, $limit);
        }
    }

    /**
     * Fallback de autocompletado si el índice falla.
     */
    private function autocompleteFallback(string $term, int $limit): JsonResponse
    {
        $designs = Design::where('name', 'like', "%{$term}%")
            ->where('is_active', true)
            ->with('primaryImage')
            ->limit($limit)
            ->get();

        $formatted = $designs->map(function ($design) {
            // Usar thumbnail_small para fallback (carga rápida)
            $imageSrc = null;
            if ($design->primaryImage) {
                $imageSrc = $design->primaryImage->thumbnail_small
                    ? asset('storage/' . $design->primaryImage->thumbnail_small)
                    : asset('storage/' . $design->primaryImage->file_path);
            }

            return [
                'id' => $design->id,
                'value' => $design->name,
                'label' => $design->name,
                'name' => $design->name,
                'slug' => $design->slug,
                'image' => $imageSrc,
            ];
        });

        return response()->json($formatted);
    }

    /**
     * Endpoint para verificar estado del sistema de búsqueda.
     */
    public function healthCheck(): JsonResponse
    {
        $health = $this->searchService->healthCheck();
        $statusCode = $health['healthy'] ? 200 : 503;

        return response()->json($health, $statusCode);
    }

    /**
     * Endpoint para estadísticas del índice (admin).
     */
    public function stats(): JsonResponse
    {
        $stats = $this->searchService->getStats();
        return response()->json($stats);
    }

    /**
     * Truncar texto para excerpts.
     */
    private function truncate(?string $text, int $length = 100): string
    {
        if (empty($text)) {
            return '';
        }

        if (mb_strlen($text) <= $length) {
            return $text;
        }

        return mb_substr($text, 0, $length) . '...';
    }
}
</file>

<file path="app/Models/AttributeValue.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;

class AttributeValue extends Model
{
    use SoftDeletes;
    protected $fillable = [
        'attribute_id',
        'value',
        'hex_color',
        'order'
    ];
    protected $dates = ['deleted_at'];

    protected $casts = [
        'order' => 'integer'
    ];



    public const TALLAS_ORDENADAS = [
        'XXS' => 1,
        'XS' => 2,
        'S' => 3,
        'CH' => 3, // CH y S son lo mismo
        'M' => 4,
        'L' => 5,
        'G' => 5,
        'XL' => 6,
        'XG' => 6,
        'XXL' => 7
    ];
    /**
     * GLOBAL SCOPE DE ORDENAMIENTO
     * Esto hace que CUALQUIER consulta a AttributeValue salga ordenada por 'order'.
     */
    protected static function boot()
    {
        parent::boot();

        static::creating(function ($model) {
            $valor = strtoupper($model->value);

            // Si el valor existe en nuestro diccionario, le asigna su peso
            if (isset(self::TALLAS_ORDENADAS[$valor])) {
                $model->order = self::TALLAS_ORDENADAS[$valor];
            } else {
                // Si es una talla nueva/extraña, la manda al final
                $model->order = static::where('attribute_id', $model->attribute_id)->max('order') + 1;
            }
        });
    }

    // Relación: Un valor pertenece a un atributo
    public function attribute()
    {
        return $this->belongsTo(Attribute::class);
    }

    // Relación: Un valor está en muchas variantes
    public function designVariants()
    {
        return $this->belongsToMany(DesignVariant::class, 'design_variant_attributes');
    }
}
</file>

<file path="app/Models/DesignVariant.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

class DesignVariant extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'design_id',
        'sku',
        'name',
        'price',
        'stock',
        'is_active',
        'is_default'
    ];

    protected $casts = [
        'price' => 'decimal:2',
        'stock' => 'integer',
        'is_active' => 'boolean',
        'is_default' => 'boolean'
    ];

    // Una variante pertenece a un diseño
    public function design()
    {
        return $this->belongsTo(Design::class);
    }

    // Valores de atributos (tallas, colores, etc.)
    public function attributeValues()
    {
        return $this->belongsToMany(AttributeValue::class, 'design_variant_attributes');
    }

    // 📸 Imágenes polimórficas
    public function images()
    {
        return $this->morphMany(Image::class, 'imageable');
    }

    // ⭐ Imagen principal
    public function primaryImage()
    {
        return $this->morphOne(Image::class, 'imageable')
            ->where('is_primary', true);
    }

    // NUEVA RELACIÓN: Una variante tiene muchas exportaciones (archivos de producción)
    /**
     * Relación con las exportaciones de la variante.
     * Esta relación es CRÍTICA para la funcionalidad de producción.
     * Usa la columna 'design_variant_id' como clave foránea.
     */
    public function exports()
    {
        return $this->hasMany(DesignExport::class, 'design_variant_id');
    }

    // NUEVA RELACIÓN: Usuario que creó la variante (para auditoría)
    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    // NUEVO MÉTODO: Contador de exportaciones (para optimización en vistas)
    public function getExportsCountAttribute()
    {
        // Si ya existe el campo exports_count en la tabla (optimización), usarlo
        if (isset($this->attributes['exports_count'])) {
            return $this->attributes['exports_count'];
        }
        // Si no, contar sobre la relación
        return $this->exports()->count();
    }

    // NUEVO MÉTODO: Verifica si la variante tiene exportaciones
    public function hasExports()
    {
        return $this->exports()->exists();
    }

    // NUEVO MÉTODO: Verifica si la variante tiene exportaciones aprobadas
    public function hasApprovedExports()
    {
        return $this->exports()->where('status', 'aprobado')->exists();
    }
}
</file>

<file path="app/Models/Product.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;

class Product extends Model
{
    use SoftDeletes;

    protected $table = 'products';

    protected $fillable = [
        'uuid',
        'tenant_id',
        'product_category_id',
        'name',
        'sku',
        'description',
        'specifications',
        'status',
    ];

    protected $casts = [
        'specifications' => 'array',
        'tenant_id' => 'integer',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->tenant_id)) {
                $model->tenant_id = 1;
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function category()
    {
        return $this->belongsTo(ProductCategory::class, 'product_category_id');
    }

    public function variants()
    {
        return $this->hasMany(ProductVariant::class, 'product_id');
    }

    public function activeVariants()
    {
        return $this->hasMany(ProductVariant::class, 'product_id')
            ->orderBy('sku_variant');
    }

    public function extras()
    {
        return $this->belongsToMany(ProductExtra::class, 'product_extra_assignment', 'product_id', 'product_extra_id')
            ->withTimestamps();
    }

    public function designs()
    {
        return $this->belongsToMany(Design::class, 'product_design', 'product_id', 'design_id')
            ->withPivot('application_type_id')
            ->withTimestamps();
    }

    public function materials()
    {
        return $this->belongsToMany(MaterialVariant::class, 'product_materials', 'product_id', 'material_variant_id')
            ->using(ProductMaterial::class)
            ->withPivot(['id', 'quantity', 'is_primary', 'notes'])
            ->withTimestamps();
    }

    public function images()
    {
        return $this->morphMany(Image::class, 'imageable');
    }

    public function primaryImage()
    {
        return $this->morphOne(Image::class, 'imageable')
            ->where('is_primary', true);
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('status', 'active');
    }

    public function scopeDraft(Builder $query): Builder
    {
        return $query->where('status', 'draft');
    }

    public function scopeDiscontinued(Builder $query): Builder
    {
        return $query->where('status', 'discontinued');
    }

    public function scopeByCategory(Builder $query, int $categoryId): Builder
    {
        return $query->where('product_category_id', $categoryId);
    }

    public function scopeSearch(Builder $query, string $term): Builder
    {
        return $query->where(function ($q) use ($term) {
            $q->where('name', 'like', "%{$term}%")
                ->orWhere('sku', 'like', "%{$term}%")
                ->orWhere('description', 'like', "%{$term}%");
        });
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getStatusLabelAttribute(): string
    {
        return match ($this->status) {
            'active' => 'Activo',
            'draft' => 'Borrador',
            'discontinued' => 'Descontinuado',
            default => 'Desconocido',
        };
    }

    public function getStatusColorAttribute(): string
    {
        return match ($this->status) {
            'active' => 'success',
            'draft' => 'warning',
            'discontinued' => 'danger',
            default => 'secondary',
        };
    }

    public function getIsActiveAttribute(): bool
    {
        return $this->status === 'active';
    }

    public function getTotalStitchesAttribute(): int
    {
        $total = 0;
        foreach ($this->designs as $design) {
            $total += $design->stitch_count ?? 0;
        }
        return $total;
    }

    public function getBasePrice(): float
    {
        $variant = $this->variants()->orderBy('price', 'asc')->first();
        return $variant ? (float) $variant->price : 0;
    }

    public function getBasePriceAttribute(): float
    {
        return $this->getBasePrice();
    }

    public function getFormattedBasePriceAttribute(): string
    {
        return '$' . number_format($this->base_price, 2);
    }

    public function getExtrasTotal(): float
    {
        return (float) $this->extras->sum('price_addition');
    }

    public function getExtrasTotalAttribute(): float
    {
        return $this->getExtrasTotal();
    }

    public function getVariantsCountAttribute(): int
    {
        return $this->variants()->count();
    }

    public function getPrimaryImageUrlAttribute(): ?string
    {
        $image = $this->primaryImage;
        if ($image) {
            return $image->url;
        }

        $firstImage = $this->images()->first();
        return $firstImage ? $firstImage->url : null;
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canEdit(): bool
    {
        return in_array($this->status, ['draft', 'active']);
    }

    public function canDelete(): bool
    {
        return $this->status === 'draft' || $this->variants()->count() === 0;
    }

    public function activate(): void
    {
        $this->status = 'active';
        $this->save();
    }

    public function discontinue(): void
    {
        $this->status = 'discontinued';
        $this->save();
    }

    public function setAsDraft(): void
    {
        $this->status = 'draft';
        $this->save();
    }

    public static function generateSku(string $categoryPrefix, string $name): string
    {
        $nameSlug = Str::upper(Str::substr(Str::slug($name, ''), 0, 6));
        $random = Str::upper(Str::random(4));
        return "{$categoryPrefix}-{$nameSlug}-{$random}";
    }
}
</file>

<file path="database/migrations/2025_12_16_174451_create_estados_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('estados', function (Blueprint $table) {
            $table->id();
            $table->string('nombre_estado');
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->string('motivo_baja')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('estados');
    }
};
</file>

<file path="database/migrations/2025_12_19_172856_create_design_variants_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('design_variants', function (Blueprint $table) {
            $table->id();
            $table->foreignId('design_id')->constrained()->onDelete('cascade');

            // Identidad de negocio
            $table->string('sku')->unique();

            // Datos operativos
            $table->string('name');
            $table->decimal('price', 10, 2)->nullable();
            $table->integer('stock')->default(0);

            // Estado de negocio
            $table->boolean('is_active')->default(true);
            $table->boolean('is_default')->default(false);

            // Auditoría
            $table->timestamps();
            $table->timestamp('activated_at')->nullable();
            $table->timestamp('deactivated_at')->nullable();

            // Eliminación lógica (SaaS / Historial)
            $table->softDeletes();

            // Índices
            $table->index('design_id');
            $table->index('sku');
            $table->index('is_active');
        });

        /*
        decimal('price', 10, 2): Permite precios como 1234.56 (10 dígitos, 2 decimales)
        constrained(): Sin especificar tabla, Laravel deduce 'designs' por el nombre del
         */
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('design_variants');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="app/Http/Controllers/DesignController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Design;
use App\Models\Category;
use App\Models\Image;
use App\Services\DesignService;
use App\Services\ImageService;
use App\Services\Search\SearchService;
use App\Http\Requests\StoreDesignRequest;
use App\Http\Requests\UpdateDesignRequest;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Session;

class DesignController extends Controller
{
    protected $designService;
    protected $imageService;
    protected $searchService;

    public function __construct(DesignService $designService, ImageService $imageService, SearchService $searchService)
    {
        $this->designService = $designService;
        $this->imageService = $imageService;
        $this->searchService = $searchService;
        $this->middleware('secure.file.upload')->only(['store', 'update']);
    }

    public function index(Request $request)
    {
        try {
            $baseQuery = Design::query()
                ->with(['categories', 'primaryImage', 'variants', 'variants.primaryImage'])
                ->where('is_active', true);

            // Variable para almacenar IDs de búsqueda (usada también en conteo de categorías)
            $matchingIds = [];

            // Búsqueda avanzada con normalización española
            if ($request->filled('search')) {
                $searchTerm = $request->search;

                // Obtener IDs que coinciden con búsqueda normalizada
                $matchingIds = $this->searchService->getMatchingIds(
                    $searchTerm,
                    Design::class,
                    ['limit' => 500]
                );

                if (!empty($matchingIds)) {
                    // Usar los IDs encontrados, mantener relevancia
                    $idsString = implode(',', $matchingIds);
                    $baseQuery->whereIn('id', $matchingIds)
                              ->orderByRaw("FIELD(id, {$idsString})");
                } else {
                    // Fallback: búsqueda LIKE tradicional si el índice no tiene resultados
                    $baseQuery->where(function ($q) use ($searchTerm) {
                        $q->where('name', 'like', "%{$searchTerm}%")
                          ->orWhere('description', 'like', "%{$searchTerm}%");
                    });
                }
            }

            $activeCategory = null;
            if ($request->filled('category')) {
                $activeCategory = Category::where('slug', $request->category)
                    ->where('is_active', true)
                    ->first();

                if ($activeCategory) {
                    $baseQuery->whereHas('categories', function ($q) use ($activeCategory) {
                        $q->where('categories.id', $activeCategory->id);
                    });
                }
            }

            $designs = (clone $baseQuery)
                ->orderByDesc('created_at')
                ->paginate(12)
                ->withQueryString();

            $categories = Category::where('is_active', true)
                ->orderBy('name')
                ->get();

            $categoryCounts = [];
            foreach ($categories as $category) {
                $countQuery = Design::query()
                    ->where('is_active', true);

                // Usar misma lógica de búsqueda avanzada para el conteo
                if ($request->filled('search') && !empty($matchingIds)) {
                    $countQuery->whereIn('id', $matchingIds);
                } elseif ($request->filled('search')) {
                    $countQuery->where(function ($q) use ($request) {
                        $q->where('name', 'like', '%' . $request->search . '%')
                          ->orWhere('description', 'like', '%' . $request->search . '%');
                    });
                }

                $categoryCounts[$category->id] = $countQuery
                    ->whereHas('categories', fn($q) => $q->where('categories.id', $category->id))
                    ->count();
            }

            return view('admin.designs.index', compact(
                'designs',
                'categories',
                'activeCategory',
                'categoryCounts'
            ));
        } catch (\Exception $e) {
            Log::error('Error al cargar listado de diseños: ' . $e->getMessage());
            return redirect()
                ->route('admin.designs.index')
                ->with('icon', 'error')
                ->with('error', 'Error al cargar los diseños: ' . $e->getMessage());
        }
    }

    /**
     * Obtener listado de diseños vía AJAX (para búsqueda sin reload).
     * Soporta filtro por categoría.
     */
    public function ajaxList(Request $request)
    {
        try {
            $query = Design::with(['primaryImage', 'categories', 'variants', 'exports'])
                ->where('is_active', true);

            // Filtro por categoría si se especifica
            if ($request->filled('category')) {
                $query->whereHas('categories', function ($q) use ($request) {
                    $q->where('slug', $request->category);
                });
            }

            $designs = $query->orderByDesc('created_at')
                ->limit(100)
                ->get();

            $formattedDesigns = $designs->map(function ($design) {
                return [
                    'id' => $design->id,
                    'name' => $design->name,
                    'slug' => $design->slug,
                    'description' => $design->description,
                    'image' => $design->primaryImage
                        ? asset('storage/' . $design->primaryImage->file_path)
                        : null,
                    'categories' => $design->categories->pluck('name')->toArray(),
                    'variants_count' => $design->variants->count(),
                    'exports_count' => $design->exports->count(),
                ];
            });

            return response()->json([
                'success' => true,
                'data' => $formattedDesigns,
                'total' => $formattedDesigns->count(),
            ]);
        } catch (\Exception $e) {
            Log::error('Error en ajaxList: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error al cargar diseños',
                'data' => [],
            ], 500);
        }
    }

    public function show(Design $design)
    {
        try {
            $design->load([
                'categories',
                'primaryImage',
                'variants.images' => function ($q) {
                    $q->orderBy('order');
                },
                'variants.attributeValues'
            ]);

            // Cargar conteos de exports (todas las exportaciones del diseño)
            $design->loadCount('exports');

            $formattedDesign = [
                'id' => $design->id,
                'name' => $design->name,
                'slug' => $design->slug,
                'description' => $design->description,
                'is_active' => $design->is_active,
                'variants_count' => $design->variants->count(),
                'exports_count' => $design->exports_count ?? 0,
                'primaryImage' => $design->primaryImage ? [
                    'id' => $design->primaryImage->id,
                    'file_path' => $design->primaryImage->file_path,
                    'thumbnail_small' => $design->primaryImage->thumbnail_small,
                    'thumbnail_medium' => $design->primaryImage->thumbnail_medium,
                    'alt_text' => $design->primaryImage->alt_text,
                    'is_primary' => $design->primaryImage->is_primary,
                    'order' => $design->primaryImage->order
                ] : null,
                'variants' => $design->variants->map(function ($variant) {
                    return [
                        'id' => $variant->id,
                        'name' => $variant->name,
                        'sku' => $variant->sku,
                        'price' => $variant->price,
                        'stock' => $variant->stock,
                        'is_active' => $variant->is_active,
                        'is_default' => $variant->is_default,
                        'images' => $variant->images->map(function ($image) {
                            return [
                                'id' => $image->id,
                                'file_path' => $image->file_path,
                                'thumbnail_small' => $image->thumbnail_small,
                                'thumbnail_medium' => $image->thumbnail_medium,
                                'alt_text' => $image->alt_text,
                                'is_primary' => $image->is_primary,
                                'order' => $image->order
                            ];
                        })
                    ];
                })
            ];

            return response()->json([
                'success' => true,
                'design' => $formattedDesign
            ]);
        } catch (\Exception $e) {
            Log::error('Error al cargar detalles del diseño: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error al cargar detalles: ' . $e->getMessage()
            ], 500);
        }
    }

    public function create()
    {
        try {
            $categories = Category::where('is_active', true)
                ->orderBy('name')
                ->get();

            // Recuperar datos temporales si existen
            $tempImageData = Session::get('temp_image_data');

            return view('admin.designs.create', compact('categories', 'tempImageData'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de creación: ' . $e->getMessage());
            return redirect()
                ->route('admin.designs.create')
                ->with('icon', 'error')
                ->with('error', 'Error al cargar el formulario: ' . $e->getMessage());
        }
    }

    public function store(StoreDesignRequest $request)
    {
        DB::beginTransaction();

        try {
            Log::info('=== INICIO CREACIÓN DE DISEÑO ===');
            Log::info('Datos recibidos:', $request->only(['name', 'description', 'categories']));
            Log::info('¿Tiene archivo?', ['hasFile' => $request->hasFile('image')]);

            // Obtener información de validación del middleware
            $detectedType = $request->input('_file_image_type', 'image');
            $detectedFormat = $request->input('_file_image_format');
            $correctExtension = $request->input('_file_image_extension');
            $uploadNote = $request->input('_file_image_note');

            if ($uploadNote) {
                Log::info('Nota del middleware: ' . $uploadNote);
            }

            // Preparar datos del diseño
            $designData = $request->validated();

            // Crear diseño usando el servicio
            $design = $this->designService->createDesign($designData);
            Log::info('Diseño creado con ID: ' . $design->id);

            // Procesar archivo temporal si existe
            $tempImageData = Session::get('temp_image_data');
            if ($tempImageData && isset($tempImageData['temp_path'])) {
                $this->processTempImage($design, $tempImageData);
            } elseif ($request->hasFile('image')) {
                // Guardar archivo si fue subido
                $file = $request->file('image');
                $originalExtension = strtolower($file->getClientOriginalExtension());

                Log::info('Información del archivo:', [
                    'nombre' => $file->getClientOriginalName(),
                    'tamaño' => $file->getSize(),
                    'tipo_mime' => $file->getMimeType(),
                    'extensión_original' => $originalExtension,
                    'extensión_correcta' => $correctExtension,
                    'tipo_detectado' => $detectedType,
                    'formato_detectado' => $detectedFormat,
                    'nota' => $uploadNote,
                    'válido' => $file->isValid(),
                ]);

                // Determinar tipo de archivo basado en detección del middleware
                if ($detectedType === 'image' || $detectedType === 'vector') {
                    // Usar el ImageService existente para imágenes/vectores
                    // [ACTUALIZACIÓN]: Se pasa 'forced_extension' para que ImageService use la corrección del middleware
                    $image = $this->imageService->uploadImage(
                        $file,
                        'App\Models\Design',
                        $design->id,
                        [
                            'design_name' => $design->name,
                            'alt_text' => $request->name,
                            'is_primary' => true,
                            'order' => 0,
                            'forced_extension' => $correctExtension // [ACTUALIZACIÓN]
                        ]
                    );

                    Log::info('Archivo guardado con ID: ' . $image->id);
                    Log::info('Ruta del archivo: ' . $image->file_path);

                    // Actualizar información adicional del archivo en el diseño
                    $design->update([
                        'file_type' => $detectedType,
                        'file_extension' => $correctExtension ?? $originalExtension,
                        'file_size' => $file->getSize(),
                        'original_filename' => $file->getClientOriginalName(),
                        'detected_format' => $detectedFormat,
                    ]);

                    // Mostrar mensaje al usuario si la extensión fue corregida
                    if ($uploadNote && Str::contains($uploadNote, 'será corregida')) {
                        session()->flash('extension_warning', $uploadNote);
                    }
                } elseif ($detectedType === 'embroidery') {
                    // Para archivos de bordado, usar el proceso existente
                    $originalName = pathinfo($file->getClientOriginalName(), PATHINFO_FILENAME);
                    // [ACTUALIZACIÓN]: Usar correctExtension si está disponible
                    $finalExt = $correctExtension ?? $originalExtension;
                    $fileName = Str::slug($originalName) . '_' . time() . '_' . Str::random(8) . '.' . $finalExt;
                    $path = $file->storeAs('designs/embroidery', $fileName, 'public');

                    // Crear registro en tabla images para mantener consistencia
                    $image = Image::create([
                        'file_path' => $path,
                        'alt_text' => $request->name . ' (Archivo de bordado)',
                        'is_primary' => true,
                        'order' => 0,
                        'imageable_type' => 'App\Models\Design',
                        'imageable_id' => $design->id,
                        'original_extension' => $originalExtension,
                        'correct_extension' => $correctExtension,
                    ]);

                    // Actualizar diseño con información del archivo
                    $design->update([
                        'file_type' => 'embroidery',
                        'file_extension' => $correctExtension ?? $originalExtension,
                        'file_size' => $file->getSize(),
                        'original_filename' => $file->getClientOriginalName(),
                        'embroidery_file_path' => $path,
                        'detected_format' => $detectedFormat,
                    ]);

                    Log::info('Archivo de bordado guardado en: ' . $path);
                }
            } else {
                Log::warning('No se recibió ningún archivo en la petición');
            }

            DB::commit();
            Log::info('=== FIN CREACIÓN DE DISEÑO EXITOSA ===');

            // Limpiar datos temporales si existen
            Session::forget('temp_image_data');

            // Si es una solicitud AJAX, responder con JSON
            if ($request->ajax() || $request->wantsJson()) {
                $successMessage = 'Diseño ' . mb_strtoupper($design->name, 'UTF-8') . ' creado exitosamente';

                // Guardar mensaje en sesión para que aparezca el SweetAlert en el index
                Session::flash('success', $successMessage);

                return response()->json([
                    'success' => true,
                    'message' => $successMessage,
                    'redirect' => route('admin.designs.index'),
                    'design' => [
                        'id' => $design->id,
                        'name' => $design->name,
                    ]
                ]);
            }

            // Preparar respuesta con posible advertencia
            $response = redirect()
                ->route('admin.designs.index')
                ->with('success', 'Diseño ' . mb_strtoupper($request->name, 'UTF-8') . ' creado exitosamente')
                ->with('icon', 'success');

            if (session()->has('extension_warning')) {
                $response->with('warning', session('extension_warning'));
            }

            return $response;
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('=== ERROR AL CREAR DISEÑO ===');
            Log::error('Mensaje: ' . $e->getMessage());
            Log::error('Archivo: ' . $e->getFile());
            Log::error('Línea: ' . $e->getLine());
            Log::error('Stack trace: ' . $e->getTraceAsString());

            // Guardar temporalmente la información del archivo si fue subido
            if ($request->hasFile('image')) {
                $file = $request->file('image');

                // Almacenar archivo temporalmente
                $tempFileName = 'temp_' . time() . '_' . Str::random(8) . '.' . $file->getClientOriginalExtension();
                $tempPath = $file->storeAs('temp', $tempFileName, 'public');

                // Guardar información del archivo en sesión
                Session::put('temp_image_data', [
                    'temp_path' => $tempPath,
                    'original_name' => $file->getClientOriginalName(),
                    'original_extension' => $file->getClientOriginalExtension(),
                    'detected_type' => $request->input('_file_image_type', 'image'),
                    'detected_format' => $request->input('_file_image_format'),
                    'correct_extension' => $request->input('_file_image_extension'),
                    'upload_note' => $request->input('_file_image_note'),
                    'file_size' => $file->getSize(),
                    'original_filename' => $file->getClientOriginalName(),
                ]);
            }

            // Si es una solicitud AJAX, responder con JSON
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error al crear el diseño: ' . $e->getMessage(),
                    'errors' => []
                ], 500);
            }

            return redirect()
                ->route('admin.designs.create')
                ->with('icon', 'error')
                ->withInput()
                ->with('error', 'Error al crear el diseño: ' . $e->getMessage());
        }
    }

    public function edit(Design $design)
    {
        try {
            $categories = Category::where('is_active', true)
                ->orderBy('name')
                ->get();

            $selectedCategories = $design->categories->pluck('id')->toArray();

            $design->load(['images' => function ($query) {
                $query->orderBy('order', 'asc');
            }]);

            return view('admin.designs.edit', compact(
                'design',
                'categories',
                'selectedCategories'
            ));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de edición: ' . $e->getMessage());
            return redirect()
                ->route('admin.designs.edit', $design)
                ->with('icon', 'error')
                ->withInput()
                ->with('error', 'Error al cargar el formulario de edición: ' . $e->getMessage());
        }
    }

    public function update(UpdateDesignRequest $request, Design $design)
    {
        DB::beginTransaction();

        try {
            Log::info('=== INICIO ACTUALIZACIÓN DE DISEÑO ===');
            Log::info('ID del diseño: ' . $design->id);

            $updatedDesign = $this->designService->updateDesign($design, $request->validated());
            Log::info('Diseño actualizado correctamente');

            // Procesar archivo temporal si existe
            $tempImageData = Session::get('temp_image_data');
            if ($tempImageData && isset($tempImageData['temp_path'])) {
                $this->processTempImage($design, $tempImageData);
            } elseif ($request->hasFile('image')) {
                // ✅ Actualizar o agregar nuevo archivo si fue subido
                Log::info('Nuevo archivo recibido');

                $file = $request->file('image');
                $extension = strtolower($file->getClientOriginalExtension());

                // [ACTUALIZACIÓN]: Capturamos todos los datos del middleware
                $correctExtension = $request->input('_file_image_extension', $extension);
                $detectedType = $request->input('_file_image_type');
                $detectedFormat = $request->input('_file_image_format');

                // Determinar tipo de archivo
                $imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'svg', 'svgz'];
                $embroideryExtensions = ['pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv', 'csd', '10o', 'bro'];

                if (in_array($extension, $imageExtensions) || in_array($correctExtension, $imageExtensions) || $detectedType === 'image') {
                    // Para imágenes/vectores, usar el ImageService
                    $design->images()->update(['is_primary' => false]);

                    // [ACTUALIZACIÓN]: Se pasa forced_extension al service
                    $image = $this->imageService->uploadImage(
                        $file,
                        'App\Models\Design',
                        $design->id,
                        [
                            'design_name' => $design->name,
                            'alt_text' => $request->name,
                            'image_context' => 'design',
                            'is_primary' => true,
                            'order' => $design->images()->max('order') + 1,
                            'forced_extension' => $correctExtension // [ACTUALIZACIÓN]
                        ]
                    );

                    Log::info('Nueva imagen/vector guardado con ID: ' . $image->id);

                    // Actualizar información del archivo
                    $design->update([
                        'file_type' => in_array($correctExtension, ['svg', 'svgz']) ? 'vector' : 'image',
                        'file_extension' => $correctExtension,
                        'file_size' => $file->getSize(),
                        'original_filename' => $file->getClientOriginalName(),
                        'detected_format' => $detectedFormat, // [ACTUALIZACIÓN]
                    ]);
                } elseif (in_array($extension, $embroideryExtensions) || $detectedType === 'embroidery') {
                    // Para archivos de bordado
                    // Eliminar archivo anterior si existe
                    if ($design->embroidery_file_path && Storage::disk('public')->exists($design->embroidery_file_path)) {
                        Storage::disk('public')->delete($design->embroidery_file_path);
                    }

                    // Eliminar imágenes anteriores relacionadas
                    $design->images()->delete();

                    // Guardar nuevo archivo
                    $originalName = pathinfo($file->getClientOriginalName(), PATHINFO_FILENAME);
                    $finalExt = $correctExtension ?? $extension;
                    $fileName = Str::slug($originalName) . '_' . time() . '_' . Str::random(8) . '.' . $finalExt;
                    $path = $file->storeAs('designs/embroidery', $fileName, 'public');

                    // Crear registro en tabla images
                    Image::create([
                        'file_path' => $path,
                        'alt_text' => $request->name . ' (Archivo de bordado)',
                        'is_primary' => true,
                        'order' => 0,
                        'imageable_type' => 'App\Models\Design',
                        'imageable_id' => $design->id,
                    ]);

                    // Actualizar información del archivo
                    $design->update([
                        'file_type' => 'embroidery',
                        'file_extension' => $finalExt,
                        'file_size' => $file->getSize(),
                        'original_filename' => $file->getClientOriginalName(),
                        'embroidery_file_path' => $path,
                        'detected_format' => $detectedFormat, // [ACTUALIZACIÓN]
                    ]);

                    Log::info('Nuevo archivo de bordado guardado en: ' . $path);
                }
            }

            DB::commit();
            Log::info('=== FIN ACTUALIZACIÓN EXITOSA ===');

            // Limpiar datos temporales
            Session::forget('temp_image_data');

            // Si es una solicitud AJAX, responder con JSON
            if ($request->ajax() || $request->wantsJson()) {
                $successMessage = 'Diseño ' . mb_strtoupper($updatedDesign->name, 'UTF-8') . ' actualizado exitosamente';

                // Guardar mensaje en sesión para que aparezca el SweetAlert en el index
                Session::flash('success', $successMessage);

                return response()->json([
                    'success' => true,
                    'message' => $successMessage,
                    'redirect' => route('admin.designs.index'),
                    'design' => [
                        'id' => $updatedDesign->id,
                        'name' => $updatedDesign->name,
                    ]
                ]);
            }

            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Diseño ' . mb_strtoupper($updatedDesign->name, 'UTF-8') . ' actualizado exitosamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('=== ERROR AL ACTUALIZAR DISEÑO ===');
            Log::error('Mensaje: ' . $e->getMessage());
            Log::error('Stack trace: ' . $e->getTraceAsString());

            // Si hay un nuevo archivo subido, guardarlo temporalmente
            if ($request->hasFile('image')) {
                $file = $request->file('image');

                // Almacenar archivo temporalmente
                $tempFileName = 'temp_' . time() . '_' . Str::random(8) . '.' . $file->getClientOriginalExtension();
                $tempPath = $file->storeAs('temp', $tempFileName, 'public');

                // Guardar información del archivo en sesión
                Session::put('temp_image_data', [
                    'temp_path' => $tempPath,
                    'original_name' => $file->getClientOriginalName(),
                    'original_extension' => $file->getClientOriginalExtension(),
                    'detected_type' => $request->input('_file_image_type', 'image'),
                    'detected_format' => $request->input('_file_image_format'),
                    'correct_extension' => $request->input('_file_image_extension'),
                    'upload_note' => $request->input('_file_image_note'),
                    'file_size' => $file->getSize(),
                ]);
            }

            // Si es una solicitud AJAX, responder con JSON
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error al actualizar el diseño: ' . $e->getMessage(),
                    'errors' => []
                ], 500);
            }

            return redirect()
                ->route('admin.designs.edit', $design)
                ->with('icon', 'error')
                ->withInput()
                ->with('error', 'Error al actualizar el diseño: ' . $e->getMessage());
        }
    }

    public function destroy(Design $design)
    {
        DB::beginTransaction();

        try {
            Log::info('=== INICIO ELIMINACIÓN DE DISEÑO ===', [
                'design_id' => $design->id,
                'design_name' => $design->name
            ]);

            if ($design->deleted_at !== null) {
                Log::warning('Intento de eliminar un diseño ya eliminado', [
                    'design_id' => $design->id
                ]);
                return redirect()
                    ->route('admin.designs.index')
                    ->with('icon', 'warning')
                    ->with('success', 'El diseño ya había sido eliminado previamente.');
            }

            if ($design->variants()->exists()) {
                Log::info('El diseño tiene variantes, desactivándolas');
                $design->variants()->update([
                    'is_active' => false,
                    'deleted_at' => now(),
                ]);
            }

            $design->update(['is_active' => false]);
            $this->designService->deleteDesign($design);

            DB::commit();
            Log::info('=== DISEÑO ELIMINADO CORRECTAMENTE ===', [
                'design_id' => $design->id
            ]);

            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Diseño ' . mb_strtoupper($design->name, 'UTF-8') . ' eliminado exitosamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('=== ERROR AL ELIMINAR DISEÑO ===', [
                'design_id' => $design->id,
                'error' => $e->getMessage(),
                'file' => $e->getFile(),
                'line' => $e->getLine(),
            ]);

            return redirect()
                ->route('admin.designs.index')
                ->with('icon', 'error')
                ->with('error', 'Error al eliminar el diseño: ' . $e->getMessage());
        }
    }

    public function clearTempImage(Request $request)
    {
        try {
            $tempImageData = Session::get('temp_image_data');

            if ($tempImageData && isset($tempImageData['temp_path'])) {
                if (Storage::disk('public')->exists($tempImageData['temp_path'])) {
                    Storage::disk('public')->delete($tempImageData['temp_path']);
                }
                Session::forget('temp_image_data');
            }

            return response()->json(['success' => true]);
        } catch (\Exception $e) {
            Log::error('Error al limpiar archivo temporal: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => $e->getMessage()], 500);
        }
    }

    private function processTempImage($design, $tempImageData)
    {
        try {
            if ($tempImageData && isset($tempImageData['temp_path'])) {
                $tempPath = $tempImageData['temp_path'];

                if (Storage::disk('public')->exists($tempPath)) {
                    $originalName = $tempImageData['original_name'];
                    $detectedType = $tempImageData['detected_type'];
                    $correctExtension = $tempImageData['correct_extension'] ?? $tempImageData['original_extension'];

                    if ($detectedType === 'image' || $detectedType === 'vector') {
                        // Mover archivo a ubicación permanente
                        $fileName = Str::slug(pathinfo($originalName, PATHINFO_FILENAME)) . '_' . time() . '_' . Str::random(8) . '.' . $correctExtension;
                        $newPath = 'designs/images/' . $fileName;

                        Storage::disk('public')->move($tempPath, $newPath);

                        // Crear registro de imagen
                        Image::create([
                            'file_path' => $newPath,
                            'alt_text' => $design->name,
                            'is_primary' => true,
                            'order' => 0,
                            'imageable_type' => 'App\Models\Design',
                            'imageable_id' => $design->id,
                        ]);

                        // Actualizar diseño
                        $design->update([
                            'file_type' => $detectedType,
                            'file_extension' => $correctExtension,
                            'original_filename' => $originalName,
                        ]);

                        Log::info('Archivo temporal procesado y guardado en: ' . $newPath);
                    }
                }
            }
        } catch (\Exception $e) {
            Log::error('Error al procesar imagen temporal: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/ProductController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\StoreProductRequest;
use App\Http\Requests\UpdateProductRequest;
use App\Models\Attribute;
use App\Models\AttributeValue;
use App\Models\Category;
use App\Models\Design;
use App\Models\DesignExport;
use App\Models\Product;
use App\Models\ProductCategory;
use App\Models\ProductExtra;
use App\Models\ProductVariant;
use App\Services\ProductService;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\ValidationException;
use Illuminate\Support\Facades\Auth;
use App\Models\Application_types;
use App\Models\MaterialVariant;
use App\Models\Material;

class ProductController extends Controller
{
    protected ProductService $productService;

    public function __construct(ProductService $productService)
    {
        $this->productService = $productService;
    }

    /*
    |--------------------------------------------------------------------------
    | INDEX
    |--------------------------------------------------------------------------
    */

    public function index(Request $request)
    {
        try {
            $validated = $request->validate([
                'category' => ['nullable', 'integer', 'min:1'],
                'status' => ['nullable', 'string', 'in:active,draft,discontinued'],
                'search' => ['nullable', 'string', 'max:100'],
            ]);

            $query = Product::with([
                'category',
                'extras',
                'variants.attributes.attribute',
                'variants.designExports',
                'designs',
            ])->orderBy('created_at', 'desc');

            // Filtro por categoría
            if (!empty($validated['category'])) {
                $query->where('product_category_id', (int) $validated['category']);
            }

            // Filtro por estado
            if (!empty($validated['status'])) {
                $query->where('status', $validated['status']);
            }

            // Búsqueda
            if (!empty($validated['search'])) {
                $search = strip_tags(trim($validated['search']));
                $query->where(function ($q) use ($search) {
                    $q->where('name', 'like', "%{$search}%")
                        ->orWhere('sku', 'like', "%{$search}%")
                        ->orWhere('description', 'like', "%{$search}%");
                });
            }

            $products = $query->paginate(10)->withQueryString();

            $categories = ProductCategory::active()->ordered()->get();

            return view('admin.products.index', compact('products', 'categories'));
        } catch (\Exception $e) {
            Log::error('Error al listar productos: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
            ]);

            return view('admin.products.index', [
                'products' => collect(),
                'categories' => collect(),
            ])->with('error', 'Error al cargar los productos');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create()
    {
        try {
            // 1. Validar categorías
            $categories = ProductCategory::active()->ordered()->get();
            if ($categories->isEmpty()) {
                return redirect()->route('product_categories.create')
                    ->with('info', 'Debe crear al menos una categoría antes de continuar.');
            }

            // 2. Carga de Insumos y Configuración
            $extras = ProductExtra::ordered()->get();
            $designs = Design::with(['categories', 'generalExports'])->orderBy('name')->get();
            $applicationTypes = Application_types::where('activo', true)->orderBy('nombre_aplicacion')->get();

            // 3. Atributos
            $sizeAttribute = Attribute::with('values')->where('slug', 'talla')->first();
            $colorAttribute = Attribute::with('values')->where('slug', 'color')->first();

            // 4. NUEVO: Materiales para la Fase 3 (Optimizado)
            // Solo traemos lo estrictamente necesario para el selector
            /*  $materials = MaterialVariant::with(['material.category.baseUnit']) 
                ->where('activo', true)
                ->get()
                ->map(function ($variant) {
                    return [
                        'id'            => $variant->id,
                        'text'          => $variant->sku . ' - ' . ($variant->color ?? 'Sin Color'),
                        'full_name'     => $variant->display_name, // Suponiendo que tienes este accessor
                        'stock'         => (float) $variant->current_stock,
                        'unit_symbol'   => $variant->material->category->baseUnit->symbol ?? 'unid',
                        'average_cost'  => (float) $variant->average_cost,
                    ];
                });*/

            // 4. Materiales (Familias) - Esto alimenta el primer Select
            $materials = Material::where('activo', true)
                ->orderBy('name')
                ->get(['id', 'name']); // Solo necesitamos el ID y Nombre de la familia



            return view('admin.products.create', compact(
                'categories',
                'extras',
                'designs',
                'applicationTypes',
                'sizeAttribute',
                'colorAttribute',
                'materials'
            ));
        } catch (\Exception $e) {
            Log::error("Product Create Error [Line {$e->getLine()}]: " . $e->getMessage(), [
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString()
            ]);
            return redirect()->route('admin.products.index')
                ->with('error', 'Error interno al cargar el formulario de creación.');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(StoreProductRequest $request)
    {
        try {
            $validated = $request->validated();

            $product = $this->productService->createProduct($validated);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Producto '{$product->name}' creado exitosamente");
        } catch (\Exception $e) {
            Log::error('Error al crear producto: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.products.create')
                ->withInput()
                ->with('error', 'Error al crear el producto. Intente nuevamente.');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | SHOW
    |--------------------------------------------------------------------------
    */

    public function show($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::with([
                'category',
                'extras',
                'designs.category',
                'variants.attributes.attribute',
                'variants.designExports.designVariant',
                'images',
            ])->findOrFail((int) $id);

            return view('admin.products.show', compact('product'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al mostrar producto: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al cargar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::with([
                'category',
                'extras',
                'designs',
                'variants.attributes',
            ])->findOrFail((int) $id);

            $categories = ProductCategory::active()->ordered()->get();
            $extras = ProductExtra::ordered()->get();
            $designs = Design::with('category')->orderBy('name')->get();
            $applicationTypes = Application_types::where('activo', true)->orderBy('nombre')->get();
            $attributes = Attribute::with('values')->orderBy('name')->get();

            return view('admin.products.edit', compact(
                'product',
                'categories',
                'extras',
                'designs',
                'applicationTypes',
                'attributes'
            ));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cargar producto para editar: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al cargar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(UpdateProductRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::findOrFail((int) $id);
            $validated = $request->validated();

            $product = $this->productService->updateProduct($product, $validated);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Producto '{$product->name}' actualizado exitosamente");
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al actualizar producto: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.edit', $id)
                ->withInput()
                ->with('error', 'Error al actualizar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM DELETE
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::with(['category', 'variants', 'designs', 'extras'])
                ->findOrFail((int) $id);

            return view('admin.products.delete', compact('product'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cargar confirmación de eliminación: ' . $e->getMessage());

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al procesar la solicitud');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DESTROY
    |--------------------------------------------------------------------------
    */

    public function destroy($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::findOrFail((int) $id);
            $productName = $product->name;

            $this->productService->deleteProduct($product);

            return redirect()->route('admin.products.index')
                ->with('success', "Producto '{$productName}' eliminado exitosamente");
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al eliminar producto: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al eliminar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DUPLICATE
    |--------------------------------------------------------------------------
    */

    public function duplicate($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::findOrFail((int) $id);
            $newProduct = $this->productService->duplicateProduct($product);

            return redirect()->route('admin.products.edit', $newProduct->id)
                ->with('success', "Producto duplicado exitosamente. Modifique los datos necesarios.");
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al duplicar producto: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al duplicar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | TOGGLE STATUS
    |--------------------------------------------------------------------------
    */

    public function toggleStatus($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->back()->with('error', 'Producto no válido');
            }

            $product = Product::findOrFail((int) $id);

            if ($product->status === 'active') {
                $product->discontinue();
                $message = "Producto '{$product->name}' marcado como descontinuado";
            } else {
                $product->activate();
                $message = "Producto '{$product->name}' activado exitosamente";
            }

            return redirect()->back()->with('success', $message);
        } catch (ModelNotFoundException $e) {
            return redirect()->back()->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cambiar estado del producto: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Error al cambiar el estado');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | VARIANTES
    |--------------------------------------------------------------------------
    */

    public function createVariant($productId)
    {
        try {
            $product = Product::with(['category', 'designs'])->findOrFail((int) $productId);
            $attributes = Attribute::with('values')->orderBy('name')->get();
            $applicationTypes = Application_types::where('activo', true)->orderBy('nombre')->get();

            // Obtener design exports de los diseños asignados
            $designExports = DesignExport::whereIn('design_id', $product->designs->pluck('id'))
                ->orWhereHas('designVariant', function ($q) use ($product) {
                    $q->whereIn('design_id', $product->designs->pluck('id'));
                })
                ->with(['design', 'designVariant'])
                ->get();

            return view('admin.products.variants.create', compact(
                'product',
                'attributes',
                'applicationTypes',
                'designExports'
            ));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de variante: ' . $e->getMessage());
            return redirect()->route('admin.products.show', $productId)
                ->with('error', 'Error al cargar el formulario');
        }
    }

    public function storeVariant(Request $request, $productId)
    {
        try {
            $product = Product::findOrFail((int) $productId);

            $validated = $request->validate([
                'sku_variant' => [
                    'required',
                    'string',
                    'max:100',
                    'regex:/^[A-Z0-9\-\_]+$/u',
                    'unique:product_variants,sku_variant',
                ],
                'price' => ['required', 'numeric', 'min:0', 'max:9999999.99'],
                'stock_alert' => ['nullable', 'integer', 'min:0', 'max:9999'],
                'attribute_values' => ['nullable', 'array'],
                'design_exports' => ['nullable', 'array'],
            ]);

            $variant = $this->productService->createVariant($product, $validated);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Variante '{$variant->sku_variant}' creada exitosamente");
        } catch (ValidationException $e) {
            return redirect()->back()->withInput()->withErrors($e->errors());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al crear variante: ' . $e->getMessage());
            return redirect()->back()->withInput()
                ->with('error', 'Error al crear la variante');
        }
    }

    public function editVariant($productId, $variantId)
    {
        try {
            $product = Product::findOrFail((int) $productId);
            $variant = ProductVariant::with(['attributes.attribute', 'designExports'])
                ->where('product_id', $product->id)
                ->findOrFail((int) $variantId);

            $attributes = Attribute::with('values')->orderBy('name')->get();
            $applicationTypes = Application_types::where('activo', true)->orderBy('nombre')->get();

            $designExports = DesignExport::whereIn('design_id', $product->designs->pluck('id'))
                ->orWhereHas('designVariant', function ($q) use ($product) {
                    $q->whereIn('design_id', $product->designs->pluck('id'));
                })
                ->with(['design', 'designVariant'])
                ->get();

            return view('admin.products.variants.edit', compact(
                'product',
                'variant',
                'attributes',
                'applicationTypes',
                'designExports'
            ));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto o variante no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cargar variante para editar: ' . $e->getMessage());
            return redirect()->route('admin.products.show', $productId)
                ->with('error', 'Error al cargar la variante');
        }
    }

    public function updateVariant(Request $request, $productId, $variantId)
    {
        try {
            $product = Product::findOrFail((int) $productId);
            $variant = ProductVariant::where('product_id', $product->id)
                ->findOrFail((int) $variantId);

            $validated = $request->validate([
                'sku_variant' => [
                    'required',
                    'string',
                    'max:100',
                    'regex:/^[A-Z0-9\-\_]+$/u',
                    "unique:product_variants,sku_variant,{$variantId}",
                ],
                'price' => ['required', 'numeric', 'min:0', 'max:9999999.99'],
                'stock_alert' => ['nullable', 'integer', 'min:0', 'max:9999'],
                'attribute_values' => ['nullable', 'array'],
                'design_exports' => ['nullable', 'array'],
            ]);

            $variant = $this->productService->updateVariant($variant, $validated);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Variante '{$variant->sku_variant}' actualizada exitosamente");
        } catch (ValidationException $e) {
            return redirect()->back()->withInput()->withErrors($e->errors());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto o variante no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al actualizar variante: ' . $e->getMessage());
            return redirect()->back()->withInput()
                ->with('error', 'Error al actualizar la variante');
        }
    }

    public function destroyVariant($productId, $variantId)
    {
        try {
            $product = Product::findOrFail((int) $productId);
            $variant = ProductVariant::where('product_id', $product->id)
                ->findOrFail((int) $variantId);

            $skuVariant = $variant->sku_variant;
            $this->productService->deleteVariant($variant);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Variante '{$skuVariant}' eliminada exitosamente");
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto o variante no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al eliminar variante: ' . $e->getMessage());
            return redirect()->route('admin.products.show', $productId)
                ->with('error', 'Error al eliminar la variante');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX ENDPOINTS
    |--------------------------------------------------------------------------
    */

    public function getDesignsByCategory($categoryId)
    {
        try {
            $designs = Design::whereHas('categories', function ($q) use ($categoryId) {
                $q->where('categories.id', (int) $categoryId);
            })->orderBy('name')->get(['id', 'name', 'code', 'stitch_count']);

            return response()->json($designs);
        } catch (\Exception $e) {
            return response()->json(['error' => 'Error al obtener diseños'], 500);
        }
    }

    public function getDesignExports($designId)
    {
        try {
            $exports = DesignExport::where('design_id', (int) $designId)
                ->orWhereHas('designVariant', function ($q) use ($designId) {
                    $q->where('design_id', (int) $designId);
                })
                ->with(['design', 'designVariant', 'format'])
                ->get();

            return response()->json($exports);
        } catch (\Exception $e) {
            return response()->json(['error' => 'Error al obtener exportaciones'], 500);
        }
    }

    public function getAttributes()
    {
        try {
            $attributes = Attribute::with('values')->orderBy('name')->get();
            return response()->json($attributes);
        } catch (\Exception $e) {
            return response()->json(['error' => 'Error al obtener atributos'], 500);
        }
    }

    /**
     * Buscar materiales para el selector (API)
     */
    public function searchMaterials(Request $request)
    {
        $term = $request->get('q');

        $materials = MaterialVariant::with(['material', 'material.category', 'material.category.baseUnit'])
            ->whereHas('material', function ($q) use ($term) {
                $q->where('name', 'like', "%{$term}%");
            })
            ->orWhere('sku', 'like', "%{$term}%")
            ->orWhere('color', 'like', "%{$term}%")
            ->limit(20)
            ->get();

        $results = $materials->map(function ($variant) {
            $unitSymbol = $variant->material->category->baseUnit->symbol ?? '';
            return [
                'id' => $variant->id,
                'text' => $variant->display_name . " (Stock: {$variant->current_stock} {$unitSymbol})",
                'sku' => $variant->sku,
                'unit' => $variant->material->category->baseUnit->name ?? 'Unidad',
                'symbol' => $unitSymbol,
                'cost' => $variant->average_cost > 0 ? $variant->average_cost : $variant->last_purchase_cost,
                'stock' => $variant->current_stock
            ];
        });

        return response()->json(['results' => $results]);
    }
}
</file>

<file path="app/Http/Controllers/ProveedorController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Proveedor;
use App\Models\Estado;
use App\Models\Giro;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class ProveedorController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $proveedores = Proveedor::where('activo', true)->with('estado', 'giro')->get();
        return view('admin.proveedores.index', compact('proveedores'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        $estados = Estado::all();
        $giros = Giro::all();
        return view('admin.proveedores.create', compact('estados', 'giros'));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        // dd($request->all());
        $request->validate([
            'nombre_proveedor' => ['required', 'string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.\,]+$/'],
            'giro_id' =>  ['required', 'exists:giros,id'],
            'direccion' =>  ['string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.\#]+$/', 'nullable'],
            'codigo_postal' => ['string', 'max:255', 'regex:/^[0-9]{5}$/', 'nullable'],
            'telefono' => ['required', 'string', 'max:255', 'regex:/^[0-9]{10}$/'],
            'email' => ['email', 'string', 'max:255', 'nullable'],
            'estado_id' => ['required', 'exists:estados,id'],
            'ciudad' => ['string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.]+$/', 'nullable'],
            'nombre_contacto' => ['string', 'max:255', 'regex:/^[a-zA-Z\sñÑáéíóúÁÉÍÓÚ\.]+$/', 'nullable'],
            'telefono_contacto' => ['string', 'max:255', 'regex:/^[0-9]{10}$/', 'nullable'],
            'email_contacto' => ['email', 'string', 'max:255', 'nullable'],
        ]);
        try {
            $proveedor = new Proveedor();
            $proveedor->nombre_proveedor = strtoupper(trim($request->nombre_proveedor));
            $proveedor->giro_id = $request->giro_id;
            $proveedor->direccion = strtoupper(trim($request->direccion));
            $proveedor->codigo_postal = $request->codigo_postal;
            $proveedor->telefono = $request->telefono;
            $proveedor->email = $request->email;
            $proveedor->estado_id = $request->estado_id;
            $proveedor->ciudad = strtoupper(trim($request->ciudad));
            $proveedor->nombre_contacto = strtoupper(trim($request->nombre_contacto));
            $proveedor->telefono_contacto = $request->telefono_contacto;
            $proveedor->email_contacto = $request->email_contacto;
            $proveedor->save();
            return redirect()->route('admin.proveedores.index')->with('success', 'Proveedor creado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al crear el proveedor: ' . $e->getMessage());
            return redirect()->route('admin.proveedores.index')->with('error', 'Error al crear el proveedor');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Proveedor $proveedor)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $proveedor = Proveedor::where('activo', true)->with('estado', 'giro')->findOrFail($id);
        $estados = Estado::all();
        $giros = Giro::all();
        return view('admin.proveedores.edit', compact('proveedor', 'estados', 'giros'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_proveedor' => ['required', 'string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.\,]+$/'],
            'giro_id' =>  ['required', 'exists:giros,id'],
            'direccion' =>  ['string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.\#]+$/', 'nullable'],
            'codigo_postal' => ['string', 'max:255', 'regex:/^[0-9]{5}$/', 'nullable'],
            'telefono' => ['required', 'string', 'max:255', 'regex:/^[0-9]{10}$/'],
            'email' => ['email', 'string', 'max:255', 'nullable'],
            'estado_id' => ['required', 'exists:estados,id'],
            'ciudad' => ['string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.]+$/', 'nullable'],
            'nombre_contacto' => ['string', 'max:255', 'regex:/^[a-zA-Z\sñÑáéíóúÁÉÍÓÚ\.]+$/', 'nullable'],
            'telefono_contacto' => ['string', 'max:255', 'regex:/^[0-9]{10}$/', 'nullable'],
            'email_contacto' => ['email', 'string', 'max:255', 'nullable'],
        ]);

        $proveedor = Proveedor::where('activo', true)->with('estado', 'giro')->findOrFail($id);

        try {

            $proveedor->nombre_proveedor = strtoupper(trim($request->nombre_proveedor));
            $proveedor->giro_id = $request->giro_id;
            $proveedor->direccion = strtoupper(trim($request->direccion));
            $proveedor->codigo_postal = $request->codigo_postal;
            $proveedor->telefono = $request->telefono;
            $proveedor->email = $request->email;
            $proveedor->estado_id = $request->estado_id;
            $proveedor->ciudad = strtoupper(trim($request->ciudad));
            $proveedor->nombre_contacto = strtoupper(trim($request->nombre_contacto));
            $proveedor->telefono_contacto = $request->telefono_contacto;
            $proveedor->email_contacto = $request->email_contacto;

            if (!$proveedor->isDirty()) {
                return redirect()->route('admin.proveedores.index')->with('info', 'No se realizaron cambios');
            }

            $proveedor->save();
            return redirect()->route('admin.proveedores.index')->with('success', 'Proveedor actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el proveedor: ' . $e->getMessage());
            return redirect()->route('admin.proveedores.index')->with('error', 'Error al actualizar el proveedor');
        }
    }

    public function confirm_delete($id)
    {
        $proveedor = Proveedor::where('activo', true)->with('estado', 'giro')->findOrFail($id);
        $estados = Estado::all();
        $giros = Giro::all();
        return view('admin.proveedores.delete', compact('proveedor', 'estados', 'giros'));
    }

    public function destroy($id)
    {
        $proveedor = Proveedor::where('activo', true)->with('estado', 'giro')->findOrFail($id);
        try {
            $proveedor->activo = false;
            $proveedor->save();
            return redirect()->route('admin.proveedores.index')->with('success', 'Proveedor eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el proveedor: ' . $e->getMessage());
            return redirect()->route('admin.proveedores.index')->with('error', 'Error al eliminar el proveedor');
        }
    }
}
</file>

<file path="app/Models/Estado.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Estado extends Model
{
    use HasFactory;
    protected $table = 'estados';
    //protected
    protected $fillable = [
        'nombre_estado',
        'activo',
        'fecha_baja',
        'motivo_baja',
    ];
    public function clientes()
    {
        return $this->hasMany(Cliente::class);
    }
    public function proveedores()
    {
        return $this->hasMany(Proveedor::class);
    }
}
</file>

<file path="app/Models/Proveedor.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class Proveedor extends Model
{
    use HasFactory;
    protected $table = 'proveedors';
    //protected
    protected $fillable = [
        'nombre',
        'tipo_proveedor',
        'direccion',
        'codigo_postal',
        'telefono',
        'email',
        'ciudad',
        'persona_contacto',
        'telefono_contacto',
        'correo_contacto',
        'activo',
        'fecha_baja',
        'motivo_baja',
        'estado_id',
    ];

    public function estado()
    {
        return $this->belongsTo(Estado::class);
    }

    public function giro()
    {
        return $this->belongsTo(Giro::class);
    }
}
</file>

<file path="database/migrations/2025_12_16_175802_create_proveedors_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('proveedors', function (Blueprint $table) {
            $table->id();
            $table->string('nombre_proveedor');

            $table->string('direccion')->nullable();
            $table->string('codigo_postal')->nullable();
            $table->string('telefono')->nullable();
            $table->string('email')->nullable()->unique();
            $table->string('ciudad')->nullable();
            $table->string('nombre_contacto')->nullable();
            $table->string('telefono_contacto')->nullable();
            $table->string('email_contacto')->nullable();

            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->string('motivo_baja')->nullable();
            $table->foreignId('estado_id')->constrained('estados')->restrictOnDelete();
            $table->foreignId('giro_id')->constrained('giros')->restrictOnDelete();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('proveedors');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="routes/web.php">
<?php

use Illuminate\Support\Facades\Route;
use Illuminate\Support\Facades\Auth;


// Ruta raíz
Route::get('/', function () {
    return view('auth.login');
});

// Autenticación
Auth::routes([
    'register' => false,
]);

// Home
Route::get('/home', [App\Http\Controllers\HomeController::class, 'index'])
    ->name('home')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE DISEÑOS
|--------------------------------------------------------------------------
*/

Route::get('admin/designs', [App\Http\Controllers\DesignController::class, 'index'])
    ->name('admin.designs.index')
    ->middleware('auth');

// AJAX: Listado de diseños sin reload (para Web App)
Route::get('admin/designs/ajax-list', [App\Http\Controllers\DesignController::class, 'ajaxList'])
    ->name('admin.designs.ajax-list')
    ->middleware('auth');

Route::get('admin/designs/create', [App\Http\Controllers\DesignController::class, 'create'])
    ->name('admin.designs.create')
    ->middleware('auth');

// Ruta para limpiar imagen temporal
Route::post('admin/designs/clear-temp-image', [App\Http\Controllers\DesignController::class, 'clearTempImage'])
    ->name('admin.designs.clear-temp-image')
    ->middleware('auth');

Route::middleware(['secure.file.upload'])->group(function () {
    Route::post('admin/designs', [App\Http\Controllers\DesignController::class, 'store'])
        ->name('admin.designs.store')
        ->middleware('auth');
});

Route::get('admin/designs/{design}', [App\Http\Controllers\DesignController::class, 'show'])
    ->name('admin.designs.show')
    ->middleware('auth');

Route::get('admin/designs/{design}/edit', [App\Http\Controllers\DesignController::class, 'edit'])
    ->name('admin.designs.edit')
    ->middleware('auth');

Route::middleware(['secure.file.upload'])->group(function () {
    Route::put('admin/designs/{design}', [App\Http\Controllers\DesignController::class, 'update'])
        ->name('admin.designs.update')
        ->middleware('auth');
});

Route::delete('admin/designs/{design}', [App\Http\Controllers\DesignController::class, 'destroy'])
    ->name('admin.designs.destroy')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE VARIANTES
|--------------------------------------------------------------------------
*/

Route::get('admin/designs/{design}/variants/create', [App\Http\Controllers\DesignVariantController::class, 'create'])
    ->name('admin.designs.variants.create')
    ->middleware('auth');

Route::post('admin/designs/{design}/variants', [App\Http\Controllers\DesignVariantController::class, 'store'])
    ->name('admin.designs.variants.store')
    ->middleware('auth');

Route::get('admin/designs/{design}/variants/{variant}/edit', [App\Http\Controllers\DesignVariantController::class, 'edit'])
    ->name('admin.designs.variants.edit')
    ->middleware('auth');

Route::put('admin/designs/{design}/variants/{variant}', [App\Http\Controllers\DesignVariantController::class, 'update'])
    ->name('admin.designs.variants.update')
    ->middleware('auth');

Route::delete('admin/designs/{design}/variants/{variant}', [App\Http\Controllers\DesignVariantController::class, 'destroy'])
    ->name('admin.designs.variants.destroy')
    ->middleware('auth');

Route::delete('admin/designs/{design}/variants/{variant}/images/{image}', [App\Http\Controllers\DesignVariantController::class, 'destroyImage'])
    ->name('admin.designs.variants.images.destroy')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE PRODUCCIÓN / EXPORTACIONES
|--------------------------------------------------------------------------
*/

// Módulo independiente "Producción" (menú lateral)
Route::get('admin/production', [App\Http\Controllers\DesignExportController::class, 'index'])
    ->name('admin.production.index')
    ->middleware('auth');

Route::get('admin/production/create', [App\Http\Controllers\DesignExportController::class, 'create'])
    ->name('admin.production.create')
    ->middleware('auth');

Route::post('admin/production', [App\Http\Controllers\DesignExportController::class, 'store'])
    ->name('admin.production.store')
    ->middleware('auth');

Route::get('admin/production/{export}', [App\Http\Controllers\DesignExportController::class, 'show'])
    ->name('admin.production.show')
    ->middleware('auth');

Route::get('admin/production/{export}/edit', [App\Http\Controllers\DesignExportController::class, 'edit'])
    ->name('admin.production.edit')
    ->middleware('auth');

Route::get('admin/production/{export}/download', [App\Http\Controllers\DesignExportController::class, 'download'])
    ->name('admin.production.download')
    ->middleware('auth');

Route::put('admin/production/{export}', [App\Http\Controllers\DesignExportController::class, 'update'])
    ->name('admin.production.update')
    ->middleware('auth');

Route::delete('admin/production/{export}', [App\Http\Controllers\DesignExportController::class, 'destroy'])
    ->name('admin.production.destroy')
    ->middleware('auth');

// Exportaciones para un diseño específico (sin variante)
Route::get('admin/designs/{design}/exports', [App\Http\Controllers\DesignExportController::class, 'forDesign'])
    ->name('admin.designs.exports.index')
    ->middleware('auth');

Route::get('admin/designs/{design}/exports/create', [App\Http\Controllers\DesignExportController::class, 'createForDesign'])
    ->name('admin.designs.exports.create')
    ->middleware('auth');

Route::post('admin/designs/{design}/exports', [App\Http\Controllers\DesignExportController::class, 'storeForDesign'])
    ->name('admin.designs.exports.store')
    ->middleware('auth');

// Exportaciones para una variante específica
Route::get('admin/designs/{design}/variants/{variant}/exports/create', [App\Http\Controllers\DesignExportController::class, 'createForVariant'])
    ->name('admin.variants.exports.create')
    ->middleware('auth');

Route::post('admin/designs/{design}/variants/{variant}/exports', [App\Http\Controllers\DesignExportController::class, 'storeForVariant'])
    ->name('admin.variants.exports.store')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS AJAX PARA EXPORTACIONES (MODAL)
|--------------------------------------------------------------------------
*/

// Analizar archivo de bordado (PyEmbroidery)
Route::post('admin/exports/analyze', [App\Http\Controllers\DesignExportController::class, 'analyzeFile'])
    ->name('admin.exports.analyze')
    ->middleware('auth');

// Guardar exportación via AJAX (desde modal)
Route::post('admin/exports/store-ajax', [App\Http\Controllers\DesignExportController::class, 'storeAjax'])
    ->name('admin.exports.store-ajax')
    ->middleware('auth');

// ⭐ ACTUALIZAR EXPORTACIÓN VIA AJAX - PUT
Route::put('admin/exports/{export}/update-ajax', [App\Http\Controllers\DesignExportController::class, 'updateAjax'])
    ->name('admin.exports.update-ajax')
    ->middleware('auth');

// ⭐ ACTUALIZAR EXPORTACIÓN VIA AJAX - POST (para compatibilidad con _method)
Route::post('admin/exports/{export}/update-ajax', [App\Http\Controllers\DesignExportController::class, 'updateAjax'])
    ->name('admin.exports.update-ajax-post')
    ->middleware('auth');

// ⭐ ACTUALIZAR ESTADO DE EXPORTACIÓN VIA AJAX
Route::post('admin/exports/{export}/status', [App\Http\Controllers\DesignExportController::class, 'updateStatus'])
    ->name('admin.exports.update-status')
    ->middleware('auth');

// Obtener exportación específica via AJAX
Route::get('admin/exports/{export}/ajax', [App\Http\Controllers\DesignExportController::class, 'getExport'])
    ->name('admin.exports.get-ajax')
    ->middleware('auth');

// Eliminar exportación via AJAX
Route::delete('admin/exports/{export}/ajax', [App\Http\Controllers\DesignExportController::class, 'destroyAjax'])
    ->name('admin.exports.destroy-ajax')
    ->middleware('auth');

// Obtener tipos de aplicación
Route::get('admin/exports/application-types', [App\Http\Controllers\DesignExportController::class, 'getApplicationTypes'])
    ->name('admin.exports.application-types')
    ->middleware('auth');

// Obtener extensiones permitidas
Route::get('admin/exports/allowed-extensions', [App\Http\Controllers\DesignExportController::class, 'getAllowedExtensions'])
    ->name('admin.exports.allowed-extensions')
    ->middleware('auth');

// Obtener exportaciones de diseño (AJAX para modal)
Route::get('admin/designs/{design}/exports/ajax', [App\Http\Controllers\DesignExportController::class, 'getDesignExports'])
    ->name('admin.designs.exports.ajax')
    ->middleware('auth');

// Obtener exportaciones de variante (AJAX para modal)
Route::get('admin/designs/{design}/variants/{variant}/exports/ajax', [App\Http\Controllers\DesignExportController::class, 'getVariantExports'])
    ->name('admin.designs.variants.exports.ajax')
    ->middleware('auth');

// ⭐ NUEVO: Obtener TODAS las exportaciones de un diseño agrupadas por variante
Route::get('admin/designs/{design}/exports-grouped', [App\Http\Controllers\DesignExportController::class, 'getAllDesignExportsGrouped'])
    ->name('admin.designs.exports-grouped')
    ->middleware('auth');

// ⭐ CONTADOR DE EXPORTACIONES (para actualizar cards en tiempo real)
Route::get('admin/designs/{design}/exports-count', [App\Http\Controllers\DesignExportController::class, 'getExportsCount'])
    ->name('admin.designs.exports-count')
    ->middleware('auth');

// ⭐ CONTADOR DE EXPORTACIONES SIN IMAGE_ID (para badge de imagen principal del diseño)
Route::get('admin/designs/{design}/exports-without-image-count', [App\Http\Controllers\DesignExportController::class, 'getExportsWithoutImageCount'])
    ->name('admin.designs.exports-without-image-count')
    ->middleware('auth');

// ⭐ CONTADOR DE EXPORTACIONES POR IMAGEN (para badges en galería)
Route::get('admin/images/{image}/exports-count', [App\Http\Controllers\DesignExportController::class, 'getImageExportsCount'])
    ->name('admin.images.exports-count')
    ->middleware('auth');

// ⭐ CONTADORES BATCH DE EXPORTACIONES (múltiples imágenes en una sola petición)
Route::post('admin/images/exports-counts-batch', [App\Http\Controllers\DesignExportController::class, 'getImagesExportsCounts'])
    ->name('admin.images.exports-counts-batch')
    ->middleware('auth');

// ⭐ OBTENER EXPORTACIONES POR IMAGEN
Route::get('admin/images/{image}/exports', [App\Http\Controllers\DesignExportController::class, 'getImageExports'])
    ->name('admin.images.exports')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE CATEGORÍAS
|--------------------------------------------------------------------------
*/
Route::get('admin/categories', [App\Http\Controllers\CategoryController::class, 'index'])
    ->name('admin.categories.index')
    ->middleware('auth');

Route::get('admin/categories/create', [App\Http\Controllers\CategoryController::class, 'create'])
    ->name('admin.categories.create')
    ->middleware('auth');

Route::post('admin/categories', [App\Http\Controllers\CategoryController::class, 'store'])
    ->name('admin.categories.store')
    ->middleware('auth');

Route::get('admin/categories/{category}', [App\Http\Controllers\CategoryController::class, 'show'])
    ->name('admin.categories.show')
    ->middleware('auth');

Route::get('admin/categories/{category}/edit', [App\Http\Controllers\CategoryController::class, 'edit'])
    ->name('admin.categories.edit')
    ->middleware('auth');

Route::put('admin/categories/{category}', [App\Http\Controllers\CategoryController::class, 'update'])
    ->name('admin.categories.update')
    ->middleware('auth');

Route::delete('admin/categories/{category}', [App\Http\Controllers\CategoryController::class, 'destroy'])
    ->name('admin.categories.destroy')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE BÚSQUEDA
|--------------------------------------------------------------------------
*/

Route::get('admin/search', [App\Http\Controllers\SearchController::class, 'index'])
    ->name('admin.search.index')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS ANTIGUAS (MANTENER SI ESTÁN EN USO)
|--------------------------------------------------------------------------
*/

// Giros
Route::get('/giros', [App\Http\Controllers\GiroController::class, 'index'])
    ->name('admin.giros.index')
    ->middleware('auth');
Route::get('/giros/nuevo', [App\Http\Controllers\GiroController::class, 'create'])
    ->name('admin.giros.create')
    ->middleware('auth');
Route::post('/giros/create', [App\Http\Controllers\GiroController::class, 'store'])
    ->name('admin.giros.store')
    ->middleware('auth');
Route::get('/giros/edit/{id}', [App\Http\Controllers\GiroController::class, 'edit'])
    ->name('admin.giros.edit')
    ->middleware('auth');
Route::put('/giros/edit/{id}', [App\Http\Controllers\GiroController::class, 'update'])
    ->name('admin.giros.update')
    ->middleware('auth');
Route::get('/giros/confirm_delete/{id}', [App\Http\Controllers\GiroController::class, 'confirm_delete'])
    ->name('admin.giros.confirm_delete')
    ->middleware('auth');
Route::delete('/giros/delete/{id}', [App\Http\Controllers\GiroController::class, 'destroy'])
    ->name('admin.giros.destroy')
    ->middleware('auth');

// Estados
Route::get('/estados', [App\Http\Controllers\EstadoController::class, 'index'])
    ->name('admin.estados.index')
    ->middleware('auth');
Route::get('/estados/nuevo', [App\Http\Controllers\EstadoController::class, 'create'])
    ->name('admin.estados.create')
    ->middleware('auth');
Route::post('/estados/create', [App\Http\Controllers\EstadoController::class, 'store'])
    ->name('admin.estados.store')
    ->middleware('auth');
Route::get('/estados/edit/{id}', [App\Http\Controllers\EstadoController::class, 'edit'])
    ->name('admin.estados.edit')
    ->middleware('auth');
Route::put('/estados/edit/{id}', [App\Http\Controllers\EstadoController::class, 'update'])
    ->name('admin.estados.update')
    ->middleware('auth');
Route::get('/estados/confirm_delete/{id}', [App\Http\Controllers\EstadoController::class, 'confirm_delete'])
    ->name('admin.estados.confirm_delete')
    ->middleware('auth');
Route::delete('/estados/delete/{id}', [App\Http\Controllers\EstadoController::class, 'destroy'])
    ->name('admin.estados.destroy')
    ->middleware('auth');

//Category
Route::get('/categorias', [App\Http\Controllers\CategoryController::class, 'index'])
    ->name('admin.categorias.index')
    ->middleware('auth');
Route::get('/categorias/nuevo', [App\Http\Controllers\CategoryController::class, 'create'])
    ->name('admin.categorias.create')
    ->middleware('auth');
Route::post('/categorias/create', [App\Http\Controllers\CategoryController::class, 'store'])
    ->name('admin.categorias.store')
    ->middleware('auth');
Route::get('/categorias/edit/{category}', [App\Http\Controllers\CategoryController::class, 'edit'])
    ->name('admin.categorias.edit')
    ->middleware('auth');

Route::put('/categorias/edit/{category}', [App\Http\Controllers\CategoryController::class, 'update'])
    ->name('admin.categorias.update')
    ->middleware('auth');
Route::get('/categorias/confirm_delete/{category}', [App\Http\Controllers\CategoryController::class, 'confirm_delete'])
    ->name('admin.categorias.confirm_delete')
    ->middleware('auth');
Route::delete('/categorias/delete/{category}', [App\Http\Controllers\CategoryController::class, 'destroy'])
    ->name('admin.categorias.destroy')
    ->middleware('auth');

// Proveedores
Route::get('/proveedores', [App\Http\Controllers\ProveedorController::class, 'index'])
    ->name('admin.proveedores.index')
    ->middleware('auth');
Route::get('/proveedores/nuevo', [App\Http\Controllers\ProveedorController::class, 'create'])
    ->name('admin.proveedores.create')
    ->middleware('auth');
Route::post('/proveedores/create', [App\Http\Controllers\ProveedorController::class, 'store'])
    ->name('admin.proveedores.store')
    ->middleware('auth');
Route::get('/proveedores/edit/{id}', [App\Http\Controllers\ProveedorController::class, 'edit'])
    ->name('admin.proveedores.edit')
    ->middleware('auth');
Route::put('/proveedores/edit/{id}', [App\Http\Controllers\ProveedorController::class, 'update'])
    ->name('admin.proveedores.update')
    ->middleware('auth');
Route::get('/proveedores/confirm_delete/{id}', [App\Http\Controllers\ProveedorController::class, 'confirm_delete'])
    ->name('admin.proveedores.confirm_delete')
    ->middleware('auth');
Route::delete('/proveedores/delete/{id}', [App\Http\Controllers\ProveedorController::class, 'destroy'])
    ->name('admin.proveedores.destroy')
    ->middleware('auth');

// Recomendaciones
Route::get('/recomendaciones', [App\Http\Controllers\RecomendacionController::class, 'index'])
    ->name('admin.recomendaciones.index')
    ->middleware('auth');
Route::get('/recomendaciones/nuevo', [App\Http\Controllers\RecomendacionController::class, 'create'])
    ->name('admin.recomendaciones.create')
    ->middleware('auth');
Route::post('/recomendaciones/create', [App\Http\Controllers\RecomendacionController::class, 'store'])
    ->name('admin.recomendaciones.store')
    ->middleware('auth');
Route::get('/recomendaciones/edit/{id}', [App\Http\Controllers\RecomendacionController::class, 'edit'])
    ->name('admin.recomendaciones.edit')
    ->middleware('auth');
Route::put('/recomendaciones/edit/{id}', [App\Http\Controllers\RecomendacionController::class, 'update'])
    ->name('admin.recomendaciones.update')
    ->middleware('auth');
Route::get('/recomendaciones/confirm_delete/{id}', [App\Http\Controllers\RecomendacionController::class, 'confirm_delete'])
    ->name('admin.recomendaciones.confirm_delete')
    ->middleware('auth');
Route::delete('/recomendaciones/delete/{id}', [App\Http\Controllers\RecomendacionController::class, 'destroy'])
    ->name('admin.recomendaciones.destroy')
    ->middleware('auth');

// Clientes
Route::get('/clientes', [App\Http\Controllers\ClienteController::class, 'index'])
    ->name('admin.clientes.index')
    ->middleware('auth');
Route::get('/clientes/nuevo', [App\Http\Controllers\ClienteController::class, 'create'])
    ->name('admin.clientes.create')
    ->middleware('auth');
Route::post('/clientes/create', [App\Http\Controllers\ClienteController::class, 'store'])
    ->name('admin.clientes.store')
    ->middleware('auth');
Route::get('/clientes/edit/{id}', [App\Http\Controllers\ClienteController::class, 'edit'])
    ->name('admin.clientes.edit')
    ->middleware('auth');
Route::put('/clientes/edit/{id}', [App\Http\Controllers\ClienteController::class, 'update'])
    ->name('admin.clientes.update')
    ->middleware('auth');
Route::get('/clientes/confirm_delete/{id}', [App\Http\Controllers\ClienteController::class, 'confirm_delete'])
    ->name('admin.clientes.confirm_delete')
    ->middleware('auth');
Route::delete('/clientes/delete/{id}', [App\Http\Controllers\ClienteController::class, 'destroy'])
    ->name('admin.clientes.destroy')
    ->middleware('auth');

// Tipos de aplicacion
Route::get('/tipos_aplicacion', [App\Http\Controllers\ApplicationTypesController::class, 'index'])
    ->name('admin.tipos_aplicacion.index')
    ->middleware('auth');

Route::get('/tipos_aplicacion/nuevo', [App\Http\Controllers\ApplicationTypesController::class, 'create'])
    ->name('admin.tipos_aplicacion.create')
    ->middleware('auth');

Route::post('/tipos_aplicacion/guardar', [App\Http\Controllers\ApplicationTypesController::class, 'store'])
    ->name('admin.tipos_aplicacion.store')
    ->middleware('auth');

Route::get('/tipos_aplicacion/editar/{id}', [App\Http\Controllers\ApplicationTypesController::class, 'edit'])
    ->name('admin.tipos_aplicacion.edit')
    ->middleware('auth');

Route::put('/tipos_aplicacion/actualizar/{id}', [App\Http\Controllers\ApplicationTypesController::class, 'update'])
    ->name('admin.tipos_aplicacion.update')
    ->middleware('auth');

Route::get('/tipos_aplicacion/confirmar-eliminacion/{id}', [App\Http\Controllers\ApplicationTypesController::class, 'confirm_delete'])
    ->name('admin.tipos_aplicacion.confirm_delete')
    ->middleware('auth');

Route::delete('/tipos_aplicacion/eliminar/{id}', [App\Http\Controllers\ApplicationTypesController::class, 'destroy'])
    ->name('admin.tipos_aplicacion.destroy')
    ->middleware('auth');

// Búsqueda AJAX
Route::middleware(['auth'])->prefix('admin')->group(function () {
    Route::get('search/ajax', [App\Http\Controllers\SearchController::class, 'searchAjax'])
        ->name('admin.search.ajax');

    Route::get('search/autocomplete', [App\Http\Controllers\SearchController::class, 'autocomplete'])
        ->name('admin.search.autocomplete');
});

//rutas produccion
Route::group(['prefix' => 'produccion', 'as' => 'admin.produccion.', 'middleware' => ['auth']], function () {
    Route::get('/', [App\Http\Controllers\ProduccionController::class, 'index'])->name('index');
    Route::get('/nuevo', [App\Http\Controllers\ProduccionController::class, 'create'])->name('create');
    Route::post('/', [App\Http\Controllers\ProduccionController::class, 'store'])->name('store');
    Route::get('/{id}', [App\Http\Controllers\ProduccionController::class, 'show'])->name('show');
    Route::get('/{id}/editar', [App\Http\Controllers\ProduccionController::class, 'edit'])->name('edit');
    Route::put('/{id}', [App\Http\Controllers\ProduccionController::class, 'update'])->name('update');
    Route::delete('/{id}', [App\Http\Controllers\ProduccionController::class, 'destroy'])->name('destroy');

    // Acciones de estado
    Route::post('/{id}/solicitar', [App\Http\Controllers\ProduccionController::class, 'requestApproval'])->name('request');
    Route::post('/{id}/aprobar', [App\Http\Controllers\ProduccionController::class, 'approve'])->name('approve');
    Route::post('/{id}/archivar', [App\Http\Controllers\ProduccionController::class, 'archive'])->name('archive');
    Route::post('/{id}/revertir', [App\Http\Controllers\ProduccionController::class, 'revert'])->name('revert');
    Route::post('/{id}/restaurar', [App\Http\Controllers\ProduccionController::class, 'restore'])->name('restore');

    // Nueva ruta para vista previa SVG (On-demand y Cacheada)
    Route::get('/{export}/preview', [App\Http\Controllers\DesignPreviewController::class, 'preview'])->name('preview');
});



/*
|--------------------------------------------------------------------------
| RUTAS DE SISTEMA (CONFIGURACIÓN, LOGS, UNIDADES)
|--------------------------------------------------------------------------
*/

// Settings (Configuración del Sistema)
Route::get('admin/settings', [App\Http\Controllers\SystemSettingController::class, 'index'])
    ->name('settings.index')
    ->middleware('auth');

Route::get('admin/settings/create', [App\Http\Controllers\SystemSettingController::class, 'create'])
    ->name('settings.create')
    ->middleware('auth');

Route::post('admin/settings', [App\Http\Controllers\SystemSettingController::class, 'store'])
    ->name('settings.store')
    ->middleware('auth');

Route::get('admin/settings/{setting}', [App\Http\Controllers\SystemSettingController::class, 'show'])
    ->name('settings.show')
    ->middleware('auth');

Route::get('admin/settings/{setting}/edit', [App\Http\Controllers\SystemSettingController::class, 'edit'])
    ->name('settings.edit')
    ->middleware('auth');

Route::put('admin/settings/{setting}', [App\Http\Controllers\SystemSettingController::class, 'update'])
    ->name('settings.update')
    ->middleware('auth');

Route::delete('admin/settings/{setting}', [App\Http\Controllers\SystemSettingController::class, 'destroy'])
    ->name('settings.destroy')
    ->middleware('auth');

// Activity Logs (Registro de Actividad)
Route::get('admin/activity-logs', [App\Http\Controllers\ActivityLogController::class, 'index'])
    ->name('activity-logs.index')
    ->middleware('auth');

Route::get('admin/activity-logs/{activityLog}', [App\Http\Controllers\ActivityLogController::class, 'show'])
    ->name('activity-logs.show')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| Unidades de Medida
|--------------------------------------------------------------------------
| Rutas para la gestión completa de unidades de medida del sistema.
| Incluye CRUD completo, cambio de estado, restauración y eliminación permanente.
|--------------------------------------------------------------------------
*/
/*
|--------------------------------------------------------------------------
| RUTAS DE UNIDADES DE MEDIDA
|--------------------------------------------------------------------------
*/

Route::get('/units', [App\Http\Controllers\UnitController::class, 'index'])
    ->name('units.index')
    ->middleware('auth');

Route::get('/units/create', [App\Http\Controllers\UnitController::class, 'create'])
    ->name('units.create')
    ->middleware('auth');

Route::post('/units', [App\Http\Controllers\UnitController::class, 'store'])
    ->name('units.store')
    ->middleware('auth');

Route::get('/units/{id}/edit', [App\Http\Controllers\UnitController::class, 'edit'])
    ->name('units.edit')
    ->middleware('auth');

Route::put('/units/{id}', [App\Http\Controllers\UnitController::class, 'update'])
    ->name('units.update')
    ->middleware('auth');

Route::get('/units/{id}/confirm-delete', [App\Http\Controllers\UnitController::class, 'confirmDelete'])
    ->name('units.confirm_delete')
    ->middleware('auth');

Route::delete('/units/{id}', [App\Http\Controllers\UnitController::class, 'destroy'])
    ->name('units.destroy')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE CONFIGURACIÓN DEL SISTEMA
|--------------------------------------------------------------------------
*/

Route::get('/settings', [App\Http\Controllers\SystemSettingController::class, 'index'])
    ->name('admin.settings.index')
    ->middleware('auth');

Route::put('/settings', [App\Http\Controllers\SystemSettingController::class, 'update'])
    ->name('admin.settings.update')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE REGISTRO DE ACTIVIDAD
|--------------------------------------------------------------------------
*/

Route::get('/activity-logs', [App\Http\Controllers\ActivityLogController::class, 'index'])
    ->name('activity-logs.index')
    ->middleware('auth');

// Cambiamos {id} por {uuid} para ser semánticamente correctos
Route::get('/activity-logs/{uuid}', [App\Http\Controllers\ActivityLogController::class, 'show'])
    ->name('activity-logs.show')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE CATEGORÍAS DE MATERIALES
|--------------------------------------------------------------------------
*/

Route::get('/material-categories', [App\Http\Controllers\MaterialCategoryController::class, 'index'])
    ->name('material-categories.index')
    ->middleware('auth');

Route::get('/material-categories/create', [App\Http\Controllers\MaterialCategoryController::class, 'create'])
    ->name('material-categories.create')
    ->middleware('auth');

Route::post('/material-categories', [App\Http\Controllers\MaterialCategoryController::class, 'store'])
    ->name('material-categories.store')
    ->middleware('auth');

Route::get('/material-categories/{id}/edit', [App\Http\Controllers\MaterialCategoryController::class, 'edit'])
    ->name('material-categories.edit')
    ->middleware('auth');

Route::put('/material-categories/{id}', [App\Http\Controllers\MaterialCategoryController::class, 'update'])
    ->name('material-categories.update')
    ->middleware('auth');

Route::get('/material-categories/{id}/confirm-delete', [App\Http\Controllers\MaterialCategoryController::class, 'confirmDelete'])
    ->name('material-categories.confirm_delete')
    ->middleware('auth');

Route::delete('/material-categories/{id}', [App\Http\Controllers\MaterialCategoryController::class, 'destroy'])
    ->name('material-categories.destroy')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE MATERIALES
|--------------------------------------------------------------------------
*/

Route::get('/materials', [App\Http\Controllers\MaterialController::class, 'index'])
    ->name('materials.index')
    ->middleware('auth');

Route::get('/materials/create', [App\Http\Controllers\MaterialController::class, 'create'])
    ->name('materials.create')
    ->middleware('auth');

Route::post('/materials', [App\Http\Controllers\MaterialController::class, 'store'])
    ->name('materials.store')
    ->middleware('auth');

Route::get('/materials/{id}/edit', [App\Http\Controllers\MaterialController::class, 'edit'])
    ->name('materials.edit')
    ->middleware('auth');

Route::put('/materials/{id}', [App\Http\Controllers\MaterialController::class, 'update'])
    ->name('materials.update')
    ->middleware('auth');

Route::get('/materials/{id}/confirm-delete', [App\Http\Controllers\MaterialController::class, 'confirmDelete'])
    ->name('materials.confirm_delete')
    ->middleware('auth');

Route::delete('/materials/{id}', [App\Http\Controllers\MaterialController::class, 'destroy'])
    ->name('materials.destroy')
    ->middleware('auth');

Route::get('/materials/category/{categoryId}', [App\Http\Controllers\MaterialController::class, 'getByCategory'])
    ->name('materials.by-category')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE VARIANTES DE MATERIALES
|--------------------------------------------------------------------------
*/

Route::get('/materials/{materialId}/variants', [App\Http\Controllers\MaterialVariantController::class, 'index'])
    ->name('material-variants.index')
    ->middleware('auth');

Route::get('/materials/{materialId}/variants/create', [App\Http\Controllers\MaterialVariantController::class, 'create'])
    ->name('material-variants.create')
    ->middleware('auth');

Route::post('/materials/{materialId}/variants', [App\Http\Controllers\MaterialVariantController::class, 'store'])
    ->name('material-variants.store')
    ->middleware('auth');

Route::get('/materials/{materialId}/variants/{id}/edit', [App\Http\Controllers\MaterialVariantController::class, 'edit'])
    ->name('material-variants.edit')
    ->middleware('auth');

Route::put('/materials/{materialId}/variants/{id}', [App\Http\Controllers\MaterialVariantController::class, 'update'])
    ->name('material-variants.update')
    ->middleware('auth');

Route::get('/materials/{materialId}/variants/{id}/confirm-delete', [App\Http\Controllers\MaterialVariantController::class, 'confirmDelete'])
    ->name('material-variants.confirm_delete')
    ->middleware('auth');

Route::delete('/materials/{materialId}/variants/{id}', [App\Http\Controllers\MaterialVariantController::class, 'destroy'])
    ->name('material-variants.destroy')
    ->middleware('auth');

//ajax
Route::get('/materials/{materialId}/variants-json', [App\Http\Controllers\MaterialVariantController::class, 'getByMaterial'])
    ->name('material-variants.by-material')
    ->middleware('auth');

Route::get('/materials/{materialId}/variants-json', [App\Http\Controllers\MaterialVariantController::class, 'getByMaterial2'])
    ->name('material-variants.conversiones')
    ->middleware('auth');
/*
|--------------------------------------------------------------------------
| RUTAS DE CONVERSIONES DE UNIDADES POR MATERIAL
|--------------------------------------------------------------------------
*/

Route::get('/materials/{materialId}/conversions', [App\Http\Controllers\MaterialUnitConversionController::class, 'index'])
    ->name('material-conversions.index')
    ->middleware('auth');

Route::get('/materials/{materialId}/conversions/create', [App\Http\Controllers\MaterialUnitConversionController::class, 'create'])
    ->name('material-conversions.create')
    ->middleware('auth');

Route::post('/materials/{materialId}/conversions', [App\Http\Controllers\MaterialUnitConversionController::class, 'store'])
    ->name('material-conversions.store')
    ->middleware('auth');

Route::get('/materials/{materialId}/conversions/{id}/edit', [App\Http\Controllers\MaterialUnitConversionController::class, 'edit'])
    ->name('material-conversions.edit')
    ->middleware('auth');

Route::put('/materials/{materialId}/conversions/{id}', [App\Http\Controllers\MaterialUnitConversionController::class, 'update'])
    ->name('material-conversions.update')
    ->middleware('auth');

Route::get('/materials/{materialId}/conversions/{id}/confirm-delete', [App\Http\Controllers\MaterialUnitConversionController::class, 'confirmDelete'])
    ->name('material-conversions.confirm_delete')
    ->middleware('auth');

Route::delete('/materials/{materialId}/conversions/{id}', [App\Http\Controllers\MaterialUnitConversionController::class, 'destroy'])
    ->name('material-conversions.destroy')
    ->middleware('auth');

Route::get('/materials/{materialId}/conversion-factor/{fromUnitId}', [App\Http\Controllers\MaterialUnitConversionController::class, 'getConversionFactor'])
    ->name('material-conversions.factor')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE COMPRAS (PURCHASES) - FORMATO EXPLÍCITO
|--------------------------------------------------------------------------
*/

// Listado
Route::get('purchases', [App\Http\Controllers\PurchaseController::class, 'index'])
    ->middleware('auth')
    ->name('admin.purchases.index');

// Crear
Route::get('purchases/create', [App\Http\Controllers\PurchaseController::class, 'create'])
    ->middleware('auth')
    ->name('admin.purchases.create');

Route::post('purchases', [App\Http\Controllers\PurchaseController::class, 'store'])
    ->middleware('auth')
    ->name('admin.purchases.store');

// Ver detalle
Route::get('purchases/{id}', [App\Http\Controllers\PurchaseController::class, 'show'])
    ->middleware('auth')
    ->name('admin.purchases.show')
    ->where('id', '[0-9]+');

// Editar
Route::get('purchases/{id}/edit', [App\Http\Controllers\PurchaseController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.purchases.edit')
    ->where('id', '[0-9]+');

Route::put('purchases/{id}', [App\Http\Controllers\PurchaseController::class, 'update'])
    ->middleware('auth')
    ->name('admin.purchases.update')
    ->where('id', '[0-9]+');

// Confirmar (Borrador → Pendiente)
Route::post('purchases/{id}/confirm', [App\Http\Controllers\PurchaseController::class, 'confirm'])
    ->middleware('auth')
    ->name('admin.purchases.confirm')
    ->where('id', '[0-9]+');

// Recibir mercancía
Route::get('purchases/{id}/receive', [App\Http\Controllers\PurchaseController::class, 'showReceive'])
    ->middleware('auth')
    ->name('admin.purchases.receive')
    ->where('id', '[0-9]+');

Route::post('purchases/{id}/receive', [App\Http\Controllers\PurchaseController::class, 'receive'])
    ->middleware('auth')
    ->name('admin.purchases.receive.store')
    ->where('id', '[0-9]+');

// Cancelar
Route::get('purchases/{id}/cancel', [App\Http\Controllers\PurchaseController::class, 'showCancel'])
    ->middleware('auth')
    ->name('admin.purchases.cancel')
    ->where('id', '[0-9]+');

Route::post('purchases/{id}/cancel', [App\Http\Controllers\PurchaseController::class, 'cancel'])
    ->middleware('auth')
    ->name('admin.purchases.cancel.store')
    ->where('id', '[0-9]+');

// Eliminar (solo borradores)
Route::get('purchases/{id}/confirm-delete', [App\Http\Controllers\PurchaseController::class, 'confirmDelete'])
    ->middleware('auth')
    ->name('admin.purchases.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('purchases/{id}', [App\Http\Controllers\PurchaseController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.purchases.destroy')
    ->where('id', '[0-9]+');

// AJAX Endpoints
Route::get('purchases/ajax/materials/{categoryId}', [App\Http\Controllers\PurchaseController::class, 'getMaterialsByCategory'])
    ->middleware('auth')
    ->name('admin.purchases.ajax.materials')
    ->where('categoryId', '[0-9]+');

Route::get('purchases/ajax/variants/{materialId}', [App\Http\Controllers\PurchaseController::class, 'getVariantsByMaterial'])
    ->middleware('auth')
    ->name('admin.purchases.ajax.variants')
    ->where('materialId', '[0-9]+');

Route::get('purchases/ajax/units/{materialId}', [App\Http\Controllers\PurchaseController::class, 'getUnitsForMaterial'])
    ->middleware('auth')
    ->name('admin.purchases.ajax.units')
    ->where('materialId', '[0-9]+');
// Anular recepción
Route::post('purchases/{id}/receptions/{receptionId}/void', [App\Http\Controllers\PurchaseController::class, 'voidReception'])
    ->middleware('auth')
    ->name('admin.purchases.receptions.void')
    ->where(['id' => '[0-9]+', 'receptionId' => '[0-9]+']);

// Recalcular estado de compra
Route::post('purchases/{id}/recalculate-status', [App\Http\Controllers\PurchaseController::class, 'recalculateStatus'])
    ->middleware('auth')
    ->name('admin.purchases.recalculate')
    ->where('id', '[0-9]+');



/*
|--------------------------------------------------------------------------
| RUTAS DE PRODUCTOS (Explícitas)
|--------------------------------------------------------------------------
*/

//rutas productos
Route::get('/gestion-productos', [App\Http\Controllers\ProductController::class, 'index'])
    ->name('admin.productos.index')
    ->middleware(['auth']);

// Listado principal
Route::get('productos', [App\Http\Controllers\ProductController::class, 'index'])
    ->middleware('auth')
    ->name('admin.products.index');

// Crear producto
Route::get('productos/create', [App\Http\Controllers\ProductController::class, 'create'])
    ->middleware('auth')
    ->name('admin.products.create');

Route::post('productos', [App\Http\Controllers\ProductController::class, 'store'])
    ->middleware('auth')
    ->name('admin.products.store');

// Ver detalle
Route::get('productos/{id}', [App\Http\Controllers\ProductController::class, 'show'])
    ->middleware('auth')
    ->name('admin.products.show')
    ->where('id', '[0-9]+');

// Editar producto
Route::get('productos/{id}/edit', [App\Http\Controllers\ProductController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.products.edit')
    ->where('id', '[0-9]+');

Route::put('productos/{id}', [App\Http\Controllers\ProductController::class, 'update'])
    ->middleware('auth')
    ->name('admin.products.update')
    ->where('id', '[0-9]+');

// Eliminar producto
Route::get('productos/{id}/confirm-delete', [App\Http\Controllers\ProductController::class, 'confirmDelete'])
    ->middleware('auth')
    ->name('admin.products.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('productos/{id}', [App\Http\Controllers\ProductController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.products.destroy')
    ->where('id', '[0-9]+');

// Operaciones adicionales
Route::post('productos/{id}/duplicate', [App\Http\Controllers\ProductController::class, 'duplicate'])
    ->middleware('auth')
    ->name('admin.products.duplicate')
    ->where('id', '[0-9]+');

Route::post('productos/{id}/toggle-status', [App\Http\Controllers\ProductController::class, 'toggleStatus'])
    ->middleware('auth')
    ->name('admin.products.toggle_status')
    ->where('id', '[0-9]+');

/*
|--------------------------------------------------------------------------
| VARIANTES DE PRODUCTO
|--------------------------------------------------------------------------
*/

Route::get('productos/{productId}/variants/create', [App\Http\Controllers\ProductController::class, 'createVariant'])
    ->middleware('auth')
    ->name('admin.products.variants.create')
    ->where('productId', '[0-9]+');

Route::post('productos/{productId}/variants', [App\Http\Controllers\ProductController::class, 'storeVariant'])
    ->middleware('auth')
    ->name('admin.products.variants.store')
    ->where('productId', '[0-9]+');

Route::get('productos/{productId}/variants/{variantId}/edit', [App\Http\Controllers\ProductController::class, 'editVariant'])
    ->middleware('auth')
    ->name('admin.products.variants.edit')
    ->where(['productId' => '[0-9]+', 'variantId' => '[0-9]+']);

Route::put('productos/{productId}/variants/{variantId}', [App\Http\Controllers\ProductController::class, 'updateVariant'])
    ->middleware('auth')
    ->name('admin.products.variants.update')
    ->where(['productId' => '[0-9]+', 'variantId' => '[0-9]+']);

Route::delete('productos/{productId}/variants/{variantId}', [App\Http\Controllers\ProductController::class, 'destroyVariant'])
    ->middleware('auth')
    ->name('admin.products.variants.destroy')
    ->where(['productId' => '[0-9]+', 'variantId' => '[0-9]+']);

/*
|--------------------------------------------------------------------------
| AJAX ENDPOINTS PRODUCTOS
|--------------------------------------------------------------------------
*/

Route::get('productos/ajax/designs-by-category/{categoryId}', [App\Http\Controllers\ProductController::class, 'getDesignsByCategory'])
    ->middleware('auth')
    ->name('admin.products.ajax.designs')
    ->where('categoryId', '[0-9]+');

Route::get('productos/ajax/design-exports/{designId}', [App\Http\Controllers\ProductController::class, 'getDesignExports'])
    ->middleware('auth')
    ->name('admin.products.ajax.exports')
    ->where('designId', '[0-9]+');

Route::get('productos/ajax/attributes', [App\Http\Controllers\ProductController::class, 'getAttributes'])
    ->middleware('auth')
    ->name('admin.products.ajax.attributes');

Route::get('productos/ajax/search-materials', [App\Http\Controllers\ProductController::class, 'searchMaterials'])
    ->middleware('auth')
    ->name('admin.products.ajax.search_materials');

/*
|--------------------------------------------------------------------------
| CATEGORÍAS DE PRODUCTOS
|--------------------------------------------------------------------------
*/

Route::get('product-categories', [App\Http\Controllers\ProductCategoryController::class, 'index'])
    ->middleware('auth')
    ->name('admin.product_categories.index');

Route::get('product-categories/create', [App\Http\Controllers\ProductCategoryController::class, 'create'])
    ->middleware('auth')
    ->name('admin.product_categories.create');

Route::post('product-categories', [App\Http\Controllers\ProductCategoryController::class, 'store'])
    ->middleware('auth')
    ->name('admin.product_categories.store');

Route::get('product-categories/{id}/edit', [App\Http\Controllers\ProductCategoryController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.product_categories.edit')
    ->where('id', '[0-9]+');

Route::put('product-categories/{id}', [App\Http\Controllers\ProductCategoryController::class, 'update'])
    ->middleware('auth')
    ->name('admin.product_categories.update')
    ->where('id', '[0-9]+');

Route::get('product-categories/{id}/confirm-delete', [App\Http\Controllers\ProductCategoryController::class, 'confirmDelete'])
    ->middleware('auth')
    ->name('admin.product_categories.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('product-categories/{id}', [App\Http\Controllers\ProductCategoryController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.product_categories.destroy')
    ->where('id', '[0-9]+');

/*
|--------------------------------------------------------------------------
| EXTRAS DE PRODUCTOS
|--------------------------------------------------------------------------
*/

Route::get('product-extras', [App\Http\Controllers\ProductExtraController::class, 'index'])
    ->middleware('auth')
    ->name('admin.product_extras.index');

Route::get('product-extras/create', [App\Http\Controllers\ProductExtraController::class, 'create'])
    ->middleware('auth')
    ->name('admin.product_extras.create');

Route::post('product-extras', [App\Http\Controllers\ProductExtraController::class, 'store'])
    ->middleware('auth')
    ->name('admin.product_extras.store');

Route::get('product-extras/{id}/edit', [App\Http\Controllers\ProductExtraController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.product_extras.edit')
    ->where('id', '[0-9]+');

Route::put('product-extras/{id}', [App\Http\Controllers\ProductExtraController::class, 'update'])
    ->middleware('auth')
    ->name('admin.product_extras.update')
    ->where('id', '[0-9]+');

Route::delete('product-extras/{id}', [App\Http\Controllers\ProductExtraController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.product_extras.destroy')
    ->where('id', '[0-9]+');

/*
|--------------------------------------------------------------------------
| RUTAS DE ATRIBUTOS
|--------------------------------------------------------------------------
*/

Route::get('attributes', [App\Http\Controllers\AttributeController::class, 'index'])
    ->middleware('auth')
    ->name('admin.attributes.index');

Route::get('attributes/create', [App\Http\Controllers\AttributeController::class, 'create'])
    ->middleware('auth')
    ->name('admin.attributes.create');

Route::post('attributes', [App\Http\Controllers\AttributeController::class, 'store'])
    ->middleware('auth')
    ->name('admin.attributes.store');

Route::get('attributes/{id}/edit', [App\Http\Controllers\AttributeController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.attributes.edit')
    ->where('id', '[0-9]+');

Route::put('attributes/{id}', [App\Http\Controllers\AttributeController::class, 'update'])
    ->middleware('auth')
    ->name('admin.attributes.update')
    ->where('id', '[0-9]+');

Route::get('attributes/{id}/confirm-delete', [App\Http\Controllers\AttributeController::class, 'confirm_delete'])
    ->middleware('auth')
    ->name('admin.attributes.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('attributes/{id}', [App\Http\Controllers\AttributeController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.attributes.destroy')
    ->where('id', '[0-9]+');

/*
|--------------------------------------------------------------------------
| RUTAS DE VALORES DE ATRIBUTOS
|--------------------------------------------------------------------------
*/

Route::get('attribute-values', [App\Http\Controllers\AttributeValueController::class, 'index'])
    ->middleware('auth')
    ->name('admin.attribute-values.index');

Route::get('attribute-values/create', [App\Http\Controllers\AttributeValueController::class, 'create'])
    ->middleware('auth')
    ->name('admin.attribute-values.create');

Route::post('attribute-values', [App\Http\Controllers\AttributeValueController::class, 'store'])
    ->middleware('auth')
    ->name('admin.attribute-values.store');

Route::get('attribute-values/{id}/edit', [App\Http\Controllers\AttributeValueController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.attribute-values.edit')
    ->where('id', '[0-9]+');

Route::put('attribute-values/{id}', [App\Http\Controllers\AttributeValueController::class, 'update'])
    ->middleware('auth')
    ->name('admin.attribute-values.update')
    ->where('id', '[0-9]+');

Route::get('attribute-values/{id}/confirm-delete', [App\Http\Controllers\AttributeValueController::class, 'confirm_delete'])
    ->middleware('auth')
    ->name('admin.attribute-values.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('attribute-values/{id}', [App\Http\Controllers\AttributeValueController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.attribute-values.destroy')
    ->where('id', '[0-9]+');

// AJAX endpoint para obtener tipo de atributo (para color picker dinámico)
Route::get('attribute-values/get-type/{attributeId}', [App\Http\Controllers\AttributeValueController::class, 'getAttributeType'])
    ->middleware('auth')
    ->name('admin.attribute-values.get-type')
    ->where('attributeId', '[0-9]+');
</file>

</files>
