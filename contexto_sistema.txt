This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: app/Models/**, app/Http/Controllers/**, database/migrations/**, resources/views/**, routes/web.php
- Files matching these patterns are excluded: **/User.php, **/create_users_table.php, **/create_failed_jobs_table.php, **/create_personal_access_tokens_table.php, **/create_password_resets_table.php, **/auth/**, **/vendor/**, **/storage/**, **/Controller.php
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/Http/Controllers/ActivityLogController.php
app/Http/Controllers/ApplicationTypesController.php
app/Http/Controllers/AttributeController.php
app/Http/Controllers/AttributeValueController.php
app/Http/Controllers/Auth/ConfirmPasswordController.php
app/Http/Controllers/Auth/ForgotPasswordController.php
app/Http/Controllers/Auth/LoginController.php
app/Http/Controllers/Auth/RegisterController.php
app/Http/Controllers/Auth/ResetPasswordController.php
app/Http/Controllers/Auth/VerificationController.php
app/Http/Controllers/CategoryController.php
app/Http/Controllers/ClienteController.php
app/Http/Controllers/DesignController.php
app/Http/Controllers/DesignExportController.php
app/Http/Controllers/DesignPreviewController.php
app/Http/Controllers/DesignVariantController.php
app/Http/Controllers/EstadoController.php
app/Http/Controllers/GiroController.php
app/Http/Controllers/HomeController.php
app/Http/Controllers/ImageController.php
app/Http/Controllers/InventoryMovementController.php
app/Http/Controllers/MaterialCategoryController.php
app/Http/Controllers/MaterialCategoryUnitController.php
app/Http/Controllers/MaterialController.php
app/Http/Controllers/MaterialUnitConversionController.php
app/Http/Controllers/MaterialVariantController.php
app/Http/Controllers/ProduccionController.php
app/Http/Controllers/ProductCategoryController.php
app/Http/Controllers/ProductController.php
app/Http/Controllers/ProductExtraController.php
app/Http/Controllers/ProductVariantController.php
app/Http/Controllers/ProveedorController.php
app/Http/Controllers/PurchaseController.php
app/Http/Controllers/PurchaseItemController.php
app/Http/Controllers/PurchaseReceptionController.php
app/Http/Controllers/PurchaseReceptionItemController.php
app/Http/Controllers/RecomendacionController.php
app/Http/Controllers/SearchController.php
app/Http/Controllers/SystemSettingController.php
app/Http/Controllers/UnitController.php
app/Http/Controllers/VisualizerController.php
app/Models/ActivityLog.php
app/Models/Application_types.php
app/Models/Attribute.php
app/Models/AttributeValue.php
app/Models/Category.php
app/Models/Cliente.php
app/Models/Design.php
app/Models/DesignExport.php
app/Models/DesignExportStatusHistory.php
app/Models/DesignVariant.php
app/Models/DesignVariantImage.php
app/Models/Estado.php
app/Models/Giro.php
app/Models/Image.php
app/Models/InventoryMovement.php
app/Models/Material.php
app/Models/MaterialCategory.php
app/Models/MaterialUnitConversion.php
app/Models/MaterialVariant.php
app/Models/Product.php
app/Models/ProductCategory.php
app/Models/ProductExtra.php
app/Models/ProductMaterial.php
app/Models/ProductVariant.php
app/Models/Proveedor.php
app/Models/Purchase.php
app/Models/PurchaseItem.php
app/Models/PurchaseReception.php
app/Models/PurchaseReceptionItem.php
app/Models/Recomendacion.php
app/Models/SearchIndex.php
app/Models/SystemSetting.php
app/Models/Unit.php
database/migrations/0001_01_01_000000_create_users_table.php
database/migrations/0001_01_01_000001_create_cache_table.php
database/migrations/0001_01_01_000002_create_jobs_table.php
database/migrations/2025_12_16_174359_create_permission_tables.php
database/migrations/2025_12_16_174450_create_giros_table.php
database/migrations/2025_12_16_174451_create_estados_table.php
database/migrations/2025_12_16_175802_create_proveedors_table.php
database/migrations/2025_12_18_045304_create_recomendacions_table.php
database/migrations/2025_12_18_055620_create_clientes_table.php
database/migrations/2025_12_19_172828_create_categories_table.php
database/migrations/2025_12_19_172849_create_designs_table.php
database/migrations/2025_12_19_172856_create_design_variants_table.php
database/migrations/2025_12_19_172905_create_attributes_table.php
database/migrations/2025_12_19_172911_create_attribute_values_table.php
database/migrations/2025_12_19_172926_create_images_table.php
database/migrations/2025_12_19_172936_create_category_design_table.php
database/migrations/2025_12_19_172942_create_design_variant_attributes_table.php
database/migrations/2025_12_20_150609_create_design_variant_images_table.php
database/migrations/2025_12_24_160930_create_application_types_table.php
database/migrations/2025_12_24_161013_create_design_exports_table.php
database/migrations/2025_12_27_000001_add_image_id_to_design_exports_table.php
database/migrations/2025_12_27_000001_create_search_index_table.php
database/migrations/2025_12_27_153719_add_thumbnail_fields_to_images_table.php
database/migrations/2025_12_30_120441_create_product_categories_table.php
database/migrations/2025_12_30_120458_create_product_extras_table.php
database/migrations/2025_12_30_121830_create_products_table.php
database/migrations/2025_12_30_121919_create_product_design_table.php
database/migrations/2025_12_30_122410_create_product_variants_table.php
database/migrations/2025_12_30_122508_create_product_variant_design_table.php
database/migrations/2025_12_30_122818_create_product_extra_assignment_table.php
database/migrations/2025_12_30_124341_create_product_variant_attribute_table.php
database/migrations/2026_01_02_191615_create_units_table.php
database/migrations/2026_01_03_013052_create_system_settings_table.php
database/migrations/2026_01_03_094357_create_activity_logs_table.php
database/migrations/2026_01_03_102946_create_material_categories.php
database/migrations/2026_01_03_103133_create_materials.php
database/migrations/2026_01_03_103227_create_material_variants.php
database/migrations/2026_01_03_103255_create_material_unit_conversions.php
database/migrations/2026_01_03_142851_add_compatible_base_unit_to_units_table.php
database/migrations/2026_01_03_150526_create_purchases_table.php
database/migrations/2026_01_03_150553_create_purchase_items_table.php
database/migrations/2026_01_03_150625_create_inventory_movements_table.php
database/migrations/2026_01_04_090517_create_purchase_receptions_table.php
database/migrations/2026_01_04_090551_create_purchase_reception_items_table.php
database/migrations/2026_01_05_000000_create_product_materials_table.php
database/migrations/2026_01_07_090609_add_active_for_variants_to_product_materials_table.php
database/migrations/2026_01_07_144024_add_color_fields_to_images_table.php
database/migrations/2026_01_08_083429_create_design_export_status_history_table.php
database/migrations/2026_01_11_192000_add_svg_content_to_design_exports_table.php
database/migrations/2026_01_13_230014_create_material_price_history_table.php
database/migrations/2026_01_14_145627_add_pricing_fields_to_products_table.php
database/migrations/2026_01_16_124902_refactor_material_schema.php
database/migrations/2026_01_16_134950_create_category_unit_table.php
database/migrations/2026_01_16_180000_add_unit_type_to_units_table.php
resources/views/admin/activity-logs/index.blade.php
resources/views/admin/activity-logs/show.blade.php
resources/views/admin/attributes/create.blade.php
resources/views/admin/attributes/delete.blade.php
resources/views/admin/attributes/edit.blade.php
resources/views/admin/attributes/index.blade.php
resources/views/admin/attributes/values/create.blade.php
resources/views/admin/attributes/values/delete.blade.php
resources/views/admin/attributes/values/edit.blade.php
resources/views/admin/categorias/create.blade.php
resources/views/admin/categorias/delete.blade.php
resources/views/admin/categorias/edit.blade.php
resources/views/admin/categorias/index.blade.php
resources/views/admin/clientes/create.blade.php
resources/views/admin/clientes/delete.blade.php
resources/views/admin/clientes/edit.blade.php
resources/views/admin/clientes/index.blade.php
resources/views/admin/clientes/partials/measures.blade.php
resources/views/admin/design-variants/create.blade.php
resources/views/admin/design-variants/edit.blade.php
resources/views/admin/design-variants/exports/create.blade.php
resources/views/admin/design-variants/index.blade.php
resources/views/admin/designs/create.blade.php
resources/views/admin/designs/delete.blade.php
resources/views/admin/designs/edit.blade.php
resources/views/admin/designs/exports/create.blade.php
resources/views/admin/designs/index.blade.php
resources/views/admin/designs/partials/production-tab.blade.php
resources/views/admin/estados/create.blade.php
resources/views/admin/estados/delete.blade.php
resources/views/admin/estados/edit.blade.php
resources/views/admin/estados/index.blade.php
resources/views/admin/giros/create.blade.php
resources/views/admin/giros/delete.blade.php
resources/views/admin/giros/edit.blade.php
resources/views/admin/giros/index.blade.php
resources/views/admin/material-categories/create.blade.php
resources/views/admin/material-categories/delete.blade.php
resources/views/admin/material-categories/edit.blade.php
resources/views/admin/material-categories/index.blade.php
resources/views/admin/material-categories/units.blade.php
resources/views/admin/material-conversions/create.blade.php
resources/views/admin/material-conversions/delete.blade.php
resources/views/admin/material-conversions/edit.blade.php
resources/views/admin/material-conversions/index.blade.php
resources/views/admin/material-variants/create.blade.php
resources/views/admin/material-variants/delete.blade.php
resources/views/admin/material-variants/edit.blade.php
resources/views/admin/material-variants/index.blade.php
resources/views/admin/materials/create.blade.php
resources/views/admin/materials/delete.blade.php
resources/views/admin/materials/edit.blade.php
resources/views/admin/materials/index.blade.php
resources/views/admin/materials/partials/table_rows.blade.php
resources/views/admin/partials/footer.blade.php
resources/views/admin/partials/navbar.blade.php
resources/views/admin/partials/sidebar.blade.php
resources/views/admin/produccion/create.blade.php
resources/views/admin/produccion/edit.blade.php
resources/views/admin/produccion/index.blade.php
resources/views/admin/produccion/preview_explorer.blade.php
resources/views/admin/produccion/show_modal_especificaciones.blade.php
resources/views/admin/produccion/show_modal.blade.php
resources/views/admin/produccion/show.blade.php
resources/views/admin/product_categories/create.blade.php
resources/views/admin/product_categories/delete.blade.php
resources/views/admin/product_categories/edit.blade.php
resources/views/admin/product_categories/index.blade.php
resources/views/admin/product_extras/create.blade.php
resources/views/admin/product_extras/delete.blade.php
resources/views/admin/product_extras/edit.blade.php
resources/views/admin/product_extras/index.blade.php
resources/views/admin/products/create.blade.php
resources/views/admin/products/delete.blade.php
resources/views/admin/products/edit.blade.php
resources/views/admin/products/index.blade.php
resources/views/admin/products/show.blade.php
resources/views/admin/proveedores/create.blade.php
resources/views/admin/proveedores/delete.blade.php
resources/views/admin/proveedores/edit.blade.php
resources/views/admin/proveedores/index.blade.php
resources/views/admin/purchases/cancel.blade.php
resources/views/admin/purchases/create.blade.php
resources/views/admin/purchases/delete.blade.php
resources/views/admin/purchases/edit.blade.php
resources/views/admin/purchases/index.blade.php
resources/views/admin/purchases/partials/table_rows.blade.php
resources/views/admin/purchases/receive.blade.php
resources/views/admin/purchases/show.blade.php
resources/views/admin/recomendaciones/create.blade.php
resources/views/admin/recomendaciones/delete.blade.php
resources/views/admin/recomendaciones/edit.blade.php
resources/views/admin/recomendaciones/index.blade.php
resources/views/admin/search/index.blade.php
resources/views/admin/settings/index.blade.php
resources/views/admin/tipos_aplicacion/create.blade.php
resources/views/admin/tipos_aplicacion/delete.blade.php
resources/views/admin/tipos_aplicacion/edit.blade.php
resources/views/admin/tipos_aplicacion/index.blade.php
resources/views/admin/units/_form.blade.php
resources/views/admin/units/create.blade.php
resources/views/admin/units/delete.blade.php
resources/views/admin/units/edit.blade.php
resources/views/admin/units/index.blade.php
resources/views/admin/variants/_form.blade.php
resources/views/admin/variants/create.blade.php
resources/views/admin/variants/edit.blade.php
resources/views/admin/visualizer/index.blade.php
resources/views/components/image-uploader.blade.php
resources/views/home.blade.php
resources/views/layouts/app.blade.php
resources/views/welcome.blade.php
routes/web.php
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/Http/Controllers/ActivityLogController.php">
<?php

namespace App\Http\Controllers;

use App\Models\ActivityLog;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\View\View;
use Illuminate\Http\RedirectResponse;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Exception;

class ActivityLogController extends Controller
{
    private const ALLOWED_ACTIONS = ['created', 'updated', 'deleted', 'restored', 'login', 'logout'];
    private const MAX_PER_PAGE = 50;

    public function __construct(
        private readonly ActivityLog $activityLog
    ) {}

    public function index(Request $request): View
    {
        try {
            $validated = $request->validate([
                'user_id'   => ['nullable', 'integer', 'exists:users,id'],
                'action'    => ['nullable', 'string', 'in:' . implode(',', self::ALLOWED_ACTIONS)],
                'date_from' => ['nullable', 'date', 'date_format:Y-m-d'],
                'date_to'   => ['nullable', 'date', 'date_format:Y-m-d', 'after_or_equal:date_from'],
                'search'    => ['nullable', 'string', 'max:100'],
            ]);

            $query = $this->activityLog->newQuery()
                ->with('user')
                ->latest();

            $query->when($request->filled('user_id'), fn($q) => $q->where('user_id', $validated['user_id']))
                ->when($request->filled('action'), fn($q) => $q->where('action', $validated['action']))
                ->when($request->filled('date_from'), fn($q) => $q->whereDate('created_at', '>=', $validated['date_from']))
                ->when($request->filled('date_to'), fn($q) => $q->whereDate('created_at', '<=', $validated['date_to']));

            if ($request->filled('search')) {
                $search = $validated['search'];
                $query->where(function ($q) use ($search) {
                    $q->where('model_name', 'like', "%{$search}%")
                        ->orWhere('description', 'like', "%{$search}%")
                        ->orWhere('user_name', 'like', "%{$search}%")
                        ->orWhere('ip_address', 'like', "%{$search}%");
                });
            }

            return view('admin.activity-logs.index', [
                'logs'    => $query->paginate(self::MAX_PER_PAGE)->withQueryString(),
                'users'   => User::orderBy('name')->pluck('name', 'id'),
                'actions' => self::ALLOWED_ACTIONS
            ]);
        } catch (Exception $e) {
            Log::error("Error en ActivityLogController@index: " . $e->getMessage(), [
                'user_id' => Auth::id(),
                'trace'   => $e->getTraceAsString()
            ]);

            return view('admin.activity-logs.index', [
                'logs'    => $this->activityLog->newQuery()->paginate(self::MAX_PER_PAGE),
                'users'   => collect(),
                'actions' => self::ALLOWED_ACTIONS
            ])->with('error', 'Error interno al cargar la auditoría.');
        }
    }

    /**
     * Muestra el detalle de un log específico por UUID.
     */
    public function show(string $uuid): View|RedirectResponse
    {
        try {
            // Buscamos el registro asegurando limpieza del input
            $log = $this->activityLog->where('uuid', trim($uuid))->first();

            if (!$log) {
                Log::warning("Actividad no encontrada: UUID '{$uuid}'", [
                    'ip'      => request()->ip(),
                    'user_id' => Auth::id()
                ]);

                return redirect()->route('activity-logs.index')
                    ->with('error', 'El registro de actividad solicitado no existe.');
            }

            return view('admin.activity-logs.show', compact('log'));
        } catch (Exception $e) {
            Log::error("Fallo crítico en ActivityLogController@show: " . $e->getMessage(), [
                'uuid'    => $uuid,
                'user_id' => Auth::id()
            ]);

            return redirect()->route('activity-logs.index')
                ->with('error', 'Ocurrió un error al procesar la solicitud.');
        }
    }
}
</file>

<file path="app/Http/Controllers/ApplicationTypesController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Application_types;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;

class ApplicationTypesController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $aplication_types = Application_types::all()->where('activo', true);
        return view('admin.tipos_aplicacion.index', compact('aplication_types'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.tipos_aplicacion.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre_aplicacion' => ['required', 'string', 'max:255', 'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/'],
        ]);
        try {
            $aplication_types = new Application_types();
            $aplication_types->nombre_aplicacion = strtoupper(trim($request->nombre_aplicacion));
            $aplication_types->slug = Str::slug($request->nombre_aplicacion);
            $aplication_types->save();
            return redirect()->route('admin.tipos_aplicacion.index')->with('success', 'Tipo de aplicación guardado exitosamente');
        } catch (\Exception $e) {
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Error al guardar el tipo de aplicación: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Application_types $application_types)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $aplication_types = Application_types::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$aplication_types) {
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Tipo de aplicación no encontrado');
        }
        return view('admin.tipos_aplicacion.edit', compact('aplication_types'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_aplicacion' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:application_types,nombre_aplicacion,' . $id,
            ],
        ]);
        try {
            $aplication_types = Application_types::where('id', $id)
                ->where('activo', true)
                ->firstOrFail();
            $aplication_types->nombre_aplicacion = strtoupper(trim($request->nombre_aplicacion));

            //validamos si hubo algun cambio o modificacion en el valor del campo nombre_estado, si no hubo cambios, no se actualiza
            if (! $aplication_types->isDirty()) {
                // return back()->with('info', 'No se realizaron cambios');
                return redirect()->route('admin.tipos_aplicacion.index')->with('info', 'No se realizaron cambios');
            }

            $aplication_types->save();
            return redirect()->route('admin.tipos_aplicacion.index')->with('success', 'Tipo de aplicación actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el tipo de aplicación: ' . $e->getMessage());
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Error al actualizar el tipo de aplicación');
        }
    }

    public function confirm_delete($id)
    {
        //validando que existe el giro
        $aplication_types = Application_types::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$aplication_types) {
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Tipo de aplicación no encontrado');
        }
        return view('admin.tipos_aplicacion.delete', compact('aplication_types'));
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy($id)
    {
        $aplication_types = Application_types::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$aplication_types) {
            return redirect()->route('admin.tipos_aplicacion.confirm_delete', $id)->with('error', 'Tipo de aplicación no encontrado');
        }
        try {
            $aplication_types->activo = false;
            $aplication_types->save();
            return redirect()->route('admin.tipos_aplicacion.index')->with('success', 'Tipo de aplicación eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el tipo de aplicación: ' . $e->getMessage());
            return redirect()->route('admin.tipos_aplicacion.index')->with('error', 'Error al eliminar el tipo de aplicación');
        }
    }
}
</file>

<file path="app/Http/Controllers/Auth/ConfirmPasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\ConfirmsPasswords;

class ConfirmPasswordController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Confirm Password Controller
    |--------------------------------------------------------------------------
    |
    | This controller is responsible for handling password confirmations and
    | uses a simple trait to include the behavior. You're free to explore
    | this trait and override any functions that require customization.
    |
    */

    use ConfirmsPasswords;

    /**
     * Where to redirect users when the intended url fails.
     *
     * @var string
     */
    protected $redirectTo = '/home';

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('auth');
    }
}
</file>

<file path="app/Http/Controllers/Auth/ForgotPasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\SendsPasswordResetEmails;

class ForgotPasswordController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Password Reset Controller
    |--------------------------------------------------------------------------
    |
    | This controller is responsible for handling password reset emails and
    | includes a trait which assists in sending these notifications from
    | your application to your users. Feel free to explore this trait.
    |
    */

    use SendsPasswordResetEmails;
}
</file>

<file path="app/Http/Controllers/Auth/LoginController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\AuthenticatesUsers;

class LoginController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Login Controller
    |--------------------------------------------------------------------------
    |
    | This controller handles authenticating users for the application and
    | redirecting them to your home screen. The controller uses a trait
    | to conveniently provide its functionality to your applications.
    |
    */

    use AuthenticatesUsers;

    /**
     * Where to redirect users after login.
     *
     * @var string
     */
    protected $redirectTo = '/home';

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('guest')->except('logout');
        $this->middleware('auth')->only('logout');
    }
}
</file>

<file path="app/Http/Controllers/Auth/RegisterController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Foundation\Auth\RegistersUsers;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Validator;

class RegisterController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Register Controller
    |--------------------------------------------------------------------------
    |
    | This controller handles the registration of new users as well as their
    | validation and creation. By default this controller uses a trait to
    | provide this functionality without requiring any additional code.
    |
    */

    use RegistersUsers;

    /**
     * Where to redirect users after registration.
     *
     * @var string
     */
    protected $redirectTo = '/home';

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('guest');
    }

    /**
     * Get a validator for an incoming registration request.
     *
     * @param  array  $data
     * @return \Illuminate\Contracts\Validation\Validator
     */
    protected function validator(array $data)
    {
        return Validator::make($data, [
            'name' => ['required', 'string', 'max:255'],
            'email' => ['required', 'string', 'email', 'max:255', 'unique:users'],
            'password' => ['required', 'string', 'min:8', 'confirmed'],
        ]);
    }

    /**
     * Create a new user instance after a valid registration.
     *
     * @param  array  $data
     * @return \App\Models\User
     */
    protected function create(array $data)
    {
        return User::create([
            'name' => $data['name'],
            'email' => $data['email'],
            'password' => Hash::make($data['password']),
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Auth/ResetPasswordController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\ResetsPasswords;

class ResetPasswordController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Password Reset Controller
    |--------------------------------------------------------------------------
    |
    | This controller is responsible for handling password reset requests
    | and uses a simple trait to include this behavior. You're free to
    | explore this trait and override any methods you wish to tweak.
    |
    */

    use ResetsPasswords;

    /**
     * Where to redirect users after resetting their password.
     *
     * @var string
     */
    protected $redirectTo = '/home';
}
</file>

<file path="app/Http/Controllers/Auth/VerificationController.php">
<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Foundation\Auth\VerifiesEmails;

class VerificationController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | Email Verification Controller
    |--------------------------------------------------------------------------
    |
    | This controller is responsible for handling email verification for any
    | user that recently registered with the application. Emails may also
    | be re-sent if the user didn't receive the original email message.
    |
    */

    use VerifiesEmails;

    /**
     * Where to redirect users after verification.
     *
     * @var string
     */
    protected $redirectTo = '/home';

    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('auth');
        $this->middleware('signed')->only('verify');
        $this->middleware('throttle:6,1')->only('verify', 'resend');
    }
}
</file>

<file path="app/Http/Controllers/DesignPreviewController.php">
<?php

namespace App\Http\Controllers;

use App\Models\DesignExport;
use App\Services\EmbroideryAnalyzerService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;

class DesignPreviewController extends Controller
{
    protected EmbroideryAnalyzerService $analyzer;

    public function __construct(EmbroideryAnalyzerService $analyzer)
    {
        $this->analyzer = $analyzer;
    }

    /**
     * Retorna la vista previa SVG de una exportación de diseño.
     * Utiliza cache para evitar ejecuciones repetidas de Python.
     */
    public function preview(Request $request, DesignExport $export)
    {
        // El cache se basa en el ID de la exportación y la fecha de actualización
        // para asegurar que si el archivo cambia, la vista previa se regenere.
        // v2: Agregado viewBox ajustado y padding.
        $cacheKey = "embroidery_preview_svg_v2_{$export->id}_{$export->updated_at->timestamp}";

        try {
            $svgContent = Cache::remember($cacheKey, now()->addDays(7), function () use ($export) {
                if (!$export->file_path || !Storage::disk('public')->exists($export->file_path)) {
                    return null;
                }

                $fullPath = Storage::disk('public')->path($export->file_path);

                Log::info("Generando preview SVG para exportación #{$export->id}");
                return $this->analyzer->generateSvg($fullPath);
            });

            if (!$svgContent) {
                return response()->json(['error' => 'No se pudo generar la vista previa'], 404);
            }

            // --- Soporte Especial para Explorador Interactivo ---

            // 1. Si se solicita descarga
            if ($request->has('download')) {
                return response($svgContent, 200)
                    ->header('Content-Type', 'image/svg+xml')
                    ->header('Content-Disposition', 'attachment; filename="diseno_' . $export->id . '.svg"');
            }

            // 2. DetecciÃ³n de Explorador (PÃ¡gina con herramientas)
            // Se activa si tiene ?explorer=1 o si es una navegaciÃ³n directa del navegador (Sec-Fetch-Dest: document)
            $fetchDest = $request->header('Sec-Fetch-Dest');
            $isDirectVisit = ($fetchDest === 'document') || ($request->has('explorer'));

            if ($isDirectVisit && !$request->ajax()) {
                return view('admin.produccion.preview_explorer', [
                    'export' => $export,
                    'svgContent' => $svgContent
                ]);
            }

            // 3. Respuesta estÃ¡ndar: Imagen SVG pura (para tags <img>)
            return response($svgContent, 200)
                ->header('Content-Type', 'image/svg+xml')
                ->header('Cache-Control', 'public, max-age=604800, immutable'); // Cache del navegador por 7 dÃ­as

        } catch (\Exception $e) {
            Log::error("Error en DesignPreviewController: " . $e->getMessage());
            return response()->json(['error' => 'Error interno al procesar la vista previa'], 500);
        }
    }
}
</file>

<file path="app/Http/Controllers/HomeController.php">
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class HomeController extends Controller
{
    /**
     * Create a new controller instance.
     *
     * @return void
     */
    public function __construct()
    {
        $this->middleware('auth');
    }

    /**
     * Show the application dashboard.
     *
     * @return \Illuminate\Contracts\Support\Renderable
     */
    public function index()
    {
        return view('home');
    }
}
</file>

<file path="app/Http/Controllers/InventoryMovementController.php">
<?php

namespace App\Http\Controllers;

use App\Models\InventoryMovement;
use Illuminate\Http\Request;

class InventoryMovementController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(InventoryMovement $inventoryMovement)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(InventoryMovement $inventoryMovement)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, InventoryMovement $inventoryMovement)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(InventoryMovement $inventoryMovement)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/MaterialCategoryUnitController.php">
<?php

namespace App\Http\Controllers;

use App\Models\MaterialCategory;
use App\Models\Material;
use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;

/**
 * =============================================================================
 * CONTROLADOR DE GESTIÓN: CATEGORÍA ↔ UNIDADES PERMITIDAS
 * =============================================================================
 *
 * Módulo administrativo para configurar qué unidades de compra/empaque
 * están permitidas para cada categoría de material.
 *
 * REGLAS DE NEGOCIO:
 * - Solo unidades con is_base = false (compra/empaque) pueden asignarse
 * - Cada categoría debe tener al menos 1 unidad asignada para permitir materiales
 * - No se puede eliminar una unidad si hay materiales usándola como base
 *
 * @see \App\Models\MaterialCategory::allowedUnits()
 * @see \App\Http\Requests\MaterialRequest (validación cruzada)
 */
class MaterialCategoryUnitController extends Controller
{
    /**
     * Mostrar listado de categorías con sus unidades asignadas.
     * Vista principal del módulo administrativo.
     */
    public function index()
    {
        try {
            // Categorías activas con conteo de unidades y materiales
            $categories = MaterialCategory::where('activo', true)
                ->with(['allowedUnits' => fn($q) => $q->orderBy('name')])
                ->withCount(['materials' => fn($q) => $q->where('activo', true)])
                ->ordered()
                ->get();

            // Unidades disponibles para asignar (solo logísticas puras)
            $availableUnits = Unit::active()
                ->logistic() // unit_type = 'logistic'
                ->ordered()
                ->get();

            return view('admin.material-categories.units', compact('categories', 'availableUnits'));
        } catch (\Exception $e) {
            Log::error('Error al cargar gestión de unidades por categoría: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return redirect()->route('admin.material-categories.index')
                ->with('error', 'Error al cargar la configuración de unidades');
        }
    }

    /**
     * Agregar una unidad a una categoría.
     * Validaciones:
     * - La unidad debe ser de tipo compra (is_base = false)
     * - No debe existir ya la relación
     */
    public function store(Request $request, $categoryId)
    {
        try {
            // Validación básica
            $request->validate([
                'unit_id' => 'required|integer|min:1|exists:units,id',
            ], [
                'unit_id.required' => 'Debe seleccionar una unidad.',
                'unit_id.exists' => 'La unidad seleccionada no existe.',
            ]);

            $category = MaterialCategory::where('activo', true)->findOrFail($categoryId);
            $unit = Unit::where('activo', true)->findOrFail($request->unit_id);

            // VALIDACIÓN CRÍTICA: Solo unidades logísticas puras
            if (!$unit->isLogistic()) {
                $typeLabel = $unit->unit_type?->label() ?? 'desconocido';
                return response()->json([
                    'success' => false,
                    'message' => "Solo se permiten unidades logísticas de compra. La unidad seleccionada es de tipo: {$typeLabel}."
                ], 422);
            }

            // Verificar si ya existe la relación
            if ($category->allowedUnits()->where('unit_id', $unit->id)->exists()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Esta unidad ya está asignada a la categoría.'
                ], 422);
            }

            DB::beginTransaction();

            $category->allowedUnits()->attach($unit->id);

            DB::commit();

            Log::info('Unidad asignada a categoría', [
                'category_id' => $category->id,
                'category_name' => $category->name,
                'unit_id' => $unit->id,
                'unit_name' => $unit->name,
                'user_id' => Auth::id(),
            ]);

            return response()->json([
                'success' => true,
                'message' => "Unidad '{$unit->name}' asignada correctamente.",
                'unit' => [
                    'id' => $unit->id,
                    'name' => $unit->name,
                    'symbol' => $unit->symbol,
                ]
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Categoría o unidad no encontrada.'
            ], 404);
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al asignar unidad a categoría: ' . $e->getMessage(), [
                'category_id' => $categoryId,
                'unit_id' => $request->unit_id ?? null,
                'user_id' => Auth::id(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error al asignar la unidad.'
            ], 500);
        }
    }

    /**
     * Eliminar una unidad de una categoría.
     * Validaciones:
     * - No se puede eliminar si hay materiales activos usando esta unidad como base
     * - Se recomienda mantener al menos 1 unidad por categoría
     */
    public function destroy(Request $request, $categoryId, $unitId)
    {
        try {
            $category = MaterialCategory::where('activo', true)->findOrFail($categoryId);
            $unit = Unit::findOrFail($unitId);

            // VALIDACIÓN CRÍTICA: Verificar si hay materiales usando esta unidad
            $materialsUsingUnit = Material::where('material_category_id', $categoryId)
                ->where('base_unit_id', $unitId)
                ->where('activo', true)
                ->count();

            if ($materialsUsingUnit > 0) {
                return response()->json([
                    'success' => false,
                    'message' => "No se puede eliminar: {$materialsUsingUnit} material(es) activo(s) usan esta unidad como base.",
                    'materials_count' => $materialsUsingUnit,
                ], 422);
            }

            // ADVERTENCIA: Si es la última unidad
            $currentUnitsCount = $category->allowedUnits()->count();
            if ($currentUnitsCount <= 1) {
                return response()->json([
                    'success' => false,
                    'message' => 'No se puede eliminar: la categoría debe tener al menos 1 unidad permitida.',
                    'is_last_unit' => true,
                ], 422);
            }

            DB::beginTransaction();

            $category->allowedUnits()->detach($unitId);

            DB::commit();

            Log::info('Unidad removida de categoría', [
                'category_id' => $category->id,
                'category_name' => $category->name,
                'unit_id' => $unit->id,
                'unit_name' => $unit->name,
                'user_id' => Auth::id(),
            ]);

            return response()->json([
                'success' => true,
                'message' => "Unidad '{$unit->name}' removida correctamente.",
            ]);
        } catch (\Illuminate\Database\Eloquent\ModelNotFoundException $e) {
            return response()->json([
                'success' => false,
                'message' => 'Categoría o unidad no encontrada.'
            ], 404);
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al remover unidad de categoría: ' . $e->getMessage(), [
                'category_id' => $categoryId,
                'unit_id' => $unitId,
                'user_id' => Auth::id(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error al remover la unidad.'
            ], 500);
        }
    }

    /**
     * Obtener unidades asignadas a una categoría (AJAX).
     */
    public function getAssignedUnits($categoryId)
    {
        try {
            $category = MaterialCategory::where('activo', true)
                ->with(['allowedUnits' => fn($q) => $q->orderBy('name')])
                ->findOrFail($categoryId);

            $units = $category->allowedUnits->map(function ($unit) use ($categoryId) {
                // Contar materiales que usan esta unidad en esta categoría
                $materialsCount = Material::where('material_category_id', $categoryId)
                    ->where('base_unit_id', $unit->id)
                    ->where('activo', true)
                    ->count();

                return [
                    'id' => $unit->id,
                    'name' => $unit->name,
                    'symbol' => $unit->symbol,
                    'materials_using' => $materialsCount,
                    'can_remove' => $materialsCount === 0,
                ];
            });

            return response()->json([
                'success' => true,
                'category' => [
                    'id' => $category->id,
                    'name' => $category->name,
                ],
                'units' => $units,
                'total_units' => $units->count(),
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error al obtener las unidades.'
            ], 500);
        }
    }

    /**
     * Obtener unidades disponibles para asignar a una categoría (AJAX).
     * Excluye las ya asignadas.
     */
    public function getAvailableUnits($categoryId)
    {
        try {
            $category = MaterialCategory::where('activo', true)->findOrFail($categoryId);

            // IDs de unidades ya asignadas
            $assignedUnitIds = $category->allowedUnits()->pluck('units.id')->toArray();

            // Unidades logísticas puras disponibles (no asignadas)
            $availableUnits = Unit::active()
                ->logistic() // unit_type = 'logistic'
                ->whereNotIn('id', $assignedUnitIds)
                ->ordered()
                ->get(['id', 'name', 'symbol']);

            return response()->json([
                'success' => true,
                'units' => $availableUnits,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error al obtener unidades disponibles.'
            ], 500);
        }
    }

    /**
     * Verificar integridad de una categoría.
     * Útil para diagnósticos y auditorías.
     */
    public function checkIntegrity($categoryId)
    {
        try {
            $category = MaterialCategory::where('activo', true)
                ->with('allowedUnits')
                ->findOrFail($categoryId);

            $issues = [];

            // Verificar si tiene unidades asignadas
            if ($category->allowedUnits->isEmpty()) {
                $issues[] = [
                    'type' => 'warning',
                    'message' => 'La categoría no tiene unidades de compra asignadas.',
                ];
            }

            // Verificar materiales con unidades inválidas
            $materialsWithInvalidUnit = Material::where('material_category_id', $categoryId)
                ->where('activo', true)
                ->whereNotIn('base_unit_id', $category->allowedUnits->pluck('id'))
                ->get(['id', 'name', 'base_unit_id']);

            if ($materialsWithInvalidUnit->isNotEmpty()) {
                $issues[] = [
                    'type' => 'error',
                    'message' => "{$materialsWithInvalidUnit->count()} material(es) tienen una unidad base no permitida.",
                    'materials' => $materialsWithInvalidUnit->toArray(),
                ];
            }

            return response()->json([
                'success' => true,
                'category' => $category->name,
                'has_issues' => !empty($issues),
                'issues' => $issues,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error al verificar integridad.'
            ], 500);
        }
    }
}
</file>

<file path="app/Http/Controllers/ProductVariantController.php">
<?php

namespace App\Http\Controllers;

use App\Models\ProductVariant;
use Illuminate\Http\Request;

class ProductVariantController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(ProductVariant $productVariant)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(ProductVariant $productVariant)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, ProductVariant $productVariant)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(ProductVariant $productVariant)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/PurchaseItemController.php">
<?php

namespace App\Http\Controllers;

use App\Models\PurchaseItem;
use Illuminate\Http\Request;

class PurchaseItemController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(PurchaseItem $purchaseItem)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(PurchaseItem $purchaseItem)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, PurchaseItem $purchaseItem)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(PurchaseItem $purchaseItem)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/PurchaseReceptionController.php">
<?php

namespace App\Http\Controllers;

use App\Models\PurchaseReception;
use Illuminate\Http\Request;

class PurchaseReceptionController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(PurchaseReception $purchaseReception)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(PurchaseReception $purchaseReception)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, PurchaseReception $purchaseReception)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(PurchaseReception $purchaseReception)
    {
        //
    }
}
</file>

<file path="app/Http/Controllers/PurchaseReceptionItemController.php">
<?php

namespace App\Http\Controllers;

use App\Models\PurchaseReceptionItem;
use Illuminate\Http\Request;

class PurchaseReceptionItemController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        //
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        //
    }

    /**
     * Display the specified resource.
     */
    public function show(PurchaseReceptionItem $purchaseReceptionItem)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit(PurchaseReceptionItem $purchaseReceptionItem)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, PurchaseReceptionItem $purchaseReceptionItem)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy(PurchaseReceptionItem $purchaseReceptionItem)
    {
        //
    }
}
</file>

<file path="app/Models/ActivityLog.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Casts\Attribute;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class ActivityLog extends Model
{
    /**
     * Inhabilitar la columna updated_at ya que los logs son inmutables.
     */
    public const UPDATED_AT = null;

    protected $table = 'activity_logs';

    protected $fillable = [
        'uuid',
        'user_id',
        'user_name',
        'action',
        'model_type',
        'model_id',
        'model_name',
        'old_values',
        'new_values',
        'changed_fields',
        'ip_address',
        'user_agent',
        'url',
        'method',
        'description',
        'metadata',
    ];

    protected $casts = [
        'old_values'     => 'array',
        'new_values'     => 'array',
        'changed_fields' => 'array',
        'metadata'       => 'array',
        'created_at'     => 'datetime',
    ];

    /**
     * Boot del modelo para lรณgica automรกtica.
     */
    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (ActivityLog $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
        });
    }

    /**
     * Relaciรณn con el usuario responsable.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class, 'user_id');
    }

    /**
     * Mรฉtodo estรกtico de registro centralizado de actividad.
     */
    public static function register(
        string $action,
        string $modelType,
        ?int $modelId = null,
        ?string $modelName = null,
        ?array $oldValues = null,
        ?array $newValues = null,
        ?string $description = null,
        ?array $metadata = null
    ): self {
        $user = Auth::user();
        $request = request();

        $changedFields = null;
        if ($oldValues && $newValues) {
            $changedFields = array_keys(array_diff_assoc(
                array_map('strval', $newValues),
                array_map('strval', $oldValues)
            ));
        }

        return self::create([
            'user_id'        => $user?->id,
            'user_name'      => $user ? Str::limit($user->name, 100, '') : 'Sistema',
            'action'         => Str::limit($action, 30, ''),
            'model_type'     => Str::limit($modelType, 100, ''),
            'model_id'       => $modelId,
            'model_name'     => $modelName ? Str::limit($modelName, 150, '') : null,
            'old_values'     => $oldValues,
            'new_values'     => $newValues,
            'changed_fields' => $changedFields,
            'ip_address'     => $request?->ip(),
            'user_agent'     => $request ? Str::limit($request->userAgent() ?? '', 500, '') : null,
            'url'            => $request ? Str::limit($request->fullUrl(), 500, '') : null,
            'method'         => $request?->method(),
            'description'    => $description,
            'metadata'       => $metadata,
        ]);
    }

    /**
     * Accesors modernos utilizando la clase Attribute de Laravel.
     */

    protected function shortModelType(): Attribute
    {
        return Attribute::make(
            get: fn() => class_basename($this->model_type)
        );
    }

    protected function actionIcon(): Attribute
    {
        return Attribute::make(
            get: fn() => match ($this->action) {
                'created'  => 'fas fa-plus-circle text-success',
                'updated'  => 'fas fa-edit text-warning',
                'deleted'  => 'fas fa-trash text-danger',
                'restored' => 'fas fa-undo text-info',
                'login'    => 'fas fa-sign-in-alt text-primary',
                'logout'   => 'fas fa-sign-out-alt text-secondary',
                default    => 'fas fa-circle text-muted',
            }
        );
    }

    protected function actionLabel(): Attribute
    {
        return Attribute::make(
            get: fn() => match ($this->action) {
                'created'  => 'Creรณ',
                'updated'  => 'Actualizรณ',
                'deleted'  => 'Eliminรณ',
                'restored' => 'Restaurรณ',
                'login'    => 'Iniciรณ sesiรณn',
                'logout'   => 'Cerrรณ sesiรณn',
                default    => Str::ucfirst($this->action),
            }
        );
    }

    public function getRouteKeyName(): string
    {
        return 'uuid';
    }
}
</file>

<file path="app/Models/Application_types.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;

class Application_types extends Model
{
    protected $table = 'application_types';
    protected $fillable = [
        'slug',
        'nombre_aplicacion',
        'descripcion',
        'activo',
        'fecha_baja',
    ];

    /**
     * Boot del modelo para generar slug automáticamente
     */
    protected static function boot()
    {
        parent::boot();

        // Generar slug automáticamente al crear
        static::creating(function ($model) {
            if (empty($model->slug) && !empty($model->nombre_aplicacion)) {
                $model->slug = self::generateSlug($model->nombre_aplicacion);
            }
        });

        // Actualizar slug si cambia el nombre
        static::updating(function ($model) {
            if ($model->isDirty('nombre_aplicacion') && !empty($model->nombre_aplicacion)) {
                $model->slug = self::generateSlug($model->nombre_aplicacion);
            }
        });
    }

    /**
     * Genera un slug a partir del nombre
     * Ejemplo: "Brazo Izquierdo" → "brazo_izquierdo"
     */
    public static function generateSlug(string $nombre): string
    {
        // Convertir a minúsculas
        $slug = Str::lower($nombre);

        // Reemplazar caracteres especiales y acentos
        $slug = Str::ascii($slug);

        // Reemplazar espacios y guiones por guiones bajos
        $slug = preg_replace('/[\s\-]+/', '_', $slug);

        // Eliminar caracteres no alfanuméricos excepto guión bajo
        $slug = preg_replace('/[^a-z0-9_]/', '', $slug);

        // Eliminar guiones bajos múltiples
        $slug = preg_replace('/_+/', '_', $slug);

        // Eliminar guiones bajos al inicio y final
        return trim($slug, '_');
    }

    /**
     * Scope para obtener solo los activos
     */
    public function scopeActivos($query)
    {
        return $query->where('activo', true)->whereNull('fecha_baja');
    }

    /**
     * Relación con diseños
     */
    public function designs()
    {
        return $this->hasMany(Design::class);
    }

    /**
     * Relación con exportaciones de diseño
     */
    public function designExports()
    {
        return $this->hasMany(DesignExport::class, 'application_type', 'slug');
    }
}
</file>

<file path="app/Models/Category.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class Category extends Model
{
    protected $fillable = [
        'name',
        'slug',
        'description',
        'parent_id',
        'order',
        'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean',
        'order' => 'integer'
    ];

    // Relación: Una categoría puede tener muchas subcategorías
    public function children()
    {
        return $this->hasMany(Category::class, 'parent_id');
    }

    // Relación: Una categoría pertenece a una categoría padre
    public function parent()
    {
        return $this->belongsTo(Category::class, 'parent_id');
    }

    // Relación: Una categoría tiene muchos diseños
    public function designs()
    {
        return $this->belongsToMany(Design::class);
    }
    /*
    fillable: Campos que se pueden asignar masivamente
    casts: Convierte automáticamente tipos de datos
    Las relaciones permiten acceder a datos relacionados fácilmente */
}
</file>

<file path="app/Models/Cliente.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Cliente extends Model
{
    use HasFactory;
    protected $table = 'clientes';
    protected $fillable = [
        'nombre',
        'apellidos',
        'telefono',
        'email',
        'direccion',
        'ciudad',
        'codigo_postal',
        'activo',
        'fecha_baja',
        'motivo_baja',
        'observaciones',
        'estado_id',
        'recomendacion_id',
        'busto',
        'alto_cintura',
        'cintura',
        'cadera',
        'largo',
    ];
    public function estado()
    {
        return $this->belongsTo(Estado::class);
    }
    public function recomendacion()
    {
        return $this->belongsTo(Recomendacion::class);
    }
}
</file>

<file path="app/Models/DesignExportStatusHistory.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class DesignExportStatusHistory extends Model
{
    protected $table = 'design_export_status_history';

    protected $fillable = [
        'design_export_id',
        'previous_status',
        'new_status',
        'changed_by',
        'notes',
    ];

    /**
     * Relación con el export.
     */
    public function export()
    {
        return $this->belongsTo(DesignExport::class, 'design_export_id');
    }

    /**
     * Relación con el usuario que hizo el cambio.
     */
    public function changedByUser()
    {
        return $this->belongsTo(User::class, 'changed_by');
    }

    /**
     * Accesor para el estado traducido (previous).
     */
    public function getPreviousStatusLabelAttribute()
    {
        return $this->getStatusLabel($this->previous_status);
    }

    /**
     * Accesor para el estado traducido (new).
     */
    public function getNewStatusLabelAttribute()
    {
        return $this->getStatusLabel($this->new_status);
    }

    /**
     * Helper para traducir estados.
     */
    private function getStatusLabel(?string $status): string
    {
        $labels = [
            'borrador' => 'Borrador',
            'pendiente' => 'Pendiente',
            'aprobado' => 'Aprobado',
            'archivado' => 'Archivado',
        ];

        return $labels[$status] ?? $status ?? 'Creación';
    }

    /**
     * Accesor para el color del estado.
     */
    public function getStatusColorAttribute(): string
    {
        $colors = [
            'borrador' => '#6b7280',
            'pendiente' => '#d97706',
            'aprobado' => '#059669',
            'archivado' => '#374151',
        ];

        return $colors[$this->new_status] ?? '#3b82f6';
    }

    /**
     * Accesor para el icono del estado.
     */
    public function getStatusIconAttribute(): string
    {
        $icons = [
            'borrador' => 'fa-pencil-alt',
            'pendiente' => 'fa-clock',
            'aprobado' => 'fa-check-circle',
            'archivado' => 'fa-archive',
        ];

        return $icons[$this->new_status] ?? 'fa-exchange-alt';
    }
}
</file>

<file path="app/Models/DesignVariantImage.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class DesignVariantImage extends Model
{
    protected $fillable = [
        'design_variant_id',
        'path',
        'original_name',
        'mime_type',
        'size',
        'is_primary',
        'order'
    ];

    protected $casts = [
        'is_primary' => 'boolean',
        'order' => 'integer',
        'size' => 'integer',
    ];

    public function variant()
    {
        return $this->belongsTo(DesignVariant::class, 'design_variant_id');
    }
}
</file>

<file path="app/Models/Giro.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class Giro extends Model
{
    use HasFactory;
    protected $table = 'giros';
    protected $fillable = [
        'nombre_giro',
        'descripcion',
        'activo',
        'fecha_baja',
    ];

    public function proveedores()
    {
        return $this->hasMany(Proveedor::class);
    }
}
</file>

<file path="app/Models/InventoryMovement.php">
<?php

namespace App\Models;

use App\Enums\MovementType;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class InventoryMovement extends Model
{
    protected $table = 'inventory_movements';

    protected $fillable = [
        'uuid',
        'material_variant_id',
        'type',
        'reference_type',
        'reference_id',
        'quantity',
        'unit_cost',
        'total_cost',
        'stock_before',
        'stock_after',
        'average_cost_before',
        'average_cost_after',
        'value_before',
        'value_after',
        'notes',
        'created_by',
    ];

    protected $casts = [
        'type' => MovementType::class,
        'quantity' => 'decimal:4',
        'unit_cost' => 'decimal:4',
        'total_cost' => 'decimal:4',
        'stock_before' => 'decimal:4',
        'stock_after' => 'decimal:4',
        'average_cost_before' => 'decimal:4',
        'average_cost_after' => 'decimal:4',
        'value_before' => 'decimal:4',
        'value_after' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->created_by)) {
                $model->created_by = Auth::id();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function materialVariant()
    {
        return $this->belongsTo(MaterialVariant::class, 'material_variant_id');
    }

    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeByVariant(Builder $query, int $variantId): Builder
    {
        return $query->where('material_variant_id', $variantId);
    }

    public function scopeByType(Builder $query, MovementType $type): Builder
    {
        return $query->where('type', $type->value);
    }

    public function scopeEntries(Builder $query): Builder
    {
        return $query->where('type', MovementType::ENTRY->value);
    }

    public function scopeExits(Builder $query): Builder
    {
        return $query->where('type', MovementType::EXIT->value);
    }

    public function scopeDateRange(Builder $query, ?string $from, ?string $to): Builder
    {
        if ($from) {
            $query->whereDate('created_at', '>=', $from);
        }
        if ($to) {
            $query->whereDate('created_at', '<=', $to);
        }
        return $query;
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getTypeLabelAttribute(): string
    {
        return $this->type->label();
    }

    public function getTypeColorAttribute(): string
    {
        return $this->type->color();
    }

    public function getTypeIconAttribute(): string
    {
        return $this->type->icon();
    }

    public function getFormattedQuantityAttribute(): string
    {
        $sign = $this->type->affectsStock() > 0 ? '+' : '-';
        return $sign . number_format(abs($this->quantity), 2);
    }

    public function getFormattedUnitCostAttribute(): string
    {
        return '$' . number_format($this->unit_cost, 4);
    }

    public function getFormattedTotalCostAttribute(): string
    {
        return '$' . number_format($this->total_cost, 2);
    }
}
</file>

<file path="app/Models/MaterialUnitConversion.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class MaterialUnitConversion extends Model
{
    protected $table = 'material_unit_conversions';

    protected $fillable = [
        'material_id',
        'from_unit_id',
        'to_unit_id',
        'conversion_factor',
    ];

    protected $casts = [
        'conversion_factor' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function material()
    {
        return $this->belongsTo(Material::class, 'material_id');
    }

    public function fromUnit()
    {
        return $this->belongsTo(Unit::class, 'from_unit_id');
    }

    public function toUnit()
    {
        return $this->belongsTo(Unit::class, 'to_unit_id');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getDisplayConversionAttribute(): string
    {
        $from = $this->fromUnit?->name ?? '';
        $to = $this->toUnit?->symbol ?? '';
        return "1 {$from} = {$this->conversion_factor} {$to}";
    }
}
</file>

<file path="app/Models/MaterialVariant.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use App\Traits\HasActivityLog;

class MaterialVariant extends Model
{
    use HasActivityLog;

    protected $table = 'material_variants';

    protected $activityLogNameField = 'sku';

    protected $fillable = [
        'uuid',
        'material_id',
        'color',
        'sku',
        'current_stock',
        'min_stock_alert',
        'current_value',
        'average_cost',
        'last_purchase_cost',
        'activo',
    ];

    protected $casts = [
        'current_stock' => 'decimal:4',
        'min_stock_alert' => 'decimal:4',
        'current_value' => 'decimal:4',
        'average_cost' => 'decimal:4',
        'last_purchase_cost' => 'decimal:4',
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function material()
    {
        return $this->belongsTo(Material::class, 'material_id');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('color')->orderBy('sku');
    }

    public function scopeLowStock(Builder $query): Builder
    {
        return $query->whereColumn('current_stock', '<=', 'min_stock_alert');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getDisplayNameAttribute(): string
    {
        $name = $this->material?->name ?? '';
        if ($this->color) {
            $name .= " - {$this->color}";
        }
        return $name;
    }

    public function getFormattedStockAttribute(): string
    {
        $unit = $this->material?->category?->baseUnit;
        $symbol = $unit?->symbol ?? '';
        return number_format($this->current_stock, 2) . ' ' . $symbol;
    }

    public function getFormattedAverageCostAttribute(): string
    {
        return '$' . number_format($this->average_cost, 2);
    }

    public function getIsLowStockAttribute(): bool
    {
        return $this->current_stock <= $this->min_stock_alert;
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS DE INVENTARIO
    |--------------------------------------------------------------------------
    */

    public function addStock(float $quantity, float $unitCost): void
    {
        $newValue = $this->current_value + ($quantity * $unitCost);
        $newStock = $this->current_stock + $quantity;

        $this->current_value = $newValue;
        $this->current_stock = $newStock;
        $this->average_cost = $newStock > 0 ? ($newValue / $newStock) : 0;
        $this->last_purchase_cost = $unitCost;
        $this->save();
    }

    public function reduceStock(float $quantity): float
    {
        $costConsumed = $quantity * $this->average_cost;

        $this->current_stock -= $quantity;
        $this->current_value -= $costConsumed;

        if ($this->current_stock < 0) {
            $this->current_stock = 0;
            $this->current_value = 0;
        }

        $this->save();

        return $costConsumed;
    }
}
</file>

<file path="app/Models/Purchase.php">
<?php

namespace App\Models;

use App\Enums\PurchaseStatus;
use App\Traits\HasActivityLog;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth; // <--- IMPORTACIÓN DE LA FACADE


class Purchase extends Model
{
    use SoftDeletes, HasActivityLog;

    protected $table = 'purchases';

    protected $activityLogNameField = 'purchase_number';

    protected $fillable = [
        'uuid',
        'purchase_number',
        'proveedor_id',
        'status',
        'subtotal',
        'tax_rate',
        'tax_amount',
        'discount_amount',
        'total',
        'notes',
        'reference',
        'ordered_at',
        'expected_at',
        'received_at',
        'created_by',
        'updated_by',
        'received_by',
        'cancelled_by',
        'cancelled_at',
        'cancellation_reason',
        'activo',
    ];

    protected $casts = [
        'status' => PurchaseStatus::class,
        'subtotal' => 'decimal:4',
        'tax_rate' => 'decimal:2',
        'tax_amount' => 'decimal:4',
        'discount_amount' => 'decimal:4',
        'total' => 'decimal:4',
        'ordered_at' => 'date',
        'expected_at' => 'date',
        'received_at' => 'datetime',
        'cancelled_at' => 'datetime',
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->purchase_number)) {
                $model->purchase_number = self::generatePurchaseNumber();
            }
            if (empty($model->status)) {
                $model->status = PurchaseStatus::DRAFT;
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function proveedor()
    {
        return $this->belongsTo(Proveedor::class, 'proveedor_id');
    }

    public function items()
    {
        return $this->hasMany(PurchaseItem::class, 'purchase_id');
    }

    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    public function updater()
    {
        return $this->belongsTo(User::class, 'updated_by');
    }

    public function receiver()
    {
        return $this->belongsTo(User::class, 'received_by');
    }

    public function canceller()
    {
        return $this->belongsTo(User::class, 'cancelled_by');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeByStatus(Builder $query, PurchaseStatus $status): Builder
    {
        return $query->where('status', $status->value);
    }

    public function scopePending(Builder $query): Builder
    {
        return $query->whereIn('status', [
            PurchaseStatus::PENDING->value,
            PurchaseStatus::PARTIAL->value,
        ]);
    }

    public function scopeByProveedor(Builder $query, int $proveedorId): Builder
    {
        return $query->where('proveedor_id', $proveedorId);
    }

    public function scopeDateRange(Builder $query, ?string $from, ?string $to): Builder
    {
        if ($from) {
            $query->whereDate('ordered_at', '>=', $from);
        }
        if ($to) {
            $query->whereDate('ordered_at', '<=', $to);
        }
        return $query;
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getStatusLabelAttribute(): string
    {
        return $this->status->label();
    }

    public function getStatusColorAttribute(): string
    {
        return $this->status->color();
    }

    public function getStatusIconAttribute(): string
    {
        return $this->status->icon();
    }

    public function getFormattedTotalAttribute(): string
    {
        return '$' . number_format($this->total, 2);
    }

    public function getFormattedSubtotalAttribute(): string
    {
        return '$' . number_format($this->subtotal, 2);
    }

    public function getItemsCountAttribute(): int
    {
        return $this->items()->count();
    }

    public function getCanEditAttribute(): bool
    {
        return $this->status->canEdit();
    }

    public function getCanReceiveAttribute(): bool
    {
        return $this->status->canReceive();
    }

    public function getCanCancelAttribute(): bool
    {
        return $this->status->canCancel();
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS DE NEGOCIO
    |--------------------------------------------------------------------------
    */

    public function recalculateTotals(): void
    {
        $subtotal = $this->items()->sum('subtotal');
        $taxAmount = $subtotal * ($this->tax_rate / 100);
        $total = $subtotal + $taxAmount - $this->discount_amount;

        $this->subtotal = $subtotal;
        $this->tax_amount = $taxAmount;
        $this->total = max(0, $total);
        $this->save();
    }

    public function markAsPending(): void
    {
        $this->status = PurchaseStatus::PENDING;
        $this->ordered_at = $this->ordered_at ?? now();
        $this->save();
    }

    public function markAsReceived(): void
    {
        $this->status = PurchaseStatus::RECEIVED;
        $this->received_at = now();
        $this->received_by = Auth::id();
        $this->save();
    }

    public function markAsPartial(): void
    {
        $this->status = PurchaseStatus::PARTIAL;
        $this->save();
    }

    public function markAsCancelled(string $reason): void
    {
        $this->status = PurchaseStatus::CANCELLED;
        $this->cancelled_at = now();
        $this->cancelled_by = Auth::id();
        $this->cancellation_reason = $reason;
        $this->save();
    }

    public function isFullyReceived(): bool
    {
        foreach ($this->items as $item) {
            if ($item->quantity_received < $item->quantity) {
                return false;
            }
        }
        return true;
    }

    public function hasReceivedItems(): bool
    {
        return $this->items()->where('quantity_received', '>', 0)->exists();
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS ESTÁTICOS
    |--------------------------------------------------------------------------
    */

    public static function generatePurchaseNumber(): string
    {
        $prefix = 'OC';
        $year = now()->format('y');
        $month = now()->format('m');

        $lastPurchase = self::whereYear('created_at', now()->year)
            ->whereMonth('created_at', now()->month)
            ->orderBy('id', 'desc')
            ->first();

        if ($lastPurchase && preg_match('/(\d+)$/', $lastPurchase->purchase_number, $matches)) {
            $sequence = (int) $matches[1] + 1;
        } else {
            $sequence = 1;
        }

        return sprintf('%s%s%s-%04d', $prefix, $year, $month, $sequence);
    }
}
</file>

<file path="app/Models/PurchaseItem.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Str;

class PurchaseItem extends Model
{
    protected $table = 'purchase_items';

    protected $fillable = [
        'uuid',
        'purchase_id',
        'material_variant_id',
        'unit_id',
        'quantity',
        'unit_price',
        'conversion_factor',
        'converted_quantity',
        'converted_unit_cost',
        'subtotal',
        'quantity_received',
        'converted_quantity_received',
        'notes',
    ];

    protected $casts = [
        'quantity' => 'decimal:4',
        'unit_price' => 'decimal:4',
        'conversion_factor' => 'decimal:4',
        'converted_quantity' => 'decimal:4',
        'converted_unit_cost' => 'decimal:4',
        'subtotal' => 'decimal:4',
        'quantity_received' => 'decimal:4',
        'converted_quantity_received' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            $model->calculateConversions();
        });

        static::updating(function (self $model): void {
            if ($model->isDirty(['quantity', 'unit_price', 'conversion_factor'])) {
                $model->calculateConversions();
            }
        });

        static::saved(function (self $model): void {
            $model->purchase->recalculateTotals();
        });

        static::deleted(function (self $model): void {
            $model->purchase->recalculateTotals();
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function purchase()
    {
        return $this->belongsTo(Purchase::class, 'purchase_id');
    }

    public function materialVariant()
    {
        return $this->belongsTo(MaterialVariant::class, 'material_variant_id');
    }

    public function unit()
    {
        return $this->belongsTo(Unit::class, 'unit_id');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFormattedSubtotalAttribute(): string
    {
        return '$' . number_format($this->subtotal, 2);
    }

    public function getFormattedUnitPriceAttribute(): string
    {
        return '$' . number_format($this->unit_price, 2);
    }

    public function getFormattedConvertedUnitCostAttribute(): string
    {
        return '$' . number_format($this->converted_unit_cost, 4);
    }

    public function getPendingQuantityAttribute(): float
    {
        return max(0, $this->quantity - $this->quantity_received);
    }

    public function getPendingConvertedQuantityAttribute(): float
    {
        return max(0, $this->converted_quantity - $this->converted_quantity_received);
    }

    public function getIsFullyReceivedAttribute(): bool
    {
        return $this->quantity_received >= $this->quantity;
    }

    public function getReceivedPercentageAttribute(): float
    {
        if ($this->quantity <= 0) {
            return 0;
        }
        return min(100, ($this->quantity_received / $this->quantity) * 100);
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    protected function calculateConversions(): void
    {
        $this->converted_quantity = $this->quantity * $this->conversion_factor;
        $this->subtotal = $this->quantity * $this->unit_price;

        if ($this->converted_quantity > 0) {
            $this->converted_unit_cost = $this->subtotal / $this->converted_quantity;
        } else {
            $this->converted_unit_cost = 0;
        }
    }

    public function recalculate(): void
    {
        $this->calculateConversions();
        $this->save();
    }

    public function addReceivedQuantity(float $quantity): void
    {
        $convertedQty = $quantity * $this->conversion_factor;

        $this->quantity_received += $quantity;
        $this->converted_quantity_received += $convertedQty;
        $this->save();
    }
}
</file>

<file path="app/Models/PurchaseReception.php">
<?php

namespace App\Models;

use App\Enums\ReceptionStatus;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class PurchaseReception extends Model
{
    protected $table = 'purchase_receptions';

    protected $fillable = [
        'uuid',
        'purchase_id',
        'reception_number',
        'status',
        'delivery_note',
        'notes',
        'received_at',
        'received_by',
        'voided_at',
        'voided_by',
        'void_reason',
    ];

    protected $casts = [
        'status' => ReceptionStatus::class,
        'received_at' => 'datetime',
        'voided_at' => 'datetime',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->reception_number)) {
                $model->reception_number = self::generateReceptionNumber($model->purchase_id);
            }
            if (empty($model->received_at)) {
                $model->received_at = now();
            }
            if (empty($model->received_by)) {
                $model->received_by = Auth::id();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function purchase()
    {
        return $this->belongsTo(Purchase::class, 'purchase_id');
    }

    public function items()
    {
        return $this->hasMany(PurchaseReceptionItem::class, 'purchase_reception_id');
    }

    public function receiver()
    {
        return $this->belongsTo(User::class, 'received_by');
    }

    public function voidedByUser()
    {
        return $this->belongsTo(User::class, 'voided_by');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeCompleted(Builder $query): Builder
    {
        return $query->where('status', ReceptionStatus::COMPLETED->value);
    }

    public function scopeVoided(Builder $query): Builder
    {
        return $query->where('status', ReceptionStatus::VOIDED->value);
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getStatusLabelAttribute(): string
    {
        return $this->status->label();
    }

    public function getStatusColorAttribute(): string
    {
        return $this->status->color();
    }

    public function getStatusIconAttribute(): string
    {
        return $this->status->icon();
    }

    public function getIsVoidedAttribute(): bool
    {
        return $this->status === ReceptionStatus::VOIDED;
    }

    public function getCanVoidAttribute(): bool
    {
        return $this->status === ReceptionStatus::COMPLETED;
    }

    public function getTotalItemsAttribute(): int
    {
        return $this->items()->count();
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public static function generateReceptionNumber(int $purchaseId): string
    {
        $purchase = Purchase::find($purchaseId);
        $prefix = $purchase ? $purchase->purchase_number : 'REC';

        $count = self::where('purchase_id', $purchaseId)->count() + 1;

        return sprintf('%s-R%02d', $prefix, $count);
    }
}
</file>

<file path="app/Models/PurchaseReceptionItem.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class PurchaseReceptionItem extends Model
{
    protected $table = 'purchase_reception_items';

    protected $fillable = [
        'purchase_reception_id',
        'purchase_item_id',
        'material_variant_id',
        'quantity_received',
        'converted_quantity',
        'unit_cost',
        'inventory_movement_id',
    ];

    protected $casts = [
        'quantity_received' => 'decimal:4',
        'converted_quantity' => 'decimal:4',
        'unit_cost' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function reception()
    {
        return $this->belongsTo(PurchaseReception::class, 'purchase_reception_id');
    }

    public function purchaseItem()
    {
        return $this->belongsTo(PurchaseItem::class, 'purchase_item_id');
    }

    public function materialVariant()
    {
        return $this->belongsTo(MaterialVariant::class, 'material_variant_id');
    }

    public function inventoryMovement()
    {
        return $this->belongsTo(InventoryMovement::class, 'inventory_movement_id');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFormattedQuantityAttribute(): string
    {
        return number_format($this->quantity_received, 2);
    }

    public function getTotalCostAttribute(): float
    {
        return $this->converted_quantity * $this->unit_cost;
    }
}
</file>

<file path="app/Models/SearchIndex.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\MorphTo;
use Illuminate\Database\Eloquent\Builder;

/**
 * SearchIndex Model
 * 
 * Representa una entrada en el índice de búsqueda.
 * Cada registro es una copia denormalizada de un modelo searchable.
 * 
 * @package App\Models
 * @property int $id
 * @property string $searchable_type
 * @property int $searchable_id
 * @property string $original_title
 * @property string|null $original_content
 * @property string $normalized_title
 * @property string|null $normalized_content
 * @property string $stemmed_tokens
 * @property array|null $metadata
 * @property bool $is_active
 * @property float $boost
 * @property \Carbon\Carbon $created_at
 * @property \Carbon\Carbon $updated_at
 */
class SearchIndex extends Model
{
    protected $table = 'search_index';

    protected $fillable = [
        'searchable_type',
        'searchable_id',
        'original_title',
        'original_content',
        'normalized_title',
        'normalized_content',
        'stemmed_tokens',
        'metadata',
        'is_active',
        'boost',
    ];

    protected $casts = [
        'metadata' => 'array',
        'is_active' => 'boolean',
        'boost' => 'float',
        'searchable_id' => 'integer',
    ];

    /**
     * Relación polimórfica al modelo indexado.
     */
    public function searchable(): MorphTo
    {
        return $this->morphTo();
    }

    /**
     * Scope: Solo entradas activas.
     */
    public function scopeActive(Builder $query): Builder
    {
        return $query->where('is_active', true);
    }

    /**
     * Scope: Filtrar por tipo de modelo.
     */
    public function scopeOfType(Builder $query, string $type): Builder
    {
        return $query->where('searchable_type', $type);
    }

    /**
     * Scope: Búsqueda FULLTEXT en tokens stemmed.
     * Este es el método principal de búsqueda.
     */
    public function scopeSearchStemmed(Builder $query, string $searchTerms): Builder
    {
        if (empty(trim($searchTerms))) {
            return $query;
        }

        return $query->whereRaw(
            'MATCH(stemmed_tokens) AGAINST(? IN BOOLEAN MODE)',
            [$searchTerms]
        );
    }

    /**
     * Scope: Búsqueda FULLTEXT en texto normalizado.
     */
    public function scopeSearchNormalized(Builder $query, string $searchTerms): Builder
    {
        if (empty(trim($searchTerms))) {
            return $query;
        }

        return $query->whereRaw(
            'MATCH(normalized_title, normalized_content) AGAINST(? IN BOOLEAN MODE)',
            [$searchTerms]
        );
    }

    /**
     * Scope: Búsqueda solo en título.
     */
    public function scopeSearchTitle(Builder $query, string $searchTerms): Builder
    {
        if (empty(trim($searchTerms))) {
            return $query;
        }

        return $query->whereRaw(
            'MATCH(normalized_title) AGAINST(? IN BOOLEAN MODE)',
            [$searchTerms]
        );
    }

    /**
     * Scope: Búsqueda con LIKE (fallback).
     */
    public function scopeSearchLike(Builder $query, string $term): Builder
    {
        $term = '%' . $term . '%';
        
        return $query->where(function ($q) use ($term) {
            $q->where('normalized_title', 'LIKE', $term)
              ->orWhere('normalized_content', 'LIKE', $term)
              ->orWhere('stemmed_tokens', 'LIKE', $term);
        });
    }

    /**
     * Scope: Ordenar por relevancia FULLTEXT.
     */
    public function scopeOrderByRelevance(Builder $query, string $searchTerms): Builder
    {
        if (empty(trim($searchTerms))) {
            return $query->orderByDesc('updated_at');
        }

        return $query->selectRaw(
            '*, MATCH(stemmed_tokens) AGAINST(? IN BOOLEAN MODE) AS relevance_score',
            [$searchTerms]
        )->orderByDesc('relevance_score')->orderByDesc('boost');
    }

    /**
     * Scope: Filtrar por metadata.
     */
    public function scopeWithMetadata(Builder $query, string $key, $value): Builder
    {
        return $query->whereRaw(
            'JSON_EXTRACT(metadata, ?) = ?',
            ['$.' . $key, json_encode($value)]
        );
    }

    /**
     * Scope: Filtrar por categorías en metadata.
     */
    public function scopeInCategories(Builder $query, array $categoryIds): Builder
    {
        if (empty($categoryIds)) {
            return $query;
        }

        return $query->where(function ($q) use ($categoryIds) {
            foreach ($categoryIds as $catId) {
                $q->orWhereRaw(
                    'JSON_CONTAINS(metadata, ?, "$.category_ids")',
                    [json_encode((int)$catId)]
                );
            }
        });
    }

    /**
     * Obtener el modelo original indexado.
     */
    public function getOriginalModel(): ?Model
    {
        $class = $this->searchable_type;
        
        if (!class_exists($class)) {
            return null;
        }

        return $class::find($this->searchable_id);
    }

    /**
     * Verificar si el índice está desactualizado.
     */
    public function isStale(): bool
    {
        $model = $this->getOriginalModel();
        
        if (!$model) {
            return true; // El modelo ya no existe
        }

        return $model->updated_at > $this->updated_at;
    }

    /**
     * Obtener extracto con highlight de términos.
     */
    public function getHighlightedExcerpt(string $query, int $length = 150): string
    {
        $content = $this->original_content ?? $this->original_title;
        
        if (empty($content)) {
            return '';
        }

        // Truncar si es muy largo
        if (mb_strlen($content) > $length) {
            $content = mb_substr($content, 0, $length) . '...';
        }

        // Destacar términos de búsqueda
        $terms = preg_split('/\s+/', $query, -1, PREG_SPLIT_NO_EMPTY);
        
        foreach ($terms as $term) {
            $content = preg_replace(
                '/(' . preg_quote($term, '/') . ')/iu',
                '<mark>$1</mark>',
                $content
            );
        }

        return $content;
    }

    /**
     * Crear o actualizar índice para un modelo.
     */
    public static function indexModel(
        Model $model,
        string $title,
        ?string $content,
        string $normalizedTitle,
        ?string $normalizedContent,
        string $stemmedTokens,
        array $metadata = [],
        float $boost = 1.0
    ): self {
        return self::updateOrCreate(
            [
                'searchable_type' => get_class($model),
                'searchable_id' => $model->getKey(),
            ],
            [
                'original_title' => $title,
                'original_content' => $content,
                'normalized_title' => $normalizedTitle,
                'normalized_content' => $normalizedContent,
                'stemmed_tokens' => $stemmedTokens,
                'metadata' => $metadata,
                'is_active' => true,
                'boost' => $boost,
            ]
        );
    }

    /**
     * Eliminar índice de un modelo.
     */
    public static function removeModel(Model $model): bool
    {
        return self::where('searchable_type', get_class($model))
            ->where('searchable_id', $model->getKey())
            ->delete() > 0;
    }

    /**
     * Desactivar índice de un modelo (soft).
     */
    public static function deactivateModel(Model $model): bool
    {
        return self::where('searchable_type', get_class($model))
            ->where('searchable_id', $model->getKey())
            ->update(['is_active' => false]) > 0;
    }
}
</file>

<file path="database/migrations/0001_01_01_000001_create_cache_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('cache', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->mediumText('value');
            $table->integer('expiration');
        });

        Schema::create('cache_locks', function (Blueprint $table) {
            $table->string('key')->primary();
            $table->string('owner');
            $table->integer('expiration');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('cache');
        Schema::dropIfExists('cache_locks');
    }
};
</file>

<file path="database/migrations/0001_01_01_000002_create_jobs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('jobs', function (Blueprint $table) {
            $table->id();
            $table->string('queue')->index();
            $table->longText('payload');
            $table->unsignedTinyInteger('attempts');
            $table->unsignedInteger('reserved_at')->nullable();
            $table->unsignedInteger('available_at');
            $table->unsignedInteger('created_at');
        });

        Schema::create('job_batches', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->string('name');
            $table->integer('total_jobs');
            $table->integer('pending_jobs');
            $table->integer('failed_jobs');
            $table->longText('failed_job_ids');
            $table->mediumText('options')->nullable();
            $table->integer('cancelled_at')->nullable();
            $table->integer('created_at');
            $table->integer('finished_at')->nullable();
        });

        Schema::create('failed_jobs', function (Blueprint $table) {
            $table->id();
            $table->string('uuid')->unique();
            $table->text('connection');
            $table->text('queue');
            $table->longText('payload');
            $table->longText('exception');
            $table->timestamp('failed_at')->useCurrent();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('jobs');
        Schema::dropIfExists('job_batches');
        Schema::dropIfExists('failed_jobs');
    }
};
</file>

<file path="database/migrations/2025_12_16_174359_create_permission_tables.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        $teams = config('permission.teams');
        $tableNames = config('permission.table_names');
        $columnNames = config('permission.column_names');
        $pivotRole = $columnNames['role_pivot_key'] ?? 'role_id';
        $pivotPermission = $columnNames['permission_pivot_key'] ?? 'permission_id';

        throw_if(empty($tableNames), Exception::class, 'Error: config/permission.php not loaded. Run [php artisan config:clear] and try again.');
        throw_if($teams && empty($columnNames['team_foreign_key'] ?? null), Exception::class, 'Error: team_foreign_key on config/permission.php not loaded. Run [php artisan config:clear] and try again.');

        Schema::create($tableNames['permissions'], static function (Blueprint $table) {
            // $table->engine('InnoDB');
            $table->bigIncrements('id'); // permission id
            $table->string('name');       // For MyISAM use string('name', 225); // (or 166 for InnoDB with Redundant/Compact row format)
            $table->string('guard_name'); // For MyISAM use string('guard_name', 25);
            $table->timestamps();

            $table->unique(['name', 'guard_name']);
        });

        Schema::create($tableNames['roles'], static function (Blueprint $table) use ($teams, $columnNames) {
            // $table->engine('InnoDB');
            $table->bigIncrements('id'); // role id
            if ($teams || config('permission.testing')) { // permission.testing is a fix for sqlite testing
                $table->unsignedBigInteger($columnNames['team_foreign_key'])->nullable();
                $table->index($columnNames['team_foreign_key'], 'roles_team_foreign_key_index');
            }
            $table->string('name');       // For MyISAM use string('name', 225); // (or 166 for InnoDB with Redundant/Compact row format)
            $table->string('guard_name'); // For MyISAM use string('guard_name', 25);
            $table->timestamps();
            if ($teams || config('permission.testing')) {
                $table->unique([$columnNames['team_foreign_key'], 'name', 'guard_name']);
            } else {
                $table->unique(['name', 'guard_name']);
            }
        });

        Schema::create($tableNames['model_has_permissions'], static function (Blueprint $table) use ($tableNames, $columnNames, $pivotPermission, $teams) {
            $table->unsignedBigInteger($pivotPermission);

            $table->string('model_type');
            $table->unsignedBigInteger($columnNames['model_morph_key']);
            $table->index([$columnNames['model_morph_key'], 'model_type'], 'model_has_permissions_model_id_model_type_index');

            $table->foreign($pivotPermission)
                ->references('id') // permission id
                ->on($tableNames['permissions'])
                ->onDelete('cascade');
            if ($teams) {
                $table->unsignedBigInteger($columnNames['team_foreign_key']);
                $table->index($columnNames['team_foreign_key'], 'model_has_permissions_team_foreign_key_index');

                $table->primary([$columnNames['team_foreign_key'], $pivotPermission, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_permissions_permission_model_type_primary');
            } else {
                $table->primary([$pivotPermission, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_permissions_permission_model_type_primary');
            }

        });

        Schema::create($tableNames['model_has_roles'], static function (Blueprint $table) use ($tableNames, $columnNames, $pivotRole, $teams) {
            $table->unsignedBigInteger($pivotRole);

            $table->string('model_type');
            $table->unsignedBigInteger($columnNames['model_morph_key']);
            $table->index([$columnNames['model_morph_key'], 'model_type'], 'model_has_roles_model_id_model_type_index');

            $table->foreign($pivotRole)
                ->references('id') // role id
                ->on($tableNames['roles'])
                ->onDelete('cascade');
            if ($teams) {
                $table->unsignedBigInteger($columnNames['team_foreign_key']);
                $table->index($columnNames['team_foreign_key'], 'model_has_roles_team_foreign_key_index');

                $table->primary([$columnNames['team_foreign_key'], $pivotRole, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_roles_role_model_type_primary');
            } else {
                $table->primary([$pivotRole, $columnNames['model_morph_key'], 'model_type'],
                    'model_has_roles_role_model_type_primary');
            }
        });

        Schema::create($tableNames['role_has_permissions'], static function (Blueprint $table) use ($tableNames, $pivotRole, $pivotPermission) {
            $table->unsignedBigInteger($pivotPermission);
            $table->unsignedBigInteger($pivotRole);

            $table->foreign($pivotPermission)
                ->references('id') // permission id
                ->on($tableNames['permissions'])
                ->onDelete('cascade');

            $table->foreign($pivotRole)
                ->references('id') // role id
                ->on($tableNames['roles'])
                ->onDelete('cascade');

            $table->primary([$pivotPermission, $pivotRole], 'role_has_permissions_permission_id_role_id_primary');
        });

        app('cache')
            ->store(config('permission.cache.store') != 'default' ? config('permission.cache.store') : null)
            ->forget(config('permission.cache.key'));
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        $tableNames = config('permission.table_names');

        throw_if(empty($tableNames), Exception::class, 'Error: config/permission.php not found and defaults could not be merged. Please publish the package configuration before proceeding, or drop the tables manually.');

        Schema::drop($tableNames['role_has_permissions']);
        Schema::drop($tableNames['model_has_roles']);
        Schema::drop($tableNames['model_has_permissions']);
        Schema::drop($tableNames['roles']);
        Schema::drop($tableNames['permissions']);
    }
};
</file>

<file path="database/migrations/2025_12_18_045304_create_recomendacions_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('recomendacion', function (Blueprint $table) {
            $table->id();
            $table->string('nombre_recomendacion');
            $table->string('descripcion_recomendacion')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->string('motivo_baja')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('recomendacion');
    }
};
</file>

<file path="database/migrations/2025_12_18_055620_create_clientes_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('clientes', function (Blueprint $table) {
            $table->id();
            $table->string('nombre');
            $table->string('apellidos');
            $table->string('telefono');
            $table->string('email')->nullable();
            $table->string('direccion')->nullable();
            $table->string('ciudad')->nullable();
            $table->string('codigo_postal')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->string('motivo_baja')->nullable();
            $table->string('observaciones')->nullable();
            $table->string('busto')->nullable();
            $table->string('alto_cintura')->nullable();
            $table->string('cintura')->nullable();
            $table->string('cadera')->nullable();
            $table->string('largo')->nullable();
            $table->foreignId('estado_id')->constrained('estados')->restrictOnDelete();
            $table->foreignId('recomendacion_id')->constrained('recomendacion')->restrictOnDelete();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('clientes');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_19_172828_create_categories_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('categories', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('slug')->unique();
            $table->text('description')->nullable();
            $table->foreignId('parent_id')->nullable()->constrained('categories')->onDelete('cascade');
            $table->integer('order')->default(0);
            $table->boolean('is_active')->default(true);
            $table->timestamps();

            // Índices para optimización
            $table->index('slug');
            $table->index('parent_id');
            $table->index('is_active');
        });
        /*Explicación de campos importantes:
        foreignId('parent_id'): Permite categorías anidadas (subcategorías)
        constrained('categories'): Crea la relación con la misma tabla
        onDelete('cascade'): Si se elimina una categoría padre, se eliminan sus hijas
        index(): Mejora velocidad de búsqueda en estos campos */
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('categories');
    }
};
</file>

<file path="database/migrations/2025_12_19_172926_create_images_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('images', function (Blueprint $table) {
            $table->id();
            $table->morphs('imageable'); // Ya crea el índice automáticamente
            $table->string('file_name');
            $table->string('file_path');
            $table->integer('file_size');
            $table->string('mime_type');
            $table->integer('width')->nullable();
            $table->integer('height')->nullable();
            $table->string('alt_text')->nullable();
            $table->integer('order')->default(0);
            $table->boolean('is_primary')->default(false);
            $table->timestamps();

            // Este índice está duplicado - ELIMINAR esta línea
            //  $table->index(['imageable_type', 'imageable_id']);
        });
        //morphs('imageable'): Crea dos campos para relación polimórfica (permite asociar a múltiples modelos)
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('images');
    }
};
</file>

<file path="database/migrations/2025_12_19_172936_create_category_design_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('category_design', function (Blueprint $table) {
            $table->id();
            $table->foreignId('category_id')->constrained()->onDelete('cascade');
            $table->foreignId('design_id')->constrained()->onDelete('cascade');
            $table->timestamps();

            // Índice compuesto para búsquedas eficientes
            $table->unique(['category_id', 'design_id']);
            $table->index('design_id');
        });
        //unique(['category_id', 'design_id']): Evita duplicados de la misma relación
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('category_design');
    }
};
</file>

<file path="database/migrations/2025_12_19_172942_create_design_variant_attributes_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('design_variant_attributes', function (Blueprint $table) {
            $table->id();
            $table->foreignId('design_variant_id')->constrained()->onDelete('cascade');
            $table->foreignId('attribute_value_id')->constrained()->onDelete('cascade');
            $table->timestamps();

            // Índice compuesto
            $table->unique(['design_variant_id', 'attribute_value_id'], 'variant_attribute_unique');
            $table->index('attribute_value_id');
        });
        //Se especifica nombre corto del índice único porque el nombre automático sería muy largo
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('design_variant_attributes');
    }
};
</file>

<file path="database/migrations/2025_12_20_150609_create_design_variant_images_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('design_variant_images', function (Blueprint $table) {
            $table->id();

            // Relación con variante
            $table->foreignId('design_variant_id')
                ->constrained('design_variants')
                ->onDelete('cascade');

            // Archivo
            $table->string('path');           // storage path
            $table->string('original_name')->nullable();
            $table->string('mime_type')->nullable();
            $table->unsignedBigInteger('size')->nullable();

            // Control visual
            $table->boolean('is_primary')->default(false);
            $table->integer('order')->default(0);

            $table->timestamps();

            // Índices
            $table->index(['design_variant_id', 'is_primary']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('design_variant_images');
    }
};
</file>

<file path="database/migrations/2025_12_24_160930_create_application_types_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('application_types', function (Blueprint $table) {
            $table->id();
            $table->string('slug')->unique(); // Ej: 'manga_izquierda'
            $table->string('nombre_aplicacion');
            $table->string('descripcion')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('application_types');
    }
};
</file>

<file path="database/migrations/2025_12_24_161013_create_design_exports_table.php">
<?php
// Nombre del archivo: 2025_12_25_000001_create_design_exports_table.php
// Ubicación: database/migrations/2025_12_25_000001_create_design_exports_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('design_exports', function (Blueprint $table) {
            $table->id();

            // Relaciones principales
            $table->foreignId('design_id')->constrained()->onDelete('cascade');
            $table->foreignId('design_variant_id')->nullable()->constrained('design_variants')->onDelete('cascade');

            // Información de aplicación
            $table->string('application_type', 50)->default('general');
            $table->string('application_label', 100);
            $table->string('placement_description', 255)->nullable();

            // Archivo técnico
            $table->string('file_name');
            $table->string('file_path');
            $table->string('file_format', 10);
            $table->unsignedBigInteger('file_size')->nullable();
            $table->string('mime_type')->nullable();

            // Datos técnicos
            $table->unsignedInteger('stitches_count')->nullable();
            $table->unsignedInteger('width_mm')->nullable();
            $table->unsignedInteger('height_mm')->nullable();
            $table->unsignedInteger('colors_count')->nullable();
            $table->json('colors_detected')->nullable();

            // Estado
            $table->enum('status', ['borrador', 'pendiente', 'aprobado', 'archivado'])->default('borrador');
            $table->boolean('auto_read_success')->default(false);
            $table->text('notes')->nullable();

            // Auditoría
            $table->foreignId('created_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('approved_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamp('approved_at')->nullable();
            $table->foreignId('application_type_id')->nullable()->constrained('application_types')->nullOnDelete();

            // Timestamps
            $table->timestamps();
            $table->softDeletes();

            // Índices
            $table->index(['design_id']);
            $table->index(['design_variant_id']);
            $table->index(['status']);
            $table->index(['application_type_id']);
            $table->index(['created_by']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('design_exports');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_27_000001_add_image_id_to_design_exports_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Agrega campo image_id para vincular producción con imagen específica.
     */
    public function up(): void
    {
        Schema::table('design_exports', function (Blueprint $table) {
            // Campo para vincular producción a una imagen específica
            // Nullable porque puede ser producción general sin imagen específica
            $table->foreignId('image_id')
                ->nullable()
                ->after('design_variant_id')
                ->constrained('images')
                ->nullOnDelete();

            // Índice para búsquedas por imagen
            $table->index('image_id');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('design_exports', function (Blueprint $table) {
            $table->dropForeign(['image_id']);
            $table->dropIndex(['image_id']);
            $table->dropColumn('image_id');
        });
    }
};
</file>

<file path="database/migrations/2025_12_27_000001_create_search_index_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    /**
     * Run the migrations.
     * 
     * Tabla de índice de búsqueda denormalizado.
     * Permite búsquedas rápidas con texto normalizado y stemmed.
     */
    public function up(): void
    {
        Schema::create('search_index', function (Blueprint $table) {
            $table->id();
            
            // Referencia polimórfica al modelo indexado
            $table->string('searchable_type', 100); // 'Design', 'Category', etc.
            $table->unsignedBigInteger('searchable_id');
            
            // Texto original (para mostrar en resultados)
            $table->string('original_title', 500);
            $table->text('original_content')->nullable();
            
            // Texto normalizado para búsqueda
            // (lowercase, sin acentos, sin caracteres especiales)
            $table->string('normalized_title', 500);
            $table->text('normalized_content')->nullable();
            
            // Tokens stemmed (raíces de palabras)
            // Ejemplo: "perros dorados" → "perr dorad"
            $table->text('stemmed_tokens');
            
            // Metadata para filtros y ordenamiento
            $table->json('metadata')->nullable(); // categorías, tags, etc.
            $table->boolean('is_active')->default(true);
            $table->float('boost', 3, 2)->default(1.00); // Factor de relevancia
            
            // Auditoría
            $table->timestamps();
            
            // Índices compuestos para queries eficientes
            $table->unique(['searchable_type', 'searchable_id'], 'search_idx_unique_model');
            $table->index(['searchable_type', 'is_active'], 'search_idx_type_active');
            $table->index('is_active', 'search_idx_active');
            $table->index('updated_at', 'search_idx_updated');
        });

        // Crear índice FULLTEXT para búsqueda de texto
        // MySQL 5.7+ / MariaDB 10.0.5+ soporta FULLTEXT en InnoDB
        DB::statement('ALTER TABLE search_index ADD FULLTEXT search_ft_normalized (normalized_title, normalized_content)');
        DB::statement('ALTER TABLE search_index ADD FULLTEXT search_ft_stemmed (stemmed_tokens)');
        DB::statement('ALTER TABLE search_index ADD FULLTEXT search_ft_title (normalized_title)');
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('search_index');
    }
};
</file>

<file path="database/migrations/2025_12_27_153719_add_thumbnail_fields_to_images_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * Agrega campos para thumbnails optimizados manteniendo la imagen original.
     */
    public function up(): void
    {
        Schema::table('images', function (Blueprint $table) {
            // Thumbnail pequeño para listados/grids (150px)
            $table->string('thumbnail_small')->nullable()->after('file_path');
            // Thumbnail mediano para galerías/modales (400px)
            $table->string('thumbnail_medium')->nullable()->after('thumbnail_small');
            // Indicador de si la imagen ha sido optimizada
            $table->boolean('is_optimized')->default(false)->after('thumbnail_medium');
            // Tamaño original del archivo (para referencia)
            $table->unsignedBigInteger('original_size')->nullable()->after('is_optimized');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('images', function (Blueprint $table) {
            $table->dropColumn(['thumbnail_small', 'thumbnail_medium', 'is_optimized', 'original_size']);
        });
    }
};
</file>

<file path="database/migrations/2025_12_30_120441_create_product_categories_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_categories', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            // Relación con tu tabla de empresas existente
            $table->string('name');
            $table->string('slug');
            $table->text('description')->nullable();
            $table->boolean('is_active')->default(true);
            $table->timestamps();
            $table->softDeletes(); // Para auditoría industrial
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('product_categories');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_30_120458_create_product_extras_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_extras', function (Blueprint $table) {
            $table->id();
            //   $table->foreignId('company_id')->constrained();
            $table->uuid('uuid')->unique();
            $table->string('name'); // Ej: "Encaje de Algodón", "Alforza Triple"
            $table->decimal('cost_addition', 15, 4)->default(0); // Cuánto suma al costo
            $table->decimal('price_addition', 15, 4)->default(0);
            $table->integer('minutes_addition')->default(0); // Tiempo extra de mano de obra
            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_extras');
    }
};
</file>

<file path="database/migrations/2025_12_30_121830_create_products_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('products', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();

            // Preparado para futuro SaaS/Sucursales (por ahora puede ser null o defecto 1)
            $table->unsignedBigInteger('tenant_id')->default(1)->index();

            // Relación con la categoría que creamos en el Paso 1
            $table->foreignId('product_category_id')->constrained()->onDelete('cascade');

            $table->string('name'); // Ej: Hipil Tradicional, Cosmetiquera Mezclilla
            $table->string('sku')->unique(); // Código único industrial
            $table->text('description')->nullable();

            // Metadata Industrial: Aquí guardamos tipo de tela base, material interior, etc.
            // Usamos JSON para tener flexibilidad total sin crear mil columnas.
            $table->json('specifications')->nullable();

            $table->enum('status', ['draft', 'active', 'discontinued'])->default('active');

            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('products');
    }
};
</file>

<file path="database/migrations/2025_12_30_121919_create_product_design_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_design', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained()->onDelete('cascade');
            $table->foreignId('design_id')->constrained('designs')->onDelete('cascade');

            // Muy importante: ¿En qué parte del producto va el bordado?
            // Usamos tu tabla existente 'application_types' (Pecho, Manga, etc.)
            $table->foreignId('application_type_id')->constrained('application_types');

            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_design');
    }
};
</file>

<file path="database/migrations/2025_12_30_122410_create_product_variants_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_variants', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('product_id')->constrained()->onDelete('cascade');

            $table->string('sku_variant')->unique(); // Ej: BLU-LIN-BLA-M
            $table->decimal('price', 15, 4)->default(0); // Precio específico de esta combinación

            // Metadata para almacenar los IDs de los atributos (Color: Azul, Tela: Lino)
            // Esto se vincula con tus tablas actuales 'attribute_values'
            $table->json('attribute_combinations')->nullable();

            $table->integer('stock_alert')->default(5); // Alerta de inventario bajo
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_variants');
    }
};
</file>

<file path="database/migrations/2025_12_30_122508_create_product_variant_design_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_variant_design', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_variant_id')->constrained()->onDelete('cascade');

            // Vínculo directo a la tabla que mencionaste: design_exports
            $table->foreignId('design_export_id')->constrained('design_exports')->onDelete('cascade');

            // Posición técnica (Pecho, Espalda, etc.)
            $table->foreignId('application_type_id')->constrained('application_types');
            $table->text('notes')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_variant_design');
    }
};
</file>

<file path="database/migrations/2025_12_30_122818_create_product_extra_assignment_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_extra_assignment', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained()->onDelete('cascade');
            $table->foreignId('product_extra_id')->constrained('product_extras')->onDelete('cascade');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_extra_assignment');
    }
};
</file>

<file path="database/migrations/2025_12_30_124341_create_product_variant_attribute_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('product_variant_attribute', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_variant_id')->constrained()->onDelete('cascade');
            $table->foreignId('attribute_id')->constrained('attributes');
            $table->foreignId('attribute_value_id')->constrained('attribute_values');
            $table->timestamps();
            $table->softDeletes();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('product_variant_attribute');
    }
};
</file>

<file path="database/migrations/2026_01_02_191615_create_units_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     * 
     * Tabla de unidades de medida para el sistema de inventario.
     * Soporta unidades base (metro, pieza) y unidades de compra (rollo, cono, caja).
     */
    public function up(): void
    {
        Schema::create('units', function (Blueprint $table) {
            // Llave primaria
            $table->id();

            // UUID para exposición externa (APIs, URLs públicas)
            $table->uuid('uuid')->unique();

            // Datos principales
            $table->string('name', 50);                    // "Metro", "Rollo", "Cono"
            $table->string('slug', 50)->unique();          // "metro", "rollo", "cono"
            $table->string('symbol', 10);                  // "m", "pz", "cono"

            // Clasificación
            $table->boolean('is_base')->default(false);    // true = unidad de consumo (metro, pieza)
            $table->boolean('activo')->default(true);   // Soft toggle sin eliminar


            // Auditoría
            $table->timestamps();
            $table->softDeletes();

            // Índices para performance
            $table->index('activo');
            $table->index('is_base');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('units');
    }
};
</file>

<file path="database/migrations/2026_01_03_013052_create_system_settings_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('system_settings', function (Blueprint $table) {
            $table->id();
            $table->string('key', 100)->unique();
            $table->text('value')->nullable();
            $table->string('type', 20)->default('string'); // string, integer, boolean, json, select
            $table->string('group', 50)->default('general'); // general, inventario, facturacion, produccion
            $table->string('label', 100);
            $table->string('description', 255)->nullable();
            $table->json('options')->nullable(); // Para tipo select
            $table->foreignId('updated_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamps();

            $table->index('group');
            $table->index('type');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('system_settings');
    }
};
</file>

<file path="database/migrations/2026_01_03_094357_create_activity_logs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('activity_logs', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('user_id')->nullable()->constrained('users')->nullOnDelete();
            $table->string('user_name', 100)->nullable();
            $table->string('action', 30);
            $table->string('model_type', 100);
            $table->unsignedBigInteger('model_id')->nullable();
            $table->string('model_name', 150)->nullable();
            $table->json('old_values')->nullable();
            $table->json('new_values')->nullable();
            $table->json('changed_fields')->nullable();
            $table->string('ip_address', 45)->nullable();
            $table->string('user_agent', 500)->nullable();
            $table->string('url', 500)->nullable();
            $table->string('method', 10)->nullable();
            $table->text('description')->nullable();
            $table->json('metadata')->nullable();
            $table->timestamp('created_at')->useCurrent();

            $table->index('user_id');
            $table->index('action');
            $table->index('model_type');
            $table->index(['model_type', 'model_id']);
            $table->index('created_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('activity_logs');
    }
};
</file>

<file path="database/migrations/2026_01_03_102946_create_material_categories.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('material_categories', function (Blueprint $table) {
            $table->id();
            $table->string('name', 50);
            $table->string('slug', 50)->unique();
            $table->text('description')->nullable();
            $table->foreignId('base_unit_id')->constrained('units')->restrictOnDelete();
            $table->boolean('has_color')->default(true);
            $table->boolean('activo')->default(true);
            $table->timestamps();

            $table->index('activo');
            $table->index('slug');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('material_categories');
    }
};
</file>

<file path="database/migrations/2026_01_03_103133_create_materials.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('materials', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('material_category_id')->constrained('material_categories')->restrictOnDelete();
            $table->string('name', 100);
            $table->string('slug', 100)->unique();
            $table->string('composition', 100)->nullable();
            $table->text('description')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamps();

            $table->index('activo');
            $table->index('slug');
            $table->index('material_category_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('materials');
    }
};
</file>

<file path="database/migrations/2026_01_03_103227_create_material_variants.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('material_variants', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('material_id')->constrained('materials')->cascadeOnDelete();
            $table->string('color', 50)->nullable();
            $table->string('sku', 30)->unique();
            $table->decimal('current_stock', 12, 4)->default(0);
            $table->decimal('min_stock_alert', 12, 4)->default(0);
            $table->decimal('current_value', 14, 4)->default(0);
            $table->decimal('average_cost', 14, 4)->default(0);
            $table->decimal('last_purchase_cost', 14, 4)->default(0);
            $table->boolean('activo')->default(true);
            $table->timestamps();

            $table->index('activo');
            $table->index('sku');
            $table->index('material_id');
            $table->index(['material_id', 'color']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('material_variants');
    }
};
</file>

<file path="database/migrations/2026_01_03_103255_create_material_unit_conversions.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('material_unit_conversions', function (Blueprint $table) {
            $table->id();
            $table->foreignId('material_id')->constrained('materials')->cascadeOnDelete();
            $table->foreignId('from_unit_id')->constrained('units')->restrictOnDelete();
            $table->foreignId('to_unit_id')->constrained('units')->restrictOnDelete();
            $table->decimal('conversion_factor', 12, 4);
            $table->timestamps();

            $table->unique(['material_id', 'from_unit_id'], 'material_unit_unique');
            $table->index('material_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('material_unit_conversions');
    }
};
</file>

<file path="database/migrations/2026_01_03_142851_add_compatible_base_unit_to_units_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::table('units', function (Blueprint $table) {
            $table->foreignId('compatible_base_unit_id')
                ->nullable()
                ->after('is_base')
                ->constrained('units')
                ->nullOnDelete();
        });
    }

    public function down(): void
    {
        Schema::table('units', function (Blueprint $table) {
            $table->dropForeign(['compatible_base_unit_id']);
            $table->dropColumn('compatible_base_unit_id');
        });
    }
};
</file>

<file path="database/migrations/2026_01_03_150526_create_purchases_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('purchases', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->string('purchase_number', 20)->unique();
            $table->foreignId('proveedor_id')->constrained('proveedors')->restrictOnDelete();
            $table->string('status', 20)->default('borrador');
            $table->decimal('subtotal', 14, 4)->default(0);
            $table->decimal('tax_rate', 5, 2)->default(0);
            $table->decimal('tax_amount', 14, 4)->default(0);
            $table->decimal('discount_amount', 14, 4)->default(0);
            $table->decimal('total', 14, 4)->default(0);
            $table->text('notes')->nullable();
            $table->string('reference', 100)->nullable();
            $table->date('ordered_at')->nullable();
            $table->date('expected_at')->nullable();
            $table->timestamp('received_at')->nullable();
            $table->foreignId('created_by')->constrained('users')->restrictOnDelete();
            $table->foreignId('updated_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('received_by')->nullable()->constrained('users')->nullOnDelete();
            $table->foreignId('cancelled_by')->nullable()->constrained('users')->nullOnDelete();
            $table->timestamp('cancelled_at')->nullable();
            $table->text('cancellation_reason')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamps();
            $table->softDeletes();

            $table->index('status');
            $table->index('proveedor_id');
            $table->index('created_by');
            $table->index('ordered_at');
            $table->index('activo');
            $table->index(['status', 'activo']);
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('purchases');
    }
};
</file>

<file path="database/migrations/2026_01_03_150553_create_purchase_items_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('purchase_items', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('purchase_id')->constrained('purchases')->cascadeOnDelete();
            $table->foreignId('material_variant_id')->constrained('material_variants')->restrictOnDelete();
            $table->foreignId('unit_id')->constrained('units')->restrictOnDelete();
            $table->decimal('quantity', 12, 4);
            $table->decimal('unit_price', 14, 4);
            $table->decimal('conversion_factor', 12, 4)->default(1);
            $table->decimal('converted_quantity', 12, 4);
            $table->decimal('converted_unit_cost', 14, 4);
            $table->decimal('subtotal', 14, 4);
            $table->decimal('quantity_received', 12, 4)->default(0);
            $table->decimal('converted_quantity_received', 12, 4)->default(0);
            $table->text('notes')->nullable();
            $table->timestamps();

            $table->index('purchase_id');
            $table->index('material_variant_id');
            $table->unique(['purchase_id', 'material_variant_id', 'unit_id'], 'purchase_item_unique');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('purchase_items');
    }
};
</file>

<file path="database/migrations/2026_01_03_150625_create_inventory_movements_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('inventory_movements', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('material_variant_id')->constrained('material_variants')->restrictOnDelete();
            $table->string('type', 30);
            $table->string('reference_type', 50)->nullable();
            $table->unsignedBigInteger('reference_id')->nullable();
            $table->decimal('quantity', 12, 4);
            $table->decimal('unit_cost', 14, 4);
            $table->decimal('total_cost', 14, 4);
            $table->decimal('stock_before', 12, 4);
            $table->decimal('stock_after', 12, 4);
            $table->decimal('average_cost_before', 14, 4);
            $table->decimal('average_cost_after', 14, 4);
            $table->decimal('value_before', 14, 4);
            $table->decimal('value_after', 14, 4);
            $table->text('notes')->nullable();
            $table->foreignId('created_by')->constrained('users')->restrictOnDelete();
            $table->timestamps();

            $table->index('material_variant_id');
            $table->index('type');
            $table->index(['reference_type', 'reference_id']);
            $table->index('created_at');
            $table->index('created_by');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('inventory_movements');
    }
};
</file>

<file path="database/migrations/2026_01_04_090517_create_purchase_receptions_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('purchase_receptions', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->foreignId('purchase_id')->constrained('purchases')->cascadeOnDelete();
            $table->string('reception_number', 30)->unique();
            $table->string('status', 20)->default('completed');
            $table->string('delivery_note', 100)->nullable();
            $table->text('notes')->nullable();
            $table->timestamp('received_at');
            $table->foreignId('received_by')->constrained('users')->restrictOnDelete();
            $table->timestamp('voided_at')->nullable();
            $table->foreignId('voided_by')->nullable()->constrained('users')->nullOnDelete();
            $table->text('void_reason')->nullable();
            $table->timestamps();

            $table->index('purchase_id');
            $table->index('status');
            $table->index('received_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('purchase_receptions');
    }
};
</file>

<file path="database/migrations/2026_01_04_090551_create_purchase_reception_items_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('purchase_reception_items', function (Blueprint $table) {
            $table->id();
            $table->foreignId('purchase_reception_id')->constrained('purchase_receptions')->cascadeOnDelete();
            $table->foreignId('purchase_item_id')->constrained('purchase_items')->cascadeOnDelete();
            $table->foreignId('material_variant_id')->constrained('material_variants')->restrictOnDelete();
            $table->decimal('quantity_received', 12, 4);
            $table->decimal('converted_quantity', 12, 4);
            $table->decimal('unit_cost', 14, 4);
            $table->foreignId('inventory_movement_id')->nullable()->constrained('inventory_movements')->nullOnDelete();
            $table->timestamps();

            $table->index('purchase_reception_id');
            $table->index('purchase_item_id');
            $table->index('material_variant_id');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('purchase_reception_items');
    }
};
</file>

<file path="database/migrations/2026_01_05_000000_create_product_materials_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('product_materials', function (Blueprint $table) {
            $table->id();
            $table->foreignId('product_id')->constrained('products')->onDelete('cascade');
            // restrict evita que borren un hilo si ya está en una receta
            $table->foreignId('material_variant_id')->constrained('material_variants')->onDelete('restrict');

            // CANTIDAD: Lo que consume 1 unidad de producto
            $table->decimal('quantity', 12, 4);

            // SNAPSHOT FINANCIERO: Guardamos el costo promedio al momento de crear la ficha
            // Esto permite saber cuánto costaba producir el producto hoy, aunque mañana suba el hilo.
            $table->decimal('unit_cost', 14, 4)->default(0);
            $table->decimal('total_cost', 14, 4)->storedAs('quantity * unit_cost');

            $table->boolean('is_primary')->default(false);
            $table->string('notes')->nullable();

            $table->softDeletes(); // Implementación de SoftDeletes
            $table->timestamps();

            // Índices para velocidad de reportes
            $table->index(['product_id', 'is_primary']);
            $table->index('deleted_at');
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('product_materials');
    }
};
</file>

<file path="database/migrations/2026_01_07_090609_add_active_for_variants_to_product_materials_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('product_materials', function (Blueprint $table) {
            $table->json('active_for_variants')->nullable()->after('quantity')->comment('Array of Variant UUIDs/IDs this material applies to. NULL = Global.');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('product_materials', function (Blueprint $table) {
            //
        });
    }
};
</file>

<file path="database/migrations/2026_01_07_144024_add_color_fields_to_images_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('images', function (Blueprint $table) {
            $table->string('dominant_color', 10)->nullable()->after('is_primary');
            $table->json('color_palette')->nullable()->after('dominant_color');
            $table->string('original_extension', 10)->nullable()->after('color_palette');
            $table->string('correct_extension', 10)->nullable()->after('original_extension');
            $table->json('metadata')->nullable()->after('correct_extension');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('images', function (Blueprint $table) {
            $table->dropColumn(['dominant_color', 'color_palette', 'original_extension', 'correct_extension', 'metadata']);
        });
    }
};
</file>

<file path="database/migrations/2026_01_08_083429_create_design_export_status_history_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('design_export_status_history', function (Blueprint $table) {
            $table->id();
            $table->foreignId('design_export_id')->constrained('design_exports')->onDelete('cascade');
            $table->string('previous_status')->nullable(); // null para creación inicial
            $table->string('new_status');
            $table->foreignId('changed_by')->constrained('users');
            $table->text('notes')->nullable();
            $table->timestamps();

            // Índice para búsquedas rápidas
            $table->index(['design_export_id', 'created_at']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('design_export_status_history');
    }
};
</file>

<file path="database/migrations/2026_01_11_192000_add_svg_content_to_design_exports_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('design_exports', function (Blueprint $table) {
            $table->longText('svg_content')->nullable()->after('notes');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('design_exports', function (Blueprint $table) {
            $table->dropColumn('svg_content');
        });
    }
};
</file>

<file path="database/migrations/2026_01_13_230014_create_material_price_history_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('material_price_history', function (Blueprint $table) {
            $table->id();
            $table->foreignId('material_id')->constrained()->onDelete('cascade');
            $table->decimal('old_price', 10, 2);
            $table->decimal('new_price', 10, 2);
            $table->foreignId('changed_by')->nullable()->constrained('users')->onDelete('set null');
            $table->string('reason')->nullable();
            $table->timestamps();

            $table->index(['material_id', 'created_at']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('material_price_history');
    }
};
</file>

<file path="database/migrations/2026_01_14_145627_add_pricing_fields_to_products_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('products', function (Blueprint $table) {
            // Precio base del producto (precio de venta final)
            $table->decimal('base_price', 15, 4)->nullable()->after('specifications');

            // Tiempo estimado de producción en días
            $table->unsignedInteger('production_lead_time')->nullable()->after('base_price');

            // Costo total de producción (materiales + bordados + mano obra + extras)
            $table->decimal('production_cost', 15, 4)->nullable()->after('production_lead_time');

            // Margen de ganancia aplicado (%)
            $table->decimal('profit_margin', 5, 2)->nullable()->after('production_cost');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('products', function (Blueprint $table) {
            $table->dropColumn(['base_price', 'production_lead_time', 'production_cost', 'profit_margin']);
        });
    }
};
</file>

<file path="database/migrations/2026_01_16_124902_refactor_material_schema.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        // 1. Agregar campos a la tabla materials
        Schema::table('materials', function (Blueprint $table) {
            $table->foreignId('base_unit_id')->nullable()->after('material_category_id')->constrained('units');
            $table->foreignId('consumption_unit_id')->nullable()->after('base_unit_id')->constrained('units');
            $table->decimal('conversion_factor', 10, 4)->default(1.0000)->after('consumption_unit_id');
            $table->boolean('has_color')->default(true)->after('description');
        });

        // 2. Migrar datos existentes
        $categories = DB::table('material_categories')->get();
        foreach ($categories as $cat) {
            DB::table('materials')
                ->where('material_category_id', $cat->id)
                ->update([
                    'base_unit_id' => $cat->base_unit_id,
                    'consumption_unit_id' => $cat->base_unit_id, // Default 1:1
                    'has_color' => $cat->has_color ?? true,
                    'conversion_factor' => 1.0
                ]);
        }

        // Make fields not nullable if desired, but we'll leave them nullable for flexibility unless strictly required.
        // Actually, for data integrity, base_unit_id SHOULD be required. But modifying column in existing table with data can be tricky if some rows weren't updated. 
        // Assuming all materials have a category, they are updated.

        // 3. Eliminar campos de material_categories
        Schema::table('material_categories', function (Blueprint $table) {
            // Drop foreign key first. Note: Name is usually table_column_foreign
            $table->dropForeign(['base_unit_id']);
            $table->dropColumn(['base_unit_id', 'has_color']);
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        // 1. Restaurar campos en material_categories
        Schema::table('material_categories', function (Blueprint $table) {
            $table->foreignId('base_unit_id')->nullable()->constrained('units')->restrictOnDelete();
            $table->boolean('has_color')->default(true);
        });

        // 2. Intentar restaurar datos (best effort)
        // Tomamos la unidad del primer material asociado a la categoría
        $categories = DB::table('material_categories')->get();
        foreach ($categories as $cat) {
            $firstMat = DB::table('materials')->where('material_category_id', $cat->id)->first();
            if ($firstMat) {
                DB::table('material_categories')
                    ->where('id', $cat->id)
                    ->update([
                        'base_unit_id' => $firstMat->base_unit_id,
                        'has_color' => $firstMat->has_color
                    ]);
            }
        }

        // 3. Eliminar campos de materials
        Schema::table('materials', function (Blueprint $table) {
            $table->dropForeign(['base_unit_id']);
            $table->dropForeign(['consumption_unit_id']);
            $table->dropColumn(['base_unit_id', 'consumption_unit_id', 'conversion_factor', 'has_color']);
        });
    }
};
</file>

<file path="database/migrations/2026_01_16_134950_create_category_unit_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('category_unit', function (Blueprint $table) {
            $table->id();
            $table->foreignId('material_category_id')->constrained('material_categories')->onDelete('cascade');
            $table->foreignId('unit_id')->constrained('units')->onDelete('cascade');
            $table->unique(['material_category_id', 'unit_id']); // Evitar duplicados
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('category_unit');
    }
};
</file>

<file path="database/migrations/2026_01_16_180000_add_unit_type_to_units_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;
use Illuminate\Support\Facades\DB;

/**
 * =============================================================================
 * MIGRACIÓN: EVOLUCIÓN DEL MODELO DE UNIDADES
 * =============================================================================
 *
 * PROPÓSITO:
 * Introducir campo `unit_type` para clasificación semántica explícita de unidades.
 *
 * TIPOS:
 * - canonical   : Unidad canónica de consumo (metro, litro, pieza)
 * - metric_pack : Presentación métrica derivada (rollo 25m, caja 100pz)
 * - logistic    : Unidad logística pura de compra (cono, saco, paquete)
 *
 * REGLAS DE BACKFILL:
 * - is_base = 1                              → canonical
 * - is_base = 0 AND compatible_base_unit_id  → metric_pack
 * - is_base = 0 AND NO compatible_base_unit  → logistic
 *
 * COMPATIBILIDAD:
 * - Campo `is_base` se mantiene como @deprecated (no se elimina)
 * - Sistema funcional durante toda la transición
 *
 * @see \App\Models\Unit
 * @see \App\Enums\UnitType (si se implementa Enum PHP)
 */
return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        // 1. Agregar columna unit_type
        Schema::table('units', function (Blueprint $table) {
            $table->enum('unit_type', ['canonical', 'metric_pack', 'logistic'])
                ->default('logistic')
                ->after('is_base')
                ->comment('Tipo semántico: canonical=consumo, metric_pack=presentación métrica, logistic=compra pura');
        });

        // 2. Backfill basado en datos existentes
        // Regla 1: is_base = true → canonical
        DB::table('units')
            ->where('is_base', true)
            ->update(['unit_type' => 'canonical']);

        // Regla 2: is_base = false AND compatible_base_unit_id IS NOT NULL → metric_pack
        DB::table('units')
            ->where('is_base', false)
            ->whereNotNull('compatible_base_unit_id')
            ->update(['unit_type' => 'metric_pack']);

        // Regla 3: is_base = false AND compatible_base_unit_id IS NULL → logistic (ya es default)
        DB::table('units')
            ->where('is_base', false)
            ->whereNull('compatible_base_unit_id')
            ->update(['unit_type' => 'logistic']);

        // 3. Agregar índice para performance en consultas filtradas
        Schema::table('units', function (Blueprint $table) {
            $table->index('unit_type');
        });

        // 4. Marcar is_base como deprecated en comentario de columna (si MySQL lo soporta)
        // Nota: Esto es informativo, el campo sigue funcional
        DB::statement("ALTER TABLE `units` MODIFY COLUMN `is_base` TINYINT(1) NOT NULL DEFAULT 0 COMMENT '@deprecated Use unit_type instead. Will be removed in future version.'");
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('units', function (Blueprint $table) {
            $table->dropIndex(['unit_type']);
            $table->dropColumn('unit_type');
        });

        // Restaurar comentario original de is_base
        DB::statement("ALTER TABLE `units` MODIFY COLUMN `is_base` TINYINT(1) NOT NULL DEFAULT 0 COMMENT 'true = unidad de consumo (metro, pieza)'");
    }
};
</file>

<file path="resources/views/admin/clientes/partials/measures.blade.php">
@php
    $hasMeasures =
        $cliente->busto || $cliente->alto_cintura || $cliente->cintura || $cliente->cadera || $cliente->largo;
@endphp

@if (!$hasMeasures)
    <div class="alert alert-info text-center">
        <i class="fas fa-info-circle"></i> No hay medidas registradas para este cliente.
    </div>
@else
    <div class="row">
        {{-- BUSTO --}}
        <div class="col-md-6 mb-4 text-center">
            <h6 class="font-weight-bold text-uppercase">Busto</h6>
            <div class="p-3 border rounded bg-white shadow-sm">
                <img src="{{ asset('images/busto.png') }}" alt="Busto" class="img-fluid mb-2" style="max-height: 150px;">
                <h5 class="text-primary font-weight-bold m-0">{{ $cliente->busto ?? '--' }} cm</h5>
            </div>
        </div>

        {{-- ALTO CINTURA --}}
        <div class="col-md-6 mb-4 text-center">
            <h6 class="font-weight-bold text-uppercase">Alto Cintura</h6>
            <div class="p-3 border rounded bg-white shadow-sm">
                <img src="{{ asset('images/alto_cintura.png') }}" alt="Alto Cintura" class="img-fluid mb-2"
                    style="max-height: 150px;">
                <h5 class="text-primary font-weight-bold m-0">{{ $cliente->alto_cintura ?? '--' }} cm</h5>
            </div>
        </div>

        {{-- CINTURA --}}
        <div class="col-md-6 mb-4 text-center">
            <h6 class="font-weight-bold text-uppercase">Cintura</h6>
            <div class="p-3 border rounded bg-white shadow-sm">
                <img src="{{ asset('images/cintura.png') }}" alt="Cintura" class="img-fluid mb-2"
                    style="max-height: 150px;">
                <h5 class="text-primary font-weight-bold m-0">{{ $cliente->cintura ?? '--' }} cm</h5>
            </div>
        </div>

        {{-- CADERA --}}
        <div class="col-md-6 mb-4 text-center">
            <h6 class="font-weight-bold text-uppercase">Cadera</h6>
            <div class="p-3 border rounded bg-white shadow-sm">
                <img src="{{ asset('images/cadera.png') }}" alt="Cadera" class="img-fluid mb-2"
                    style="max-height: 150px;">
                <h5 class="text-primary font-weight-bold m-0">{{ $cliente->cadera ?? '--' }} cm</h5>
            </div>
        </div>

        {{-- LARGO --}}
        <div class="col-md-6 mb-4 text-center mx-auto">
            <h6 class="font-weight-bold text-uppercase">Largo</h6>
            <div class="p-3 border rounded bg-white shadow-sm">
                <img src="{{ asset('images/largo.png') }}" alt="Largo" class="img-fluid mb-2"
                    style="max-height: 150px;">
                <h5 class="text-primary font-weight-bold m-0">{{ $cliente->largo ?? '--' }} cm</h5>
            </div>
        </div>
    </div>
@endif
</file>

<file path="resources/views/admin/design-variants/exports/create.blade.php">
@extends('adminlte::page')

@section('title', 'Crear Exportación para Variante')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1>
            <i class="fas fa-file-export text-primary mr-2"></i>
            Nueva Exportación de Bordado
        </h1>
        <a href="{{ route('admin.designs.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-1"></i> Volver a Diseños
        </a>
    </div>
@stop

@section('content')
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-plus-circle mr-1"></i>
                            Exportación para variante: <strong>{{ $variant->name }}</strong>
                            <small class="text-muted">({{ $design->name }})</small>
                        </h3>
                    </div>
                    <form action="{{ route('admin.variants.exports.store', ['design' => $design->id, 'variant' => $variant->id]) }}"
                        method="POST" enctype="multipart/form-data" id="exportForm">
                        @csrf
                        <div class="card-body">
                            {{-- Errores de validación --}}
                            @if ($errors->any())
                                <div class="alert alert-danger alert-dismissible fade show">
                                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                                    <h5><i class="icon fas fa-ban"></i> Error de validación</h5>
                                    <ul class="mb-0">
                                        @foreach ($errors->all() as $error)
                                            <li>{{ $error }}</li>
                                        @endforeach
                                    </ul>
                                </div>
                            @endif

                            <div class="row">
                                <div class="col-md-6">
                                    {{-- Tipo de Aplicación (Select dinámico) --}}
                                    <div class="form-group">
                                        <label for="application_type">
                                            <i class="fas fa-tag mr-1"></i> Tipo de Aplicación
                                            <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-control @error('application_type') is-invalid @enderror"
                                            id="application_type" name="application_type" required>
                                            <option value="">-- Seleccione un tipo --</option>
                                            @foreach ($applicationTypes as $tipo)
                                                <option value="{{ $tipo->slug }}"
                                                    {{ old('application_type') == $tipo->slug ? 'selected' : '' }}>
                                                    {{ $tipo->nombre_aplicacion }}
                                                </option>
                                            @endforeach
                                        </select>
                                        @error('application_type')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                        <small class="form-text text-muted">
                                            Ubicación donde se aplicará el bordado (pecho, espalda, manga, etc.)
                                        </small>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    {{-- Etiqueta de Aplicación --}}
                                    <div class="form-group">
                                        <label for="application_label">
                                            <i class="fas fa-bookmark mr-1"></i> Etiqueta / Nombre
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text"
                                            class="form-control @error('application_label') is-invalid @enderror"
                                            id="application_label" name="application_label"
                                            value="{{ old('application_label') }}" required
                                            placeholder="Ej: Logo frontal pequeño">
                                        @error('application_label')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                        <small class="form-text text-muted">
                                            Nombre descriptivo para identificar esta exportación
                                        </small>
                                    </div>
                                </div>
                            </div>

                            {{-- Descripción de ubicación --}}
                            <div class="form-group">
                                <label for="placement_description">
                                    <i class="fas fa-map-marker-alt mr-1"></i> Descripción de Ubicación
                                </label>
                                <input type="text"
                                    class="form-control @error('placement_description') is-invalid @enderror"
                                    id="placement_description" name="placement_description"
                                    value="{{ old('placement_description') }}"
                                    placeholder="Ej: Centrado a 5cm del cuello, lado izquierdo">
                                @error('placement_description')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">
                                    Detalles adicionales sobre la posición exacta (opcional)
                                </small>
                            </div>

                            {{-- Archivo de Bordado --}}
                            <div class="form-group">
                                <label for="file">
                                    <i class="fas fa-file-upload mr-1"></i> Archivo de Bordado
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input @error('file') is-invalid @enderror"
                                        id="file" name="file" accept=".pes,.dst,.exp,.jef,.vip,.vp3,.xxx" required>
                                    <label class="custom-file-label" for="file" data-browse="Buscar">
                                        Seleccionar archivo...
                                    </label>
                                </div>
                                @error('file')
                                    <div class="invalid-feedback d-block">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Formatos permitidos: <strong>PES, DST, EXP, JEF, VIP, VP3, XXX</strong> (máx. 10MB)
                                </small>
                            </div>

                            {{-- Notas --}}
                            <div class="form-group">
                                <label for="notes">
                                    <i class="fas fa-sticky-note mr-1"></i> Notas adicionales
                                </label>
                                <textarea class="form-control @error('notes') is-invalid @enderror" id="notes" name="notes"
                                    rows="3" placeholder="Observaciones, instrucciones especiales...">{{ old('notes') }}</textarea>
                                @error('notes')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save mr-1"></i> Guardar Exportación
                            </button>
                            <a href="{{ route('admin.designs.index') }}" class="btn btn-default">
                                <i class="fas fa-times mr-1"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            {{-- Panel lateral con info de la variante --}}
            <div class="col-md-4">
                <div class="card card-info card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-layer-group mr-1"></i> Variante
                        </h3>
                    </div>
                    <div class="card-body text-center">
                        @php
                            $variantImage = $variant->images()->orderBy('order')->first();
                        @endphp
                        @if ($variantImage)
                            <img src="{{ asset('storage/' . $variantImage->file_path) }}"
                                alt="{{ $variant->name }}" class="img-fluid rounded mb-3"
                                style="max-height: 200px; object-fit: contain;">
                        @elseif ($design->primaryImage)
                            <img src="{{ asset('storage/' . $design->primaryImage->file_path) }}"
                                alt="{{ $design->name }}" class="img-fluid rounded mb-3"
                                style="max-height: 200px; object-fit: contain; opacity: 0.6;">
                            <p class="text-muted small">Imagen del diseño principal</p>
                        @else
                            <div class="text-muted py-4">
                                <i class="fas fa-image fa-3x mb-2"></i>
                                <p>Sin imagen</p>
                            </div>
                        @endif
                        <h5>{{ $variant->name }}</h5>
                        <p class="text-muted small">
                            Diseño: {{ $design->name }} ({{ $design->code }})
                        </p>
                        @if ($variant->description)
                            <p class="small">{{ Str::limit($variant->description, 100) }}</p>
                        @endif
                    </div>
                </div>

                {{-- Info de formatos --}}
                <div class="card card-secondary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-question-circle mr-1"></i> Formatos de Bordado
                        </h3>
                    </div>
                    <div class="card-body small">
                        <ul class="list-unstyled mb-0">
                            <li><strong>.PES</strong> - Brother/Babylock</li>
                            <li><strong>.DST</strong> - Tajima</li>
                            <li><strong>.EXP</strong> - Melco</li>
                            <li><strong>.JEF</strong> - Janome</li>
                            <li><strong>.VIP/.VP3</strong> - Pfaff/Viking</li>
                            <li><strong>.XXX</strong> - Singer</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        .custom-file-label::after {
            content: "Buscar";
        }
    </style>
@stop

@section('js')
    <script>
        $(document).ready(function() {
            // Mostrar nombre del archivo seleccionado
            $('.custom-file-input').on('change', function() {
                let fileName = $(this).val().split('\\').pop();
                $(this).next('.custom-file-label').addClass("selected").html(fileName);
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/design-variants/index.blade.php">

</file>

<file path="resources/views/admin/designs/delete.blade.php">

</file>

<file path="resources/views/admin/designs/exports/create.blade.php">
@extends('adminlte::page')

@section('title', 'Crear Exportación para Diseño')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <h1>
            <i class="fas fa-file-export text-primary mr-2"></i>
            Nueva Exportación de Bordado
        </h1>
        <a href="{{ route('admin.designs.index') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left mr-1"></i> Volver a Diseños
        </a>
    </div>
@stop

@section('content')
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <div class="card card-primary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-plus-circle mr-1"></i>
                            Exportación para: <strong>{{ $design->name }}</strong>
                        </h3>
                    </div>
                    <form action="{{ route('admin.designs.exports.store', $design->id) }}" method="POST"
                        enctype="multipart/form-data" id="exportForm">
                        @csrf
                        <div class="card-body">
                            {{-- Errores de validación --}}
                            @if ($errors->any())
                                <div class="alert alert-danger alert-dismissible fade show">
                                    <button type="button" class="close" data-dismiss="alert">&times;</button>
                                    <h5><i class="icon fas fa-ban"></i> Error de validación</h5>
                                    <ul class="mb-0">
                                        @foreach ($errors->all() as $error)
                                            <li>{{ $error }}</li>
                                        @endforeach
                                    </ul>
                                </div>
                            @endif

                            <div class="row">
                                <div class="col-md-6">
                                    {{-- Tipo de Aplicación (Select dinámico) --}}
                                    <div class="form-group">
                                        <label for="application_type">
                                            <i class="fas fa-tag mr-1"></i> Tipo de Aplicación
                                            <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-control @error('application_type') is-invalid @enderror"
                                            id="application_type" name="application_type" required>
                                            <option value="">-- Seleccione un tipo --</option>
                                            @foreach ($applicationTypes as $tipo)
                                                <option value="{{ $tipo->slug }}"
                                                    {{ old('application_type') == $tipo->slug ? 'selected' : '' }}>
                                                    {{ $tipo->nombre_aplicacion }}
                                                </option>
                                            @endforeach
                                        </select>
                                        @error('application_type')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                        <small class="form-text text-muted">
                                            Ubicación donde se aplicará el bordado (pecho, espalda, manga, etc.)
                                        </small>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    {{-- Etiqueta de Aplicación --}}
                                    <div class="form-group">
                                        <label for="application_label">
                                            <i class="fas fa-bookmark mr-1"></i> Etiqueta / Nombre
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text"
                                            class="form-control @error('application_label') is-invalid @enderror"
                                            id="application_label" name="application_label"
                                            value="{{ old('application_label') }}" required
                                            placeholder="Ej: Logo frontal pequeño">
                                        @error('application_label')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                        <small class="form-text text-muted">
                                            Nombre descriptivo para identificar esta exportación
                                        </small>
                                    </div>
                                </div>
                            </div>

                            {{-- Descripción de ubicación --}}
                            <div class="form-group">
                                <label for="placement_description">
                                    <i class="fas fa-map-marker-alt mr-1"></i> Descripción de Ubicación
                                </label>
                                <input type="text"
                                    class="form-control @error('placement_description') is-invalid @enderror"
                                    id="placement_description" name="placement_description"
                                    value="{{ old('placement_description') }}"
                                    placeholder="Ej: Centrado a 5cm del cuello, lado izquierdo">
                                @error('placement_description')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">
                                    Detalles adicionales sobre la posición exacta (opcional)
                                </small>
                            </div>

                            {{-- Archivo de Bordado --}}
                            <div class="form-group">
                                <label for="file">
                                    <i class="fas fa-file-upload mr-1"></i> Archivo de Bordado
                                    <span class="text-danger">*</span>
                                </label>
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input @error('file') is-invalid @enderror"
                                        id="file" name="file" accept=".pes,.dst,.exp,.jef,.vip,.vp3,.xxx" required>
                                    <label class="custom-file-label" for="file" data-browse="Buscar">
                                        Seleccionar archivo...
                                    </label>
                                </div>
                                @error('file')
                                    <div class="invalid-feedback d-block">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Formatos permitidos: <strong>PES, DST, EXP, JEF, VIP, VP3, XXX</strong> (máx. 10MB)
                                </small>
                            </div>

                            {{-- Notas --}}
                            <div class="form-group">
                                <label for="notes">
                                    <i class="fas fa-sticky-note mr-1"></i> Notas adicionales
                                </label>
                                <textarea class="form-control @error('notes') is-invalid @enderror" id="notes" name="notes"
                                    rows="3" placeholder="Observaciones, instrucciones especiales...">{{ old('notes') }}</textarea>
                                @error('notes')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save mr-1"></i> Guardar Exportación
                            </button>
                            <a href="{{ route('admin.designs.index') }}" class="btn btn-default">
                                <i class="fas fa-times mr-1"></i> Cancelar
                            </a>
                        </div>
                    </form>
                </div>
            </div>

            {{-- Panel lateral con info del diseño --}}
            <div class="col-md-4">
                <div class="card card-info card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-palette mr-1"></i> Diseño
                        </h3>
                    </div>
                    <div class="card-body text-center">
                        @if ($design->primaryImage)
                            <img src="{{ asset('storage/' . $design->primaryImage->file_path) }}"
                                alt="{{ $design->name }}" class="img-fluid rounded mb-3"
                                style="max-height: 200px; object-fit: contain;">
                        @else
                            <div class="text-muted py-4">
                                <i class="fas fa-image fa-3x mb-2"></i>
                                <p>Sin imagen</p>
                            </div>
                        @endif
                        <h5>{{ $design->name }}</h5>
                        <p class="text-muted small">{{ $design->code }}</p>
                        @if ($design->description)
                            <p class="small">{{ Str::limit($design->description, 100) }}</p>
                        @endif
                    </div>
                </div>

                {{-- Info de formatos --}}
                <div class="card card-secondary card-outline">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-question-circle mr-1"></i> Formatos de Bordado
                        </h3>
                    </div>
                    <div class="card-body small">
                        <ul class="list-unstyled mb-0">
                            <li><strong>.PES</strong> - Brother/Babylock</li>
                            <li><strong>.DST</strong> - Tajima</li>
                            <li><strong>.EXP</strong> - Melco</li>
                            <li><strong>.JEF</strong> - Janome</li>
                            <li><strong>.VIP/.VP3</strong> - Pfaff/Viking</li>
                            <li><strong>.XXX</strong> - Singer</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        .custom-file-label::after {
            content: "Buscar";
        }
    </style>
@stop

@section('js')
    <script>
        $(document).ready(function() {
            // Mostrar nombre del archivo seleccionado
            $('.custom-file-input').on('change', function() {
                let fileName = $(this).val().split('\\').pop();
                $(this).next('.custom-file-label').addClass("selected").html(fileName);
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/material-categories/units.blade.php">
@extends('adminlte::page')

@section('title', 'Unidades por Categoría')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info', 'warning'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-link"></i> UNIDADES PERMITIDAS POR CATEGORÍA
            </h3>
        </div>

        <div class="card-body">
            {{-- INFORMACIÓN DEL MÓDULO --}}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <strong><i class="fas fa-info-circle"></i> Configuración de Reglas de Dominio</strong>
                <p class="mb-0 mt-2">
                    Define qué <strong>unidades de compra/empaque</strong> están permitidas para cada categoría de material.
                    <br>
                    <small class="text-muted">
                        Solo las unidades asignadas aquí aparecerán disponibles al crear/editar materiales de cada
                        categoría.
                    </small>
                </p>
                <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
            </div>

            <div class="row mb-3">
                <div class="col-12">
                    <a href="{{ route('admin.material-categories.index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Categorías
                    </a>
                </div>
            </div>
            <hr>

            {{-- TABLA DE CATEGORÍAS CON UNIDADES --}}
            <div class="table-responsive">
                <table class="table table-bordered table-hover" id="categoriesTable">
                    <thead class="thead-dark text-center">
                        <tr>
                            <th style="width: 5%;">#</th>
                            <th style="width: 20%;">Categoría</th>
                            <th style="width: 25%;">Descripción</th>
                            <th style="width: 30%;">Unidades de Compra Permitidas</th>
                            <th style="width: 10%;">Materiales</th>
                            <th style="width: 10%;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @forelse ($categories as $category)
                            <tr data-category-id="{{ $category->id }}">
                                <td class="text-center align-middle">{{ $loop->iteration }}</td>
                                <td class="align-middle">
                                    <strong style="font-size: 1.1rem;">{{ $category->name }}</strong>
                                </td>
                                <td class="align-middle">
                                    @if ($category->description)
                                        <span style="font-size: 1rem;">{{ $category->description }}</span>
                                    @else
                                        <span class="text-muted font-italic">Sin descripción</span>
                                    @endif
                                </td>
                                <td class="units-cell" data-category-id="{{ $category->id }}">
                                    @if ($category->allowedUnits->isEmpty())
                                        <span class="badge badge-warning">
                                            <i class="fas fa-exclamation-triangle"></i> Sin unidades asignadas
                                        </span>
                                    @else
                                        <div class="d-flex flex-wrap gap-1" id="units-container-{{ $category->id }}">
                                            @foreach ($category->allowedUnits as $unit)
                                                @php
                                                    $materialsUsing = \App\Models\Material::where(
                                                        'material_category_id',
                                                        $category->id,
                                                    )
                                                        ->where('base_unit_id', $unit->id)
                                                        ->where('activo', true)
                                                        ->count();
                                                    $canRemove = $materialsUsing === 0;
                                                @endphp
                                                <span class="badge badge-primary unit-badge mr-1 mb-1"
                                                    data-unit-id="{{ $unit->id }}"
                                                    data-materials-using="{{ $materialsUsing }}"
                                                    style="font-size: 0.9rem; padding: 8px 12px;">
                                                    {{ $unit->name }}
                                                    <small>({{ $unit->symbol }})</small>
                                                    @if ($materialsUsing > 0)
                                                        <span class="badge badge-light ml-1"
                                                            title="{{ $materialsUsing }} material(es) usando esta unidad">
                                                            {{ $materialsUsing }}
                                                        </span>
                                                    @endif
                                                    @if ($canRemove && $category->allowedUnits->count() > 1)
                                                        <button type="button" class="btn btn-xs btn-remove-unit ml-1"
                                                            data-category-id="{{ $category->id }}"
                                                            data-unit-id="{{ $unit->id }}"
                                                            data-unit-name="{{ $unit->name }}" title="Quitar unidad"
                                                            style="background: none; border: none; color: #fff; padding: 0 4px;">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    @endif
                                                </span>
                                            @endforeach
                                        </div>
                                    @endif
                                </td>
                                <td class="text-center align-middle">
                                    <span class="badge badge-info" style="font-size: 1rem;">
                                        {{ $category->materials_count }}
                                    </span>
                                </td>
                                <td class="text-center align-middle">
                                    <button type="button" class="btn btn-success btn-sm btn-add-unit"
                                        data-category-id="{{ $category->id }}" data-category-name="{{ $category->name }}"
                                        title="Agregar unidad">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </td>
                            </tr>
                        @empty
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    No hay categorías de materiales registradas.
                                </td>
                            </tr>
                        @endforelse
                    </tbody>
                </table>
            </div>

            {{-- LEYENDA --}}
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <small>
                                <strong>Leyenda:</strong>
                                <span class="badge badge-primary mr-2">Unidad asignada</span>
                                <span class="badge badge-light border mr-2">N</span> = Materiales usando esta unidad
                                <span class="text-danger ml-3"><i class="fas fa-lock"></i></span> = No se puede eliminar
                                (tiene materiales asociados)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{-- MODAL PARA AGREGAR UNIDAD --}}
    <div class="modal fade" id="addUnitModal" tabindex="-1" role="dialog" aria-labelledby="addUnitModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content shadow-lg" style="border-radius: 15px; border: none;">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title font-weight-bold" id="addUnitModalLabel">
                        <i class="fas fa-plus-circle"></i> Agregar Unidad de Compra
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modal-category-id">
                    <div class="form-group">
                        <label class="font-weight-bold">Categoría:</label>
                        <p id="modal-category-name" class="form-control-plaintext font-weight-bold text-primary"></p>
                    </div>
                    <div class="form-group">
                        <label for="modal-unit-select" class="font-weight-bold">
                            Seleccionar Unidad de Compra: <span class="text-danger">*</span>
                        </label>
                        <select id="modal-unit-select" class="form-control">
                            <option value="">Cargando unidades disponibles...</option>
                        </select>
                        <small class="text-muted">Solo se muestran unidades de compra/empaque no asignadas.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-success" id="btn-confirm-add-unit">
                        <i class="fas fa-check"></i> Agregar Unidad
                    </button>
                </div>
            </div>
        </div>
    </div>

    {{-- MODAL DE CONFIRMACIÓN PARA ELIMINAR --}}
    <div class="modal fade" id="removeUnitModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content shadow-lg" style="border-radius: 15px; border: none;">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title font-weight-bold">
                        <i class="fas fa-exclamation-triangle"></i> Confirmar Eliminación
                    </h5>
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-center">
                    <input type="hidden" id="remove-category-id">
                    <input type="hidden" id="remove-unit-id">
                    <p class="mb-0">
                        ¿Está seguro de quitar la unidad <strong id="remove-unit-name"></strong>?
                    </p>
                    <small class="text-muted">Esta acción solo desvincula la unidad de la categoría.</small>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" id="btn-confirm-remove-unit">
                        <i class="fas fa-trash"></i> Sí, Quitar
                    </button>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        .unit-badge {
            display: inline-flex;
            align-items: center;
        }

        .btn-remove-unit:hover {
            color: #ffc107 !important;
        }

        .units-cell .badge {
            transition: all 0.2s ease;
        }

        .units-cell .badge:hover {
            transform: scale(1.05);
        }

        #categoriesTable tbody tr:hover {
            background-color: #f8f9fa;
        }

        .gap-1 {
            gap: 0.25rem;
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            // =====================================================
            // AGREGAR UNIDAD
            // =====================================================
            $('.btn-add-unit').on('click', function() {
                var categoryId = $(this).data('category-id');
                var categoryName = $(this).data('category-name');

                $('#modal-category-id').val(categoryId);
                $('#modal-category-name').text(categoryName);

                // Cargar unidades disponibles
                var $select = $('#modal-unit-select');
                $select.html('<option value="">Cargando...</option>').prop('disabled', true);

                $.ajax({
                    url: '/admin/material-categories/' + categoryId + '/available-units',
                    type: 'GET',
                    success: function(response) {
                        $select.empty();
                        if (response.units && response.units.length > 0) {
                            $select.append('<option value="">Seleccionar unidad...</option>');
                            $.each(response.units, function(i, unit) {
                                $select.append(
                                    '<option value="' + unit.id + '">' +
                                    unit.name + ' (' + unit.symbol + ')' +
                                    '</option>'
                                );
                            });
                            $select.prop('disabled', false);
                        } else {
                            $select.html(
                                '<option value="">No hay unidades disponibles</option>');
                        }
                    },
                    error: function() {
                        $select.html('<option value="">Error al cargar unidades</option>');
                    }
                });

                $('#addUnitModal').modal('show');
            });

            // Confirmar agregar unidad
            $('#btn-confirm-add-unit').on('click', function() {
                var categoryId = $('#modal-category-id').val();
                var unitId = $('#modal-unit-select').val();

                if (!unitId) {
                    alert('Debe seleccionar una unidad.');
                    return;
                }

                var $btn = $(this);
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');

                $.ajax({
                    url: '/admin/material-categories/' + categoryId + '/units',
                    type: 'POST',
                    data: {
                        unit_id: unitId,
                        _token: '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            // Recargar la página para mostrar los cambios
                            location.reload();
                        } else {
                            alert(response.message || 'Error al agregar la unidad.');
                            $btn.prop('disabled', false).html(
                                '<i class="fas fa-check"></i> Agregar Unidad');
                        }
                    },
                    error: function(xhr) {
                        var msg = xhr.responseJSON?.message || 'Error al agregar la unidad.';
                        alert(msg);
                        $btn.prop('disabled', false).html(
                            '<i class="fas fa-check"></i> Agregar Unidad');
                    }
                });
            });

            // =====================================================
            // ELIMINAR UNIDAD
            // =====================================================
            $(document).on('click', '.btn-remove-unit', function() {
                var categoryId = $(this).data('category-id');
                var unitId = $(this).data('unit-id');
                var unitName = $(this).data('unit-name');

                $('#remove-category-id').val(categoryId);
                $('#remove-unit-id').val(unitId);
                $('#remove-unit-name').text(unitName);

                $('#removeUnitModal').modal('show');
            });

            // Confirmar eliminar unidad
            $('#btn-confirm-remove-unit').on('click', function() {
                var categoryId = $('#remove-category-id').val();
                var unitId = $('#remove-unit-id').val();

                var $btn = $(this);
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Eliminando...');

                $.ajax({
                    url: '/admin/material-categories/' + categoryId + '/units/' + unitId,
                    type: 'DELETE',
                    data: {
                        _token: '{{ csrf_token() }}'
                    },
                    success: function(response) {
                        if (response.success) {
                            // Recargar la página
                            location.reload();
                        } else {
                            alert(response.message || 'Error al eliminar la unidad.');
                            $btn.prop('disabled', false).html(
                                '<i class="fas fa-trash"></i> Sí, Quitar');
                            $('#removeUnitModal').modal('hide');
                        }
                    },
                    error: function(xhr) {
                        var msg = xhr.responseJSON?.message || 'Error al eliminar la unidad.';
                        alert(msg);
                        $btn.prop('disabled', false).html(
                            '<i class="fas fa-trash"></i> Sí, Quitar');
                        $('#removeUnitModal').modal('hide');
                    }
                });
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/partials/footer.blade.php">
<footer class="h-12 bg-white border-t flex items-center justify-center text-xs text-gray-500">
    © {{ date('Y') }} Sistema de Bordados · Panel Administrativo
</footer>
</file>

<file path="resources/views/admin/partials/navbar.blade.php">
<header class="h-16 bg-white border-b flex items-center justify-between px-6">

    <!-- TÍTULO -->
    <h1 class="text-lg font-semibold">
        @yield('header', 'Dashboard')
    </h1>

    <!-- ACCIONES -->
    <div class="flex items-center gap-4">

        <span class="text-sm text-gray-600">
            {{ auth()->user()->name ?? 'Administrador' }}
        </span>

        <form method="POST" action="{{ route('logout') }}">
            @csrf
            <button class="text-red-500 hover:text-red-700 transition">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </form>

    </div>
</header>
</file>

<file path="resources/views/admin/partials/sidebar.blade.php">
<aside class="w-64 bg-white border-r shadow-sm">

    <!-- LOGO -->
    <div class="h-16 flex items-center justify-center border-b">
        <span class="text-xl font-bold tracking-wide">BORDADOS</span>
    </div>

    <!-- MENÚ -->
    <nav class="p-4 space-y-2 text-sm">

        <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
            <i class="fas fa-palette"></i>
            Diseños
        </a>

        <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
            <i class="fas fa-folder"></i>
            Categorías
        </a>

        <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
            <i class="fas fa-search"></i>
            Buscar diseños
        </a>

    </nav>

</aside>
</file>

<file path="resources/views/admin/products/delete.blade.php">

</file>

<file path="resources/views/admin/products/edit.blade.php">

</file>

<file path="resources/views/admin/products/show.blade.php">
{{-- resources/views/admin/products/show.blade.php --}}
@extends('adminlte::page')

@section('title', 'Detalle del Producto')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary" bis_skin_checked="1">
        <div class="card-header" bis_skin_checked="1">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                    DETALLE DEL PRODUCTO: {{ $product->name }}
                </h3>
                <div class="btn-group">
                    <a href="{{ route('products.index') }}" class="btn btn-default btn-sm">
                        <i class="fas fa-arrow-left mr-1"></i> Volver
                    </a>
                    <a href="{{ route('products.edit', $product->id) }}" class="btn btn-warning btn-sm">
                        <i class="fas fa-edit mr-1"></i> Editar
                    </a>
                    @if ($product->canDelete())
                        <a href="{{ route('products.confirm_delete', $product->id) }}" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash mr-1"></i> Eliminar
                        </a>
                    @endif
                    @if ($product->status === 'active')
                        <form action="{{ route('products.toggle_status', $product->id) }}" method="POST" class="d-inline"
                            data-confirm="¿Cambiar a descontinuado?">
                            @csrf
                            <button type="submit" class="btn btn-secondary btn-sm">
                                <i class="fas fa-ban mr-1"></i> Descontinuar
                            </button>
                        </form>
                    @elseif($product->status === 'discontinued')
                        <form action="{{ route('products.toggle_status', $product->id) }}" method="POST" class="d-inline"
                            data-confirm="¿Activar producto?">
                            @csrf
                            <button type="submit" class="btn btn-success btn-sm">
                                <i class="fas fa-check mr-1"></i> Activar
                            </button>
                        </form>
                    @endif
                    <form action="{{ route('products.duplicate', $product->id) }}" method="POST" class="d-inline"
                        data-confirm="¿Duplicar este producto?">
                        @csrf
                        <button type="submit" class="btn btn-info btn-sm">
                            <i class="fas fa-copy mr-1"></i> Duplicar
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <!-- /.card-header -->

        <div class="card-body" bis_skin_checked="1">
            <!-- Mensajes de éxito/error -->
            @if (session('success'))
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {{ session('success') }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            @endif

            @if (session('error'))
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {{ session('error') }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            @endif

            <div class="row">
                <!-- Columna izquierda: Información principal -->
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-box bg-light">
                                <span class="info-box-icon bg-info"><i class="fas fa-barcode"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">SKU</span>
                                    <span class="info-box-number">{{ $product->sku }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="info-box bg-light">
                                <span class="info-box-icon bg-{{ $product->status_color }}">
                                    <i
                                        class="fas fa-{{ $product->status === 'active' ? 'check' : ($product->status === 'draft' ? 'file' : 'ban') }}"></i>
                                </span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Estado</span>
                                    <span class="info-box-number">{{ $product->status_label }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="info-box bg-light">
                                <span class="info-box-icon bg-success"><i class="fas fa-tags"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Categoría</span>
                                    <span class="info-box-number">{{ $product->category->name ?? 'Sin categoría' }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="info-box bg-light">
                                <span class="info-box-icon bg-warning"><i class="fas fa-dollar-sign"></i></span>
                                <div class="info-box-content">
                                    <span class="info-box-text">Precio Base</span>
                                    <span class="info-box-number">{{ $product->formatted_base_price }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Descripción -->
                    <div class="card card-outline card-info mt-3">
                        <div class="card-header">
                            <h3 class="card-title">Descripción</h3>
                        </div>
                        <div class="card-body">
                            {{ $product->description ?? 'Sin descripción' }}
                        </div>
                    </div>

                    <!-- Especificaciones -->
                    @if ($product->specifications && count($product->specifications) > 0)
                        <div class="card card-outline card-success mt-3">
                            <div class="card-header">
                                <h3 class="card-title">Especificaciones Técnicas</h3>
                            </div>
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th style="width: 40%">Característica</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach ($product->specifications as $key => $value)
                                            <tr>
                                                <td><strong>{{ $key }}</strong></td>
                                                <td>{{ $value }}</td>
                                            </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    @endif
                </div>

                <!-- Columna derecha: Imágenes y extras -->
                <div class="col-md-4">
                    <!-- Imagen principal -->
                    <div class="card card-outline card-primary">
                        <div class="card-header">
                            <h3 class="card-title">Imagen Principal</h3>
                        </div>
                        <div class="card-body text-center">
                            @if ($product->primary_image_url)
                                <img src="{{ asset($product->primary_image_url) }}" alt="{{ $product->name }}"
                                    class="img-fluid" style="max-height: 250px; object-fit: contain;">
                            @else
                                <div class="text-center py-5">
                                    <i class="fas fa-image fa-5x text-muted"></i>
                                    <p class="mt-2 text-muted">Sin imagen</p>
                                </div>
                            @endif
                        </div>
                    </div>

                    <!-- Extras -->
                    @if ($product->extras->count() > 0)
                        <div class="card card-outline card-warning mt-3">
                            <div class="card-header">
                                <h3 class="card-title">Extras Asociados</h3>
                            </div>
                            <div class="card-body">
                                <ul class="list-group list-group-flush">
                                    @foreach ($product->extras as $extra)
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ $extra->name }}
                                            <span
                                                class="badge badge-primary badge-pill">{{ $extra->formatted_price }}</span>
                                        </li>
                                    @endforeach
                                </ul>
                            </div>
                        </div>
                    @endif

                    <!-- Estadísticas -->
                    <div class="card card-outline card-secondary mt-3">
                        <div class="card-header">
                            <h3 class="card-title">Estadísticas</h3>
                        </div>
                        <div class="card-body">
                            <div class="small-box bg-info">
                                <div class="inner">
                                    <h3>{{ $product->variants_count }}</h3>
                                    <p>Variantes</p>
                                </div>
                                <div class="icon">
                                    <i class="fas fa-layer-group"></i>
                                </div>
                                <a href="#variants-section" class="small-box-footer">
                                    Ver variantes <i class="fas fa-arrow-circle-down"></i>
                                </a>
                            </div>

                            @if ($product->designs->count() > 0)
                                <div class="small-box bg-success mt-3">
                                    <div class="inner">
                                        <h3>{{ $product->designs->count() }}</h3>
                                        <p>Diseños Asociados</p>
                                    </div>
                                    <div class="icon">
                                        <i class="fas fa-palette"></i>
                                    </div>
                                </div>
                            @endif
                        </div>
                    </div>
                </div>
            </div>

            <!-- Diseños Asociados -->
            @if ($product->designs->count() > 0)
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card card-outline card-info">
                            <div class="card-header">
                                <h3 class="card-title">Diseños Asociados</h3>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    @foreach ($product->designs as $design)
                                        <div class="col-md-4 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <h5 class="card-title">{{ $design->name }}</h5>
                                                    <p class="card-text">
                                                        <strong>Código:</strong> {{ $design->code }}<br>
                                                        <strong>Puntadas:</strong> {{ $design->stitch_count ?? 'N/A' }}<br>
                                                        <strong>Tipo de Aplicación:</strong>
                                                        {{ $design->pivot->application_type_id ? $applicationTypes->firstWhere('id', $design->pivot->application_type_id)->nombre ?? 'N/A' : 'N/A' }}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    @endforeach
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            @endif

            <!-- Variantes del Producto -->
            <div class="row mt-4" id="variants-section">
                <div class="col-12">
                    <div class="card card-outline card-primary">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h3 class="card-title">Variantes del Producto</h3>
                            <a href="{{ route('products.variants.create', $product->id) }}"
                                class="btn btn-success btn-sm">
                                <i class="fas fa-plus mr-1"></i> Nueva Variante
                            </a>
                        </div>
                        <div class="card-body">
                            @if ($product->variants->count() > 0)
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>SKU Variante</th>
                                                <th>Atributos</th>
                                                <th>Precio</th>
                                                <th>Precio + Extras</th>
                                                <th>Alerta Stock</th>
                                                <th>Exportaciones</th>
                                                <th style="width: 120px;">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach ($product->variants as $variant)
                                                <tr>
                                                    <td>
                                                        <span class="badge badge-dark">{{ $variant->sku_variant }}</span>
                                                    </td>
                                                    <td>
                                                        @if ($variant->attributes->count() > 0)
                                                            <div class="d-flex flex-wrap gap-1">
                                                                @foreach ($variant->attributes as $attribute)
                                                                    <span class="badge badge-info">
                                                                        {{ $attribute->attribute->name ?? 'N/A' }}:
                                                                        {{ $attribute->value }}
                                                                    </span>
                                                                @endforeach
                                                            </div>
                                                        @else
                                                            <span class="text-muted">Sin atributos</span>
                                                        @endif
                                                    </td>
                                                    <td class="text-right font-weight-bold">
                                                        {{ $variant->formatted_price }}</td>
                                                    <td class="text-right font-weight-bold text-success">
                                                        {{ $variant->formatted_total_with_extras }}</td>
                                                    <td class="text-center">
                                                        <span
                                                            class="badge badge-{{ $variant->stock_alert > 0 ? 'warning' : 'secondary' }}">
                                                            {{ $variant->stock_alert }}
                                                        </span>
                                                    </td>
                                                    <td class="text-center">
                                                        <span
                                                            class="badge badge-secondary">{{ $variant->designExports->count() }}</span>
                                                    </td>
                                                    <td>
                                                        <div class="btn-group btn-group-sm">
                                                            <a href="#" class="btn btn-info" title="Ver">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                            <a href="{{ route('products.variants.edit', ['productId' => $product->id, 'variantId' => $variant->id]) }}"
                                                                class="btn btn-warning" title="Editar">
                                                                <i class="fas fa-edit"></i>
                                                            </a>
                                                            <form
                                                                action="{{ route('products.variants.destroy', ['productId' => $product->id, 'variantId' => $variant->id]) }}"
                                                                method="POST" class="d-inline"
                                                                data-confirm="¿Eliminar esta variante?">
                                                                @csrf
                                                                @method('DELETE')
                                                                <button type="submit" class="btn btn-danger"
                                                                    title="Eliminar">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </td>
                                                </tr>
                                            @endforeach
                                        </tbody>
                                    </table>
                                </div>
                            @else
                                <div class="text-center py-4">
                                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No hay variantes registradas</h5>
                                    <p class="text-muted">Crea la primera variante para este producto</p>
                                    <a href="{{ route('products.variants.create', $product->id) }}"
                                        class="btn btn-primary">
                                        <i class="fas fa-plus mr-1"></i> Crear Primera Variante
                                    </a>
                                </div>
                            @endif
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información de Auditoría -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card card-outline card-secondary">
                        <div class="card-header">
                            <h3 class="card-title">Información de Auditoría</h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <p><strong>Creado:</strong><br>
                                        {{ $product->created_at->format('d/m/Y H:i:s') }}<br>
                                        <small class="text-muted">{{ $product->created_at->diffForHumans() }}</small>
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <p><strong>Actualizado:</strong><br>
                                        {{ $product->updated_at->format('d/m/Y H:i:s') }}<br>
                                        <small class="text-muted">{{ $product->updated_at->diffForHumans() }}</small>
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <p><strong>UUID:</strong><br>
                                        <code>{{ $product->uuid }}</code>
                                    </p>
                                </div>
                                <div class="col-md-3">
                                    <p><strong>Tenant ID:</strong><br>
                                        {{ $product->tenant_id }}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /.card-body -->

        <div class="card-footer" bis_skin_checked="1">
            <div class="row">
                <div class="col-md-6">
                    <a href="{{ route('products.index') }}" class="btn btn-default">
                        <i class="fas fa-arrow-left mr-1"></i> Volver al Listado
                    </a>
                </div>
                <div class="col-md-6 text-right">
                    <div class="btn-group">
                        <a href="{{ route('products.edit', $product->id) }}" class="btn btn-warning">
                            <i class="fas fa-edit mr-1"></i> Editar Producto
                        </a>
                        @if ($product->canDelete())
                            <a href="{{ route('products.confirm_delete', $product->id) }}" class="btn btn-danger">
                                <i class="fas fa-trash mr-1"></i> Eliminar Producto
                            </a>
                        @endif
                    </div>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        .info-box {
            margin-bottom: 15px;
            box-shadow: 0 0 1px rgba(0, 0, 0, .125), 0 1px 3px rgba(0, 0, 0, .2);
            border-radius: .25rem;
        }

        .small-box {
            border-radius: .25rem;
            position: relative;
            display: block;
            margin-bottom: 20px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
        }

        .small-box>.inner {
            padding: 10px;
        }

        .small-box .icon {
            position: absolute;
            top: -10px;
            right: 10px;
            z-index: 0;
            font-size: 70px;
            color: rgba(0, 0, 0, 0.15);
        }

        .gap-1 {
            gap: 0.25rem;
        }
    </style>
@stop

@section('js')
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function() {
            // SweetAlert para confirmaciones
            $(document).on('submit', 'form[data-confirm]', function(e) {
                e.preventDefault();
                var form = this;

                Swal.fire({
                    title: '¿Estás seguro?',
                    text: $(this).data('confirm'),
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí, continuar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                });
            });

            // Scroll suave a la sección de variantes
            $('a[href="#variants-section"]').click(function(e) {
                e.preventDefault();
                $('html, body').animate({
                    scrollTop: $("#variants-section").offset().top - 20
                }, 500);
            });

            // Auto-ocultar alertas después de 5 segundos
            setTimeout(function() {
                $('.alert').fadeOut('slow');
            }, 5000);
        });
    </script>
@stop
</file>

<file path="resources/views/admin/purchases/partials/table_rows.blade.php">
@forelse ($purchases as $purchase)
    <tr>
        <td>
            <a href="{{ route('admin.purchases.show', $purchase->id) }}" class="font-weight-bold">
                {{ $purchase->purchase_number }}
            </a>
            @if ($purchase->reference)
                <br><small class="text-muted">Ref: {{ $purchase->reference }}</small>
            @endif
        </td>
        <td>
            {{ $purchase->proveedor->nombre_proveedor ?? 'N/A' }}
        </td>
        <td>
            {{ $purchase->ordered_at ? $purchase->ordered_at->format('d/m/Y') : '-' }}

            @if ($purchase->expected_at)
                @php
                    $orderDate = $purchase->ordered_at ? $purchase->ordered_at->format('d/m/Y') : '';
                    $expectedDate = $purchase->expected_at->format('d/m/Y');
                    $isOverdue =
                        $purchase->expected_at->startOfDay()->lt(now()->startOfDay()) && $purchase->can_receive;
                @endphp

                @if ($expectedDate !== $orderDate || $isOverdue)
                    <br>
                    <small class="{{ $isOverdue ? 'text-danger font-weight-bold' : 'text-muted' }}">
                        Espera: {{ $expectedDate }}
                    </small>
                @endif
            @endif
        </td>
        <td class="text-center">
            <span class="badge badge-{{ $purchase->status_color }}">
                <i class="{{ $purchase->status_icon }}"></i>
                {{ $purchase->status_label }}
            </span>
        </td>
        <td class="text-center align-middle">
            {{ $purchase->items->count() }}
        </td>
        <td class="text-center align-middle font-weight-bold">
            {{ $purchase->formatted_total }}
        </td>
        <td class="text-center">
            <div class="btn-group btn-group-sm" role="group">
                <a href="{{ route('admin.purchases.show', $purchase->id) }}" class="btn btn-info" title="Ver detalle">
                    <i class="fas fa-eye"></i>
                </a>

                @if ($purchase->can_edit)
                    <a href="{{ route('admin.purchases.edit', $purchase->id) }}" class="btn btn-warning"
                        title="Editar">
                        <i class="fas fa-edit"></i>
                    </a>
                @endif

                @if ($purchase->can_receive)
                    <a href="{{ route('admin.purchases.receive', $purchase->id) }}" class="btn btn-success"
                        title="Recibir">
                        <i class="fas fa-truck-loading"></i>
                    </a>
                @endif

                @if ($purchase->can_cancel)
                    <a href="{{ route('admin.purchases.cancel', $purchase->id) }}" class="btn btn-danger"
                        title="Cancelar">
                        <i class="fas fa-ban"></i>
                    </a>
                @endif
            </div>
        </td>
    </tr>
@empty
    <tr>
        <td colspan="7" class="text-center">No se encontraron resultados</td>
    </tr>
@endforelse
</file>

<file path="resources/views/admin/purchases/receive.blade.php">
@extends('adminlte::page')

@section('title', 'Recibir OC: ' . $purchase->purchase_number)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- ERRORES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    <form method="POST" action="{{ route('admin.purchases.receive.store', $purchase->id) }}" id="receiveForm">
        @csrf

        <div class="card card-success">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold; font-size: 20px;">
                    <i class="fas fa-truck-loading"></i> RECIBIR MERCANCÍA: {{ $purchase->purchase_number }}
                </h3>
            </div>

            <div class="card-body">
                {{-- INFO DE LA COMPRA --}}
                <div class="row mb-4">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <td style="width: 150px;"><strong>Proveedor:</strong></td>
                                <td>{{ $purchase->proveedor->nombre_proveedor ?? 'N/A' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Fecha Orden:</strong></td>
                                <td>{{ $purchase->ordered_at?->format('d/m/Y') ?? '-' }}</td>
                            </tr>
                            <tr>
                                <td><strong>Total:</strong></td>
                                <td class="font-weight-bold">{{ $purchase->formatted_total }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label>Tipo de Recepción <span class="text-danger">*</span></label>
                            <div class="custom-control custom-radio">
                                <input type="radio" id="receive_complete" name="receive_type" value="complete"
                                    class="custom-control-input" checked>
                                <label class="custom-control-label" for="receive_complete">
                                    <strong>Recepción Completa</strong>
                                    <small class="text-muted d-block">Recibir todos los items pendientes</small>
                                </label>
                            </div>
                            <div class="custom-control custom-radio mt-2">
                                <input type="radio" id="receive_partial" name="receive_type" value="partial"
                                    class="custom-control-input">
                                <label class="custom-control-label" for="receive_partial">
                                    <strong>Recepción Parcial</strong>
                                    <small class="text-muted d-block">Especificar cantidad por item</small>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                {{-- TABLA DE ITEMS --}}
                <h5 class="mb-3"><i class="fas fa-list"></i> Items a Recibir</h5>

                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="thead-light">
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Material</th>
                                <th>SKU</th>
                                <th class="text-center">Ordenado</th>
                                <th class="text-center">Recibido</th>
                                <th class="text-center">Pendiente</th>
                                <th class="text-center" style="width: 150px;">A Recibir</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach ($purchase->items as $item)
                                <tr class="{{ $item->is_fully_received ? 'table-success' : '' }}">
                                    <td>{{ $loop->iteration }}</td>
                                    <td>
                                        <strong>{{ $item->materialVariant->material->name ?? 'N/A' }}</strong>
                                        @if ($item->materialVariant->color)
                                            <br><span
                                                class="badge badge-secondary">{{ $item->materialVariant->color }}</span>
                                        @endif
                                    </td>
                                    <td><code>{{ $item->materialVariant->sku ?? 'N/A' }}</code></td>
                                    <td class="text-center">
                                        {{ number_format($item->quantity, 2) }} {{ $item->unit->symbol ?? '' }}
                                    </td>
                                    <td class="text-center">
                                        {{ number_format($item->quantity_received, 2) }} {{ $item->unit->symbol ?? '' }}
                                    </td>
                                    <td class="text-center">
                                        @if ($item->is_fully_received)
                                            <span class="badge badge-success">Completo</span>
                                        @else
                                            <span class="badge badge-warning">
                                                {{ number_format($item->pending_quantity, 2) }}
                                                {{ $item->unit->symbol ?? '' }}
                                            </span>
                                        @endif
                                    </td>
                                    <td class="text-center">
                                        @if ($item->is_fully_received)
                                            <span class="text-success"><i class="fas fa-check"></i></span>
                                        @else
                                            <input type="hidden" name="items[{{ $loop->index }}][item_id]"
                                                value="{{ $item->id }}">
                                            <input type="number" name="items[{{ $loop->index }}][quantity]"
                                                class="form-control form-control-sm text-center partial-quantity"
                                                value="{{ $item->pending_quantity }}" min="0"
                                                max="{{ $item->pending_quantity }}" step="0.01" disabled>
                                        @endif
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>

                {{-- GUÍA Y NOTAS --}}
                <div class="row mt-3">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label>Número de Guía / Remisión</label>
                            <input type="text" name="delivery_note" class="form-control" maxlength="100"
                                placeholder="Ej: GR-12345" value="{{ old('delivery_note') }}">
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="form-group">
                            <label>Notas de Recepción</label>
                            <textarea name="notes" class="form-control" rows="2" maxlength="1000"
                                placeholder="Observaciones sobre la recepción...">{{ old('notes') }}</textarea>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer text-center">
                <a href="{{ route('admin.purchases.show', $purchase->id) }}" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Cancelar
                </a>
                <button type="submit" class="btn btn-success">
                    <i class="fas fa-check"></i> Confirmar Recepción
                </button>
            </div>
        </div>
    </form>
@stop

@section('js')
    <script>
        $(function() {
            const $partialInputs = $('.partial-quantity');

            $('input[name="receive_type"]').on('change', function() {
                if ($(this).val() === 'partial') {
                    $partialInputs.prop('disabled', false);
                } else {
                    $partialInputs.prop('disabled', true);
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/search/index.blade.php">

</file>

<file path="resources/views/admin/variants/_form.blade.php">

</file>

<file path="resources/views/admin/variants/create.blade.php">

</file>

<file path="resources/views/admin/variants/edit.blade.php">

</file>

<file path="resources/views/components/image-uploader.blade.php">
<div class="border-2 border-dashed rounded-2xl p-6 text-center transition
            hover:border-black hover:bg-gray-50"
    id="dropzone">

    <input type="file" name="imagenes[]" id="imageInput" class="hidden" accept="image/*" multiple>

    <div class="space-y-3 cursor-pointer" onclick="document.getElementById('imageInput').click()">

        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400"></i>

        <p class="text-sm text-gray-600">
            Arrastra imágenes aquí o haz clic para seleccionar
        </p>

        <p class="text-xs text-gray-400">
            JPG, PNG — Máx 5MB
        </p>
    </div>

</div>

<div id="previewContainer" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6"></div>
</file>

<file path="resources/views/home.blade.php">
@extends('adminlte::page')

@section('title', 'Dashboard')

@section('content_header')
    <h1>Dashboard</h1>
@stop

@section('content')
    <p>Welcome to this beautiful admin panel.</p>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/layouts/app.blade.php">
<!doctype html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSRF Token -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>{{ config('app.name', 'Laravel') }}</title>

    <!-- Fonts -->
    <link rel="dns-prefetch" href="//fonts.bunny.net">
    <link href="https://fonts.bunny.net/css?family=Nunito" rel="stylesheet">

    <!-- Scripts -->
    @vite(['resources/sass/app.scss', 'resources/js/app.js'])
</head>
<body>
    <div id="app">
        <nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm">
            <div class="container">
                <a class="navbar-brand" href="{{ url('/') }}">
                    {{ config('app.name', 'Laravel') }}
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="{{ __('Toggle navigation') }}">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <!-- Left Side Of Navbar -->
                    <ul class="navbar-nav me-auto">

                    </ul>

                    <!-- Right Side Of Navbar -->
                    <ul class="navbar-nav ms-auto">
                        <!-- Authentication Links -->
                        @guest
                            @if (Route::has('login'))
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ route('login') }}">{{ __('Login') }}</a>
                                </li>
                            @endif

                            @if (Route::has('register'))
                                <li class="nav-item">
                                    <a class="nav-link" href="{{ route('register') }}">{{ __('Register') }}</a>
                                </li>
                            @endif
                        @else
                            <li class="nav-item dropdown">
                                <a id="navbarDropdown" class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" v-pre>
                                    {{ Auth::user()->name }}
                                </a>

                                <div class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                    <a class="dropdown-item" href="{{ route('logout') }}"
                                       onclick="event.preventDefault();
                                                     document.getElementById('logout-form').submit();">
                                        {{ __('Logout') }}
                                    </a>

                                    <form id="logout-form" action="{{ route('logout') }}" method="POST" class="d-none">
                                        @csrf
                                    </form>
                                </div>
                            </li>
                        @endguest
                    </ul>
                </div>
            </div>
        </nav>

        <main class="py-4">
            @yield('content')
        </main>
    </div>
</body>
</html>
</file>

<file path="resources/views/welcome.blade.php">
<!DOCTYPE html>
<html lang="{{ str_replace('_', '-', app()->getLocale()) }}">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>{{ config('app.name', 'Laravel') }}</title>

        <!-- Fonts -->
        <link rel="preconnect" href="https://fonts.bunny.net">
        <link href="https://fonts.bunny.net/css?family=instrument-sans:400,500,600" rel="stylesheet" />

        <!-- Styles / Scripts -->
        @if (file_exists(public_path('build/manifest.json')) || file_exists(public_path('hot')))
            @vite(['resources/css/app.css', 'resources/js/app.js'])
        @else
            <style>
                /*! tailwindcss v4.0.7 | MIT License | https://tailwindcss.com */@layer theme{:root,:host{--font-sans:'Instrument Sans',ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--font-serif:ui-serif,Georgia,Cambria,"Times New Roman",Times,serif;--font-mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--color-red-50:oklch(.971 .013 17.38);--color-red-100:oklch(.936 .032 17.717);--color-red-200:oklch(.885 .062 18.334);--color-red-300:oklch(.808 .114 19.571);--color-red-400:oklch(.704 .191 22.216);--color-red-500:oklch(.637 .237 25.331);--color-red-600:oklch(.577 .245 27.325);--color-red-700:oklch(.505 .213 27.518);--color-red-800:oklch(.444 .177 26.899);--color-red-900:oklch(.396 .141 25.723);--color-red-950:oklch(.258 .092 26.042);--color-orange-50:oklch(.98 .016 73.684);--color-orange-100:oklch(.954 .038 75.164);--color-orange-200:oklch(.901 .076 70.697);--color-orange-300:oklch(.837 .128 66.29);--color-orange-400:oklch(.75 .183 55.934);--color-orange-500:oklch(.705 .213 47.604);--color-orange-600:oklch(.646 .222 41.116);--color-orange-700:oklch(.553 .195 38.402);--color-orange-800:oklch(.47 .157 37.304);--color-orange-900:oklch(.408 .123 38.172);--color-orange-950:oklch(.266 .079 36.259);--color-amber-50:oklch(.987 .022 95.277);--color-amber-100:oklch(.962 .059 95.617);--color-amber-200:oklch(.924 .12 95.746);--color-amber-300:oklch(.879 .169 91.605);--color-amber-400:oklch(.828 .189 84.429);--color-amber-500:oklch(.769 .188 70.08);--color-amber-600:oklch(.666 .179 58.318);--color-amber-700:oklch(.555 .163 48.998);--color-amber-800:oklch(.473 .137 46.201);--color-amber-900:oklch(.414 .112 45.904);--color-amber-950:oklch(.279 .077 45.635);--color-yellow-50:oklch(.987 .026 102.212);--color-yellow-100:oklch(.973 .071 103.193);--color-yellow-200:oklch(.945 .129 101.54);--color-yellow-300:oklch(.905 .182 98.111);--color-yellow-400:oklch(.852 .199 91.936);--color-yellow-500:oklch(.795 .184 86.047);--color-yellow-600:oklch(.681 .162 75.834);--color-yellow-700:oklch(.554 .135 66.442);--color-yellow-800:oklch(.476 .114 61.907);--color-yellow-900:oklch(.421 .095 57.708);--color-yellow-950:oklch(.286 .066 53.813);--color-lime-50:oklch(.986 .031 120.757);--color-lime-100:oklch(.967 .067 122.328);--color-lime-200:oklch(.938 .127 124.321);--color-lime-300:oklch(.897 .196 126.665);--color-lime-400:oklch(.841 .238 128.85);--color-lime-500:oklch(.768 .233 130.85);--color-lime-600:oklch(.648 .2 131.684);--color-lime-700:oklch(.532 .157 131.589);--color-lime-800:oklch(.453 .124 130.933);--color-lime-900:oklch(.405 .101 131.063);--color-lime-950:oklch(.274 .072 132.109);--color-green-50:oklch(.982 .018 155.826);--color-green-100:oklch(.962 .044 156.743);--color-green-200:oklch(.925 .084 155.995);--color-green-300:oklch(.871 .15 154.449);--color-green-400:oklch(.792 .209 151.711);--color-green-500:oklch(.723 .219 149.579);--color-green-600:oklch(.627 .194 149.214);--color-green-700:oklch(.527 .154 150.069);--color-green-800:oklch(.448 .119 151.328);--color-green-900:oklch(.393 .095 152.535);--color-green-950:oklch(.266 .065 152.934);--color-emerald-50:oklch(.979 .021 166.113);--color-emerald-100:oklch(.95 .052 163.051);--color-emerald-200:oklch(.905 .093 164.15);--color-emerald-300:oklch(.845 .143 164.978);--color-emerald-400:oklch(.765 .177 163.223);--color-emerald-500:oklch(.696 .17 162.48);--color-emerald-600:oklch(.596 .145 163.225);--color-emerald-700:oklch(.508 .118 165.612);--color-emerald-800:oklch(.432 .095 166.913);--color-emerald-900:oklch(.378 .077 168.94);--color-emerald-950:oklch(.262 .051 172.552);--color-teal-50:oklch(.984 .014 180.72);--color-teal-100:oklch(.953 .051 180.801);--color-teal-200:oklch(.91 .096 180.426);--color-teal-300:oklch(.855 .138 181.071);--color-teal-400:oklch(.777 .152 181.912);--color-teal-500:oklch(.704 .14 182.503);--color-teal-600:oklch(.6 .118 184.704);--color-teal-700:oklch(.511 .096 186.391);--color-teal-800:oklch(.437 .078 188.216);--color-teal-900:oklch(.386 .063 188.416);--color-teal-950:oklch(.277 .046 192.524);--color-cyan-50:oklch(.984 .019 200.873);--color-cyan-100:oklch(.956 .045 203.388);--color-cyan-200:oklch(.917 .08 205.041);--color-cyan-300:oklch(.865 .127 207.078);--color-cyan-400:oklch(.789 .154 211.53);--color-cyan-500:oklch(.715 .143 215.221);--color-cyan-600:oklch(.609 .126 221.723);--color-cyan-700:oklch(.52 .105 223.128);--color-cyan-800:oklch(.45 .085 224.283);--color-cyan-900:oklch(.398 .07 227.392);--color-cyan-950:oklch(.302 .056 229.695);--color-sky-50:oklch(.977 .013 236.62);--color-sky-100:oklch(.951 .026 236.824);--color-sky-200:oklch(.901 .058 230.902);--color-sky-300:oklch(.828 .111 230.318);--color-sky-400:oklch(.746 .16 232.661);--color-sky-500:oklch(.685 .169 237.323);--color-sky-600:oklch(.588 .158 241.966);--color-sky-700:oklch(.5 .134 242.749);--color-sky-800:oklch(.443 .11 240.79);--color-sky-900:oklch(.391 .09 240.876);--color-sky-950:oklch(.293 .066 243.157);--color-blue-50:oklch(.97 .014 254.604);--color-blue-100:oklch(.932 .032 255.585);--color-blue-200:oklch(.882 .059 254.128);--color-blue-300:oklch(.809 .105 251.813);--color-blue-400:oklch(.707 .165 254.624);--color-blue-500:oklch(.623 .214 259.815);--color-blue-600:oklch(.546 .245 262.881);--color-blue-700:oklch(.488 .243 264.376);--color-blue-800:oklch(.424 .199 265.638);--color-blue-900:oklch(.379 .146 265.522);--color-blue-950:oklch(.282 .091 267.935);--color-indigo-50:oklch(.962 .018 272.314);--color-indigo-100:oklch(.93 .034 272.788);--color-indigo-200:oklch(.87 .065 274.039);--color-indigo-300:oklch(.785 .115 274.713);--color-indigo-400:oklch(.673 .182 276.935);--color-indigo-500:oklch(.585 .233 277.117);--color-indigo-600:oklch(.511 .262 276.966);--color-indigo-700:oklch(.457 .24 277.023);--color-indigo-800:oklch(.398 .195 277.366);--color-indigo-900:oklch(.359 .144 278.697);--color-indigo-950:oklch(.257 .09 281.288);--color-violet-50:oklch(.969 .016 293.756);--color-violet-100:oklch(.943 .029 294.588);--color-violet-200:oklch(.894 .057 293.283);--color-violet-300:oklch(.811 .111 293.571);--color-violet-400:oklch(.702 .183 293.541);--color-violet-500:oklch(.606 .25 292.717);--color-violet-600:oklch(.541 .281 293.009);--color-violet-700:oklch(.491 .27 292.581);--color-violet-800:oklch(.432 .232 292.759);--color-violet-900:oklch(.38 .189 293.745);--color-violet-950:oklch(.283 .141 291.089);--color-purple-50:oklch(.977 .014 308.299);--color-purple-100:oklch(.946 .033 307.174);--color-purple-200:oklch(.902 .063 306.703);--color-purple-300:oklch(.827 .119 306.383);--color-purple-400:oklch(.714 .203 305.504);--color-purple-500:oklch(.627 .265 303.9);--color-purple-600:oklch(.558 .288 302.321);--color-purple-700:oklch(.496 .265 301.924);--color-purple-800:oklch(.438 .218 303.724);--color-purple-900:oklch(.381 .176 304.987);--color-purple-950:oklch(.291 .149 302.717);--color-fuchsia-50:oklch(.977 .017 320.058);--color-fuchsia-100:oklch(.952 .037 318.852);--color-fuchsia-200:oklch(.903 .076 319.62);--color-fuchsia-300:oklch(.833 .145 321.434);--color-fuchsia-400:oklch(.74 .238 322.16);--color-fuchsia-500:oklch(.667 .295 322.15);--color-fuchsia-600:oklch(.591 .293 322.896);--color-fuchsia-700:oklch(.518 .253 323.949);--color-fuchsia-800:oklch(.452 .211 324.591);--color-fuchsia-900:oklch(.401 .17 325.612);--color-fuchsia-950:oklch(.293 .136 325.661);--color-pink-50:oklch(.971 .014 343.198);--color-pink-100:oklch(.948 .028 342.258);--color-pink-200:oklch(.899 .061 343.231);--color-pink-300:oklch(.823 .12 346.018);--color-pink-400:oklch(.718 .202 349.761);--color-pink-500:oklch(.656 .241 354.308);--color-pink-600:oklch(.592 .249 .584);--color-pink-700:oklch(.525 .223 3.958);--color-pink-800:oklch(.459 .187 3.815);--color-pink-900:oklch(.408 .153 2.432);--color-pink-950:oklch(.284 .109 3.907);--color-rose-50:oklch(.969 .015 12.422);--color-rose-100:oklch(.941 .03 12.58);--color-rose-200:oklch(.892 .058 10.001);--color-rose-300:oklch(.81 .117 11.638);--color-rose-400:oklch(.712 .194 13.428);--color-rose-500:oklch(.645 .246 16.439);--color-rose-600:oklch(.586 .253 17.585);--color-rose-700:oklch(.514 .222 16.935);--color-rose-800:oklch(.455 .188 13.697);--color-rose-900:oklch(.41 .159 10.272);--color-rose-950:oklch(.271 .105 12.094);--color-slate-50:oklch(.984 .003 247.858);--color-slate-100:oklch(.968 .007 247.896);--color-slate-200:oklch(.929 .013 255.508);--color-slate-300:oklch(.869 .022 252.894);--color-slate-400:oklch(.704 .04 256.788);--color-slate-500:oklch(.554 .046 257.417);--color-slate-600:oklch(.446 .043 257.281);--color-slate-700:oklch(.372 .044 257.287);--color-slate-800:oklch(.279 .041 260.031);--color-slate-900:oklch(.208 .042 265.755);--color-slate-950:oklch(.129 .042 264.695);--color-gray-50:oklch(.985 .002 247.839);--color-gray-100:oklch(.967 .003 264.542);--color-gray-200:oklch(.928 .006 264.531);--color-gray-300:oklch(.872 .01 258.338);--color-gray-400:oklch(.707 .022 261.325);--color-gray-500:oklch(.551 .027 264.364);--color-gray-600:oklch(.446 .03 256.802);--color-gray-700:oklch(.373 .034 259.733);--color-gray-800:oklch(.278 .033 256.848);--color-gray-900:oklch(.21 .034 264.665);--color-gray-950:oklch(.13 .028 261.692);--color-zinc-50:oklch(.985 0 0);--color-zinc-100:oklch(.967 .001 286.375);--color-zinc-200:oklch(.92 .004 286.32);--color-zinc-300:oklch(.871 .006 286.286);--color-zinc-400:oklch(.705 .015 286.067);--color-zinc-500:oklch(.552 .016 285.938);--color-zinc-600:oklch(.442 .017 285.786);--color-zinc-700:oklch(.37 .013 285.805);--color-zinc-800:oklch(.274 .006 286.033);--color-zinc-900:oklch(.21 .006 285.885);--color-zinc-950:oklch(.141 .005 285.823);--color-neutral-50:oklch(.985 0 0);--color-neutral-100:oklch(.97 0 0);--color-neutral-200:oklch(.922 0 0);--color-neutral-300:oklch(.87 0 0);--color-neutral-400:oklch(.708 0 0);--color-neutral-500:oklch(.556 0 0);--color-neutral-600:oklch(.439 0 0);--color-neutral-700:oklch(.371 0 0);--color-neutral-800:oklch(.269 0 0);--color-neutral-900:oklch(.205 0 0);--color-neutral-950:oklch(.145 0 0);--color-stone-50:oklch(.985 .001 106.423);--color-stone-100:oklch(.97 .001 106.424);--color-stone-200:oklch(.923 .003 48.717);--color-stone-300:oklch(.869 .005 56.366);--color-stone-400:oklch(.709 .01 56.259);--color-stone-500:oklch(.553 .013 58.071);--color-stone-600:oklch(.444 .011 73.639);--color-stone-700:oklch(.374 .01 67.558);--color-stone-800:oklch(.268 .007 34.298);--color-stone-900:oklch(.216 .006 56.043);--color-stone-950:oklch(.147 .004 49.25);--color-black:#000;--color-white:#fff;--spacing:.25rem;--breakpoint-sm:40rem;--breakpoint-md:48rem;--breakpoint-lg:64rem;--breakpoint-xl:80rem;--breakpoint-2xl:96rem;--container-3xs:16rem;--container-2xs:18rem;--container-xs:20rem;--container-sm:24rem;--container-md:28rem;--container-lg:32rem;--container-xl:36rem;--container-2xl:42rem;--container-3xl:48rem;--container-4xl:56rem;--container-5xl:64rem;--container-6xl:72rem;--container-7xl:80rem;--text-xs:.75rem;--text-xs--line-height:calc(1/.75);--text-sm:.875rem;--text-sm--line-height:calc(1.25/.875);--text-base:1rem;--text-base--line-height: 1.5 ;--text-lg:1.125rem;--text-lg--line-height:calc(1.75/1.125);--text-xl:1.25rem;--text-xl--line-height:calc(1.75/1.25);--text-2xl:1.5rem;--text-2xl--line-height:calc(2/1.5);--text-3xl:1.875rem;--text-3xl--line-height: 1.2 ;--text-4xl:2.25rem;--text-4xl--line-height:calc(2.5/2.25);--text-5xl:3rem;--text-5xl--line-height:1;--text-6xl:3.75rem;--text-6xl--line-height:1;--text-7xl:4.5rem;--text-7xl--line-height:1;--text-8xl:6rem;--text-8xl--line-height:1;--text-9xl:8rem;--text-9xl--line-height:1;--font-weight-thin:100;--font-weight-extralight:200;--font-weight-light:300;--font-weight-normal:400;--font-weight-medium:500;--font-weight-semibold:600;--font-weight-bold:700;--font-weight-extrabold:800;--font-weight-black:900;--tracking-tighter:-.05em;--tracking-tight:-.025em;--tracking-normal:0em;--tracking-wide:.025em;--tracking-wider:.05em;--tracking-widest:.1em;--leading-tight:1.25;--leading-snug:1.375;--leading-normal:1.5;--leading-relaxed:1.625;--leading-loose:2;--radius-xs:.125rem;--radius-sm:.25rem;--radius-md:.375rem;--radius-lg:.5rem;--radius-xl:.75rem;--radius-2xl:1rem;--radius-3xl:1.5rem;--radius-4xl:2rem;--shadow-2xs:0 1px #0000000d;--shadow-xs:0 1px 2px 0 #0000000d;--shadow-sm:0 1px 3px 0 #0000001a,0 1px 2px -1px #0000001a;--shadow-md:0 4px 6px -1px #0000001a,0 2px 4px -2px #0000001a;--shadow-lg:0 10px 15px -3px #0000001a,0 4px 6px -4px #0000001a;--shadow-xl:0 20px 25px -5px #0000001a,0 8px 10px -6px #0000001a;--shadow-2xl:0 25px 50px -12px #00000040;--inset-shadow-2xs:inset 0 1px #0000000d;--inset-shadow-xs:inset 0 1px 1px #0000000d;--inset-shadow-sm:inset 0 2px 4px #0000000d;--drop-shadow-xs:0 1px 1px #0000000d;--drop-shadow-sm:0 1px 2px #00000026;--drop-shadow-md:0 3px 3px #0000001f;--drop-shadow-lg:0 4px 4px #00000026;--drop-shadow-xl:0 9px 7px #0000001a;--drop-shadow-2xl:0 25px 25px #00000026;--ease-in:cubic-bezier(.4,0,1,1);--ease-out:cubic-bezier(0,0,.2,1);--ease-in-out:cubic-bezier(.4,0,.2,1);--animate-spin:spin 1s linear infinite;--animate-ping:ping 1s cubic-bezier(0,0,.2,1)infinite;--animate-pulse:pulse 2s cubic-bezier(.4,0,.6,1)infinite;--animate-bounce:bounce 1s infinite;--blur-xs:4px;--blur-sm:8px;--blur-md:12px;--blur-lg:16px;--blur-xl:24px;--blur-2xl:40px;--blur-3xl:64px;--perspective-dramatic:100px;--perspective-near:300px;--perspective-normal:500px;--perspective-midrange:800px;--perspective-distant:1200px;--aspect-video:16/9;--default-transition-duration:.15s;--default-transition-timing-function:cubic-bezier(.4,0,.2,1);--default-font-family:var(--font-sans);--default-font-feature-settings:var(--font-sans--font-feature-settings);--default-font-variation-settings:var(--font-sans--font-variation-settings);--default-mono-font-family:var(--font-mono);--default-mono-font-feature-settings:var(--font-mono--font-feature-settings);--default-mono-font-variation-settings:var(--font-mono--font-variation-settings)}}@layer base{*,:after,:before,::backdrop{box-sizing:border-box;border:0 solid;margin:0;padding:0}::file-selector-button{box-sizing:border-box;border:0 solid;margin:0;padding:0}html,:host{-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;line-height:1.5;font-family:var(--default-font-family,ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji");font-feature-settings:var(--default-font-feature-settings,normal);font-variation-settings:var(--default-font-variation-settings,normal);-webkit-tap-highlight-color:transparent}body{line-height:inherit}hr{height:0;color:inherit;border-top-width:1px}abbr:where([title]){-webkit-text-decoration:underline dotted;text-decoration:underline dotted}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;-webkit-text-decoration:inherit;text-decoration:inherit}b,strong{font-weight:bolder}code,kbd,samp,pre{font-family:var(--default-mono-font-family,ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace);font-feature-settings:var(--default-mono-font-feature-settings,normal);font-variation-settings:var(--default-mono-font-variation-settings,normal);font-size:1em}small{font-size:80%}sub,sup{vertical-align:baseline;font-size:75%;line-height:0;position:relative}sub{bottom:-.25em}sup{top:-.5em}table{text-indent:0;border-color:inherit;border-collapse:collapse}:-moz-focusring{outline:auto}progress{vertical-align:baseline}summary{display:list-item}ol,ul,menu{list-style:none}img,svg,video,canvas,audio,iframe,embed,object{vertical-align:middle;display:block}img,video{max-width:100%;height:auto}button,input,select,optgroup,textarea{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}::file-selector-button{font:inherit;font-feature-settings:inherit;font-variation-settings:inherit;letter-spacing:inherit;color:inherit;opacity:1;background-color:#0000;border-radius:0}:where(select:is([multiple],[size])) optgroup{font-weight:bolder}:where(select:is([multiple],[size])) optgroup option{padding-inline-start:20px}::file-selector-button{margin-inline-end:4px}::placeholder{opacity:1;color:color-mix(in oklab,currentColor 50%,transparent)}textarea{resize:vertical}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-date-and-time-value{min-height:1lh;text-align:inherit}::-webkit-datetime-edit{display:inline-flex}::-webkit-datetime-edit-fields-wrapper{padding:0}::-webkit-datetime-edit{padding-block:0}::-webkit-datetime-edit-year-field{padding-block:0}::-webkit-datetime-edit-month-field{padding-block:0}::-webkit-datetime-edit-day-field{padding-block:0}::-webkit-datetime-edit-hour-field{padding-block:0}::-webkit-datetime-edit-minute-field{padding-block:0}::-webkit-datetime-edit-second-field{padding-block:0}::-webkit-datetime-edit-millisecond-field{padding-block:0}::-webkit-datetime-edit-meridiem-field{padding-block:0}:-moz-ui-invalid{box-shadow:none}button,input:where([type=button],[type=reset],[type=submit]){-webkit-appearance:button;-moz-appearance:button;appearance:button}::file-selector-button{-webkit-appearance:button;-moz-appearance:button;appearance:button}::-webkit-inner-spin-button{height:auto}::-webkit-outer-spin-button{height:auto}[hidden]:where(:not([hidden=until-found])){display:none!important}}@layer components;@layer utilities{.absolute{position:absolute}.relative{position:relative}.static{position:static}.inset-0{inset:calc(var(--spacing)*0)}.-mt-\[4\.9rem\]{margin-top:-4.9rem}.-mb-px{margin-bottom:-1px}.mb-1{margin-bottom:calc(var(--spacing)*1)}.mb-2{margin-bottom:calc(var(--spacing)*2)}.mb-4{margin-bottom:calc(var(--spacing)*4)}.mb-6{margin-bottom:calc(var(--spacing)*6)}.-ml-8{margin-left:calc(var(--spacing)*-8)}.flex{display:flex}.hidden{display:none}.inline-block{display:inline-block}.inline-flex{display:inline-flex}.table{display:table}.aspect-\[335\/376\]{aspect-ratio:335/376}.h-1{height:calc(var(--spacing)*1)}.h-1\.5{height:calc(var(--spacing)*1.5)}.h-2{height:calc(var(--spacing)*2)}.h-2\.5{height:calc(var(--spacing)*2.5)}.h-3{height:calc(var(--spacing)*3)}.h-3\.5{height:calc(var(--spacing)*3.5)}.h-14{height:calc(var(--spacing)*14)}.h-14\.5{height:calc(var(--spacing)*14.5)}.min-h-screen{min-height:100vh}.w-1{width:calc(var(--spacing)*1)}.w-1\.5{width:calc(var(--spacing)*1.5)}.w-2{width:calc(var(--spacing)*2)}.w-2\.5{width:calc(var(--spacing)*2.5)}.w-3{width:calc(var(--spacing)*3)}.w-3\.5{width:calc(var(--spacing)*3.5)}.w-\[448px\]{width:448px}.w-full{width:100%}.max-w-\[335px\]{max-width:335px}.max-w-none{max-width:none}.flex-1{flex:1}.shrink-0{flex-shrink:0}.translate-y-0{--tw-translate-y:calc(var(--spacing)*0);translate:var(--tw-translate-x)var(--tw-translate-y)}.transform{transform:var(--tw-rotate-x)var(--tw-rotate-y)var(--tw-rotate-z)var(--tw-skew-x)var(--tw-skew-y)}.flex-col{flex-direction:column}.flex-col-reverse{flex-direction:column-reverse}.items-center{align-items:center}.justify-center{justify-content:center}.justify-end{justify-content:flex-end}.gap-3{gap:calc(var(--spacing)*3)}.gap-4{gap:calc(var(--spacing)*4)}:where(.space-x-1>:not(:last-child)){--tw-space-x-reverse:0;margin-inline-start:calc(calc(var(--spacing)*1)*var(--tw-space-x-reverse));margin-inline-end:calc(calc(var(--spacing)*1)*calc(1 - var(--tw-space-x-reverse)))}.overflow-hidden{overflow:hidden}.rounded-full{border-radius:3.40282e38px}.rounded-sm{border-radius:var(--radius-sm)}.rounded-t-lg{border-top-left-radius:var(--radius-lg);border-top-right-radius:var(--radius-lg)}.rounded-br-lg{border-bottom-right-radius:var(--radius-lg)}.rounded-bl-lg{border-bottom-left-radius:var(--radius-lg)}.border{border-style:var(--tw-border-style);border-width:1px}.border-\[\#19140035\]{border-color:#19140035}.border-\[\#e3e3e0\]{border-color:#e3e3e0}.border-black{border-color:var(--color-black)}.border-transparent{border-color:#0000}.bg-\[\#1b1b18\]{background-color:#1b1b18}.bg-\[\#FDFDFC\]{background-color:#fdfdfc}.bg-\[\#dbdbd7\]{background-color:#dbdbd7}.bg-\[\#fff2f2\]{background-color:#fff2f2}.bg-white{background-color:var(--color-white)}.p-6{padding:calc(var(--spacing)*6)}.px-5{padding-inline:calc(var(--spacing)*5)}.py-1{padding-block:calc(var(--spacing)*1)}.py-1\.5{padding-block:calc(var(--spacing)*1.5)}.py-2{padding-block:calc(var(--spacing)*2)}.pb-12{padding-bottom:calc(var(--spacing)*12)}.text-sm{font-size:var(--text-sm);line-height:var(--tw-leading,var(--text-sm--line-height))}.text-\[13px\]{font-size:13px}.leading-\[20px\]{--tw-leading:20px;line-height:20px}.leading-normal{--tw-leading:var(--leading-normal);line-height:var(--leading-normal)}.font-medium{--tw-font-weight:var(--font-weight-medium);font-weight:var(--font-weight-medium)}.text-\[\#1b1b18\]{color:#1b1b18}.text-\[\#706f6c\]{color:#706f6c}.text-\[\#F53003\],.text-\[\#f53003\]{color:#f53003}.text-white{color:var(--color-white)}.underline{text-decoration-line:underline}.underline-offset-4{text-underline-offset:4px}.opacity-100{opacity:1}.shadow-\[0px_0px_1px_0px_rgba\(0\,0\,0\,0\.03\)\,0px_1px_2px_0px_rgba\(0\,0\,0\,0\.06\)\]{--tw-shadow:0px 0px 1px 0px var(--tw-shadow-color,#00000008),0px 1px 2px 0px var(--tw-shadow-color,#0000000f);box-shadow:var(--tw-inset-shadow),var(--tw-inset-ring-shadow),var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow)}.shadow-\[inset_0px_0px_0px_1px_rgba\(26\,26\,0\,0\.16\)\]{--tw-shadow:inset 0px 0px 0px 1px var(--tw-shadow-color,#1a1a0029);box-shadow:var(--tw-inset-shadow),var(--tw-inset-ring-shadow),var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow)}.\!filter{filter:var(--tw-blur,)var(--tw-brightness,)var(--tw-contrast,)var(--tw-grayscale,)var(--tw-hue-rotate,)var(--tw-invert,)var(--tw-saturate,)var(--tw-sepia,)var(--tw-drop-shadow,)!important}.filter{filter:var(--tw-blur,)var(--tw-brightness,)var(--tw-contrast,)var(--tw-grayscale,)var(--tw-hue-rotate,)var(--tw-invert,)var(--tw-saturate,)var(--tw-sepia,)var(--tw-drop-shadow,)}.transition-all{transition-property:all;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.transition-opacity{transition-property:opacity;transition-timing-function:var(--tw-ease,var(--default-transition-timing-function));transition-duration:var(--tw-duration,var(--default-transition-duration))}.delay-300{transition-delay:.3s}.duration-750{--tw-duration:.75s;transition-duration:.75s}.not-has-\[nav\]\:hidden:not(:has(:is(nav))){display:none}.before\:absolute:before{content:var(--tw-content);position:absolute}.before\:top-0:before{content:var(--tw-content);top:calc(var(--spacing)*0)}.before\:top-1\/2:before{content:var(--tw-content);top:50%}.before\:bottom-0:before{content:var(--tw-content);bottom:calc(var(--spacing)*0)}.before\:bottom-1\/2:before{content:var(--tw-content);bottom:50%}.before\:left-\[0\.4rem\]:before{content:var(--tw-content);left:.4rem}.before\:border-l:before{content:var(--tw-content);border-left-style:var(--tw-border-style);border-left-width:1px}.before\:border-\[\#e3e3e0\]:before{content:var(--tw-content);border-color:#e3e3e0}@media (hover:hover){.hover\:border-\[\#1915014a\]:hover{border-color:#1915014a}.hover\:border-\[\#19140035\]:hover{border-color:#19140035}.hover\:border-black:hover{border-color:var(--color-black)}.hover\:bg-black:hover{background-color:var(--color-black)}}@media (width>=64rem){.lg\:-mt-\[6\.6rem\]{margin-top:-6.6rem}.lg\:mb-0{margin-bottom:calc(var(--spacing)*0)}.lg\:mb-6{margin-bottom:calc(var(--spacing)*6)}.lg\:-ml-px{margin-left:-1px}.lg\:ml-0{margin-left:calc(var(--spacing)*0)}.lg\:block{display:block}.lg\:aspect-auto{aspect-ratio:auto}.lg\:w-\[438px\]{width:438px}.lg\:max-w-4xl{max-width:var(--container-4xl)}.lg\:grow{flex-grow:1}.lg\:flex-row{flex-direction:row}.lg\:justify-center{justify-content:center}.lg\:rounded-t-none{border-top-left-radius:0;border-top-right-radius:0}.lg\:rounded-tl-lg{border-top-left-radius:var(--radius-lg)}.lg\:rounded-r-lg{border-top-right-radius:var(--radius-lg);border-bottom-right-radius:var(--radius-lg)}.lg\:rounded-br-none{border-bottom-right-radius:0}.lg\:p-8{padding:calc(var(--spacing)*8)}.lg\:p-20{padding:calc(var(--spacing)*20)}}@media (prefers-color-scheme:dark){.dark\:block{display:block}.dark\:hidden{display:none}.dark\:border-\[\#3E3E3A\]{border-color:#3e3e3a}.dark\:border-\[\#eeeeec\]{border-color:#eeeeec}.dark\:bg-\[\#0a0a0a\]{background-color:#0a0a0a}.dark\:bg-\[\#1D0002\]{background-color:#1d0002}.dark\:bg-\[\#3E3E3A\]{background-color:#3e3e3a}.dark\:bg-\[\#161615\]{background-color:#161615}.dark\:bg-\[\#eeeeec\]{background-color:#eeeeec}.dark\:text-\[\#1C1C1A\]{color:#1c1c1a}.dark\:text-\[\#A1A09A\]{color:#a1a09a}.dark\:text-\[\#EDEDEC\]{color:#ededec}.dark\:text-\[\#F61500\]{color:#f61500}.dark\:text-\[\#FF4433\]{color:#f43}.dark\:shadow-\[inset_0px_0px_0px_1px_\#fffaed2d\]{--tw-shadow:inset 0px 0px 0px 1px var(--tw-shadow-color,#fffaed2d);box-shadow:var(--tw-inset-shadow),var(--tw-inset-ring-shadow),var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow)}.dark\:before\:border-\[\#3E3E3A\]:before{content:var(--tw-content);border-color:#3e3e3a}@media (hover:hover){.dark\:hover\:border-\[\#3E3E3A\]:hover{border-color:#3e3e3a}.dark\:hover\:border-\[\#62605b\]:hover{border-color:#62605b}.dark\:hover\:border-white:hover{border-color:var(--color-white)}.dark\:hover\:bg-white:hover{background-color:var(--color-white)}}}@starting-style{.starting\:translate-y-4{--tw-translate-y:calc(var(--spacing)*4);translate:var(--tw-translate-x)var(--tw-translate-y)}}@starting-style{.starting\:translate-y-6{--tw-translate-y:calc(var(--spacing)*6);translate:var(--tw-translate-x)var(--tw-translate-y)}}@starting-style{.starting\:opacity-0{opacity:0}}}@keyframes spin{to{transform:rotate(360deg)}}@keyframes ping{75%,to{opacity:0;transform:scale(2)}}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{animation-timing-function:cubic-bezier(.8,0,1,1);transform:translateY(-25%)}50%{animation-timing-function:cubic-bezier(0,0,.2,1);transform:none}}@property --tw-translate-x{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-y{syntax:"*";inherits:false;initial-value:0}@property --tw-translate-z{syntax:"*";inherits:false;initial-value:0}@property --tw-rotate-x{syntax:"*";inherits:false;initial-value:rotateX(0)}@property --tw-rotate-y{syntax:"*";inherits:false;initial-value:rotateY(0)}@property --tw-rotate-z{syntax:"*";inherits:false;initial-value:rotateZ(0)}@property --tw-skew-x{syntax:"*";inherits:false;initial-value:skewX(0)}@property --tw-skew-y{syntax:"*";inherits:false;initial-value:skewY(0)}@property --tw-space-x-reverse{syntax:"*";inherits:false;initial-value:0}@property --tw-border-style{syntax:"*";inherits:false;initial-value:solid}@property --tw-leading{syntax:"*";inherits:false}@property --tw-font-weight{syntax:"*";inherits:false}@property --tw-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-shadow-color{syntax:"*";inherits:false}@property --tw-inset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-shadow-color{syntax:"*";inherits:false}@property --tw-ring-color{syntax:"*";inherits:false}@property --tw-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-inset-ring-color{syntax:"*";inherits:false}@property --tw-inset-ring-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-ring-inset{syntax:"*";inherits:false}@property --tw-ring-offset-width{syntax:"<length>";inherits:false;initial-value:0}@property --tw-ring-offset-color{syntax:"*";inherits:false;initial-value:#fff}@property --tw-ring-offset-shadow{syntax:"*";inherits:false;initial-value:0 0 #0000}@property --tw-blur{syntax:"*";inherits:false}@property --tw-brightness{syntax:"*";inherits:false}@property --tw-contrast{syntax:"*";inherits:false}@property --tw-grayscale{syntax:"*";inherits:false}@property --tw-hue-rotate{syntax:"*";inherits:false}@property --tw-invert{syntax:"*";inherits:false}@property --tw-opacity{syntax:"*";inherits:false}@property --tw-saturate{syntax:"*";inherits:false}@property --tw-sepia{syntax:"*";inherits:false}@property --tw-drop-shadow{syntax:"*";inherits:false}@property --tw-duration{syntax:"*";inherits:false}@property --tw-content{syntax:"*";inherits:false;initial-value:""}
            </style>
        @endif
    </head>
    <body class="bg-[#FDFDFC] dark:bg-[#0a0a0a] text-[#1b1b18] flex p-6 lg:p-8 items-center lg:justify-center min-h-screen flex-col">
        <header class="w-full lg:max-w-4xl max-w-[335px] text-sm mb-6 not-has-[nav]:hidden">
            @if (Route::has('login'))
                <nav class="flex items-center justify-end gap-4">
                    @auth
                        <a
                            href="{{ url('/dashboard') }}"
                            class="inline-block px-5 py-1.5 dark:text-[#EDEDEC] border-[#19140035] hover:border-[#1915014a] border text-[#1b1b18] dark:border-[#3E3E3A] dark:hover:border-[#62605b] rounded-sm text-sm leading-normal"
                        >
                            Dashboard
                        </a>
                    @else
                        <a
                            href="{{ route('login') }}"
                            class="inline-block px-5 py-1.5 dark:text-[#EDEDEC] text-[#1b1b18] border border-transparent hover:border-[#19140035] dark:hover:border-[#3E3E3A] rounded-sm text-sm leading-normal"
                        >
                            Log in
                        </a>

                        @if (Route::has('register'))
                            <a
                                href="{{ route('register') }}"
                                class="inline-block px-5 py-1.5 dark:text-[#EDEDEC] border-[#19140035] hover:border-[#1915014a] border text-[#1b1b18] dark:border-[#3E3E3A] dark:hover:border-[#62605b] rounded-sm text-sm leading-normal">
                                Register
                            </a>
                        @endif
                    @endauth
                </nav>
            @endif
        </header>
        <div class="flex items-center justify-center w-full transition-opacity opacity-100 duration-750 lg:grow starting:opacity-0">
            <main class="flex max-w-[335px] w-full flex-col-reverse lg:max-w-4xl lg:flex-row">
                <div class="text-[13px] leading-[20px] flex-1 p-6 pb-12 lg:p-20 bg-white dark:bg-[#161615] dark:text-[#EDEDEC] shadow-[inset_0px_0px_0px_1px_rgba(26,26,0,0.16)] dark:shadow-[inset_0px_0px_0px_1px_#fffaed2d] rounded-bl-lg rounded-br-lg lg:rounded-tl-lg lg:rounded-br-none">
                    <h1 class="mb-1 font-medium">Let's get started</h1>
                    <p class="mb-2 text-[#706f6c] dark:text-[#A1A09A]">Laravel has an incredibly rich ecosystem. <br>We suggest starting with the following.</p>
                    <ul class="flex flex-col mb-4 lg:mb-6">
                        <li class="flex items-center gap-4 py-2 relative before:border-l before:border-[#e3e3e0] dark:before:border-[#3E3E3A] before:top-1/2 before:bottom-0 before:left-[0.4rem] before:absolute">
                            <span class="relative py-1 bg-white dark:bg-[#161615]">
                                <span class="flex items-center justify-center rounded-full bg-[#FDFDFC] dark:bg-[#161615] shadow-[0px_0px_1px_0px_rgba(0,0,0,0.03),0px_1px_2px_0px_rgba(0,0,0,0.06)] w-3.5 h-3.5 border dark:border-[#3E3E3A] border-[#e3e3e0]">
                                    <span class="rounded-full bg-[#dbdbd7] dark:bg-[#3E3E3A] w-1.5 h-1.5"></span>
                                </span>
                            </span>
                            <span>
                                Read the
                                <a href="https://laravel.com/docs" target="_blank" class="inline-flex items-center space-x-1 font-medium underline underline-offset-4 text-[#f53003] dark:text-[#FF4433] ml-1">
                                    <span>Documentation</span>
                                    <svg
                                        width="10"
                                        height="11"
                                        viewBox="0 0 10 11"
                                        fill="none"
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-2.5 h-2.5"
                                    >
                                        <path
                                            d="M7.70833 6.95834V2.79167H3.54167M2.5 8L7.5 3.00001"
                                            stroke="currentColor"
                                            stroke-linecap="square"
                                        />
                                    </svg>
                                </a>
                            </span>
                        </li>
                        <li class="flex items-center gap-4 py-2 relative before:border-l before:border-[#e3e3e0] dark:before:border-[#3E3E3A] before:bottom-1/2 before:top-0 before:left-[0.4rem] before:absolute">
                            <span class="relative py-1 bg-white dark:bg-[#161615]">
                                <span class="flex items-center justify-center rounded-full bg-[#FDFDFC] dark:bg-[#161615] shadow-[0px_0px_1px_0px_rgba(0,0,0,0.03),0px_1px_2px_0px_rgba(0,0,0,0.06)] w-3.5 h-3.5 border dark:border-[#3E3E3A] border-[#e3e3e0]">
                                    <span class="rounded-full bg-[#dbdbd7] dark:bg-[#3E3E3A] w-1.5 h-1.5"></span>
                                </span>
                            </span>
                            <span>
                                Watch video tutorials at
                                <a href="https://laracasts.com" target="_blank" class="inline-flex items-center space-x-1 font-medium underline underline-offset-4 text-[#f53003] dark:text-[#FF4433] ml-1">
                                    <span>Laracasts</span>
                                    <svg
                                        width="10"
                                        height="11"
                                        viewBox="0 0 10 11"
                                        fill="none"
                                        xmlns="http://www.w3.org/2000/svg"
                                        class="w-2.5 h-2.5"
                                    >
                                        <path
                                            d="M7.70833 6.95834V2.79167H3.54167M2.5 8L7.5 3.00001"
                                            stroke="currentColor"
                                            stroke-linecap="square"
                                        />
                                    </svg>
                                </a>
                            </span>
                        </li>
                    </ul>
                    <ul class="flex gap-3 text-sm leading-normal">
                        <li>
                            <a href="https://cloud.laravel.com" target="_blank" class="inline-block dark:bg-[#eeeeec] dark:border-[#eeeeec] dark:text-[#1C1C1A] dark:hover:bg-white dark:hover:border-white hover:bg-black hover:border-black px-5 py-1.5 bg-[#1b1b18] rounded-sm border border-black text-white text-sm leading-normal">
                                Deploy now
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="bg-[#fff2f2] dark:bg-[#1D0002] relative lg:-ml-px -mb-px lg:mb-0 rounded-t-lg lg:rounded-t-none lg:rounded-r-lg aspect-[335/376] lg:aspect-auto w-full lg:w-[438px] shrink-0 overflow-hidden">
                    {{-- Laravel Logo --}}
                    <svg class="w-full text-[#F53003] dark:text-[#F61500] transition-all translate-y-0 opacity-100 max-w-none duration-750 starting:opacity-0 starting:translate-y-6" viewBox="0 0 438 104" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17.2036 -3H0V102.197H49.5189V86.7187H17.2036V-3Z" fill="currentColor" />
                        <path d="M110.256 41.6337C108.061 38.1275 104.945 35.3731 100.905 33.3681C96.8667 31.3647 92.8016 30.3618 88.7131 30.3618C83.4247 30.3618 78.5885 31.3389 74.201 33.2923C69.8111 35.2456 66.0474 37.928 62.9059 41.3333C59.7643 44.7401 57.3198 48.6726 55.5754 53.1293C53.8287 57.589 52.9572 62.274 52.9572 67.1813C52.9572 72.1925 53.8287 76.8995 55.5754 81.3069C57.3191 85.7173 59.7636 89.6241 62.9059 93.0293C66.0474 96.4361 69.8119 99.1155 74.201 101.069C78.5885 103.022 83.4247 103.999 88.7131 103.999C92.8016 103.999 96.8667 102.997 100.905 100.994C104.945 98.9911 108.061 96.2359 110.256 92.7282V102.195H126.563V32.1642H110.256V41.6337ZM108.76 75.7472C107.762 78.4531 106.366 80.8078 104.572 82.8112C102.776 84.8161 100.606 86.4183 98.0637 87.6206C95.5202 88.823 92.7004 89.4238 89.6103 89.4238C86.5178 89.4238 83.7252 88.823 81.2324 87.6206C78.7388 86.4183 76.5949 84.8161 74.7998 82.8112C73.004 80.8078 71.6319 78.4531 70.6856 75.7472C69.7356 73.0421 69.2644 70.1868 69.2644 67.1821C69.2644 64.1758 69.7356 61.3205 70.6856 58.6154C71.6319 55.9102 73.004 53.5571 74.7998 51.5522C76.5949 49.5495 78.738 47.9451 81.2324 46.7427C83.7252 45.5404 86.5178 44.9396 89.6103 44.9396C92.7012 44.9396 95.5202 45.5404 98.0637 46.7427C100.606 47.9451 102.776 49.5487 104.572 51.5522C106.367 53.5571 107.762 55.9102 108.76 58.6154C109.756 61.3205 110.256 64.1758 110.256 67.1821C110.256 70.1868 109.756 73.0421 108.76 75.7472Z" fill="currentColor" />
                        <path d="M242.805 41.6337C240.611 38.1275 237.494 35.3731 233.455 33.3681C229.416 31.3647 225.351 30.3618 221.262 30.3618C215.974 30.3618 211.138 31.3389 206.75 33.2923C202.36 35.2456 198.597 37.928 195.455 41.3333C192.314 44.7401 189.869 48.6726 188.125 53.1293C186.378 57.589 185.507 62.274 185.507 67.1813C185.507 72.1925 186.378 76.8995 188.125 81.3069C189.868 85.7173 192.313 89.6241 195.455 93.0293C198.597 96.4361 202.361 99.1155 206.75 101.069C211.138 103.022 215.974 103.999 221.262 103.999C225.351 103.999 229.416 102.997 233.455 100.994C237.494 98.9911 240.611 96.2359 242.805 92.7282V102.195H259.112V32.1642H242.805V41.6337ZM241.31 75.7472C240.312 78.4531 238.916 80.8078 237.122 82.8112C235.326 84.8161 233.156 86.4183 230.614 87.6206C228.07 88.823 225.251 89.4238 222.16 89.4238C219.068 89.4238 216.275 88.823 213.782 87.6206C211.289 86.4183 209.145 84.8161 207.35 82.8112C205.554 80.8078 204.182 78.4531 203.236 75.7472C202.286 73.0421 201.814 70.1868 201.814 67.1821C201.814 64.1758 202.286 61.3205 203.236 58.6154C204.182 55.9102 205.554 53.5571 207.35 51.5522C209.145 49.5495 211.288 47.9451 213.782 46.7427C216.275 45.5404 219.068 44.9396 222.16 44.9396C225.251 44.9396 228.07 45.5404 230.614 46.7427C233.156 47.9451 235.326 49.5487 237.122 51.5522C238.917 53.5571 240.312 55.9102 241.31 58.6154C242.306 61.3205 242.806 64.1758 242.806 67.1821C242.805 70.1868 242.305 73.0421 241.31 75.7472Z" fill="currentColor" />
                        <path d="M438 -3H421.694V102.197H438V-3Z" fill="currentColor" />
                        <path d="M139.43 102.197H155.735V48.2834H183.712V32.1665H139.43V102.197Z" fill="currentColor" />
                        <path d="M324.49 32.1665L303.995 85.794L283.498 32.1665H266.983L293.748 102.197H314.242L341.006 32.1665H324.49Z" fill="currentColor" />
                        <path d="M376.571 30.3656C356.603 30.3656 340.797 46.8497 340.797 67.1828C340.797 89.6597 356.094 104 378.661 104C391.29 104 399.354 99.1488 409.206 88.5848L398.189 80.0226C398.183 80.031 389.874 90.9895 377.468 90.9895C363.048 90.9895 356.977 79.3111 356.977 73.269H411.075C413.917 50.1328 398.775 30.3656 376.571 30.3656ZM357.02 61.0967C357.145 59.7487 359.023 43.3761 376.442 43.3761C393.861 43.3761 395.978 59.7464 396.099 61.0967H357.02Z" fill="currentColor" />
                    </svg>

                    {{-- Light Mode 12 SVG --}}
                    <svg class="w-[448px] max-w-none relative -mt-[4.9rem] -ml-8 lg:ml-0 lg:-mt-[6.6rem] dark:hidden" viewBox="0 0 440 376" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M188.263 355.73L188.595 355.73C195.441 348.845 205.766 339.761 219.569 328.477C232.93 317.193 242.978 308.205 249.714 301.511C256.34 294.626 260.867 287.358 263.296 279.708C265.725 272.058 264.565 264.121 259.816 255.896C254.516 246.716 247.062 239.352 237.454 233.805C227.957 228.067 217.908 225.198 207.307 225.198C196.927 225.197 190.136 227.97 186.934 233.516C183.621 238.872 184.726 246.331 190.247 255.894L125.647 255.891C116.371 239.825 112.395 225.481 113.72 212.858C115.265 200.235 121.559 190.481 132.602 183.596C143.754 176.52 158.607 172.982 177.159 172.983C196.594 172.984 215.863 176.523 234.968 183.6C253.961 190.486 271.299 200.241 286.98 212.864C302.661 225.488 315.14 239.833 324.416 255.899C333.03 270.817 336.841 283.918 335.847 295.203C335.075 306.487 331.376 316.336 324.75 324.751C318.346 333.167 308.408 343.494 294.936 355.734L377.094 355.737L405.917 405.656L217.087 405.649L188.263 355.73Z" fill="black" />
                            <path d="M9.11884 226.339L-13.7396 226.338L-42.7286 176.132L43.0733 176.135L175.595 405.649L112.651 405.647L9.11884 226.339Z" fill="black" />
                            <path d="M188.263 355.73L188.595 355.73C195.441 348.845 205.766 339.761 219.569 328.477C232.93 317.193 242.978 308.205 249.714 301.511C256.34 294.626 260.867 287.358 263.296 279.708C265.725 272.058 264.565 264.121 259.816 255.896C254.516 246.716 247.062 239.352 237.454 233.805C227.957 228.067 217.908 225.198 207.307 225.198C196.927 225.197 190.136 227.97 186.934 233.516C183.621 238.872 184.726 246.331 190.247 255.894L125.647 255.891C116.371 239.825 112.395 225.481 113.72 212.858C115.265 200.235 121.559 190.481 132.602 183.596C143.754 176.52 158.607 172.982 177.159 172.983C196.594 172.984 215.863 176.523 234.968 183.6C253.961 190.486 271.299 200.241 286.98 212.864C302.661 225.488 315.14 239.833 324.416 255.899C333.03 270.817 336.841 283.918 335.847 295.203C335.075 306.487 331.376 316.336 324.75 324.751C318.346 333.167 308.408 343.494 294.936 355.734L377.094 355.737L405.917 405.656L217.087 405.649L188.263 355.73Z" stroke="#1B1B18" stroke-width="1" />
                            <path d="M9.11884 226.339L-13.7396 226.338L-42.7286 176.132L43.0733 176.135L175.595 405.649L112.651 405.647L9.11884 226.339Z" stroke="#1B1B18" stroke-width="1" />
                            <path d="M204.592 327.449L204.923 327.449C211.769 320.564 222.094 311.479 235.897 300.196C249.258 288.912 259.306 279.923 266.042 273.23C272.668 266.345 277.195 259.077 279.624 251.427C282.053 243.777 280.893 235.839 276.145 227.615C270.844 218.435 263.39 211.071 253.782 205.524C244.285 199.786 234.236 196.917 223.635 196.916C213.255 196.916 206.464 199.689 203.262 205.235C199.949 210.59 201.054 218.049 206.575 227.612L141.975 227.61C132.699 211.544 128.723 197.2 130.048 184.577C131.593 171.954 137.887 162.2 148.93 155.315C160.083 148.239 174.935 144.701 193.487 144.702C212.922 144.703 232.192 148.242 251.296 155.319C270.289 162.205 287.627 171.96 303.308 184.583C318.989 197.207 331.468 211.552 340.745 227.618C349.358 242.536 353.169 255.637 352.175 266.921C351.403 278.205 347.704 288.055 341.078 296.47C334.674 304.885 324.736 315.213 311.264 327.453L393.422 327.456L422.246 377.375L233.415 377.368L204.592 327.449Z" fill="#F8B803" />
                            <path d="M25.447 198.058L2.58852 198.057L-26.4005 147.851L59.4015 147.854L191.923 377.368L128.979 377.365L25.447 198.058Z" fill="#F8B803" />
                            <path d="M204.592 327.449L204.923 327.449C211.769 320.564 222.094 311.479 235.897 300.196C249.258 288.912 259.306 279.923 266.042 273.23C272.668 266.345 277.195 259.077 279.624 251.427C282.053 243.777 280.893 235.839 276.145 227.615C270.844 218.435 263.39 211.071 253.782 205.524C244.285 199.786 234.236 196.917 223.635 196.916C213.255 196.916 206.464 199.689 203.262 205.235C199.949 210.59 201.054 218.049 206.575 227.612L141.975 227.61C132.699 211.544 128.723 197.2 130.048 184.577C131.593 171.954 137.887 162.2 148.93 155.315C160.083 148.239 174.935 144.701 193.487 144.702C212.922 144.703 232.192 148.242 251.296 155.319C270.289 162.205 287.627 171.96 303.308 184.583C318.989 197.207 331.468 211.552 340.745 227.618C349.358 242.536 353.169 255.637 352.175 266.921C351.403 278.205 347.704 288.055 341.078 296.47C334.674 304.885 324.736 315.213 311.264 327.453L393.422 327.456L422.246 377.375L233.415 377.368L204.592 327.449Z" stroke="#1B1B18" stroke-width="1" />
                            <path d="M25.447 198.058L2.58852 198.057L-26.4005 147.851L59.4015 147.854L191.923 377.368L128.979 377.365L25.447 198.058Z" stroke="#1B1B18" stroke-width="1" />
                        </g>
                        <g style="mix-blend-mode: hard-light" class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M217.342 305.363L217.673 305.363C224.519 298.478 234.844 289.393 248.647 278.11C262.008 266.826 272.056 257.837 278.792 251.144C285.418 244.259 289.945 236.991 292.374 229.341C294.803 221.691 293.643 213.753 288.895 205.529C283.594 196.349 276.14 188.985 266.532 183.438C257.035 177.7 246.986 174.831 236.385 174.83C226.005 174.83 219.214 177.603 216.012 183.149C212.699 188.504 213.804 195.963 219.325 205.527L154.725 205.524C145.449 189.458 141.473 175.114 142.798 162.491C144.343 149.868 150.637 140.114 161.68 133.229C172.833 126.153 187.685 122.615 206.237 122.616C225.672 122.617 244.942 126.156 264.046 133.233C283.039 140.119 300.377 149.874 316.058 162.497C331.739 175.121 344.218 189.466 353.495 205.532C362.108 220.45 365.919 233.551 364.925 244.835C364.153 256.12 360.454 265.969 353.828 274.384C347.424 282.799 337.486 293.127 324.014 305.367L406.172 305.37L434.996 355.289L246.165 355.282L217.342 305.363Z" fill="#F0ACB8" />
                            <path d="M38.197 175.972L15.3385 175.971L-13.6505 125.765L72.1515 125.768L204.673 355.282L141.729 355.279L38.197 175.972Z" fill="#F0ACB8" />
                            <path d="M217.342 305.363L217.673 305.363C224.519 298.478 234.844 289.393 248.647 278.11C262.008 266.826 272.056 257.837 278.792 251.144C285.418 244.259 289.945 236.991 292.374 229.341C294.803 221.691 293.643 213.753 288.895 205.529C283.594 196.349 276.14 188.985 266.532 183.438C257.035 177.7 246.986 174.831 236.385 174.83C226.005 174.83 219.214 177.603 216.012 183.149C212.699 188.504 213.804 195.963 219.325 205.527L154.725 205.524C145.449 189.458 141.473 175.114 142.798 162.491C144.343 149.868 150.637 140.114 161.68 133.229C172.833 126.153 187.685 122.615 206.237 122.616C225.672 122.617 244.942 126.156 264.046 133.233C283.039 140.119 300.377 149.874 316.058 162.497C331.739 175.121 344.218 189.466 353.495 205.532C362.108 220.45 365.919 233.551 364.925 244.835C364.153 256.12 360.454 265.969 353.828 274.384C347.424 282.799 337.486 293.127 324.014 305.367L406.172 305.37L434.996 355.289L246.165 355.282L217.342 305.363Z" stroke="#1B1B18" stroke-width="1" />
                            <path d="M38.197 175.972L15.3385 175.971L-13.6505 125.765L72.1515 125.768L204.673 355.282L141.729 355.279L38.197 175.972Z" stroke="#1B1B18" stroke-width="1" />
                        </g>
                        <g style="mix-blend-mode: plus-darker" class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M230.951 281.792L231.282 281.793C238.128 274.907 248.453 265.823 262.256 254.539C275.617 243.256 285.666 234.267 292.402 227.573C299.027 220.688 303.554 213.421 305.983 205.771C308.412 198.12 307.253 190.183 302.504 181.959C297.203 172.778 289.749 165.415 280.142 159.868C270.645 154.13 260.596 151.26 249.995 151.26C239.615 151.26 232.823 154.033 229.621 159.579C226.309 164.934 227.413 172.393 232.935 181.956L168.335 181.954C159.058 165.888 155.082 151.543 156.407 138.92C157.953 126.298 164.247 116.544 175.289 109.659C186.442 102.583 201.294 99.045 219.846 99.0457C239.281 99.0464 258.551 102.585 277.655 109.663C296.649 116.549 313.986 126.303 329.667 138.927C345.349 151.551 357.827 165.895 367.104 181.961C375.718 196.88 379.528 209.981 378.535 221.265C377.762 232.549 374.063 242.399 367.438 250.814C361.033 259.229 351.095 269.557 337.624 281.796L419.782 281.8L448.605 331.719L259.774 331.712L230.951 281.792Z" fill="#F3BEC7" />
                            <path d="M51.8063 152.402L28.9479 152.401L-0.0411453 102.195L85.7608 102.198L218.282 331.711L155.339 331.709L51.8063 152.402Z" fill="#F3BEC7" />
                            <path d="M230.951 281.792L231.282 281.793C238.128 274.907 248.453 265.823 262.256 254.539C275.617 243.256 285.666 234.267 292.402 227.573C299.027 220.688 303.554 213.421 305.983 205.771C308.412 198.12 307.253 190.183 302.504 181.959C297.203 172.778 289.749 165.415 280.142 159.868C270.645 154.13 260.596 151.26 249.995 151.26C239.615 151.26 232.823 154.033 229.621 159.579C226.309 164.934 227.413 172.393 232.935 181.956L168.335 181.954C159.058 165.888 155.082 151.543 156.407 138.92C157.953 126.298 164.247 116.544 175.289 109.659C186.442 102.583 201.294 99.045 219.846 99.0457C239.281 99.0464 258.551 102.585 277.655 109.663C296.649 116.549 313.986 126.303 329.667 138.927C345.349 151.551 357.827 165.895 367.104 181.961C375.718 196.88 379.528 209.981 378.535 221.265C377.762 232.549 374.063 242.399 367.438 250.814C361.033 259.229 351.095 269.557 337.624 281.796L419.782 281.8L448.605 331.719L259.774 331.712L230.951 281.792Z" stroke="#1B1B18" stroke-width="1" />
                            <path d="M51.8063 152.402L28.9479 152.401L-0.0411453 102.195L85.7608 102.198L218.282 331.711L155.339 331.709L51.8063 152.402Z" stroke="#1B1B18" stroke-width="1" />
                        </g>
                        <g class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M188.467 355.363L188.798 355.363C195.644 348.478 205.969 339.393 219.772 328.11C233.133 316.826 243.181 307.837 249.917 301.144C253.696 297.217 256.792 293.166 259.205 288.991C261.024 285.845 262.455 282.628 263.499 279.341C265.928 271.691 264.768 263.753 260.02 255.529C254.719 246.349 247.265 238.985 237.657 233.438C228.16 227.7 218.111 224.831 207.51 224.83C197.13 224.83 190.339 227.603 187.137 233.149C183.824 238.504 184.929 245.963 190.45 255.527L125.851 255.524C116.574 239.458 112.598 225.114 113.923 212.491C114.615 206.836 116.261 201.756 118.859 197.253C122.061 191.704 126.709 187.03 132.805 183.229C143.958 176.153 158.81 172.615 177.362 172.616C196.797 172.617 216.067 176.156 235.171 183.233C254.164 190.119 271.502 199.874 287.183 212.497C302.864 225.121 315.343 239.466 324.62 255.532C333.233 270.45 337.044 283.551 336.05 294.835C335.46 303.459 333.16 311.245 329.151 318.194C327.915 320.337 326.515 322.4 324.953 324.384C318.549 332.799 308.611 343.127 295.139 355.367L377.297 355.37L406.121 405.289L217.29 405.282L188.467 355.363Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M9.32197 225.972L-13.5365 225.971L-42.5255 175.765L43.2765 175.768L175.798 405.282L112.854 405.279L9.32197 225.972Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M345.247 111.915C329.566 99.2919 312.229 89.5371 293.235 82.6512L235.167 183.228C254.161 190.114 271.498 199.869 287.179 212.492L345.247 111.915Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M382.686 154.964C373.41 138.898 360.931 124.553 345.25 111.93L287.182 212.506C302.863 225.13 315.342 239.475 324.618 255.541L382.686 154.964Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M293.243 82.6472C274.139 75.57 254.869 72.031 235.434 72.0303L177.366 172.607C196.801 172.608 216.071 176.147 235.175 183.224L293.243 82.6472Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M394.118 194.257C395.112 182.973 391.301 169.872 382.688 154.953L324.619 255.53C333.233 270.448 337.044 283.55 336.05 294.834L394.118 194.257Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M235.432 72.0311C216.88 72.0304 202.027 75.5681 190.875 82.6442L132.806 183.221C143.959 176.145 158.812 172.607 177.363 172.608L235.432 72.0311Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M265.59 124.25C276.191 124.251 286.24 127.12 295.737 132.858L237.669 233.435C228.172 227.697 218.123 224.828 207.522 224.827L265.59 124.25Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M295.719 132.859C305.326 138.406 312.78 145.77 318.081 154.95L260.013 255.527C254.712 246.347 247.258 238.983 237.651 233.436L295.719 132.859Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M387.218 217.608C391.227 210.66 393.527 202.874 394.117 194.25L336.049 294.827C335.459 303.451 333.159 311.237 329.15 318.185L387.218 217.608Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M245.211 132.577C248.413 127.03 255.204 124.257 265.584 124.258L207.516 224.835C197.136 224.834 190.345 227.607 187.143 233.154L245.211 132.577Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M318.094 154.945C322.842 163.17 324.002 171.107 321.573 178.757L263.505 279.334C265.934 271.684 264.774 263.746 260.026 255.522L318.094 154.945Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M176.925 96.6737C180.127 91.1249 184.776 86.4503 190.871 82.6499L132.803 183.227C126.708 187.027 122.059 191.702 118.857 197.25L176.925 96.6737Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M387.226 217.606C385.989 219.749 384.59 221.813 383.028 223.797L324.96 324.373C326.522 322.39 327.921 320.326 329.157 318.183L387.226 217.606Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M317.269 188.408C319.087 185.262 320.519 182.045 321.562 178.758L263.494 279.335C262.451 282.622 261.019 285.839 259.201 288.985L317.269 188.408Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M245.208 132.573C241.895 137.928 243 145.387 248.522 154.95L190.454 255.527C184.932 245.964 183.827 238.505 187.14 233.15L245.208 132.573Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M176.93 96.6719C174.331 101.175 172.686 106.255 171.993 111.91L113.925 212.487C114.618 206.831 116.263 201.752 118.862 197.249L176.93 96.6719Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M317.266 188.413C314.853 192.589 311.757 196.64 307.978 200.566L249.91 301.143C253.689 297.216 256.785 293.166 259.198 288.99L317.266 188.413Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M464.198 304.708L435.375 254.789L377.307 355.366L406.13 405.285L464.198 304.708Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M353.209 254.787C366.68 242.548 376.618 232.22 383.023 223.805L324.955 324.382C318.55 332.797 308.612 343.124 295.141 355.364L353.209 254.787Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M435.37 254.787L353.212 254.784L295.144 355.361L377.302 355.364L435.37 254.787Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M183.921 154.947L248.521 154.95L190.453 255.527L125.853 255.524L183.921 154.947Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M171.992 111.914C170.668 124.537 174.643 138.881 183.92 154.947L125.852 255.524C116.575 239.458 112.599 225.114 113.924 212.491L171.992 111.914Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M307.987 200.562C301.251 207.256 291.203 216.244 277.842 227.528L219.774 328.105C233.135 316.821 243.183 307.832 249.919 301.139L307.987 200.562Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M15.5469 75.1797L44.5359 125.386L-13.5321 225.963L-42.5212 175.756L15.5469 75.1797Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M277.836 227.536C264.033 238.82 253.708 247.904 246.862 254.789L188.794 355.366C195.64 348.481 205.965 339.397 219.768 328.113L277.836 227.536Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M275.358 304.706L464.189 304.713L406.12 405.29L217.29 405.283L275.358 304.706Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M44.5279 125.39L67.3864 125.39L9.31834 225.967L-13.5401 225.966L44.5279 125.39Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M101.341 75.1911L233.863 304.705L175.795 405.282L43.2733 175.768L101.341 75.1911ZM15.5431 75.19L-42.525 175.767L43.277 175.77L101.345 75.1932L15.5431 75.19Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M246.866 254.784L246.534 254.784L188.466 355.361L188.798 355.361L246.866 254.784Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M246.539 254.781L275.362 304.701L217.294 405.277L188.471 355.358L246.539 254.781Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M67.3906 125.391L170.923 304.698L112.855 405.275L9.32257 225.967L67.3906 125.391Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                            <path d="M170.921 304.699L233.865 304.701L175.797 405.278L112.853 405.276L170.921 304.699Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="bevel" />
                        </g>
                        <g style="mix-blend-mode: hard-light" class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M246.544 254.79L246.875 254.79C253.722 247.905 264.046 238.82 277.849 227.537C291.21 216.253 301.259 207.264 307.995 200.57C314.62 193.685 319.147 186.418 321.577 178.768C324.006 171.117 322.846 163.18 318.097 154.956C312.796 145.775 305.342 138.412 295.735 132.865C286.238 127.127 276.189 124.258 265.588 124.257C255.208 124.257 248.416 127.03 245.214 132.576C241.902 137.931 243.006 145.39 248.528 154.953L183.928 154.951C174.652 138.885 170.676 124.541 172 111.918C173.546 99.2946 179.84 89.5408 190.882 82.6559C202.035 75.5798 216.887 72.0421 235.439 72.0428C254.874 72.0435 274.144 75.5825 293.248 82.6598C312.242 89.5457 329.579 99.3005 345.261 111.924C360.942 124.548 373.421 138.892 382.697 154.958C391.311 169.877 395.121 182.978 394.128 194.262C393.355 205.546 389.656 215.396 383.031 223.811C376.627 232.226 366.688 242.554 353.217 254.794L435.375 254.797L464.198 304.716L275.367 304.709L246.544 254.79Z" fill="#F0ACB8" />
                            <path d="M246.544 254.79L246.875 254.79C253.722 247.905 264.046 238.82 277.849 227.537C291.21 216.253 301.259 207.264 307.995 200.57C314.62 193.685 319.147 186.418 321.577 178.768C324.006 171.117 322.846 163.18 318.097 154.956C312.796 145.775 305.342 138.412 295.735 132.865C286.238 127.127 276.189 124.258 265.588 124.257C255.208 124.257 248.416 127.03 245.214 132.576C241.902 137.931 243.006 145.39 248.528 154.953L183.928 154.951C174.652 138.885 170.676 124.541 172 111.918C173.546 99.2946 179.84 89.5408 190.882 82.6559C202.035 75.5798 216.887 72.0421 235.439 72.0428C254.874 72.0435 274.144 75.5825 293.248 82.6598C312.242 89.5457 329.579 99.3005 345.261 111.924C360.942 124.548 373.421 138.892 382.697 154.958C391.311 169.877 395.121 182.978 394.128 194.262C393.355 205.546 389.656 215.396 383.031 223.811C376.627 232.226 366.688 242.554 353.217 254.794L435.375 254.797L464.198 304.716L275.367 304.709L246.544 254.79Z" stroke="#1B1B18" stroke-width="1" stroke-linejoin="round" />
                        </g>
                        <g style="mix-blend-mode: hard-light" class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M67.41 125.402L44.5515 125.401L15.5625 75.1953L101.364 75.1985L233.886 304.712L170.942 304.71L67.41 125.402Z" fill="#F0ACB8" />
                            <path d="M67.41 125.402L44.5515 125.401L15.5625 75.1953L101.364 75.1985L233.886 304.712L170.942 304.71L67.41 125.402Z" stroke="#1B1B18" stroke-width="1" />
                        </g>
                    </svg>

                    {{-- Dark Mode 12 SVG --}}
                    <svg class="w-[448px] max-w-none relative -mt-[4.9rem] -ml-8 lg:ml-0 lg:-mt-[6.6rem] hidden dark:block" viewBox="0 0 440 376" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M188.263 355.73L188.595 355.73C195.441 348.845 205.766 339.761 219.569 328.477C232.93 317.193 242.978 308.205 249.714 301.511C256.34 294.626 260.867 287.358 263.296 279.708C265.725 272.058 264.565 264.121 259.816 255.896C254.516 246.716 247.062 239.352 237.454 233.805C227.957 228.067 217.908 225.198 207.307 225.198C196.927 225.197 190.136 227.97 186.934 233.516C183.621 238.872 184.726 246.331 190.247 255.894L125.647 255.891C116.371 239.825 112.395 225.481 113.72 212.858C115.265 200.235 121.559 190.481 132.602 183.596C143.754 176.52 158.607 172.982 177.159 172.983C196.594 172.984 215.863 176.523 234.968 183.6C253.961 190.486 271.299 200.241 286.98 212.864C302.661 225.488 315.14 239.833 324.416 255.899C333.03 270.817 336.841 283.918 335.847 295.203C335.075 306.487 331.376 316.336 324.75 324.751C318.346 333.167 308.408 343.494 294.936 355.734L377.094 355.737L405.917 405.656L217.087 405.649L188.263 355.73Z" fill="black"/>
                            <path d="M9.11884 226.339L-13.7396 226.338L-42.7286 176.132L43.0733 176.135L175.595 405.649L112.651 405.647L9.11884 226.339Z" fill="black"/>
                            <path d="M188.263 355.73L188.595 355.73C195.441 348.845 205.766 339.761 219.569 328.477C232.93 317.193 242.978 308.205 249.714 301.511C256.34 294.626 260.867 287.358 263.296 279.708C265.725 272.058 264.565 264.121 259.816 255.896C254.516 246.716 247.062 239.352 237.454 233.805C227.957 228.067 217.908 225.198 207.307 225.198C196.927 225.197 190.136 227.97 186.934 233.516C183.621 238.872 184.726 246.331 190.247 255.894L125.647 255.891C116.371 239.825 112.395 225.481 113.72 212.858C115.265 200.235 121.559 190.481 132.602 183.596C143.754 176.52 158.607 172.982 177.159 172.983C196.594 172.984 215.863 176.523 234.968 183.6C253.961 190.486 271.299 200.241 286.98 212.864C302.661 225.488 315.14 239.833 324.416 255.899C333.03 270.817 336.841 283.918 335.847 295.203C335.075 306.487 331.376 316.336 324.75 324.751C318.346 333.167 308.408 343.494 294.936 355.734L377.094 355.737L405.917 405.656L217.087 405.649L188.263 355.73Z" stroke="#FF750F" stroke-width="1"/>
                            <path d="M9.11884 226.339L-13.7396 226.338L-42.7286 176.132L43.0733 176.135L175.595 405.649L112.651 405.647L9.11884 226.339Z" stroke="#FF750F" stroke-width="1"/>
                            <path d="M204.592 327.449L204.923 327.449C211.769 320.564 222.094 311.479 235.897 300.196C249.258 288.912 259.306 279.923 266.042 273.23C272.668 266.345 277.195 259.077 279.624 251.427C282.053 243.777 280.893 235.839 276.145 227.615C270.844 218.435 263.39 211.071 253.782 205.524C244.285 199.786 234.236 196.917 223.635 196.916C213.255 196.916 206.464 199.689 203.262 205.235C199.949 210.59 201.054 218.049 206.575 227.612L141.975 227.61C132.699 211.544 128.723 197.2 130.048 184.577C131.593 171.954 137.887 162.2 148.93 155.315C160.083 148.239 174.935 144.701 193.487 144.702C212.922 144.703 232.192 148.242 251.296 155.319C270.289 162.205 287.627 171.96 303.308 184.583C318.989 197.207 331.468 211.552 340.745 227.618C349.358 242.536 353.169 255.637 352.175 266.921C351.403 278.205 347.704 288.055 341.078 296.47C334.674 304.885 324.736 315.213 311.264 327.453L393.422 327.456L422.246 377.375L233.415 377.368L204.592 327.449Z" fill="#391800"/>
                            <path d="M25.447 198.058L2.58852 198.057L-26.4005 147.851L59.4015 147.854L191.923 377.368L128.979 377.365L25.447 198.058Z" fill="#391800"/>
                            <path d="M204.592 327.449L204.923 327.449C211.769 320.564 222.094 311.479 235.897 300.196C249.258 288.912 259.306 279.923 266.042 273.23C272.668 266.345 277.195 259.077 279.624 251.427C282.053 243.777 280.893 235.839 276.145 227.615C270.844 218.435 263.39 211.071 253.782 205.524C244.285 199.786 234.236 196.917 223.635 196.916C213.255 196.916 206.464 199.689 203.262 205.235C199.949 210.59 201.054 218.049 206.575 227.612L141.975 227.61C132.699 211.544 128.723 197.2 130.048 184.577C131.593 171.954 137.887 162.2 148.93 155.315C160.083 148.239 174.935 144.701 193.487 144.702C212.922 144.703 232.192 148.242 251.296 155.319C270.289 162.205 287.627 171.96 303.308 184.583C318.989 197.207 331.468 211.552 340.745 227.618C349.358 242.536 353.169 255.637 352.175 266.921C351.403 278.205 347.704 288.055 341.078 296.47C334.674 304.885 324.736 315.213 311.264 327.453L393.422 327.456L422.246 377.375L233.415 377.368L204.592 327.449Z" stroke="#FF750F" stroke-width="1"/>
                            <path d="M25.447 198.058L2.58852 198.057L-26.4005 147.851L59.4015 147.854L191.923 377.368L128.979 377.365L25.447 198.058Z" stroke="#FF750F" stroke-width="1"/>
                        </g>
                        <g class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4" style="mix-blend-mode:hard-light">
                            <path d="M217.342 305.363L217.673 305.363C224.519 298.478 234.844 289.393 248.647 278.11C262.008 266.826 272.056 257.837 278.792 251.144C285.418 244.259 289.945 236.991 292.374 229.341C294.803 221.691 293.643 213.753 288.895 205.529C283.594 196.349 276.14 188.985 266.532 183.438C257.035 177.7 246.986 174.831 236.385 174.83C226.005 174.83 219.214 177.603 216.012 183.149C212.699 188.504 213.804 195.963 219.325 205.527L154.725 205.524C145.449 189.458 141.473 175.114 142.798 162.491C144.343 149.868 150.637 140.114 161.68 133.229C172.833 126.153 187.685 122.615 206.237 122.616C225.672 122.617 244.942 126.156 264.046 133.233C283.039 140.119 300.377 149.874 316.058 162.497C331.739 175.121 344.218 189.466 353.495 205.532C362.108 220.45 365.919 233.551 364.925 244.835C364.153 256.12 360.454 265.969 353.828 274.384C347.424 282.799 337.486 293.127 324.014 305.367L406.172 305.37L434.996 355.289L246.165 355.282L217.342 305.363Z" fill="#733000"/>
                            <path d="M38.197 175.972L15.3385 175.971L-13.6505 125.765L72.1515 125.768L204.673 355.282L141.729 355.279L38.197 175.972Z" fill="#733000"/>
                            <path d="M217.342 305.363L217.673 305.363C224.519 298.478 234.844 289.393 248.647 278.11C262.008 266.826 272.056 257.837 278.792 251.144C285.418 244.259 289.945 236.991 292.374 229.341C294.803 221.691 293.643 213.753 288.895 205.529C283.594 196.349 276.14 188.985 266.532 183.438C257.035 177.7 246.986 174.831 236.385 174.83C226.005 174.83 219.214 177.603 216.012 183.149C212.699 188.504 213.804 195.963 219.325 205.527L154.725 205.524C145.449 189.458 141.473 175.114 142.798 162.491C144.343 149.868 150.637 140.114 161.68 133.229C172.833 126.153 187.685 122.615 206.237 122.616C225.672 122.617 244.942 126.156 264.046 133.233C283.039 140.119 300.377 149.874 316.058 162.497C331.739 175.121 344.218 189.466 353.495 205.532C362.108 220.45 365.919 233.551 364.925 244.835C364.153 256.12 360.454 265.969 353.828 274.384C347.424 282.799 337.486 293.127 324.014 305.367L406.172 305.37L434.996 355.289L246.165 355.282L217.342 305.363Z" stroke="#FF750F" stroke-width="1"/>
                            <path d="M38.197 175.972L15.3385 175.971L-13.6505 125.765L72.1515 125.768L204.673 355.282L141.729 355.279L38.197 175.972Z" stroke="#FF750F" stroke-width="1"/>
                        </g>
                        <g class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M217.342 305.363L217.673 305.363C224.519 298.478 234.844 289.393 248.647 278.11C262.008 266.826 272.056 257.837 278.792 251.144C285.418 244.259 289.945 236.991 292.374 229.341C294.803 221.691 293.643 213.753 288.895 205.529C283.594 196.349 276.14 188.985 266.532 183.438C257.035 177.7 246.986 174.831 236.385 174.83C226.005 174.83 219.214 177.603 216.012 183.149C212.699 188.504 213.804 195.963 219.325 205.527L154.726 205.524C145.449 189.458 141.473 175.114 142.798 162.491C144.343 149.868 150.637 140.114 161.68 133.229C172.833 126.153 187.685 122.615 206.237 122.616C225.672 122.617 244.942 126.156 264.046 133.233C283.039 140.119 300.377 149.874 316.058 162.497C331.739 175.121 344.218 189.466 353.495 205.532C362.108 220.45 365.919 233.551 364.925 244.835C364.153 256.12 360.454 265.969 353.828 274.384C347.424 282.799 337.486 293.127 324.014 305.367L406.172 305.37L434.996 355.289L246.165 355.282L217.342 305.363Z" stroke="#FF750F" stroke-width="1"/>
                            <path d="M38.197 175.972L15.3385 175.971L-13.6505 125.765L72.1515 125.768L204.673 355.282L141.729 355.279L38.197 175.972Z" stroke="#FF750F" stroke-width="1"/>
                        </g>
                        <g class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4">
                            <path d="M188.467 355.363L188.798 355.363C195.644 348.478 205.969 339.393 219.772 328.11C233.133 316.826 243.181 307.837 249.917 301.144C253.696 297.217 256.792 293.166 259.205 288.991C261.024 285.845 262.455 282.628 263.499 279.341C265.928 271.691 264.768 263.753 260.02 255.529C254.719 246.349 247.265 238.985 237.657 233.438C228.16 227.7 218.111 224.831 207.51 224.83C197.13 224.83 190.339 227.603 187.137 233.149C183.824 238.504 184.929 245.963 190.45 255.527L125.851 255.524C116.574 239.458 112.598 225.114 113.923 212.491C114.615 206.836 116.261 201.756 118.859 197.253C122.061 191.704 126.709 187.03 132.805 183.229C143.958 176.153 158.81 172.615 177.362 172.616C196.797 172.617 216.067 176.156 235.171 183.233C254.164 190.119 271.502 199.874 287.183 212.497C302.864 225.121 315.343 239.466 324.62 255.532C333.233 270.45 337.044 283.551 336.05 294.835C335.46 303.459 333.16 311.245 329.151 318.194C327.915 320.337 326.515 322.4 324.953 324.384C318.549 332.799 308.611 343.127 295.139 355.367L377.297 355.37L406.121 405.289L217.29 405.282L188.467 355.363Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M9.32197 225.972L-13.5365 225.971L-42.5255 175.765L43.2765 175.768L175.798 405.282L112.854 405.279L9.32197 225.972Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M345.247 111.915C329.566 99.2919 312.229 89.5371 293.235 82.6512L235.167 183.228C254.161 190.114 271.498 199.869 287.179 212.492L345.247 111.915Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M382.686 154.964C373.41 138.898 360.931 124.553 345.25 111.93L287.182 212.506C302.863 225.13 315.342 239.475 324.618 255.541L382.686 154.964Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M293.243 82.6472C274.139 75.57 254.869 72.031 235.434 72.0303L177.366 172.607C196.801 172.608 216.071 176.147 235.175 183.224L293.243 82.6472Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M394.118 194.257C395.112 182.973 391.301 169.872 382.688 154.953L324.619 255.53C333.233 270.448 337.044 283.55 336.05 294.834L394.118 194.257Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M235.432 72.0311C216.88 72.0304 202.027 75.5681 190.875 82.6442L132.806 183.221C143.959 176.145 158.812 172.607 177.363 172.608L235.432 72.0311Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M265.59 124.25C276.191 124.251 286.24 127.12 295.737 132.858L237.669 233.435C228.172 227.697 218.123 224.828 207.522 224.827L265.59 124.25Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M295.719 132.859C305.326 138.406 312.78 145.77 318.081 154.95L260.013 255.527C254.712 246.347 247.258 238.983 237.651 233.436L295.719 132.859Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M387.218 217.608C391.227 210.66 393.527 202.874 394.117 194.25L336.049 294.827C335.459 303.451 333.159 311.237 329.15 318.185L387.218 217.608Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M245.211 132.577C248.413 127.03 255.204 124.257 265.584 124.258L207.516 224.835C197.136 224.834 190.345 227.607 187.143 233.154L245.211 132.577Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M318.094 154.945C322.842 163.17 324.002 171.107 321.573 178.757L263.505 279.334C265.934 271.684 264.774 263.746 260.026 255.522L318.094 154.945Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M176.925 96.6737C180.127 91.1249 184.776 86.4503 190.871 82.6499L132.803 183.227C126.708 187.027 122.059 191.702 118.857 197.25L176.925 96.6737Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M387.226 217.606C385.989 219.749 384.59 221.813 383.028 223.797L324.96 324.373C326.522 322.39 327.921 320.326 329.157 318.183L387.226 217.606Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M317.269 188.408C319.087 185.262 320.519 182.045 321.562 178.758L263.494 279.335C262.451 282.622 261.019 285.839 259.201 288.985L317.269 188.408Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M245.208 132.573C241.895 137.928 243 145.387 248.522 154.95L190.454 255.527C184.932 245.964 183.827 238.505 187.14 233.15L245.208 132.573Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M176.93 96.6719C174.331 101.175 172.686 106.255 171.993 111.91L113.925 212.487C114.618 206.831 116.263 201.752 118.862 197.249L176.93 96.6719Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M317.266 188.413C314.853 192.589 311.757 196.64 307.978 200.566L249.91 301.143C253.689 297.216 256.785 293.166 259.198 288.99L317.266 188.413Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M464.198 304.708L435.375 254.789L377.307 355.366L406.13 405.285L464.198 304.708Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M353.209 254.787C366.68 242.548 376.618 232.22 383.023 223.805L324.955 324.382C318.55 332.797 308.612 343.124 295.141 355.364L353.209 254.787Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M435.37 254.787L353.212 254.784L295.144 355.361L377.302 355.364L435.37 254.787Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M183.921 154.947L248.521 154.95L190.453 255.527L125.853 255.524L183.921 154.947Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M171.992 111.914C170.668 124.537 174.643 138.881 183.92 154.947L125.852 255.524C116.575 239.458 112.599 225.114 113.924 212.491L171.992 111.914Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M307.987 200.562C301.251 207.256 291.203 216.244 277.842 227.528L219.774 328.105C233.135 316.821 243.183 307.832 249.919 301.139L307.987 200.562Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M15.5469 75.1797L44.5359 125.386L-13.5321 225.963L-42.5212 175.756L15.5469 75.1797Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M277.836 227.536C264.033 238.82 253.708 247.904 246.862 254.789L188.794 355.366C195.64 348.481 205.965 339.397 219.768 328.113L277.836 227.536Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M275.358 304.706L464.189 304.713L406.12 405.29L217.29 405.283L275.358 304.706Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M44.5279 125.39L67.3864 125.39L9.31834 225.967L-13.5401 225.966L44.5279 125.39Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M101.341 75.1911L233.863 304.705L175.795 405.282L43.2733 175.768L101.341 75.1911ZM15.5431 75.19L-42.525 175.767L43.277 175.77L101.345 75.1932L15.5431 75.19Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M246.866 254.784L246.534 254.784L188.466 355.361L188.798 355.361L246.866 254.784Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M246.539 254.781L275.362 304.701L217.294 405.277L188.471 355.358L246.539 254.781Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M67.3906 125.391L170.923 304.698L112.855 405.275L9.32257 225.967L67.3906 125.391Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                            <path d="M170.921 304.699L233.865 304.701L175.797 405.278L112.853 405.276L170.921 304.699Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="bevel"/>
                        </g>
                        <g class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4" style="mix-blend-mode:hard-light">
                            <path d="M246.544 254.79L246.875 254.79C253.722 247.905 264.046 238.82 277.849 227.537C291.21 216.253 301.259 207.264 307.995 200.57C314.62 193.685 319.147 186.418 321.577 178.768C324.006 171.117 322.846 163.18 318.097 154.956C312.796 145.775 305.342 138.412 295.735 132.865C286.238 127.127 276.189 124.258 265.588 124.257C255.208 124.257 248.416 127.03 245.214 132.576C241.902 137.931 243.006 145.39 248.528 154.953L183.928 154.951C174.652 138.885 170.676 124.541 172 111.918C173.546 99.2946 179.84 89.5408 190.882 82.6559C202.035 75.5798 216.887 72.0421 235.439 72.0428C254.874 72.0435 274.144 75.5825 293.248 82.6598C312.242 89.5457 329.579 99.3005 345.261 111.924C360.942 124.548 373.421 138.892 382.697 154.958C391.311 169.877 395.121 182.978 394.128 194.262C393.355 205.546 389.656 215.396 383.031 223.811C376.627 232.226 366.688 242.554 353.217 254.794L435.375 254.797L464.198 304.716L275.367 304.709L246.544 254.79Z" fill="#4B0600"/>
                            <path d="M246.544 254.79L246.875 254.79C253.722 247.905 264.046 238.82 277.849 227.537C291.21 216.253 301.259 207.264 307.995 200.57C314.62 193.685 319.147 186.418 321.577 178.768C324.006 171.117 322.846 163.18 318.097 154.956C312.796 145.775 305.342 138.412 295.735 132.865C286.238 127.127 276.189 124.258 265.588 124.257C255.208 124.257 248.416 127.03 245.214 132.576C241.902 137.931 243.006 145.39 248.528 154.953L183.928 154.951C174.652 138.885 170.676 124.541 172 111.918C173.546 99.2946 179.84 89.5408 190.882 82.6559C202.035 75.5798 216.887 72.0421 235.439 72.0428C254.874 72.0435 274.144 75.5825 293.248 82.6598C312.242 89.5457 329.579 99.3005 345.261 111.924C360.942 124.548 373.421 138.892 382.697 154.958C391.311 169.877 395.121 182.978 394.128 194.262C393.355 205.546 389.656 215.396 383.031 223.811C376.627 232.226 366.688 242.554 353.217 254.794L435.375 254.797L464.198 304.716L275.367 304.709L246.544 254.79Z" stroke="#FF750F" stroke-width="1" stroke-linejoin="round"/>
                        </g>
                        <g class="transition-all delay-300 translate-y-0 opacity-100 duration-750 starting:opacity-0 starting:translate-y-4" style="mix-blend-mode:hard-light">
                            <path d="M67.41 125.402L44.5515 125.401L15.5625 75.1953L101.364 75.1985L233.886 304.712L170.942 304.71L67.41 125.402Z" fill="#4B0600"/>
                            <path d="M67.41 125.402L44.5515 125.401L15.5625 75.1953L101.364 75.1985L233.886 304.712L170.942 304.71L67.41 125.402Z" stroke="#FF750F" stroke-width="1"/>
                        </g>
                    </svg>
                    <div class="absolute inset-0 rounded-t-lg lg:rounded-t-none lg:rounded-r-lg shadow-[inset_0px_0px_0px_1px_rgba(26,26,0,0.16)] dark:shadow-[inset_0px_0px_0px_1px_#fffaed2d]"></div>
                </div>
            </main>
        </div>

        @if (Route::has('login'))
            <div class="h-14.5 hidden lg:block"></div>
        @endif
    </body>
</html>
</file>

<file path="app/Http/Controllers/AttributeController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Attribute;
use App\Models\AttributeValue;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class AttributeController extends Controller
{
    /**
     * Display a listing of the resource.
     * Muestra atributos y valores en la misma vista con dos DataTables
     */
    public function index()
    {
        try {
            $attributes = Attribute::orderBy('order', 'asc')->get();
            $attributeValues = AttributeValue::with('attribute')->orderBy('order', 'asc')->get();

            return view('admin.attributes.index', compact('attributes', 'attributeValues'));
        } catch (\Exception $e) {
            Log::error('Error al cargar atributos: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Error al cargar los atributos');
        }
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.attributes.create');
    }

    /**
     * Store a newly created resource in storage.
     * Validaciones empresariales con protección contra XSS y SQL injection
     */
    public function store(Request $request)
    {
        // Validación con regex para prevenir inyecciones
        $validated = $request->validate([
            'name' => [
                'required',
                'string',
                'max:100',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:attributes,name'
            ],
            'type' => ['nullable', 'in:select,color,text'],
            'is_required' => ['nullable', 'boolean'],
            'order' => ['nullable', 'integer', 'min:0', 'max:9999']
        ], [
            'name.required' => 'El nombre del atributo es obligatorio.',
            'name.regex' => 'El nombre solo puede contener letras y espacios.',
            'name.unique' => 'Ya existe un atributo con este nombre.',
            'name.max' => 'El nombre no puede exceder 100 caracteres.',
            'type.required' => 'El tipo de atributo es obligatorio.',
            'type.in' => 'El tipo de atributo no es válido.',
            'order.integer' => 'El orden debe ser un número entero.',
            'order.min' => 'El orden debe ser mayor o igual a 0.'
        ]);

        DB::beginTransaction();
        try {
            $attribute = new Attribute();
            $attribute->name = mb_strtoupper(trim(htmlspecialchars($request->name, ENT_QUOTES, 'UTF-8')));
            $attribute->slug = Str::slug($request->name);
            $attribute->type = 'select';
            $attribute->is_required = $request->has('is_required') ? true : false;
            $attribute->order = $request->order ?? 0;
            $attribute->save();

            DB::commit();

            Log::info('Atributo creado exitosamente: ' . $attribute->id);
            return redirect()->route('admin.attributes.index')->with('success', 'Atributo creado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al crear atributo: ' . $e->getMessage() . ' | Trace: ' . $e->getTraceAsString());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al crear el atributo. Por favor intente nuevamente.');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Attribute $attribute)
    {
        return redirect()->route('admin.attributes.index');
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        try {
            $attribute = Attribute::findOrFail($id);
            return view('admin.attributes.edit', compact('attribute'));
        } catch (\Exception $e) {
            Log::error('Error al cargar atributo para edición: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Atributo no encontrado');
        }
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        // Validación con regex para prevenir inyecciones
        $validated = $request->validate([
            'name' => [
                'required',
                'string',
                'max:100',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:attributes,name,' . $id
            ],
            'type' => ['in:select,color,text'],
            'is_required' => ['nullable', 'boolean'],
            'order' => ['nullable', 'integer', 'min:0', 'max:9999']
        ], [
            'name.required' => 'El nombre del atributo es obligatorio.',
            'name.regex' => 'El nombre solo puede contener letras y espacios.',
            'name.unique' => 'Ya existe un atributo con este nombre.',
            'name.max' => 'El nombre no puede exceder 100 caracteres.',
            'type.required' => 'El tipo de atributo es obligatorio.',
            'type.in' => 'El tipo de atributo no es válido.',
            'order.integer' => 'El orden debe ser un número entero.',
            'order.min' => 'El orden debe ser mayor o igual a 0.'
        ]);

        DB::beginTransaction();
        try {
            $attribute = Attribute::findOrFail($id);

            $attribute->name = mb_strtoupper(trim(htmlspecialchars($request->name, ENT_QUOTES, 'UTF-8')));
            $attribute->slug = Str::slug($request->name);
            $attribute->type = 'select';
            $attribute->is_required = $request->has('is_required') ? true : false;
            $attribute->order = $request->order ?? 0;

            if (!$attribute->isDirty()) {
                return redirect()->route('admin.attributes.index')->with('info', 'No se realizaron cambios');
            }

            $attribute->save();
            DB::commit();

            Log::info('Atributo actualizado exitosamente: ' . $attribute->id);
            return redirect()->route('admin.attributes.index')->with('success', 'Atributo actualizado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al actualizar atributo: ' . $e->getMessage() . ' | Trace: ' . $e->getTraceAsString());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al actualizar el atributo. Por favor intente nuevamente.');
        }
    }

    /**
     * Show confirmation page before deletion.
     */
    public function confirm_delete($id)
    {
        try {
            $attribute = Attribute::with('values')->findOrFail($id);
            return view('admin.attributes.delete', compact('attribute'));
        } catch (\Exception $e) {
            Log::error('Error al cargar atributo para eliminación: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Atributo no encontrado');
        }
    }

    /**
     * Remove the specified resource from storage.
     * Elimina el atributo y sus valores en cascada (definido en la migración)
     */
    public function destroy($id)
    {
        DB::beginTransaction();
        try {
            // 1. Obtener el atributo con sus valores cargados para optimizar
            $attribute = Attribute::with('values')->findOrFail($id);
            $attributeName = $attribute->name;

            // 2. BLINDAJE DE INTEGRIDAD EMPRESARIAL
            // Verificamos si alguno de los valores de este atributo está en uso 
            // en la tabla pivote de variantes (usando la relación que vimos antes)
            $valuesIds = $attribute->values->pluck('id');

            $isInUse = DB::table('design_variant_attributes')
                ->whereIn('attribute_value_id', $valuesIds)
                ->exists();

            if ($isInUse) {
                DB::rollBack();
                return redirect()->route('admin.attributes.index')
                    ->with('error', "No se puede eliminar '$attributeName' porque sus valores están asignados a variantes de diseño activas.");
            }

            /**
             * 3. CASCADA MANUAL PARA SOFT DELETES
             * Al usar Eloquent sobre la relación, Laravel marca cada hijo con deleted_at
             */
            if ($attribute->values()->exists()) {
                $attribute->values()->delete();
            }

            // 4. Soft Delete del padre
            $attribute->delete();

            DB::commit();

            // 5. Logging Detallado
            Log::info("Atributo y valores eliminados (Soft Delete) por usuario ID: " . Auth::id(), [
                'attribute_id' => $id,
                'name' => $attributeName,
                'affected_values_count' => $valuesIds->count()
            ]);

            return redirect()->route('admin.attributes.index')
                ->with('success', 'Atributo y sus valores asociados eliminados correctamente.');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error("Fallo al eliminar Atributo ID {$id}: " . $e->getMessage());

            return redirect()->route('admin.attributes.index')
                ->with('error', 'Error técnico al intentar eliminar el atributo.');
        }
    }
}
</file>

<file path="app/Http/Controllers/AttributeValueController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Attribute;
use App\Models\AttributeValue;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;

class AttributeValueController extends Controller
{
    /**
     * Display a listing of the resource.
     * Redirige al index principal de atributos
     */
    public function index()
    {
        return redirect()->route('admin.attributes.index');
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        try {
            $attributes = Attribute::orderBy('name', 'asc')->get();
            return view('admin.attributes.values.create', compact('attributes'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de valor de atributo: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al cargar el formulario');
        }
    }

    /**
     * Store a newly created resource in storage.
     * Validaciones empresariales con protección contra XSS y SQL injection
     */
    public function store(Request $request)
    {
        // Obtener el tipo de atributo para validación condicional
        $attribute = Attribute::find($request->attribute_id);
        $isColorType = $attribute && $attribute->slug === 'color';

        // Reglas de validación base
        $rules = [
            'attribute_id' => ['required', 'exists:attributes,id'],
            'value' => [
                'required',
                'string',
                'max:100',
                'regex:/^[a-zA-Z0-9ñÑáéíóúÁÉÍÓÚ\s\-]+$/'
            ],
            'order' => ['nullable', 'integer', 'min:0', 'max:9999']
        ];

        // Agregar validación de hex_color si el atributo es tipo color
        if ($isColorType) {
            $rules['hex_color'] = ['required', 'regex:/^#[0-9A-Fa-f]{6}$/'];
        } else {
            $rules['hex_color'] = ['nullable', 'regex:/^#[0-9A-Fa-f]{6}$/'];
        }

        $validated = $request->validate($rules, [
            'attribute_id.required' => 'Debe seleccionar un atributo.',
            'attribute_id.exists' => 'El atributo seleccionado no existe.',
            'value.required' => 'El valor es obligatorio.',
            'value.regex' => 'El valor solo puede contener letras, números, espacios y guiones.',
            'value.max' => 'El valor no puede exceder 100 caracteres.',
            'hex_color.required' => 'El código de color es obligatorio para atributos tipo color.',
            'hex_color.regex' => 'El código de color debe tener formato hexadecimal válido (#RRGGBB).',
            'order.integer' => 'El orden debe ser un número entero.',
            'order.min' => 'El orden debe ser mayor o igual a 0.'
        ]);

        DB::beginTransaction();
        try {
            $attributeValue = new AttributeValue();
            $attributeValue->attribute_id = $request->attribute_id;
            $attributeValue->value = mb_strtoupper(trim(htmlspecialchars($request->value, ENT_QUOTES, 'UTF-8')));
            $attributeValue->hex_color = $isColorType ? strtoupper(trim($request->hex_color)) : null;
            $attributeValue->order = $request->order ?? 0;
            $attributeValue->save();

            DB::commit();

            Log::info('Valor de atributo creado exitosamente: ' . $attributeValue->id);
            return redirect()->route('admin.attributes.index')->with('success', 'Valor de atributo creado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al crear valor de atributo: ' . $e->getMessage() . ' | Trace: ' . $e->getTraceAsString());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al crear el valor de atributo. Por favor intente nuevamente.');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(AttributeValue $attributeValue)
    {
        return redirect()->route('admin.attributes.index');
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        try {
            $attributeValue = AttributeValue::with('attribute')->findOrFail($id);
            $attributes = Attribute::orderBy('name', 'asc')->get();
            return view('admin.attributes.values.edit', compact('attributeValue', 'attributes'));
        } catch (\Exception $e) {
            Log::error('Error al cargar valor de atributo para edición: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Valor de atributo no encontrado');
        }
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        // 1. Verificación previa de existencia para ahorrar recursos
        $attributeValue = AttributeValue::findOrFail($id);

        // 2. Obtener el Atributo PADRE desde la BD (Fuente de verdad única)
        // No confiamos en lo que el front diga que es el atributo
        $attribute = Attribute::findOrFail($request->attribute_id);
        $isColorType = ($attribute->slug === 'color');

        // 3. Definición dinámica de Reglas de Validación
        $rules = [
            'attribute_id' => ['required', 'exists:attributes,id'],
            'value' => [
                'required',
                'string',
                'max:100',
                // Regex empresarial: permite letras, números, espacios, guiones y tildes
                'regex:/^[a-zA-Z0-9ñÑáéíóúÁÉÍÓÚ\s\-]+$/'
            ],
            'order' => ['nullable', 'integer', 'min:0', 'max:9999']
        ];

        // Lógica de validación cruzada: El HEX es obligatorio SI Y SOLO SI el atributo es Color
        if ($isColorType) {
            $rules['hex_color'] = ['required', 'regex:/^#[0-9A-Fa-f]{6}$/'];
        } else {
            // Si no es color, nos aseguramos de que no envíen basura
            $rules['hex_color'] = ['nullable'];
        }

        // Mensajes personalizados para una UX profesional
        $messages = [
            'value.regex' => 'El formato del nombre no es válido.',
            'hex_color.required' => 'El código de color es obligatorio para este tipo de atributo.',
            'hex_color.regex' => 'El formato de color hexadecimal es inválido.',
        ];

        $request->validate($rules, $messages);

        DB::beginTransaction();
        try {
            // 4. Asignación de Datos con Sanitización Profesional
            $attributeValue->attribute_id = $request->attribute_id;

            // Trim y Capitalización limpia (sin codificar HTML en BD para permitir búsquedas)
            $attributeValue->value = (mb_strtoupper(trim($request->value), 'UTF-8'));

            /** * BLINDAJE DE INTEGRIDAD:
             * Aunque el usuario manipule el HTML y envíe un HEX en una Talla, 
             * aquí forzamos la nulidad basándonos en la BD del servidor.
             */
            $attributeValue->hex_color = $isColorType ? strtoupper(trim($request->hex_color)) : null;

            $attributeValue->order = $request->order ?? 0;

            // 5. Verificación de cambios (isDirty) antes de persistir
            if (!$attributeValue->isDirty()) {
                DB::rollBack(); // Cerramos transacción sin cambios
                return redirect()->route('admin.attributes.index')->with('info', 'No se detectaron cambios en el valor.');
            }

            $attributeValue->save();

            DB::commit();

            Log::info("Valor de atributo actualizado por usuario ID: " . Auth::id(), [
                'value_id' => $attributeValue->id,
                'new_data' => $attributeValue->getChanges()
            ]);

            return redirect()->route('admin.attributes.index')->with('success', 'Valor de atributo actualizado exitosamente.');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error("Fallo crítico en actualización de AttributeValue ID {$id}: " . $e->getMessage());

            return redirect()->back()
                ->withInput()
                ->with('error', 'Hubo un problema técnico. La operación fue abortada para proteger los datos.');
        }
    }

    /**
     * Show confirmation page before deletion.
     */
    public function confirm_delete($id)
    {
        try {
            $attributeValue = AttributeValue::with('attribute')->findOrFail($id);
            return view('admin.attributes.values.delete', compact('attributeValue'));
        } catch (\Exception $e) {
            Log::error('Error al cargar valor de atributo para eliminación: ' . $e->getMessage());
            return redirect()->route('admin.attributes.index')->with('error', 'Valor de atributo no encontrado');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy($id)
    {
        DB::beginTransaction();
        try {
            $attributeValue = AttributeValue::findOrFail($id);
            $valueName = $attributeValue->value;

            $attributeValue->delete();

            DB::commit();

            Log::info('Valor de atributo eliminado exitosamente: ' . $valueName . ' (ID: ' . $id . ')');
            return redirect()->route('admin.attributes.index')->with('success', 'Valor de atributo eliminado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al eliminar valor de atributo: ' . $e->getMessage() . ' | Trace: ' . $e->getTraceAsString());
            return redirect()->route('admin.attributes.index')->with('error', 'Error al eliminar el valor de atributo. Por favor intente nuevamente.');
        }
    }

    /**
     * Get attribute type via AJAX for conditional color picker display
     * @param int $attributeId
     * @return \Illuminate\Http\JsonResponse
     */
    public function getAttributeType($attributeId)
    {
        try {
            $attribute = Attribute::findOrFail($attributeId);
            return response()->json([
                'success' => true,
                'type' => $attribute->type
            ]);
        } catch (\Exception $e) {
            Log::error('Error al obtener tipo de atributo: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Atributo no encontrado'
            ], 404);
        }
    }
}
</file>

<file path="app/Http/Controllers/ClienteController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Cliente;
use App\Models\Recomendacion;
use App\Models\Estado;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class ClienteController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $clientes = Cliente::where('activo', true)->with('estado', 'recomendacion')->get();
        return view('admin.clientes.index', compact('clientes'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        $recomendaciones = Recomendacion::all();
        $estados = Estado::all();
        return view('admin.clientes.create', compact('recomendaciones', 'estados'));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre' => ['required', 'string', 'max:255'],
            'apellidos' => ['required', 'string', 'max:255'],
            'telefono' => ['required', 'regex:/^[0-9]{10}$/', 'unique:clientes,telefono'],
            'email' => ['nullable', 'email', 'unique:clientes,email'],
            'direccion' => ['nullable', 'string', 'max:255'],
            'ciudad' => ['required', 'string', 'max:255'],
            'codigo_postal' => ['nullable', 'max:5', 'regex:/^[0-9]{5}$/'],
            'fecha_baja' => 'nullable',
            'motivo_baja' => ['nullable', 'string', 'max:255'],
            'observaciones' => ['nullable', 'string'],
            'estado_id' => ['required', 'exists:estados,id'],
            'recomendacion_id' => ['required', 'exists:recomendacion,id'],
            'busto' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'alto_cintura' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'cintura' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'cadera' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'largo' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
        ]);

        try {
            $cliente = new Cliente();
            $cliente->nombre = mb_strtoupper(trim($request->nombre), 'UTF-8');
            $cliente->apellidos = mb_strtoupper(trim($request->apellidos), 'UTF-8');
            $cliente->telefono = $request->telefono;
            $cliente->email = $request->email;
            $cliente->direccion = mb_strtoupper(trim($request->direccion), 'UTF-8');
            $cliente->ciudad = mb_strtoupper(trim($request->ciudad), 'UTF-8');
            $cliente->codigo_postal = $request->codigo_postal;
            $cliente->observaciones = mb_strtoupper(trim($request->observaciones), 'UTF-8');
            $cliente->estado_id = $request->estado_id;
            $cliente->recomendacion_id = $request->recomendacion_id;
            $cliente->busto = $request->busto;
            $cliente->alto_cintura = $request->alto_cintura;
            $cliente->cintura = $request->cintura;
            $cliente->cadera = $request->cadera;
            $cliente->largo = $request->largo;
            $cliente->save();
            return redirect()->route('admin.clientes.index')->with('success', 'Cliente creado correctamente');
        } catch (\Exception $e) {
            Log::error('Error al crear el cliente: ' . $e->getMessage());
            return redirect()->route('admin.clientes.index')->with('error', 'Error al crear el cliente: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Cliente $cliente)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $cliente = Cliente::where('activo', true)->with('estado', 'recomendacion')->findOrFail($id);
        $recomendaciones = Recomendacion::all();
        $estados = Estado::all();
        return view('admin.clientes.edit', compact('cliente', 'recomendaciones', 'estados'));
    }

    public function getMeasures($id)
    {
        $cliente = Cliente::findOrFail($id);
        return view('admin.clientes.partials.measures', compact('cliente'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {


        $request->validate([
            'nombre' => ['required', 'string', 'max:255'],
            'apellidos' => ['required', 'string', 'max:255'],
            'telefono' => ['required', 'regex:/^[0-9]{10}$/', 'unique:clientes,telefono,' . $id],
            'email' => ['nullable', 'email', 'unique:clientes,email,' . $id],
            'direccion' => ['nullable', 'string', 'max:255'],
            'codigo_postal' => ['nullable', 'max:5', 'regex:/^[0-9]{5}$/'],
            'ciudad' => ['required', 'string', 'max:255'],
            'fecha_baja' => 'nullable',
            'motivo_baja' => ['nullable', 'string', 'max:255'],
            'observaciones' => ['nullable', 'string'],
            'estado_id' => ['required', 'exists:estados,id'],
            'recomendacion_id' => ['required', 'exists:recomendacion,id'],
            'busto' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'alto_cintura' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'cintura' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'cadera' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
            'largo' => [
                'nullable',
                'regex:/^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/'
            ],
        ]);

        try {
            $cliente = Cliente::where('activo', true)->with('estado', 'recomendacion')->findOrFail($id);
            $cliente->nombre = mb_strtoupper(trim($request->nombre), 'UTF-8');
            $cliente->apellidos = mb_strtoupper(trim($request->apellidos), 'UTF-8');
            $cliente->telefono = $request->telefono;
            $cliente->email = $request->email;
            $cliente->direccion = mb_strtoupper(trim($request->direccion), 'UTF-8');
            $cliente->ciudad = mb_strtoupper(trim($request->ciudad), 'UTF-8');
            $cliente->codigo_postal = $request->codigo_postal;
            $cliente->observaciones = mb_strtoupper(trim($request->observaciones ?? ''), 'UTF-8');
            $cliente->estado_id = $request->estado_id;
            $cliente->recomendacion_id = $request->recomendacion_id;
            $cliente->busto = $request->busto;
            $cliente->alto_cintura = $request->alto_cintura;
            $cliente->cintura = $request->cintura;
            $cliente->cadera = $request->cadera;
            $cliente->largo = $request->largo;

            if (!$cliente->isDirty()) {
                return redirect()->route('admin.clientes.index')->with('warning', 'No se realizaron cambios');
            }

            $cliente->save();
            return redirect()->route('admin.clientes.index')->with('success', 'Cliente actualizado correctamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el cliente: ' . $e->getMessage());
            return redirect()->route('admin.clientes.index')->with('error', 'Error al actualizar el cliente: ' . $e->getMessage());
        }
    }

    /**
     * Remove the specified resource from storage.
     */

    public function confirm_delete($id)
    {
        $cliente = Cliente::where('activo', true)->with('estado', 'recomendacion')->findOrFail($id);
        $estados = Estado::all();
        $recomendaciones = Recomendacion::all();
        return view('admin.clientes.delete', compact('cliente', 'estados', 'recomendaciones'));
    }

    public function destroy($id)
    {
        try {
            $cliente = Cliente::where('activo', true)->with('estado', 'recomendacion')->findOrFail($id);
            $cliente->activo = false;
            $cliente->fecha_baja = now();
            $cliente->save();
            return redirect()->route('admin.clientes.index')->with('success', 'Cliente eliminado correctamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el cliente: ' . $e->getMessage());
            return redirect()->route('admin.clientes.index')->with('error', 'Error al eliminar el cliente: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/ImageController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Image;
use App\Services\ImageService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class ImageController extends Controller
{
    protected $imageService;

    public function __construct(ImageService $imageService)
    {
        $this->imageService = $imageService;
    }

    /**
     * Subir imagen
     */
    public function upload(Request $request)
    {
        $validated = $request->validate([
            'image' => 'required|file|max:51200',
            'imageable_type' => 'required|string|in:App\Models\Design,App\Models\DesignVariant',
            'imageable_id' => 'required|integer',
            'alt_text' => 'nullable|string|max:255',
            'is_primary' => 'boolean'
        ]);

        $image = $this->imageService->uploadImage(
            $request->file('image'),
            $validated['imageable_type'],
            $validated['imageable_id'],
            [
                'alt_text' => $validated['alt_text'] ?? null,
                'is_primary' => $validated['is_primary'] ?? false,
            ]
        );

        return response()->json([
            'success' => true,
            'message' => 'Archivo subido exitosamente',
            'image' => [
                'id' => $image->id,
                'url' => Storage::url($image->file_path),
                'file_name' => $image->file_name,
            ]
        ]);
    }

    /**
     * Actualizar metadatos de imagen
     */
    public function update(Request $request, Image $image)
    {
        $validated = $request->validate([
            'alt_text' => 'nullable|string|max:255',
            'is_primary' => 'boolean',
            'order' => 'nullable|integer|min:0'
        ]);

        $image->update($validated);

        return response()->json([
            'success' => true,
            'message' => 'Imagen actualizada exitosamente',
        ]);
    }

    /**
     * Eliminar imagen
     */
    public function destroy(Image $image)
    {
        $this->imageService->deleteImage($image);

        return response()->json([
            'success' => true,
            'message' => 'Imagen eliminada exitosamente'
        ]);
    }

    /**
     * Reordenar imágenes
     */
    public function reorder(Request $request)
    {
        $validated = $request->validate([
            'images' => 'required|array',
            'images.*.id' => 'required|exists:images,id',
            'images.*.order' => 'required|integer|min:0'
        ]);

        $this->imageService->reorderImages($validated['images']);

        return response()->json([
            'success' => true,
            'message' => 'Orden actualizado exitosamente'
        ]);
    }
}
</file>

<file path="app/Http/Controllers/ProduccionController.php">
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use App\Models\DesignExport;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class ProduccionController extends Controller
{
    /**
     * Muestra la lista de todas las producciones.
     * Este método obtiene los registros de la base de datos y los envía a la vista principal.
     */
    public function index()
    {
        try {
            // Obtenemos las exportaciones que no han sido eliminadas, con sus relaciones
            $exportaciones = DesignExport::whereNull('deleted_at')
                ->with(['design', 'variant', 'creator'])
                ->orderBy('created_at', 'desc')
                ->get();

            // Retornamos la vista con los datos
            return view('admin.produccion.index', compact('exportaciones'));
        } catch (\Exception $e) {
            // Si ocurre un error, lo registramos y notificamos al usuario
            Log::error('Error en index de producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al cargar las producciones: ' . $e->getMessage());
        }
    }

    /**
     * Muestra el formulario para crear una nueva producción.
     * Aquí cargamos los diseños disponibles para que el usuario pueda elegir uno.
     */
    public function create()
    {
        try {
            // Obtenemos todos los diseños ordenados por nombre
            $designs = \App\Models\Design::orderBy('name')->get();
            return view('admin.produccion.create', compact('designs'));
        } catch (\Exception $e) {
            Log::error('Error en create de producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al cargar el formulario: ' . $e->getMessage());
        }
    }

    /**
     * Guarda la nueva producción en la base de datos.
     * Este método valida los datos del formulario y crea el registro.
     */
    public function store(Request $request)
    {
        try {
            // Validamos que los datos sean correctos
            $request->validate([
                'design_id' => 'required|exists:designs,id',
                'file' => 'nullable|file|max:51200', // Máximo 50MB
                'notes' => 'nullable|string',
            ]);

            // Preparamos los datos básicos
            $data = [
                'design_id' => $request->design_id,
                'status' => 'borrador', // Estado inicial
                'notes' => $request->notes,
                'created_by' => Auth::id(),
            ];

            // Si se subió un archivo, lo procesamos
            if ($request->hasFile('file')) {
                $file = $request->file('file');
                $path = $file->store('exports', 'public'); // Guardamos en la carpeta 'exports'

                // Agregamos la información del archivo a los datos
                $data['file_path'] = $path;
                $data['file_name'] = $file->getClientOriginalName();
                $data['mime_type'] = $file->getClientMimeType();
                $data['file_size'] = $file->getSize();
            }

            // Creamos el registro en la base de datos
            DesignExport::create($data);

            // Redirigimos al usuario con un mensaje de éxito
            return redirect()->route('admin.production.index')
                ->with('success', 'Producción creada correctamente en estado Borrador.');
        } catch (\Exception $e) {
            Log::error('Error al guardar producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al guardar la producción: ' . $e->getMessage())->withInput();
        }
    }

    /**
     * Muestra los detalles de una producción específica.
     * Si la petición es AJAX (modal), devuelve una vista parcial.
     */
    public function show(string $id)
    {
        try {
            // Buscamos la producción por su ID con todas las relaciones necesarias
            $export = DesignExport::with([
                'design',
                'variant',
                'creator',
                'image',
                'statusHistory.changedByUser'
            ])->findOrFail($id);

            // Si la petición viene de un modal (AJAX), devolvemos solo la vista parcial
            if (request()->ajax()) {
                $type = request('type');
                if ($type === 'details') {
                    return view('admin.produccion.show_modal', compact('export'));
                }
                return view('admin.produccion.show_modal_especificaciones', compact('export'));
            }

            // Si es una visita normal, devolvemos la vista completa
            return view('admin.produccion.show', compact('export'));
        } catch (\Exception $e) {
            Log::error('Error al mostrar producción: ' . $e->getMessage());
            // Si es ajax, devolvemos error texto plano o json, si no, redirect
            if (request()->ajax()) {
                return response('Error al cargar detalles: ' . $e->getMessage(), 500);
            }
            return back()->with('error', 'Ocurrió un error al cargar los detalles: ' . $e->getMessage());
        }
    }

    /**
     * Muestra el formulario para editar una producción existente.
     */
    public function edit(string $id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            return view('admin.produccion.edit', compact('export'));
        } catch (\Exception $e) {
            Log::error('Error en edit de producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al cargar el formulario de edición: ' . $e->getMessage());
        }
    }

    /**
     * Actualiza los datos de la producción en la base de datos.
     * Permite cambiar notas y reemplazar el archivo adjunto.
     */
    public function update(Request $request, string $id)
    {
        try {
            // Validamos los datos
            $request->validate([
                'file' => 'nullable|file|max:51200',
                'notes' => 'nullable|string',
            ]);

            // Buscamos el registro
            $export = DesignExport::findOrFail($id);

            $data = [
                'notes' => $request->notes,
            ];

            // Si se sube un nuevo archivo, reemplazamos el anterior
            if ($request->hasFile('file')) {
                // Borrar archivo viejo del almacenamiento
                if ($export->file_path && Storage::disk('public')->exists($export->file_path)) {
                    Storage::disk('public')->delete($export->file_path);
                }

                // Guardar nuevo archivo
                $file = $request->file('file');
                $path = $file->store('exports', 'public');

                $data['file_path'] = $path;
                $data['file_name'] = $file->getClientOriginalName();
                $data['mime_type'] = $file->getClientMimeType();
                $data['file_size'] = $file->getSize();
            }

            // Actualizamos el registro
            $export->update($data);

            return redirect()->route('admin.production.index')
                ->with('success', 'Producción actualizada correctamente.');
        } catch (\Exception $e) {
            Log::error('Error al actualizar producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al actualizar: ' . $e->getMessage());
        }
    }

    /**
     * Elimina una producción de la base de datos.
     */
    public function destroy(string $id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            // Si tuviera archivo físico, idealmente se borra también o se mantiene según política.
            // Aquí usamos SoftDeletes o delete normal.
            $export->delete();
            return back()->with('success', 'Producción eliminada correctamente.');
        } catch (\Exception $e) {
            Log::error('Error al eliminar producción: ' . $e->getMessage());
            return back()->with('error', 'Ocurrió un error al eliminar: ' . $e->getMessage());
        }
    }

    // --- ACCIONES DE ESTADO ---

    /**
     * Registra el cambio de estado en el historial.
     * Helper method para evitar duplicación de código.
     */
    private function recordStatusChange(DesignExport $export, string $previousStatus, string $newStatus): void
    {
        \App\Models\DesignExportStatusHistory::create([
            'design_export_id' => $export->id,
            'previous_status' => $previousStatus,
            'new_status' => $newStatus,
            'changed_by' => Auth::id(),
        ]);
    }

    /**
     * Cambia el estado a 'pendiente' para solicitar revisión.
     */
    public function requestApproval($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $previousStatus = $export->status;

            // Registrar en historial antes de actualizar
            $this->recordStatusChange($export, $previousStatus, 'pendiente');

            $export->update(['status' => 'pendiente']);
            return back()->with('success', 'Solicitud de aprobación enviada.');
        } catch (\Exception $e) {
            Log::error('Error al solicitar aprobación: ' . $e->getMessage());
            return back()->with('error', 'Error al procesar solicitud: ' . $e->getMessage());
        }
    }

    /**
     * Aprueba la producción, registrando quién y cuándo aprobó.
     */
    public function approve($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $previousStatus = $export->status;

            // Registrar en historial antes de actualizar
            $this->recordStatusChange($export, $previousStatus, 'aprobado');

            $export->update([
                'status' => 'aprobado',
                'approved_by' => Auth::id(),
                'approved_at' => now(),
            ]);
            return back()->with('success', 'Producción aprobada correctamente.');
        } catch (\Exception $e) {
            Log::error('Error al aprobar producción: ' . $e->getMessage());
            return back()->with('error', 'Error al aprobar: ' . $e->getMessage());
        }
    }

    /**
     * Archiva la producción (estado final).
     */
    public function archive($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $previousStatus = $export->status;

            // Registrar en historial antes de actualizar
            $this->recordStatusChange($export, $previousStatus, 'archivado');

            $export->update(['status' => 'archivado']);
            return back()->with('success', 'Producción archivada correctamente.');
        } catch (\Exception $e) {
            Log::error('Error al archivar producción: ' . $e->getMessage());
            return back()->with('error', 'Error al archivar: ' . $e->getMessage());
        }
    }

    /**
     * Revierte la producción a estado 'pendiente' (útil para correcciones).
     */
    public function revert($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $previousStatus = $export->status;

            // Registrar en historial antes de actualizar
            $this->recordStatusChange($export, $previousStatus, 'pendiente');

            $export->update(['status' => 'pendiente']);
            return back()->with('success', 'Estado revertido a pendiente.');
        } catch (\Exception $e) {
            Log::error('Error al revertir producción: ' . $e->getMessage());
            return back()->with('error', 'Error al revertir: ' . $e->getMessage());
        }
    }

    /**
     * Restaura una producción archivada a estado 'aprobado'.
     */
    public function restore($id)
    {
        try {
            $export = DesignExport::findOrFail($id);
            $previousStatus = $export->status;

            // Registrar en historial antes de actualizar
            $this->recordStatusChange($export, $previousStatus, 'aprobado');

            $export->update(['status' => 'aprobado']);
            return back()->with('success', 'Producción restaurada a aprobado.');
        } catch (\Exception $e) {
            Log::error('Error al restaurar producción: ' . $e->getMessage());
            return back()->with('error', 'Error al restaurar: ' . $e->getMessage());
        }
    }

    /**
     * Descarga el archivo de la producción.
     */
    public function download($id)
    {
        try {
            $export = DesignExport::findOrFail($id);

            // Verificar que existe el archivo
            if (!$export->file_path || !Storage::disk('public')->exists($export->file_path)) {
                return back()->with('error', 'El archivo no existe o fue eliminado.');
            }

            $filePath = Storage::disk('public')->path($export->file_path);
            $fileName = $export->file_name ?: basename($export->file_path);

            return response()->download($filePath, $fileName);
        } catch (\Exception $e) {
            Log::error('Error al descargar archivo de producción: ' . $e->getMessage());
            return back()->with('error', 'Error al descargar el archivo: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/ProductExtraController.php">
<?php

namespace App\Http\Controllers;

use App\Models\ProductExtra;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class ProductExtraController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $extras = ProductExtra::orderBy('name')->get();
        return view('admin.product_extras.index', compact('extras'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.product_extras.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'name' => ['required', 'string', 'max:100', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s\-\_\.\,]+$/', 'unique:product_extras,name'],
            'cost_addition' => ['required', 'numeric', 'min:0', 'max:999999.99'],
            'price_addition' => ['required', 'numeric', 'min:0', 'max:999999.99'],
            'minutes_addition' => ['nullable', 'integer', 'min:0', 'max:9999'],
        ], [
            'name.required' => 'El nombre del extra es obligatorio.',
            'name.regex' => 'El nombre contiene caracteres no permitidos.',
            'name.unique' => 'Ya existe un extra con este nombre.',
            'cost_addition.required' => 'El costo adicional es obligatorio.',
            'cost_addition.numeric' => 'El costo debe ser un número válido.',
            'price_addition.required' => 'El precio adicional es obligatorio.',
            'price_addition.numeric' => 'El precio debe ser un número válido.',
        ]);

        try {
            $extra = new ProductExtra();
            $extra->name = strtoupper(trim($request->name));
            $extra->cost_addition = $request->cost_addition;
            $extra->price_addition = $request->price_addition;
            $extra->minutes_addition = $request->minutes_addition ?? 0;
            $extra->save();

            return redirect()->route('admin.product_extras.index')
                ->with('success', 'Extra creado exitosamente');
        } catch (\Exception $e) {
            Log::error('[ProductExtra@store] Error al crear extra: ' . $e->getMessage(), [
                'line' => $e->getLine(),
                'file' => $e->getFile()
            ]);
            return redirect()->route('admin.product_extras.index')
                ->with('error', 'Error al crear el extra');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(ProductExtra $productExtra)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $extra = ProductExtra::findOrFail($id);
        return view('admin.product_extras.edit', compact('extra'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'name' => ['required', 'string', 'max:100', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s\-\_\.\,]+$/', 'unique:product_extras,name,' . $id],
            'cost_addition' => ['required', 'numeric', 'min:0', 'max:999999.99'],
            'price_addition' => ['required', 'numeric', 'min:0', 'max:999999.99'],
            'minutes_addition' => ['nullable', 'integer', 'min:0', 'max:9999'],
        ], [
            'name.required' => 'El nombre del extra es obligatorio.',
            'name.regex' => 'El nombre contiene caracteres no permitidos.',
            'name.unique' => 'Ya existe un extra con este nombre.',
            'cost_addition.required' => 'El costo adicional es obligatorio.',
            'cost_addition.numeric' => 'El costo debe ser un número válido.',
            'price_addition.required' => 'El precio adicional es obligatorio.',
            'price_addition.numeric' => 'El precio debe ser un número válido.',
        ]);

        $extra = ProductExtra::findOrFail($id);

        try {
            $extra->name = strtoupper(trim($request->name));
            $extra->cost_addition = $request->cost_addition;
            $extra->price_addition = $request->price_addition;
            $extra->minutes_addition = $request->minutes_addition ?? 0;

            if (!$extra->isDirty()) {
                return redirect()->route('admin.product_extras.index')
                    ->with('info', 'No se realizaron cambios');
            }

            $extra->save();

            return redirect()->route('admin.product_extras.index')
                ->with('success', 'Extra actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('[ProductExtra@update] Error al actualizar extra: ' . $e->getMessage(), [
                'line' => $e->getLine(),
                'file' => $e->getFile()
            ]);
            return redirect()->route('admin.product_extras.index')
                ->with('error', 'Error al actualizar el extra');
        }
    }

    /**
     * Confirm delete page
     */
    public function confirm_delete($id)
    {
        $extra = ProductExtra::findOrFail($id);
        return view('admin.product_extras.delete', compact('extra'));
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy($id)
    {
        $extra = ProductExtra::findOrFail($id);

        try {
            // Verificar si tiene productos asociados
            if ($extra->products()->count() > 0) {
                return redirect()->route('admin.product_extras.index')
                    ->with('error', 'No se puede eliminar el extra porque tiene productos asociados.');
            }

            $extra->delete();

            return redirect()->route('admin.product_extras.index')
                ->with('success', 'Extra eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('[ProductExtra@destroy] Error al eliminar extra: ' . $e->getMessage(), [
                'line' => $e->getLine(),
                'file' => $e->getFile()
            ]);
            return redirect()->route('admin.product_extras.index')
                ->with('error', 'Error al eliminar el extra');
        }
    }
}
</file>

<file path="app/Http/Controllers/RecomendacionController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Recomendacion;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class RecomendacionController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $recomendaciones = Recomendacion::where('activo', true)->get();
        return view('admin.recomendaciones.index', compact('recomendaciones'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.recomendaciones.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre_recomendacion' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
            ],
        ]);
        try {
            $nombre = strtoupper(trim($request->nombre_recomendacion));

            // Buscar si ya existe (activo o inactivo)
            $existingRecomendacion = Recomendacion::where('nombre_recomendacion', $nombre)->first();

            if ($existingRecomendacion) {
                if ($existingRecomendacion->activo) {
                    return back()->withErrors(['nombre_recomendacion' => 'El nombre de la recomendación ya ha sido registrado.'])->withInput();
                } else {
                    // Reactivar si existía pero estaba eliminado logicamente
                    $existingRecomendacion->activo = true;
                    $existingRecomendacion->fecha_baja = null; // Limpiar fecha de baja si existe
                    $existingRecomendacion->save();
                    return redirect()->route('admin.recomendaciones.index')->with('success', 'Recomendación reactivada exitosamente');
                }
            }

            $recomendacion = new Recomendacion();
            $recomendacion->nombre_recomendacion = $nombre;
            $recomendacion->save();
            return redirect()->route('admin.recomendaciones.index')->with('success', 'Recomendación guardada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al guardar la recomendación: ' . $e->getMessage());
            return redirect()->route('admin.recomendaciones.index')->with('error', 'Error al guardar la recomendación: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Recomendacion $recomendacion)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $recomendacion = Recomendacion::where('activo', true)->findOrFail($id);
        return view('admin.recomendaciones.edit', compact('recomendacion'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_recomendacion' => ['required', 'string', 'max:255', 'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/', 'unique:recomendacion,nombre_recomendacion,' . $id],
        ]);
        try {
            $recomendacion = Recomendacion::where('activo', true)->findOrFail($id);
            $recomendacion->nombre_recomendacion = strtoupper(trim($request->nombre_recomendacion));
            if (!$recomendacion->isDirty()) {
                return redirect()->route('admin.recomendaciones.index')->with('info', 'No se realizaron cambios');
            }
            $recomendacion->save();
            return redirect()->route('admin.recomendaciones.index')->with('success', 'Recomendación guardada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al guardar la recomendación: ' . $e->getMessage());
            return redirect()->route('admin.recomendaciones.index')->with('error', 'Error al guardar la recomendación: ' . $e->getMessage());
        }
    }

    /**
     * Remove the specified resource from storage.
     */

    public function confirm_delete($id)
    {
        $recomendacion = Recomendacion::where('activo', true)->findOrFail($id);
        return view('admin.recomendaciones.delete', compact('recomendacion'));
    }

    public function destroy($id)
    {
        try {
            $recomendacion = Recomendacion::where('activo', true)->findOrFail($id);
            $recomendacion->activo = false;
            $recomendacion->fecha_baja = now();
            $recomendacion->save();
            return redirect()->route('admin.recomendaciones.index')->with('success', 'Recomendación eliminada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar la recomendación: ' . $e->getMessage());
            return redirect()->route('admin.recomendaciones.index')->with('error', 'Error al eliminar la recomendación: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/VisualizerController.php">
<?php

namespace App\Http\Controllers;

use App\Services\EmbroideryAnalyzerService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class VisualizerController extends Controller
{
    protected EmbroideryAnalyzerService $analyzer;

    public function __construct(EmbroideryAnalyzerService $analyzer)
    {
        $this->analyzer = $analyzer;
    }

    /**
     * Muestra la vista principal del visualizador.
     */
    public function index()
    {
        return view('admin.visualizer.index');
    }

    /**
     * Analiza el archivo subido y devuelve los resultados JSON.
     */
    public function analyze(Request $request)
    {
        $tempPath = null;
        try {
            // Validar archivo (10MB max)
            $request->validate([
                'file' => 'required|file|max:10240'
            ]);

            $file = $request->file('file');
            $extension = $file->getClientOriginalExtension();

            // Crear una ruta temporal con la extensión correcta (IMPORTANTE para pyembroidery)
            $tempPath = sys_get_temp_dir() . DIRECTORY_SEPARATOR . 'viz_' . uniqid() . '.' . $extension;

            // Mover/Copiar el archivo a la ruta temporal
            file_put_contents($tempPath, file_get_contents($file->getRealPath()));

            // 1. Analizar Datos Técnicos
            $result = $this->analyzer->analyzeFromPath($tempPath);

            // Agregar metadatos originales que analyzeFromPath no tiene (porque lee del disco)
            $result['original_name'] = $file->getClientOriginalName();
            $result['mime_type'] = $file->getMimeType();

            if ($result['success']) {
                // 2. Generar SVG (Usando la misma ruta temporal válida)
                $svg = $this->analyzer->generateSvg($tempPath);

                return response()->json([
                    'success' => true,
                    'data' => $this->cleanUtf8(array_merge($result, ['svg_content' => $svg]))
                ]);
            } else {
                return response()->json([
                    'success' => false,
                    'error' => $result['error']
                ], 400);
            }
        } catch (\Exception $e) {
            Log::error('Error en VisualizerController@analyze: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error interno al procesar el archivo: ' . $e->getMessage()
            ], 500);
        } finally {
            // Limpieza siempre
            if ($tempPath && file_exists($tempPath)) {
                @unlink($tempPath);
            }
        }
    }
    /**
     * Limpia recursivamente los datos para asegurar UTF-8 válido.
     */
    private function cleanUtf8($data)
    {
        if (is_string($data)) {
            // mb_convert_encoding con 'UTF-8' como input y output reemplaza bytes inválidos
            return mb_convert_encoding($data, 'UTF-8', 'UTF-8');
        }
        if (is_array($data)) {
            $ret = [];
            foreach ($data as $i => $d) {
                $ret[$i] = $this->cleanUtf8($d);
            }
            return $ret;
        }
        return $data;
    }
}
</file>

<file path="app/Models/Attribute.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes; // 1. Importar para borrado lógico
use Illuminate\Support\Str;

class Attribute extends Model
{
    use SoftDeletes; // 2. Usar el trait para borrado lógico

    protected $fillable = [
        'name',
        'slug',
        'type',
        'is_required',
        'order'
    ];

    protected $casts = [
        'is_required' => 'boolean',
        'order' => 'integer',
        'deleted_at' => 'datetime' // 3. Cast de fecha para Laravel 10/11/12
    ];
    /**
     * Boot del modelo para asegurar que el slug sea siempre correcto
     */
    protected static function boot()
    {
        parent::boot();
        static::creating(function ($attribute) {
            if (empty($attribute->slug)) {
                $attribute->slug = Str::slug($attribute->name);
            }
        });
    }

    /**
     * Relación: Un atributo tiene muchos valores 
     */
    public function values()
    {
        // Añadimos el orden por defecto para que los colores/tallas salgan siempre organizados
        return $this->hasMany(AttributeValue::class)->orderBy('order', 'asc');
    }
}
</file>

<file path="app/Models/Design.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

class Design extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'name',
        'slug',
        'description',
        'is_active'
    ];

    protected $casts = [
        'is_active' => 'boolean'
    ];

    // Relación: Un diseño tiene muchas variantes
    public function variants()
    {
        return $this->hasMany(DesignVariant::class);
    }

    // Relación: Un diseño pertenece a muchas categorías
    public function categories()
    {
        return $this->belongsToMany(Category::class);
    }

    // Relación polimórfica: Un diseño tiene muchas imágenes
    public function images()
    {
        return $this->morphMany(Image::class, 'imageable');
    }

    // Imagen principal
    public function primaryImage()
    {
        return $this->morphOne(Image::class, 'imageable')->where('is_primary', true);
    }

    /**
     * Relación con las exportaciones del diseño.
     */
    public function exports()
    {
        return $this->hasMany(DesignExport::class);
    }

    /**
     * Relación con las exportaciones sin variante (generales).
     * Esta relación es CRÍTICA para la funcionalidad de producción.
     * Filtra solo las exportaciones que no están asociadas a una variante específica.
     */
    public function generalExports()
    {
        return $this->hasMany(DesignExport::class)->whereNull('design_variant_id');
    }

    // NUEVA RELACIÓN: Usuario que creó el diseño (para auditoría)
    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    // NUEVO MÉTODO: Contador de exportaciones (para optimización en vistas)
    public function getExportsCountAttribute()
    {
        // Si ya existe el campo exports_count en la tabla (optimización), usarlo
        if (isset($this->attributes['exports_count'])) {
            return $this->attributes['exports_count'];
        }
        // Si no, contar sobre la relación
        return $this->exports()->count();
    }

    // NUEVO MÉTODO: Verifica si el diseño tiene exportaciones
    public function hasExports()
    {
        return $this->exports()->exists();
    }

    // NUEVO MÉTODO: Verifica si el diseño tiene exportaciones aprobadas
    public function hasApprovedExports()
    {
        return $this->exports()->where('status', 'aprobado')->exists();
    }
}
</file>

<file path="app/Models/MaterialCategory.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use App\Traits\HasActivityLog;

class MaterialCategory extends Model
{
    use HasActivityLog;

    protected $table = 'material_categories';

    protected $activityLogNameField = 'name';

    protected $fillable = [
        'name',
        'slug',
        'description',
        'activo',
    ];

    protected $casts = [
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->slug) && !empty($model->name)) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::updating(function (self $model): void {
            if ($model->isDirty('name')) {
                $model->slug = Str::slug($model->name);
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */



    public function materials()
    {
        return $this->hasMany(Material::class, 'material_category_id');
    }

    public function allowedUnits()
    {
        return $this->belongsToMany(Unit::class, 'category_unit', 'material_category_id', 'unit_id')
            ->withTimestamps();
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name');
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canDelete(): array
    {
        if ($this->materials()->where('activo', true)->exists()) {
            return [
                'can_delete' => false,
                'message' => 'No se puede eliminar: tiene materiales activos asociados.',
            ];
        }

        return ['can_delete' => true, 'message' => ''];
    }
}
</file>

<file path="app/Models/ProductCategory.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;

class ProductCategory extends Model
{
    use SoftDeletes;

    protected $table = 'product_categories';

    protected $fillable = [
        'uuid',
        'name',
        'slug',
        'description',
        'is_active',
    ];

    protected $casts = [
        'is_active' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->slug)) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::updating(function (self $model): void {
            if ($model->isDirty('name')) {
                $model->slug = Str::slug($model->name);
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function products()
    {
        return $this->hasMany(Product::class, 'product_category_id');
    }

    public function activeProducts()
    {
        return $this->hasMany(Product::class, 'product_category_id')
            ->where('status', 'active');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('is_active', true);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name', 'asc');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getProductsCountAttribute(): int
    {
        return $this->products()->count();
    }

    public function getActiveProductsCountAttribute(): int
    {
        return $this->activeProducts()->count();
    }

    public function getStatusLabelAttribute(): string
    {
        return $this->is_active ? 'Activa' : 'Inactiva';
    }

    public function getStatusColorAttribute(): string
    {
        return $this->is_active ? 'success' : 'danger';
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canDelete(): bool
    {
        return $this->products()->count() === 0;
    }

    public function getSkuPrefix(): string
    {
        return Str::upper(Str::substr(Str::slug($this->name, ''), 0, 3));
    }
}
</file>

<file path="app/Models/ProductExtra.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;

class ProductExtra extends Model
{
    use SoftDeletes;

    protected $table = 'product_extras';

    protected $fillable = [
        'uuid',
        'name',
        'cost_addition',
        'price_addition',
        'minutes_addition',
    ];

    protected $casts = [
        'cost_addition' => 'decimal:4',
        'price_addition' => 'decimal:4',
        'minutes_addition' => 'integer',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function products()
    {
        return $this->belongsToMany(
            Product::class,
            'product_extra_assignment',
            'product_extra_id',
            'product_id'
        )->withTimestamps();
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name', 'asc');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFormattedCostAttribute(): string
    {
        return '$' . number_format($this->cost_addition, 2);
    }

    public function getFormattedPriceAttribute(): string
    {
        return '+$' . number_format($this->price_addition, 2);
    }

    public function getFormattedMinutesAttribute(): string
    {
        if ($this->minutes_addition <= 0) {
            return '-';
        }

        $hours = floor($this->minutes_addition / 60);
        $minutes = $this->minutes_addition % 60;

        if ($hours > 0) {
            return "{$hours}h {$minutes}m";
        }

        return "{$minutes}m";
    }

    public function getProductsCountAttribute(): int
    {
        return $this->products()->count();
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canDelete(): bool
    {
        return $this->products()->count() === 0;
    }
}
</file>

<file path="app/Models/ProductMaterial.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Relations\Pivot;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class ProductMaterial extends Pivot
{
    protected $table = 'product_materials';

    public $incrementing = true;

    protected $fillable = [
        'product_id',
        'material_variant_id',
        'quantity',
        'is_primary',
        'notes',
        'active_for_variants',
    ];

    protected $casts = [
        'quantity' => 'decimal:4',
        'is_primary' => 'boolean',
        'active_for_variants' => 'array',
    ];

    /**
     * Relación con el material (Variante)
     */
    public function materialVariant()
    {
        return $this->belongsTo(MaterialVariant::class, 'material_variant_id');
    }

    /**
     * Relación con el producto
     */
    public function product()
    {
        return $this->belongsTo(Product::class, 'product_id');
    }
}
</file>

<file path="app/Models/ProductVariant.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;

class ProductVariant extends Model
{
    protected $table = 'product_variants';

    protected $fillable = [
        'uuid',
        'product_id',
        'sku_variant',
        'price',
        'attribute_combinations',
        'stock_alert',
    ];

    protected $casts = [
        'price' => 'decimal:4',
        'attribute_combinations' => 'array',
        'stock_alert' => 'integer',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function product()
    {
        return $this->belongsTo(Product::class, 'product_id');
    }

    public function attributes()
    {
        return $this->belongsToMany(
            AttributeValue::class,
            'product_variant_attribute',
            'product_variant_id',
            'attribute_value_id'
        )->withPivot('attribute_id');
    }

    public function designExports()
    {
        return $this->belongsToMany(
            DesignExport::class,
            'product_variant_design',
            'product_variant_id',
            'design_export_id'
        )->withPivot('application_type_id', 'notes')
            ->withTimestamps();
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('sku_variant', 'asc');
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFormattedPriceAttribute(): string
    {
        return '$' . number_format($this->price, 2);
    }

    public function getTotalWithExtrasAttribute(): float
    {
        $extrasTotal = $this->product->extras->sum('price_addition');
        return (float) $this->price + $extrasTotal;
    }

    public function getFormattedTotalWithExtrasAttribute(): string
    {
        return '$' . number_format($this->total_with_extras, 2);
    }

    public function getAttributesDisplayAttribute(): string
    {
        $attrs = [];
        foreach ($this->attributes as $attrValue) {
            $attrs[] = $attrValue->value;
        }
        return implode(' / ', $attrs);
    }

    public function getAttributesDetailedAttribute(): array
    {
        $result = [];
        foreach ($this->attributes as $attrValue) {
            $result[] = [
                'attribute' => $attrValue->attribute->name ?? 'N/A',
                'value' => $attrValue->value,
            ];
        }
        return $result;
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public static function generateSkuVariant(Product $product, array $attributeValues): string
    {
        $productSku = $product->sku;
        $parts = [$productSku];

        foreach ($attributeValues as $value) {
            $parts[] = Str::upper(Str::substr(Str::slug($value, ''), 0, 3));
        }

        return implode('-', $parts);
    }
}
</file>

<file path="app/Models/Recomendacion.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Recomendacion extends Model
{
    use HasFactory;
    protected $table = 'recomendacion';

    protected $fillable = [
        'nombre_recomendacion',
        'detalles_recomendacion',
        'activo',
        'fecha_baja',
        'motivo_baja',
    ];
    public function clientes()
    {
        return $this->hasMany(Cliente::class);
    }
}
</file>

<file path="app/Models/SystemSetting.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Cache;
use App\Traits\HasActivityLog;

class SystemSetting extends Model
{
    use HasActivityLog;

    public $activityLogNameField = 'label'; // Usar el label (ej: "Nombre de la Empresa") en lugar del ID en los logs

    protected $table = 'system_settings';

    protected $fillable = [
        'key',
        'value',
        'type',
        'group',
        'label',
        'description',
        'options',
        'updated_by',
    ];

    protected $casts = [
        'options' => 'array',
    ];

    protected $hidden = [
        'created_at',
        'updated_at',
    ];

    public function updatedByUser()
    {
        return $this->belongsTo(User::class, 'updated_by');
    }

    public static function getValue(string $key, mixed $default = null): mixed
    {
        // Validar formato de key
        if (!preg_match('/^[a-z][a-z0-9_]{2,50}$/', $key)) {
            return $default;
        }

        return Cache::remember("setting_{$key}", 3600, function () use ($key, $default) {
            $setting = static::where('key', $key)->first();

            if (!$setting) {
                return $default;
            }

            return match ($setting->type) {
                'boolean' => $setting->value === '1',
                'integer' => (int) $setting->value,
                'json' => json_decode($setting->value, true) ?? $default,
                default => $setting->value,
            };
        });
    }

    public static function getByGroup(string $group): \Illuminate\Database\Eloquent\Collection
    {
        // Validar formato de grupo
        if (!preg_match('/^[a-z]{3,50}$/', $group)) {
            return collect();
        }

        return static::where('group', $group)->orderBy('id')->get();
    }

    public static function getGroups(): array
    {
        return static::distinct()->pluck('group')->toArray();
    }
}
</file>

<file path="database/migrations/0001_01_01_000000_create_users_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('users', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('email')->unique();
            $table->timestamp('email_verified_at')->nullable();
            $table->string('password');
            $table->rememberToken();
            $table->timestamps();
        });

        Schema::create('password_reset_tokens', function (Blueprint $table) {
            $table->string('email')->primary();
            $table->string('token');
            $table->timestamp('created_at')->nullable();
        });

        Schema::create('sessions', function (Blueprint $table) {
            $table->string('id')->primary();
            $table->foreignId('user_id')->nullable()->index();
            $table->string('ip_address', 45)->nullable();
            $table->text('user_agent')->nullable();
            $table->longText('payload');
            $table->integer('last_activity')->index();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('users');
        Schema::dropIfExists('password_reset_tokens');
        Schema::dropIfExists('sessions');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_16_174450_create_giros_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('giros', function (Blueprint $table) {
            $table->id();
            $table->string('nombre_giro');
            $table->string('descripcion')->nullable();
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('giros');
    }
};
</file>

<file path="database/migrations/2025_12_19_172849_create_designs_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('designs', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('slug')->unique();
            $table->text('description')->nullable();
            $table->boolean('is_active')->default(true);
            $table->timestamps();
            $table->softDeletes(); // Para eliminación suave

            // Índices
            $table->index('slug');
            $table->index('name');
            $table->index('is_active');
        });
        //softDeletes(): Agrega campo deleted_at para no eliminar físicamente registros
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('designs');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="database/migrations/2025_12_19_172905_create_attributes_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('attributes', function (Blueprint $table) {
            $table->id();
            $table->string('name');
            $table->string('slug')->unique();
            $table->enum('type', ['select', 'color', 'text'])->default('select');
            $table->boolean('is_required')->default(false);
            $table->integer('order')->default(0);
            $table->timestamps();
            $table->softDeletes(); // <--- ESTA LÍNEA ES OBLIGATORIA
            // Índices
            $table->index('slug');
        });
        //enum(): Campo que solo acepta valores específicos (select, color, text)
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('attributes');
    }
};
</file>

<file path="database/migrations/2025_12_19_172911_create_attribute_values_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('attribute_values', function (Blueprint $table) {
            $table->id();
            $table->foreignId('attribute_id')->constrained()->onDelete('cascade');
            $table->string('value');
            $table->string('hex_color', 7)->nullable();
            $table->integer('order')->default(0);
            $table->timestamps();
            $table->softDeletes();
            // Índices
            $table->index('attribute_id');
        });
        //hex_color: Almacena colores como #FF0000 (7 caracteres máximo)
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('attribute_values');
    }
};
</file>

<file path="resources/views/admin/activity-logs/show.blade.php">
@extends('adminlte::page')

@section('title', 'Auditoría Técnica')

@section('content')
    <div class="container-fluid pt-4">
        <div class="card card-outline card-info shadow">
            <div class="card-header">
                <h3 class="card-title font-weight-bold">
                    <i class="fas fa-fingerprint mr-2 text-info"></i> Detalle de Auditoría
                </h3>
                <div class="card-tools">
                    <span class="badge badge-light border px-3 py-2">UUID: {{ $log->uuid }}</span>
                </div>
            </div>

            <div class="card-body">
                <div class="row">
                    {{-- Bloque Izquierdo: Información del Evento --}}
                    <div class="col-md-6">
                        <h5 class="text-info border-bottom pb-2 mb-3">
                            <i class="fas fa-history mr-1"></i> Contexto del Evento
                        </h5>
                        <table class="table table-sm table-hover">
                            <tbody>
                                <tr>
                                    <th style="width: 30%">Fecha y Hora</th>
                                    <td>{{ $log->created_at->format('d/m/Y H:i:s') }}
                                        <small class="text-muted">({{ $log->created_at->diffForHumans() }})</small>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Operador</th>
                                    <td>
                                        <span
                                            class="badge badge-secondary px-2">{{ $log->user_name ?? 'Sistema / Cron' }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Acción</th>
                                    <td>
                                        <span class="badge border text-uppercase px-2">
                                            <i class="{{ $log->action_icon }} mr-1"></i> {{ $log->action_label }}
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Módulo / Entidad</th>
                                    <td><code class="text-primary font-weight-bold">{{ $log->short_model_type }}</code></td>
                                </tr>
                                <tr>
                                    <th>ID del Registro</th>
                                    <td><span class="badge badge-light border">#{{ $log->model_id ?? 'N/A' }}</span></td>
                                </tr>
                                <tr>
                                    <th>Descripción</th>
                                    <td class="text-wrap"><strong>{{ $log->description }}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    {{-- Bloque Derecho: Información de Red/Técnica --}}
                    <div class="col-md-6">
                        <h5 class="text-success border-bottom pb-2 mb-3">
                            <i class="fas fa-network-wired mr-1"></i> Trazabilidad Técnica
                        </h5>
                        <table class="table table-sm table-hover">
                            <tbody>
                                <tr>
                                    <th style="width: 30%">Dirección IP</th>
                                    <td><code class="bg-light px-2 rounded">{{ $log->ip_address ?? 'Local/Unknown' }}</code>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Método HTTP</th>
                                    <td><span class="badge badge-outline-dark">{{ $log->method ?? 'N/A' }}</span></td>
                                </tr>
                                <tr>
                                    <th>URL Solicitada</th>
                                    <td><small class="text-break">{{ $log->url ?? 'N/A' }}</small></td>
                                </tr>
                                <tr>
                                    <th>Agente de Navegación</th>
                                    <td><small class="text-muted text-break">{{ $log->user_agent ?? 'N/A' }}</small></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                {{-- Comparativa de Valores (Solo si hay cambios) --}}
                @if ($log->action === 'updated' && $log->new_values)
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="text-warning border-bottom pb-2 mb-3">
                                <i class="fas fa-columns mr-1"></i> Comparativa de Cambios
                            </h5>
                            <div class="table-responsive border rounded">
                                <table class="table table-striped table-valign-middle m-0">
                                    <thead class="bg-light">
                                        <tr>
                                            <th>Atributo Modificado</th>
                                            <th class="text-danger">Valor Anterior</th>
                                            <th class="text-success">Valor Nuevo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach ($log->new_values as $key => $value)
                                            <tr>
                                                <td class="font-weight-bold text-muted">
                                                    {{ str($key)->replace('_', ' ')->title() }}</td>
                                                <td class="bg-soft-danger">
                                                    @if (isset($log->old_values[$key]))
                                                        <del>{{ is_array($log->old_values[$key]) ? json_encode($log->old_values[$key]) : $log->old_values[$key] }}</del>
                                                    @else
                                                        <span class="text-muted small"><em>Nulo</em></span>
                                                    @endif
                                                </td>
                                                <td class="bg-soft-success font-weight-bold">
                                                    {{ is_array($value) ? json_encode($value) : $value }}
                                                </td>
                                            </tr>
                                        @endforeach
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                @elseif($log->action === 'created' || $log->action === 'deleted')
                    {{-- Para creación o eliminación mostramos el bloque de datos completo --}}
                    <div class="row mt-4">
                        <div class="col-12">
                            <h5 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-database mr-1"></i> Datos del Registro ({{ $log->action_label }})
                            </h5>
                            <div class="bg-light p-3 border rounded">
                                <pre class="m-0"><code>{{ json_encode($log->action === 'created' ? $log->new_values : $log->old_values, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE) }}</code></pre>
                            </div>
                        </div>
                    </div>
                @endif
            </div>

            <div class="card-footer bg-white text-right">
                <a href="{{ route('admin.activity-logs.index') }}" class="btn btn-sm btn-secondary">
                    <i class="fas fa-arrow-left"></i> Volver
                </a>
            </div>
        </div>
    </div>
@stop

@push('css')
    <style>
        .bg-soft-danger {
            background-color: rgba(220, 53, 69, 0.05);
        }

        .bg-soft-success {
            background-color: rgba(40, 167, 69, 0.05);
        }

        pre {
            font-size: 85%;
        }
    </style>
@endpush
</file>

<file path="resources/views/admin/categorias/delete.blade.php">
@extends('adminlte::page')

@section('title', 'CATEGORIA')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-md-4">
        <div class="card card-danger " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> ELIMINAR CATEGORIA</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form id="deleteForm" action="{{ route('admin.categories.destroy', $category->id) }}" method="POST"
                    style="display: inline-block;">
                    @csrf
                    @method('DELETE')
                    <div class="col-md-12">


                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos de la Categoria
                            </h5>
                        </div>
                        <div class="form-group">


                            <label for="nombre">

                                Nombre <span style="color: red;">*</span>
                            </label>
                            <input type="text" class="form-control form-control-sm" id="nombre" name="nombre"
                                placeholder="Ej: TELA" pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+"
                                title="Solo se permiten letras y espacios" value="{{ $category->name }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" disabled>
                        </div>
                        <div style="font-weight: bold;font-size: 25px;text-align: center;">¿Deseas eliminar la
                            categoria?</div>
                        <!-- Botones de acción -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="text-right">
                                    <a href="{{ route('admin.categories.index') }}" class="btn btn-secondary"
                                        style="margin-right: 10px; padding: 8px 20px;">
                                        <i class="fas fa-times-circle"></i> Regresar
                                    </a>
                                    <button type="submit" class="btn btn-danger" style="padding: 8px 20px;">
                                        <i class="fas fa-trash-alt"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault(); // Detener el envío automático

            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡Eliminarás esta categoría y TODO su contenido asociado!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', // Rojo para acción destructiva
                cancelButtonColor: '#6c757d', // Gris para cancelar
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true // Pone Cancelar a la Izquierda y Confirmar a la Derecha
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit(); // Enviar el formulario si se confirma
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/design-variants/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nueva Variante')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h1 class="text-2xl font-weight-semibold text-gray-800">
            Nueva variante de: {{ $design->name }}
        </h1>
        <div class="d-flex gap-2">
            <a id="back-btn" href="{{ route('admin.designs.index') }}" class="btn btn-secondary btn-md px-3 mr-2">
                <i class="fas fa-arrow-left"></i> Regresar
            </a>
            <button id="submitBtn" form="variant-form" type="submit" class="btn btn-primary btn-md px-3">
                <i class="fas fa-save"></i> Guardar variante
            </button>
        </div>
    </div>
@stop

@section('content')
    {{-- ============================================
         SPINNER PREMIUM CON BARRA DE PROGRESO (NUEVO)
         ============================================ --}}
    <div class="modal-loading-overlay" id="loadingOverlay">
        <div class="modal-loading-content">
            <div class="modal-loading-spinner"></div>
            <h3 class="modal-loading-title" id="loadingTitle">Guardando variante</h3>
            <p class="modal-loading-subtitle" id="loadingSubtitle">
                Procesando tu solicitud, por favor espera...
            </p>

            {{-- CONTENEDOR DE BARRA DE PROGRESO --}}
            <div class="progress-container-premium">
                <div class="progress-bar-premium" id="progressBar">
                    <div class="progress-fill-premium" id="progressFill"></div>
                </div>
                <div class="progress-text-container">
                    <span class="progress-text" id="progressText">0%</span>
                    <span class="progress-status" id="progressStatus">Iniciando...</span>
                </div>
            </div>
        </div>
    </div>

    <form id="variant-form" action="{{ route('admin.designs.variants.store', $design) }}" method="POST"
        enctype="multipart/form-data">
        @csrf

        <div class="row">
            {{-- COLUMNA IZQUIERDA --}}
            <div class="col-lg-5">
                <div class="surface">
                    <h5 class="section-title mb-3">
                        <i class="fas fa-image text-primary"></i> Imágenes de la variante
                    </h5>

                    <div class="alert alert-info alert-modern mb-3">
                        <i class="fas fa-info-circle"></i>
                        <span>Sube hasta 10 imágenes (máx. 10MB c/u) específicas para esta variante.</span>
                    </div>

                    {{-- DROPZONE COMPACTO --}}
                    <div id="dropzone" class="dropzone dropzone-compact">
                        <input type="file" id="imageInput" name="variant_images[]" multiple accept="image/*" hidden>

                        {{-- Contenido de la dropzone (texto) --}}
                        <div class="dropzone-content" id="dropzoneContent">
                            <div class="dropzone-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="dropzone-title">Subir imágenes</div>
                            <div class="dropzone-sub">Arrastra imágenes aquí o haz clic</div>
                            <div class="dropzone-formats">
                                Formatos: JPEG, PNG, SVG, AVIF, WebP
                            </div>
                        </div>
                    </div>

                    {{-- Resumen de archivos (MOVIDO: ahora está debajo del dropzone) --}}
                    <div id="filesSummary" class="files-summary" style="display: none;">
                        <div class="summary-header">
                            <i class="fas fa-images text-primary"></i>
                            <span id="summaryCount">0 archivos seleccionados</span>
                        </div>
                        <div class="summary-details">
                            <span id="summaryTotal">Total: 0 imágenes</span>
                            <span id="summarySize">Tamaño total: 0 KB</span>
                        </div>
                        <div class="summary-status">
                            <i class="fas fa-check-circle text-success"></i>
                            <span id="summaryReady">Listo para subir 0 archivos</span>
                        </div>
                    </div>

                    {{-- Contenedor scrolleable para las imágenes con analizador --}}
                    <div id="imagesScrollContainer" class="images-scroll-container">
                        <div id="imagesGrid" class="images-analysis-grid">
                            {{-- Aquí se agregan las imágenes con su info --}}
                        </div>
                    </div>

                    {{-- Toast para mensajes --}}
                    <div id="appleToast" class="apple-toast">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="toastMessage" style="font-weight: 500; color: #1d1d1f;"></span>
                    </div>
                </div>
            </div>

            {{-- COLUMNA DERECHA --}}
            <div class="col-lg-7">
                <div class="surface">
                    <h5 class="section-title mb-4">
                        <i class="fas fa-info-circle text-primary"></i> Información básica
                    </h5>

                    <div class="mb-4">
                        <label class="label">Nombre de la variante <span class="text-danger">*</span></label>
                        <input type="text" id="variant_name" name="name"
                            class="input @error('name') is-invalid @enderror"
                            placeholder="Ej. Sentado, Edición Especial, etc." value="{{ old('name') }}" required>
                        @error('name')
                            <span class="text-danger small d-block">{{ $message }}</span>
                        @enderror
                    </div>

                    <div class="mb-4">
                        <label class="label">SKU (Código único) </label>
                        <input type="text" id="variant_sku" name="sku"
                            class="input sku-readonly @error('sku') is-invalid @enderror" placeholder="SKU_AUTOMATICO"
                            value="{{ old('sku') }}" readonly tabindex="-1">
                        <small class="hint">Código automático jerárquico profesional</small>
                    </div>

                    {{-- Selector visual de imagen principal --}}
                    <div class="mb-4 mt-4" id="primaryImageContainer" style="display: none;">
                        <label class="label">
                            <i class="fas fa-star text-warning"></i> Selecciona la imagen principal de la variante <span class="text-danger">*</span>
                        </label>
                        <input type="hidden" id="primary_image_index" name="primary_image_index" value="">

                        <div id="primaryImageGrid" class="primary-image-grid">
                            {{-- Aquí se generan las opciones de imagen --}}
                        </div>

                        <div id="primaryImageError" class="invalid-feedback" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i> Debes seleccionar una imagen principal
                        </div>

                        <small class="hint mt-2">
                            <i class="fas fa-info-circle text-info"></i> Esta imagen será la representativa de la variante en listados y búsquedas. Haz clic para seleccionar.
                        </small>
                    </div>

                    {{-- Campos ocultos necesarios para el backend --}}
                    <input type="hidden" name="is_active" value="1">
                    <input type="hidden" name="is_default" value="0">
                </div>
            </div>
        </div>
    </form>
@stop

@section('css')
    <style>
        /* ============================================
           MATERIAL DESIGN / APPLE HIG - BASE STYLES
           ============================================ */
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 15px;
            --font-size-lg: 17px;
            --font-size-xl: 20px;
        }

        .surface {
            background: #fff;
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-md);
            height: 100%;
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: var(--font-size-base);
        }

        .label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 6px;
            display: block;
            font-size: var(--font-size-base);
        }

        .input {
            width: 100%;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            font-size: var(--font-size-base);
            background: var(--gray-50);
            transition: all 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* ============================================
           ALERTA MODERNA
           ============================================ */
        .alert-modern {
            font-size: var(--font-size-sm);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            border: none;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-modern i {
            margin-top: 2px;
        }

        .custom-unified-group {
            display: flex;
            align-items: stretch;
            background: #f5f5f7;
            border-radius: 12px;
            border: 1px solid #d2d2d7;
            height: 48px;
            overflow: hidden;
        }

        .unificado-text {
            background: transparent !important;
            border: none !important;
            color: #86868b;
            padding: 0 12px;
            display: flex;
            align-items: center;
        }

        .unificado-input {
            border: none !important;
            background: transparent !important;
            flex: 1;
            outline: none !important;
        }

        /* ============================================
           DROPZONE - DISEÑO MODERNO
           ============================================ */
        .dropzone {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-50);
        }

        .dropzone:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }

        .dropzone-content {
            text-align: center;
        }

        .dropzone-icon {
            font-size: 42px;
            color: var(--gray-400);
            margin-bottom: 12px;
        }

        .dropzone-title {
            font-weight: 600;
            font-size: var(--font-size-lg);
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .dropzone-sub {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .dropzone-formats {
            font-size: var(--font-size-xs);
            color: var(--gray-400);
            background: var(--gray-100);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .preview-item {
            position: relative;
            padding-top: 100%;
            background: #fff;
            border-radius: 16px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .preview-item img {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            height: 90%;
            object-fit: contain;
        }

        .remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            cursor: pointer;
            z-index: 10;
            font-size: 18px;
            line-height: 1;
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .color-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .color-option input {
            display: none;
        }

        .color-option input:checked+.color-label {
            border-color: #0071e3;
            transform: scale(1.05);
        }

        .color-name {
            font-size: 10px;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 5px;
            border-radius: 4px;
        }

        .apple-toast {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 20px;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .apple-toast.show {
            transform: translateX(0);
        }

        .sku-readonly {
            background-color: #f1f1f2 !important;
            color: #86868b;
            cursor: not-allowed;
        }

        /* ============================================
               SISTEMA PREMIUM (NUEVOS ESTILOS AGREGADOS)
               ============================================ */

        /* DROPZONE COMPACTO */
        .dropzone.dropzone-compact {
            min-height: 120px;
            padding: 20px 15px;
        }

        .dropzone.dropzone-compact .dropzone-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .dropzone.dropzone-compact .dropzone-title {
            font-size: 15px;
            margin-bottom: 3px;
        }

        .dropzone.dropzone-compact .dropzone-sub {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .dropzone.dropzone-compact .dropzone-formats {
            font-size: 11px;
            margin-top: 5px;
        }

        .dropzone-icon {
            font-size: 48px;
            color: #9ca3af;
            margin-bottom: 15px;
        }

        .dropzone-title {
            font-weight: 600;
            font-size: 18px;
            color: #111827;
            margin-bottom: 5px;
        }

        .dropzone-sub {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .dropzone-formats {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 10px;
        }

        /* ============================================
           CONTENEDOR SCROLLEABLE DE IMÁGENES
           ============================================ */
        .images-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 5px;
        }

        .images-scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .images-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .images-scroll-container::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        .images-scroll-container::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* GRID DE IMÁGENES CON ANÁLISIS (2 COLUMNAS) */
        .images-analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* ============================================
           IMAGE ANALYSIS CARD - DISEÑO DESCRIPTIVO
           ============================================ */
        .image-analysis-card {
            background: #fff;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .image-analysis-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .image-analysis-card.selected {
            border-color: var(--primary);
            border-width: 2px;
        }

        /* Preview de imagen dentro de la card */
        .image-card-preview {
            position: relative;
            width: 100%;
            height: 120px;
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-bottom: 1px solid var(--gray-100);
        }

        .image-card-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Botón de eliminar */
        .image-card-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: 2px solid white;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .image-card-remove:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }

        /* Info del análisis */
        .image-card-info {
            padding: 14px;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .image-card-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 10px;
        }

        .image-card-name i {
            color: var(--primary);
        }

        .image-card-name span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-card-details {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-200);
        }

        .image-card-dimensions {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: var(--font-size-sm);
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .image-card-dimensions .dim-label {
            color: var(--gray-500);
            font-weight: 500;
        }

        .image-card-format {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: var(--font-size-sm);
            color: var(--success);
            font-weight: 500;
        }

        .image-card-format i {
            font-size: var(--font-size-xs);
        }

        /* Alerta de extensión diferente */
        .image-card-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: var(--radius-sm);
            padding: 8px 10px;
            margin-top: 10px;
            font-size: var(--font-size-xs);
            color: #92400e;
            display: flex;
            align-items: flex-start;
            gap: 6px;
        }

        .image-card-warning i {
            color: var(--warning);
            margin-top: 1px;
            flex-shrink: 0;
        }

        .image-card-warning div {
            line-height: 1.4;
        }

        /* ============================================
           SELECTOR VISUAL DE IMAGEN PRINCIPAL
           ============================================ */
        .primary-image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .primary-image-option {
            position: relative;
            border: 3px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            aspect-ratio: 1;
            background: #f9fafb;
        }

        .primary-image-option:hover {
            border-color: #93c5fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .primary-image-option.selected {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2), 0 4px 12px rgba(37, 99, 235, 0.25);
        }

        .primary-image-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .primary-image-option .image-number {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .primary-image-option .selected-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: #2563eb;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .primary-image-option.selected .selected-badge {
            transform: translate(-50%, -50%) scale(1);
        }

        .primary-image-option .image-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            color: white;
            font-size: 11px;
            padding: 20px 8px 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Error de validación */
        .primary-image-grid.has-error {
            border: 2px dashed #dc2626;
            border-radius: 12px;
            padding: 10px;
            background: #fef2f2;
        }

        .invalid-feedback {
            color: #dc2626;
            font-size: 13px;
            margin-top: 8px;
        }

        /* Alerta de extensión diferente */
        .image-card-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 6px;
            padding: 6px 8px;
            margin-top: 6px;
            font-size: 9px;
            color: #92400e;
        }

        .image-card-warning i {
            color: #d97706;
            margin-right: 3px;
        }

        /* Resumen de archivos */
        .files-summary {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 14px;
            margin-top: 12px;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
        }

        .summary-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .summary-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #059669;
            font-weight: 500;
        }

        /* Para archivos de bordado */
        .embroidery-preview {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            color: white;
            text-align: center;
            padding: 15px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .embroidery-preview i {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .embroidery-preview .format-name {
            font-size: 11px;
            font-weight: 600;
        }

        /* Para SVGs */
        .svg-preview {
            background: white;
            padding: 10px;
        }

        /* Responsive para grid de 1 columna en móvil */
        @media (max-width: 576px) {
            .images-analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ============================================
               ESTILOS DEL SPINNER PREMIUM (AGREGADOS)
               ============================================ */
        .modal-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .modal-loading-content {
            text-align: center;
            padding: 40px;
            max-width: 320px;
        }

        .modal-loading-spinner {
            width: 64px;
            height: 64px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top-color: #2563eb;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }

        .modal-loading-subtitle {
            font-size: 0.95rem;
            color: #6b7280;
            line-height: 1.5;
        }

        /* ============================================
               BARRA DE PROGRESO PREMIUM
               ============================================ */
        .progress-container-premium {
            width: 100%;
            max-width: 320px;
            margin: 24px auto 0;
        }

        .progress-bar-premium {
            width: 100%;
            height: 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        .progress-fill-premium {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,
                    #2563eb 0%,
                    #3b82f6 25%,
                    #60a5fa 50%,
                    #93c5fd 75%,
                    #bfdbfe 100%);
            border-radius: 10px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
        }

        /* Efecto de brillo animado */
        .progress-fill-premium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    transparent 100%);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Texto de progreso */
        .progress-text-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .progress-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2563eb;
            text-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
            min-width: 60px;
        }

        .progress-status {
            font-size: 0.95rem;
            color: #6b7280;
            font-weight: 500;
            text-align: right;
            flex: 1;
            padding-left: 16px;
        }

        /* Estados de completado */
        .progress-complete .progress-fill-premium {
            background: linear-gradient(90deg,
                    #059669 0%,
                    #10b981 25%,
                    #34d399 50%,
                    #6ee7b7 75%,
                    #a7f3d0 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .progress-complete .progress-text {
            color: #059669;
        }

        /* Estados de error */
        .progress-error .progress-fill-premium {
            background: linear-gradient(90deg,
                    #dc2626 0%,
                    #ef4444 25%,
                    #f87171 50%,
                    #fca5a5 75%,
                    #fecaca 100%);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .progress-error .progress-text {
            color: #dc2626;
        }

        /* ========== ESTILOS PARA INFORMACIÓN DE ARCHIVO ========== */
        .file-info {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 13px;
            margin-top: 12px;
        }

        .file-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .file-info-name {
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }

        .file-info-details {
            display: flex;
            justify-content: space-between;
            color: #6b7280;
            font-size: 12px;
        }

        .file-info-success {
            color: #059669;
            font-weight: 500;
        }

        /* Animación fade-in */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Estilos para botones deshabilitados */
        .disabled-btn {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Dropzone con error */
        .dropzone.border-danger {
            border-color: #dc2626 !important;
            background: #fef2f2;
        }

        /* Responsive */
        @media (max-width: 991px) {
            .dropzone {
                min-height: 250px;
            }

            .dropzone-title {
                font-size: 16px;
            }

            .preview-multiple-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }

            .preview-multiple-item {
                width: 100px;
                height: 100px;
            }
        }
    </style>
@stop

@section('js')
    <script>
        // ============================================
        // SISTEMA PREMIUM COMPLETO PARA NUEVA VARIANTE
        // ============================================

        // ============================================
        // VALIDADOR MEJORADO DE ARCHIVOS DE DISEÑO
        // ============================================
        class DesignFileValidator {
            constructor() {
                this.allowedExtensions = [
                    'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'tiff',
                    'svg', 'svgz',
                    'pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv', 'csd', '10o', 'bro'
                ];

                this.maxSizes = {
                    'image': 10 * 1024 * 1024,
                    'vector': 5 * 1024 * 1024,
                    'embroidery': 50 * 1024 * 1024
                };
            }

            async getFileBytes(file, bytes = 64) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = (e) => {
                        try {
                            const arr = new Uint8Array(e.target.result);
                            resolve(arr);
                        } catch (error) {
                            resolve(new Uint8Array());
                        }
                    };
                    reader.onerror = () => resolve(new Uint8Array());
                    const slice = file.slice(0, bytes);
                    reader.readAsArrayBuffer(slice);
                });
            }

            async detectFileTypeByContent(file) {
                const bytes = await this.getFileBytes(file, 64);
                if (bytes.length === 0) return null;

                let hexHeader = '';
                for (let i = 0; i < bytes.length; i++) {
                    hexHeader += bytes[i].toString(16).padStart(2, '0');
                }

                const signatures = {
                    'jpeg': [
                        'ffd8ffe0', 'ffd8ffe1', 'ffd8ffe2', 'ffd8ffe3',
                        'ffd8ffe8', 'ffd8ffdb', 'ffd8ffee'
                    ],
                    'png': ['89504e470d0a1a0a'],
                    'gif': ['474946383761', '474946383961'],
                    'bmp': ['424d'],
                    'webp': ['52494646'],
                    'tiff': ['49492a00', '4d4d002a'],
                    'svg': ['3c737667', '3c3f786d6c', '3c21444f4354595045'],
                    'pes': ['23504553', '50455330', '43455031'],
                    'dst': ['4154414a494d41', '4c414a494d41'],
                    'exp': ['45787031', '45787032'],
                    'xxx': ['585858', '53494e474552'],
                    'jef': ['4a4546', '4a454631'],
                    'vp3': ['567033', '4856534d'],
                    'hus': ['4846475631', '4846475632'],
                    'pec': ['504543', '50454330', '43455031'],
                    'phc': ['504843', '43455031'],
                    'sew': ['534557', '53455730'],
                    'shv': ['534856', '53485630'],
                    'csd': ['436865727279'],
                    '10o': ['31306f'],
                    'bro': ['42524f']
                };

                if (hexHeader.startsWith('52494646')) {
                    const webpBytes = await this.getFileBytes(file, 16);
                    if (webpBytes.length >= 12) {
                        const webpCheck = String.fromCharCode(webpBytes[8], webpBytes[9], webpBytes[10], webpBytes[11]);
                        if (webpCheck === 'WEBP') {
                            return 'webp';
                        }
                    }
                }

                if (hexHeader.startsWith('0000001') || hexHeader.startsWith('0000002')) {
                    const avifBytes = await this.getFileBytes(file, 12);
                    if (avifBytes.length >= 12) {
                        const ftypPos = String.fromCharCode(avifBytes[4], avifBytes[5], avifBytes[6], avifBytes[7]);
                        const brand = String.fromCharCode(avifBytes[8], avifBytes[9], avifBytes[10], avifBytes[11]);
                        if (ftypPos === 'ftyp' && (brand === 'avif' || brand === 'avis' || brand === 'mif1')) {
                            return 'avif';
                        }
                    }
                }

                for (const [type, sigs] of Object.entries(signatures)) {
                    for (const sig of sigs) {
                        if (hexHeader.startsWith(sig)) {
                            if (type === 'svg') {
                                const isSvg = await this.validateSVGContent(file);
                                if (isSvg) return 'svg';
                            } else {
                                return type;
                            }
                        }
                    }
                }

                return null;
            }

            async validateSVGContent(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = (e) => {
                        try {
                            const content = e.target.result;
                            const hasSvgTag = content.includes('<svg') || content.includes('<SVG');
                            resolve(hasSvgTag);
                        } catch (error) {
                            resolve(false);
                        }
                    };
                    reader.onerror = () => resolve(false);
                    reader.readAsText(file.slice(0, 2048));
                });
            }

            getFileCategory(fileType) {
                const imageTypes = ['jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'tiff'];
                const vectorTypes = ['svg'];
                const embroideryTypes = ['pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv',
                    'csd', '10o', 'bro'
                ];

                if (imageTypes.includes(fileType)) return 'image';
                if (vectorTypes.includes(fileType)) return 'vector';
                if (embroideryTypes.includes(fileType)) return 'embroidery';

                return 'unknown';
            }

            async validateDesignFile(file) {
                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();

                const detectedType = await this.detectFileTypeByContent(file);

                if (!detectedType) {
                    if (this.allowedExtensions.includes(fileExtension)) {
                        return {
                            valid: true,
                            type: this.getFileCategory(fileExtension),
                            subtype: fileExtension,
                            detectedBy: 'extension',
                            reason: `Archivo aceptado por extensión (.${fileExtension})`
                        };
                    }
                    return {
                        valid: false,
                        reason: 'Formato de archivo no reconocido. Asegúrate de subir una imagen, SVG o archivo de bordado válido.'
                    };
                }

                const category = this.getFileCategory(detectedType);

                const sizeValidation = this.validateFileSize(file, category);
                if (!sizeValidation.valid) {
                    return sizeValidation;
                }

                let reason = '';
                if (detectedType !== fileExtension) {
                    reason =
                        `Formato detectado: ${detectedType.toUpperCase()} (archivo con extensión .${fileExtension})`;
                } else {
                    reason = `Archivo ${detectedType.toUpperCase()} válido`;
                }

                return {
                    valid: true,
                    type: category,
                    subtype: detectedType,
                    detectedBy: 'signature',
                    reason: reason,
                    actualExtension: fileExtension
                };
            }

            validateFileSize(file, category) {
                const maxSize = this.maxSizes[category] || 10 * 1024 * 1024;

                if (file.size > maxSize) {
                    const sizeMB = (maxSize / (1024 * 1024)).toFixed(1);
                    let fileTypeName = '';
                    switch (category) {
                        case 'image':
                            fileTypeName = 'imágenes';
                            break;
                        case 'vector':
                            fileTypeName = 'SVG';
                            break;
                        case 'embroidery':
                            fileTypeName = 'archivos de bordado';
                            break;
                        default:
                            fileTypeName = 'archivos';
                    }
                    return {
                        valid: false,
                        reason: `El archivo es demasiado grande. Máximo ${sizeMB}MB para ${fileTypeName}.`
                    };
                }
                return {
                    valid: true,
                    reason: 'Tamaño válido'
                };
            }

            getFileIcon(fileType) {
                const icons = {
                    'image': 'image',
                    'vector': 'vector-square',
                    'embroidery': 'vest',
                    'jpeg': 'file-image',
                    'png': 'file-image',
                    'gif': 'file-image',
                    'bmp': 'file-image',
                    'webp': 'file-image',
                    'avif': 'file-image',
                    'svg': 'vector-square',
                    'pes': 'vest',
                    'dst': 'vest',
                    'default': 'file'
                };

                return icons[fileType] || icons['default'];
            }
        }

        // ============================================
        // CÓDIGO PRINCIPAL DE LA VISTA
        // ============================================
        const dropzone = document.getElementById('dropzone');
        const input = document.getElementById('imageInput');
        const imagesGrid = document.getElementById('imagesGrid');
        const imagesScrollContainer = document.getElementById('imagesScrollContainer');
        const filesSummary = document.getElementById('filesSummary');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('variant-form');
        const backBtn = document.getElementById('back-btn');
        const nameInput = document.getElementById('variant_name');
        const skuInput = document.getElementById('variant_sku');
        const designBaseName = "{{ $design->name }}";
        const appleToast = document.getElementById('appleToast');
        const toastMessage = document.getElementById('toastMessage');
        const primaryImageContainer = document.getElementById('primaryImageContainer');
        const primaryImageGrid = document.getElementById('primaryImageGrid');
        const primaryImageInput = document.getElementById('primary_image_index');
        const primaryImageError = document.getElementById('primaryImageError');

        let isSubmitting = false;
        let currentObjectURLs = [];
        const fileValidator = new DesignFileValidator();
        let selectedFiles = [];
        let validationResults = []; // Guardar resultados de validación

        // Variable para controlar si hay cambios en el formulario
        let formChanged = false;
        let isFormSubmitting = false;

        // ============================================
        // FUNCIONALIDAD DE SKU AUTOMÁTICO
        // ============================================

        function updateSku() {
            let skuBase = designBaseName;
            let userValue = nameInput.value.trim();
            if (userValue) {
                skuBase += " " + userValue;
            }

            skuInput.value = skuBase
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, '_')
                .replace(/[^a-zA-Z0-9_]/g, '')
                .toUpperCase();
        }

        nameInput.addEventListener('input', updateSku);
        updateSku(); // Inicializar SKU

        // ============================================
        // FUNCIONALIDAD DEL SELECTOR VISUAL DE IMAGEN PRINCIPAL
        // ============================================

        function updatePrimaryImageSelect() {
            // Mostrar selector solo si hay imágenes
            if (selectedFiles.length > 0) {
                primaryImageContainer.style.display = 'block';

                // Limpiar grid actual
                primaryImageGrid.innerHTML = '';

                // Crear opción visual por cada imagen
                selectedFiles.forEach((file, index) => {
                    const option = document.createElement('div');
                    option.className = 'primary-image-option';
                    option.dataset.index = index;

                    // Crear thumbnail
                    const img = document.createElement('img');
                    const objectURL = URL.createObjectURL(file);
                    img.src = objectURL;
                    img.alt = file.name;

                    // Número de imagen
                    const numberBadge = document.createElement('span');
                    numberBadge.className = 'image-number';
                    numberBadge.textContent = index + 1;

                    // Badge de selección
                    const selectedBadge = document.createElement('span');
                    selectedBadge.className = 'selected-badge';
                    selectedBadge.innerHTML = '<i class="fas fa-check"></i>';

                    // Nombre de la imagen
                    const imageName = document.createElement('span');
                    imageName.className = 'image-name';
                    imageName.textContent = file.name;
                    imageName.title = file.name;

                    option.appendChild(img);
                    option.appendChild(numberBadge);
                    option.appendChild(selectedBadge);
                    option.appendChild(imageName);

                    // Event listener para seleccionar
                    option.addEventListener('click', () => selectPrimaryImage(index));

                    primaryImageGrid.appendChild(option);
                });

                // Si solo hay una imagen, seleccionarla automáticamente
                if (selectedFiles.length === 1) {
                    selectPrimaryImage(0);
                } else if (primaryImageInput.value === '') {
                    // Si hay más de una y ninguna está seleccionada, limpiar selección
                    clearPrimaryImageSelection();
                }
            } else {
                primaryImageContainer.style.display = 'none';
                primaryImageInput.value = '';
            }
        }

        function selectPrimaryImage(index) {
            // Actualizar input hidden
            primaryImageInput.value = index;

            // Quitar selección de todas
            document.querySelectorAll('.primary-image-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Agregar selección a la seleccionada
            const selectedOption = document.querySelector(`.primary-image-option[data-index="${index}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }

            // Quitar error si existía
            primaryImageGrid.classList.remove('has-error');
            primaryImageError.style.display = 'none';

            // Marcar cambio en formulario
            formChanged = true;
        }

        function clearPrimaryImageSelection() {
            primaryImageInput.value = '';
            document.querySelectorAll('.primary-image-option').forEach(opt => {
                opt.classList.remove('selected');
            });
        }

        function validatePrimaryImage() {
            if (selectedFiles.length > 0 && primaryImageInput.value === '') {
                primaryImageGrid.classList.add('has-error');
                primaryImageError.style.display = 'block';
                return false;
            }
            return true;
        }

        // ============================================
        // FUNCIONALIDAD DEL DROPZONE MULTIPLE MEJORADO
        // ============================================

        // Función para limpiar todo el contenido anterior
        function clearPreviousContent() {
            imagesGrid.innerHTML = '';
            filesSummary.style.display = 'none';

            // Liberar URLs de objetos
            currentObjectURLs.forEach(url => URL.revokeObjectURL(url));
            currentObjectURLs = [];
            selectedFiles = [];
            validationResults = [];

            dropzone.classList.remove('border-danger');

            // Eliminar todos los mensajes de error
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());
        }

        // Función para mostrar toast
        function showToast(message, type = 'info') {
            toastMessage.textContent = message;
            appleToast.classList.add('show');

            setTimeout(() => {
                appleToast.classList.remove('show');
            }, 3000);
        }

        // Función para crear card de imagen con análisis
        function createImageCard(file, validationResult, index, dimensions = null) {
            const card = document.createElement('div');
            card.className = 'image-analysis-card fade-in';
            card.dataset.index = index;

            // Preview container
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-card-preview';

            if (validationResult.type === 'embroidery') {
                previewDiv.innerHTML = `
                    <div class="embroidery-preview">
                        <i class="fas fa-vest"></i>
                        <span class="format-name">${validationResult.subtype.toUpperCase()}</span>
                    </div>
                `;
            } else if (validationResult.type === 'vector') {
                const objectURL = URL.createObjectURL(file);
                currentObjectURLs.push(objectURL);
                previewDiv.innerHTML = `<img src="${objectURL}" alt="Vista previa SVG">`;
                previewDiv.classList.add('svg-preview');
            } else {
                const objectURL = URL.createObjectURL(file);
                currentObjectURLs.push(objectURL);
                const img = document.createElement('img');
                img.src = objectURL;
                img.alt = "Vista previa";
                img.onerror = () => {
                    previewDiv.innerHTML = `
                        <div style="text-align: center; color: #666; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%;">
                            <i class="fas fa-file-image" style="font-size: 24px; margin-bottom: 5px;"></i>
                            <div style="font-size: 9px;">No disponible</div>
                        </div>
                    `;
                };
                previewDiv.appendChild(img);
            }

            // Botón de eliminar
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'image-card-remove';
            removeBtn.innerHTML = '×';
            removeBtn.title = 'Eliminar imagen';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                removeFile(index);
            });
            previewDiv.appendChild(removeBtn);

            // Info del análisis
            const infoDiv = document.createElement('div');
            infoDiv.className = 'image-card-info';

            const fileSize = (file.size / 1024).toFixed(1);
            const originalExtension = file.name.toLowerCase().split('.').pop();
            const detectedFormat = validationResult.subtype || originalExtension;
            let fileTypeName = '';

            switch (validationResult.type) {
                case 'image': fileTypeName = 'Imagen'; break;
                case 'vector': fileTypeName = 'Vector'; break;
                case 'embroidery': fileTypeName = 'Bordado'; break;
                default: fileTypeName = 'Archivo';
            }

            // Verificar si hay discrepancia de extensión
            let warningHTML = '';
            if (validationResult.detectedBy === 'signature' &&
                validationResult.subtype &&
                originalExtension !== validationResult.subtype.toLowerCase()) {
                warningHTML = `
                    <div class="image-card-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        Extensión .${originalExtension} → formato ${validationResult.subtype.toUpperCase()}
                    </div>
                `;
            }

            // Dimensiones de la imagen
            let dimensionsHTML = '';
            if (dimensions && dimensions.width && dimensions.height) {
                dimensionsHTML = `
                    <div class="image-card-dimensions">
                        <span class="dim-label">Dimensiones:</span>
                        ${dimensions.width} × ${dimensions.height} px
                    </div>
                `;
            } else {
                // Placeholder mientras se carga
                dimensionsHTML = `
                    <div class="image-card-dimensions" id="dimensions-${index}">
                        <span class="dim-label">Dimensiones:</span>
                        <span class="text-muted">Calculando...</span>
                    </div>
                `;
            }

            infoDiv.innerHTML = `
                <div class="image-card-name" title="${file.name}">
                    <i class="fas fa-${fileValidator.getFileIcon(detectedFormat)} mr-1"></i>
                    ${file.name}
                </div>
                <div class="image-card-details">
                    <span>${fileTypeName} (${detectedFormat.toUpperCase()})</span>
                    <span>${fileSize} KB</span>
                </div>
                ${dimensionsHTML}
                <div class="image-card-format">
                    <i class="fas fa-check-circle"></i>
                    Formato detectado: ${detectedFormat.toUpperCase()}
                </div>
                ${warningHTML}
            `;

            card.appendChild(previewDiv);
            card.appendChild(infoDiv);

            return card;
        }

        // Función para obtener dimensiones de una imagen
        function getImageDimensions(file) {
            return new Promise((resolve) => {
                if (!file.type.startsWith('image/')) {
                    resolve({ width: null, height: null });
                    return;
                }

                const img = new Image();
                const objectURL = URL.createObjectURL(file);

                img.onload = () => {
                    URL.revokeObjectURL(objectURL);
                    resolve({ width: img.naturalWidth, height: img.naturalHeight });
                };

                img.onerror = () => {
                    URL.revokeObjectURL(objectURL);
                    resolve({ width: null, height: null });
                };

                img.src = objectURL;
            });
        }

        // Almacena las dimensiones de las imágenes
        let imageDimensions = [];

        // Función para renderizar todas las cards
        async function renderImageCards() {
            imagesGrid.innerHTML = '';

            // Obtener dimensiones de todas las imágenes en paralelo
            const dimensionPromises = selectedFiles.map(file => getImageDimensions(file));
            imageDimensions = await Promise.all(dimensionPromises);

            selectedFiles.forEach((file, index) => {
                const card = createImageCard(file, validationResults[index], index, imageDimensions[index]);
                imagesGrid.appendChild(card);
            });

            // Actualizar resumen
            updateFilesSummary();

            // Actualizar select de imagen principal
            updatePrimaryImageSelect();
        }

        // Función para actualizar resumen de archivos
        function updateFilesSummary() {
            if (selectedFiles.length === 0) {
                filesSummary.style.display = 'none';
                return;
            }

            filesSummary.style.display = 'block';

            let totalSize = 0;
            selectedFiles.forEach(file => totalSize += file.size);
            const totalSizeKB = (totalSize / 1024).toFixed(2);
            const fileCount = selectedFiles.length;

            document.getElementById('summaryCount').textContent =
                `${fileCount} archivo${fileCount !== 1 ? 's' : ''} seleccionado${fileCount !== 1 ? 's' : ''}`;
            document.getElementById('summaryTotal').textContent =
                `Total: ${fileCount} imagen${fileCount !== 1 ? 'es' : ''}`;
            document.getElementById('summarySize').textContent =
                `Tamaño total: ${totalSizeKB} KB`;
            document.getElementById('summaryReady').textContent =
                `Listo para subir ${fileCount} archivo${fileCount !== 1 ? 's' : ''}`;
        }

        // Función para eliminar un archivo específico
        function removeFile(index) {
            // Liberar URL del objeto si existe
            if (currentObjectURLs[index]) {
                URL.revokeObjectURL(currentObjectURLs[index]);
            }

            // Eliminar de los arrays
            selectedFiles.splice(index, 1);
            validationResults.splice(index, 1);
            currentObjectURLs.splice(index, 1);
            if (imageDimensions[index]) {
                imageDimensions.splice(index, 1);
            }

            // Re-renderizar
            if (selectedFiles.length > 0) {
                renderImageCards();
            } else {
                clearPreviousContent();
                // Ocultar select de imagen principal
                primaryImageContainer.style.display = 'none';
            }

            // Actualizar estado de cambios
            formChanged = true;
        }

        // Función para mostrar error
        function showImageError(message) {
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());

            dropzone.classList.add('border-danger');
            const error = document.createElement('small');
            error.className = 'text-danger d-block mt-2 image-error';
            error.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${message}`;

            dropzone.parentElement.insertBefore(error, dropzone.nextSibling);

            error.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        // Función para manejar clic en dropzone
        function handleDropzoneClick(e) {
            // Verificar límite de archivos
            if (selectedFiles.length >= 10) {
                showToast('Máximo 10 imágenes permitidas', 'warning');
                return;
            }

            // Abrir selector de archivos
            input.click();
        }

        // Event Listeners para dropzone
        dropzone.addEventListener('click', handleDropzoneClick);

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#2563eb';
            dropzone.style.backgroundColor = '#eff6ff';
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.style.borderColor = '#d1d5db';
            dropzone.style.backgroundColor = 'transparent';
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#d1d5db';
            dropzone.style.backgroundColor = 'transparent';

            if (e.dataTransfer.files.length) {
                const filesArray = Array.from(e.dataTransfer.files);

                // Verificar límite de archivos
                const remainingSlots = 10 - selectedFiles.length;
                const filesToAdd = filesArray.slice(0, remainingSlots);

                if (filesToAdd.length < filesArray.length) {
                    showToast(
                        `Solo se agregaron ${filesToAdd.length} de ${filesArray.length} imágenes (límite: 10)`,
                        'warning');
                }

                // Usar DataTransfer para crear FileList
                const dt = new DataTransfer();
                filesToAdd.forEach(f => dt.items.add(f));
                input.files = dt.files;

                const changeEvent = new Event('change');
                input.dispatchEvent(changeEvent);
            }
        });

        // Evento para cambiar el archivo con validación mejorada
        input.addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            // Calcular cuántos archivos nuevos podemos agregar
            const remainingSlots = 10 - selectedFiles.length;
            const newFiles = Array.from(files).slice(0, remainingSlots);

            if (newFiles.length < files.length) {
                showToast(`Solo se agregaron ${newFiles.length} de ${files.length} imágenes (límite: 10)`,
                    'warning');
            }

            if (newFiles.length === 0) {
                showToast('Ya has alcanzado el límite de 10 imágenes', 'warning');
                return;
            }

            // Quitar errores previos
            dropzone.classList.remove('border-danger');
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());

            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Validando...';
            submitBtn.disabled = true;
            backBtn.classList.add('disabled-btn');
            backBtn.style.pointerEvents = 'none';

            try {
                // Validar cada archivo
                const validationPromises = newFiles.map(file => fileValidator.validateDesignFile(file));
                const newValidationResults = await Promise.all(validationPromises);

                // Verificar si hay errores
                const errors = newValidationResults.filter(result => !result.valid);
                if (errors.length > 0) {
                    showImageError(errors[0].reason);
                    return;
                }

                // Agregar archivos y resultados a las listas
                selectedFiles.push(...newFiles);
                validationResults.push(...newValidationResults);

                // Renderizar cards
                renderImageCards();

                // Mostrar toast de éxito
                showToast(
                    `${newFiles.length} imagen${newFiles.length !== 1 ? 'es' : ''} agregada${newFiles.length !== 1 ? 's' : ''} correctamente`,
                    'success');

                // Marcar que el formulario ha cambiado
                formChanged = true;

            } catch (error) {
                console.error('Error en validación:', error);
                showImageError('Error inesperado al validar los archivos. Intenta con otros archivos.');
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Guardar variante';
                submitBtn.disabled = false;
                backBtn.classList.remove('disabled-btn');
                backBtn.style.pointerEvents = 'auto';
            }
        });

        // ============================================
        // DETECCIÓN DE CAMBIOS EN EL FORMULARIO
        // ============================================
        form.querySelectorAll('input, textarea, select').forEach(el => {
            if (el.type !== 'file') {
                el.addEventListener('change', () => formChanged = true);
                el.addEventListener('input', () => formChanged = true);
            }
        });

        // ============================================
        // FUNCIONES PARA EL SPINNER CON BARRA DE PROGRESO
        // ============================================

        // Función para deshabilitar todos los botones y preparar spinner
        function disableAllButtons() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            submitBtn.classList.add('disabled-btn');

            backBtn.disabled = true;
            backBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Bloqueado';
            backBtn.classList.add('disabled-btn');
            backBtn.style.pointerEvents = 'none';

            // Preparar spinner de carga
            showLoadingState();
        }

        // Función para habilitar todos los botones
        function enableAllButtons() {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Guardar variante';
            submitBtn.classList.remove('disabled-btn');

            backBtn.disabled = false;
            backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Regresar';
            backBtn.classList.remove('disabled-btn');
            backBtn.style.pointerEvents = 'auto';
        }

        /**
         * Muestra el spinner con barra de progreso
         */
        function showLoadingState() {
            // Resetear barra de progreso
            resetProgressBar();

            // Mostrar overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.classList.add('fade-in');
            }

            // Actualizar textos iniciales
            document.getElementById('loadingTitle').textContent = 'Guardando variante';
            document.getElementById('loadingSubtitle').textContent = 'Procesando tu solicitud, por favor espera...';
            document.getElementById('progressStatus').textContent = 'Preparando subida...';

            // Bloquear scroll del body
            document.body.style.overflow = 'hidden';

            // El progreso real viene del evento xhr.upload.onprogress en submitFormWithProgress()
        }

        /**
         * Oculta el spinner
         */
        function hideLoadingState() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
                loadingOverlay.classList.remove('fade-in');
            }

            // Restaurar scroll del body
            document.body.style.overflow = 'auto';
        }

        /**
         * Resetea la barra de progreso a 0%
         */
        function resetProgressBar() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');

            if (progressFill) progressFill.style.width = '0%';
            if (progressText) progressText.textContent = '0%';
            if (progressBar) {
                progressBar.classList.remove('progress-complete', 'progress-error');
            }
        }

        /**
         * Actualiza la barra de progreso
         * @param {number} percentage - Porcentaje de 0 a 100
         * @param {string} status - Texto de estado (opcional)
         */
        function updateProgress(percentage, status = null) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressStatus = document.getElementById('progressStatus');

            // Asegurar que el porcentaje esté entre 0 y 100
            const safePercentage = Math.min(100, Math.max(0, percentage));

            // Actualizar barra visual
            if (progressFill) {
                progressFill.style.width = `${safePercentage}%`;
            }

            // Actualizar texto
            if (progressText) {
                progressText.textContent = `${Math.round(safePercentage)}%`;

                // Cambiar color cuando se complete
                if (safePercentage >= 100) {
                    const progressBar = document.getElementById('progressBar');
                    if (progressBar) {
                        progressBar.classList.add('progress-complete');
                    }
                }
            }

            // Actualizar estado si se proporciona
            if (status && progressStatus) {
                progressStatus.textContent = status;
            }
        }

        /**
         * Muestra estado de error en la barra de progreso
         * @param {string} errorMessage - Mensaje de error
         */
        function showProgressError(errorMessage) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');

            if (progressBar) {
                progressBar.classList.add('progress-error');
            }

            if (progressStatus) {
                progressStatus.textContent = errorMessage;
                progressStatus.style.color = '#dc2626';
            }

            // Actualizar título y subtítulo
            document.getElementById('loadingTitle').textContent = '¡Error!';
            document.getElementById('loadingSubtitle').textContent = 'Hubo un problema al procesar tu solicitud.';

            // Ocultar después de 3 segundos
            setTimeout(() => {
                hideLoadingState();
                enableAllButtons();
                isFormSubmitting = false;
                isSubmitting = false;
            }, 3000);
        }

        /**
         * Envía el formulario via AJAX con progreso real de subida
         */
        function submitFormWithProgress() {
            return new Promise((resolve, reject) => {
                const formData = new FormData(form);

                // Agregar archivos seleccionados al FormData
                // Primero eliminar los archivos existentes (si hay)
                formData.delete('variant_images[]');

                // Agregar todos los archivos seleccionados
                selectedFiles.forEach((file, index) => {
                    formData.append('variant_images[]', file);
                });

                const xhr = new XMLHttpRequest();

                // Evento de progreso de subida (PROGRESO REAL)
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);

                        // Mensajes según el progreso
                        let statusMessage = 'Subiendo imágenes...';
                        if (percentComplete < 30) {
                            statusMessage = 'Subiendo imágenes...';
                        } else if (percentComplete < 60) {
                            statusMessage = 'Procesando archivos...';
                        } else if (percentComplete < 90) {
                            statusMessage = 'Optimizando imágenes...';
                        } else {
                            statusMessage = 'Finalizando subida...';
                        }

                        updateProgress(percentComplete, statusMessage);
                    }
                });

                // Evento cuando la subida se completa (ahora espera respuesta del servidor)
                xhr.upload.addEventListener('load', function() {
                    updateProgress(100, 'Guardando en servidor...');
                });

                // Evento cuando llega la respuesta del servidor
                xhr.addEventListener('load', function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        // Intentar parsear como JSON primero
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                resolve(response);
                            } else {
                                reject({
                                    type: 'validation',
                                    errors: response.errors || {},
                                    message: response.message || 'Error de validación'
                                });
                            }
                        } catch (e) {
                            // Si no es JSON, es una redirección o HTML
                            // Verificar si hay mensaje de éxito en sesión (Laravel redirige)
                            resolve({ success: true, redirect: true });
                        }
                    } else if (xhr.status === 422) {
                        // Error de validación de Laravel
                        try {
                            const response = JSON.parse(xhr.responseText);
                            reject({
                                type: 'validation',
                                errors: response.errors || {},
                                message: 'Error de validación'
                            });
                        } catch (e) {
                            reject({
                                type: 'server',
                                message: 'Error de validación del servidor'
                            });
                        }
                    } else {
                        reject({
                            type: 'server',
                            message: `Error del servidor: ${xhr.status}`
                        });
                    }
                });

                // Evento de error de red
                xhr.addEventListener('error', function() {
                    reject({
                        type: 'network',
                        message: 'Error de conexión. Verifica tu internet.'
                    });
                });

                // Evento de timeout
                xhr.addEventListener('timeout', function() {
                    reject({
                        type: 'timeout',
                        message: 'La solicitud tardó demasiado. Intenta de nuevo.'
                    });
                });

                // Configurar y enviar
                xhr.open('POST', form.action);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.timeout = 120000; // 2 minutos de timeout

                xhr.send(formData);
            });
        }

        /**
         * Muestra errores de validación del servidor
         */
        function showValidationErrors(errors) {
            // Limpiar errores previos
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.server-error').forEach(el => el.remove());

            // Mostrar nuevos errores
            for (const [field, messages] of Object.entries(errors)) {
                const fieldName = field.replace('variant_images.', 'variant_images_');
                const input = document.querySelector(`[name="${field}"]`) ||
                              document.querySelector(`[name="${fieldName}"]`) ||
                              document.getElementById(field);

                if (input) {
                    input.classList.add('is-invalid');

                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-danger small mt-1 server-error';
                    errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${Array.isArray(messages) ? messages[0] : messages}`;

                    input.parentElement.appendChild(errorDiv);
                }
            }

            // Scroll al primer error
            const firstError = document.querySelector('.is-invalid');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstError.focus();
            }
        }

        // ============================================
        // MANEJO DEL FORMULARIO CON AJAX Y PROGRESO REAL
        // ============================================
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (isSubmitting) {
                return;
            }

            // Validar imagen principal si hay imágenes
            if (!validatePrimaryImage()) {
                primaryImageContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                showToast('Debes seleccionar una imagen principal', 'error');
                return;
            }

            isSubmitting = true;
            isFormSubmitting = true;

            // 1. Deshabilitar botones y mostrar spinner
            disableAllButtons();

            try {
                // 2. Enviar formulario con AJAX y progreso real
                const response = await submitFormWithProgress();

                // 3. Mostrar estado de éxito brevemente
                updateProgress(100, '¡Completado!');
                document.getElementById('loadingTitle').textContent = '¡Variante Guardada!';
                document.getElementById('loadingSubtitle').textContent = 'Redirigiendo...';

                // Marcar formulario como no modificado para evitar beforeunload
                formChanged = false;

                // 4. Redirigir rápido (500ms para que el usuario vea el éxito)
                setTimeout(() => {
                    window.location.href = "{{ route('admin.designs.index') }}";
                }, 500);

            } catch (error) {
                console.error('Error en submit:', error);

                // Ocultar spinner
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;

                if (error.type === 'validation') {
                    // Mostrar errores de validación
                    showValidationErrors(error.errors);

                    Swal.fire({
                        icon: 'error',
                        title: 'Error de validación',
                        text: 'Por favor corrige los errores marcados en el formulario.',
                        confirmButtonColor: '#2563eb'
                    });
                } else {
                    // Error de red o servidor
                    Swal.fire({
                        icon: 'error',
                        title: '¡Error!',
                        text: error.message || 'Ocurrió un error al guardar la variante.',
                        confirmButtonColor: '#2563eb'
                    });
                }
            }
        });

        // Manejar el evento beforeunload - SOLO si no estamos usando el botón de regresar
        window.addEventListener('beforeunload', e => {
            // No mostrar el mensaje nativo si está enviando el formulario
            if (isFormSubmitting) {
                return;
            }
            // Para otros casos de navegación (cerrar pestaña, etc)
            // Ya no mostramos el mensaje nativo, el botón de regresar tiene su propio handler
        });

        // Manejar el botón de regresar - CORREGIDO
        backBtn.addEventListener('click', function(e) {
            const backUrl = this.href;

            // Si está enviando el formulario
            if (isSubmitting) {
                e.preventDefault();

                Swal.fire({
                    title: '¿Cancelar operación?',
                    text: 'La variante se está guardando. ¿Estás seguro de que quieres cancelar?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#2563eb',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Sí, cancelar',
                    cancelButtonText: 'Continuar guardando'
                }).then((result) => {
                    if (result.isConfirmed) {
                        isSubmitting = false;
                        isFormSubmitting = false;
                        enableAllButtons();
                        hideLoadingState();
                        window.location.href = backUrl;
                    }
                });
                return;
            }

            // Si hay cambios en el formulario (incluyendo imágenes)
            if (formChanged || selectedFiles.length > 0) {
                e.preventDefault();

                Swal.fire({
                    title: '¿Deseas abandonar el sitio?',
                    text: 'Es posible que los cambios que implementaste no se puedan guardar.',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#6b7280',
                    cancelButtonColor: '#2563eb',
                    confirmButtonText: 'Abandonar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Limpiar estado y redirigir
                        formChanged = false;
                        window.location.href = backUrl;
                    }
                });
            }
            // Si no hay cambios, permitir navegación normal
        });

        // Restaurar estado si hay error de validación del servidor
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;
            }
        });

        // También ocultar spinner cuando se cargue la página normalmente
        window.addEventListener('load', function() {
            setTimeout(() => {
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;
            }, 500);
        });
    </script>

    @if (session('success'))
        <script>
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: "{{ session('success') }}",
                timer: 4000,
                showConfirmButton: false,
                customClass: {
                    popup: 'fade-in'
                }
            });
        </script>
    @endif

    @if (session('error'))
        <script>
            Swal.fire({
                icon: 'error',
                title: '¡Error!',
                text: "{{ session('error') }}",
                showConfirmButton: true,
                confirmButtonColor: '#2563eb',
                customClass: {
                    popup: 'shake'
                }
            });
        </script>
    @endif
@stop
</file>

<file path="resources/views/admin/design-variants/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Variante - ' . str_replace('_', ' ', strtoupper($design->name)))
@section('content_header')
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <h1 class="text-2xl font-weight-semibold text-gray-800">
                Editar Variante <small class="text-muted">{{ str_replace('_', ' ', $variant->sku) }}</small>
            </h1>
            <p class="text-sm text-muted mb-0">
                Diseño: <a href="{{ route('admin.designs.index') }}">{{ $design->name }}</a>
            </p>
        </div>
        <div class="flex gap-2">
            <a id="back-btn" href="{{ route('admin.designs.index') }}" class="btn btn-secondary btn-md px-3">
                <i class="fas fa-arrow-left"></i> Regresar
            </a>
            <button id="submitBtn" form="variant-form" type="submit" class="btn btn-primary btn-md px-3">
                <i class="fas fa-save"></i> Guardar Cambios
            </button>
        </div>
    </div>
@stop

@section('content')
    {{-- ============================================
         SPINNER PREMIUM CON BARRA DE PROGRESO
         ============================================ --}}
    <div class="modal-loading-overlay" id="loadingOverlay">
        <div class="modal-loading-content">
            <div class="modal-loading-spinner"></div>
            <h3 class="modal-loading-title" id="loadingTitle">Actualizando variante</h3>
            <p class="modal-loading-subtitle" id="loadingSubtitle">
                Procesando tu solicitud, por favor espera...
            </p>

            {{-- CONTENEDOR DE BARRA DE PROGRESO --}}
            <div class="progress-container-premium">
                <div class="progress-bar-premium" id="progressBar">
                    <div class="progress-fill-premium" id="progressFill"></div>
                </div>
                <div class="progress-text-container">
                    <span class="progress-text" id="progressText">0%</span>
                    <span class="progress-status" id="progressStatus">Iniciando...</span>
                </div>
            </div>
        </div>
    </div>

    <form id="variant-form" action="{{ route('admin.designs.variants.update', [$design, $variant]) }}" method="POST"
        enctype="multipart/form-data">
        @csrf
        @method('PUT')

        <div class="row">

            {{-- COLUMNA IZQUIERDA: GALERÍA CON SISTEMA PREMIUM --}}
            <div class="col-lg-5">
                <div class="surface">
                    <h5 class="section-title mb-3">
                        <i class="fas fa-images text-primary"></i> Galería de la variante
                    </h5>

                    {{-- DROPZONE COMPACTO PREMIUM --}}
                    <div class="alert alert-info alert-modern mb-3">
                        <i class="fas fa-info-circle"></i>
                        Puedes agregar hasta 10 imágenes nuevas (máx. 10MB c/u) para esta variante.
                    </div>

                    <div id="dropzone" class="dropzone dropzone-compact">
                        <input type="file" id="imageInput" name="variant_images[]" multiple accept="image/*" hidden>

                        {{-- Contenido de la dropzone (texto) --}}
                        <div class="dropzone-content" id="dropzoneContent">
                            <div class="dropzone-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="dropzone-title">Agregar imágenes</div>
                            <div class="dropzone-sub">Arrastra imágenes aquí o haz clic</div>
                            <div class="dropzone-formats">
                                Formatos: JPEG, PNG, SVG, AVIF, WebP, etc.
                            </div>
                        </div>
                    </div>

                    {{-- Resumen de archivos nuevos --}}
                    <div id="filesSummary" class="files-summary" style="display: none;">
                        <div class="summary-header">
                            <i class="fas fa-images text-primary"></i>
                            <span id="summaryCount">0 archivos seleccionados</span>
                        </div>
                        <div class="summary-details">
                            <span id="summaryTotal">Total: 0 imágenes nuevas</span>
                            <span id="summarySize">Tamaño total: 0 KB</span>
                        </div>
                        <div class="summary-status">
                            <i class="fas fa-check-circle text-success"></i>
                            <span id="summaryReady">Listo para subir 0 archivos</span>
                        </div>
                    </div>

                    {{-- Contenedor scrolleable para las imágenes con analizador --}}
                    <div id="imagesScrollContainer" class="images-scroll-container">
                        <div id="imagesGrid" class="images-analysis-grid">
                            {{-- Aquí se agregan las imágenes nuevas con su info --}}
                        </div>
                    </div>

                    {{-- Toast para mensajes --}}
                    <div id="appleToast" class="apple-toast">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="toastMessage" style="font-weight: 500; color: #1d1d1f;"></span>
                    </div>

                    <hr class="my-4">

                    {{-- SELECTOR DE IMAGEN PRINCIPAL (IMÁGENES EXISTENTES) --}}
                    @if ($variant->images->count() > 0)
                        <div class="mb-4">
                            <label class="label">
                                <i class="fas fa-star text-warning"></i> Imagen principal de la variante
                            </label>
                            <small class="hint mt-2">
                                <i class="fas fa-info-circle text-info"></i> Haz clic en una imagen para establecerla como
                                principal.
                            </small>
                            <input type="hidden" id="primary_image_id" name="primary_image_id"
                                value="{{ $variant->images->firstWhere('is_primary', true)?->id ?? $variant->images->first()?->id }}">

                            <div class="primary-image-grid mt-2">
                                @foreach ($variant->images as $image)
                                    <div class="primary-image-option {{ $image->is_primary ? 'selected' : '' }}"
                                        data-image-id="{{ $image->id }}"
                                        onclick="selectExistingPrimaryImage({{ $image->id }})">
                                        <img src="{{ $image->thumbnail_small ? asset('storage/' . $image->thumbnail_small) : asset('storage/' . $image->file_path) }}"
                                            alt="{{ $image->alt_text ?? 'Imagen variante' }}">

                                        <span class="image-number">{{ $loop->iteration }}</span>
                                        <span class="selected-badge"><i class="fas fa-check"></i></span>
                                        <span class="image-name">{{ $image->file_name }}</span>

                                        {{-- Botón eliminar --}}
                                        <button type="button" class="btn-delete-image"
                                            onclick="event.stopPropagation(); confirmDeleteImage('{{ route('admin.designs.variants.images.destroy', [$design, $variant, $image->id]) }}')"
                                            title="Eliminar imagen">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                @endforeach
                            </div>

                        </div>
                        <hr class="my-3">
                    @endif

                </div>
            </div>

            {{-- COLUMNA DERECHA: DATOS - ACTUALIZADO CON SKU IDÉNTICO AL CREATE --}}
            <div class="col-lg-7">
                <div class="surface">
                    <h5 class="section-title mb-4">
                        <i class="fas fa-info-circle text-primary"></i> Información General
                    </h5>

                    {{-- ============================================
                         ACTUALIZADO: Campo de nombre IDÉNTICO al create
                         ============================================ --}}
                    <div class="mb-4">
                        <label class="label">
                            Nombre de la variante <span class="text-danger">*</span>
                        </label>
                        <input type="text" id="variant_name" name="name"
                            class="input @error('name') is-invalid @enderror" value="{{ old('name', $variant->name) }}"
                            placeholder="Ej. Sentado, Edición Especial, etc." required>
                        <div id="name-error" class="text-danger small mt-1" style="display: none;"></div>
                        @error('name')
                            <small class="text-danger">{{ $message }}</small>
                        @enderror
                    </div>

                    {{-- ============================================
                         ACTUALIZADO: Campo SKU EXACTAMENTE IGUAL al create
                         - readonly
                         - tabindex="-1"
                         - Clase sku-readonly
                         - Misma estructura HTML
                         ============================================ --}}
                    <div class="mb-4">
                        <label class="label">SKU (Código único) </label>
                        <input type="text" id="variant_sku" name="sku"
                            class="input sku-readonly @error('sku') is-invalid @enderror" placeholder="SKU_AUTOMATICO"
                            value="{{ old('sku', $variant->sku) }}" readonly tabindex="-1">
                        <div id="sku-error" class="text-danger small mt-1" style="display: none;"></div>
                        {{-- ============================================
                             AGREGADO: Texto de ayuda IDÉNTICO al create
                             ============================================ --}}
                        <small class="hint">Código automático jerárquico profesional</small>
                        @error('sku')
                            <small class="text-danger">{{ $message }}</small>
                        @enderror
                    </div>

                </div>
            </div>
        </div>
    </form>

    {{-- Formulario para eliminar imagen existente --}}
    <form id="deleteImageForm" method="POST" style="display: none;">
        @csrf
        @method('DELETE')
    </form>

    {{-- ============================================
         MODAL DE CONFIRMACIÓN ELIMINAR IMAGEN CON BOTÓN X AZUL PREMIUM
         ============================================ --}}
    <div class="modal fade" id="deleteImageConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 440px;">
            <div class="modal-content modal-delete-apple">

                {{-- Botón Cerrar Flotante - X AZUL PREMIUM --}}
                <div style="position: absolute; top: 15px; right: 15px; z-index: 1060;">
                    <button type="button" class="modal-close-premium" data-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                {{-- Icono de advertencia --}}
                <div class="modal-delete-icon">
                    <div class="icon-wrapper">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>

                {{-- Título --}}
                <h3 class="modal-delete-title">
                    ¿Eliminar esta imagen?
                </h3>

                {{-- Descripción --}}
                <p class="modal-delete-description">
                    Esta acción no se puede deshacer. La imagen será eliminada permanentemente del sistema.
                </p>

                {{-- Botones de acción --}}
                <div class="modal-delete-actions">
                    <button type="button" class="btn-cancel-apple" data-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn-delete-apple" id="confirmDeleteImageBtn">
                        Eliminar imagen
                    </button>
                </div>

            </div>
        </div>
    </div>

@stop

@section('css')
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        /* ============================================
                                                                                       VARIABLES Y ESTILOS BASE DEL PRIMER CÓDIGO
                                                                                       ============================================ */
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 15px;
            --font-size-lg: 17px;
            --font-size-xl: 20px;
        }

        /* ============================================
                                                                                       ESTILOS DE SUPERFICIE Y SECCIONES (DEL PRIMER CÓDIGO)
                                                                                       ============================================ */
        .surface {
            background: #fff;
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-md);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: var(--font-size-base);
        }

        .label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 6px;
            display: block;
            font-size: var(--font-size-base);
        }

        .input {
            width: 100%;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            font-size: var(--font-size-base);
            background: var(--gray-50);
            transition: all 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .is-invalid {
            border-color: var(--danger) !important;
            background: #fef2f2;
        }

        .hint {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            display: block;
            margin-top: 4px;
        }

        /* ============================================
                                                                                       ALERTA MODERNA DEL PRIMER CÓDIGO
                                                                                       ============================================ */
        .alert-modern {
            font-size: var(--font-size-sm);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            border: none;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-modern i {
            margin-top: 2px;
        }

        /* ============================================
                                                                                       AGREGADO: ESTILO PARA SKU READONLY (IDÉNTICO AL CREATE)
                                                                                       ============================================ */
        .sku-readonly {
            background-color: #f1f1f2 !important;
            color: #86868b;
            cursor: not-allowed;
        }

        /* ============================================
                                                                                       ESTILOS EXISTENTES DEL SEGUNDO CÓDIGO (MANTENIDOS)
                                                                                       ============================================ */

        /* SELECTOR VISUAL DE IMAGEN PRINCIPAL */
        .primary-image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 12px;
            margin-bottom: 8px;
        }

        .primary-image-option {
            position: relative;
            border: 3px solid var(--gray-200);
            border-radius: var(--radius-md);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            aspect-ratio: 1;
            background: var(--gray-50);
        }

        .primary-image-option:hover {
            border-color: #93c5fd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }

        .primary-image-option.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2), 0 4px 12px rgba(37, 99, 235, 0.25);
        }

        .primary-image-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .primary-image-option .image-number {
            position: absolute;
            top: 6px;
            left: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
        }

        .primary-image-option .selected-badge {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: var(--primary);
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .primary-image-option.selected .selected-badge {
            transform: translate(-50%, -50%) scale(1);
        }

        .primary-image-option .image-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            color: white;
            font-size: 10px;
            padding: 20px 6px 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .primary-image-option .btn-delete-image {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: 2px solid white;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .primary-image-option:hover .btn-delete-image {
            opacity: 1;
        }

        .primary-image-option .btn-delete-image:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* ============================================
                                                                                       SISTEMA PREMIUM - DROPZONE Y ANALIZADOR
                                                                                       ============================================ */

        /* DROPZONE COMPACTO */
        .dropzone.dropzone-compact {
            min-height: 120px;
            padding: 20px 15px;
        }

        .dropzone.dropzone-compact .dropzone-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .dropzone.dropzone-compact .dropzone-title {
            font-size: 15px;
            margin-bottom: 3px;
        }

        .dropzone.dropzone-compact .dropzone-sub {
            font-size: 12px;
            margin-bottom: 3px;
        }

        .dropzone.dropzone-compact .dropzone-formats {
            font-size: 11px;
            margin-top: 5px;
        }

        .dropzone {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            background: var(--gray-50);
            transition: all .2s;
        }

        .dropzone:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .dropzone-icon {
            font-size: 48px;
            color: var(--gray-400);
            margin-bottom: 15px;
        }

        .dropzone-title {
            font-weight: 600;
            font-size: 18px;
            color: var(--gray-800);
            margin-bottom: 5px;
        }

        .dropzone-sub {
            font-size: 14px;
            color: var(--gray-600);
            margin-bottom: 5px;
        }

        .dropzone-formats {
            font-size: 12px;
            color: var(--gray-400);
            margin-top: 10px;
        }

        /* CONTENEDOR SCROLLEABLE DE IMÁGENES */
        .images-scroll-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            padding-right: 5px;
        }

        .images-scroll-container::-webkit-scrollbar {
            width: 6px;
        }

        .images-scroll-container::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 10px;
        }

        .images-scroll-container::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 10px;
        }

        .images-scroll-container::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        /* GRID DE IMÁGENES CON ANÁLISIS (2 COLUMNAS) */
        .images-analysis-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        /* CARD DE IMAGEN CON ANÁLISIS */
        .image-analysis-card {
            background: #fff;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .image-analysis-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .image-analysis-card.selected {
            border-color: var(--primary);
            border-width: 2px;
        }

        /* Preview de imagen dentro de la card */
        .image-card-preview {
            position: relative;
            width: 100%;
            height: 100px;
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .image-card-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Botón de eliminar para imágenes nuevas */
        .image-card-remove {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: 2px solid white;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .image-card-remove:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Info del análisis */
        .image-card-info {
            padding: 10px;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .image-card-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-800);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 4px;
        }

        .image-card-details {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .image-card-format {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--success);
            font-weight: 500;
        }

        .image-card-format i {
            font-size: 10px;
        }

        /* Alerta de extensión diferente */
        .image-card-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 6px;
            padding: 6px 8px;
            margin-top: 6px;
            font-size: 9px;
            color: #92400e;
        }

        .image-card-warning i {
            color: var(--warning);
            margin-right: 3px;
        }

        /* Resumen de archivos */
        .files-summary {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: 12px 14px;
            margin-top: 12px;
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 6px;
        }

        .summary-details {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--gray-600);
            margin-bottom: 6px;
        }

        .summary-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--success);
            font-weight: 500;
        }

        /* Para archivos de bordado */
        .embroidery-preview {
            background: linear-gradient(45deg, #1e40af, var(--primary));
            color: white;
            text-align: center;
            padding: 15px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .embroidery-preview i {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .embroidery-preview .format-name {
            font-size: 11px;
            font-weight: 600;
        }

        /* Para SVGs */
        .svg-preview {
            background: white;
            padding: 10px;
        }

        /* Toast */
        .apple-toast {
            position: fixed;
            top: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 16px 24px;
            border-radius: 20px;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            z-index: 9999;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .apple-toast.show {
            transform: translateX(0);
        }

        /* Dropzone con error */
        .dropzone.border-danger {
            border-color: var(--danger) !important;
            background: #fef2f2;
        }

        /* ============================================
                                                                                       ESTILOS DEL SPINNER PREMIUM
                                                                                       ============================================ */
        .modal-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .modal-loading-content {
            text-align: center;
            padding: 40px;
            max-width: 320px;
        }

        .modal-loading-spinner {
            width: 64px;
            height: 64px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }

        .modal-loading-subtitle {
            font-size: 0.95rem;
            color: var(--gray-600);
            line-height: 1.5;
        }

        /* ============================================
                                                                                       BARRA DE PROGRESO PREMIUM
                                                                                       ============================================ */
        .progress-container-premium {
            width: 100%;
            max-width: 320px;
            margin: 24px auto 0;
        }

        .progress-bar-premium {
            width: 100%;
            height: 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        .progress-fill-premium {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,
                    var(--primary) 0%,
                    #3b82f6 25%,
                    #60a5fa 50%,
                    #93c5fd 75%,
                    #bfdbfe 100%);
            border-radius: 10px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
        }

        /* Efecto de brillo animado */
        .progress-fill-premium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    transparent 100%);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Texto de progreso */
        .progress-text-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .progress-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary);
            text-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
            min-width: 60px;
        }

        .progress-status {
            font-size: 0.95rem;
            color: var(--gray-600);
            font-weight: 500;
            text-align: right;
            flex: 1;
            padding-left: 16px;
        }

        /* Estados de completado */
        .progress-complete .progress-fill-premium {
            background: linear-gradient(90deg,
                    var(--success) 0%,
                    #10b981 25%,
                    #34d399 50%,
                    #6ee7b7 75%,
                    #a7f3d0 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .progress-complete .progress-text {
            color: var(--success);
        }

        /* Estados de error */
        .progress-error .progress-fill-premium {
            background: linear-gradient(90deg,
                    var(--danger) 0%,
                    #ef4444 25%,
                    #f87171 50%,
                    #fca5a5 75%,
                    #fecaca 100%);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .progress-error .progress-text {
            color: var(--danger);
        }

        /* Animación fade-in */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Estilos para botones deshabilitados */
        .disabled-btn {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Estilos para mensajes de error */
        .image-error {
            font-size: 12px;
            color: var(--danger);
            margin-top: 8px;
            display: block;
        }

        /* Estilos para Select2 personalizados */
        .select2-container--default .select2-selection--single,
        .select2-container--default .select2-selection--multiple {
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            background: var(--gray-50);
            padding: 8px;
            min-height: 48px;
        }

        .select2-container--default .select2-selection--single:focus,
        .select2-container--default .select2-selection--multiple:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* ============================================
                                                                                       ESTILOS PARA SWEETALERT PREMIUM TIPO APPLE
                                                                                       ============================================ */
        .apple-sweet-alert {
            border-radius: 20px !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            background: #fff !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
        }

        .apple-sweet-alert-title {
            font-size: 22px !important;
            font-weight: 700 !important;
            color: #1d1d1f !important;
            margin-bottom: 10px !important;
            letter-spacing: -0.3px !important;
        }

        .apple-sweet-alert-html {
            font-size: 15px !important;
            color: #86868b !important;
            line-height: 1.5 !important;
        }

        .apple-sweet-alert-actions {
            margin-top: 30px !important;
            gap: 12px !important;
            justify-content: center !important;
        }

        .apple-sweet-alert-confirm-btn {
            background: linear-gradient(135deg, #dc2626, #ef4444) !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 14px 28px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            color: white !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.2) !important;
            min-width: 180px !important;
        }

        .apple-sweet-alert-confirm-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.3) !important;
            background: linear-gradient(135deg, #ef4444, #f87171) !important;
        }

        .apple-sweet-alert-confirm-btn:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 10px rgba(220, 38, 38, 0.2) !important;
        }

        .apple-sweet-alert-cancel-btn {
            background: #f1f1f2 !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 12px !important;
            padding: 14px 28px !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            color: #374151 !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            min-width: 120px !important;
        }

        .apple-sweet-alert-cancel-btn:hover {
            background: #e5e7eb !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05) !important;
        }

        .apple-sweet-alert-cancel-btn:active {
            transform: translateY(0) !important;
            box-shadow: 0 1px 5px rgba(0, 0, 0, 0.05) !important;
        }

        /* Animaciones para SweetAlert */
        .animate__animated {
            animation-duration: 0.3s !important;
        }

        .animate__faster {
            animation-duration: 0.2s !important;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translate3d(0, -20px, 0);
            }

            to {
                opacity: 1;
                transform: translate3d(0, 0, 0);
            }
        }

        @keyframes fadeOutUp {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
                transform: translate3d(0, -20px, 0);
            }
        }

        .animate__fadeInDown {
            animation-name: fadeInDown;
        }

        .animate__fadeOutUp {
            animation-name: fadeOutUp;
        }

        /* ============================================
                       ESTILOS DEL BOTÓN X AZUL PREMIUM (MODAL-CLOSE-PREMIUM)
                       ============================================ */
        .modal-close-premium {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 45px;
            height: 45px;
            background: #2563eb;
            border: 2px solid #fff;
            border-radius: 50%;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1070;
        }

        .modal-close-premium:hover {
            background: #1d4ed8;
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5);
        }

        /* ============================================
                       ESTILOS DEL MODAL DE CONFIRMACIÓN ELIMINAR IMAGEN
                       ============================================ */
        .modal-delete-apple {
            border-radius: 24px;
            border: none;
            padding: 32px 28px 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25),
                0 0 1px rgba(0, 0, 0, 0.1);
            background: #ffffff;
        }

        .modal-delete-icon {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .modal-delete-icon .icon-wrapper {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(252, 211, 77, 0.3);
        }

        .modal-delete-icon i {
            font-size: 28px;
            color: #d97706;
        }

        .modal-delete-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: -0.5px;
            line-height: 1.3;
        }

        .modal-delete-description {
            font-size: 0.95rem;
            color: #6b7280;
            text-align: center;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .modal-delete-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }

        .btn-cancel-apple {
            background: #f3f4f6;
            border: 1.5px solid #e5e7eb;
            color: #374151;
            font-weight: 600;
            font-size: 1rem;
            padding: 14px 24px;
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            letter-spacing: 0.2px;
        }

        .btn-cancel-apple:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
            transform: translateY(-1px);
        }

        .btn-delete-apple {
            background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%);
            border: none;
            color: #ffffff;
            font-weight: 600;
            font-size: 1rem;
            padding: 14px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.25);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .btn-delete-apple:hover {
            background: linear-gradient(180deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.3);
        }

        .btn-delete-apple.loading {
            position: relative;
            color: transparent;
        }

        .btn-delete-apple.loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Responsive */
        @media (max-width: 991px) {
            .dropzone {
                min-height: 250px;
            }

            .dropzone-title {
                font-size: 16px;
            }
        }

        @media (max-width: 576px) {
            .images-analysis-grid {
                grid-template-columns: 1fr;
            }

            .primary-image-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
@stop

@section('js')
    {{-- Primero asegurar que jQuery esté cargado --}}
    <script>
        if (typeof jQuery === 'undefined') {
            document.write('<script src="https://code.jquery.com/jquery-3.6.0.min.js"><\/script>');
        }
    </script>

    {{-- Luego cargar Select2 --}}
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
        // ============================================
        // DECLARACIONES INICIALES
        // ============================================
        const dropzone = document.getElementById('dropzone');
        const input = document.getElementById('imageInput');
        const imagesGrid = document.getElementById('imagesGrid');
        const imagesScrollContainer = document.getElementById('imagesScrollContainer');
        const filesSummary = document.getElementById('filesSummary');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('variant-form');
        const backBtn = document.getElementById('back-btn');
        const appleToast = document.getElementById('appleToast');
        const toastMessage = document.getElementById('toastMessage');
        const designBaseName = "{{ $design->name }}";
        const nameInput = document.getElementById('variant_name');
        const skuInput = document.getElementById('variant_sku');

        let isSubmitting = false;
        let currentObjectURLs = [];
        let selectedFiles = []; // Solo para nuevas imágenes
        let validationResults = [];
        let formChanged = false;
        let isFormSubmitting = false;

        // ============================================
        // VALIDADOR MEJORADO DE ARCHIVOS DE DISEÑO
        // ============================================
        class DesignFileValidator {
            constructor() {
                this.allowedExtensions = [
                    'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'tiff',
                    'svg', 'svgz',
                    'pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv', 'csd', '10o', 'bro'
                ];

                this.maxSizes = {
                    'image': 10 * 1024 * 1024,
                    'vector': 5 * 1024 * 1024,
                    'embroidery': 50 * 1024 * 1024
                };
            }

            async getFileBytes(file, bytes = 64) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = (e) => {
                        try {
                            const arr = new Uint8Array(e.target.result);
                            resolve(arr);
                        } catch (error) {
                            resolve(new Uint8Array());
                        }
                    };
                    reader.onerror = () => resolve(new Uint8Array());
                    const slice = file.slice(0, bytes);
                    reader.readAsArrayBuffer(slice);
                });
            }

            async detectFileTypeByContent(file) {
                const bytes = await this.getFileBytes(file, 64);
                if (bytes.length === 0) return null;

                let hexHeader = '';
                for (let i = 0; i < bytes.length; i++) {
                    hexHeader += bytes[i].toString(16).padStart(2, '0');
                }

                const signatures = {
                    'jpeg': [
                        'ffd8ffe0', 'ffd8ffe1', 'ffd8ffe2', 'ffd8ffe3',
                        'ffd8ffe8', 'ffd8ffdb', 'ffd8ffee'
                    ],
                    'png': ['89504e470d0a1a0a'],
                    'gif': ['474946383761', '474946383961'],
                    'bmp': ['424d'],
                    'webp': ['52494646'],
                    'tiff': ['49492a00', '4d4d002a'],
                    'svg': ['3c737667', '3c3f786d6c', '3c21444f4354595045'],
                    'pes': ['23504553', '50455330', '43455031'],
                    'dst': ['4154414a494d41', '4c414a494d41'],
                    'exp': ['45787031', '45787032'],
                    'xxx': ['585858', '53494e474552'],
                    'jef': ['4a4546', '4a454631'],
                    'vp3': ['567033', '4856534d'],
                    'hus': ['4846475631', '4846475632'],
                    'pec': ['504543', '50454330', '43455031'],
                    'phc': ['504843', '43455031'],
                    'sew': ['534557', '53455730'],
                    'shv': ['534856', '53485630'],
                    'csd': ['436865727279'],
                    '10o': ['31306f'],
                    'bro': ['42524f']
                };

                if (hexHeader.startsWith('52494646')) {
                    const webpBytes = await this.getFileBytes(file, 16);
                    if (webpBytes.length >= 12) {
                        const webpCheck = String.fromCharCode(webpBytes[8], webpBytes[9], webpBytes[10], webpBytes[11]);
                        if (webpCheck === 'WEBP') {
                            return 'webp';
                        }
                    }
                }

                if (hexHeader.startsWith('0000001') || hexHeader.startsWith('0000002')) {
                    const avifBytes = await this.getFileBytes(file, 12);
                    if (avifBytes.length >= 12) {
                        const ftypPos = String.fromCharCode(avifBytes[4], avifBytes[5], avifBytes[6], avifBytes[7]);
                        const brand = String.fromCharCode(avifBytes[8], avifBytes[9], avifBytes[10], avifBytes[11]);
                        if (ftypPos === 'ftyp' && (brand === 'avif' || brand === 'avis' || brand === 'mif1')) {
                            return 'avif';
                        }
                    }
                }

                for (const [type, sigs] of Object.entries(signatures)) {
                    for (const sig of sigs) {
                        if (hexHeader.startsWith(sig)) {
                            if (type === 'svg') {
                                const isSvg = await this.validateSVGContent(file);
                                if (isSvg) return 'svg';
                            } else {
                                return type;
                            }
                        }
                    }
                }

                return null;
            }

            async validateSVGContent(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = (e) => {
                        try {
                            const content = e.target.result;
                            const hasSvgTag = content.includes('<svg') || content.includes('<SVG');
                            resolve(hasSvgTag);
                        } catch (error) {
                            resolve(false);
                        }
                    };
                    reader.onerror = () => resolve(false);
                    reader.readAsText(file.slice(0, 2048));
                });
            }

            getFileCategory(fileType) {
                const imageTypes = ['jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'tiff'];
                const vectorTypes = ['svg'];
                const embroideryTypes = ['pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv',
                    'csd', '10o', 'bro'
                ];

                if (imageTypes.includes(fileType)) return 'image';
                if (vectorTypes.includes(fileType)) return 'vector';
                if (embroideryTypes.includes(fileType)) return 'embroidery';

                return 'unknown';
            }

            async validateDesignFile(file) {
                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();

                const detectedType = await this.detectFileTypeByContent(file);

                if (!detectedType) {
                    if (this.allowedExtensions.includes(fileExtension)) {
                        return {
                            valid: true,
                            type: this.getFileCategory(fileExtension),
                            subtype: fileExtension,
                            detectedBy: 'extension',
                            reason: `Archivo aceptado por extensión (.${fileExtension})`
                        };
                    }
                    return {
                        valid: false,
                        reason: 'Formato de archivo no reconocido. Asegúrate de subir una imagen, SVG o archivo de bordado válido.'
                    };
                }

                const category = this.getFileCategory(detectedType);

                const sizeValidation = this.validateFileSize(file, category);
                if (!sizeValidation.valid) {
                    return sizeValidation;
                }

                let reason = '';
                if (detectedType !== fileExtension) {
                    reason =
                        `Formato detectado: ${detectedType.toUpperCase()} (archivo con extensión .${fileExtension})`;
                } else {
                    reason = `Archivo ${detectedType.toUpperCase()} válido`;
                }

                return {
                    valid: true,
                    type: category,
                    subtype: detectedType,
                    detectedBy: 'signature',
                    reason: reason,
                    actualExtension: fileExtension
                };
            }

            validateFileSize(file, category) {
                const maxSize = this.maxSizes[category] || 10 * 1024 * 1024;

                if (file.size > maxSize) {
                    const sizeMB = (maxSize / (1024 * 1024)).toFixed(1);
                    let fileTypeName = '';
                    switch (category) {
                        case 'image':
                            fileTypeName = 'imágenes';
                            break;
                        case 'vector':
                            fileTypeName = 'SVG';
                            break;
                        case 'embroidery':
                            fileTypeName = 'archivos de bordado';
                            break;
                        default:
                            fileTypeName = 'archivos';
                    }
                    return {
                        valid: false,
                        reason: `El archivo es demasiado grande. Máximo ${sizeMB}MB para ${fileTypeName}.`
                    };
                }
                return {
                    valid: true,
                    reason: 'Tamaño válido'
                };
            }

            getFileIcon(fileType) {
                const icons = {
                    'image': 'image',
                    'vector': 'vector-square',
                    'embroidery': 'vest',
                    'jpeg': 'file-image',
                    'png': 'file-image',
                    'gif': 'file-image',
                    'bmp': 'file-image',
                    'webp': 'file-image',
                    'avif': 'file-image',
                    'svg': 'vector-square',
                    'pes': 'vest',
                    'dst': 'vest',
                    'default': 'file'
                };

                return icons[fileType] || icons['default'];
            }
        }

        // Instanciar el validador
        const fileValidator = new DesignFileValidator();

        // ============================================
        // AGREGADO: GENERACIÓN DE SKU IDÉNTICA AL CREATE
        // ============================================
        function updateSku() {
            let skuBase = designBaseName;
            let userValue = nameInput.value.trim();

            if (userValue) {
                skuBase += " " + userValue;
            }

            skuInput.value = skuBase
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/\s+/g, '_')
                .replace(/[^a-zA-Z0-9_]/g, '')
                .toUpperCase();
        }

        // ============================================
        // INICIALIZACIÓN SELECT2 (con jQuery seguro)
        // ============================================
        function initializeSelect2() {
            // Esperar a que jQuery esté disponible
            if (typeof jQuery === 'undefined') {
                setTimeout(initializeSelect2, 50);
                return;
            }

            $(document).ready(function() {
                $('.select2').select2({
                    width: '100%',
                    placeholder: 'Selecciona una opción',
                    allowClear: true
                });

                // AGREGADO: Inicializar SKU al cargar la página
                updateSku();
            });
        }

        // Inicializar Select2 cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeSelect2);
        } else {
            initializeSelect2();
        }

        // ============================================
        // AGREGADO: EVENTO PARA ACTUALIZAR SKU AL ESCRIBIR
        // ============================================
        nameInput.addEventListener('input', updateSku);

        // ============================================
        // FUNCIONALIDAD DEL DROPZONE PREMIUM
        // ============================================

        // Función para limpiar todo el contenido anterior
        function clearPreviousContent() {
            imagesGrid.innerHTML = '';
            filesSummary.style.display = 'none';

            // Liberar URLs de objetos
            currentObjectURLs.forEach(url => URL.revokeObjectURL(url));
            currentObjectURLs = [];
            selectedFiles = [];
            validationResults = [];

            dropzone.classList.remove('border-danger');

            // Eliminar todos los mensajes de error
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());
        }

        // Función para mostrar toast
        function showToast(message, type = 'info') {
            toastMessage.textContent = message;
            appleToast.classList.add('show');

            setTimeout(() => {
                appleToast.classList.remove('show');
            }, 3000);
        }

        // Función para crear card de imagen con análisis
        function createImageCard(file, validationResult, index) {
            const card = document.createElement('div');
            card.className = 'image-analysis-card fade-in';
            card.dataset.index = index;

            // Preview container
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-card-preview';

            if (validationResult.type === 'embroidery') {
                previewDiv.innerHTML = `
                <div class="embroidery-preview">
                    <i class="fas fa-vest"></i>
                    <span class="format-name">${validationResult.subtype.toUpperCase()}</span>
                </div>
            `;
            } else if (validationResult.type === 'vector') {
                const objectURL = URL.createObjectURL(file);
                currentObjectURLs.push(objectURL);
                previewDiv.innerHTML = `<img src="${objectURL}" alt="Vista previa SVG">`;
                previewDiv.classList.add('svg-preview');
            } else {
                const objectURL = URL.createObjectURL(file);
                currentObjectURLs.push(objectURL);
                const img = document.createElement('img');
                img.src = objectURL;
                img.alt = "Vista previa";
                img.onerror = () => {
                    previewDiv.innerHTML = `
                    <div style="text-align: center; color: #666; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%;">
                        <i class="fas fa-file-image" style="font-size: 24px; margin-bottom: 5px;"></i>
                        <div style="font-size: 9px;">No disponible</div>
                    </div>
                `;
                };
                previewDiv.appendChild(img);
            }

            // Botón de eliminar (solo para nuevas imágenes)
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'image-card-remove';
            removeBtn.innerHTML = '×';
            removeBtn.title = 'Eliminar imagen';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                removeFile(index);
            });
            previewDiv.appendChild(removeBtn);

            // Info del análisis
            const infoDiv = document.createElement('div');
            infoDiv.className = 'image-card-info';

            const fileSize = (file.size / 1024).toFixed(1);
            const originalExtension = file.name.toLowerCase().split('.').pop();
            const detectedFormat = validationResult.subtype || originalExtension;
            let fileTypeName = '';

            switch (validationResult.type) {
                case 'image':
                    fileTypeName = 'Imagen';
                    break;
                case 'vector':
                    fileTypeName = 'Vector';
                    break;
                case 'embroidery':
                    fileTypeName = 'Bordado';
                    break;
                default:
                    fileTypeName = 'Archivo';
            }

            // Verificar si hay discrepancia de extensión
            let warningHTML = '';
            if (validationResult.detectedBy === 'signature' &&
                validationResult.subtype &&
                originalExtension !== validationResult.subtype.toLowerCase()) {
                warningHTML = `
                <div class="image-card-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    Extensión .${originalExtension} → formato ${validationResult.subtype.toUpperCase()}
                </div>
            `;
            }

            infoDiv.innerHTML = `
            <div class="image-card-name" title="${file.name}">
                <i class="fas fa-${fileValidator.getFileIcon(detectedFormat)} mr-1"></i>
                ${file.name}
            </div>
            <div class="image-card-details">
                <span>${fileTypeName} (${detectedFormat.toUpperCase()})</span>
                <span>${fileSize} KB</span>
            </div>
            <div class="image-card-format">
                <i class="fas fa-check-circle"></i>
                Formato detectado: ${detectedFormat.toUpperCase()}
            </div>
            ${warningHTML}
        `;

            card.appendChild(previewDiv);
            card.appendChild(infoDiv);

            return card;
        }

        // Función para renderizar todas las cards
        function renderImageCards() {
            imagesGrid.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const card = createImageCard(file, validationResults[index], index);
                imagesGrid.appendChild(card);
            });

            // Actualizar resumen
            updateFilesSummary();
        }

        // Función para actualizar resumen de archivos
        function updateFilesSummary() {
            if (selectedFiles.length === 0) {
                filesSummary.style.display = 'none';
                return;
            }

            filesSummary.style.display = 'block';

            let totalSize = 0;
            selectedFiles.forEach(file => totalSize += file.size);
            const totalSizeKB = (totalSize / 1024).toFixed(2);
            const fileCount = selectedFiles.length;

            document.getElementById('summaryCount').textContent =
                `${fileCount} archivo${fileCount !== 1 ? 's' : ''} seleccionado${fileCount !== 1 ? 's' : ''}`;
            document.getElementById('summaryTotal').textContent =
                `Total: ${fileCount} imagen${fileCount !== 1 ? 'es' : ''} nuevas`;
            document.getElementById('summarySize').textContent =
                `Tamaño total: ${totalSizeKB} KB`;
            document.getElementById('summaryReady').textContent =
                `Listo para subir ${fileCount} archivo${fileCount !== 1 ? 's' : ''}`;
        }

        // Función para eliminar un archivo específico (solo nuevas imágenes)
        function removeFile(index) {
            // Liberar URL del objeto si existe
            if (currentObjectURLs[index]) {
                URL.revokeObjectURL(currentObjectURLs[index]);
            }

            // Eliminar de los arrays
            selectedFiles.splice(index, 1);
            validationResults.splice(index, 1);
            currentObjectURLs.splice(index, 1);

            // Re-renderizar
            if (selectedFiles.length > 0) {
                renderImageCards();
            } else {
                clearPreviousContent();
            }

            // Actualizar estado de cambios
            formChanged = true;
        }

        // Función para mostrar error
        function showImageError(message) {
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());

            dropzone.classList.add('border-danger');
            const error = document.createElement('small');
            error.className = 'text-danger d-block mt-2 image-error';
            error.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${message}`;

            dropzone.parentElement.insertBefore(error, dropzone.nextSibling);

            error.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        // Función para manejar clic en dropzone
        function handleDropzoneClick(e) {
            // Verificar límite de archivos (10 imágenes nuevas)
            if (selectedFiles.length >= 10) {
                showToast('Máximo 10 imágenes nuevas permitidas', 'warning');
                return;
            }

            // Abrir selector de archivos
            input.click();
        }

        // ============================================
        // EVENT LISTENERS PARA DROPZONE PREMIUM
        // ============================================

        // Event Listeners para dropzone
        dropzone.addEventListener('click', handleDropzoneClick);

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#2563eb';
            dropzone.style.backgroundColor = '#eff6ff';
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.style.borderColor = '#d1d5db';
            dropzone.style.backgroundColor = 'transparent';
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#d1d5db';
            dropzone.style.backgroundColor = 'transparent';

            if (e.dataTransfer.files.length) {
                const filesArray = Array.from(e.dataTransfer.files);

                // Verificar límite de archivos
                const remainingSlots = 10 - selectedFiles.length;
                const filesToAdd = filesArray.slice(0, remainingSlots);

                if (filesToAdd.length < filesArray.length) {
                    showToast(
                        `Solo se agregaron ${filesToAdd.length} de ${filesArray.length} imágenes (límite: 10)`,
                        'warning');
                }

                // Usar DataTransfer para crear FileList
                const dt = new DataTransfer();
                filesToAdd.forEach(f => dt.items.add(f));
                input.files = dt.files;

                const changeEvent = new Event('change');
                input.dispatchEvent(changeEvent);
            }
        });

        // Evento para cambiar el archivo con validación mejorada
        input.addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            // Calcular cuántos archivos nuevos podemos agregar
            const remainingSlots = 10 - selectedFiles.length;
            const newFiles = Array.from(files).slice(0, remainingSlots);

            if (newFiles.length < files.length) {
                showToast(`Solo se agregaron ${newFiles.length} de ${files.length} imágenes (límite: 10)`,
                    'warning');
            }

            if (newFiles.length === 0) {
                showToast('Ya has alcanzado el límite de 10 imágenes nuevas', 'warning');
                return;
            }

            // Quitar errores previos
            dropzone.classList.remove('border-danger');
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());

            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Validando...';
            submitBtn.disabled = true;
            backBtn.classList.add('disabled-btn');
            backBtn.style.pointerEvents = 'none';

            try {
                // Validar cada archivo
                const validationPromises = newFiles.map(file => fileValidator.validateDesignFile(file));
                const newValidationResults = await Promise.all(validationPromises);

                // Verificar si hay errores
                const errors = newValidationResults.filter(result => !result.valid);
                if (errors.length > 0) {
                    showImageError(errors[0].reason);
                    return;
                }

                // Agregar archivos y resultados a las listas
                selectedFiles.push(...newFiles);
                validationResults.push(...newValidationResults);

                // Renderizar cards
                renderImageCards();

                // Mostrar toast de éxito
                showToast(
                    `${newFiles.length} imagen${newFiles.length !== 1 ? 'es' : ''} agregada${newFiles.length !== 1 ? 's' : ''} correctamente`,
                    'success');

                // Marcar que el formulario ha cambiado
                formChanged = true;

            } catch (error) {
                console.error('Error en validación:', error);
                showImageError('Error inesperado al validar los archivos. Intenta con otros archivos.');
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
                submitBtn.disabled = false;
                backBtn.classList.remove('disabled-btn');
                backBtn.style.pointerEvents = 'auto';
            }
        });

        // ============================================
        // FUNCIONES DE VALIDACIÓN SIMILARES AL CREATE
        // ============================================

        // Función para mostrar error en un campo específico
        function showFieldError(field, message) {
            field.classList.add('is-invalid');

            // Buscar el div de error por ID del campo
            const fieldName = field.getAttribute('name');
            let errorElement = document.getElementById(fieldName + '-error');

            if (errorElement) {
                errorElement.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${message}`;
                errorElement.style.display = 'block';
            }
        }

        // Función para limpiar todos los errores de validación
        function clearValidationErrors() {
            // Limpiar errores de campos (clases is-invalid)
            form.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });

            // Limpiar errores de los divs con ID (name-error, sku-error, etc.)
            document.querySelectorAll('[id$="-error"]').forEach(el => {
                el.style.display = 'none';
                el.innerHTML = '';
            });

            // Limpiar errores del dropzone
            dropzone.classList.remove('border-danger');
            const imageErrors = document.querySelectorAll('.image-error');
            imageErrors.forEach(error => error.remove());
        }

        // ============================================
        // AGREGADO: EVENTOS PARA LIMPIAR ERRORES AL INTERACTUAR
        // ============================================

        // Limpiar error del nombre cuando se escribe
        nameInput.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const nameError = document.getElementById('name-error');
            if (nameError) {
                nameError.style.display = 'none';
                nameError.innerHTML = '';
            }
        });

        // Limpiar error del SKU cuando se escribe
        skuInput.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const skuError = document.getElementById('sku-error');
            if (skuError) {
                skuError.style.display = 'none';
                skuError.innerHTML = '';
            }
        });

        // Limpiar error del precio cuando se escribe
        form.querySelector('input[name="price"]')?.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const priceError = document.getElementById('price-error');
            if (priceError) {
                priceError.style.display = 'none';
                priceError.innerHTML = '';
            }
        });

        // Limpiar error del stock cuando se escribe
        form.querySelector('input[name="stock"]')?.addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const stockError = document.getElementById('stock-error');
            if (stockError) {
                stockError.style.display = 'none';
                stockError.innerHTML = '';
            }
        });

        // ============================================
        // DETECCIÓN DE CAMBIOS EN EL FORMULARIO
        // ============================================
        form.querySelectorAll('input, textarea, select').forEach(el => {
            if (el.type !== 'file') {
                el.addEventListener('change', () => formChanged = true);
                el.addEventListener('input', () => formChanged = true);
            }
        });

        // ============================================
        // FUNCIONES PARA EL SPINNER CON BARRA DE PROGRESO
        // ============================================

        // Función para deshabilitar todos los botones y preparar spinner
        function disableAllButtons() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualizando...';
            submitBtn.classList.add('disabled-btn');

            backBtn.disabled = true;
            backBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Bloqueado';
            backBtn.classList.add('disabled-btn');
            backBtn.style.pointerEvents = 'none';

            // Preparar spinner de carga
            showLoadingState();
        }

        // Función para habilitar todos los botones
        function enableAllButtons() {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            submitBtn.classList.remove('disabled-btn');

            backBtn.disabled = false;
            backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Regresar';
            backBtn.classList.remove('disabled-btn');
            backBtn.style.pointerEvents = 'auto';
        }

        /**
         * Muestra el spinner con barra de progreso
         */
        function showLoadingState() {
            // Resetear barra de progreso
            resetProgressBar();

            // Mostrar overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.classList.add('fade-in');
            }

            // Actualizar textos iniciales
            document.getElementById('loadingTitle').textContent = 'Actualizando variante';
            document.getElementById('loadingSubtitle').textContent = 'Procesando tu solicitud, por favor espera...';
            document.getElementById('progressStatus').textContent = 'Validando datos...';

            // Bloquear scroll del body
            document.body.style.overflow = 'hidden';

            // Iniciar progreso automático
            startProgressSimulation();
        }

        /**
         * Oculta el spinner
         */
        function hideLoadingState() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
                loadingOverlay.classList.remove('fade-in');
            }

            // Restaurar scroll del body
            document.body.style.overflow = 'auto';
        }

        /**
         * Resetea la barra de progreso a 0%
         */
        function resetProgressBar() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');

            if (progressFill) progressFill.style.width = '0%';
            if (progressText) progressText.textContent = '0%';
            if (progressBar) {
                progressBar.classList.remove('progress-complete', 'progress-error');
            }
        }

        /**
         * Actualiza la barra de progreso
         */
        function updateProgress(percentage, status = null) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressStatus = document.getElementById('progressStatus');

            // Asegurar que el porcentaje esté entre 0 y 100
            const safePercentage = Math.min(100, Math.max(0, percentage));

            // Actualizar barra visual
            if (progressFill) {
                progressFill.style.width = `${safePercentage}%`;
            }

            // Actualizar texto
            if (progressText) {
                progressText.textContent = `${Math.round(safePercentage)}%`;

                // Cambiar color cuando se complete
                if (safePercentage >= 100) {
                    const progressBar = document.getElementById('progressBar');
                    if (progressBar) {
                        progressBar.classList.add('progress-complete');
                    }
                }
            }

            // Actualizar estado si se proporciona
            if (status && progressStatus) {
                progressStatus.textContent = status;
            }
        }

        /**
         * Muestra estado de error en la barra de progreso
         */
        function showProgressError(errorMessage) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');

            if (progressBar) {
                progressBar.classList.add('progress-error');
            }

            if (progressStatus) {
                progressStatus.textContent = errorMessage;
                progressStatus.style.color = '#dc2626';
            }

            // Actualizar título y subtítulo
            document.getElementById('loadingTitle').textContent = '¡Error!';
            document.getElementById('loadingSubtitle').textContent = 'Hubo un problema al procesar tu solicitud.';

            // Ocultar después de 3 segundos
            setTimeout(() => {
                hideLoadingState();
                enableAllButtons();
                isFormSubmitting = false;
                isSubmitting = false;
            }, 3000);
        }

        /**
         * Simula el progreso de carga
         */
        function startProgressSimulation() {
            let progress = 0;
            const statusMessages = [
                'Validando datos...',
                'Procesando imágenes...',
                'Guardando en servidor...',
                'Optimizando recursos...',
                'Finalizando proceso...',
                '¡Completado!'
            ];

            // Iniciar simulación
            const interval = setInterval(() => {
                progress += 1;

                // Cambiar mensaje según progreso
                let statusIndex = 0;
                if (progress >= 20) statusIndex = 1;
                if (progress >= 40) statusIndex = 2;
                if (progress >= 60) statusIndex = 3;
                if (progress >= 80) statusIndex = 4;
                if (progress >= 95) statusIndex = 5;

                updateProgress(progress, statusMessages[statusIndex]);

                // Cuando llegue al 100%, mantener por 1 segundo y luego dejar que el formulario continúe
                if (progress >= 100) {
                    clearInterval(interval);

                    // Cambiar a estado completado
                    document.getElementById('loadingTitle').textContent = '¡Variante Actualizada!';
                    document.getElementById('loadingSubtitle').textContent =
                        'Redirigiendo a la lista de diseños...';

                    // Marcar que el formulario se está enviando
                    isFormSubmitting = true;
                    formChanged = false;

                    // Esperar 1.5 segundos para mostrar el estado "completado"
                    setTimeout(() => {
                        // Permitir que el formulario se envíe
                        hideLoadingState();

                        // Actualizar input files antes de enviar (solo nuevas imágenes)
                        const dt = new DataTransfer();
                        selectedFiles.forEach(file => dt.items.add(file));
                        input.files = dt.files;

                        // Enviar el formulario
                        form.submit();
                    }, 1500);
                }
            }, 30);
        }

        // ============================================
        // MANEJO DEL FORMULARIO CON VALIDACIÓN
        // ============================================
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (isSubmitting) {
                return;
            }

            // Validaciones básicas antes de enviar
            clearValidationErrors();

            const name = nameInput.value.trim();
            let hasErrors = false;

            // Validar nombre (igual que en el create)
            if (!name) {
                showFieldError(nameInput, 'El nombre de la variante es obligatorio.');
                hasErrors = true;
            }

            // Si hay errores, hacer focus en el primer campo con error
            if (hasErrors) {
                const firstError = form.querySelector('.is-invalid, .border-danger');
                if (firstError) {
                    firstError.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    if (firstError.focus) firstError.focus();
                }
                return;
            }

            isSubmitting = true;
            isFormSubmitting = true;

            // 1. Deshabilitar botones y mostrar spinner
            disableAllButtons();

            // 2. Pequeña pausa para que se muestre el spinner
            await new Promise(resolve => setTimeout(resolve, 100));

            // 3. Permitir que el formulario se envíe normalmente
            // El spinner continuará mostrándose hasta que la página se recargue
        });

        // ============================================
        // FUNCIONES ORIGINALES (MANTENIDAS)
        // ============================================

        // Función para seleccionar imagen principal existente
        function selectExistingPrimaryImage(imageId) {
            // Actualizar input hidden
            document.getElementById('primary_image_id').value = imageId;

            // Quitar selección de todas
            document.querySelectorAll('.primary-image-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Agregar selección a la seleccionada
            const selectedOption = document.querySelector(`.primary-image-option[data-image-id="${imageId}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }

            // Marcar cambio en formulario
            formChanged = true;
        }

        // ============================================
        // NUEVA FUNCIÓN CON MODAL DE BOOTSTRAP (REEMPLAZA SWEETALERT)
        // ============================================
        function confirmDeleteImage(url) {
            // Mostrar el modal de confirmación con botón X azul
            $('#deleteImageConfirmModal').modal('show');

            // Configurar el evento del botón de confirmación
            document.getElementById('confirmDeleteImageBtn').onclick = function() {
                const form = document.getElementById('deleteImageForm');
                form.action = url;
                form.submit();
            };
        }

        // ============================================
        // LIMPIAR EVENTO AL CERRAR EL MODAL
        // ============================================
        $(document).ready(function() {
            // Limpiar el evento cuando el modal de confirmación de imagen se cierre
            $('#deleteImageConfirmModal').on('hidden.bs.modal', function() {
                document.getElementById('confirmDeleteImageBtn').onclick = null;
            });
        });

        // Manejar el evento beforeunload
        window.addEventListener('beforeunload', e => {
            if (formChanged && !isFormSubmitting) {
                e.preventDefault();
                e.returnValue = '';
                return '¿Deseas abandonar el sitio?\n\nEs posible que los cambios que implementaste no se puedan guardar.\n\n';
            }
        });

        // Manejar el botón de regresar
        backBtn.addEventListener('click', function(e) {
            if (isSubmitting) {
                e.preventDefault();

                Swal.fire({
                    title: '¿Cancelar operación?',
                    text: 'La variante se está actualizando. ¿Estás seguro de que quieres cancelar?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#2563eb',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Sí, cancelar',
                    cancelButtonText: 'Continuar actualizando',
                    customClass: {
                        popup: 'apple-sweet-alert'
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Cancelar operación
                        isSubmitting = false;
                        isFormSubmitting = false;
                        enableAllButtons();
                        hideLoadingState();

                        // Redirigir
                        window.location.href = this.href;
                    }
                });
            }
        });

        // Restaurar estado si hay error de validación del servidor
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;
            }
        });

        // También ocultar spinner cuando se cargue la página normalmente
        window.addEventListener('load', function() {
            setTimeout(() => {
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;
            }, 500);
        });
    </script>

    @if (session('success'))
        <script>
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: "{{ session('success') }}",
                timer: 4000,
                showConfirmButton: false,
                customClass: {
                    popup: 'fade-in apple-sweet-alert'
                }
            });
        </script>
    @endif

    @if (session('error'))
        <script>
            Swal.fire({
                icon: 'error',
                title: '¡Error!',
                text: "{{ session('error') }}",
                showConfirmButton: true,
                confirmButtonColor: '#2563eb',
                customClass: {
                    popup: 'shake apple-sweet-alert'
                }
            });
        </script>
    @endif
@stop
</file>

<file path="resources/views/admin/designs/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar diseño')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h1 class="text-2xl font-weight-semibold text-gray-800">
            Editar diseño: {{ $design->name }}
        </h1>
        <div class="d-flex gap-2">
            <a id="back-btn" href="{{ route('admin.designs.index') }}" class="btn btn-secondary btn-md px-3 mr-2">
                <i class="fas fa-arrow-left"></i> Regresar
            </a>
            <button id="submitBtn" form="design-form" type="submit" class="btn btn-primary btn-md px-3">
                <i class="fas fa-save"></i> Actualizar
            </button>
        </div>
    </div>

    {{-- Envolver en row y col para alinear con las tarjetas de abajo --}}
    <div class="row mb-3">
        <div class="col-12">
            <div class="variants-indicator sticky-indicator" id="variantsIndicator" style="border-radius: 15px;">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-layer-group text-primary mr-2"></i>
                        <strong>{{ $design->variants->count() }}</strong>
                        <span>variante{{ $design->variants->count() != 1 ? 's' : '' }}</span>
                        @if ($design->variants->count() == 0)
                            <small class="ml-2" style="color: white !important;font-weight: bold;">(Crea tu primera
                                variante abajo)</small>
                        @endif
                    </div>
                    <button type="button" class="btn btn-sm btn-primary" onclick="scrollToVariants()">
                        <i class="fas fa-arrow-down"></i> Ver variantes
                    </button>
                </div>
            </div>
        </div>
    </div>
@stop

@section('content')
    {{-- ============================================
         SPINNER PREMIUM CON BARRA DE PROGRESO
         ============================================ --}}
    <div class="modal-loading-overlay" id="loadingOverlay">
        <div class="modal-loading-content">
            <div class="modal-loading-spinner"></div>
            <h3 class="modal-loading-title" id="loadingTitle">Actualizando diseño</h3>
            <p class="modal-loading-subtitle" id="loadingSubtitle">
                Procesando tu solicitud, por favor espera...
            </p>

            {{-- CONTENEDOR DE BARRA DE PROGRESO --}}
            <div class="progress-container-premium">
                <div class="progress-bar-premium" id="progressBar">
                    <div class="progress-fill-premium" id="progressFill"></div>
                </div>
                <div class="progress-text-container">
                    <span class="progress-text" id="progressText">0%</span>
                    <span class="progress-status" id="progressStatus">Iniciando...</span>
                </div>
            </div>
        </div>
    </div>

    <form id="design-form" action="{{ route('admin.designs.update', $design) }}" method="POST"
        enctype="multipart/form-data">
        @csrf
        @method('PUT')

        <div class="row">

            {{-- COLUMNA IZQUIERDA: IMAGEN --}}
            <div class="col-lg-5">
                <div class="surface">

                    <h5 class="section-title mb-3">
                        <i class="fas fa-image text-primary"></i> Imagen del diseño
                    </h5>

                    {{-- Imagen actual con diseño descriptivo --}}
                    @if ($design->primaryImage)
                        @php
                            $img = $design->primaryImage;
                            $fileExt = strtolower(pathinfo($img->file_name, PATHINFO_EXTENSION));
                            $mimeMap = [
                                'image/jpeg' => 'JPEG',
                                'image/png' => 'PNG',
                                'image/webp' => 'WebP',
                                'image/avif' => 'AVIF',
                                'image/gif' => 'GIF',
                                'image/svg+xml' => 'SVG',
                            ];
                            $formatName = $mimeMap[$img->mime_type] ?? strtoupper($fileExt);
                            $fileType = str_starts_with($img->mime_type ?? '', 'image/svg') ? 'Vector' : 'Imagen';

                            // Formatear tamaño
                            $fileSize = $img->file_size ?? $img->original_size ?? 0;
                            if ($fileSize < 1024) {
                                $formattedSize = $fileSize . ' B';
                            } elseif ($fileSize < 1024 * 1024) {
                                $formattedSize = number_format($fileSize / 1024, 1) . ' KB';
                            } else {
                                $formattedSize = number_format($fileSize / (1024 * 1024), 2) . ' MB';
                            }
                        @endphp
                        <div class="image-analysis-card current-image-card mb-3">
                            <div class="image-card-preview">
                                <img src="{{ asset('storage/' . $img->file_path) }}"
                                    alt="{{ $design->name }}">
                            </div>
                            <div class="image-card-info">
                                <div class="image-card-name">
                                    <i class="fas fa-file-image"></i>
                                    <span title="{{ $img->file_name }}">{{ $img->file_name }}</span>
                                </div>
                                <div class="image-card-details">
                                    <span>{{ $fileType }} ({{ $formatName }})</span>
                                    <span>Tamaño: {{ $formattedSize }}</span>
                                </div>
                                @if($img->width && $img->height)
                                <div class="image-card-dimensions">
                                    <span class="dim-label">Dimensiones:</span>
                                    {{ $img->width }} × {{ $img->height }} px
                                </div>
                                @endif
                                <div class="image-card-format">
                                    <i class="fas fa-check-circle"></i>
                                    Formato: {{ $formatName }} (extensión .{{ $fileExt }})
                                </div>
                                <div class="image-card-date">
                                    <i class="fas fa-calendar-alt"></i>
                                    Subida el {{ $img->created_at->format('d/m/Y') }} a las {{ $img->created_at->format('H:i') }}
                                </div>
                            </div>
                        </div>
                    @endif

                    {{-- Alerta warning --}}
                    <div class="alert alert-warning alert-modern mb-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Nota:</strong> Si subes una nueva imagen, reemplazará la actual como imagen principal.
                    </div>

                    {{-- Dropzone para nueva imagen --}}
                    <div id="dropzone" class="dropzone @error('image') border-danger @enderror">
                        <input type="file" id="imageInput" name="image" accept="image/*" hidden>

                        <div class="dropzone-content" id="dropzoneContent">
                            <div class="dropzone-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="dropzone-title">
                                {{ $design->primaryImage ? 'Cambiar imagen' : 'Subir imagen' }}
                            </div>
                            <div class="dropzone-sub">
                                Arrastra una imagen aquí o haz clic
                            </div>
                            <div class="dropzone-formats">
                                Formatos: JPEG, PNG, SVG, AVIF, WebP
                            </div>
                        </div>

                        {{-- Contenedor para la vista previa de la imagen --}}
                        <div id="previewContainer" class="preview-container"></div>
                    </div>

                    {{-- Contenedor para la información del archivo (card descriptiva) --}}
                    <div id="fileInfoContainer"></div>
                    <div id="image-error" class="text-danger small mt-1" style="display: none;"></div>

                </div>
            </div>

            {{-- COLUMNA DERECHA: FORMULARIO --}}
            <div class="col-lg-7">
                <div class="surface">

                    <h5 class="section-title mb-4">
                        <i class="fas fa-info-circle text-primary"></i> Información básica
                    </h5>

                    {{-- Nombre del diseño --}}
                    <div class="mb-4">
                        <label class="label">
                            Nombre del diseño <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="name" class="input @error('name') is-invalid @enderror"
                            placeholder="Ej. Mariposa floral minimalista" value="{{ old('name', $design->name) }}" required>
                        <div id="name-error" class="text-danger small mt-1" style="display: none;"></div>
                        @error('name')
                            <span class="text-danger small">{{ $message }}</span>
                        @enderror
                    </div>

                    {{-- Categorías --}}
                    <div class="mb-4">
                        <label class="label">
                            Categorías <span class="text-danger">*</span>
                        </label>
                        <select name="categories[]" class="input @error('categories') is-invalid @enderror" multiple
                            size="6">
                            @foreach ($categories as $category)
                                <option value="{{ $category->id }}"
                                    {{ in_array($category->id, old('categories', $selectedCategories)) ? 'selected' : '' }}>
                                    {{ $category->name }}
                                </option>
                            @endforeach
                        </select>
                        <div id="categories-error" class="text-danger small mt-1" style="display: none;"></div>
                        <small class="hint">
                            Selecciona una o varias categorías (mantén Ctrl/Cmd para seleccionar múltiples)
                        </small>
                        @error('categories')
                            <span class="text-danger small d-block">{{ $message }}</span>
                        @enderror
                    </div>

                    {{-- Descripción --}}
                    <div class="mb-4">
                        <label class="label">Descripción</label>
                        <textarea name="description" rows="5" class="input @error('description') is-invalid @enderror"
                            placeholder="Describe el estilo, uso y enfoque del diseño…">{{ old('description', $design->description) }}</textarea>
                        <div id="description-error" class="text-danger small mt-1" style="display: none;"></div>
                        @error('description')
                            <span class="text-danger small">{{ $message }}</span>
                        @enderror
                    </div>

                    {{-- Estado activo (oculto) --}}
                    <div style="display: none">
                        <div class="custom-control custom-switch">
                            <input type="hidden" name="is_active" value="0">
                            <input type="checkbox" class="custom-control-input" id="is_active" name="is_active"
                                value="1" {{ old('is_active', $design->is_active) ? 'checked' : '' }}>
                            <label class="custom-control-label" for="is_active">
                                <strong>Diseño activo</strong>
                            </label>
                        </div>
                        <small class="hint">
                            Los diseños inactivos no se mostrarán en el listado público
                        </small>
                    </div>

                </div>
            </div>

        </div>

    </form>

    {{-- ===== SECCIÓN DE VARIANTES ===== --}}
    <div class="row mt-4" id="variantsSection">
        <div class="col-12">
            @if ($design->variants->count() > 0)
                <div class="surface">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-layer-group text-primary"></i>
                            Variantes del diseño ({{ $design->variants->count() }})
                        </h5>
                        <a href="{{ route('admin.designs.variants.create', $design) }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-plus"></i> Agregar variante
                        </a>
                    </div>

                    <div class="variants-grid">
                        @foreach ($design->variants as $variant)
                            {{-- ⭐ ID ÚNICO PARA CADA VARIANTE --}}
                            <div class="variant-card variant-scroll-target" id="variant-{{ $variant->id }}">
                                {{-- Imagen de la variante --}}
                                <div class="variant-image">
                                    @if ($variant->primaryImage)
                                        <img src="{{ asset('storage/' . $variant->primaryImage->file_path) }}"
                                            alt="{{ $variant->primaryImage->alt_text ?? $variant->name }}">
                                    @else
                                        <div class="no-variant-image">
                                            <i class="fas fa-image fa-2x text-muted"></i>
                                        </div>
                                    @endif
                                </div>

                                {{-- Info de la variante --}}
                                <div class="variant-body">
                                    <h6 class="variant-name">{{ $variant->name }}</h6>
                                    <div class="variant-details">
                                        <small class="text-muted d-block">SKU: {{ $variant->sku }}</small>
                                        @if ($variant->price)
                                            <small class="text-success d-block">
                                                <strong>${{ number_format($variant->price, 2) }}</strong>
                                            </small>
                                        @endif
                                    </div>

                                    {{-- Badges --}}
                                    <div class="variant-badges mt-2">
                                        @if ($variant->is_default)
                                            <span class="badge badge-primary">Principal</span>
                                        @endif
                                        @if ($variant->is_active)
                                            <span class="badge badge-success">Activo</span>
                                        @else
                                            <span class="badge badge-secondary">Inactivo</span>
                                        @endif
                                    </div>
                                </div>

                                {{-- Acciones --}}
                                <div class="variant-actions">
                                    <a href="{{ route('admin.designs.variants.edit', [$design, $variant]) }}"
                                        class="btn btn-sm btn-outline-primary" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete-variant"
                                        data-url="{{ route('admin.designs.variants.destroy', [$design, $variant]) }}"
                                        title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        @endforeach
                    </div>
                </div>
            @else
                {{-- Card para crear primera variante --}}
                <div class="surface text-center py-5 empty-variants-card">
                    <div class="empty-icon mb-3">
                        <i class="fas fa-layer-group fa-4x text-muted"></i>
                    </div>
                    <h4 class="text-muted mb-3">Este diseño no tiene variantes</h4>
                    <p class="text-muted mb-4">
                        Las variantes te permiten tener diferentes versiones del mismo diseño<br>
                        con diferentes colores, tamaños, estilos, precios e inventario individual.
                    </p>
                    <div class="benefits-grid mb-4">
                        <div class="benefit-item">
                            <i class="fas fa-palette text-primary"></i>
                            <small>Diferentes colores</small>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-dollar-sign text-success"></i>
                            <small>Precios individuales</small>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-boxes text-info"></i>
                            <small>Control de stock</small>
                        </div>
                    </div>
                    <a href="{{ route('admin.designs.variants.create', $design) }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus-circle"></i> Crear primera variante
                    </a>
                </div>
            @endif
        </div>
    </div>
@stop

@section('css')
    <style>
        /* ============================================
           MATERIAL DESIGN / APPLE HIG - BASE STYLES
           ============================================ */
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1);
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 15px;
            --font-size-lg: 17px;
            --font-size-xl: 20px;
        }

        .surface {
            background: #ffffff;
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-md);
            height: 100%;
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: var(--font-size-base);
        }

        /* ============================================
           ALERTA MODERNA
           ============================================ */
        .alert-modern {
            font-size: var(--font-size-sm);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            border: none;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-modern i {
            margin-top: 2px;
        }

        /* ============================================
           IMAGE ANALYSIS CARD - DISEÑO DESCRIPTIVO
           ============================================ */
        .image-analysis-card {
            background: #fff;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: 16px;
            transition: all 0.2s ease;
        }

        .image-analysis-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .image-card-preview {
            position: relative;
            width: 100%;
            height: 140px;
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-bottom: 1px solid var(--gray-100);
        }

        .image-card-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-card-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: 2px solid white;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .image-card-remove:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }

        .image-card-info {
            padding: 16px;
            background: var(--gray-50);
        }

        .image-card-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 12px;
        }

        .image-card-name i {
            color: var(--primary);
        }

        .image-card-details {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }

        .image-card-dimensions {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: var(--font-size-sm);
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .image-card-dimensions .dim-label {
            color: var(--gray-500);
            font-weight: 500;
        }

        .image-card-format {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: var(--font-size-sm);
            color: var(--success);
            font-weight: 500;
        }

        .image-card-format i {
            font-size: var(--font-size-xs);
        }

        /* Alerta de extensión diferente */
        .image-card-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            margin-top: 12px;
            font-size: var(--font-size-xs);
            color: #92400e;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .image-card-warning i {
            color: var(--warning);
            margin-top: 1px;
        }

        /* Fecha de subida */
        .image-card-date {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-200);
        }

        .image-card-date i {
            color: var(--gray-400);
            font-size: var(--font-size-xs);
        }

        /* Ajuste para imagen actual (card más grande) */
        .current-image-card .image-card-preview {
            height: 200px;
        }

        .current-image-card .image-card-name span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ========== INDICADOR STICKY DE VARIANTES ========== */
        .variants-indicator {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            animation: slideInDown 0.5s ease-out;
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .variants-indicator strong {
            font-size: 20px;
            color: #fff;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            border-radius: 12px;
        }

        .variants-indicator .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            transition: all 0.3s;
        }

        .variants-indicator .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(2px);
        }

        /* ========== LABELS E INPUTS ========== */
        .label {
            font-weight: 600;
            color: #333;
            margin-bottom: 6px;
            display: block;
        }

        .input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 15px;
            background: #fafafa;
            transition: border .2s, background .2s;
        }

        .input:focus {
            outline: none;
            border-color: #2563eb;
            background: #fff;
        }

        .input.is-invalid {
            border-color: #dc3545;
        }

        .hint {
            font-size: 13px;
            color: #6b7280;
        }

        /* ========== IMAGEN ACTUAL ========== */
        .current-image-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            border: 1px solid #e5e7eb;
        }

        .current-image-wrapper {
            text-align: center;
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
        }

        .current-image {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-info {
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
        }

        /* ========== DROPZONE ========== */
        .dropzone {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--gray-50);
            position: relative;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .dropzone:hover {
            background: var(--gray-100);
            border-color: var(--primary);
        }

        .dropzone.has-preview {
            min-height: 80px;
            padding: 20px;
            border: 2px solid var(--primary);
            background: #eff6ff;
        }

        .dropzone.has-preview .dropzone-content {
            display: none;
        }

        .dropzone.has-preview::after {
            content: 'Archivo seleccionado ✓';
            font-size: var(--font-size-sm);
            color: var(--primary);
            font-weight: 500;
        }

        .dropzone-content {
            text-align: center;
        }

        .dropzone-icon {
            font-size: 42px;
            color: var(--gray-400);
            margin-bottom: 12px;
        }

        .dropzone-title {
            font-weight: 600;
            font-size: var(--font-size-lg);
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .dropzone-sub {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .dropzone-formats {
            font-size: var(--font-size-xs);
            color: var(--gray-400);
            background: var(--gray-100);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        /* ========== PREVIEW CONTAINER ========== */
        .preview-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 16px;
        }

        .preview-container.active {
            display: flex;
        }

        .preview-item {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
            border: 1px solid #e5e7eb;
        }

        .preview-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        /* Botón de eliminar (tachita) - POSICIÓN CORREGIDA */
        .remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: 2px solid white;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Icono para archivos de bordado */
        .embroidery-preview {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            color: white;
            text-align: center;
            padding: 30px;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
        }

        .embroidery-preview i {
            font-size: 60px;
            margin-bottom: 15px;
        }

        /* Para SVGs con fondo blanco */
        .svg-preview {
            background: white;
            padding: 20px;
        }

        /* ========== EMPTY STATE (SIN VARIANTES) ========== */
        .empty-variants-card {
            background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
            border: 2px dashed #d1d5db;
        }

        .empty-icon {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .benefits-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .benefit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .benefit-item i {
            font-size: 24px;
        }

        .benefit-item small {
            color: #6b7280;
            font-weight: 500;
        }

        /* ========== VARIANTES GRID ========== */
        .variants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .variant-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
            scroll-margin-top: 120px;
        }

        .variant-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }

        /* ⭐ ANIMACIÓN DE HIGHLIGHT */
        .variant-card.highlight-variant {
            animation: variantHighlight 2s ease-in-out;
        }

        @keyframes variantHighlight {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(37, 99, 235, 0);
                border-color: #e5e7eb;
            }

            50% {
                box-shadow: 0 0 0 15px rgba(37, 99, 235, 0.2);
                border-color: #2563eb;
            }
        }

        .variant-image {
            height: 150px;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .variant-image img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .no-variant-image {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .variant-body {
            padding: 12px;
            background: #fff;
        }

        .variant-name {
            font-weight: 600;
            font-size: 14px;
            color: #111827;
            margin-bottom: 8px;
        }

        .variant-details {
            margin-bottom: 8px;
        }

        .variant-badges {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }

        .variant-actions {
            display: flex;
            gap: 5px;
            padding: 10px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            justify-content: center;
        }

        /* ========== SWITCH PERSONALIZADO ========== */
        .custom-control-input:checked~.custom-control-label::before {
            background-color: #2563eb;
            border-color: #2563eb;
        }

        /* ========== SCROLL SMOOTH ========== */
        html {
            scroll-behavior: smooth;
        }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 991px) {
            .variants-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .benefits-grid {
                grid-template-columns: 1fr;
            }

            .dropzone {
                min-height: 250px;
            }

            .dropzone-title {
                font-size: 16px;
            }
        }

        .shake {
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        .premium-swal-popup {
            border-radius: 20px !important;
            padding: 2rem !important;
        }

        .premium-swal-confirm {
            background-color: #dc3545 !important;
            border-radius: 12px !important;
            padding: 12px 30px !important;
            font-weight: 600 !important;
        }

        .premium-swal-cancel {
            background-color: #f3f4f6 !important;
            color: #374151 !important;
            border-radius: 12px !important;
            padding: 12px 30px !important;
            font-weight: 600 !important;
        }

        /* ========== ESTILOS PARA INFORMACIÓN DE ARCHIVO ========== */
        .file-info {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 13px;
            margin-top: 12px;
        }

        .file-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .file-info-name {
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }

        .file-info-details {
            display: flex;
            justify-content: space-between;
            color: #6b7280;
            font-size: 12px;
        }

        .file-info-success {
            color: #059669;
            font-weight: 500;
        }

        /* Animación fade-in */
        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Estilos para botones deshabilitados */
        .disabled-btn {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Dropzone con error */
        .dropzone.border-danger {
            border-color: #dc2626 !important;
            background: #fef2f2;
        }

        /* ============================================
                               ESTILOS DEL SPINNER PREMIUM (AGREGADOS)
                               ============================================ */
        .modal-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .modal-loading-content {
            text-align: center;
            padding: 40px;
            max-width: 320px;
        }

        .modal-loading-spinner {
            width: 64px;
            height: 64px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top-color: #2563eb;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }

        .modal-loading-subtitle {
            font-size: 0.95rem;
            color: #6b7280;
            line-height: 1.5;
        }

        /* ============================================
                               BARRA DE PROGRESO PREMIUM
                               ============================================ */
        .progress-container-premium {
            width: 100%;
            max-width: 320px;
            margin: 24px auto 0;
        }

        .progress-bar-premium {
            width: 100%;
            height: 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        .progress-fill-premium {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,
                    #2563eb 0%,
                    #3b82f6 25%,
                    #60a5fa 50%,
                    #93c5fd 75%,
                    #bfdbfe 100%);
            border-radius: 10px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
        }

        /* Efecto de brillo animado */
        .progress-fill-premium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    transparent 100%);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Texto de progreso */
        .progress-text-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .progress-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2563eb;
            text-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
            min-width: 60px;
        }

        .progress-status {
            font-size: 0.95rem;
            color: #6b7280;
            font-weight: 500;
            text-align: right;
            flex: 1;
            padding-left: 16px;
        }

        /* Estados de completado */
        .progress-complete .progress-fill-premium {
            background: linear-gradient(90deg,
                    #059669 0%,
                    #10b981 25%,
                    #34d399 50%,
                    #6ee7b7 75%,
                    #a7f3d0 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .progress-complete .progress-text {
            color: #059669;
        }

        /* Estados de error */
        .progress-error .progress-fill-premium {
            background: linear-gradient(90deg,
                    #dc2626 0%,
                    #ef4444 25%,
                    #f87171 50%,
                    #fca5a5 75%,
                    #fecaca 100%);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .progress-error .progress-text {
            color: #dc2626;
        }
    </style>
@stop

@section('js')
    <script>
        // ============================================
        // VALIDADOR MEJORADO DE ARCHIVOS DE DISEÑO
        // ============================================
        class DesignFileValidator {
            constructor() {
                this.allowedExtensions = [
                    'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'tiff',
                    'svg', 'svgz',
                    'pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv', 'csd', '10o', 'bro'
                ];

                this.maxSizes = {
                    'image': 10 * 1024 * 1024,
                    'vector': 5 * 1024 * 1024,
                    'embroidery': 50 * 1024 * 1024
                };
            }

            async getFileBytes(file, bytes = 64) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = (e) => {
                        try {
                            const arr = new Uint8Array(e.target.result);
                            resolve(arr);
                        } catch (error) {
                            resolve(new Uint8Array());
                        }
                    };
                    reader.onerror = () => resolve(new Uint8Array());
                    const slice = file.slice(0, bytes);
                    reader.readAsArrayBuffer(slice);
                });
            }

            async detectFileTypeByContent(file) {
                const bytes = await this.getFileBytes(file, 64);
                if (bytes.length === 0) return null;

                let hexHeader = '';
                for (let i = 0; i < bytes.length; i++) {
                    hexHeader += bytes[i].toString(16).padStart(2, '0');
                }

                const signatures = {
                    'jpeg': [
                        'ffd8ffe0', 'ffd8ffe1', 'ffd8ffe2', 'ffd8ffe3',
                        'ffd8ffe8', 'ffd8ffdb', 'ffd8ffee'
                    ],
                    'png': ['89504e470d0a1a0a'],
                    'gif': ['474946383761', '474946383961'],
                    'bmp': ['424d'],
                    'webp': ['52494646'],
                    'tiff': ['49492a00', '4d4d002a'],
                    'svg': ['3c737667', '3c3f786d6c', '3c21444f4354595045'],
                    'pes': ['23504553', '50455330', '43455031'],
                    'dst': ['4154414a494d41', '4c414a494d41'],
                    'exp': ['45787031', '45787032'],
                    'xxx': ['585858', '53494e474552'],
                    'jef': ['4a4546', '4a454631'],
                    'vp3': ['567033', '4856534d'],
                    'hus': ['4846475631', '4846475632'],
                    'pec': ['504543', '50454330', '43455031'],
                    'phc': ['504843', '43455031'],
                    'sew': ['534557', '53455730'],
                    'shv': ['534856', '53485630'],
                    'csd': ['436865727279'],
                    '10o': ['31306f'],
                    'bro': ['42524f']
                };

                if (hexHeader.startsWith('52494646')) {
                    const webpBytes = await this.getFileBytes(file, 16);
                    if (webpBytes.length >= 12) {
                        const webpCheck = String.fromCharCode(webpBytes[8], webpBytes[9], webpBytes[10], webpBytes[11]);
                        if (webpCheck === 'WEBP') {
                            return 'webp';
                        }
                    }
                }

                if (hexHeader.startsWith('0000001') || hexHeader.startsWith('0000002')) {
                    const avifBytes = await this.getFileBytes(file, 12);
                    if (avifBytes.length >= 12) {
                        const ftypPos = String.fromCharCode(avifBytes[4], avifBytes[5], avifBytes[6], avifBytes[7]);
                        const brand = String.fromCharCode(avifBytes[8], avifBytes[9], avifBytes[10], avifBytes[11]);
                        if (ftypPos === 'ftyp' && (brand === 'avif' || brand === 'avis' || brand === 'mif1')) {
                            return 'avif';
                        }
                    }
                }

                for (const [type, sigs] of Object.entries(signatures)) {
                    for (const sig of sigs) {
                        if (hexHeader.startsWith(sig)) {
                            if (type === 'svg') {
                                const isSvg = await this.validateSVGContent(file);
                                if (isSvg) return 'svg';
                            } else {
                                return type;
                            }
                        }
                    }
                }

                return null;
            }

            async validateSVGContent(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = (e) => {
                        try {
                            const content = e.target.result;
                            const hasSvgTag = content.includes('<svg') || content.includes('<SVG');
                            resolve(hasSvgTag);
                        } catch (error) {
                            resolve(false);
                        }
                    };
                    reader.onerror = () => resolve(false);
                    reader.readAsText(file.slice(0, 2048));
                });
            }

            getFileCategory(fileType) {
                const imageTypes = ['jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'tiff'];
                const vectorTypes = ['svg'];
                const embroideryTypes = ['pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv',
                    'csd', '10o', 'bro'
                ];

                if (imageTypes.includes(fileType)) return 'image';
                if (vectorTypes.includes(fileType)) return 'vector';
                if (embroideryTypes.includes(fileType)) return 'embroidery';

                return 'unknown';
            }

            async validateDesignFile(file) {
                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();

                const detectedType = await this.detectFileTypeByContent(file);

                if (!detectedType) {
                    if (this.allowedExtensions.includes(fileExtension)) {
                        return {
                            valid: true,
                            type: this.getFileCategory(fileExtension),
                            subtype: fileExtension,
                            detectedBy: 'extension',
                            reason: `Archivo aceptado por extensión (.${fileExtension})`
                        };
                    }
                    return {
                        valid: false,
                        reason: 'Formato de archivo no reconocido. Asegúrate de subir una imagen, SVG o archivo de bordado válido.'
                    };
                }

                const category = this.getFileCategory(detectedType);

                const sizeValidation = this.validateFileSize(file, category);
                if (!sizeValidation.valid) {
                    return sizeValidation;
                }

                let reason = '';
                if (detectedType !== fileExtension) {
                    reason =
                        `Formato detectado: ${detectedType.toUpperCase()} (archivo con extensión .${fileExtension})`;
                } else {
                    reason = `Archivo ${detectedType.toUpperCase()} válido`;
                }

                return {
                    valid: true,
                    type: category,
                    subtype: detectedType,
                    detectedBy: 'signature',
                    reason: reason,
                    actualExtension: fileExtension
                };
            }

            validateFileSize(file, category) {
                const maxSize = this.maxSizes[category] || 10 * 1024 * 1024;

                if (file.size > maxSize) {
                    const sizeMB = (maxSize / (1024 * 1024)).toFixed(1);
                    let fileTypeName = '';
                    switch (category) {
                        case 'image':
                            fileTypeName = 'imágenes';
                            break;
                        case 'vector':
                            fileTypeName = 'SVG';
                            break;
                        case 'embroidery':
                            fileTypeName = 'archivos de bordado';
                            break;
                        default:
                            fileTypeName = 'archivos';
                    }
                    return {
                        valid: false,
                        reason: `El archivo es demasiado grande. Máximo ${sizeMB}MB para ${fileTypeName}.`
                    };
                }
                return {
                    valid: true,
                    reason: 'Tamaño válido'
                };
            }

            getFileIcon(fileType) {
                const icons = {
                    'image': 'image',
                    'vector': 'vector-square',
                    'embroidery': 'vest',
                    'jpeg': 'file-image',
                    'png': 'file-image',
                    'gif': 'file-image',
                    'bmp': 'file-image',
                    'webp': 'file-image',
                    'avif': 'file-image',
                    'svg': 'vector-square',
                    'pes': 'vest',
                    'dst': 'vest',
                    'default': 'file'
                };

                return icons[fileType] || icons['default'];
            }
        }

        // ============================================
        // CÓDIGO PRINCIPAL DE LA VISTA
        // ============================================
        const dropzone = document.getElementById('dropzone');
        const input = document.getElementById('imageInput');
        const previewContainer = document.getElementById('previewContainer');
        const fileInfoContainer = document.getElementById('fileInfoContainer');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('design-form');
        const backBtn = document.getElementById('back-btn');

        let isSubmitting = false;
        let currentObjectURL = null;
        const fileValidator = new DesignFileValidator();

        // Variable para controlar si hay cambios en el formulario
        let formChanged = false;
        let isFormSubmitting = false;

        function scrollToVariants() {
            const variantsSection = document.getElementById('variantsSection');
            variantsSection.scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Función para limpiar todo el contenido anterior
        function clearPreviousContent() {
            previewContainer.innerHTML = '';
            previewContainer.classList.remove('active');
            fileInfoContainer.innerHTML = '';

            if (currentObjectURL) {
                URL.revokeObjectURL(currentObjectURL);
                currentObjectURL = null;
            }

            dropzone.classList.remove('border-danger');
            dropzone.classList.remove('has-preview');

            // Eliminar todos los mensajes de error
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());
        }

        /**
         * Obtiene las dimensiones de una imagen
         */
        function getImageDimensions(file) {
            return new Promise((resolve) => {
                if (!file.type.startsWith('image/')) {
                    resolve({ width: null, height: null });
                    return;
                }

                const img = new Image();
                const url = URL.createObjectURL(file);

                img.onload = () => {
                    URL.revokeObjectURL(url);
                    resolve({ width: img.naturalWidth, height: img.naturalHeight });
                };

                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve({ width: null, height: null });
                };

                img.src = url;
            });
        }

        /**
         * Formatea el tamaño de archivo de forma legible
         */
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Función para mostrar información del archivo (diseño descriptivo como foto 2)
        async function showFileInfo(file, validationResult) {
            // Obtener dimensiones de la imagen
            const dimensions = await getImageDimensions(file);

            const fileSize = formatFileSize(file.size);
            const fileExt = file.name.split('.').pop().toLowerCase();
            const detectedFormat = validationResult.subtype || fileExt;

            // Determinar tipo de archivo
            let fileTypeName = 'Imagen';
            if (validationResult.type === 'vector') fileTypeName = 'Vector';
            else if (validationResult.type === 'embroidery') fileTypeName = 'Bordado';

            // Construir HTML de dimensiones
            let dimensionsHTML = '';
            if (dimensions.width && dimensions.height) {
                dimensionsHTML = `
                    <div class="image-card-dimensions">
                        <span class="dim-label">Dimensiones:</span>
                        ${dimensions.width} × ${dimensions.height} px
                    </div>
                `;
            }

            // Alerta de extensión diferente al tipo real detectado
            let warningHTML = '';
            if (validationResult.detectedBy === 'signature' &&
                validationResult.subtype &&
                validationResult.actualExtension &&
                validationResult.subtype.toLowerCase() !== validationResult.actualExtension.toLowerCase()) {
                warningHTML = `
                    <div class="image-card-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Nota:</strong> El archivo tiene extensión .${validationResult.actualExtension} pero es un formato ${validationResult.subtype.toUpperCase()}. Se guardará con la extensión correcta (.${validationResult.subtype}).
                        </div>
                    </div>
                `;
            }

            // Crear la URL de la imagen para preview
            const previewURL = URL.createObjectURL(file);

            const fileInfoHTML = `
                <div class="image-analysis-card fade-in">
                    <div class="image-card-preview">
                        <img src="${previewURL}" alt="${file.name}">
                        <button type="button" class="image-card-remove" onclick="handleRemoveImage()" title="Eliminar imagen">×</button>
                    </div>
                    <div class="image-card-info">
                        <div class="image-card-name">
                            <i class="fas fa-file-image"></i>
                            <span title="${file.name}">${file.name}</span>
                        </div>
                        <div class="image-card-details">
                            <span>${fileTypeName} (${detectedFormat.toUpperCase()})</span>
                            <span>Tamaño: ${fileSize}</span>
                        </div>
                        ${dimensionsHTML}
                        <div class="image-card-format">
                            <i class="fas fa-check-circle"></i>
                            Formato detectado: ${detectedFormat.toUpperCase()} (archivo con extensión .${fileExt})
                        </div>
                        ${warningHTML}
                    </div>
                </div>
            `;

            fileInfoContainer.innerHTML = fileInfoHTML;
        }

        // Función para crear vista previa dentro de la dropzone
        // NOTA: La vista previa principal ahora está en la card descriptiva (fileInfoContainer)
        // Esta función solo oculta el contenido del dropzone y marca que hay archivo seleccionado
        function createPreview(file, validationResult) {
            // Agregar clase para indicar que hay preview (oculta dropzone content)
            dropzone.classList.add('has-preview');

            // La preview visual se muestra en la card descriptiva (showFileInfo)
            // Solo guardamos la URL para posible uso posterior
            if (validationResult.type !== 'embroidery') {
                currentObjectURL = URL.createObjectURL(file);
            }
        }

        // Función para manejar la eliminación de imagen
        function handleRemoveImage() {
            clearPreviousContent();
            input.value = '';

            // Actualizar el estado de cambios del formulario
            formChanged = true;
        }

        // Función para mostrar error
        function showImageError(message) {
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());

            dropzone.classList.add('border-danger');
            const error = document.createElement('small');
            error.className = 'text-danger d-block mt-2 image-error';
            error.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${message}`;

            dropzone.parentElement.insertBefore(error, dropzone.nextSibling);

            error.scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }

        // Función para manejar clic en dropzone - SOLO cuando NO hay imagen
        function handleDropzoneClick(e) {
            // Si ya hay una imagen, NO hacer nada (solo se elimina con la "x")
            if (dropzone.classList.contains('has-preview')) {
                // Si se hace clic en la tachita, ya se maneja por separado
                if (e.target.closest('.remove-btn')) {
                    return;
                }
                // Si se hace clic en cualquier otra parte de la dropzone, NO abrir selector
                return;
            }

            // Si no hay imagen, abrir selector de archivos
            input.click();
        }

        // Event Listeners
        dropzone.addEventListener('click', handleDropzoneClick);

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#2563eb';
            dropzone.style.backgroundColor = '#eff6ff';
        });

        dropzone.addEventListener('dragleave', () => {
            dropzone.style.borderColor = '#d1d5db';
            dropzone.style.backgroundColor = 'transparent';
        });

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.style.borderColor = '#d1d5db';
            dropzone.style.backgroundColor = 'transparent';

            if (e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                const changeEvent = new Event('change');
                input.dispatchEvent(changeEvent);
            }
        });

        // Evento para cambiar el archivo con validación mejorada
        input.addEventListener('change', async function(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            const file = files[0];

            // Limpiar contenido anterior
            clearPreviousContent();

            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Validando...';
            submitBtn.disabled = true;
            backBtn.classList.add('disabled-btn');
            backBtn.style.pointerEvents = 'none';

            try {
                // Validar el archivo
                const validationResult = await fileValidator.validateDesignFile(file);

                if (!validationResult.valid) {
                    showImageError(validationResult.reason);
                    input.value = '';
                    return;
                }

                // Crear vista previa
                createPreview(file, validationResult);

                // Mostrar información del archivo
                showFileInfo(file, validationResult);

                // Marcar que el formulario ha cambiado
                formChanged = true;

            } catch (error) {
                console.error('Error en validación:', error);
                showImageError('Error inesperado al validar el archivo. Intenta con otro archivo.');
                input.value = '';
            } finally {
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar';
                submitBtn.disabled = false;
                backBtn.classList.remove('disabled-btn');
                backBtn.style.pointerEvents = 'auto';
            }
        });

        // Detectar cambios en el formulario
        form.querySelectorAll('input, textarea, select').forEach(el => {
            // No incluir el input de archivo (ya lo manejamos por separado)
            if (el.type !== 'file') {
                el.addEventListener('change', () => {
                    formChanged = true;
                });
                el.addEventListener('input', () => {
                    formChanged = true;
                });
            }
        });

        // Manejar el evento beforeunload (para evitar el mensaje cuando el formulario se está enviando)
        window.addEventListener('beforeunload', e => {
            if (formChanged && !isFormSubmitting) {
                e.preventDefault();
                e.returnValue = '';
                return '¿Deseas abandonar el sitio?\n\nEs posible que los cambios que implementaste no se puedan guardar.\n\n';
            }
        });

        // ============================================
        // FUNCIONES PARA EL SPINNER CON BARRA DE PROGRESO
        // ============================================

        // Función para deshabilitar todos los botones y preparar spinner
        function disableAllButtons() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualizando...';
            submitBtn.classList.add('disabled-btn');

            backBtn.disabled = true;
            backBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Bloqueado';
            backBtn.classList.add('disabled-btn');
            backBtn.style.pointerEvents = 'none';

            // Preparar spinner de carga
            showLoadingState();
        }

        // Función para habilitar todos los botones
        function enableAllButtons() {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Actualizar';
            submitBtn.classList.remove('disabled-btn');

            backBtn.disabled = false;
            backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Regresar';
            backBtn.classList.remove('disabled-btn');
            backBtn.style.pointerEvents = 'auto';
        }

        /**
         * Muestra el spinner con barra de progreso
         */
        function showLoadingState() {
            // Resetear barra de progreso
            resetProgressBar();

            // Mostrar overlay
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
                loadingOverlay.classList.add('fade-in');
            }

            // Actualizar textos iniciales
            document.getElementById('loadingTitle').textContent = 'Actualizando diseño';
            document.getElementById('loadingSubtitle').textContent = 'Procesando tu solicitud, por favor espera...';
            document.getElementById('progressStatus').textContent = 'Validando datos...';

            // Restablecer color del texto del estado a su valor por defecto
            document.getElementById('progressStatus').style.color = '#6b7280';

            // Bloquear scroll del body
            document.body.style.overflow = 'hidden';

            // Iniciar progreso automático
            startProgressSimulation();
        }

        /**
         * Oculta el spinner
         */
        function hideLoadingState() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
                loadingOverlay.classList.remove('fade-in');
            }

            // Restaurar scroll del body
            document.body.style.overflow = 'auto';
        }

        /**
         * Resetea la barra de progreso a 0%
         */
        function resetProgressBar() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressBar = document.getElementById('progressBar');

            if (progressFill) progressFill.style.width = '0%';
            if (progressText) progressText.textContent = '0%';
            if (progressBar) {
                progressBar.classList.remove('progress-complete', 'progress-error');
            }
        }

        /**
         * Actualiza la barra de progreso
         * @param {number} percentage - Porcentaje de 0 a 100
         * @param {string} status - Texto de estado (opcional)
         */
        function updateProgress(percentage, status = null) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const progressStatus = document.getElementById('progressStatus');

            // Asegurar que el porcentaje esté entre 0 y 100
            const safePercentage = Math.min(100, Math.max(0, percentage));

            // Actualizar barra visual
            if (progressFill) {
                progressFill.style.width = `${safePercentage}%`;
            }

            // Actualizar texto
            if (progressText) {
                progressText.textContent = `${Math.round(safePercentage)}%`;

                // Cambiar color cuando se complete
                if (safePercentage >= 100) {
                    const progressBar = document.getElementById('progressBar');
                    if (progressBar) {
                        progressBar.classList.add('progress-complete');
                    }
                }
            }

            // Actualizar estado si se proporciona
            if (status && progressStatus) {
                progressStatus.textContent = status;
            }
        }

        /**
         * Muestra estado de error en la barra de progreso
         * @param {string} errorMessage - Mensaje de error
         */
        function showProgressError(errorMessage) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');

            if (progressBar) {
                progressBar.classList.add('progress-error');
            }

            if (progressStatus) {
                progressStatus.textContent = errorMessage;
                progressStatus.style.color = '#dc2626';
            }

            // Actualizar título y subtítulo
            document.getElementById('loadingTitle').textContent = '¡Error!';
            document.getElementById('loadingSubtitle').textContent = 'Hubo un problema al procesar tu solicitud.';

            // Ocultar después de 3 segundos
            setTimeout(() => {
                hideLoadingState();
                enableAllButtons();
                isFormSubmitting = false;
                isSubmitting = false;
            }, 3000);
        }

        /**
         * Variable para controlar el intervalo de simulación
         */
        let progressInterval = null;
        let currentProgress = 0;

        /**
         * Simula el progreso de carga hasta un límite (para AJAX)
         * @param {number} maxProgress - Progreso máximo a simular (default 90)
         */
        function startProgressSimulation(maxProgress = 90) {
            currentProgress = 0;
            const statusMessages = [
                'Validando datos...',
                'Procesando imagen...',
                'Guardando en servidor...',
                'Optimizando recursos...',
                'Esperando respuesta...'
            ];

            // Limpiar intervalo anterior si existe
            if (progressInterval) {
                clearInterval(progressInterval);
            }

            // Iniciar simulación
            progressInterval = setInterval(() => {
                // Incremento más lento al acercarse al límite
                const increment = currentProgress < 50 ? 2 : (currentProgress < 70 ? 1 : 0.5);
                currentProgress += increment;

                // Limitar al máximo especificado
                if (currentProgress >= maxProgress) {
                    currentProgress = maxProgress;
                    clearInterval(progressInterval);
                    progressInterval = null;
                }

                // Cambiar mensaje según progreso
                let statusIndex = 0;
                if (currentProgress >= 20) statusIndex = 1;
                if (currentProgress >= 40) statusIndex = 2;
                if (currentProgress >= 60) statusIndex = 3;
                if (currentProgress >= 80) statusIndex = 4;

                updateProgress(currentProgress, statusMessages[statusIndex]);
            }, 50);
        }

        /**
         * Completa el progreso al 100% después de recibir respuesta exitosa
         */
        function completeProgress(redirectUrl) {
            // Detener simulación si está corriendo
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }

            // Completar rápidamente hasta 100%
            const completeInterval = setInterval(() => {
                currentProgress += 3;

                if (currentProgress >= 100) {
                    currentProgress = 100;
                    clearInterval(completeInterval);

                    updateProgress(100, '¡Completado!');

                    // Cambiar a estado completado
                    document.getElementById('loadingTitle').textContent = '¡Diseño Actualizado!';
                    document.getElementById('loadingSubtitle').textContent = 'Redirigiendo...';

                    // Agregar clase de completado
                    const progressBar = document.getElementById('progressBar');
                    if (progressBar) {
                        progressBar.classList.add('progress-complete');
                    }

                    // Redirigir después de mostrar el estado completado
                    setTimeout(() => {
                        window.location.href = redirectUrl;
                    }, 800);
                } else {
                    updateProgress(currentProgress, 'Finalizando...');
                }
            }, 20);
        }

        // Función para mostrar errores en los campos del formulario
        function showFieldErrors(errors) {
            // Limpiar errores anteriores
            document.querySelectorAll('.text-danger.small').forEach(el => {
                if (el.id && el.id.endsWith('-error')) {
                    el.style.display = 'none';
                    el.innerHTML = '';
                }
            });

            // Remover clases de error de los inputs
            document.querySelectorAll('.input.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });

            // Mostrar nuevos errores
            Object.keys(errors).forEach(fieldName => {
                const errorElement = document.getElementById(fieldName + '-error');
                if (errorElement) {
                    errorElement.innerHTML =
                        `<i class="fas fa-exclamation-triangle mr-1"></i>${errors[fieldName][0]}`;
                    errorElement.style.display = 'block';

                    // Agregar clase de error al input correspondiente
                    const inputElement = form.querySelector(`[name="${fieldName}"]`);
                    if (inputElement) {
                        inputElement.classList.add('is-invalid');
                    }
                }

                // Manejar el campo de imagen de manera especial
                if (fieldName === 'image') {
                    showImageError(errors[fieldName][0]);
                }
            });
        }

        // Validación del formulario con AJAX y spinner premium
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (isSubmitting) {
                return;
            }

            isSubmitting = true;
            isFormSubmitting = true;
            formChanged = false; // Evitar mensaje de beforeunload

            // 1. Deshabilitar botones y mostrar spinner
            disableAllButtons();

            // 2. Iniciar simulación de progreso (hasta 90%)
            startProgressSimulation(90);

            // 3. Preparar datos del formulario
            const formData = new FormData(form);

            // 4. Enviar por AJAX
            try {
                const response = await fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Éxito - completar progreso y redirigir
                    completeProgress(data.redirect || '{{ route('admin.designs.index') }}');
                } else {
                    // Error de validación o del servidor
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }

                    showProgressError(data.message || 'Error al actualizar el diseño');

                    // Mostrar errores de validación si existen
                    if (data.errors) {
                        setTimeout(() => {
                            hideLoadingState();
                            enableAllButtons();
                            isSubmitting = false;
                            isFormSubmitting = false;

                            // Mostrar errores en los campos del formulario
                            showFieldErrors(data.errors);

                            // Mostrar SweetAlert con los errores
                            const errorMessages = Object.values(data.errors).flat().join('<br>');
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de validación',
                                html: errorMessages,
                                confirmButtonColor: '#2563eb'
                            });
                        }, 2000);
                    } else {
                        // Si no hay errores específicos, solo ocultar después de 3 segundos
                        setTimeout(() => {
                            hideLoadingState();
                            enableAllButtons();
                            isSubmitting = false;
                            isFormSubmitting = false;
                        }, 3000);
                    }
                }
            } catch (error) {
                console.error('Error en la solicitud:', error);

                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }

                showProgressError('Error de conexión. Intenta de nuevo.');

                setTimeout(() => {
                    hideLoadingState();
                    enableAllButtons();
                    isSubmitting = false;
                    isFormSubmitting = false;
                }, 3000);
            }
        });

        // Manejar el botón de regresar para cancelar operación si está en progreso
        backBtn.addEventListener('click', function(e) {
            if (isSubmitting) {
                e.preventDefault();

                Swal.fire({
                    title: '¿Cancelar operación?',
                    text: 'El diseño se está actualizando. ¿Estás seguro de que quieres cancelar?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#2563eb',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Sí, cancelar',
                    cancelButtonText: 'Continuar actualizando'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Cancelar operación
                        isSubmitting = false;
                        isFormSubmitting = false;
                        enableAllButtons();
                        hideLoadingState();

                        // Redirigir
                        window.location.href = this.href;
                    }
                });
            }
        });

        // Restaurar botones y ocultar spinner si hay un error de validación del servidor
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                // Si la página se carga desde caché (error de validación), ocultar spinner
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;
            }
        });

        // También ocultar spinner cuando se cargue la página normalmente
        window.addEventListener('load', function() {
            // Pequeño delay para asegurar que todo esté cargado
            setTimeout(() => {
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;
            }, 500);
        });

        $('.btn-delete-variant').on('click', function() {
            const url = $(this).data('url');

            Swal.fire({
                title: '¿Eliminar variante?',
                text: "Esta acción no se puede deshacer.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                cancelButtonColor: '#6e7881',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true,
                customClass: {
                    popup: 'premium-swal-popup',
                    confirmButton: 'premium-swal-confirm',
                    cancelButton: 'premium-swal-cancel'
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    showLoadingState();
                    document.getElementById('loadingTitle').textContent = "Eliminando variante";
                    document.getElementById('loadingSubtitle').textContent = "Esto tomará solo un segundo";
                    document.getElementById('progressStatus').textContent = "Procesando...";

                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: {
                            _token: '{{ csrf_token() }}',
                            _method: 'DELETE'
                        },
                        success: function(response) {
                            // Simular progreso de eliminación
                            let progress = 0;
                            const deleteInterval = setInterval(() => {
                                progress += 2;
                                updateProgress(progress, `Eliminando... ${progress}%`);

                                if (progress >= 100) {
                                    clearInterval(deleteInterval);
                                    updateProgress(100, "¡Completado!");

                                    setTimeout(() => {
                                        hideLoadingState();
                                        window.location.reload();
                                    }, 500);
                                }
                            }, 30);
                        },
                        error: function(xhr) {
                            hideLoadingState();
                            Swal.fire({
                                icon: 'error',
                                title: '¡Error!',
                                text: xhr.responseJSON?.message ||
                                    'No se pudo eliminar la variante.',
                                confirmButtonColor: '#2563eb'
                            });
                        }
                    });
                }
            });
        });
    </script>

    @if (session('success'))
        <script>
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: "{{ session('success') }}",
                timer: 4000,
                showConfirmButton: false,
                customClass: {
                    popup: 'fade-in'
                }
            });
        </script>
    @endif

    @if (session('error'))
        <script>
            Swal.fire({
                icon: 'error',
                title: '¡Error!',
                text: "{{ session('error') }}",
                showConfirmButton: true,
                confirmButtonColor: '#2563eb',
                customClass: {
                    popup: 'shake'
                }
            });
        </script>
    @endif
@stop
</file>

<file path="resources/views/admin/material-conversions/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nueva Conversión - ' . $material->name)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    {{-- BREADCRUMB INFO --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.materials.index') }}">
                            <i class="fas fa-boxes"></i> Materiales
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.material-conversions.index', $material->id) }}">
                            {{ $material->name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Nueva Conversión</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-plus-circle"></i> NUEVA CONVERSIÓN DE UNIDAD
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.material-conversions.store', $material->id) }}">
                @csrf
                <input type="hidden" name="material_id" value="{{ $material->id }}">

                <div class="row">
                    {{-- COLUMNA izquierda --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-calculator"></i> Vista Previa
                            </h5>
                        </div>

                        {{-- INFO DEL MATERIAL --}}
                        <div class="card bg-light mb-3">
                            <div class="card-body py-3">
                                <h6 class="mb-2"><i class="fas fa-box text-primary"></i> Material</h6>
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td style="width: 120px;"><strong>Nombre:</strong></td>
                                        <td>{{ $material->name }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Categoría:</strong></td>
                                        <td>{{ $material->category->name ?? 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Unidad de Compra:</strong></td>
                                        <td>
                                            <span class="badge badge-success">
                                                {{ $material->baseUnit->name ?? 'N/A' }}
                                                ({{ $material->baseUnit->symbol ?? '' }})
                                            </span>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>


                        {{-- INFO ADICIONAL --}}
                        <div class="card bg-light mt-3">
                            <div class="card-body py-2">
                                <small>
                                    <i class="fas fa-info-circle text-info"></i>
                                    <strong>Información:</strong> Al guardar esta conversión, el sistema
                                    calculará automáticamente las cantidades en inventario basándose en
                                    las compras realizadas.
                                </small>
                            </div>
                        </div>

                        {{-- EJEMPLOS --}}
                        <div class="alert alert-secondary mt-3">
                            <strong><i class="fas fa-lightbulb"></i> Ejemplos comunes:</strong>
                            <ul class="mb-0 mt-2">
                                <li>1 Rollo de tela = <strong>50</strong> metros</li>
                                <li>1 Caja de hilos = <strong>12</strong> conos</li>
                                <li>1 Paquete de agujas = <strong>100</strong> piezas</li>
                            </ul>
                        </div>
                    </div>
                    {{-- COLUMNA derecha --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">
                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-exchange-alt"></i> Configurar Conversión
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Unidad de Compra <span class="text-danger">*</span></label>
                            <select name="from_unit_id" id="from_unit_id"
                                class="form-control @error('from_unit_id') is-invalid @enderror" required>
                                <option value="">Seleccionar unidad...</option>
                                @foreach ($purchaseUnits as $unit)
                                    @if (!in_array($unit->id, $usedUnitIds))
                                        <option value="{{ $unit->id }}" data-symbol="{{ $unit->symbol }}"
                                            {{ old('from_unit_id') == $unit->id ? 'selected' : '' }}>
                                            {{ $unit->name }} ({{ $unit->symbol }})
                                        </option>
                                    @endif
                                @endforeach
                            </select>
                            @error('from_unit_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">
                                Unidades compatibles con
                                <strong>{{ $material->category->baseUnit->name ?? 'N/A' }}</strong>
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Unidad de Inventario (Destino)</label>
                            <input type="hidden" name="to_unit_id" value="{{ $material->category->base_unit_id }}">
                            <div class="form-control bg-light" style="cursor: not-allowed;">
                                <span class="badge badge-info">
                                    {{ $material->category->baseUnit->name ?? 'N/A' }}
                                    ({{ $material->category->baseUnit->symbol ?? '' }})
                                </span>
                                <i class="fas fa-lock text-muted float-right mt-1"></i>
                            </div>
                            <small class="form-text text-muted">
                                Definida por la categoría del material. No editable.
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Factor de Conversión <span class="text-danger">*</span></label>
                            <input type="number" name="conversion_factor" id="conversion_factor"
                                class="form-control @error('conversion_factor') is-invalid @enderror"
                                value="{{ old('conversion_factor') }}" placeholder="Ej: 50" min="0.0001" max="999999999"
                                step="0.0001" required>
                            @error('conversion_factor')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">
                                ¿Cuántas <strong>{{ $material->category->baseUnit->symbol ?? 'unidades' }}</strong> hay en
                                1 unidad de compra?
                            </small>
                        </div>

                        {{-- PREVIEW DE CONVERSIÓN --}}
                        <div class="card border-primary" id="previewCard" style="display: none;">
                            <div class="card-header bg-primary text-white py-2">
                                <strong><i class="fas fa-eye"></i> Resultado de Conversión</strong>
                            </div>
                            <div class="card-body text-center py-4">
                                <h4 class="mb-0">
                                    <span class="badge badge-secondary" id="previewFrom">1 ?</span>
                                    <i class="fas fa-arrow-right mx-2 text-primary"></i>
                                    <span class="badge badge-success" id="previewTo">? unidades</span>
                                </h4>
                                <hr>
                                <p class="mb-0 text-muted">
                                    <small id="previewText">-</small>
                                </p>
                            </div>
                        </div>
                    </div>


                </div>

                <hr>

                <div class="text-center">
                    <a href="{{ route('admin.material-conversions.index', $material->id) }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            // Datos de la unidad base (destino) desde el servidor
            var toUnitName = '{{ $material->category->baseUnit->name ?? 'N/A' }}';
            var toUnitSymbol = '{{ $material->category->baseUnit->symbol ?? '' }}';

            function updatePreview() {
                var fromUnit = $('#from_unit_id option:selected');
                var factor = parseFloat($('#conversion_factor').val()) || 0;

                if (fromUnit.val() && factor > 0) {
                    var fromSymbol = fromUnit.data('symbol') || fromUnit.text();
                    var fromName = fromUnit.text().split('(')[0].trim();

                    $('#previewFrom').text('1 ' + fromSymbol);
                    $('#previewTo').text(factor.toFixed(2) + ' ' + toUnitSymbol);
                    $('#previewText').text('Al comprar 1 ' + fromName +
                        ', se registrarán ' + factor.toFixed(2) + ' ' + toUnitSymbol + ' en inventario');
                    $('#previewCard').show();
                } else {
                    $('#previewCard').hide();
                }
            }

            $('#from_unit_id, #conversion_factor').on('change keyup', updatePreview);

            // Trigger on load
            updatePreview();
        });
    </script>
@stop
</file>

<file path="resources/views/admin/material-conversions/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Conversión - ' . $material->name)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- BREADCRUMB INFO --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.materials.index') }}">
                            <i class="fas fa-boxes"></i> Materiales
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.material-conversions.index', $material->id) }}">
                            {{ $material->name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Eliminar Conversión</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="card card-danger">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-trash"></i> ELIMINAR CONVERSIÓN DE UNIDAD
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.material-conversions.destroy', [$material->id, $conversion->id]) }}">
                @csrf
                @method('DELETE')

                <div class="row">
                    {{-- INFO --}}
                    <div class="col-md-6 offset-md-3">
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <strong><i class="fas fa-exchange-alt"></i> Conversión a Eliminar</strong>
                            </div>
                            <div class="card-body text-center py-4">
                                <p class="mb-2"><strong>Material:</strong> {{ $material->name }}</p>
                                <hr>
                                <h4 class="mb-3">
                                    <span class="badge badge-secondary">
                                        1 {{ $conversion->fromUnit->name ?? 'N/A' }}
                                    </span>
                                    <i class="fas fa-arrow-right mx-2 text-primary"></i>
                                    <span class="badge badge-info">
                                        {{ number_format($conversion->conversion_factor, 2) }}
                                        {{ $conversion->toUnit->symbol ?? '' }}
                                    </span>
                                </h4>
                                <p class="text-muted mb-0">
                                    <code>{{ $conversion->display_conversion }}</code>
                                </p>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Advertencia:</strong><br>
                            Al eliminar esta conversión, no podrá registrar compras de este material
                            usando la unidad <strong>{{ $conversion->fromUnit->name ?? 'N/A' }}</strong>.
                            <br><br>
                            Las compras anteriores no se verán afectadas.
                        </div>
                    </div>
                </div>

                <div style="font-weight: bold;font-size: 25px;text-align: center;padding: 20px;">
                    ¿Deseas eliminar esta conversión?
                </div>

                <div class="text-center">
                    <a href="{{ route('admin.material-conversions.index', $material->id) }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                </div>
            </form>
        </div>
    </div>
@stop
</file>

<file path="resources/views/admin/material-conversions/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Conversión - ' . $material->name)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    {{-- BREADCRUMB INFO --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.materials.index') }}">
                            <i class="fas fa-boxes"></i> Materiales
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.material-conversions.index', $material->id) }}">
                            {{ $material->name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Editar Conversión</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="card card-warning">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-edit"></i> EDITAR CONVERSIÓN DE UNIDAD
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.material-conversions.update', [$material->id, $conversion->id]) }}">
                @csrf
                @method('PUT')
                <input type="hidden" name="material_id" value="{{ $material->id }}">

                <div class="row">

                    {{-- COLUMNA izquierda --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-calculator"></i> Vista Previa
                            </h5>
                        </div>
                        {{-- INFO DEL MATERIAL --}}
                        <div class="card bg-light mb-3">
                            <div class="card-body py-3">
                                <h6 class="mb-2"><i class="fas fa-box text-primary"></i> Material</h6>
                                <table class="table table-sm table-borderless mb-0">
                                    <tr>
                                        <td style="width: 120px;"><strong>Nombre:</strong></td>
                                        <td>{{ $material->name }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Categoría:</strong></td>
                                        <td>{{ $material->category->name ?? 'N/A' }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Unidad de Compra:</strong></td>
                                        <td>
                                            <span class="badge badge-success">
                                                {{ $material->baseUnit->name ?? 'N/A' }}
                                                ({{ $material->baseUnit->symbol ?? '' }})
                                            </span>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>



                        {{-- INFO --}}
                        <div class="card bg-light mt-3">
                            <div class="card-body py-2">
                                <small>
                                    <strong>Creado:</strong> {{ $conversion->created_at->format('d/m/Y H:i') }}<br>
                                    <strong>Actualizado:</strong> {{ $conversion->updated_at->format('d/m/Y H:i') }}
                                </small>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Advertencia:</strong> Modificar el factor de conversión no afecta compras anteriores,
                            solo las nuevas compras usarán el nuevo factor.
                        </div>
                    </div>

                    {{-- COLUMNA derecha --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">
                        <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #856404; font-weight: 600;">
                                <i class="fas fa-exchange-alt"></i> Configurar Conversión
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Unidad de Compra <span class="text-danger">*</span></label>
                            <select name="from_unit_id" id="from_unit_id"
                                class="form-control @error('from_unit_id') is-invalid @enderror" required>
                                <option value="">Seleccionar unidad...</option>
                                @foreach ($purchaseUnits as $unit)
                                    @if (!in_array($unit->id, $usedUnitIds) || $unit->id == $conversion->from_unit_id)
                                        <option value="{{ $unit->id }}" data-symbol="{{ $unit->symbol }}"
                                            {{ old('from_unit_id', $conversion->from_unit_id) == $unit->id ? 'selected' : '' }}>
                                            {{ $unit->name }} ({{ $unit->symbol }})
                                        </option>
                                    @endif
                                @endforeach
                            </select>
                            @error('from_unit_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">
                                Unidades compatibles con
                                <strong>{{ $material->category->baseUnit->name ?? 'N/A' }}</strong>
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Unidad de Inventario (Destino)</label>
                            <input type="hidden" name="to_unit_id" value="{{ $material->category->base_unit_id }}">
                            <div class="form-control bg-light" style="cursor: not-allowed;">
                                <span class="badge badge-info">
                                    {{ $material->category->baseUnit->name ?? 'N/A' }}
                                    ({{ $material->category->baseUnit->symbol ?? '' }})
                                </span>
                                <i class="fas fa-lock text-muted float-right mt-1"></i>
                            </div>
                            <small class="form-text text-muted">
                                Definida por la categoría del material. No editable.
                            </small>
                        </div>

                        <div class="form-group">
                            <label>Factor de Conversión <span class="text-danger">*</span></label>
                            <input type="number" name="conversion_factor" id="conversion_factor"
                                class="form-control @error('conversion_factor') is-invalid @enderror"
                                value="{{ old('conversion_factor', $conversion->conversion_factor) }}" min="0.0001"
                                max="999999999" step="0.0001" required>
                            @error('conversion_factor')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">
                                ¿Cuántas <strong>{{ $material->category->baseUnit->symbol ?? 'unidades' }}</strong> hay en
                                1 unidad de compra?
                            </small>
                        </div>

                        {{-- PREVIEW DE CONVERSIÓN --}}
                        <div class="card border-primary" id="previewCard" style="display: none;">
                            <div class="card-header bg-primary text-white py-2">
                                <strong><i class="fas fa-eye"></i> Resultado de Conversión</strong>
                            </div>
                            <div class="card-body text-center py-4">
                                <h4 class="mb-0">
                                    <span class="badge badge-secondary" id="previewFrom">1 ?</span>
                                    <i class="fas fa-arrow-right mx-2 text-primary"></i>
                                    <span class="badge badge-success" id="previewTo">? unidades</span>
                                </h4>
                                <hr>
                                <p class="mb-0 text-muted">
                                    <small id="previewText">-</small>
                                </p>
                            </div>
                        </div>
                    </div>

                </div>

                <hr>

                <div class="text-center">
                    <a href="{{ route('admin.material-conversions.index', $material->id) }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            // Datos de la unidad base (destino) desde el servidor
            var toUnitName = '{{ $material->category->baseUnit->name ?? 'N/A' }}';
            var toUnitSymbol = '{{ $material->category->baseUnit->symbol ?? '' }}';

            function updatePreview() {
                var fromUnit = $('#from_unit_id option:selected');
                var factor = parseFloat($('#conversion_factor').val()) || 0;

                if (fromUnit.val() && factor > 0) {
                    var fromSymbol = fromUnit.data('symbol') || fromUnit.text();
                    var fromName = fromUnit.text().split('(')[0].trim();

                    $('#previewFrom').text('1 ' + fromSymbol);
                    $('#previewTo').text(factor.toFixed(2) + ' ' + toUnitSymbol);
                    $('#previewText').text('Al comprar 1 ' + fromName +
                        ', se registrarán ' + factor.toFixed(2) + ' ' + toUnitSymbol + ' en inventario');
                    $('#previewCard').show();
                } else {
                    $('#previewCard').hide();
                }
            }

            $('#from_unit_id, #conversion_factor').on('change keyup', updatePreview);

            // Trigger on load para mostrar preview inicial
            updatePreview();
        });
    </script>
@stop
</file>

<file path="resources/views/admin/material-variants/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nueva Variante - ' . $material->name)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    {{-- BREADCRUMB INFO --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.materials.index') }}">
                            <i class="fas fa-boxes"></i> Materiales
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.material-variants.index', $material->id) }}">
                            {{ $material->name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Nueva Variante</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-plus-circle"></i> NUEVA VARIANTE DE: {{ $material->name }}
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.material-variants.store', $material->id) }}">
                @csrf
                <input type="hidden" name="material_id" value="{{ $material->id }}">

                <div class="row">
                    {{-- COLUMNA IZQUIERDA --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">
                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-barcode"></i> Identificación
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>SKU <span class="text-danger">*</span></label>
                            <input type="text" name="sku" class="form-control @error('sku') is-invalid @enderror"
                                value="{{ old('sku', $suggestedSku) }}" placeholder="Ej: TEL-MANT-001" maxlength="30"
                                style="text-transform: uppercase;" required>
                            @error('sku')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">
                                Código único. Solo mayúsculas, números y guiones.
                            </small>
                        </div>

                        @if ($material->has_color)
                            <div class="form-group">
                                <label>Color</label>
                                <input type="text" name="color"
                                    class="form-control @error('color') is-invalid @enderror" value="{{ old('color') }}"
                                    placeholder="Ej: Blanco, Rojo, Azul Marino" maxlength="50">
                                @error('color')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">
                                    Color o variación del material
                                </small>
                            </div>
                        @else
                            <input type="hidden" name="color" value="">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                Este material no maneja variantes de color.
                            </div>
                        @endif
                    </div>

                    {{-- COLUMNA DERECHA --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-warehouse"></i> Configuración de Inventario
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Stock Mínimo (Alerta) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="min_stock_alert"
                                    class="form-control @error('min_stock_alert') is-invalid @enderror"
                                    value="{{ old('min_stock_alert', 0) }}" min="0" max="999999" step="0.01"
                                    required>
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        {{ $material->category->baseUnit->symbol ?? 'unidad' }}
                                    </span>
                                </div>
                                @error('min_stock_alert')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                            <small class="form-text text-muted">
                                Se alertará cuando el stock sea igual o menor a este valor
                            </small>
                        </div>

                        {{-- INFO --}}
                        <div class="card bg-light mt-4">
                            <div class="card-body py-3">
                                <h6 class="mb-2"><i class="fas fa-info-circle text-info"></i> Información</h6>
                                <small>
                                    <strong>Material:</strong> {{ $material->name }}<br>
                                    <strong>Categoría:</strong> {{ $material->category->name ?? 'N/A' }}<br>
                                    <strong>Unidad:</strong> {{ $material->category->baseUnit->name ?? 'N/A' }}
                                    ({{ $material->category->baseUnit->symbol ?? '' }})<br>
                                    @if ($material->composition)
                                        <strong>Composición:</strong> {{ $material->composition }}
                                    @endif
                                </small>
                            </div>
                        </div>

                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Nota:</strong> El stock inicial será 0.
                            Use el módulo de <strong>Compras</strong> para registrar entradas de inventario.
                        </div>
                    </div>
                </div>

                <hr>

                <div class="text-center">
                    <a href="{{ route('admin.material-variants.index', $material->id) }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            // Convertir SKU a mayúsculas en tiempo real
            $('input[name="sku"]').on('input', function() {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9\-]/g, '');
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/material-variants/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Variante - ' . $variant->sku)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- BREADCRUMB INFO --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.materials.index') }}">
                            <i class="fas fa-boxes"></i> Materiales
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.material-variants.index', $material->id) }}">
                            {{ $material->name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Eliminar: {{ $variant->sku }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="card card-danger">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-trash"></i> ELIMINAR VARIANTE: {{ $variant->sku }}
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.material-variants.destroy', [$material->id, $variant->id]) }}">
                @csrf
                @method('DELETE')

                <div class="row">
                    {{-- COLUMNA IZQUIERDA --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">
                        <div style="border-bottom: 3px solid #dc3545; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #dc3545; font-weight: 600;">
                                <i class="fas fa-barcode"></i> Identificación
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Material</label>
                            <input type="text" class="form-control" value="{{ $material->name }}" disabled>
                        </div>

                        <div class="form-group">
                            <label>SKU</label>
                            <input type="text" class="form-control font-weight-bold" value="{{ $variant->sku }}"
                                disabled>
                        </div>

                        <div class="form-group">
                            <label>Color</label>
                            <input type="text" class="form-control" value="{{ $variant->color ?? '-' }}" disabled>
                        </div>
                    </div>

                    {{-- COLUMNA DERECHA --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #6c757d; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #6c757d; font-weight: 600;">
                                <i class="fas fa-warehouse"></i> Estado del Inventario
                            </h5>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Stock Actual</label>
                                    <input type="text" class="form-control"
                                        value="{{ number_format($variant->current_stock, 2) }} {{ $material->category->baseUnit->symbol ?? '' }}"
                                        disabled>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Valor Total</label>
                                    <input type="text" class="form-control"
                                        value="${{ number_format($variant->current_value, 2) }}" disabled>
                                </div>
                            </div>
                        </div>

                        @if ($variant->current_stock > 0)
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i>
                                <strong>No se puede eliminar.</strong><br>
                                Esta variante tiene stock disponible ({{ number_format($variant->current_stock, 2) }}
                                {{ $material->category->baseUnit->symbol ?? '' }}).
                                <br><br>
                                Debe consumir o ajustar el inventario antes de eliminar.
                            </div>
                        @else
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Advertencia:</strong> Esta acción desactivará la variante.
                                El historial de movimientos se conservará para auditoría.
                            </div>
                        @endif
                    </div>
                </div>

                <div style="font-weight: bold;font-size: 25px;text-align: center;padding: 20px;">
                    ¿Deseas eliminar esta variante?
                </div>

                <div class="text-center">
                    <a href="{{ route('admin.material-variants.index', $material->id) }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    @if ($variant->current_stock <= 0)
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    @else
                        <button type="button" class="btn btn-danger" disabled title="Tiene stock disponible">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    @endif
                </div>
            </form>
        </div>
    </div>
@stop
</file>

<file path="resources/views/admin/material-variants/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Variante - ' . $variant->sku)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    {{-- BREADCRUMB INFO --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.materials.index') }}">
                            <i class="fas fa-boxes"></i> Materiales
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.material-variants.index', $material->id) }}">
                            {{ $material->name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Editar: {{ $variant->sku }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="card card-warning">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-edit"></i> EDITAR VARIANTE: {{ $variant->sku }}
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.material-variants.update', [$material->id, $variant->id]) }}">
                @csrf
                @method('PUT')
                <input type="hidden" name="material_id" value="{{ $material->id }}">

                <div class="row">
                    {{-- COLUMNA IZQUIERDA --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">
                        <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #856404; font-weight: 600;">
                                <i class="fas fa-barcode"></i> Identificación
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>SKU <span class="text-danger">*</span></label>
                            <input type="text" name="sku" class="form-control @error('sku') is-invalid @enderror"
                                value="{{ old('sku', $variant->sku) }}" maxlength="30" style="text-transform: uppercase;"
                                required>
                            @error('sku')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        @if ($material->category->has_color ?? false)
                            <div class="form-group">
                                <label>Color</label>
                                <input type="text" name="color"
                                    class="form-control @error('color') is-invalid @enderror"
                                    value="{{ old('color', $variant->color) }}" maxlength="50">
                                @error('color')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        @else
                            <input type="hidden" name="color" value="">
                        @endif

                        <div class="form-group">
                            <label>Stock Mínimo (Alerta) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="number" name="min_stock_alert"
                                    class="form-control @error('min_stock_alert') is-invalid @enderror"
                                    value="{{ old('min_stock_alert', $variant->min_stock_alert) }}" min="0"
                                    max="999999" step="0.01" required>
                                <div class="input-group-append">
                                    <span class="input-group-text">
                                        {{ $material->category->baseUnit->symbol ?? 'unidad' }}
                                    </span>
                                </div>
                                @error('min_stock_alert')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>
                    </div>

                    {{-- COLUMNA DERECHA --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #17a2b8; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #17a2b8; font-weight: 600;">
                                <i class="fas fa-chart-bar"></i> Estado del Inventario
                            </h5>
                        </div>

                        {{-- INFO DE STOCK (Solo lectura) --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Stock Actual</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control font-weight-bold"
                                            value="{{ number_format($variant->current_stock, 2) }}" disabled>
                                        <div class="input-group-append">
                                            <span class="input-group-text">
                                                {{ $material->category->baseUnit->symbol ?? '' }}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Valor Total</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <input type="text" class="form-control font-weight-bold"
                                            value="{{ number_format($variant->current_value, 2) }}" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Costo Promedio</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <input type="text" class="form-control"
                                            value="{{ number_format($variant->average_cost, 2) }}" disabled>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Última Compra</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">$</span>
                                        </div>
                                        <input type="text" class="form-control"
                                            value="{{ number_format($variant->last_purchase_cost, 2) }}" disabled>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{-- INFO --}}
                        <div class="card bg-light mt-2">
                            <div class="card-body py-2">
                                <small>
                                    <strong>UUID:</strong> <code>{{ $variant->uuid }}</code><br>
                                    <strong>Creado:</strong> {{ $variant->created_at->format('d/m/Y H:i') }}<br>
                                    <strong>Actualizado:</strong> {{ $variant->updated_at->format('d/m/Y H:i') }}
                                </small>
                            </div>
                        </div>

                        <div class="alert alert-info mt-2 mb-0">
                            <i class="fas fa-info-circle"></i>
                            <small>El stock y costos se actualizan desde el módulo de <strong>Compras</strong>.</small>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="text-center">
                    <a href="{{ route('admin.material-variants.index', $material->id) }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            $('input[name="sku"]').on('input', function() {
                this.value = this.value.toUpperCase().replace(/[^A-Z0-9\-]/g, '');
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/materials/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Material')

@section('content_header')
@stop

@section('content')
    <br>

    <div class="card card-danger">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-trash"></i> ELIMINAR MATERIAL
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.materials.destroy', $material->id) }}">
                @csrf
                @method('DELETE')

                <div class="row">
                    {{-- COLUMNA IZQUIERDA --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">
                        <div style="border-bottom: 3px solid #dc3545; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #dc3545; font-weight: 600;">
                                <i class="fas fa-box"></i> Datos del Material
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Categoría</label>
                            <input type="text" class="form-control" value="{{ $material->category->name ?? 'N/A' }}"
                                disabled>
                        </div>

                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" class="form-control" value="{{ $material->name }}" disabled>
                        </div>

                        <div class="form-group">
                            <label>Composición</label>
                            <input type="text" class="form-control" value="{{ $material->composition ?? '-' }}" disabled>
                        </div>
                    </div>

                    {{-- COLUMNA DERECHA --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #6c757d; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #6c757d; font-weight: 600;">
                                <i class="fas fa-info-circle"></i> Información
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Descripción</label>
                            <textarea class="form-control" rows="3" disabled>{{ $material->description ?? '-' }}</textarea>
                        </div>

                        <div class="form-group">
                            <label>Variantes Activas</label>
                            <input type="text" class="form-control" value="{{ $material->active_variants_count }}"
                                disabled>
                        </div>

                        @if ($material->active_variants_count > 0)
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Advertencia:</strong> Este material tiene variantes activas.
                                No podrá ser eliminado hasta que se desactiven.
                            </div>
                        @endif
                    </div>
                </div>

                <div style="font-weight: bold;font-size: 25px;text-align: center;padding: 20px;">
                    ¿Deseas eliminar este material?
                </div>

                <div class="text-center">
                    <a href="{{ route('admin.materials.index') }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    @if ($material->active_variants_count == 0)
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    @else
                        <button type="button" class="btn btn-danger" disabled title="Tiene variantes activas">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    @endif
                </div>
            </form>
        </div>
    </div>
@stop
</file>

<file path="resources/views/admin/materials/partials/table_rows.blade.php">
@foreach ($materials as $material)
    <tr>
        <td>{{ $loop->iteration }}</td>
        <td>
            <span class="badge badge-primary">{{ $material->category->name ?? 'N/A' }}</span>
        </td>
        <td>
            <strong>{{ $material->name }}</strong>
            @if ($material->description)
                <br><small style="color: #333;">{{ Str::limit($material->description, 50) }}</small>
            @endif
        </td>

        <td>{{ $material->composition ?? '-' }}</td>
        <td>
            <span class="badge badge-secondary" style="font-size: 14px; padding: 6px 10px;">
                {{ $material->baseUnit->symbol ?? 'N/A' }}
            </span>
        </td>
        <td class="text-center">
            @if ($material->has_color)
                <span class="badge badge-info" style="font-size: 14px; padding: 6px 10px;">
                    {{ $material->active_variants_count }}
                </span>
            @else
                <span class="text-muted">-</span>
            @endif
        </td>

        <td class="text-center align-middle">
            <div class="d-flex justify-content-center align-items-center gap-1">
                {{-- Botón Variantes --}}
                <a href="{{ route('admin.material-variants.index', $material->id) }}"
                    class="btn btn-info btn-sm d-flex align-items-center justify-content-center"
                    style="width: 32px; height: 32px;" title="Ver Variantes">
                    <i class="fas fa-palette"></i>
                </a>

                {{-- Botón Conversiones --}}
                <a href="{{ route('admin.material-conversions.index', $material->id) }}"
                    class="btn btn-secondary btn-sm d-flex align-items-center justify-content-center"
                    style="width: 32px; height: 32px;" title="Conversiones">
                    <i class="fas fa-exchange-alt"></i>
                </a>

                {{-- Botón Editar --}}
                <a href="{{ route('admin.materials.edit', $material->id) }}"
                    class="btn btn-warning btn-sm d-flex align-items-center justify-content-center"
                    style="width: 32px; height: 32px;" title="Editar">
                    <i class="fas fa-edit text-white"></i>
                </a>

                {{-- Botón Eliminar --}}
                <a href="{{ route('admin.materials.confirm_delete', $material->id) }}"
                    class="btn btn-danger btn-sm d-flex align-items-center justify-content-center"
                    style="width: 32px; height: 32px;" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </a>
            </div>
        </td>
    </tr>
@endforeach
</file>

<file path="resources/views/admin/produccion/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nueva Producción')

@section('plugins.Select2', true)

@section('content_header')
    <h1>Nueva Producción</h1>
@stop

@section('content')
    <div class="container-fluid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Registrar Nueva Producción</h3>
            </div>
            <div class="card-body">
                <form action="{{ route('admin.production.store') }}" method="POST" enctype="multipart/form-data">
                    @csrf

                    <div class="form-group">
                        <label for="design_id">Diseño</label>
                        <select name="design_id" id="design_id" class="form-control select2" style="width: 100%;">
                            <option value="">Seleccione un diseño...</option>
                            @foreach ($designs as $design)
                                <option value="{{ $design->id }}">
                                    {{ $design->name }} ({{ $design->sku }})
                                </option>
                            @endforeach
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="file">Archivo de Bordado (Opcional)</label>
                        <input type="file" name="file" id="file" class="form-control-file">
                        <small class="form-text text-muted">Suba el archivo .dst, .emb, o similar si dispone de él.</small>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notas / Observaciones</label>
                        <textarea name="notes" id="notes" class="form-control" rows="3" placeholder="Detalles adicionales..."></textarea>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> Guardar Producción
                        </button>
                        <a href="{{ route('admin.production.index') }}" class="btn btn-secondary">
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(document).ready(function() {
            $('.select2').select2({
                theme: 'bootstrap4',
                placeholder: 'Seleccione un diseño...'
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/produccion/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Producción')

@section('plugins.Select2', true)

@section('content_header')
    <h1>Editar Producción #{{ $export->id }}</h1>
@stop

@section('content')
    <div class="container-fluid">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Editar Información</h3>
            </div>
            <div class="card-body">
                <form action="{{ route('admin.production.update', $export->id) }}" method="POST"
                    enctype="multipart/form-data">
                    @csrf
                    @method('PUT')

                    <div class="form-group">
                        <label for="design_id">Diseño</label>
                        {{-- Assuming we pass $designs to edit view as well. Controller needs update --}}
                        <select name="design_id" id="design_id" class="form-control select2" style="width: 100%;">
                            {{-- We need designs list here. Controller update required --}}
                            <option value="{{ $export->design_id }}" selected>
                                {{ $export->design->name ?? 'Diseño actual' }} ({{ $export->design->sku ?? '' }})
                            </option>
                        </select>
                        <small class="text-muted">El diseño no se puede cambiar fácilmente en esta vista simplificada. (Para
                            cambiar, cree una nueva).</small>
                    </div>

                    <div class="form-group">
                        <label for="file">Archivo de Bordado (Reemplazar)</label>
                        <input type="file" name="file" id="file" class="form-control-file">
                        @if ($export->file_path)
                            <small class="d-block mt-1">Archivo actual: {{ $export->file_name }}</small>
                        @endif
                    </div>

                    <div class="form-group">
                        <label for="notes">Notas / Observaciones</label>
                        <textarea name="notes" id="notes" class="form-control" rows="3">{{ $export->notes }}</textarea>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save mr-1"></i> Actualizar
                        </button>
                        <a href="{{ route('admin.production.index') }}" class="btn btn-secondary">
                            Cancelar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(document).ready(function() {
            $('.select2').select2({
                theme: 'bootstrap4'
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/produccion/preview_explorer.blade.php">
@extends('adminlte::page')

@section('title', 'Explorador de Bordado')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center w-100 explorer-header">
        <h1 class="m-0 explorer-title">
            <i class="fas fa-search-plus text-success mr-2"></i>Escáner Técnico
        </h1>
        <a href="javascript:void(0)" onclick="window.close()" class="btn-premium-close shadow-sm">
            <i class="fas fa-times-circle"></i>
            <span class="ml-2">Cerrar Vista</span>
        </a>
    </div>
@stop

@section('content')
    <div class="container-fluid">
        <div class="card shadow-lg border-0" style="border-radius: 16px; overflow: hidden;">
            <div class="card-header bg-white border-0 py-3">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0" style="font-weight: 700; color: #374151;">
                            {{ $export->variant->name ?? ($export->design->name ?? 'Diseño sin nombre') }}
                        </h5>
                        <p class="text-muted small mb-0">ID: PRD-{{ str_pad($export->id, 3, '0', STR_PAD_LEFT) }} |
                            {{ $export->stitches_count }} puntadas</p>
                    </div>
                    <div class="col-auto">
                        <div class="d-flex">
                            <a href="{{ route('admin.production.preview', $export->id) }}?download=1"
                                class="btn btn-premium-download-alt mr-2 shadow-sm">
                                <i class="fas fa-file-download"></i>
                                <span class="d-none d-md-inline ml-2">SVG</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body p-0 position-relative"
                style="background-color: #f8fafc; height: 80vh; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                {{-- Technical Canvas Background --}}
                <div
                    style="position: absolute; top:0; left:0; width:100%; height:100%; 
                     background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
                     background-size: 20px 20px; opacity: 0.5; pointer-events: none;">
                </div>

                <div id="zoomContainer" class="zoom-container"
                    style="cursor: grab; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <div id="zoomWrapper" class="zoom-wrapper"
                        style="transition: transform 0.1s ease-out; transform-origin: center; display: flex; justify-content: center; align-items: center;">
                        {!! $svgContent !!}
                    </div>
                </div>

                {{-- Controles Flotantes --}}
                <div class="zoom-controls">
                    <button type="button" class="zoom-btn" id="btnZoomIn" title="Acercar (Rueda Arriba)">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <button type="button" class="zoom-btn" id="btnZoomOut" title="Alejar (Rueda Abajo)">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button type="button" class="zoom-btn" id="btnZoomReset" title="Restaurar Vista">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                {{-- Pantalla de Ayuda (Overlay) --}}
                <div id="panningHint"
                    style="position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.6); color: white; padding: 10px 15px; border-radius: 80px; font-size: 12px; backdrop-filter: blur(4px); pointer-events: none; transition: opacity 0.3s;">
                    <i class="fas fa-mouse mr-2 text-success"></i>Usa la <strong>rueda del mouse</strong> para zoom y
                    <strong>arrastra</strong> para mover
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        .zoom-controls {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 12px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .zoom-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #374151;
            font-size: 18px;
        }

        .zoom-btn:hover {
            background: #f0fdf4;
            border-color: #10b981;
            color: #10b981;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
        }

        .zoom-wrapper svg {
            max-width: 90vw;
            max-height: 70vh;
            filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.15));
            user-select: none;
            pointer-events: none;
            /* Dejar que el contenedor maneje el arrastre */
        }

        #zoomContainer:active {
            cursor: grabbing;
        }

        /* Botón Premium Close Responsivo - SaaS Luxury Style */
        .btn-premium-close {
            background: #ffffff !important;
            color: #2563eb !important;
            border: 2px solid #eff6ff !important;
            border-radius: 14px !important;
            font-weight: 700 !important;
            padding: 12px 24px !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03) !important;
            text-decoration: none !important;
            white-space: nowrap;
        }

        .btn-premium-close:hover {
            background: #2563eb !important;
            color: #ffffff !important;
            border-color: #2563eb !important;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.3) !important;
        }

        .btn-premium-close i {
            font-size: 1.2rem;
        }

        .explorer-title {
            font-weight: 800;
            color: #111827;
            font-size: 1.5rem !important;
        }

        /* Botón Descarga Secundario */
        .btn-premium-download-alt {
            background: #f8fafc !important;
            color: #475569 !important;
            border: 1px solid #e2e8f0 !important;
            border-radius: 10px !important;
            font-weight: 600 !important;
            padding: 8px 16px !important;
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            transition: all 0.2s;
            text-decoration: none !important;
        }

        .btn-premium-download-alt:hover {
            background: #f1f5f9 !important;
            color: #1e293b !important;
            border-color: #cbd5e1 !important;
            transform: translateY(-1px);
        }

        .btn-premium-close i {
            font-size: 1.1rem;
        }

        /* Ajustes Responsivos para Web App */
        @media (max-width: 768px) {
            .explorer-header {
                padding: 15px 0 !important;
            }

            .explorer-title {
                font-size: 1.15rem !important;
            }

            .btn-premium-close {
                padding: 10px 18px !important;
                font-size: 0.9rem !important;
                border-radius: 12px !important;
            }

            .btn-premium-close span {
                display: none;
            }

            .btn-premium-close i {
                margin: 0 !important;
                font-size: 1.3rem;
            }
        }

        @media (max-width: 480px) {
            .explorer-title {
                display: flex;
                align-items: center;
            }

            .explorer-title span {
                display: none;
            }
        }

        @media (max-width: 576px) {
            .container-fluid {
                padding: 0 5px !important;
            }

            .card-body {
                height: 70vh !important;
            }
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            let currentScale = 1;
            let isDragging = false;
            let startX, startY, transX = 0,
                transY = 0;

            function updateTransform() {
                $('#zoomWrapper').css('transform', `scale(${currentScale}) translate(${transX}px, ${transY}px)`);

                // Mostrar/Ocultar hint de paneo
                if (currentScale > 1) {
                    $('#panningHint').css('opacity', '1');
                } else {
                    $('#panningHint').css('opacity', '0.7');
                }
            }

            // Zoom In/Out
            $('#btnZoomIn').on('click', () => {
                currentScale = Math.min(currentScale + 0.5, 8);
                updateTransform();
            });
            $('#btnZoomOut').on('click', () => {
                currentScale = Math.max(currentScale - 0.5, 0.5);
                updateTransform();
            });
            $('#btnZoomReset').on('click', () => {
                currentScale = 1;
                transX = 0;
                transY = 0;
                updateTransform();
            });

            // Wheel Zoom
            $('#zoomContainer').on('wheel', function(e) {
                e.preventDefault();
                const delta = e.originalEvent.deltaY;
                currentScale = delta > 0 ? Math.max(currentScale - 0.2, 0.5) : Math.min(currentScale + 0.2,
                    8);
                updateTransform();
            });

            // Dragging (Pan)
            $('#zoomContainer').on('mousedown', function(e) {
                if (currentScale > 1) {
                    isDragging = true;
                    startX = e.pageX - transX;
                    startY = e.pageY - transY;
                    $(this).css('cursor', 'grabbing');
                }
            });

            $(window).on('mousemove', function(e) {
                if (isDragging) {
                    transX = e.pageX - startX;
                    transY = e.pageY - startY;
                    updateTransform();
                }
            }).on('mouseup', function() {
                isDragging = false;
                $('#zoomContainer').css('cursor', currentScale > 1 ? 'grab' : 'default');
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/produccion/show.blade.php">
@extends('adminlte::page')

@section('title', 'Detalles de Producción')

@section('content_header')
    <h1>Detalles de Producción #{{ $export->id }}</h1>
@stop

@section('content')
    <div class="container-fluid">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="card-title">
                    Diseño: <strong>{{ $export->design->name ?? 'N/A' }}</strong>
                </h3>
                <span
                    class="badge badge-{{ $export->status == 'aprobado' ? 'success' : ($export->status == 'pendiente' ? 'warning' : 'secondary') }}">
                    {{ ucfirst($export->status) }}
                </span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>SKU:</strong> {{ $export->design->sku ?? 'N/A' }}<br>
                        <strong>Creado por:</strong> {{ $export->creator->name ?? 'N/A' }}<br>
                        <strong>Fecha:</strong> {{ strtoupper($export->created_at->translatedFormat('d M Y - H:i')) }}<br>
                        <hr>
                        <strong>Notas:</strong>
                        <p>{{ $export->notes ?? 'Sin notas.' }}</p>
                    </div>
                    <div class="col-md-6">
                        @if ($export->file_path)
                            <div class="alert alert-info">
                                <h5><i class="icon fas fa-file"></i> Archivo Adjunto</h5>
                                Nombre: {{ $export->file_name }} <br>
                                Tamaño: {{ round($export->file_size / 1024, 2) }} KB <br>
                                {{-- Link to download/view if public --}}
                                <a href="{{ asset('storage/' . $export->file_path) }}" target="_blank"
                                    class="btn btn-light mt-2">
                                    <i class="fas fa-download"></i> Descargar / Ver
                                </a>
                            </div>
                        @else
                            <div class="alert alert-warning">
                                No hay archivo adjunto.
                            </div>
                        @endif
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="{{ route('admin.production.index') }}" class="btn btn-secondary">Volver</a>
                <a href="{{ route('admin.production.edit', $export->id) }}" class="btn btn-primary">Editar</a>
            </div>
        </div>
    </div>
@stop
</file>

<file path="resources/views/admin/product_categories/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nueva Categoría de Producto')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVA CATEGORÍA DE PRODUCTO</h3>
            </div>

            <div class="card-body">
                <form method="post" action="{{ route('admin.product_categories.store') }}">
                    @csrf
                    @method('POST')

                    <div class="row">
                        <div class="col-12">

                            <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                                <h5 style="color: #007bff; font-weight: 600;">
                                    <i class="fas fa-tag"></i> Datos de la Categoría
                                </h5>
                            </div>

                            {{-- Nombre --}}
                            <div class="form-group">
                                <label>Nombre de la Categoría <span style="color: red;">*</span></label>
                                <input type="text" name="name"
                                    class="form-control form-control-sm @error('name') is-invalid @enderror"
                                    value="{{ old('name') }}" required placeholder="Ej: Playeras, Camisas, Gorras...">
                                @error('name')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            {{-- Descripción --}}
                            <div class="form-group">
                                <label>Descripción</label>
                                <textarea name="description" class="form-control form-control-sm @error('description') is-invalid @enderror"
                                    rows="3" placeholder="Descripción opcional de la categoría...">{{ old('description') }}</textarea>
                                @error('description')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            {{-- Estado Activo (Hidden: Default True) --}}
                            <input type="hidden" name="is_active" value="1">

                            {{-- Botones --}}
                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <a href="{{ route('admin.product_categories.index') }}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('css')
@stop

@section('js')
    <script>
        console.log("ProductCategory Create View");
    </script>
@stop
</file>

<file path="resources/views/admin/product_categories/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Categoría')

@section('content_header')
@stop

@section('content')
    <br>

    <div class="card card-danger">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold; font-size: 20px;"> ELIMINAR CATEGORÍA DE PRODUCTO</h3>
        </div>

        <div class="card-body">
            <div class="row">
                <div class="col-md-8 offset-md-2">

                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle"></i> ¡Atención!</h5>
                        <p>Está a punto de eliminar la siguiente categoría:</p>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <table class="table table-bordered">
                                <tr>
                                    <th style="width: 200px;">Nombre:</th>
                                    <td><strong>{{ $category->name }}</strong></td>
                                </tr>
                                <tr>
                                    <th>Descripción:</th>
                                    <td>{{ $category->description ?? '-' }}</td>
                                </tr>
                                <tr>
                                    <th>Productos Asociados:</th>
                                    <td>
                                        @if ($category->products_count > 0)
                                            <span class="badge badge-danger">{{ $category->products_count }}</span>
                                            <span class="text-danger ml-2">No se puede eliminar</span>
                                        @else
                                            <span class="badge badge-success">0</span>
                                        @endif
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    @if ($category->products_count > 0)
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-exclamation-circle"></i>
                            Esta categoría tiene <strong>{{ $category->products_count }} producto(s)</strong> asociado(s).
                            Debe reasignar o eliminar los productos primero.
                        </div>
                    @else
                        <p class="text-center text-muted mt-3">
                            Esta acción no se puede deshacer. ¿Está seguro que desea continuar?
                        </p>
                    @endif

                    <div class="text-center mt-4">
                        <a href="{{ route('admin.product_categories.index') }}" class="btn btn-secondary">
                            <i class="fas fa-times-circle"></i> Cancelar
                        </a>
                        @if ($category->products_count == 0)
                            <form id="deleteForm" action="{{ route('admin.product_categories.destroy', $category->id) }}"
                                method="POST" class="d-inline">
                                @csrf
                                @method('DELETE')
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash-alt"></i> Sí, Eliminar
                                </button>
                            </form>
                        @endif
                    </div>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
@stop

@section('js')
    <script>
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();

            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡Eliminarás esta categoría y su contenido asociado!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', // Rojo
                cancelButtonColor: '#6c757d', // Gris
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/product_categories/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Categoría de Producto')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-warning">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold; font-size: 20px;"> EDITAR CATEGORÍA DE PRODUCTO</h3>
            </div>

            <div class="card-body">
                <form method="post" action="{{ route('admin.product_categories.update', $category->id) }}">
                    @csrf
                    @method('PUT')

                    <div class="row">
                        <div class="col-12">

                            <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                                <h5 style="color: #ffc107; font-weight: 600;">
                                    <i class="fas fa-edit"></i> Datos de la Categoría
                                </h5>
                            </div>

                            {{-- Nombre --}}
                            <div class="form-group">
                                <label>Nombre de la Categoría <span style="color: red;">*</span></label>
                                <input type="text" name="name"
                                    class="form-control form-control-sm @error('name') is-invalid @enderror"
                                    value="{{ old('name', $category->name) }}" required
                                    placeholder="Ej: Playeras, Camisas, Gorras...">
                                @error('name')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            {{-- Descripción --}}
                            <div class="form-group">
                                <label>Descripción</label>
                                <textarea name="description" class="form-control form-control-sm @error('description') is-invalid @enderror"
                                    rows="3" placeholder="Descripción opcional de la categoría...">{{ old('description', $category->description) }}</textarea>
                                @error('description')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            {{-- Estado Activo (Hidden: Default True) --}}
                            <input type="hidden" name="is_active" value="1">

                            {{-- Botones --}}
                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <a href="{{ route('admin.product_categories.index') }}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save"></i> Actualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('css')
@stop

@section('js')
    <script>
        console.log("ProductCategory Edit View");
    </script>
@stop
</file>

<file path="resources/views/admin/product_extras/index.blade.php">
@extends('adminlte::page')

@section('title', 'Extras de Productos')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary">

        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> EXTRAS DE PRODUCTOS</h3>
        </div>

        <div class="card-body">
            <div class="row">
                <a href="{{ route('admin.product_extras.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i></a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Costo</th>
                                <th>Precio</th>
                                <th>Tiempo</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach ($extras as $extra)
                                <tr>
                                    <td>{{ $loop->iteration }}</td>
                                    <td>{{ $extra->name }}</td>
                                    <td>${{ number_format($extra->cost_addition, 2) }}</td>
                                    <td>${{ number_format($extra->price_addition, 2) }}</td>
                                    <td>{{ $extra->formatted_minutes }}</td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center align-items-center gap-1">
                                            <a href="{{ route('admin.product_extras.edit', $extra->id) }}"
                                                class="btn btn-warning btn-sm" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <a href="{{ route('admin.product_extras.confirm_delete', $extra->id) }}"
                                                class="btn btn-danger btn-sm" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            @endforeach

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        #example1_wrapper .btn {
            color: #fff;
            border-radius: 4px;
            padding: 5px 15px;
            font-size: 14px;
        }

        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay información",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Extras",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Extras",
                    "infoFiltered": "(Filtrado de _MAX_ total Extras)",
                    "lengthMenu": "Mostrar _MENU_ Extras",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/proveedores/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Proveedor')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="card card-warning">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;  font-size: 20px;"> EDITAR PROVEEDOR</h3>
        </div>

        <div class="card-body">
            <form method="post" action="{{ route('admin.proveedores.update', $proveedor->id) }}">
                @csrf
                @method('PUT')

                <div class="row">
                    {{-- DATOS DEL PROVEEDOR --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">

                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-building"></i> Datos del Proveedor
                            </h5>
                        </div>

                        {{-- Nombre --}}
                        <div class="form-group">
                            <label>Nombre Proveedor <span style="color: red;">*</span></label>
                            <input type="text" name="nombre_proveedor"
                                class="form-control form-control-sm @error('nombre_proveedor') is-invalid @enderror"
                                value="{{ old('nombre_proveedor', $proveedor->nombre_proveedor) }}" required
                                placeholder="Nombre del proveedor">
                            @error('nombre_proveedor')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        {{-- Giro --}}
                        <div class="form-group">
                            <label>Giro <span style="color: red;">*</span></label>
                            <select name="giro_id"
                                class="form-control form-control-sm @error('giro_id') is-invalid @enderror" required>
                                <option value="">Selecciona un Giro</option>
                                @foreach ($giros as $giro)
                                    <option value="{{ $giro->id }}"
                                        {{ old('giro_id', $proveedor->giro_id) == $giro->id ? 'selected' : '' }}>
                                        {{ $giro->nombre_giro }}
                                    </option>
                                @endforeach
                            </select>
                            @error('giro_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        {{-- Dirección --}}
                        <div class="row">
                            <div class="col-md-10">
                                <div class="form-group">
                                    <label>Dirección</label>
                                    <input type="text" name="direccion" class="form-control form-control-sm"
                                        value="{{ old('direccion', $proveedor->direccion) }}" placeholder="Dirección">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>C.P.</label>
                                    <input type="text" name="codigo_postal"
                                        class="form-control form-control-sm @error('codigo_postal') is-invalid @enderror"
                                        value="{{ old('codigo_postal', $proveedor->codigo_postal) }}" placeholder="C.P"
                                        maxlength="5" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                        pattern="[0-9]{5}">
                                    @error('codigo_postal')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Teléfono y correo --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Teléfono <span style="color: red;">*</span></label>
                                    <input type="tel" name="telefono"
                                        class="form-control form-control-sm @error('telefono') is-invalid @enderror"
                                        value="{{ old('telefono', $proveedor->telefono) }}" required
                                        placeholder="Ej: 2233445566" maxlength="10"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}">
                                    @error('telefono')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Correo <span style="color: red;" for="email">*</span></label>
                                    <input type="email" name="email"
                                        class="form-control form-control-sm @error('email') is-invalid @enderror"
                                        value="{{ old('email', $proveedor->email) }}" placeholder="Ej: correo@correo.com">
                                    @error('email')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Estado y ciudad --}}
                        <div class="row">
                            <div class="col-md-6">
                                <label>Estado <span style="color: red;">*</span></label>
                                <select name="estado_id"
                                    class="form-control form-control-sm @error('estado_id') is-invalid @enderror" required>
                                    <option value="">Selecciona un estado</option>
                                    @foreach ($estados as $estado)
                                        <option value="{{ $estado->id }}"
                                            {{ old('estado_id', $proveedor->estado_id) == $estado->id ? 'selected' : '' }}>
                                            {{ $estado->nombre_estado }}
                                        </option>
                                    @endforeach
                                </select>
                                @error('estado_id')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            <div class="col-md-6">
                                <label>Ciudad <span style="color: red;">*</span></label>
                                <input type="text" name="ciudad" class="form-control form-control-sm"
                                    value="{{ old('ciudad', $proveedor->ciudad) }}" placeholder="Ej: Merida">
                            </div>
                        </div>

                        {{-- Botones --}}
                        <div class="text-center mt-4">
                            <a href="{{ route('admin.proveedores.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Actualizar
                            </button>
                        </div>
                    </div>

                    {{-- DATOS CONTACTO --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-address-book"></i> Datos de Contacto
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Nombre del contacto</label>
                            <input type="text" name="nombre_contacto" class="form-control form-control-sm"
                                value="{{ old('nombre_contacto', $proveedor->nombre_contacto) }}"
                                placeholder="Nombre del contacto">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label>Teléfono</label>
                                <input type="tel" name="telefono_contacto" class="form-control form-control-sm"
                                    value="{{ old('telefono_contacto', $proveedor->telefono_contacto) }}"
                                    placeholder="Ej: 2233445566" maxlength="10"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}">
                            </div>
                            <div class="col-md-6">
                                <label for="email_contacto">Correo</label>
                                <input type="email" name="email_contacto" class="form-control form-control-sm"
                                    value="{{ old('email_contacto', $proveedor->email_contacto) }}"
                                    placeholder="Ej: correo@correo.com">
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/purchases/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar OC: ' . $purchase->purchase_number)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @if (session('error'))
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ session('error') }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    @endif

    {{-- BREADCRUMB --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.purchases.index') }}">
                            <i class="fas fa-shopping-cart"></i> Órdenes de Compra
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.purchases.show', $purchase->id) }}">
                            {{ $purchase->purchase_number }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Eliminar</li>
                </ol>
            </nav>
        </div>
    </div>

    <form method="POST" action="{{ route('admin.purchases.destroy', $purchase->id) }}" id="deleteForm">
        @csrf
        @method('DELETE')

        <div class="card card-danger">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold; font-size: 20px;">
                    <i class="fas fa-trash"></i> ELIMINAR ORDEN DE COMPRA
                </h3>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        {{-- INFORMACIÓN DE LA COMPRA --}}
                        <div class="card border-danger mb-4">
                            <div class="card-header bg-danger text-white">
                                <i class="fas fa-file-invoice"></i>
                                <strong>Orden a Eliminar: {{ $purchase->purchase_number }}</strong>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 130px;"><strong>Proveedor:</strong></td>
                                                    <td>{{ $purchase->proveedor->nombre_proveedor ?? 'N/A' }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Fecha Orden:</strong></td>
                                                    <td>{{ $purchase->ordered_at ? $purchase->ordered_at->format('d/m/Y') : '-' }}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Referencia:</strong></td>
                                                    <td>{{ $purchase->reference ?? '-' }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 130px;"><strong>Estado:</strong></td>
                                                    <td>
                                                        <span class="badge badge-{{ $purchase->status_color }}">
                                                            <i class="{{ $purchase->status_icon }}"></i>
                                                            {{ $purchase->status_label }}
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Total Items:</strong></td>
                                                    <td>{{ $purchase->items->count() }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Total:</strong></td>
                                                    <td class="font-weight-bold text-primary" style="font-size: 18px;">
                                                        {{ $purchase->formatted_total }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{-- DETALLE DE ITEMS --}}
                        @if ($purchase->items->count() > 0)
                            <div class="card mb-4">
                                <div class="card-header bg-secondary text-white py-2">
                                    <strong><i class="fas fa-list"></i> Items que serán eliminados</strong>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-sm table-striped mb-0">
                                        <thead class="thead-light">
                                            <tr>
                                                <th>#</th>
                                                <th>Material</th>
                                                <th>SKU</th>
                                                <th class="text-center">Cantidad</th>
                                                <th class="text-right">Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach ($purchase->items as $item)
                                                <tr>
                                                    <td>{{ $loop->iteration }}</td>
                                                    <td>{{ $item->materialVariant->material->name ?? 'N/A' }}</td>
                                                    <td><code>{{ $item->materialVariant->sku ?? 'N/A' }}</code></td>
                                                    <td class="text-center">
                                                        {{ number_format($item->quantity, 2) }}
                                                        {{ $item->unit->symbol ?? '' }}
                                                    </td>
                                                    <td class="text-right">${{ number_format($item->subtotal, 2) }}</td>
                                                </tr>
                                            @endforeach
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        @endif

                        {{-- ADVERTENCIAS --}}
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">
                                <i class="fas fa-exclamation-circle"></i> ¡Atención!
                            </h5>
                            <hr>
                            <p class="mb-0">
                                Está a punto de <strong>eliminar permanentemente</strong> esta orden de compra.
                                Esta acción:
                            </p>
                            <ul class="mt-2 mb-0">
                                <li>Eliminará la orden de compra y <strong>todos sus items</strong>.</li>
                                <li><strong>No se puede deshacer</strong>.</li>
                                <li>Solo es posible porque la orden está en estado <strong>Borrador</strong>.</li>
                            </ul>
                        </div>

                        {{-- CONFIRMACIÓN --}}
                        <div class="custom-control custom-checkbox mb-3">
                            <input type="checkbox" class="custom-control-input" id="confirmDelete" required>
                            <label class="custom-control-label text-danger" for="confirmDelete">
                                <strong>Entiendo que esta acción es permanente y deseo eliminar esta orden</strong>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-footer">
                <div class="row">
                    <div class="col-md-8 offset-md-2 text-center">
                        <a href="{{ route('admin.purchases.show', $purchase->id) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-danger" id="btnDelete">
                            <i class="fas fa-trash"></i> Eliminar Permanentemente
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
@stop

@section('js')
    <script>
        $(function() {
            const $confirmCheck = $('#confirmDelete');
            const $btnDelete = $('#btnDelete');

            // Validación del formulario
            $('#deleteForm').on('submit', function(e) {
                if (!$confirmCheck.is(':checked')) {
                    e.preventDefault();
                    alert('Debe confirmar que entiende que esta acción es permanente');
                    return false;
                }

                return confirm('¿Está COMPLETAMENTE SEGURO de eliminar esta orden de compra?\n\n' +
                    'Orden: {{ $purchase->purchase_number }}\n' +
                    'Total: {{ $purchase->formatted_total }}\n\n' +
                    'Esta acción NO se puede deshacer.');
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/tipos_aplicacion/create.blade.php">
@extends('adminlte::page')

@section('title', 'CREAR TIPO DE APLICACIÓN')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-12 col-md-6 col-lg-4">

        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif


        <div class="card card-primary " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVO TIPO DE APLICACIÓN</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.tipos_aplicacion.store') }}">
                    @csrf
                    @method('POST')
                    <div class="col-md-12">
                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Tipo de Aplicación
                            </h5>
                        </div>
                        <div class="form-group @error('nombre_aplicacion') is-invalid @enderror">
                            <label for="nombre_aplicacion">Nombre <span style="color: red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="nombre_aplicacion"
                                name="nombre_aplicacion" placeholder="Ej: MANGA IZQUIERDA" required
                                pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+" title="Solo se permiten letras y espacios"
                                value="{{ old('nombre_aplicacion') }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')">
                            @error('nombre_aplicacion')
                                <div class="invalid-feedback">
                                    {{ $message }}
                                </div>
                            @enderror
                        </div>

                        <!-- Botones de acción -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="text-right">
                                    <a href="{{ route('admin.tipos_aplicacion.index') }}" class="btn btn-secondary"
                                        style="margin-right: 10px; padding: 8px 20px;">
                                        <i class="fas fa-times-circle"></i> Regresar
                                    </a>
                                    <button type="submit" class="btn btn-primary" style="padding: 8px 20px;">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script></script>
@stop
</file>

<file path="resources/views/admin/tipos_aplicacion/delete.blade.php">
@extends('adminlte::page')

@section('title', 'ELIMINAR GIRO')

@section('content_header')
@stop

@section('content')
    <br>
    <br>
    <div class="col-12 col-md-6 col-lg-4">
        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif
        <div class="card card-danger " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> ELIMINAR TIPO DE APLICACIÓN</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.tipos_aplicacion.destroy', $aplication_types->id) }}">
                    @csrf
                    @method('DELETE')
                    <div class="col-md-12">


                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Tipo de Aplicación
                            </h5>
                        </div>
                        <div class="form-group">


                            <label for="nombre_aplicacion ">

                                Nombre <span style="color: red;">*</span>
                            </label>
                            <input type="text" class="form-control form-control-sm" id="nombre_aplicacion"
                                name="nombre_aplicacion" placeholder="Ej: TELA" pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+"
                                title="Solo se permiten letras y espacios"
                                value="{{ old('nombre_aplicacion', $aplication_types->nombre_aplicacion) }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" disabled>

                            @error('nombre_aplicacion')
                                <div class="invalid-feedback">
                                    {{ $message }}
                                </div>
                            @enderror
                        </div>
                        <div style="font-weight: bold;font-size: 25px;text-align: center;">¿Deseas eliminar el
                            tipo de aplicación?</div>
                        <!-- Botones de acción -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="text-right">
                                    <a href="{{ route('admin.tipos_aplicacion.index') }}" class="btn btn-secondary"
                                        style="margin-right: 10px; padding: 8px 20px;">
                                        <i class="fas fa-times-circle"></i> Regresar
                                    </a>
                                    <button type="submit" class="btn btn-danger" style="padding: 8px 20px;">
                                        <i class="fas fa-save"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/tipos_aplicacion/edit.blade.php">
@extends('adminlte::page')

@section('title', 'EDITAR TIPO DE APLICACIÓN')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-12 col-md-6 col-lg-4">

        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        <div class="card card-warning " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                    EDITAR TIPO DE APLICACIÓN
                </h3>
            </div>

            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.tipos_aplicacion.update', $aplication_types->id) }}">
                    @csrf
                    @method('PUT')

                    <div class="col-md-12">

                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Tipo de Aplicación
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>
                                Nombre <span style="color: red;">*</span>
                            </label>

                            <input type="text"
                                class="form-control form-control-sm @error('nombre_aplicacion') is-invalid @enderror"
                                id="nombre_aplicacion" name="nombre_aplicacion" placeholder="Ej: MEXICO"
                                pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+" title="Solo se permiten letras y espacios"
                                value="{{ old('nombre_aplicacion', $aplication_types->nombre_aplicacion) }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" required>

                            @error('nombre_aplicacion')
                                <div class="invalid-feedback">
                                    {{ $message }}
                                </div>
                            @enderror
                        </div>

                        <div class="row mt-4">
                            <div class="col-12 text-right">
                                <a href="{{ route('admin.tipos_aplicacion.index') }}" class="btn btn-secondary"
                                    style="margin-right: 10px;">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Actualizar
                                </button>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
@stop


@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/units/_form.blade.php">
{{-- Nombre y Símbolo --}}
<div class="row">
    <div class="col-md-6">
        <div class="form-group">
            <label for="name" class="font-weight-bold">
                Nombre <span class="text-danger">*</span>
            </label>
            <input type="text" name="name" id="name" class="form-control @error('name') is-invalid @enderror"
                value="{{ old('name', $unit->name ?? '') }}" placeholder="Ej: Metro, Rollo, Cono" required autofocus>
            @error('name')
                <span class="invalid-feedback">{{ $message }}</span>
            @enderror
        </div>
    </div>

    <div class="col-md-3">
        <div class="form-group">
            <label for="symbol" class="font-weight-bold">
                Símbolo <span class="text-danger">*</span>
            </label>
            <input type="text" name="symbol" id="symbol"
                class="form-control @error('symbol') is-invalid @enderror"
                value="{{ old('symbol', $unit->symbol ?? '') }}" placeholder="Ej: m, pz, cono" required>
            @error('symbol')
                <span class="invalid-feedback">{{ $message }}</span>
            @enderror
            <small class="form-text text-muted">Abreviación corta</small>
        </div>
    </div>

    <div class="col-md-3">
        <div class="form-group">
            <label for="sort_order" class="font-weight-bold">Orden</label>
            <input type="number" name="sort_order" id="sort_order"
                class="form-control @error('sort_order') is-invalid @enderror"
                value="{{ old('sort_order', $unit->sort_order ?? 0) }}" min="0" max="999">
            @error('sort_order')
                <span class="invalid-feedback">{{ $message }}</span>
            @enderror
        </div>
    </div>
</div>

{{-- Tipo de Unidad --}}
<div class="row mt-3">
    <div class="col-md-6">
        <div class="card bg-light border-0">
            <div class="card-body">
                <label class="font-weight-bold d-block mb-2">Tipo de unidad</label>
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="is_base" name="is_base" value="1"
                        {{ old('is_base', $unit->is_base ?? false) ? 'checked' : '' }}>
                    <label class="custom-control-label font-weight-bold" for="is_base">
                        Unidad de Consumo
                    </label>
                </div>
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle mr-1 text-info"></i>
                    <strong>Consumo:</strong> unidad en la que el material se gasta durante producción (metro, litro, pieza, minuto)
                </small>
                <small class="text-muted d-block mt-1">
                    Si no marca esta opción, la unidad será de <strong>Compra</strong> (cono, saco, paquete)
                </small>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card bg-light border-0">
            <div class="card-body">
                <div class="custom-control custom-switch">
                    <input type="checkbox" class="custom-control-input" id="is_active" name="is_active" value="1"
                        {{ old('is_active', $unit->is_active ?? true) ? 'checked' : '' }}>
                    <label class="custom-control-label font-weight-bold" for="is_active">
                        Activo
                    </label>
                </div>
                <small class="text-muted d-block mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    Las unidades inactivas no aparecen en los selectores del sistema.
                </small>
            </div>
        </div>
    </div>
</div>

{{-- Se convierte a (solo para unidades de compra/presentación) --}}
<div class="row mt-3" id="compatible_unit_section" style="{{ old('is_base', $unit->is_base ?? false) ? 'display: none;' : '' }}">
    <div class="col-md-6">
        <div class="form-group">
            <label for="compatible_base_unit_id" class="font-weight-bold">
                <i class="fas fa-link text-info mr-1"></i>
                Se convierte a (Unidad de Consumo)
            </label>
            <select name="compatible_base_unit_id" id="compatible_base_unit_id"
                class="form-control @error('compatible_base_unit_id') is-invalid @enderror">
                <option value="">-- Seleccionar unidad de consumo --</option>
                @foreach($baseUnits ?? [] as $baseUnit)
                    <option value="{{ $baseUnit->id }}"
                        {{ old('compatible_base_unit_id', $unit->compatible_base_unit_id ?? '') == $baseUnit->id ? 'selected' : '' }}>
                        {{ $baseUnit->name }} ({{ $baseUnit->symbol }})
                    </option>
                @endforeach
            </select>
            @error('compatible_base_unit_id')
                <span class="invalid-feedback">{{ $message }}</span>
            @enderror
            <small class="form-text text-muted">
                <i class="fas fa-info-circle mr-1"></i>
                Indica a qué unidad de consumo se puede convertir esta unidad de compra.
                <br>Ejemplo: ROLLO 50M → METRO
            </small>
        </div>
    </div>
</div>

@push('js')
<script>
$(function() {
    // Mostrar/ocultar sección de unidad compatible según el checkbox
    $('#is_base').on('change', function() {
        if ($(this).is(':checked')) {
            $('#compatible_unit_section').slideUp();
            $('#compatible_base_unit_id').val('');
        } else {
            $('#compatible_unit_section').slideDown();
        }
    });
});
</script>
@endpush
</file>

<file path="resources/views/admin/visualizer/index.blade.php">
@extends('adminlte::page')

@section('title', 'Visualizador de Bordados')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="m-0 text-dark font-weight-bold" style="font-size: 1.5rem; letter-spacing: -0.5px;">Visualizador</h1>
            <p class="text-muted m-0 small">Analiza y visualiza archivos de bordado en tiempo real.</p>
        </div>
        <div>
            {{-- Breadcrumb o acciones globales si fueran necesarias --}}
        </div>
    </div>
@stop

@section('content')
    <div class="container-fluid pb-5">

        {{-- Main Container con Ancho Máximo Contenido --}}
        <div class="row justify-content-center">
            <div class="col-lg-10 col-xl-9">

                {{-- ==================== ZONE 1: UPLOAD ==================== --}}
                <div class="card border-0 shadow-sm" id="uploadCard"
                    style="border-radius: 16px; overflow: hidden; transition: all 0.3s ease;">
                    <div class="card-body p-0">
                        <div class="upload-area position-relative d-flex flex-column align-items-center justify-content-center p-5"
                            style="min-height: 400px; border: 2px dashed #cbd5e1; background: #f8fafc; cursor: pointer; transition: all 0.2s ease;">

                            <div class="icon-circle mb-4 d-flex align-items-center justify-content-center shadow-sm"
                                style="width: 80px; height: 80px; background: #fff; border-radius: 50%;">
                                <i class="fas fa-cloud-upload-alt text-primary" style="font-size: 2.5rem;"></i>
                            </div>

                            <h3 class="font-weight-bold text-dark mb-2">Sube tu archivo de bordado</h3>
                            <p class="text-muted mb-4 text-center" style="max-width: 400px;">
                                Arrastra y suelta tu archivo aquí o haz clic para explorar.
                                <br><span class="small opacity-75">Soportamos .DST, .PES, .JEF, .EXP, .VP3, .XXX</span>
                            </p>

                            <div class="d-flex align-items-center justify-content-center gap-2 mb-3">
                                <span class="badge badge-light px-3 py-2 border text-muted">DST</span>
                                <span class="badge badge-light px-3 py-2 border text-muted">PES</span>
                                <span class="badge badge-light px-3 py-2 border text-muted">JEF</span>
                            </div>

                            <div class="alert alert-warning border-0 d-flex align-items-center py-2 px-3 mt-3"
                                style="background: #fffbeb; color: #92400e; border-radius: 8px; font-size: 0.85rem;">
                                <i class="fas fa-exclamation-circle mr-2"></i>
                                <span>Archivos <b>.EMB (Wilcom)</b> no son soportados directamente.</span>
                            </div>

                        </div>
                        <input type="file" id="fileInput" class="d-none" accept=".dst,.pes,.jef,.exp,.vp3,.xxx,.emb">
                    </div>
                </div>

                {{-- ==================== ZONE 2: LOADING ==================== --}}
                <div id="loadingSection" class="text-center py-5 d-none bg-white shadow-sm rounded-lg"
                    style="min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 16px;">
                    <div class="spinner-grow text-primary mb-3" style="width: 3rem; height: 3rem;" role="status">
                        <span class="sr-only">Cargando...</span>
                    </div>
                    <h4 class="font-weight-bold text-dark">Analizando Geometría...</h4>
                    <p class="text-muted">Extrayendo puntadas, colores y vectores.</p>
                </div>

                {{-- ==================== ZONE 3: RESULTS DASHBOARD ==================== --}}
                <div class="d-none animate__animated animate__fadeIn" id="resultCard">

                    {{-- Toolbar Superior --}}
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 bg-white p-3 rounded shadow-sm"
                        style="border-radius: 12px !important;">
                        <div class="d-flex align-items-center mb-3 mb-md-0">
                            <div class="file-icon mr-3 d-flex align-items-center justify-content-center bg-light text-primary font-weight-bold rounded"
                                style="width: 48px; height: 48px; font-size: 1.2rem; border: 1px solid #e2e8f0;"
                                id="resFormatBadgeHeader">
                                PES
                            </div>
                            <div>
                                <h5 class="font-weight-bold m-0 text-dark text-truncate" id="resFileName"
                                    style="max-width: 300px; letter-spacing: -0.3px;">NombreArchivo.esp</h5>
                                <span class="text-muted small" id="resFileSize">250 KB</span>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm font-weight-bold px-3" id="btnNewUpload"
                                style="border-radius: 8px;">
                                <i class="fas fa-arrow-left mr-1"></i> Subir Otro
                            </button>
                            <button class="btn btn-primary btn-sm font-weight-bold px-3 shadow-sm" id="btnResetView"
                                style="border-radius: 8px;">
                                <i class="fas fa-compress-arrows-alt mr-1"></i> Centrar Vista
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        {{-- Left Column: Visualization --}}
                        <div class="col-lg-7 mb-4">
                            <div class="card border-0 shadow-sm h-100" id="previewCard"
                                style="border-radius: 16px; overflow: hidden;">
                                <div class="card-header bg-white border-0 pt-4 px-4 pb-0">
                                    <h6 class="font-weight-bold text-uppercase text-muted small letter-spacing-1">Vista
                                        Previa</h6>
                                </div>
                                <div class="card-body p-0 d-flex align-items-center justify-content-center position-relative"
                                    style="background: #f8fafc; min-height: 450px;">
                                    {{-- Background Pattern for transparency feel --}}
                                    <div class="position-absolute w-100 h-100"
                                        style="opacity: 0.4; background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px;">
                                    </div>

                                    <div id="svgContainer" class="p-4"
                                        style="width: 100%; height: 100%; max-height: 500px; z-index: 1;">
                                        {{-- SVG Injected Here --}}
                                    </div>

                                    {{-- Floating Toolbar --}}
                                    <div id="svgToolbar"
                                        class="position-absolute d-flex gap-2 p-2 bg-white rounded shadow-sm animate__animated animate__fadeInUp"
                                        style="bottom: 20px; z-index: 10; left: 50%; transform: translateX(-50%); border: 1px solid #e2e8f0;">
                                        <button class="btn btn-sm btn-light border" id="btnZoomOut" title="Alejar"><i
                                                class="fas fa-minus text-secondary"></i></button>
                                        <button class="btn btn-sm btn-light border" id="btnZoomReset" title="Resetear"><i
                                                class="fas fa-compress-arrows-alt text-secondary"></i></button>
                                        <button class="btn btn-sm btn-light border" id="btnZoomIn" title="Acercar"><i
                                                class="fas fa-plus text-primary"></i></button>
                                        <div class="vr mx-1 bg-secondary opacity-25"></div>
                                        <button class="btn btn-sm btn-light border" id="btnFullscreen"
                                            title="Pantalla Completa"><i class="fas fa-expand text-dark"></i></button>
                                        <button class="btn btn-sm btn-primary shadow-sm" id="btnDownload"
                                            title="Descargar SVG"><i class="fas fa-download"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{-- Right Column: Data & Analytics --}}
                        <div class="col-lg-5">

                            {{-- Compatibility Card --}}
                            <div class="card border-0 shadow-sm mb-3"
                                style="border-radius: 12px; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white;">
                                <div class="card-body p-4 d-flex align-items-center">
                                    <div
                                        class="mr-3 p-3 rounded bg-white bg-opacity-10 d-flex align-items-center justify-content-center">
                                        <i class="fas fa-microchip fa-lg text-white"></i>
                                    </div>
                                    <div>
                                        <div class="text-white-50 small text-uppercase font-weight-bold mb-1">Máquina
                                            Recomendada</div>
                                        <div class="h5 font-weight-bold m-0" id="resCompatibility">Brother / Babylock
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {{-- Technical Stats Grid --}}
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div class="stat-card p-3 bg-white shadow-sm rounded border-bottom-primary h-100"
                                        style="border-radius: 12px !important; border-bottom: 3px solid #3b82f6;">
                                        <div class="text-muted small font-weight-bold text-uppercase mb-1">Puntadas</div>
                                        <div class="h3 font-weight-bold text-dark m-0" id="resStitches">0</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="stat-card p-3 bg-white shadow-sm rounded border-bottom-success h-100"
                                        style="border-radius: 12px !important; border-bottom: 3px solid #10b981;">
                                        <div class="text-muted small font-weight-bold text-uppercase mb-1">Colores</div>
                                        <div class="h3 font-weight-bold text-dark m-0" id="resColorsCount">0</div>
                                    </div>
                                </div>
                                <div class="col-6 mt-2">
                                    <div class="stat-card p-3 bg-white shadow-sm rounded h-100"
                                        style="border-radius: 12px !important;">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <div class="text-muted small font-weight-bold text-uppercase">Ancho</div>
                                            <i class="fas fa-arrows-alt-h text-muted opacity-50"></i>
                                        </div>
                                        <div class="h4 font-weight-bold text-dark m-0"><span id="resWidth">0</span> <span
                                                class="small text-muted">mm</span></div>
                                    </div>
                                </div>
                                <div class="col-6 mt-2">
                                    <div class="stat-card p-3 bg-white shadow-sm rounded h-100"
                                        style="border-radius: 12px !important;">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <div class="text-muted small font-weight-bold text-uppercase">Alto</div>
                                            <i class="fas fa-arrows-alt-v text-muted opacity-50"></i>
                                        </div>
                                        <div class="h4 font-weight-bold text-dark m-0"><span id="resHeight">0</span> <span
                                                class="small text-muted">mm</span></div>
                                    </div>
                                </div>
                                <div class="col-12 mt-2">
                                    <div class="stat-card p-3 bg-white shadow-sm rounded d-flex justify-content-between align-items-center"
                                        style="border-radius: 12px !important;">
                                        <div>
                                            <div class="text-muted small font-weight-bold text-uppercase">Saltos
                                                (Trims/Jumps)</div>
                                            <div class="small text-muted">Cortes de hilo estimados</div>
                                        </div>
                                        <div class="h3 font-weight-bold text-dark m-0" id="resJumps">0</div>
                                    </div>
                                </div>
                            </div>

                            {{-- Colors Palette --}}
                            <div class="card border-0 shadow-sm" style="border-radius: 16px;">
                                <div class="card-header bg-white border-0 pt-3 px-3">
                                    <h6 class="font-weight-bold m-0 text-dark">Paleta de Hilos</h6>
                                </div>
                                <div class="card-body px-3 pb-3">
                                    <div id="resColorGrid" class="d-flex flex-wrap gap-2">
                                        {{-- Swatches injected via JS --}}
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
@stop

@section('css')
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif !important;
            background-color: #f1f5f9;
        }

        /* Upload Area Effects */
        .upload-area:hover {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
        }

        .upload-area:hover .icon-circle {
            transform: scale(1.1);
            color: #2563eb;
        }

        .icon-circle {
            transition: transform 0.2s ease-in-out;
        }

        /* SVG Container */
        #svgContainer svg {
            max-width: 100%;
            max-height: 100%;
            filter: drop-shadow(0 10px 15px -3px rgba(0, 0, 0, 0.1));
        }

        /* Utilities */
        .letter-spacing-1 {
            letter-spacing: 1px;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .text-white-50 {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate__fadeIn {
            animation: fadeIn 0.5s ease-out forwards;
        }
    </style>
@stop

@section('js')
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            const dropZone = $('.upload-area');
            const fileInput = $('#fileInput');

            // --- Event Handlers ---

            // Click anywhere in drop zone triggers input
            dropZone.on('click', function() {
                fileInput.click();
            });

            // Drag effects
            dropZone.on('dragover', function(e) {
                e.preventDefault();
                $(this).css({
                    'border-color': '#3b82f6',
                    'background-color': '#eff6ff'
                });
            });

            dropZone.on('dragleave', function(e) {
                e.preventDefault();
                $(this).removeAttr('style'); // Revert to CSS hover class or default
            });

            // Drop
            dropZone.on('drop', function(e) {
                e.preventDefault();
                $(this).removeAttr('style');

                const files = e.originalEvent.dataTransfer.files;
                if (files.length > 0) {
                    analyzeFile(files[0]);
                }
            });

            // File Input Change
            fileInput.on('change', function() {
                if (this.files.length > 0) {
                    analyzeFile(this.files[0]);
                }
            });

            // "Subir Otro" Button
            $('#btnNewUpload').on('click', function() {
                $('#resultCard').addClass('d-none');
                $('#uploadCard').removeClass('d-none');
                fileInput.val(''); // Reset input
                fileInput.click(); // Open system dialog
            });

            // "Centrar Vista" (Reset Zoom/Pan - Placeholder for now)
            $('#btnResetView').on('click', function() {
                // Future: Implement Panzoom reset here
                const svg = $('#svgContainer svg');
                if (svg.length) {
                    svg.css({
                        'transform': 'scale(1)',
                        'transition': 'transform 0.3s'
                    });
                }
            });

            // --- Main Logic ---

            function analyzeFile(file) {
                // 1. Validation Logic
                const ext = file.name.split('.').pop().toLowerCase();

                if (ext === 'emb') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Formato de Edición',
                        text: 'El archivo .EMB es editable (Wilcom) y no se puede visualizar directamente aquí. Por favor sube la versión de producción (.DST, .PES, etc).',
                        confirmButtonColor: '#3085d6',
                    });
                    return;
                }

                const validExts = ['dst', 'pes', 'jef', 'jef+', 'exp', 'vp3', 'vip', 'xxx', 'hus', 'pec', 'sew',
                    'shv', 'tap', 'tbf', 'u01', '10o', 'emd', 'csd', 'pcs', 'ksm'
                ];
                if (!validExts.includes(ext)) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Formato no soportado',
                        text: 'Por favor sube un archivo de bordado válido (.DST, .PES, .JEF, etc).',
                    });
                    return;
                }

                // 2. Prepare UI
                $('#uploadCard').addClass('d-none');
                $('#loadingSection').removeClass('d-none');

                // 3. AJAX Request
                const formData = new FormData();
                formData.append('file', file);

                $.ajax({
                    url: '{{ route('admin.visualizer.analyze') }}',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    success: function(response) {
                        $('#loadingSection').addClass('d-none');
                        if (response.success) {
                            renderDashboard(response.data);
                        }
                    },
                    error: function(xhr) {
                        $('#loadingSection').addClass('d-none');
                        $('#uploadCard').removeClass('d-none');

                        let msg = 'Ocurrió un error al analizar el archivo.';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            msg = xhr.responseJSON.error;
                        }

                        // Error visual
                        Swal.fire({
                            title: 'Error de Análisis',
                            text: msg,
                            icon: 'error',
                            confirmButtonColor: '#d33'
                        });
                    }
                });
            }

            function renderDashboard(data) {
                // Header Info
                $('#resFileName').text(data.original_name || data.file_name);
                $('#resFileSize').text(formatBytes(data.file_size));
                $('#resFormatBadgeHeader').text(data.file_format || 'N/A');

                // Compatibility
                $('#resCompatibility').text(data.machine_compatibility || 'Universal');

                // Stats
                animateValue('resStitches', 0, data.total_stitches, 1000);
                $('#resColorsCount').text(data.colors_count);
                $('#resWidth').text(data.width_mm);
                $('#resHeight').text(data.height_mm);
                $('#resJumps').text(data.jumps);

                // SVG
                const svgContainer = $('#svgContainer');
                if (data.svg_content) {
                    svgContainer.html(data.svg_content);
                    // Add responsiveness to SVG
                    svgContainer.find('svg').attr('width', '100%').attr('height', '100%');
                } else {
                    svgContainer.html(`
                        <div class="text-center text-muted opacity-50">
                            <i class="fas fa-image fa-3x mb-3"></i>
                            <p>No se pudo generar la vista previa</p>
                        </div>
                    `);
                    $('#svgToolbar').addClass('d-none'); // Hide toolbar if no SVG
                }

                // Colors Palette
                const colorGrid = $('#resColorGrid');
                colorGrid.empty();

                if (data.colors && data.colors.length > 0) {
                    data.colors.forEach(color => {
                        const hex = color.hex || '#e2e8f0';
                        const name = color.name || 'Sin nombre';
                        const html = `
                            <div class="d-flex flex-column align-items-center mb-2" style="width: 80px;">
                                <div class="palette-swatch shadow-sm mb-2" title="${name} (${hex})" 
                                     style="
                                        width: 48px; height: 48px; 
                                        background: ${hex}; 
                                        border-radius: 12px; 
                                        cursor: help;
                                        border: 2px solid #fff;
                                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                                        transition: transform 0.2s;
                                     "
                                     onmouseover="this.style.transform='scale(1.1)'"
                                     onmouseout="this.style.transform='scale(1)'"
                                ></div>
                                <span class="text-dark font-weight-bold bg-white px-2 py-1 rounded shadow-sm border" style="font-size: 0.85rem; font-family: monospace; letter-spacing: 0.5px;">${hex}</span>
                            </div>
                        `;
                        colorGrid.append(html);
                    });
                } else {
                    colorGrid.html(
                        '<p class="text-muted small pl-1">No hay información de colores disponible.</p>');
                }

                // Show Dashboard
                $('#resultCard').removeClass('d-none');
            }

            // --- Toolbar Logic ---

            $('#btnZoomIn').on('click', function() {
                currentScale = Math.min(5, currentScale + 0.5);
                updateTransform();
            });

            $('#btnZoomOut').on('click', function() {
                currentScale = Math.max(0.5, currentScale - 0.5);
                updateTransform();
            });

            $('#btnZoomReset').on('click', function() {
                currentScale = 1;
                transX = 0;
                transY = 0;
                updateTransform();
            });

            $('#btnDownload').on('click', function() {
                const svgNode = document.querySelector('#svgContainer svg');
                if (!svgNode) return;

                // Show loading state
                const btn = $(this);
                const originalHtml = btn.html();
                btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

                try {
                    const svgData = new XMLSerializer().serializeToString(svgNode);
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();

                    // High Resolution Settings (4x Scale for crisp quality)
                    const scaleFactor = 4;

                    // Get original SVG dimensions or fallback
                    let width = 800;
                    let height = 800;

                    if (svgNode.viewBox && svgNode.viewBox.baseVal) {
                        width = svgNode.viewBox.baseVal.width || 800;
                        height = svgNode.viewBox.baseVal.height || 800;
                    } else if (svgNode.width && svgNode.width.baseVal) {
                        width = svgNode.width.baseVal.value || 800;
                        height = svgNode.height.baseVal.value || 800;
                    }

                    canvas.width = width * scaleFactor;
                    canvas.height = height * scaleFactor;

                    img.onload = function() {
                        // Optional: White background for better WhatsApp visibility (transparency can be problematic)
                        // ctx.fillStyle = '#ffffff';
                        // ctx.fillRect(0, 0, canvas.width, canvas.height);

                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                        const pngFile = canvas.toDataURL('image/png');
                        const a = document.createElement('a');
                        a.download = ($('#resFileName').text() || 'bordado') + '_HD.png';
                        a.href = pngFile;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);

                        // Reset button
                        btn.html(originalHtml).prop('disabled', false);
                    };

                    // Handle SVG encoding for src
                    img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));

                } catch (e) {
                    console.error('Error generating PNG:', e);
                    Swal.fire('Error', 'No se pudo generar la imagen HD. Intenta con captura de pantalla.',
                        'error');
                    btn.html(originalHtml).prop('disabled', false);
                }
            });

            $('#btnFullscreen').on('click', function() {
                const elem = document.getElementById('previewCard'); // ID agregado al card padre
                if (!document.fullscreenElement) {
                    elem.requestFullscreen().catch(err => {
                        console.error(
                            `Error attempting to enable full-screen mode: ${err.message} (${err.name})`
                        );
                    });
                } else {
                    document.exitFullscreen();
                }
            });

            // --- Zoom / Pan Logic ---
            let currentScale = 1;
            let isDragging = false;
            let startX, startY, transX = 0,
                transY = 0;
            const zoomContainer = $('#svgContainer');

            function updateTransform() {
                // Aplicamos la transformación al primer hijo (el SVG) o al contenedor si fuera necesario
                // En este caso, el SVG es inyectado dentro de #svgContainer -> svg
                const content = zoomContainer.find('svg');
                if (content.length) {
                    content.css({
                        'transform': `scale(${currentScale}) translate(${transX}px, ${transY}px)`,
                        'transform-origin': 'center',
                        'transition': isDragging ? 'none' : 'transform 0.1s ease-out'
                    });
                }
            }

            // Buttons (Global Reset removed/redirected to toolbar)
            // The old #btnResetView logic is now handled by the toolbar's #btnZoomReset
            // The original #btnResetView handler is updated above to call the new reset logic.

            // Mouse Events on Container
            zoomContainer.on('mousedown', function(e) {
                if (currentScale > 1) {
                    isDragging = true;
                    // Ajuste de coordenadas relativo al zoom
                    startX = e.pageX - (transX * currentScale);
                    startY = e.pageY - (transY * currentScale);
                    // Simplificado: usar movimiento relativo
                    startX = e.pageX;
                    startY = e.pageY;
                    // Guardar posición actual de translate para sumar delta
                    $(this).css('cursor', 'grabbing');
                }
            });

            // Corrección lógica Pan con Zoom
            let panStartX = 0,
                panStartY = 0;

            zoomContainer.on('mousedown', function(e) {
                if (currentScale > 1) {
                    isDragging = true;
                    panStartX = e.pageX - transX;
                    panStartY = e.pageY - transY;
                    $(this).css('cursor', 'grabbing');
                }
            });

            $(window).on('mousemove', function(e) {
                if (isDragging) {
                    e.preventDefault();
                    transX = e.pageX - panStartX;
                    transY = e.pageY - panStartY;
                    updateTransform();
                }
            }).on('mouseup', function() {
                isDragging = false;
                zoomContainer.css('cursor', currentScale > 1 ? 'grab' : 'default');
            });

            zoomContainer.on('wheel', function(e) {
                e.preventDefault();
                const delta = e.originalEvent.deltaY;
                if (delta > 0) {
                    currentScale = Math.max(0.5, currentScale - 0.2);
                } else {
                    currentScale = Math.min(5, currentScale + 0.2);
                }
                updateTransform();
            });

            // --- Helpers ---

            function formatBytes(bytes, decimals = 1) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const dm = decimals < 0 ? 0 : decimals;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
            }

            function animateValue(id, start, end, duration) {
                const obj = document.getElementById(id);
                if (!obj) return;

                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.innerHTML = new Intl.NumberFormat().format(Math.floor(progress * (end - start) +
                        start));
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    }
                };
                window.requestAnimationFrame(step);
            }
        });
    </script>
@stop
</file>

<file path="app/Http/Controllers/CategoryController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Category;
use Illuminate\Http\Request;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;

class CategoryController extends Controller
{
    /**
     * Mostrar listado de categorías
     */
    public function index()
    {
        // Obtener categorías con sus padres e hijos
        $categories = Category::with(['parent', 'children'])
            ->where('is_active', true)
            ->whereNull('parent_id') // Solo categorías raíz
            ->orderBy('order')
            ->orderBy('name')
            ->get();

        return view('admin.categorias.index', compact('categories'));
    }

    /**
     * Mostrar formulario para crear categoría
     */
    public function create()
    {
        // Obtener categorías para seleccionar como padre
        $parentCategories = Category::where('is_active', true)
            ->orderBy('name')
            ->get();

        return view('admin.categorias.create', compact('parentCategories'));
    }

    /**
     * Guardar nueva categoría
     */
    public function store(Request $request)
    {

        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:categories,name',
            'description' => 'nullable|string',
            'parent_id' => 'nullable|exists:categories,id',
            'order' => 'nullable|integer|min:0',
            'is_active' => 'boolean'
        ]);

        $validated['slug'] = Str::slug($validated['name']);
        try {
            // Si no se proporciona orden, usar el siguiente disponible
            if (!isset($validated['order'])) {
                $validated['order'] = Category::max('order') + 1;
            }

            $category = Category::create($validated);

            return redirect()
                ->route('admin.categories.index')
                ->with('success', 'Categoría creada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al crear la categoría: ' . $e->getMessage());
            return redirect()
                ->back()
                ->with('error', 'Error al crear la categoría: ' . $e->getMessage());
        }
    }

    /**
     * Mostrar formulario para editar
     */
    public function edit(Category $category)
    {
        try {
            $parentCategories = Category::where('is_active', true)
                ->where('id', '!=', $category->id) // Evitar seleccionarse a sí misma
                ->orderBy('name')
                ->get();

            return view('admin.categorias.edit', compact('category', 'parentCategories'));
        } catch (\Exception $e) {
            Log::error('Error al editar la categoría: ' . $e->getMessage());
            return redirect()
                ->back()
                ->with('error', 'Error al editar la categoría: ' . $e->getMessage());
        }
    }

    /**
     * Mostrar una categoría con sus diseños
     */
    public function show(Category $category)
    {
        $category->load([
            'designs.primaryImage',
            'children',
            'parent'
        ]);

        return view('admin.categorias.show', compact('category'));
    }



    /**
     * Actualizar categoría
     */
    public function update(Request $request, Category $category)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:categories,name,' . $category->id,
            'description' => 'nullable|string',
            'parent_id' => 'nullable|exists:categories,id',
            'order' => 'nullable|integer|min:0',
            'is_active' => 'boolean'
        ]);
        try {

            // Validar que no se seleccione a sí misma como padre
            if (isset($validated['parent_id']) && $validated['parent_id'] == $category->id) {
                return back()
                    ->with('error', 'Una categoría no puede ser su propia categoría padre')
                    ->withInput();
            }

            if ($category->name !== $validated['name']) {
                $validated['slug'] = Str::slug($validated['name']);
            }

            $category->update($validated);

            return redirect()
                ->route('admin.categories.index')
                ->with('success', 'Categoría actualizada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar la categoría: ' . $e->getMessage());
            return redirect()
                ->back()
                ->with('error', 'Error al actualizar la categoría: ' . $e->getMessage());
        }
    }

    /**
     * Eliminar categoría
     */
    public function confirm_delete(Category $category)
    {
        //validando que existe el giro
        $category = Category::where('id', $category->id)
            ->where('is_active', true)
            ->firstOrFail();
        if (!$category) {
            return redirect()->route('admin.categories.index')->with('error', 'Categoría no encontrada');
        }

        return view('admin.categorias.delete', compact('category'));
    }
    public function destroy(Category $category)
    {
        try {

            // Verificar si tiene diseños asociados
            if ($category->designs()->count() > 0) {
                return back()
                    ->with('error', 'No se puede eliminar la categoría porque tiene diseños asociados');
            }

            // Verificar si tiene subcategorías
            if ($category->children()->count() > 0) {
                return back()
                    ->with('error', 'No se puede eliminar la categoría porque tiene subcategorías');
            }

            $category->delete();

            return redirect()
                ->route('admin.categories.index')
                ->with('success', 'Categoría eliminada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar la categoría: ' . $e->getMessage());
            return redirect()
                ->back()
                ->with('error', 'Error al eliminar la categoría: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/DesignVariantController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Design;
use App\Models\DesignVariant;
use App\Models\Attribute;
use App\Services\ImageService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\DB;

class DesignVariantController extends Controller
{
    protected ImageService $imageService;

    public function __construct(ImageService $imageService)
    {
        $this->imageService = $imageService;
    }

    public function create(Design $design)
    {
        try {
            $attributes = Attribute::with('values')
                ->orderBy('order')
                ->get();

            return view('admin.design-variants.create', compact('design', 'attributes'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de creación de variante: ' . $e->getMessage());
            return redirect()->route('admin.designs.index')
                ->with('error', 'Error al cargar formulario de creación de variante')
                ->with('icon', 'error');
            abort(500);
        }
    }

    /**
     * ============================================================
     * GUARDAR VARIANTE (STORE)
     * ============================================================
     */
    public function store(Request $request, Design $design)
    {
        Log::info('=== [PASO 0] INICIO MÉTODO STORE ===', [
            'design_id' => $design->id,
            'all_data' => $request->except(['_token', 'variant_images'])
        ]);

        // 1. Verificación inmediata de archivos
        if ($request->hasFile('variant_images')) {
            Log::info('=== [PASO 1] ARCHIVOS DETECTADOS ===', [
                'count' => count($request->file('variant_images')),
                'details' => array_map(fn($f) => $f->getClientOriginalName(), $request->file('variant_images'))
            ]);
        } else {
            Log::warning('=== [PASO 1] ADVERTENCIA: No se detectaron archivos en "variant_images" ===');
        }

        /**
         * 1. LIMPIEZA DE ATRIBUTOS (si se proporcionan)
         */
        if ($request->has('attribute_values')) {
            $request->merge([
                'attribute_values' => array_values(array_filter(
                    (array) $request->input('attribute_values'),
                    fn($value) => !is_null($value) && $value !== ''
                ))
            ]);
        }

        /**
         * 2. VALIDACIÓN (Simplificada - sin precio ni atributos obligatorios)
         */
        $rules = [
            'sku' => 'required|string|max:255|unique:design_variants,sku',
            'name' => 'required|string|max:255|unique:design_variants,name',
            'price' => 'nullable|numeric|min:0',
            'stock' => 'nullable|integer|min:0',
            'is_default' => 'nullable',
            'attribute_values' => 'nullable|array',
            'attribute_values.*' => 'exists:attribute_values,id',
            'variant_images' => 'nullable|array',
            'variant_images.*' => 'file|mimes:jpg,jpeg,png,webp,avif|max:10240',
            'primary_image_index' => 'nullable|integer|min:0',
        ];

        // Si hay imágenes, el índice de imagen principal es requerido
        if ($request->hasFile('variant_images')) {
            $rules['primary_image_index'] = 'required|integer|min:0';
        }

        $messages = [
            'primary_image_index.required' => 'Debes seleccionar una imagen principal para la variante.',
        ];

        $validator = Validator::make($request->all(), $rules, $messages);

        if ($validator->fails()) {
            Log::error('=== [ERROR] FALLO DE VALIDACIÓN ===', [
                'errors' => $validator->errors()->toArray()
            ]);

            // Si es petición AJAX, devolver JSON
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error de validación',
                    'errors' => $validator->errors()->toArray()
                ], 422);
            }

            return back()->with('error', 'Error al cargar formulario de creación de variante')
                ->with('icon', 'error')
                ->withInput();
        }

        Log::info('=== [PASO 2] VALIDACIÓN EXITOSA ===');
        $validated = $validator->validated();

        DB::beginTransaction();
        try {
            /**
             * 3. MANEJO DE VARIANTE POR DEFECTO
             */
            $isDefault = $request->input('is_default') == "1";
            if ($isDefault) {
                Log::info('=== [PASO 3] RESETEANDO OTRAS VARIANTES DEFAULT ===');
                $design->variants()->update(['is_default' => false]);
            }

            /**
             * 4. CREAR VARIANTE
             */
            $variant = $design->variants()->create([
                'sku' => $validated['sku'],
                'name' => $validated['name'],
                'price' => $validated['price'] ?? 0,
                'stock' => $validated['stock'] ?? 0,
                'is_active' => $request->input('is_active', "1") == "1",
                'is_default' => $isDefault,
                'activated_at' => now(),
            ]);

            Log::info('=== [PASO 4] VARIANTE CREADA EN BD ===', ['variant_id' => $variant->id]);

            /**
             * 5. SINCRONIZAR ATRIBUTOS (si se proporcionan)
             */
            if (!empty($validated['attribute_values'])) {
                $variant->attributeValues()->sync($validated['attribute_values']);
                Log::info('=== [PASO 5] ATRIBUTOS SINCRONIZADOS ===');
            } else {
                Log::info('=== [PASO 5] SIN ATRIBUTOS PARA SINCRONIZAR ===');
            }

            /**
             * 6. SUBIDA DE IMÁGENES
             */
            if ($request->hasFile('variant_images')) {
                Log::info('=== [PASO 6] INICIANDO SUBIDA DE IMÁGENES ===');

                // Obtener índice de imagen principal (0 por defecto)
                $primaryIndex = (int) $request->input('primary_image_index', 0);

                foreach ($request->file('variant_images') as $index => $image) {
                    $this->imageService->uploadImage(
                        $image,
                        DesignVariant::class,
                        $variant->id,
                        [
                            'design_name'   => $design->name,
                            'variant_name'  => $variant->name,
                            'variant_sku'   => $variant->sku,
                            'alt_text'      => $variant->name,
                            'is_primary'    => $index === $primaryIndex,
                            'image_context' => 'variant',
                            'order'         => $index,
                        ]
                    );
                }
                Log::info('=== [PASO 6] TODAS LAS IMÁGENES PROCESADAS EXITOSAMENTE ===', [
                    'primary_index' => $primaryIndex
                ]);
            }

            DB::commit();
            Log::info('=== [ÉXITO FINAL] TRANSACCIÓN COMPLETADA ===');

            // Si es petición AJAX, devolver JSON
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Variante guardada correctamente',
                    'variant_id' => $variant->id,
                    'redirect' => route('admin.designs.index')
                ]);
            }

            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Variante guardada correctamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('=== [ERROR CRÍTICO] FALLO EN EL PROCESO STORE ===', [
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            // Si es petición AJAX, devolver JSON de error
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error al guardar la variante: ' . $e->getMessage(),
                    'errors' => []
                ], 500);
            }

            return back()
                ->with('error', 'Error al guardar la variante: ' . $e->getMessage())
                ->withInput()
                ->with('icon', 'error');
        }
    }

    public function edit(Design $design, DesignVariant $variant)
    {
        $variant->load('images');
        $attributes = Attribute::with('values')->orderBy('order')->get();
        $selectedAttributeValues = $variant->attributeValues->pluck('id')->toArray();

        return view('admin.design-variants.edit', compact('design', 'variant', 'attributes', 'selectedAttributeValues'));
    }

    /**
     * ============================================================
     * ACTUALIZAR VARIANTE (UPDATE)
     * ============================================================
     */
    public function update(Request $request, Design $design, DesignVariant $variant)
    {
        Log::info('=== INICIO ACTUALIZACIÓN DE VARIANTE ===', ['id' => $variant->id]);

        if ($request->has('attribute_values')) {
            $request->merge([
                'attribute_values' => array_values(array_filter(
                    (array) $request->input('attribute_values'),
                    fn($value) => !is_null($value) && $value !== ''
                ))
            ]);
        }

        $validator = Validator::make($request->all(), [
            'sku' => 'required|string|max:255|unique:design_variants,sku,' . $variant->id,
            'name' => 'required|string|max:255|unique:design_variants,name,' . $variant->id,
            'price' => 'nullable|numeric|min:0',
            'stock' => 'nullable|integer|min:0',
            'is_default' => 'nullable',
            'attribute_values' => 'nullable|array',
            'attribute_values.*' => 'exists:attribute_values,id',
            'variant_images' => 'nullable|array',
            'variant_images.*' => 'file|mimes:jpg,jpeg,png,webp,avif|max:10240',
            'primary_image_id' => 'nullable|integer|exists:images,id',
        ]);

        if ($validator->fails()) {
            Log::error('Error de validación en update:', $validator->errors()->toArray());
            return back()->with('error', 'Error al cargar formulario de actualización de variante')
                ->with('icon', 'error')
                ->withInput();
        }

        $validated = $validator->validated();
        DB::beginTransaction();

        try {
            $isDefault = $request->input('is_default') == "1";
            if ($isDefault) {
                $design->variants()->where('id', '!=', $variant->id)->update(['is_default' => false]);
            }

            $variant->update([
                'sku' => $validated['sku'],
                'name' => $validated['name'],
                'price' => $validated['price'] ?? $variant->price ?? 0,
                'stock' => $validated['stock'] ?? $variant->stock,
                'is_default' => $isDefault,
                'is_active' => $request->input('is_active', "1") == "1",
                'activated_at' => $variant->activated_at ?? now(),
            ]);

            // Sincronizar atributos solo si se proporcionan
            if (!empty($validated['attribute_values'])) {
                $variant->attributeValues()->sync($validated['attribute_values']);
            }

            // Actualizar imagen principal si se proporcionó
            if ($request->filled('primary_image_id')) {
                $primaryImageId = $request->input('primary_image_id');

                // Quitar is_primary de todas las imágenes de la variante
                $variant->images()->update(['is_primary' => false]);

                // Establecer la nueva imagen principal
                $variant->images()->where('id', $primaryImageId)->update(['is_primary' => true]);

                Log::info('Imagen principal actualizada', [
                    'variant_id' => $variant->id,
                    'primary_image_id' => $primaryImageId
                ]);
            }

            if ($request->hasFile('variant_images')) {
                Log::info('Subiendo nuevas imágenes en update...');
                // Buscamos el último orden para no sobrescribir posiciones
                $lastOrder = $variant->images()->max('order') ?? -1;

                foreach ($request->file('variant_images') as $index => $image) {
                    $this->imageService->uploadImage(
                        $image,
                        DesignVariant::class,
                        $variant->id,
                        [
                            'design_name'   => $design->name,
                            'variant_name'  => $variant->name,
                            'variant_sku'   => $variant->sku,
                            'alt_text'      => $variant->name,
                            'is_primary'    => false, // En update, las nuevas no suelen ser primarias por defecto
                            'image_context' => 'variant',
                            'order'         => $lastOrder + $index + 1,
                        ]
                    );
                }
            }

            DB::commit();
            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Variante actualizada correctamente');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error en update variante: ' . $e->getMessage());
            return back()->with('error', 'Error al actualizar: ' . $e->getMessage())->withInput();
        }
    }

    public function destroy(Design $design, DesignVariant $variant)
    {
        try {
            DB::beginTransaction();
            foreach ($variant->images as $image) {
                $this->imageService->deleteImage($image);
            }
            $variant->delete();
            DB::commit();

            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Variante eliminada exitosamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al eliminar variante: ' . $e->getMessage());
            return back()->with('error', 'Error al eliminar variante')
                ->with('icon', 'error');
        }
    }

    public function destroyImage(Design $design, DesignVariant $variant, $imageId)
    {
        try {
            $image = $variant->images()->findOrFail($imageId);
            $this->imageService->deleteImage($image);
            return back()->with('success', 'Imagen eliminada correctamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            Log::error('Error al eliminar imagen de variante: ' . $e->getMessage());
            return back()->with('error', 'Error al eliminar imagen')
                ->with('icon', 'error');
        }
    }
}
</file>

<file path="app/Http/Controllers/GiroController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Giro;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class GiroController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $giros = Giro::all()->where('activo', true);
        return view('admin.giros.index', compact('giros'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.giros.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre_giro' => ['required', 'string', 'max:255', 'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/'],
        ]);
        try {
            $nombre = strtoupper(trim($request->nombre_giro));

            // Buscar si ya existe (activo o inactivo)
            $existingGiro = Giro::where('nombre_giro', $nombre)->first();

            if ($existingGiro) {
                if ($existingGiro->activo) {
                    return back()->withErrors(['nombre_giro' => 'El nombre del giro ya ha sido registrado.'])->withInput();
                } else {
                    // Reactivar si existía pero estaba eliminado logicamente
                    $existingGiro->activo = true;
                    $existingGiro->save();
                    return redirect()->route('admin.giros.index')->with('success', 'Giro reactivado exitosamente');
                }
            }

            $giro = new Giro();
            $giro->nombre_giro = $nombre;
            $giro->save();
            return redirect()->route('admin.giros.index')->with('success', 'Giro guardado exitosamente');
        } catch (\Exception $e) {
            return redirect()->route('admin.giros.index')->with('error', 'Error al guardar el giro: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Giro $giro)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $giro = Giro::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$giro) {
            return redirect()->route('admin.giros.index')->with('error', 'Giro no encontrado');
        }
        return view('admin.giros.edit', compact('giro'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_giro' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:giros,nombre_giro,' . $id,
            ],
        ]);
        try {
            $giro = Giro::where('id', $id)
                ->where('activo', true)
                ->firstOrFail();
            $giro->nombre_giro = strtoupper(trim($request->nombre_giro));

            //validamos si hubo algun cambio o modificacion en el valor del campo nombre_estado, si no hubo cambios, no se actualiza
            if (! $giro->isDirty()) {
                // return back()->with('info', 'No se realizaron cambios');
                return redirect()->route('admin.giros.index')->with('info', 'No se realizaron cambios');
            }

            $giro->save();
            return redirect()->route('admin.giros.index')->with('success', 'Giro actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el giro: ' . $e->getMessage());
            return redirect()->route('admin.giros.index')->with('error', 'Error al actualizar el giro');
        }
    }
    public function confirm_delete($id)
    {
        //validando que existe el giro
        $giro = Giro::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$giro) {
            return redirect()->route('admin.giros.index')->with('error', 'Giro no encontrado');
        }
        return view('admin.giros.delete', compact('giro'));
    }

    /**
     * Remove the specified resource from storage.
     */
    public function destroy($id)
    {
        $giro = Giro::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$giro) {
            return redirect()->route('admin.giros.confirm_delete', $id)->with('error', 'Giro no encontrado');
        }
        try {
            $giro->activo = false;
            $giro->save();
            return redirect()->route('admin.giros.index')->with('success', 'Giro eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el giro: ' . $e->getMessage());
            return redirect()->route('admin.giros.index')->with('error', 'Error al eliminar el giro');
        }
    }
}
</file>

<file path="app/Http/Controllers/MaterialCategoryController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\MaterialCategoryRequest;
use App\Models\MaterialCategory;
use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class MaterialCategoryController extends Controller
{
    public function index()
    {
        try {
            $categories = MaterialCategory::where('activo', true)
                ->with(['allowedUnits'])
                ->withCount(['materials' => fn($q) => $q->where('activo', true)])
                ->ordered()
                ->get();

            return view('admin.material-categories.index', compact('categories'));
        } catch (\Exception $e) {
            Log::error('Error al listar categorías de materiales: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return view('admin.material-categories.index', ['categories' => collect()])
                ->with('error', 'Error al cargar las categorías');
        }
    }

    public function create()
    {
        try {
            return view('admin.material-categories.create');
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de categoría: ' . $e->getMessage());
            return redirect()->route('material-categories.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    public function store(MaterialCategoryRequest $request)
    {
        try {
            DB::beginTransaction();

            $category = new MaterialCategory();
            $category->name = mb_strtoupper(trim($request->name));
            $category->slug = Str::slug($request->name);
            $category->description = $request->filled('description')
                ? trim($request->description)
                : null;
            $category->activo = true;
            $category->save();

            DB::commit();

            Log::info('Categoría de material creada', [
                'category_id' => $category->id,
                'name' => $category->name,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.material-categories.index')
                ->with('success', 'Categoría creada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al crear categoría de material: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'request' => $request->validated(),
            ]);

            return redirect()->route('admin.material-categories.index')
                ->with('error', 'Error al crear la categoría');
        }
    }

    public function edit($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.material-categories.index')
                    ->with('error', 'Categoría no válida');
            }

            $category = MaterialCategory::where('activo', true)->findOrFail((int) $id);

            return view('admin.material-categories.edit', compact('category'));
        } catch (\Exception $e) {
            Log::error('Error al cargar categoría para editar: ' . $e->getMessage());
            return redirect()->route('admin.material-categories.index')
                ->with('error', 'Categoría no encontrada');
        }
    }

    public function update(MaterialCategoryRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.material-categories.index')
                    ->with('error', 'Categoría no válida');
            }

            DB::beginTransaction();

            $category = MaterialCategory::where('activo', true)->findOrFail((int) $id);

            $category->name = mb_strtoupper(trim($request->name));
            $category->slug = Str::slug($request->name);
            $category->description = $request->filled('description')
                ? trim($request->description)
                : null;

            if (!$category->isDirty()) {
                return redirect()->route('admin.material-categories.index')
                    ->with('info', 'No se realizaron cambios');
            }

            $category->save();

            DB::commit();

            Log::info('Categoría de material actualizada', [
                'category_id' => $category->id,
                'name' => $category->name,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.material-categories.index')
                ->with('success', 'Categoría actualizada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar categoría: ' . $e->getMessage(), [
                'category_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.material-categories.index')
                ->with('error', 'Error al actualizar la categoría');
        }
    }

    public function confirmDelete($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.material-categories.index')
                    ->with('error', 'Categoría no válida');
            }

            $category = MaterialCategory::where('activo', true)
                ->findOrFail((int) $id);

            return view('admin.material-categories.delete', compact('category'));
        } catch (\Exception $e) {
            Log::error('Error al cargar categoría para eliminar: ' . $e->getMessage());
            return redirect()->route('admin.material-categories.index')
                ->with('error', 'Categoría no encontrada');
        }
    }

    public function destroy($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.material-categories.index')
                    ->with('error', 'Categoría no válida');
            }

            DB::beginTransaction();

            $category = MaterialCategory::where('activo', true)->findOrFail((int) $id);

            $validation = $category->canDelete();
            if (!$validation['can_delete']) {
                return redirect()->route('admin.material-categories.index')
                    ->with('error', $validation['message']);
            }

            $category->activo = false;
            $category->save();

            DB::commit();

            Log::info('Categoría de material eliminada', [
                'category_id' => $category->id,
                'name' => $category->name,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.material-categories.index')
                ->with('success', 'Categoría eliminada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al eliminar categoría: ' . $e->getMessage(), [
                'category_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.material-categories.index')
                ->with('error', 'Error al eliminar la categoría');
        }
    }
    public function getMaterials($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return response()->json(['error' => 'Categoría no válida'], 400);
            }

            $category = MaterialCategory::where('activo', true)->findOrFail((int) $id);

            $materials = $category->materials()
                ->where('activo', true)
                ->select('id', 'name')
                ->orderBy('name')
                ->get();

            return response()->json($materials);
        } catch (\Exception $e) {
            Log::error('Error al obtener materiales de la categoría: ' . $e->getMessage(), [
                'category_id' => $id,
                'user_id' => Auth::id(),
            ]);
            return response()->json(['error' => 'Error al cargar materiales'], 500);
        }
    }
    public function getUnits($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return response()->json(['error' => 'Categoría no válida'], 400);
            }

            $category = MaterialCategory::where('activo', true)
                ->with(['allowedUnits' => function ($q) {
                    // Filtrar SOLO unidades logísticas puras (unit_type = 'logistic')
                    $q->logistic()->ordered();
                }])
                ->findOrFail((int) $id);

            // Si no tiene unidades asignadas, devolver vacío.
            // El frontend mostrará "Sin unidades".

            return response()->json($category->allowedUnits);
        } catch (\Exception $e) {
            Log::error('Error al obtener unidades de la categoría: ' . $e->getMessage(), [
                'category_id' => $id,
                'user_id' => Auth::id(),
            ]);
            return response()->json(['error' => 'Error al cargar unidades'], 500);
        }
    }
}
</file>

<file path="app/Http/Controllers/MaterialController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\MaterialRequest;
use App\Models\Material;
use App\Models\MaterialCategory;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class MaterialController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | INDEX
    |--------------------------------------------------------------------------
    */

    public function index(Request $request)
    {
        try {
            $request->validate([
                'category' => ['nullable', 'integer', 'min:1', 'max:999999'],
                'search' => ['nullable', 'string', 'max:100', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s\-\_]+$/u'],
            ]);

            $query = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->withCount(['activeVariants']);

            if ($request->filled('category')) {
                $query->where('material_category_id', (int) $request->input('category'));
            }

            if ($request->filled('search')) {
                $search = $request->input('search');
                $query->where(function ($q) use ($search) {
                    $q->where('name', 'like', "%{$search}%")
                        ->orWhere('composition', 'like', "%{$search}%");
                });
            }

            $materials = $query->ordered()->get();

            $categories = MaterialCategory::where('activo', true)
                ->ordered()
                ->get();

            if ($request->ajax()) {
                return response()->json([
                    'html' => view('admin.materials.partials.table_rows', compact('materials'))->render(),
                ]);
            }

            return view('admin.materials.index', compact('materials', 'categories'));
        } catch (\Exception $e) {
            Log::error('Error al listar materiales: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return view('admin.materials.index', [
                'materials' => collect(),
                'categories' => collect(),
            ])->with('error', 'Error al cargar los materiales');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create()
    {
        try {
            $categories = MaterialCategory::where('activo', true)
                ->ordered()
                ->get();

            if ($categories->isEmpty()) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Debe crear al menos una categoría de material primero');
            }

            return view('admin.materials.create', compact('categories'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de material: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(MaterialRequest $request)
    {
        try {
            DB::beginTransaction();

            $material = new Material();
            $material->uuid = (string) Str::uuid();
            $material->material_category_id = (int) $request->material_category_id;
            $material->base_unit_id = (int) $request->base_unit_id;
            $material->consumption_unit_id = null;
            $material->conversion_factor = 1.0;
            $material->has_color = $request->boolean('has_color');
            $material->name = mb_strtoupper(trim($request->name));
            $material->slug = Str::slug($request->name);
            $material->composition = $request->filled('composition')
                ? mb_strtoupper(trim($request->composition))
                : null;
            $material->description = $request->filled('description')
                ? trim($request->description)
                : null;
            $material->activo = true;
            $material->save();

            DB::commit();

            Log::info('Material creado with properties', [
                'material_id' => $material->id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('success', 'Material creado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al crear material: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'request' => $request->validated(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.materials.create')
                ->withInput()
                ->with('error', 'Error al crear el material');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit', 'consumptionUnit'])
                ->findOrFail((int) $id);

            $categories = MaterialCategory::where('activo', true)
                ->ordered()
                ->get();

            $baseUnits = $material->category->allowedUnits()->ordered()->get();

            return view('admin.materials.edit', compact('material', 'categories', 'baseUnits'));
        } catch (\Exception $e) {
            Log::error('Error al cargar material para editar: ' . $e->getMessage(), [
                'material_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Material no encontrado');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(MaterialRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            DB::beginTransaction();

            $material = Material::where('activo', true)->findOrFail((int) $id);

            $oldName = $material->name;

            $material->material_category_id = (int) $request->material_category_id;
            $material->base_unit_id = (int) $request->base_unit_id;
            // $material->consumption_unit_id = null; // Mantener valor anterior o resetear? Resetear si eliminamos el campo UI.
            $material->consumption_unit_id = null;
            $material->conversion_factor = 1.0;
            $material->has_color = $request->boolean('has_color');
            $material->name = mb_strtoupper(trim($request->name));
            $material->slug = Str::slug($request->name);
            $material->composition = $request->filled('composition')
                ? mb_strtoupper(trim($request->composition))
                : null;
            $material->description = $request->filled('description')
                ? trim($request->description)
                : null;

            if (!$material->isDirty()) {
                return redirect()->route('admin.materials.index')
                    ->with('info', 'No se realizaron cambios');
            }

            $material->save();

            DB::commit();

            Log::info('Material actualizado', [
                'material_id' => $material->id,
                'old_name' => $oldName,
                'new_name' => $material->name,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('success', 'Material actualizado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar material: ' . $e->getMessage(), [
                'material_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.materials.edit', $id)
                ->withInput()
                ->with('error', 'Error al actualizar el material');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM DELETE
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->withCount('activeVariants')
                ->findOrFail((int) $id);

            return view('admin.materials.delete', compact('material'));
        } catch (\Exception $e) {
            Log::error('Error al cargar material para eliminar: ' . $e->getMessage(), [
                'material_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Material no encontrado');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DESTROY
    |--------------------------------------------------------------------------
    */

    public function destroy($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            DB::beginTransaction();

            $material = Material::where('activo', true)->findOrFail((int) $id);

            $validation = $material->canDelete();
            if (!$validation['can_delete']) {
                return redirect()->route('admin.materials.index')
                    ->with('error', $validation['message']);
            }

            $materialName = $material->name;

            $material->activo = false;
            $material->save();

            DB::commit();

            Log::info('Material eliminado', [
                'material_id' => $material->id,
                'name' => $materialName,
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('success', 'Material eliminado exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al eliminar material: ' . $e->getMessage(), [
                'material_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Error al eliminar el material');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX: Obtener materiales por categoría
    |--------------------------------------------------------------------------
    */

    public function getByCategory(Request $request, $categoryId)
    {
        try {
            if (!is_numeric($categoryId) || $categoryId < 1) {
                return response()->json(['error' => 'Categoría no válida'], 400);
            }

            $materials = Material::where('activo', true)
                ->where('material_category_id', (int) $categoryId)
                ->ordered()
                ->get(['id', 'name', 'composition']);

            return response()->json($materials);
        } catch (\Exception $e) {
            Log::error('Error AJAX getByCategory: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener materiales'], 500);
        }
    }
}
</file>

<file path="app/Http/Controllers/MaterialUnitConversionController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\MaterialUnitConversionRequest;
use App\Models\Material;
use App\Models\MaterialUnitConversion;
use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;

class MaterialUnitConversionController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | INDEX - Listar conversiones de un material
    |--------------------------------------------------------------------------
    */

    public function index($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->findOrFail((int) $materialId);

            $conversions = MaterialUnitConversion::where('material_id', $material->id)
                ->with(['fromUnit', 'toUnit'])
                ->orderBy('id')
                ->get();

            return view('admin.material-conversions.index', compact('material', 'conversions'));
        } catch (\Exception $e) {
            Log::error('Error al listar conversiones de material: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Error al cargar las conversiones');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->findOrFail((int) $materialId);

            $baseUnitId = $material->base_unit_id;

            // Solo unidades de compra compatibles con la unidad base
            $purchaseUnits = Unit::getPurchaseUnitsFor($baseUnitId);

            if ($purchaseUnits->isEmpty()) {
                $unitName = $material->baseUnit->name ?? 'la unidad actual';
                return redirect()->route('admin.material-conversions.index', $material->id)
                    ->with('error', "Para crear una conversión, primero debe existir una unidad superior (ej: Caja, Paquete) compatible con '{$unitName}'. Vaya al catálogo de Unidades y cree una que tenga a '{$unitName}' como unidad base compatible.");
            }

            // Unidades ya usadas
            $usedUnitIds = MaterialUnitConversion::where('material_id', $material->id)
                ->pluck('from_unit_id')
                ->toArray();

            return view('admin.material-conversions.create', compact(
                'material',
                'purchaseUnits',
                'usedUnitIds'
            ));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de conversión: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(MaterialUnitConversionRequest $request, $materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $conversion = new MaterialUnitConversion();
            $conversion->material_id = $material->id;
            $conversion->from_unit_id = (int) $request->from_unit_id;
            $conversion->to_unit_id = (int) $request->to_unit_id;
            $conversion->conversion_factor = (float) $request->conversion_factor;
            $conversion->save();

            DB::commit();

            Log::info('Conversión de unidad creada', [
                'conversion_id' => $conversion->id,
                'material_id' => $material->id,
                'material_name' => $material->name,
                'from_unit_id' => $conversion->from_unit_id,
                'to_unit_id' => $conversion->to_unit_id,
                'factor' => $conversion->conversion_factor,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('admin.material-conversions.index', $material->id)
                ->with('success', 'Conversión creada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al crear conversión de unidad: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.material-conversions.create', $materialId)
                ->withInput()
                ->with('error', 'Error al crear la conversión');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->findOrFail((int) $materialId);

            $conversion = MaterialUnitConversion::where('material_id', $material->id)
                ->with(['fromUnit', 'toUnit'])
                ->findOrFail((int) $id);

            $baseUnitId = $material->base_unit_id;

            // Solo unidades de compra compatibles
            $purchaseUnits = Unit::getPurchaseUnitsFor($baseUnitId);

            // Unidades ya usadas (excepto la actual)
            $usedUnitIds = MaterialUnitConversion::where('material_id', $material->id)
                ->where('id', '!=', $conversion->id)
                ->pluck('from_unit_id')
                ->toArray();

            return view('admin.material-conversions.edit', compact(
                'material',
                'conversion',
                'purchaseUnits',
                'usedUnitIds'
            ));
        } catch (\Exception $e) {
            Log::error('Error al cargar conversión para editar: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'conversion_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Conversión no encontrada');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(MaterialUnitConversionRequest $request, $materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $conversion = MaterialUnitConversion::where('material_id', $material->id)
                ->findOrFail((int) $id);

            $oldFactor = $conversion->conversion_factor;

            $conversion->from_unit_id = (int) $request->from_unit_id;
            $conversion->to_unit_id = (int) $request->to_unit_id;
            $conversion->conversion_factor = (float) $request->conversion_factor;

            if (!$conversion->isDirty()) {
                return redirect()->route('admin.material-conversions.index', $material->id)
                    ->with('info', 'No se realizaron cambios');
            }

            $conversion->save();

            DB::commit();

            Log::info('Conversión de unidad actualizada', [
                'conversion_id' => $conversion->id,
                'material_id' => $material->id,
                'old_factor' => $oldFactor,
                'new_factor' => $conversion->conversion_factor,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('admin.material-conversions.index', $material->id)
                ->with('success', 'Conversión actualizada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar conversión: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'conversion_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.material-conversions.edit', [$materialId, $id])
                ->withInput()
                ->with('error', 'Error al actualizar la conversión');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM DELETE
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->findOrFail((int) $materialId);

            $conversion = MaterialUnitConversion::where('material_id', $material->id)
                ->with(['fromUnit', 'toUnit'])
                ->findOrFail((int) $id);

            return view('admin.material-conversions.delete', compact('material', 'conversion'));
        } catch (\Exception $e) {
            Log::error('Error al cargar conversión para eliminar: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'conversion_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Conversión no encontrada');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DESTROY
    |--------------------------------------------------------------------------
    */

    public function destroy($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $conversion = MaterialUnitConversion::where('material_id', $material->id)
                ->with(['fromUnit', 'toUnit'])
                ->findOrFail((int) $id);

            $conversionInfo = $conversion->display_conversion;

            $conversion->delete();

            DB::commit();

            Log::info('Conversión de unidad eliminada', [
                'conversion_id' => $id,
                'material_id' => $material->id,
                'material_name' => $material->name,
                'conversion_info' => $conversionInfo,
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return redirect()->route('admin.material-conversions.index', $material->id)
                ->with('success', 'Conversión eliminada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al eliminar conversión: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'conversion_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('material-conversions.index', $materialId)
                ->with('error', 'Error al eliminar la conversión');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX: Obtener factor de conversión
    |--------------------------------------------------------------------------
    */

    public function getConversionFactor(Request $request, $materialId, $fromUnitId)
    {
        try {
            if (!is_numeric($materialId) || !is_numeric($fromUnitId)) {
                return response()->json(['error' => 'Parámetros no válidos'], 400);
            }

            $conversion = MaterialUnitConversion::where('material_id', (int) $materialId)
                ->where('from_unit_id', (int) $fromUnitId)
                ->with(['fromUnit', 'toUnit'])
                ->first();

            if (!$conversion) {
                return response()->json([
                    'found' => false,
                    'message' => 'No existe conversión configurada',
                ]);
            }

            return response()->json([
                'found' => true,
                'conversion_factor' => $conversion->conversion_factor,
                'from_unit' => $conversion->fromUnit->symbol ?? '',
                'to_unit' => $conversion->toUnit->symbol ?? '',
                'display' => $conversion->display_conversion,
            ]);
        } catch (\Exception $e) {
            Log::error('Error AJAX getConversionFactor: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener conversión'], 500);
        }
    }
}
</file>

<file path="app/Http/Controllers/ProductCategoryController.php">
<?php

namespace App\Http\Controllers;

use App\Models\ProductCategory;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\Rule;

class ProductCategoryController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        try {
            $categories = ProductCategory::withCount('products')
                ->orderBy('name')
                ->get();

            return view('admin.product_categories.index', compact('categories'));
        } catch (\Exception $e) {
            Log::error('[ProductCategory@index] Error al cargar categorías: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'line' => $e->getLine(),
                'file' => $e->getFile()
            ]);
            return redirect()->back()->with('error', 'Error al cargar las categorías de productos.');
        }
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        try {
            return view('admin.product_categories.create');
        } catch (\Exception $e) {
            Log::error('[ProductCategory@create] Error al cargar formulario: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'line' => $e->getLine(),
                'file' => $e->getFile()
            ]);
            return redirect()->route('admin.product_categories.index')
                ->with('error', 'Error al cargar el formulario de creación.');
        }
    }

    /**
     * Store a newly created resource in storage.
     * Incluye validación robusta contra SQL injection
     */
    public function store(Request $request)
    {
        // Validación robusta con regex para prevenir SQL injection
        $validated = $request->validate([
            'name' => [
                'required',
                'string',
                'min:2',
                'max:100',
                'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s\-\_\.\,]+$/',
                'unique:product_categories,name'
            ],
            'description' => [
                'nullable',
                'string',
                'max:500',
                'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s\-\_\.\,\!\?\(\)\:\;]+$/'
            ],
            'is_active' => ['boolean']
        ], [
            'name.required' => 'El nombre de la categoría es obligatorio.',
            'name.min' => 'El nombre debe tener al menos 2 caracteres.',
            'name.max' => 'El nombre no puede exceder 100 caracteres.',
            'name.regex' => 'El nombre contiene caracteres no permitidos.',
            'name.unique' => 'Ya existe una categoría con este nombre.',
            'description.max' => 'La descripción no puede exceder 500 caracteres.',
            'description.regex' => 'La descripción contiene caracteres no permitidos.'
        ]);

        try {
            $category = new ProductCategory();
            $category->name = mb_strtoupper(trim($validated['name']), 'UTF-8');
            $category->description = isset($validated['description']) ? trim($validated['description']) : null;
            $category->is_active = $request->has('is_active') ? true : false;
            $category->save();

            Log::info('[ProductCategory@store] Categoría creada exitosamente', [
                'user_id' => Auth::id(),
                'category_id' => $category->id,
                'category_name' => $category->name
            ]);

            return redirect()->route('admin.product_categories.index')
                ->with('success', 'Categoría "' . $category->name . '" creada exitosamente.');
        } catch (\Exception $e) {
            Log::error('[ProductCategory@store] Error al crear categoría: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'request_data' => $request->except(['_token']),
                'line' => $e->getLine(),
                'file' => $e->getFile(),
                'trace' => $e->getTraceAsString()
            ]);
            return redirect()->back()
                ->withInput()
                ->with('error', 'Error al crear la categoría. Por favor, intente nuevamente.');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show($id)
    {
        try {
            $category = ProductCategory::with('products')->findOrFail($id);
            return view('admin.product_categories.show', compact('category'));
        } catch (\Exception $e) {
            Log::error('[ProductCategory@show] Error al mostrar categoría: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'category_id' => $id,
                'line' => $e->getLine(),
                'file' => $e->getFile()
            ]);
            return redirect()->route('admin.product_categories.index')
                ->with('error', 'Categoría no encontrada.');
        }
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        try {
            $category = ProductCategory::findOrFail($id);
            return view('admin.product_categories.edit', compact('category'));
        } catch (\Exception $e) {
            Log::error('[ProductCategory@edit] Error al cargar formulario de edición: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'category_id' => $id,
                'line' => $e->getLine(),
                'file' => $e->getFile()
            ]);
            return redirect()->route('admin.product_categories.index')
                ->with('error', 'Categoría no encontrada.');
        }
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $category = ProductCategory::findOrFail($id);

        // Validación robusta con regex para prevenir SQL injection
        $validated = $request->validate([
            'name' => [
                'required',
                'string',
                'min:2',
                'max:100',
                'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s\-\_\.\,]+$/',
                Rule::unique('product_categories', 'name')->ignore($category->id)
            ],
            'description' => [
                'nullable',
                'string',
                'max:500',
                'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑüÜ0-9\s\-\_\.\,\!\?\(\)\:\;]+$/'
            ],
            'is_active' => ['boolean']
        ], [
            'name.required' => 'El nombre de la categoría es obligatorio.',
            'name.min' => 'El nombre debe tener al menos 2 caracteres.',
            'name.max' => 'El nombre no puede exceder 100 caracteres.',
            'name.regex' => 'El nombre contiene caracteres no permitidos.',
            'name.unique' => 'Ya existe una categoría con este nombre.',
            'description.max' => 'La descripción no puede exceder 500 caracteres.',
            'description.regex' => 'La descripción contiene caracteres no permitidos.'
        ]);

        try {
            $category->name = mb_strtoupper(trim($validated['name']), 'UTF-8');
            $category->description = isset($validated['description']) ? trim($validated['description']) : null;
            $category->is_active = $request->has('is_active') ? true : false;

            if (!$category->isDirty()) {
                return redirect()->route('admin.product_categories.index')
                    ->with('info', 'No se realizaron cambios en la categoría.');
            }

            $category->save();

            Log::info('[ProductCategory@update] Categoría actualizada exitosamente', [
                'user_id' => Auth::id(),
                'category_id' => $category->id,
                'category_name' => $category->name
            ]);

            return redirect()->route('admin.product_categories.index')
                ->with('success', 'Categoría "' . $category->name . '" actualizada exitosamente.');
        } catch (\Exception $e) {
            Log::error('[ProductCategory@update] Error al actualizar categoría: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'category_id' => $id,
                'request_data' => $request->except(['_token']),
                'line' => $e->getLine(),
                'file' => $e->getFile(),
                'trace' => $e->getTraceAsString()
            ]);
            return redirect()->back()
                ->withInput()
                ->with('error', 'Error al actualizar la categoría. Por favor, intente nuevamente.');
        }
    }

    /**
     * Confirm delete page (soft delete)
     */
    public function confirmDelete($id)
    {
        try {
            $category = ProductCategory::withCount('products')->findOrFail($id);
            return view('admin.product_categories.delete', compact('category'));
        } catch (\Exception $e) {
            Log::error('[ProductCategory@confirmDelete] Error al cargar confirmación: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'category_id' => $id,
                'line' => $e->getLine(),
                'file' => $e->getFile()
            ]);
            return redirect()->route('admin.product_categories.index')
                ->with('error', 'Categoría no encontrada.');
        }
    }

    /**
     * Remove the specified resource from storage (soft delete).
     */
    public function destroy($id)
    {
        try {
            $category = ProductCategory::findOrFail($id);

            // Verificar si tiene productos asociados
            if ($category->products()->count() > 0) {
                return redirect()->route('admin.product_categories.index')
                    ->with('error', 'No se puede eliminar la categoría porque tiene productos asociados.');
            }

            $categoryName = $category->name;
            $category->delete(); // SoftDelete

            Log::info('[ProductCategory@destroy] Categoría eliminada exitosamente', [
                'user_id' => Auth::id(),
                'category_id' => $id,
                'category_name' => $categoryName
            ]);

            return redirect()->route('admin.product_categories.index')
                ->with('success', 'Categoría "' . $categoryName . '" eliminada exitosamente.');
        } catch (\Exception $e) {
            Log::error('[ProductCategory@destroy] Error al eliminar categoría: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'category_id' => $id,
                'line' => $e->getLine(),
                'file' => $e->getFile(),
                'trace' => $e->getTraceAsString()
            ]);
            return redirect()->route('admin.product_categories.index')
                ->with('error', 'Error al eliminar la categoría. Por favor, intente nuevamente.');
        }
    }
}
</file>

<file path="app/Http/Controllers/SearchController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Design;
use App\Models\Category;
use App\Services\Search\SearchService;
use Illuminate\Http\Request;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Log;

/**
 * SearchController
 * 
 * Controlador de búsqueda con soporte para:
 * - Búsqueda tradicional (form submit)
 * - Búsqueda AJAX en tiempo real
 * - Autocompletado
 * - Filtros avanzados
 * 
 * @package App\Http\Controllers
 */
class SearchController extends Controller
{
    private SearchService $searchService;

    public function __construct(SearchService $searchService)
    {
        $this->searchService = $searchService;
    }

    /**
     * Búsqueda principal de diseños (página completa).
     * Soporta tanto búsqueda tradicional como AJAX.
     */
    public function index(Request $request)
    {
        // Si es AJAX, delegar al método AJAX
        if ($request->ajax() || $request->wantsJson()) {
            return $this->searchAjax($request);
        }

        $query = Design::with(['categories', 'primaryImage', 'variants']);

        // Aplicar búsqueda avanzada si hay término
        if ($request->filled('q')) {
            $searchTerm = $request->q;
            
            // Obtener IDs que coinciden con búsqueda normalizada
            $matchingIds = $this->searchService->getMatchingIds(
                $searchTerm, 
                Design::class,
                ['limit' => 500] // Límite razonable
            );

            if (!empty($matchingIds)) {
                // Usar los IDs encontrados, mantener relevancia
                $idsString = implode(',', $matchingIds);
                $query->whereIn('id', $matchingIds)
                      ->orderByRaw("FIELD(id, {$idsString})");
            } else {
                // Fallback: búsqueda LIKE tradicional si el índice no tiene resultados
                $query->where(function ($q) use ($searchTerm) {
                    $q->where('name', 'like', "%{$searchTerm}%")
                      ->orWhere('description', 'like', "%{$searchTerm}%");
                });
            }
        }

        // Filtro por categorías
        if ($request->filled('categories')) {
            $categoryIds = is_array($request->categories)
                ? $request->categories
                : [$request->categories];

            $query->whereHas('categories', function ($q) use ($categoryIds) {
                $q->whereIn('categories.id', $categoryIds);
            });
        }

        // Filtro por atributos
        if ($request->filled('attributes')) {
            $attributeValueIds = is_array($request->attributes)
                ? $request->attributes
                : [$request->attributes];

            $query->whereHas('variants.attributeValues', function ($q) use ($attributeValueIds) {
                $q->whereIn('attribute_values.id', $attributeValueIds);
            });
        }

        // Filtro por rango de precio
        if ($request->filled('price_min')) {
            $query->whereHas('variants', function ($q) use ($request) {
                $q->where('price', '>=', $request->price_min);
            });
        }

        if ($request->filled('price_max')) {
            $query->whereHas('variants', function ($q) use ($request) {
                $q->where('price', '<=', $request->price_max);
            });
        }

        // Solo diseños activos
        $query->where('is_active', true);

        // Ordenamiento (si no hay búsqueda con relevancia)
        if (!$request->filled('q')) {
            $sortBy = $request->get('sort_by', 'created_at');
            $sortOrder = $request->get('sort_order', 'desc');

            if (in_array($sortBy, ['name', 'created_at'])) {
                $query->orderBy($sortBy, $sortOrder);
            }
        }

        // Resultados paginados
        $designs = $query->paginate(12)->withQueryString();

        // Datos para filtros
        $categories = Category::where('is_active', true)
            ->orderBy('name')
            ->get();

        return view('admin.search.index', compact('designs', 'categories'));
    }

    /**
     * Búsqueda AJAX en tiempo real.
     * Retorna JSON con resultados parciales.
     */
    public function searchAjax(Request $request): JsonResponse
    {
        $term = $request->get('q', $request->get('term', ''));
        $categoryId = $request->get('category_id');
        $limit = min($request->get('limit', 20), 50); // Máximo 50
        $page = max($request->get('page', 1), 1);
        $offset = ($page - 1) * $limit;

        if (mb_strlen(trim($term)) < 1) {
            return response()->json([
                'success' => true,
                'data' => [],
                'total' => 0,
                'message' => 'Ingresa al menos 1 caracter',
            ]);
        }

        try {
            // Opciones de búsqueda
            $options = [
                'model_type' => Design::class,
                'limit' => $limit,
                'offset' => $offset,
                'only_active' => true,
            ];

            if ($categoryId) {
                $options['category_ids'] = [$categoryId];
            }

            // Ejecutar búsqueda
            $results = $this->searchService->search($term, $options);

            // Obtener modelos completos con relaciones
            $designIds = $results->pluck('id')->toArray();
            
            $designs = Design::with(['primaryImage', 'categories', 'variants', 'exports'])
                ->whereIn('id', $designIds)
                ->get()
                ->keyBy('id');

            // Formatear respuesta manteniendo orden de relevancia
            $formattedResults = $results->map(function ($result) use ($designs, $term) {
                $design = $designs->get($result['id']);
                
                if (!$design) {
                    return null;
                }

                // Usar thumbnail_small para listados (carga rápida)
                $imageSrc = null;
                if ($design->primaryImage) {
                    $imageSrc = $design->primaryImage->thumbnail_small
                        ? asset('storage/' . $design->primaryImage->thumbnail_small)
                        : asset('storage/' . $design->primaryImage->file_path);
                }

                return [
                    'id' => $design->id,
                    'name' => $design->name,
                    'slug' => $design->slug,
                    'description' => $design->description,
                    'excerpt' => $result['excerpt'] ?? $this->truncate($design->description, 100),
                    'image' => $imageSrc,
                    'categories' => $design->categories->pluck('name')->toArray(),
                    'variants_count' => $design->variants->count(),
                    'exports_count' => $design->exports->count(),
                    'score' => $result['score'] ?? 1,
                    'url' => route('admin.designs.show', $design),
                ];
            })->filter()->values();

            return response()->json([
                'success' => true,
                'data' => $formattedResults,
                'total' => $results->count(),
                'query' => $term,
                'page' => $page,
                'has_more' => $results->count() >= $limit,
            ]);

        } catch (\Exception $e) {
            Log::error('SearchController::searchAjax error', [
                'term' => $term,
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'message' => 'Error en la búsqueda',
                'data' => [],
            ], 500);
        }
    }

    /**
     * Autocompletado rápido para campo de búsqueda.
     */
    public function autocomplete(Request $request): JsonResponse
    {
        $term = $request->get('term', $request->get('q', ''));
        $limit = min($request->get('limit', 10), 20);

        if (mb_strlen(trim($term)) < 2) {
            return response()->json([]);
        }

        try {
            $suggestions = $this->searchService->autocomplete($term, $limit);

            // Agregar imagen thumbnail si está disponible
            $designIds = $suggestions->pluck('id')->toArray();
            $designs = Design::with('primaryImage')
                ->whereIn('id', $designIds)
                ->get()
                ->keyBy('id');

            $formatted = $suggestions->map(function ($item) use ($designs) {
                $design = $designs->get($item['id']);

                // Usar thumbnail_small para autocompletado (carga rápida)
                $imageSrc = null;
                if ($design && $design->primaryImage) {
                    $imageSrc = $design->primaryImage->thumbnail_small
                        ? asset('storage/' . $design->primaryImage->thumbnail_small)
                        : asset('storage/' . $design->primaryImage->file_path);
                }

                return [
                    'id' => $item['id'],
                    'value' => $item['title'], // Para jQuery UI Autocomplete
                    'label' => $item['title'], // Para jQuery UI Autocomplete
                    'name' => $item['title'],
                    'slug' => $item['metadata']['slug'] ?? null,
                    'image' => $imageSrc,
                ];
            });

            return response()->json($formatted);

        } catch (\Exception $e) {
            Log::error('SearchController::autocomplete error', [
                'term' => $term,
                'error' => $e->getMessage(),
            ]);

            // Fallback a búsqueda simple
            return $this->autocompleteFallback($term, $limit);
        }
    }

    /**
     * Fallback de autocompletado si el índice falla.
     */
    private function autocompleteFallback(string $term, int $limit): JsonResponse
    {
        $designs = Design::where('name', 'like', "%{$term}%")
            ->where('is_active', true)
            ->with('primaryImage')
            ->limit($limit)
            ->get();

        $formatted = $designs->map(function ($design) {
            // Usar thumbnail_small para fallback (carga rápida)
            $imageSrc = null;
            if ($design->primaryImage) {
                $imageSrc = $design->primaryImage->thumbnail_small
                    ? asset('storage/' . $design->primaryImage->thumbnail_small)
                    : asset('storage/' . $design->primaryImage->file_path);
            }

            return [
                'id' => $design->id,
                'value' => $design->name,
                'label' => $design->name,
                'name' => $design->name,
                'slug' => $design->slug,
                'image' => $imageSrc,
            ];
        });

        return response()->json($formatted);
    }

    /**
     * Endpoint para verificar estado del sistema de búsqueda.
     */
    public function healthCheck(): JsonResponse
    {
        $health = $this->searchService->healthCheck();
        $statusCode = $health['healthy'] ? 200 : 503;

        return response()->json($health, $statusCode);
    }

    /**
     * Endpoint para estadísticas del índice (admin).
     */
    public function stats(): JsonResponse
    {
        $stats = $this->searchService->getStats();
        return response()->json($stats);
    }

    /**
     * Truncar texto para excerpts.
     */
    private function truncate(?string $text, int $length = 100): string
    {
        if (empty($text)) {
            return '';
        }

        if (mb_strlen($text) <= $length) {
            return $text;
        }

        return mb_substr($text, 0, $length) . '...';
    }
}
</file>

<file path="app/Http/Controllers/SystemSettingController.php">
<?php

namespace App\Http\Controllers;

use App\Models\SystemSetting;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class SystemSettingController extends Controller
{
    private const ALLOWED_GROUPS = ['general', 'inventario', 'facturacion', 'produccion'];

    public function index(Request $request)
    {
        try {
            $request->validate([
                'group' => ['sometimes', 'string', 'max:50', 'regex:/^[a-z]+$/'],
            ]);

            $groups = SystemSetting::getGroups();
            $activeGroup = $request->get('group', 'general');

            if (!in_array($activeGroup, self::ALLOWED_GROUPS, true)) {
                $activeGroup = 'general';
            }

            $settings = SystemSetting::getByGroup($activeGroup);

            return view('admin.settings.index', compact('groups', 'activeGroup', 'settings'));
        } catch (\Exception $e) {
            Log::error('Error al cargar configuraciones: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);
            return view('admin.settings.index', [
                'groups' => [],
                'activeGroup' => 'general',
                'settings' => collect()
            ])->with('error', 'Error al cargar las configuraciones');
        }
    }

    public function update(Request $request)
    {
        $request->validate([
            'group' => [
                'required',
                'string',
                'max:50',
                'regex:/^[a-z]+$/',
                function ($attribute, $value, $fail) {
                    if (!in_array($value, self::ALLOWED_GROUPS, true)) {
                        $fail('Grupo de configuración no válido.');
                    }
                },
            ],
            'settings' => ['required', 'array', 'max:50'],
            'settings.*' => ['nullable'], // Quitamos la restricción de string para permitir archivos
        ]);

        $group = $request->input('group');

        try {
            DB::beginTransaction();

            $updated = 0;
            $settingsInput = $request->input('settings', []);

            // Obtener solo las keys válidas del grupo actual
            $validKeys = SystemSetting::where('group', $group)
                ->pluck('key')
                ->toArray();

            foreach ($settingsInput as $key => $value) {
                // 1. Validar que la key pertenezca al grupo
                if (!in_array($key, $validKeys, true)) {
                    continue;
                }

                $setting = SystemSetting::where('key', $key)
                    ->where('group', $group)
                    ->first();

                if (!$setting) {
                    continue;
                }

                // MANEJO DE ARCHIVOS (IMÁGENES)
                if ($setting->type === 'image') {
                    if ($request->hasFile("settings.$key")) {
                        $file = $request->file("settings.$key");

                        // Validación manual del archivo
                        if (!$file->isValid()) {
                            continue; // O lanzar error
                        }

                        $allowedMimes = ['image/jpeg', 'image/png', 'image/webp'];
                        if (!in_array($file->getMimeType(), $allowedMimes)) {
                            DB::rollBack();
                            return redirect()->back()->with('error', 'Formato de imagen no válido para ' . $setting->label);
                        }

                        // Eliminar imagen anterior si existe
                        if ($setting->value && Storage::disk('public')->exists($setting->value)) {
                            Storage::disk('public')->delete($setting->value);
                        }

                        // Guardar nueva imagen
                        $path = $file->store('settings', 'public');
                        $sanitizedValue = $path;
                    } else {
                        // Si no se subió archivo pero viene "null" o vacío, ¿borramos?
                        // Por UX del Dropzone, si el usuario da "eliminar", podríamos enviar un input hidden vacío.
                        // Asumiremos que si viene vacío string, es borrar. Si no viene nada, es mantener.
                        // Pero el request->input incluye todo. 

                        // Si el valor es una cadena vacía y antes había algo, significa borrar?
                        // Vamos a manejar que si viene texto "DELETE_IMAGE", borramos.
                        if ($value === '__DELETE__') {
                            if ($setting->value && Storage::disk('public')->exists($setting->value)) {
                                Storage::disk('public')->delete($setting->value);
                            }
                            $sanitizedValue = null;
                        } else {
                            // Si no es archivo ni flag de borrado, mantenemos el valor actual (no actualizar)
                            continue;
                        }
                    }
                } else {
                    // 2. Sanitizar y validar según tipo (NO IMAGEN)
                    $sanitizedValue = $this->sanitizeValue($value, $setting);
                }

                // CORRECCIÓN: Si el valor es inválido, informamos la causa exacta
                if ($sanitizedValue === false) {
                    DB::rollBack();
                    return redirect()->back()
                        ->withInput()
                        ->with('error', 'El formato para ' . $setting->label . ' es inválido o contiene caracteres no permitidos.');
                }

                if ($setting->value !== $sanitizedValue) {
                    $setting->value = $sanitizedValue;
                    $setting->updated_by = Auth::id();
                    $setting->save();

                    Cache::forget("setting_{$key}");
                    $updated++;

                    Log::info('Configuración actualizada', [
                        'key' => $key,
                        'old_value' => $setting->getOriginal('value'),
                        'new_value' => $sanitizedValue,
                        'user_id' => Auth::id(),
                    ]);
                }
            }

            DB::commit();

            if ($updated === 0) {
                return redirect()
                    ->route('admin.settings.index', ['group' => $group])
                    ->with('info', 'No se detectaron cambios en la configuración.');
            }

            return redirect()
                ->route('admin.settings.index', ['group' => $group])
                ->with('success', 'Se actualizaron ' . $updated . ' configuraciones correctamente.');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar configuraciones: ' . $e->getMessage());

            return redirect()
                ->back()
                ->with('error', 'Ocurrió un error inesperado al procesar la solicitud.');
        }
    }

    /**
     * Sanitiza y valida el valor según el tipo de configuración
     */
    private function sanitizeValue(?string $value, SystemSetting $setting): string|false
    {
        if ($value === null) {
            $value = '';
        }

        $value = strip_tags($value);
        $value = trim($value);

        switch ($setting->type) {
            case 'boolean':
                return in_array($value, ['1', '0', 'true', 'false', ''], true)
                    ? ($value === '1' || $value === 'true' ? '1' : '0')
                    : false;

            case 'integer':
                if ($value === '') return '0';
                if (!preg_match('/^[0-9]{1,10}$/', $value)) {
                    return false;
                }
                return (string) (int) $value;

            case 'select':
                $options = $setting->options ?? [];
                return array_key_exists($value, $options) ? $value : false;

            case 'string':
            default:
                if ($value === '') return '';

                // Regex actualizado: Acepta eñes, acentos, y caracteres como * . [ ] ( ) # @ $ % &
                // El flag /u es indispensable para soporte UTF-8
                $pattern = '/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s\-_.,\/()\[\]*#@$%&!]{1,255}$/u';

                if (!preg_match($pattern, $value)) {
                    return false;
                }
                if (!preg_match($pattern, $value)) {
                    return false;
                }
                return $value;

            case 'image':
                // Para tipos imagen, sanitizeValue no se usa para el upload, 
                // pero por seguridad retornamos null si llega aquí por error.
                return $value;
        }
    }
}
</file>

<file path="app/Http/Controllers/UnitController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;

class UnitController extends Controller
{
    public function index()
    {
        try {
            $units = Unit::with('compatibleBaseUnit')
                ->where('activo', true)
                ->ordered()
                ->get();
            return view('admin.units.index', compact('units'));
        } catch (\Exception $e) {
            Log::error('Error al listar unidades: ' . $e->getMessage());
            return view('admin.units.index', ['units' => collect()])
                ->with('error', 'Error al cargar las unidades');
        }
    }

    public function create()
    {
        $baseUnits = Unit::getBaseUnits();
        return view('admin.units.create', compact('baseUnits'));
    }

    public function store(Request $request)
    {
        $request->validate([
            'name' => ['required', 'string', 'min:2', 'max:50', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑ0-9\s]+$/'],
            'symbol' => ['required', 'string', 'min:1', 'max:10', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑ0-9\s]+$/'],
            'is_base' => ['sometimes', 'boolean'],
            'compatible_base_unit_id' => ['nullable', 'integer', 'exists:units,id'],
            'unit_type' => ['nullable', 'string', 'in:logistic,metric_pack'],
        ], [
            'name.required' => 'El nombre es obligatorio.',
            'name.regex' => 'El nombre solo puede contener letras, números y espacios.',
            'name.max' => 'El nombre no puede exceder 50 caracteres.',
            'symbol.required' => 'El símbolo es obligatorio.',
            'symbol.regex' => 'El símbolo solo puede contener letras, números y espacios.',
            'symbol.max' => 'El símbolo no puede exceder 10 caracteres.',
            'compatible_base_unit_id.exists' => 'La unidad base seleccionada no es válida.',
        ]);

        try {
            $name = mb_strtoupper(trim($request->name));
            $symbol = mb_strtolower(trim($request->symbol));
            $slug = Str::slug($request->name);

            // Verificar si existe una unidad con el mismo nombre, símbolo o slug
            $existingUnit = Unit::where(function ($query) use ($name, $symbol, $slug) {
                $query->where('name', $name)
                    ->orWhere('symbol', $symbol)
                    ->orWhere('slug', $slug);
            })
                ->first();

            if ($existingUnit) {
                if ($existingUnit->activo) {
                    // Ya existe una unidad activa
                    return redirect()->back()
                        ->withInput()
                        ->with('error', 'Ya existe una unidad con ese nombre o símbolo');
                }

                // Reactivar la unidad inactiva
                $existingUnit->name = $name;
                $existingUnit->slug = $slug;
                $existingUnit->symbol = $symbol;
                $existingUnit->is_base = $request->boolean('is_base');
                $existingUnit->compatible_base_unit_id = $request->boolean('is_base') ? null : $request->compatible_base_unit_id;
                $existingUnit->activo = true;
                $existingUnit->save();

                return redirect()->route('admin.units.index')->with('success', 'Unidad reactivada exitosamente');
            }

            // Crear nueva unidad
            $unit = new Unit();
            $unit->uuid = (string) Str::uuid();
            $unit->name = $name;
            $unit->slug = $slug;
            $unit->symbol = $symbol;
            $unit->is_base = $request->boolean('is_base');
            $unit->compatible_base_unit_id = $request->boolean('is_base') ? null : $request->compatible_base_unit_id;

            if (!$unit->is_base && $request->filled('unit_type')) {
                $unit->unit_type = $request->unit_type;
            }

            $unit->activo = true;
            $unit->save();

            if ($request->wantsJson()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Unidad creada exitosamente',
                    'id' => $unit->id,
                    'name' => $unit->name,
                    'symbol' => $unit->symbol
                ]);
            }

            return redirect()->route('admin.units.index')->with('success', 'Unidad creada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al crear unidad: ' . $e->getMessage());
            if ($request->wantsJson()) {
                return response()->json(['message' => 'Error al crear la unidad'], 500);
            }
            return redirect()->route('admin.units.index')->with('error', 'Error al crear la unidad');
        }
    }

    public function edit($id)
    {
        try {
            $unit = Unit::where('activo', true)->findOrFail($id);
            $baseUnits = Unit::getBaseUnits()->where('id', '!=', $id);
            return view('admin.units.edit', compact('unit', 'baseUnits'));
        } catch (\Exception $e) {
            Log::error('Error al cargar unidad para editar: ' . $e->getMessage());
            return redirect()->route('admin.units.index')->with('error', 'Unidad no encontrada');
        }
    }

    public function update(Request $request, $id)
    {
        $request->validate([
            'name' => ['required', 'string', 'min:2', 'max:50', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s0-9]+$/'],
            'symbol' => ['required', 'string', 'min:1', 'max:10', 'regex:/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s0-9]+$/'],
            'is_base' => ['sometimes', 'boolean'],
            'compatible_base_unit_id' => ['nullable', 'integer', 'exists:units,id'],
            'unit_type' => ['nullable', 'string', 'in:logistic,metric_pack'],
        ], [
            'name.required' => 'El nombre es obligatorio.',
            'name.regex' => 'El nombre solo puede contener letras, números y espacios.',
            'name.max' => 'El nombre no puede exceder 50 caracteres.',
            'symbol.required' => 'El símbolo es obligatorio.',
            'symbol.regex' => 'El símbolo solo puede contener letras, números y espacios.',
            'symbol.max' => 'El símbolo no puede exceder 10 caracteres.',
            'compatible_base_unit_id.exists' => 'La unidad base seleccionada no es válida.',
        ]);

        try {
            $unit = Unit::where('activo', true)->findOrFail($id);

            $unit->name = mb_strtoupper(trim($request->name));
            $unit->slug = Str::slug($request->name);
            $unit->symbol = mb_strtolower(trim($request->symbol));
            $unit->is_base = $request->boolean('is_base');
            $unit->compatible_base_unit_id = $request->boolean('is_base') ? null : $request->compatible_base_unit_id;

            if (!$unit->is_base && $request->filled('unit_type')) {
                $unit->unit_type = $request->unit_type;
            } else if ($unit->is_base) {
                // El observer lo pondrá en CANONICAL anyway, pero lo limpiamos aquí por claridad
                $unit->unit_type = \App\Enums\UnitType::CANONICAL;
            }

            if (!$unit->isDirty()) {
                return redirect()->route('admin.units.index')->with('info', 'No se realizaron cambios');
            }

            $unit->save();
            return redirect()->route('admin.units.index')->with('success', 'Unidad actualizada exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar unidad: ' . $e->getMessage());
            return redirect()->route('admin.units.index')->with('error', 'Error al actualizar la unidad');
        }
    }

    public function confirmDelete($id)
    {
        try {
            $unit = Unit::with(['compatibleBaseUnit', 'purchaseUnits'])
                ->where('activo', true)
                ->findOrFail($id);
            return view('admin.units.delete', compact('unit'));
        } catch (\Exception $e) {
            Log::error('Error al cargar unidad para eliminar: ' . $e->getMessage());
            return redirect()->route('admin.units.index')->with('error', 'Unidad no encontrada');
        }
    }

    public function destroy($id)
    {
        try {
            $unit = Unit::with('purchaseUnits')->where('activo', true)->findOrFail($id);

            $deletedCount = 0;

            // Si es unidad base, eliminar también las unidades de compra vinculadas
            if ($unit->is_base && $unit->purchaseUnits->count() > 0) {
                foreach ($unit->purchaseUnits as $purchaseUnit) {
                    $purchaseUnit->activo = false;
                    $purchaseUnit->save();
                    $deletedCount++;
                }
            }

            $unit->activo = false;
            $unit->save();

            $message = 'Unidad eliminada exitosamente';
            if ($deletedCount > 0) {
                $message .= ". También se eliminaron {$deletedCount} unidad(es) de compra vinculada(s).";
            }

            return redirect()->route('admin.units.index')->with('success', $message);
        } catch (\Exception $e) {
            Log::error('Error al eliminar unidad: ' . $e->getMessage());
            return redirect()->route('admin.units.index')->with('error', 'Error al eliminar la unidad');
        }
    }
}
</file>

<file path="app/Models/AttributeValue.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;

class AttributeValue extends Model
{
    use SoftDeletes;
    protected $fillable = [
        'attribute_id',
        'value',
        'hex_color',
        'order'
    ];
    protected $dates = ['deleted_at'];

    protected $casts = [
        'order' => 'integer'
    ];



    public const TALLAS_ORDENADAS = [
        'XXS' => 1,
        'XS' => 2,
        'S' => 3,
        'CH' => 3, // CH y S son lo mismo
        'M' => 4,
        'L' => 5,
        'G' => 5,
        'XL' => 6,
        'XG' => 6,
        'XXL' => 7
    ];
    /**
     * GLOBAL SCOPE DE ORDENAMIENTO
     * Esto hace que CUALQUIER consulta a AttributeValue salga ordenada por 'order'.
     */
    protected static function boot()
    {
        parent::boot();

        static::creating(function ($model) {
            $valor = strtoupper($model->value);

            // Si el valor existe en nuestro diccionario, le asigna su peso
            if (isset(self::TALLAS_ORDENADAS[$valor])) {
                $model->order = self::TALLAS_ORDENADAS[$valor];
            } else {
                // Si es una talla nueva/extraña, la manda al final
                $model->order = static::where('attribute_id', $model->attribute_id)->max('order') + 1;
            }
        });
    }

    // Relación: Un valor pertenece a un atributo
    public function attribute()
    {
        return $this->belongsTo(Attribute::class);
    }

    // Relación: Un valor está en muchas variantes
    public function designVariants()
    {
        return $this->belongsToMany(DesignVariant::class, 'design_variant_attributes');
    }
}
</file>

<file path="app/Models/DesignVariant.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

class DesignVariant extends Model
{
    use SoftDeletes;

    protected $fillable = [
        'design_id',
        'sku',
        'name',
        'price',
        'stock',
        'is_active',
        'is_default'
    ];

    protected $casts = [
        'price' => 'decimal:2',
        'stock' => 'integer',
        'is_active' => 'boolean',
        'is_default' => 'boolean'
    ];

    // Una variante pertenece a un diseño
    public function design()
    {
        return $this->belongsTo(Design::class);
    }

    // Valores de atributos (tallas, colores, etc.)
    public function attributeValues()
    {
        return $this->belongsToMany(AttributeValue::class, 'design_variant_attributes');
    }

    // 📸 Imágenes polimórficas
    public function images()
    {
        return $this->morphMany(Image::class, 'imageable');
    }

    // ⭐ Imagen principal
    public function primaryImage()
    {
        return $this->morphOne(Image::class, 'imageable')
            ->where('is_primary', true);
    }

    // NUEVA RELACIÓN: Una variante tiene muchas exportaciones (archivos de producción)
    /**
     * Relación con las exportaciones de la variante.
     * Esta relación es CRÍTICA para la funcionalidad de producción.
     * Usa la columna 'design_variant_id' como clave foránea.
     */
    public function exports()
    {
        return $this->hasMany(DesignExport::class, 'design_variant_id');
    }

    // NUEVA RELACIÓN: Usuario que creó la variante (para auditoría)
    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    // NUEVO MÉTODO: Contador de exportaciones (para optimización en vistas)
    public function getExportsCountAttribute()
    {
        // Si ya existe el campo exports_count en la tabla (optimización), usarlo
        if (isset($this->attributes['exports_count'])) {
            return $this->attributes['exports_count'];
        }
        // Si no, contar sobre la relación
        return $this->exports()->count();
    }

    // NUEVO MÉTODO: Verifica si la variante tiene exportaciones
    public function hasExports()
    {
        return $this->exports()->exists();
    }

    // NUEVO MÉTODO: Verifica si la variante tiene exportaciones aprobadas
    public function hasApprovedExports()
    {
        return $this->exports()->where('status', 'aprobado')->exists();
    }
}
</file>

<file path="app/Models/Material.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use App\Traits\HasActivityLog;
use App\Models\MaterialCategory;
use App\Models\MaterialVariant;
use App\Models\MaterialUnitConversion;
use App\Models\Unit;

class Material extends Model
{
    use HasActivityLog;

    protected $table = 'materials';

    protected $activityLogNameField = 'name';

    protected $fillable = [
        'uuid',
        'material_category_id',
        'base_unit_id',
        'consumption_unit_id',
        'name',
        'slug',
        'composition',
        'description',
        'has_color',
        'conversion_factor',
        'activo',
    ];

    protected $casts = [
        'activo' => 'boolean',
        'has_color' => 'boolean',
        'conversion_factor' => 'decimal:4',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->slug) && !empty($model->name)) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::updating(function (self $model): void {
            if ($model->isDirty('name')) {
                $model->slug = Str::slug($model->name);
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function category()
    {
        return $this->belongsTo(MaterialCategory::class, 'material_category_id');
    }

    public function baseUnit()
    {
        return $this->belongsTo(Unit::class, 'base_unit_id');
    }

    public function consumptionUnit()
    {
        return $this->belongsTo(Unit::class, 'consumption_unit_id');
    }

    public function variants()
    {
        return $this->hasMany(MaterialVariant::class, 'material_id');
    }

    public function activeVariants()
    {
        return $this->hasMany(MaterialVariant::class, 'material_id')->where('activo', true);
    }

    public function unitConversions()
    {
        return $this->hasMany(MaterialUnitConversion::class, 'material_id');
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name');
    }

    public function scopeByCategory(Builder $query, int $categoryId): Builder
    {
        return $query->where('material_category_id', $categoryId);
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getFullNameAttribute(): string
    {
        $name = $this->name;
        if ($this->composition) {
            $name .= " ({$this->composition})";
        }
        return $name;
    }

    public function getTotalStockAttribute(): float
    {
        return $this->activeVariants()->sum('current_stock');
    }

    public function getTotalValueAttribute(): float
    {
        return $this->activeVariants()->sum('current_value');
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canDelete(): array
    {
        if ($this->variants()->where('activo', true)->exists()) {
            return [
                'can_delete' => false,
                'message' => 'No se puede eliminar: tiene variantes activas asociadas.',
            ];
        }

        return ['can_delete' => true, 'message' => ''];
    }

    public function hasColor(): bool
    {
        return $this->has_color;
    }

    public function getBaseUnit(): ?Unit
    {
        return $this->baseUnit;
    }
}
</file>

<file path="app/Models/Unit.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;
use App\Traits\HasActivityLog;
use App\Enums\UnitType;

/**
 * =============================================================================
 * MODELO: UNIDAD DE MEDIDA
 * =============================================================================
 *
 * Representa las unidades de medida del sistema.
 *
 * TIPOS (unit_type):
 * - canonical   : Unidad canónica de consumo (metro, litro, pieza)
 * - metric_pack : Presentación métrica derivada (rollo 25m, caja 100pz)
 * - logistic    : Unidad logística pura de compra (cono, saco, paquete)
 *
 * @property UnitType $unit_type Tipo semántico de la unidad
 * @property bool $is_base @deprecated Use unit_type instead
 */
class Unit extends Model
{
    use SoftDeletes, HasActivityLog;

    protected $table = 'units';

    protected $activityLogNameField = 'name';

    protected $fillable = [
        'uuid',
        'name',
        'slug',
        'symbol',
        'is_base',              // @deprecated - mantener por compatibilidad
        'unit_type',            // Nuevo: fuente de verdad semántica
        'compatible_base_unit_id',
        'activo',
    ];

    protected $casts = [
        'is_base' => 'boolean', // @deprecated
        'unit_type' => UnitType::class,
        'activo' => 'boolean',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->slug) && !empty($model->name)) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::updating(function (self $model): void {
            if ($model->isDirty('name')) {
                $model->slug = Str::slug($model->name);
            }
        });

        static::saving(function (self $model): void {
            // Regla de negocio para determinar el tipo semántico
            if ($model->is_base) {
                // Si es base (marcada como consumo en la UI) -> Canonical
                $model->unit_type = UnitType::CANONICAL;
                $model->compatible_base_unit_id = null;
            } else {
                // Si no es base, solo aplicamos la lógica automática si el unit_type es nulo
                // Esto permite forzar 'logistic' vía controlador o tinker aunque tenga compatibilidad
                if (empty($model->unit_type)) {
                    if (!empty($model->compatible_base_unit_id)) {
                        $model->unit_type = UnitType::METRIC_PACK;
                    } else {
                        $model->unit_type = UnitType::LOGISTIC;
                    }
                }
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function compatibleBaseUnit()
    {
        return $this->belongsTo(Unit::class, 'compatible_base_unit_id');
    }

    public function purchaseUnits()
    {
        return $this->hasMany(Unit::class, 'compatible_base_unit_id')->where('activo', true);
    }

    public function categories()
    {
        return $this->belongsToMany(MaterialCategory::class, 'category_unit', 'unit_id', 'material_category_id')
            ->withTimestamps();
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES - SEMÁNTICOS (USAR ESTOS)
    |--------------------------------------------------------------------------
    */

    /**
     * Filtrar solo unidades activas.
     */
    public function scopeActive(Builder $query): Builder
    {
        return $query->where('activo', true);
    }

    /**
     * Filtrar unidades canónicas (consumo): metro, litro, pieza.
     */
    public function scopeCanonical(Builder $query): Builder
    {
        return $query->where('unit_type', UnitType::CANONICAL);
    }

    /**
     * Filtrar presentaciones métricas: rollo 25m, caja 100pz.
     */
    public function scopeMetricPack(Builder $query): Builder
    {
        return $query->where('unit_type', UnitType::METRIC_PACK);
    }

    /**
     * Filtrar unidades logísticas puras: cono, saco, paquete.
     * ÚNICA permitida para: Categoría↔Unidad, Material.base_unit
     */
    public function scopeLogistic(Builder $query): Builder
    {
        return $query->where('unit_type', UnitType::LOGISTIC);
    }

    /**
     * Ordenar por nombre.
     */
    public function scopeOrdered(Builder $query): Builder
    {
        return $query->orderBy('name');
    }

    /**
     * Filtrar por compatibilidad con unidad base.
     */
    public function scopeCompatibleWith(Builder $query, int $baseUnitId): Builder
    {
        return $query->where('compatible_base_unit_id', $baseUnitId);
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES - LEGACY (@deprecated)
    |--------------------------------------------------------------------------
    */

    /**
     * @deprecated Use scopeCanonical() instead
     */
    public function scopeBase(Builder $query): Builder
    {
        return $query->where('is_base', true);
    }

    /**
     * @deprecated Use scopeLogistic() or scopeMetricPack() instead
     */
    public function scopePurchase(Builder $query): Builder
    {
        return $query->where('is_base', false);
    }

    /*
    |--------------------------------------------------------------------------
    | HELPERS - TIPO DE UNIDAD
    |--------------------------------------------------------------------------
    */

    /**
     * ¿Es unidad canónica de consumo?
     */
    public function isCanonical(): bool
    {
        return $this->unit_type === UnitType::CANONICAL;
    }

    /**
     * ¿Es presentación métrica?
     */
    public function isMetricPack(): bool
    {
        return $this->unit_type === UnitType::METRIC_PACK;
    }

    /**
     * ¿Es unidad logística de compra?
     */
    public function isLogistic(): bool
    {
        return $this->unit_type === UnitType::LOGISTIC;
    }

    /**
     * ¿Puede asignarse a categorías de materiales?
     */
    public function canAssignToCategory(): bool
    {
        return $this->unit_type?->canAssignToCategory() ?? false;
    }

    /**
     * ¿Puede ser unidad base de un material?
     */
    public function canBeBaseMaterialUnit(): bool
    {
        return $this->unit_type?->canBeBaseMaterialUnit() ?? false;
    }

    /**
     * ¿Puede ser origen de una conversión?
     */
    public function canBeConversionSource(): bool
    {
        return $this->unit_type?->canBeConversionSource() ?? false;
    }

    /**
     * ¿Puede ser destino de una conversión?
     */
    public function canBeConversionTarget(): bool
    {
        return $this->unit_type?->canBeConversionTarget() ?? false;
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS ESTÁTICOS
    |--------------------------------------------------------------------------
    */

    /**
     * Obtener unidades logísticas para asignar a categorías.
     */
    public static function getLogisticUnits(): \Illuminate\Database\Eloquent\Collection
    {
        return static::active()
            ->logistic()
            ->ordered()
            ->get();
    }

    /**
     * Obtener unidades canónicas (consumo).
     */
    public static function getCanonicalUnits(): \Illuminate\Database\Eloquent\Collection
    {
        return static::active()
            ->canonical()
            ->ordered()
            ->get();
    }

    /**
     * Obtener presentaciones métricas derivadas de una unidad canónica.
     */
    public static function getMetricPacksFor(int $canonicalUnitId): \Illuminate\Database\Eloquent\Collection
    {
        return static::active()
            ->metricPack()
            ->where('compatible_base_unit_id', $canonicalUnitId)
            ->ordered()
            ->get();
    }

    /**
     * @deprecated Use getMetricPacksFor() instead
     */
    public static function getPurchaseUnitsFor(int $baseUnitId): \Illuminate\Database\Eloquent\Collection
    {
        return static::where('activo', true)
            ->where('is_base', false)
            ->where('compatible_base_unit_id', $baseUnitId)
            ->ordered()
            ->get();
    }

    /**
     * @deprecated Use getCanonicalUnits() instead
     */
    public static function getBaseUnits(): \Illuminate\Database\Eloquent\Collection
    {
        return static::where('activo', true)
            ->where('is_base', true)
            ->ordered()
            ->get();
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getDisplayNameAttribute(): string
    {
        return "{$this->name} ({$this->symbol})";
    }
}
</file>

<file path="database/migrations/2025_12_16_174451_create_estados_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('estados', function (Blueprint $table) {
            $table->id();
            $table->string('nombre_estado');
            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->string('motivo_baja')->nullable();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('estados');
    }
};
</file>

<file path="database/migrations/2025_12_19_172856_create_design_variants_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('design_variants', function (Blueprint $table) {
            $table->id();
            $table->foreignId('design_id')->constrained()->onDelete('cascade');

            // Identidad de negocio
            $table->string('sku')->unique();

            // Datos operativos
            $table->string('name');
            $table->decimal('price', 10, 2)->nullable();
            $table->integer('stock')->default(0);

            // Estado de negocio
            $table->boolean('is_active')->default(true);
            $table->boolean('is_default')->default(false);

            // Auditoría
            $table->timestamps();
            $table->timestamp('activated_at')->nullable();
            $table->timestamp('deactivated_at')->nullable();

            // Eliminación lógica (SaaS / Historial)
            $table->softDeletes();

            // Índices
            $table->index('design_id');
            $table->index('sku');
            $table->index('is_active');
        });

        /*
        decimal('price', 10, 2): Permite precios como 1234.56 (10 dígitos, 2 decimales)
        constrained(): Sin especificar tabla, Laravel deduce 'designs' por el nombre del
         */
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('design_variants');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="resources/views/admin/activity-logs/index.blade.php">
@extends('adminlte::page')

@section('title', 'Registro de Actividad')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-history"></i> REGISTRO DE ACTIVIDAD
            </h3>
        </div>

        <div class="card-body">
            {{-- FILTROS --}}
            <form method="GET" action="{{ route('admin.activity-logs.index') }}" class="mb-4">
                <div class="row">
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Usuario</label>
                            <select name="user_id" class="form-control form-control-sm">
                                <option value="">Todos</option>
                                @foreach ($users as $id => $name)
                                    <option value="{{ $id }}" {{ request('user_id') == $id ? 'selected' : '' }}>
                                        {{ $name }}
                                    </option>
                                @endforeach
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Acción</label>
                            <select name="action" class="form-control form-control-sm">
                                <option value="">Todas</option>
                                @foreach ($actions as $action)
                                    <option value="{{ $action }}"
                                        {{ request('action') == $action ? 'selected' : '' }}>
                                        {{ ucfirst($action) }}
                                    </option>
                                @endforeach
                            </select>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Desde</label>
                            <input type="date" name="date_from" class="form-control form-control-sm"
                                value="{{ request('date_from') }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Hasta</label>
                            <input type="date" name="date_to" class="form-control form-control-sm"
                                value="{{ request('date_to') }}">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>Buscar</label>
                            <input type="text" name="search" class="form-control form-control-sm"
                                value="{{ request('search') }}" placeholder="Descripción...">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-info btn-sm">
                                    <i class="fas fa-search"></i> Filtrar
                                </button>
                                <a href="{{ route('admin.activity-logs.index') }}" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <hr>

            <div class="col-12">
                <div class="table-responsive">
                    {{-- TABLA CON DATATABLE --}}
                    <table id="example1" class="table table-bordered table-hover table-condensed">
                        <thead class="thead-dark">
                            <tr style="text-align: center;">
                                <th style="width: 150px;">Fecha</th>
                                <th style="width: 120px;">Usuario</th>
                                <th style="width: 100px;">Acción</th>
                                <th>Descripción</th>
                                <th style="width: 100px;">IP</th>
                                <th style="width: 80px; text-align: center;">Detalle</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach ($logs as $log)
                                <tr style="text-align: center;">
                                    <td>
                                        <small>{{ $log->created_at->format('d/m/Y H:i:s') }}</small>
                                    </td>
                                    <td>{{ $log->user_name ?? 'Sistema' }}</td>
                                    <td>
                                        <i class="{{ $log->action_icon }}"></i>
                                        {{ $log->action_label }}
                                    </td>
                                    <td style="text-align: left;">
                                        {{ $log->description }}
                                        @if ($log->model_name)
                                            <br><small class="text-muted">{{ $log->short_model_type }}:
                                                {{ $log->model_name }}</small>
                                        @endif
                                    </td>
                                    <td><small>{{ $log->ip_address }}</small></td>
                                    <td class="text-center">
                                        <a href="{{ route('admin.activity-logs.show', $log->uuid) }}"
                                            class="btn btn-info btn-sm" title="Ver detalle">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            /* Centrar los botones */
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Registros",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Registros",
                    "infoFiltered": "(Filtrado de _MAX_ total Registros)",
                    "lengthMenu": "Mostrar _MENU_ Registros",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/attributes/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nuevo Atributo')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVO ATRIBUTO</h3>
            </div>

            <div class="card-body">
                <form method="post" action="{{ route('admin.attributes.store') }}">
                    @csrf
                    @method('POST')

                    <div class="row">
                        <div class="col-md-12">
                            <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                                <h5 style="color: #007bff; font-weight: 600;">
                                    <i class="fas fa-tags"></i> Datos del Atributo
                                </h5>
                            </div>

                            {{-- Nombre --}}
                            <div class="form-group">
                                <label>Nombre del Atributo <span style="color: red;">*</span></label>
                                <input type="text" name="name"
                                    class="form-control form-control-sm @error('name') is-invalid @enderror"
                                    value="{{ old('name') }}" required placeholder="Ej: Color, Talla, Material"
                                    maxlength="100">
                                @error('name')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">Solo letras y espacios (máx. 100 caracteres)</small>
                            </div>

                            {{-- Tipo
                        <div class="form-group">
                            <label>Tipo de Atributo <span style="color: red;">*</span></label>
                            <select name="type" class="form-control form-control-sm @error('type') is-invalid @enderror"
                                required>
                                <option value="">Selecciona un tipo</option>
                                <option value="select" {{ old('type') == 'select' ? 'selected' : '' }}>Selector (Lista
                                    desplegable)</option>
                                <option value="color" {{ old('type') == 'color' ? 'selected' : '' }}>Color (Con paleta de
                                    colores)</option>
                                <option value="text" {{ old('type') == 'text' ? 'selected' : '' }}>Texto (Campo libre)
                                </option>
                            </select>
                            @error('type')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div> --}}

                            <div class="row">
                                {{-- Requerido 
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>¿Es Requerido?</label>
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" id="is_required"
                                            name="is_required" value="1" {{ old('is_required') ? 'checked' : '' }}>
                                        <label class="custom-control-label" for="is_required">
                                            <span id="required_label">{{ old('is_required') ? 'Sí' : 'No' }}</span>
                                        </label>
                                    </div>
                                </div>
                            </div> --}}

                                {{-- Orden 
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Orden de Visualización</label>
                                    <input type="number" name="order"
                                        class="form-control form-control-sm @error('order') is-invalid @enderror"
                                        value="{{ old('order', 0) }}" min="0" max="9999" placeholder="0">
                                    @error('order')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                    <small class="form-text text-muted">Número menor = mayor prioridad</small>
                                </div>
                            </div>
                        </div> --}}

                                {{-- Botones --}}
                                <div class="d-flex justify-content-end align-items-center mt-4">
                                    <a href="{{ route('admin.attributes.index') }}" class="btn btn-secondary mr-2">
                                        <i class="fas fa-times-circle"></i> Regresar
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                </div>
                            </div>
                        </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('css')
@stop

@section('js')
    <script>
        $(document).ready(function() {
            // Toggle label para switch de requerido
            $('#is_required').on('change', function() {
                $('#required_label').text($(this).is(':checked') ? 'Sí' : 'No');
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/attributes/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Atributo')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-warning">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> EDITAR ATRIBUTO</h3>
            </div>

            <div class="card-body">
                <form method="post" action="{{ route('admin.attributes.update', $attribute->id) }}">
                    @csrf
                    @method('PUT')

                    <div class="row">
                        <div class="col-md-12">
                            <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                                <h5 style="color: #856404; font-weight: 600;">
                                    <i class="fas fa-tags"></i> Datos del Atributo
                                </h5>
                            </div>

                            {{-- Nombre --}}
                            <div class="form-group">
                                <label>Nombre del Atributo <span style="color: red;">*</span></label>
                                <input type="text" name="name"
                                    class="form-control form-control-sm @error('name') is-invalid @enderror"
                                    value="{{ old('name', $attribute->name) }}" required
                                    placeholder="Ej: Color, Talla, Material" maxlength="100">
                                @error('name')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">Solo letras y espacios (máx. 100 caracteres)</small>
                            </div>

                            {{-- Tipo 
                            <div class="form-group">
                                <label>Tipo de Atributo <span style="color: red;">*</span></label>
                                <select name="type"
                                    class="form-control form-control-sm @error('type') is-invalid @enderror" >
                                    <option value="">Selecciona un tipo</option>
                                    <option value="select"
                                        {{ old('type', $attribute->type) == 'select' ? 'selected' : '' }}>
                                        Selector (Lista desplegable)</option>
                                    <option value="color" {{ old('type', $attribute->type) == 'color' ? 'selected' : '' }}>
                                        Color (Con paleta de colores)</option>
                                    <option value="text" {{ old('type', $attribute->type) == 'text' ? 'selected' : '' }}>
                                        Texto
                                        (Campo libre)</option>
                                </select>
                                @error('type')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div> --}}

                            {{-- Requerido 
                            <div class="row">

                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>¿Es Requerido?</label>
                                        <div class="custom-control custom-switch">
                                            <input type="checkbox" class="custom-control-input" id="is_required"
                                                name="is_required" value="1"
                                                {{ old('is_required', $attribute->is_required) ? 'checked' : '' }}>
                                            <label class="custom-control-label" for="is_required">
                                                <span
                                                    id="required_label">{{ old('is_required', $attribute->is_required) ? 'Sí' : 'No' }}</span>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                {{-- Orden 
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Orden de Visualización</label>
                                        <input type="number" name="order"
                                            class="form-control form-control-sm @error('order') is-invalid @enderror"
                                            value="{{ old('order', $attribute->order) }}" min="0" max="9999"
                                            placeholder="0">
                                        @error('order')
                                            <div class="invalid-feedback">{{ $message }}</div>
                                        @enderror
                                        <small class="form-text text-muted">Número menor = mayor prioridad</small>
                                    </div>
                                </div>
                            </div> --}}

                            {{-- Botones --}}
                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <a href="{{ route('admin.attributes.index') }}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save"></i> Actualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('css')
@stop

@section('js')
    <script>
        $(document).ready(function() {
            // Toggle label para switch de requerido
            $('#is_required').on('change', function() {
                $('#required_label').text($(this).is(':checked') ? 'Sí' : 'No');
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/attributes/index.blade.php">
@extends('adminlte::page')

@section('title', 'Atributos')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    <div class="row">

        {{-- ================== COLUMNA ATRIBUTOS ================== --}}
        <div class="col-12 col-lg-6">

            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title font-weight-bold">ATRIBUTOS</h3>
                </div>

                <div class="card-body">
                    <div class="mb-3">
                        <a href="{{ route('admin.attributes.create') }}" class="btn btn-primary">
                            Nuevo Atributo <i class="fas fa-plus"></i>
                        </a>
                    </div>

                    <div class="table-responsive">
                        <table id="tableAtributos" class="table table-bordered table-hover text-center">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Nombre</th>
                                    <th>Slug</th>
                                    <th>Tipo</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach ($attributes as $attribute)
                                    <tr>
                                        <td>{{ $loop->iteration }}</td>
                                        <td>{{ $attribute->name }}</td>
                                        <td><code>{{ $attribute->slug }}</code></td>
                                        <td>
                                            @switch($attribute->type)
                                                @case('select')
                                                    <span class="badge badge-primary">Selector</span>
                                                @break

                                                @case('color')
                                                    <span class="badge badge-warning">Color</span>
                                                @break

                                                @case('text')
                                                    <span class="badge badge-secondary">Texto</span>
                                                @break
                                            @endswitch
                                        </td>
                                        <td>
                                            <a href="{{ route('admin.attributes.edit', $attribute->id) }}"
                                                class="btn btn-warning btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <a href="{{ route('admin.attributes.confirm_delete', $attribute->id) }}"
                                                class="btn btn-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                @endforeach
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>

        {{-- ================== COLUMNA VALORES ================== --}}
        <div class="col-12 col-lg-6">

            <div class="card card-success">
                <div class="card-header">
                    <h3 class="card-title font-weight-bold">VALORES DE ATRIBUTOS</h3>
                </div>

                <div class="card-body">
                    <div class="mb-3">
                        <a href="{{ route('admin.attribute-values.create') }}" class="btn btn-success">
                            Nuevo Valor <i class="fas fa-plus"></i>
                        </a>
                    </div>

                    <div class="table-responsive">
                        <table id="tableValores" class="table table-bordered table-hover text-center">
                            <thead class="thead-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Atributo</th>
                                    <th>Valor</th>
                                    <th>Color</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach ($attributeValues as $value)
                                    <tr>
                                        <td>{{ $loop->iteration }}</td>
                                        <td>
                                            <span class="badge badge-info">
                                                {{ $value->attribute->name ?? 'N/A' }}
                                            </span>
                                        </td>
                                        <td>{{ $value->value }}</td>
                                        <td>
                                            @if ($value->hex_color)
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <span
                                                        style="
                                                    width: 22px;
                                                    height: 22px;
                                                    background-color: {{ $value->hex_color }};
                                                    border: 2px solid #333;
                                                    border-radius: 4px;
                                                    margin-right: 6px;">
                                                    </span>
                                                    <code>{{ $value->hex_color }}</code>
                                                </div>
                                            @else
                                                <span class="text-muted">N/A</span>
                                            @endif
                                        </td>
                                        <td>
                                            <a href="{{ route('admin.attribute-values.edit', $value->id) }}"
                                                class="btn btn-warning btn-sm">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <a href="{{ route('admin.attribute-values.confirm_delete', $value->id) }}"
                                                class="btn btn-danger btn-sm">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </td>
                                    </tr>
                                @endforeach
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #tableAtributos_wrapper .dt-buttons,
        #tableValores_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        /* Estilo personalizado para los botones */
        #tableAtributos_wrapper .btn,
        #tableValores_wrapper .btn {
            color: #fff;
            border-radius: 4px;
            padding: 5px 15px;
            font-size: 14px;
        }

        /* Colores por tipo de botón */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }

        .gap-1 {
            gap: 0.5rem;
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            // DataTable para Atributos
            $("#tableAtributos").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay información",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Atributos",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Atributos",
                    "infoFiltered": "(Filtrado de _MAX_ total Atributos)",
                    "lengthMenu": "Mostrar _MENU_ Atributos",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#tableAtributos_wrapper .row:eq(0)');

            // DataTable para Valores
            $("#tableValores").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay información",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Valores",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Valores",
                    "infoFiltered": "(Filtrado de _MAX_ total Valores)",
                    "lengthMenu": "Mostrar _MENU_ Valores",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#tableValores_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/attributes/values/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nuevo Valor de Atributo')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-success">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVO VALOR DE ATRIBUTO</h3>
            </div>

            <div class="card-body">
                <form method="post" action="{{ route('admin.attribute-values.store') }}" id="formValorAtributo">
                    @csrf

                    <div class="row">
                        <div class="col-md-12">
                            <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                                <h5 style="color: #28a745; font-weight: 600;">
                                    <i class="fas fa-tag"></i> Datos del Valor
                                </h5>
                            </div>

                            {{-- Atributo --}}
                            <div class="form-group">
                                <label>Atributo <span style="color: red;">*</span></label>
                                <select name="attribute_id" id="attribute_id"
                                    class="form-control form-control-sm @error('attribute_id') is-invalid @enderror"
                                    required>
                                    <option value="" data-slug="">Selecciona un atributo</option>
                                    @foreach ($attributes as $attribute)
                                        <option value="{{ $attribute->id }}" data-slug="{{ $attribute->slug }}"
                                            {{ old('attribute_id') == $attribute->id ? 'selected' : '' }}>
                                            {{ $attribute->name }}
                                        </option>
                                    @endforeach
                                </select>
                                @error('attribute_id')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            {{-- Valor --}}
                            <div class="form-group">
                                <label>Nombre del Valor <span style="color: red;">*</span></label>
                                <input type="text" name="value"
                                    class="form-control form-control-sm @error('value') is-invalid @enderror"
                                    value="{{ old('value') }}" required placeholder="Ej: Rojo, Grande, Algodón"
                                    maxlength="100">
                                @error('value')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">Letras, números, espacios y guiones (máx. 100
                                    caracteres)</small>
                            </div>

                            {{-- Color Picker (Dinámico) --}}
                            <div class="form-group" id="color_picker_container" style="display: none;">
                                <label>Color Hexadecimal <span style="color: red;">*</span></label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <input type="color" id="color_picker" class="form-control" value="#000000"
                                            style="height: 45px; padding: 2px; cursor: pointer;">
                                    </div>
                                    <div class="col-md-9">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">#</span>
                                            </div>
                                            <input type="text" name="hex_color" id="hex_color"
                                                class="form-control form-control-sm @error('hex_color') is-invalid @enderror"
                                                value="{{ old('hex_color', '#000000') }}" placeholder="RRGGBB"
                                                maxlength="7" pattern="^#[0-9A-Fa-f]{6}$">
                                            @error('hex_color')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                        <small class="form-text text-muted">Formato: #RRGGBB (ej: #FF0000 para rojo)</small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <label>Vista previa:</label>
                                    <div id="color_preview"
                                        style="
                                    width: 100%;
                                    height: 40px;
                                    background-color: #000000;
                                    border: 2px solid #333;
                                    border-radius: 4px;
                                ">
                                    </div>
                                </div>
                            </div>

                            {{-- Orden
                            <div class="form-group">
                                <label>Orden de Visualización</label>
                                <input type="number" name="order"
                                    class="form-control form-control-sm @error('order') is-invalid @enderror"
                                    value="{{ old('order', 0) }}" min="0" max="9999" placeholder="0">
                                @error('order')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                                <small class="form-text text-muted">Número menor = mayor prioridad</small>
                            </div> --}}

                            {{-- Botones --}}
                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <a href="{{ route('admin.attributes.index') }}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        #color_picker {
            border: 2px solid #ced4da;
            border-radius: 4px;
        }

        #color_picker:hover {
            border-color: #28a745;
        }
    </style>
@stop
@section('js')
    <script src="https://chir.ag/projects/ntc/ntc.js"></script>

    <script>
        $(document).ready(function() {
            const $attributeSelect = $('#attribute_id');
            const $colorContainer = $('#color_picker_container');
            const $hexInput = $('#hex_color');
            const $colorPicker = $('#color_picker');
            const $colorPreview = $('#color_preview');
            const $valueInput = $('input[name="value"]');

            /**
             * Obtiene el nombre del color usando ntc.js
             */
            function getColorName(hex) {
                if (!hex || hex.length < 4) return "";
                const match = ntc.name(hex);
                return match[1];
            }

            function updateUI(hex) {
                if (/^#[0-9A-Fa-f]{3,6}$/.test(hex)) {
                    const normalizedHex = hex.toUpperCase();
                    $colorPicker.val(normalizedHex);
                    $colorPreview.css('background-color', normalizedHex);

                    const colorName = getColorName(normalizedHex);
                    $valueInput.val(colorName);
                }
            }

            function toggleDisplay() {
                const isColor = $attributeSelect.find('option:selected').data('slug') === 'color';

                if (isColor) {
                    $colorContainer.slideDown();
                    $hexInput.prop('required', true);
                    if (!$hexInput.val()) $hexInput.val('#000000');
                    updateUI($hexInput.val());
                } else {
                    // RESET TOTAL
                    $colorContainer.slideUp();
                    $hexInput.prop('required', false).val('');
                    $valueInput.val('');
                    $colorPreview.css('background-color', 'transparent');
                }
            }

            // --- EVENTOS ---
            $attributeSelect.on('change', toggleDisplay);

            $colorPicker.on('input change', function() {
                const hex = $(this).val();
                $hexInput.val(hex.toUpperCase());
                updateUI(hex);
            });

            $hexInput.on('input', function() {
                let val = $(this).val().trim();
                if (val && !val.startsWith('#')) {
                    val = '#' + val;
                    $(this).val(val);
                }
                if (val.length === 7) updateUI(val);
            });

            toggleDisplay();
        });
    </script>
@stop
</file>

<file path="resources/views/admin/attributes/values/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Valor de Atributo')

@section('content_header')
@stop

@section('content')
    <br>

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-danger">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> ELIMINAR VALOR DE ATRIBUTO</h3>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-danger">
                            <h5><i class="icon fas fa-exclamation-triangle"></i> ¡Atención!</h5>
                            <p>Está a punto de eliminar el siguiente valor de atributo. Esta acción no se puede deshacer.
                            </p>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 30%;">Atributo:</th>
                                        <td>
                                            <span
                                                class="badge badge-info">{{ $attributeValue->attribute->name ?? 'N/A' }}</span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Valor:</th>
                                        <td><strong>{{ $attributeValue->value }}</strong></td>
                                    </tr>
                                    @if ($attributeValue->hex_color)
                                        <tr>
                                            <th>Color:</th>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span
                                                        style="
                                                display: inline-block;
                                                width: 30px;
                                                height: 30px;
                                                background-color: {{ $attributeValue->hex_color }};
                                                border: 2px solid #333;
                                                border-radius: 4px;
                                                margin-right: 10px;
                                            "></span>
                                                    <code>{{ $attributeValue->hex_color }}</code>
                                                </div>
                                            </td>
                                        </tr>
                                    @endif

                                    <tr>
                                        <th>Creado:</th>
                                        <td>{{ $attributeValue->created_at->format('d/m/Y H:i') }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <form id="deleteForm" method="POST"
                            action="{{ route('admin.attribute-values.destroy', $attributeValue->id) }}">
                            @csrf
                            @method('DELETE')

                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <a href="{{ route('admin.attributes.index') }}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times-circle"></i> Cancelar
                                </a>
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> Confirmar Eliminación
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
@stop

@section('js')
    <script>
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: '¿Está seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminarlo',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/attributes/values/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Valor de Atributo')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-warning">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> EDITAR VALOR DE ATRIBUTO</h3>
            </div>

            <div class="card-body">
                <form method="post" action="{{ route('admin.attribute-values.update', $attributeValue->id) }}"
                    id="formValorAtributo">
                    @csrf
                    @method('PUT')

                    <div class="row">
                        <div class="col-md-12">
                            <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                                <h5 style="color: #856404; font-weight: 600;">
                                    <i class="fas fa-tag"></i> Datos del Valor
                                </h5>
                            </div>

                            {{-- Atributo --}}
                            <div class="form-group">
                                <label>Atributo <span style="color: red;">*</span></label>
                                <select name="attribute_id" id="attribute_id"
                                    class="form-control form-control-sm @error('attribute_id') is-invalid @enderror"
                                    required>
                                    <option value="" data-slug="">Selecciona un atributo</option>
                                    @foreach ($attributes as $attribute)
                                        <option value="{{ $attribute->id }}" data-slug="{{ $attribute->slug }}"
                                            {{ old('attribute_id', $attributeValue->attribute_id) == $attribute->id ? 'selected' : '' }}>
                                            {{ $attribute->name }}

                                        </option>
                                    @endforeach
                                </select>
                                @error('attribute_id')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            {{-- Valor --}}
                            <div class="form-group">
                                <label>Nombre del Valor <span style="color: red;">*</span></label>
                                <input type="text" name="value" {{-- CAMBIADO: Antes decía "name" --}}
                                    class="form-control form-control-sm @error('value') is-invalid @enderror"
                                    value="{{ old('value', $attributeValue->value) }}" required
                                    placeholder="Ej: Rojo, Grande, Algodón" maxlength="100">

                                @error('value')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror

                                <small class="form-text text-muted">
                                    Letras, números, espacios y guiones (máx. 100 caracteres)
                                </small>
                            </div>

                            {{-- Color Picker (Dinámico) --}}
                            <div class="form-group" id="color_picker_container" style="display: none;">
                                <label>Color Hexadecimal <span style="color: red;">*</span></label>
                                <div class="row">
                                    <div class="col-md-3">
                                        <input type="color" id="color_picker" class="form-control"
                                            value="{{ old('hex_color', $attributeValue->hex_color ?? '#000000') }}"
                                            style="height: 45px; padding: 2px; cursor: pointer;">
                                    </div>
                                    <div class="col-md-9">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">#</span>
                                            </div>
                                            <input type="text" name="hex_color" id="hex_color"
                                                class="form-control form-control-sm @error('hex_color') is-invalid @enderror"
                                                value="{{ old('hex_color', $attributeValue->hex_color ?? '#000000') }}"
                                                placeholder="RRGGBB" maxlength="7" pattern="^#[0-9A-Fa-f]{6}$">
                                            @error('hex_color')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                        <small class="form-text text-muted">Formato: #RRGGBB (ej: #FF0000 para rojo)</small>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <label>Vista previa:</label>
                                    <div id="color_preview"
                                        style="
                                    width: 100%;
                                    height: 40px;
                                    background-color: {{ old('hex_color', $attributeValue->hex_color ?? '#000000') }};
                                    border: 2px solid #333;
                                    border-radius: 4px;
                                ">
                                    </div>
                                </div>
                            </div>


                            {{-- Botones --}}
                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <a href="{{ route('admin.attributes.index') }}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save"></i> Actualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        #color_picker {
            border: 2px solid #ced4da;
            border-radius: 4px;
        }

        #color_picker:hover {
            border-color: #ffc107;
        }
    </style>
@stop
@section('js')
    <script src="https://chir.ag/projects/ntc/ntc.js"></script>

    <script>
        $(document).ready(function() {
            const $attributeSelect = $('#attribute_id');
            const $colorContainer = $('#color_picker_container');
            const $hexInput = $('#hex_color');
            const $colorPicker = $('#color_picker');
            const $colorPreview = $('#color_preview');
            const $valueInput = $('input[name="value"]');

            // Flag para identificar la carga inicial
            let isInitialLoad = true;

            /**
             * Obtiene el nombre del color usando ntc.js
             */
            function getColorName(hex) {
                if (!hex || hex.length < 4) return "";
                const match = ntc.name(hex);
                return match[1];
            }

            function updateUI(hex) {
                if (/^#[0-9A-Fa-f]{3,6}$/.test(hex)) {
                    $colorPicker.val(hex);
                    $colorPreview.css('background-color', hex);

                    // Solo autocompletar el nombre si el usuario está interactuando (no en carga inicial)
                    if (!isInitialLoad) {
                        const colorName = getColorName(hex);
                        $valueInput.val(colorName);
                    }
                }
            }

            function toggleDisplay() {
                const selectedOption = $attributeSelect.find('option:selected');
                const isColor = selectedOption.data('slug') === 'color';

                if (isColor) {
                    $colorContainer.slideDown();
                    $hexInput.prop('required', true);

                    if (!$hexInput.val()) {
                        $hexInput.val('#000000');
                    }
                    updateUI($hexInput.val());
                } else {
                    $colorContainer.slideUp();
                    $hexInput.prop('required', false);

                    // Solo resetear si el usuario está CAMBIANDO el select,
                    // no cuando la página carga por primera vez.
                    if (!isInitialLoad) {
                        $hexInput.val('');
                        $valueInput.val('');
                        $colorPreview.css('background-color', 'transparent');
                    }
                }
            }

            // --- MANEJO DE EVENTOS ---

            $attributeSelect.on('change', function() {
                isInitialLoad = false;
                toggleDisplay();
            });

            $colorPicker.on('input change', function() {
                isInitialLoad = false;
                const hex = $(this).val().toUpperCase();
                $hexInput.val(hex);
                updateUI(hex);
            });

            $hexInput.on('input', function() {
                isInitialLoad = false;
                let hex = $(this).val().trim();
                if (hex && !hex.startsWith('#')) {
                    hex = '#' + hex;
                    $(this).val(hex);
                }
                if (hex.length === 7) {
                    updateUI(hex);
                }
            });

            // Ejecución inicial
            toggleDisplay();

            // Finalizamos la carga inicial después de ejecutar toggleDisplay
            isInitialLoad = false;
        });
    </script>
@stop
</file>

<file path="resources/views/admin/categorias/create.blade.php">
@extends('adminlte::page')

@section('title', 'CATEGORIA')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-12 col-md-6 col-lg-4">

        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        <div class="card card-primary " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVA CATEGORIA</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.categories.store') }}">
                    @csrf
                    @method('POST')
                    <div class="col-md-12">
                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos de la Categoría
                            </h5>
                        </div>
                        <div class="form-group">
                            <label for="name">Nombre <span style="color: red;">*</span></label>
                            <input type="text" class="form-control form-control-sm @error('name') is-invalid @enderror"
                                id="name" name="name" placeholder="Ej: Plantas" required
                                pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+" title="Solo se permiten letras y espacios"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')"
                                value="{{ old('name') }}">
                        </div>
                        @error('name')
                            <div class="text-danger">{{ $message }}</div>
                        @enderror

                        <!-- Botones de acción -->
                        <div class="d-flex flex-column flex-sm-row justify-content-end mt-4">
                            <a href="{{ route('admin.categories.index') }}" class="btn btn-secondary mb-2 mb-sm-0 mr-sm-2">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')


@stop
</file>

<file path="resources/views/admin/categorias/edit.blade.php">
@extends('adminlte::page')

@section('title', 'CATEGORIA')

@section('content_header')
@stop

@section('content')
    <br>
    <br>
    <div class="col-12 col-md-6 col-lg-4">

        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        <div class="card card-warning " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                    EDITAR CATEGORIA
                </h3>
            </div>

            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.categories.update', $category->id) }}">
                    @csrf
                    @method('PUT')

                    <div class="col-md-12">

                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos de la Categoria
                            </h5>
                        </div>

                        <div class="form-group">
                            <label for="name">
                                Nombre <span style="color: red;">*</span>
                            </label>

                            <input type="text" class="form-control form-control-sm @error('name') is-invalid @enderror"
                                id="name" name="name" placeholder="Ej: MEXICO" pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+"
                                title="Solo se permiten letras y espacios" value="{{ $category->name }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" required>

                            @error('name')
                                <div class="invalid-feedback">
                                    {{ $message }}
                                </div>
                            @enderror
                        </div>

                        <div class="row mt-4">
                            <div class="col-12 text-right">
                                <a href="{{ route('admin.categories.index') }}" class="btn btn-secondary"
                                    style="margin-right: 10px;">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>

                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Actualizar
                                </button>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
@stop


@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/clientes/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nuevo Cliente')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVO CLIENTE</h3>
        </div>

        <div class="card-body">
            <form method="post" action="{{ route('admin.clientes.store') }}">
                @csrf
                @method('POST')

                <div class="row">
                    {{-- DATOS DEL CLIENTE --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">

                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-user-tie"></i> Datos del Cliente
                            </h5>
                        </div>


                        {{-- Nombres y apellidos --}}
                        <div class="row">
                            {{-- Nombres --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="nombre">Nombres <span style="color: red;">*</span></label>
                                    <input type="text" name="nombre" id="nombre"
                                        class="form-control form-control-sm @error('nombre') is-invalid @enderror"
                                        value="{{ old('nombre') }}" required placeholder="Nombres"
                                        oninput="this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')">
                                    @error('nombre')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- Apellidos --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="apellidos">Apellidos <span style="color: red;">*</span></label>
                                    <input type="text" name="apellidos" id="apellidos"
                                        class="form-control form-control-sm @error('apellidos') is-invalid @enderror"
                                        value="{{ old('apellidos') }}" required placeholder="Apellidos"
                                        oninput="this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')">
                                    @error('apellidos')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>



                        {{-- Dirección --}}
                        <div class="row">
                            <div class="col-md-10">
                                <div class="form-group">
                                    <label for="direccion">Dirección</label>
                                    <input type="text" name="direccion" id="direccion"
                                        class="form-control form-control-sm @error('direccion') is-invalid @enderror"
                                        value="{{ old('direccion') }}" placeholder="Dirección">
                                    @error('direccion')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="codigo_postal">C.P.</label>
                                    <input type="text" name="codigo_postal" id="codigo_postal"
                                        class="form-control form-control-sm @error('codigo_postal') is-invalid @enderror"
                                        value="{{ old('codigo_postal') }}" maxlength="5"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{5}"
                                        placeholder="Ej: 97000">
                                    @error('codigo_postal')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Teléfono y correo --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="telefono">Teléfono <span style="color: red;">*</span></label>
                                    <input type="phone" name="telefono" id="telefono"
                                        class="form-control form-control-sm @error('telefono') is-invalid @enderror"
                                        value="{{ old('telefono') }}" required placeholder="Ej: 2233445566" maxlength="10"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}">
                                    @error('telefono')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" name="email" id="email"
                                        class="form-control form-control-sm @error('email') is-invalid @enderror"
                                        value="{{ old('email') }}" placeholder="Ej: correo@correo.com">
                                    @error('email')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Estado y ciudad --}}
                        {{-- estado --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="estado_id">Estado <span style="color: red;">*</span></label>
                                    <select name="estado_id" id="estado_id"
                                        class="form-control form-control-sm @error('estado_id') is-invalid @enderror"
                                        required>
                                        <option value="">Selecciona un estado</option>
                                        @foreach ($estados as $estado)
                                            <option value="{{ $estado->id }}"
                                                {{ old('estado_id') == $estado->id ? 'selected' : '' }}>
                                                {{ $estado->nombre_estado }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('estado_id')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- ciudad --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="ciudad">Ciudad <span style="color: red;">*</span></label>
                                    <input type="text" name="ciudad" id="ciudad"
                                        class="form-control form-control-sm @error('ciudad') is-invalid @enderror"
                                        value="{{ old('ciudad') }}" placeholder="Ej: Mérida">
                                    @error('ciudad')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>




                        {{-- Recomendacion --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="recomendacion_id">Recomendacion <span style="color: red;">*</span></label>
                                    <select name="recomendacion_id" id="recomendacion_id"
                                        class="form-control form-control-sm @error('recomendacion_id') is-invalid @enderror"
                                        required>
                                        <option value="">Selecciona una recomendacion</option>
                                        @foreach ($recomendaciones as $recomendacion)
                                            <option value="{{ $recomendacion->id }}"
                                                {{ old('recomendacion_id') == $recomendacion->id ? 'selected' : '' }}>
                                                {{ $recomendacion->nombre_recomendacion }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('recomendacion_id')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- observaciones --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="observaciones">Observaciones <span style="color: red;">*</span></label>
                                    <textarea name="observaciones" id="observaciones" placeholder="Observaciones"
                                        class="form-control form-control-sm @error('observaciones') is-invalid @enderror">{{ old('observaciones') }}</textarea>
                                    @error('observaciones')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>





                        {{-- Botones --}}
                        <div class="text-center mt-4">
                            <a href="{{ route('admin.clientes.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </div>

                    {{-- MEDIDAS --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid rgb(225, 0, 255); padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: rgb(225, 0, 255); font-weight: 600;">
                                <i class="fas fa-ruler-vertical text-pink"></i>
                                <i class="fas fa-female fa-lg mr-2 text-pink"></i> Medidas(cm)
                            </h5>
                        </div>

                        {{-- BUSTO --}}
                        <div class="row">
                            <div class="form-group col-md-4 text-center">
                                <label for="busto" class="medida-label">BUSTO</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/busto.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="busto" id="busto"
                                        class="form-control form-control-sm medida-input @error('busto') is-invalid @enderror"
                                        value="{{ old('busto') }}" placeholder="Ej: 80.56" maxlength="6"
                                        inputmode="decimal" oninput="validateMedida(this)">
                                    @error('busto')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- ALTO CINTURA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="alto_cintura" class="medida-label">ALTO CINTURA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/alto_cintura.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="alto_cintura" id="alto_cintura"
                                        class="form-control form-control-sm medida-input @error('alto_cintura') is-invalid @enderror"
                                        value="{{ old('alto_cintura') }}" placeholder="Ej: 80.56" maxlength="6"
                                        inputmode="decimal" oninput="validateMedida(this)">
                                    @error('alto_cintura')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- CINTURA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="cintura" class="medida-label">CINTURA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/cintura.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="cintura" id="cintura"
                                        class="form-control form-control-sm medida-input @error('cintura') is-invalid @enderror"
                                        value="{{ old('cintura') }}" placeholder="Ej: 80.56" maxlength="6"
                                        inputmode="decimal" oninput="validateMedida(this)">
                                    @error('cintura')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- CADERA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="cadera" class="medida-label">CADERA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/cadera.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="cadera" id="cadera"
                                        class="form-control form-control-sm medida-input @error('cadera') is-invalid @enderror"
                                        value="{{ old('cadera') }}" placeholder="Ej: 80.56" maxlength="6"
                                        inputmode="decimal" oninput="validateMedida(this)">
                                    @error('cadera')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- LARGO --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="largo" class="medida-label">LARGO</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/largo.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="largo" id="largo"
                                        class="form-control form-control-sm medida-input @error('largo') is-invalid @enderror"
                                        value="{{ old('largo') }}" placeholder="Ej: 80.56" maxlength="6"
                                        inputmode="decimal" oninput="validateMedida(this)">
                                    @error('largo')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>
@stop

@section('css')
    <style>
        /* === CONTENEDOR PRINCIPAL === */
        .medida-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px 12px 14px;
            background: #ffffff;
            transition:
                box-shadow 0.25s ease,
                transform 0.25s ease,
                border-color 0.25s ease;
            cursor: pointer;
            position: relative;
        }

        /* === HOVER PREMIUM === */
        .medida-card:hover {
            transform: translateY(-4px);
            border-color: rgba(247, 0, 255, 0.779);
            box-shadow:
                0 10px 22px rgba(0, 0, 0, 0.06),
                0 4px 8px rgba(0, 0, 0, 0.04);
        }

        /* === IMAGEN === */
        .medida-img {
            width: 55%;
            margin-bottom: 10px;
            transition: transform 0.25s ease, opacity 0.25s ease;
        }

        .medida-card:hover .medida-img {
            transform: scale(1.03);
            opacity: 0.95;
        }

        /* === INPUT === */
        .medida-input {
            border-radius: 8px;
            transition:
                box-shadow 0.2s ease,
                border-color 0.2s ease;
        }

        /* FOCUS REAL (APPLE STYLE) */
        .medida-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }

        /* === LABEL === */
        .medida-label {
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
            color: #111827;
        }

        /* === ERROR VISUAL === */
        .medida-input.is-invalid {
            border-color: #dc3545;
            box-shadow: none;
        }

        .invalid-feedback {
            font-size: 0.75rem;
            margin-top: 6px;
        }
    </style>
@stop

@section('js')
    <script>
        function validateMedida(input) {
            let value = input.value;

            // 1. Eliminar todo excepto números y punto
            value = value.replace(/[^0-9.]/g, '');

            // 2. Evitar más de un punto
            value = value.replace(/(\..*)\./g, '$1');

            // Regex FINAL (igual al backend)
            const finalRegex = /^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/;

            // Regex parcial permitida SOLO para escribir
            const partialRegex = /^[1-9]\d{0,2}(\.\d{0,2})?$/;

            // 3. Bloquear casos inválidos inmediatos
            if (
                value === '.' ||
                value === '0' ||
                value === '0.' ||
                value === '.0'
            ) {
                input.value = '';
                return;
            }

            // 4. Permitir escritura progresiva válida
            if (!partialRegex.test(value)) {
                input.value = value.slice(0, -1);
                return;
            }

            // 5. Validación visual final
            if (finalRegex.test(value)) {
                input.classList.remove('is-invalid');
            } else {
                input.classList.add('is-invalid');
            }

            input.value = value;
        }
    </script>

@stop
</file>

<file path="resources/views/admin/clientes/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Cliente')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="card card-danger">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> ELIMINAR CLIENTE</h3>
        </div>

        <div class="card-body">
            <form id="deleteForm" method="post" action="{{ route('admin.clientes.destroy', $cliente->id) }}">
                @csrf
                @method('DELETE')

                <div class="row">
                    {{-- DATOS DEL CLIENTE --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">

                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-user-tie"></i> Datos del Cliente
                            </h5>
                        </div>


                        {{-- Nombres y apellidos --}}
                        <div class="row">
                            {{-- Nombres --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="nombre">Nombres <span style="color: red;">*</span></label>
                                    <input type="text" name="nombre" id="nombre"
                                        class="form-control form-control-sm @error('nombre') is-invalid @enderror"
                                        value="{{ old('nombre', $cliente->nombre) }}" required placeholder="Nombres"
                                        oninput="this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')" disabled>
                                    @error('nombre')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- Apellidos --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="apellidos">Apellidos <span style="color: red;">*</span></label>
                                    <input type="text" name="apellidos" id="apellidos"
                                        class="form-control form-control-sm @error('apellidos') is-invalid @enderror"
                                        value="{{ old('apellidos', $cliente->apellidos) }}" required placeholder="Apellidos"
                                        oninput="this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')" disabled>
                                    @error('apellidos')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>



                        {{-- Dirección --}}
                        <div class="row">
                            <div class="col-md-10">
                                <div class="form-group">
                                    <label for="direccion">Dirección</label>
                                    <input type="text" name="direccion" id="direccion"
                                        class="form-control form-control-sm @error('direccion') is-invalid @enderror"
                                        value="{{ old('direccion', $cliente->direccion) }}" placeholder="Dirección"
                                        disabled>
                                    @error('direccion')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="codigo_postal">C.P.</label>
                                    <input type="text" name="codigo_postal" id="codigo_postal"
                                        class="form-control form-control-sm @error('codigo_postal') is-invalid @enderror"
                                        value="{{ old('codigo_postal', $cliente->codigo_postal) }}" maxlength="5"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{5}"
                                        placeholder="Ej: 97000" disabled>
                                    @error('codigo_postal')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Teléfono y correo --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="telefono">Teléfono <span style="color: red;">*</span></label>
                                    <input type="phone" name="telefono" id="telefono"
                                        class="form-control form-control-sm @error('telefono') is-invalid @enderror"
                                        value="{{ old('telefono', $cliente->telefono) }}" required
                                        placeholder="Ej: 2233445566" maxlength="10" disabled
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}">
                                    @error('telefono')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" name="email" id="email"
                                        class="form-control form-control-sm @error('email') is-invalid @enderror"
                                        value="{{ old('email', $cliente->email) }}" placeholder="Ej: correo@correo.com"
                                        disabled>
                                    @error('email')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Estado y ciudad --}}
                        {{-- estado --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="estado_id">Estado <span style="color: red;">*</span></label>
                                    <select name="estado_id" id="estado_id"
                                        class="form-control form-control-sm @error('estado_id') is-invalid @enderror"
                                        disabled>
                                        <option value="">Selecciona un estado</option>
                                        @foreach ($estados as $estado)
                                            <option value="{{ $estado->id }}"
                                                {{ old('estado_id', $cliente->estado_id) == $estado->id ? 'selected' : '' }}>
                                                {{ $estado->nombre_estado }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('estado_id')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- ciudad --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="ciudad">Ciudad <span style="color: red;">*</span></label>
                                    <input type="text" name="ciudad" id="ciudad"
                                        class="form-control form-control-sm @error('ciudad') is-invalid @enderror"
                                        value="{{ old('ciudad', $cliente->ciudad) }}" placeholder="Ej: Mérida" disabled>
                                    @error('ciudad')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>




                        {{-- Recomendacion --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="recomendacion_id">Recomendacion <span style="color: red;">*</span></label>
                                    <select name="recomendacion_id" id="recomendacion_id"
                                        class="form-control form-control-sm @error('recomendacion_id') is-invalid @enderror"
                                        disabled>
                                        <option value="">Selecciona una recomendacion</option>
                                        @foreach ($recomendaciones as $recomendacion)
                                            <option value="{{ $recomendacion->id }}"
                                                {{ old('recomendacion_id', $cliente->recomendacion_id) == $recomendacion->id ? 'selected' : '' }}>
                                                {{ $recomendacion->nombre_recomendacion }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('recomendacion_id')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="observaciones">Observaciones <span style="color: red;">*</span></label>
                                    <textarea name="observaciones" id="observaciones" placeholder="Observaciones"
                                        class="form-control form-control-sm @error('observaciones') is-invalid @enderror" disabled>{{ old('observaciones', $cliente->observaciones) }}</textarea>
                                    @error('observaciones')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        <div style="font-weight: bold;font-size: 25px;text-align: center;padding: 0px;margin: 0px;">
                            ¿Deseas
                            eliminar el
                            cliente?</div>

                        {{-- Botones --}}
                        <div class="text-center mt-4">
                            <a href="{{ route('admin.clientes.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </div>
                    </div>

                    {{-- MEDIDAS --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid rgb(225, 0, 255); padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: rgb(225, 0, 255); font-weight: 600;">
                                <i class="fas fa-ruler-vertical text-pink"></i>
                                <i class="fas fa-female fa-lg mr-2 text-pink"></i> Medidas(cm)
                            </h5>
                        </div>

                        {{-- BUSTO --}}
                        <div class="row">
                            <div class="form-group col-md-4 text-center">
                                <label for="busto" class="medida-label">BUSTO</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/busto.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="busto" id="busto"
                                        class="form-control form-control-sm medida-input @error('busto') is-invalid @enderror"
                                        value="{{ old('busto', $cliente->busto) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)" disabled>
                                    @error('busto')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- ALTO CINTURA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="alto_cintura" class="medida-label">ALTO CINTURA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/alto_cintura.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="alto_cintura" id="alto_cintura"
                                        class="form-control form-control-sm medida-input @error('alto_cintura') is-invalid @enderror"
                                        value="{{ old('alto_cintura', $cliente->alto_cintura) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)" disabled>
                                    @error('alto_cintura')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- CINTURA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="cintura" class="medida-label">CINTURA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/cintura.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="cintura" id="cintura"
                                        class="form-control form-control-sm medida-input @error('cintura') is-invalid @enderror"
                                        value="{{ old('cintura', $cliente->cintura) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)" disabled>
                                    @error('cintura')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- CADERA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="cadera" class="medida-label">CADERA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/cadera.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="cadera" id="cadera"
                                        class="form-control form-control-sm medida-input @error('cadera') is-invalid @enderror"
                                        value="{{ old('cadera', $cliente->cadera) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)" disabled>
                                    @error('cadera')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- LARGO --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="largo" class="medida-label">LARGO</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/largo.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="largo" id="largo"
                                        class="form-control form-control-sm medida-input @error('largo') is-invalid @enderror"
                                        value="{{ old('largo', $cliente->largo) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)" disabled>
                                    @error('largo')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                    </div>
            </form>
        </div>
    </div>
@stop

@section('css')
    <style>
        /* === CONTENEDOR PRINCIPAL === */
        .medida-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px 12px 14px;
            background: #ffffff;
            transition:
                box-shadow 0.25s ease,
                transform 0.25s ease,
                border-color 0.25s ease;
            cursor: pointer;
            position: relative;
        }

        /* === HOVER PREMIUM === */
        .medida-card:hover {
            transform: translateY(-4px);
            border-color: rgba(247, 0, 255, 0.779);
            box-shadow:
                0 10px 22px rgba(0, 0, 0, 0.06),
                0 4px 8px rgba(0, 0, 0, 0.04);
        }

        /* === IMAGEN === */
        .medida-img {
            width: 55%;
            margin-bottom: 10px;
            transition: transform 0.25s ease, opacity 0.25s ease;
        }

        .medida-card:hover .medida-img {
            transform: scale(1.03);
            opacity: 0.95;
        }

        /* === INPUT === */
        .medida-input {
            border-radius: 8px;
            transition:
                box-shadow 0.2s ease,
                border-color 0.2s ease;
        }

        /* FOCUS REAL (APPLE STYLE) */
        .medida-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }

        /* === LABEL === */
        .medida-label {
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
            color: #111827;
        }

        /* === ERROR VISUAL === */
        .medida-input.is-invalid {
            border-color: #dc3545;
            box-shadow: none;
        }

        .invalid-feedback {
            font-size: 0.75rem;
            margin-top: 6px;
        }
    </style>
@stop

@section('js')
    <script>
        function validateMedida(input) {
            let value = input.value;

            // 1. Eliminar todo excepto números y punto
            value = value.replace(/[^0-9.]/g, '');

            // 2. Evitar más de un punto
            value = value.replace(/(\..*)\./g, '$1');

            // Regex FINAL (igual al backend)
            const finalRegex = /^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/;

            // Regex parcial permitida SOLO para escribir
            const partialRegex = /^[1-9]\d{0,2}(\.\d{0,2})?$/;

            // 3. Bloquear casos inválidos inmediatos
            if (
                value === '.' ||
                value === '0' ||
                value === '0.' ||
                value === '.0'
            ) {
                input.value = '';
                return;
            }

            // 4. Permitir escritura progresiva válida
            if (!partialRegex.test(value)) {
                input.value = value.slice(0, -1);
                return;
            }

            // 5. Validación visual final
            if (finalRegex.test(value)) {
                input.classList.remove('is-invalid');
            } else {
                input.classList.add('is-invalid');
            }

            input.value = value;
        }

        // SweetAlert2 para eliminar cliente
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();

            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡Eliminarás este cliente y todos sus datos asociados!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', // Rojo
                cancelButtonColor: '#6c757d', // Gris (Secondary)
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>

@stop
</file>

<file path="resources/views/admin/clientes/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Cliente')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="card card-warning">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> EDITAR CLIENTE</h3>
        </div>

        <div class="card-body">
            <form method="post" action="{{ route('admin.clientes.update', $cliente->id) }}">
                @csrf
                @method('PUT')

                <div class="row">
                    {{-- DATOS DEL CLIENTE --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">

                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-user-tie"></i> Datos del Cliente
                            </h5>
                        </div>


                        {{-- Nombres y apellidos --}}
                        <div class="row">
                            {{-- Nombres --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="nombre">Nombres <span style="color: red;">*</span></label>
                                    <input type="text" name="nombre" id="nombre"
                                        class="form-control form-control-sm @error('nombre') is-invalid @enderror"
                                        value="{{ old('nombre', $cliente->nombre) }}" required placeholder="Nombres"
                                        oninput="this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')">
                                    @error('nombre')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- Apellidos --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="apellidos">Apellidos <span style="color: red;">*</span></label>
                                    <input type="text" name="apellidos" id="apellidos"
                                        class="form-control form-control-sm @error('apellidos') is-invalid @enderror"
                                        value="{{ old('apellidos', $cliente->apellidos) }}" required placeholder="Apellidos"
                                        oninput="this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')">
                                    @error('apellidos')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>



                        {{-- Dirección --}}
                        <div class="row">
                            <div class="col-md-10">
                                <div class="form-group">
                                    <label for="direccion">Dirección</label>
                                    <input type="text" name="direccion" id="direccion"
                                        class="form-control form-control-sm @error('direccion') is-invalid @enderror"
                                        value="{{ old('direccion', $cliente->direccion) }}" placeholder="Dirección">
                                    @error('direccion')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label for="codigo_postal">C.P.</label>
                                    <input type="text" name="codigo_postal" id="codigo_postal"
                                        class="form-control form-control-sm @error('codigo_postal') is-invalid @enderror"
                                        value="{{ old('codigo_postal', $cliente->codigo_postal) }}" maxlength="5"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{5}"
                                        placeholder="Ej: 97000">
                                    @error('codigo_postal')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Teléfono y correo --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="telefono">Teléfono <span style="color: red;">*</span></label>
                                    <input type="phone" name="telefono" id="telefono"
                                        class="form-control form-control-sm @error('telefono') is-invalid @enderror"
                                        value="{{ old('telefono', $cliente->telefono) }}" required
                                        placeholder="Ej: 2233445566" maxlength="10"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}">
                                    @error('telefono')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" name="email" id="email"
                                        class="form-control form-control-sm @error('email') is-invalid @enderror"
                                        value="{{ old('email', $cliente->email) }}" placeholder="Ej: correo@correo.com">
                                    @error('email')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Estado y ciudad --}}
                        {{-- estado --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="estado_id">Estado <span style="color: red;">*</span></label>
                                    <select name="estado_id" id="estado_id"
                                        class="form-control form-control-sm @error('estado_id') is-invalid @enderror"
                                        required>
                                        <option value="">Selecciona un estado</option>
                                        @foreach ($estados as $estado)
                                            <option value="{{ $estado->id }}"
                                                {{ old('estado_id', $cliente->estado_id) == $estado->id ? 'selected' : '' }}>
                                                {{ $estado->nombre_estado }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('estado_id')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- ciudad --}}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="ciudad">Ciudad <span style="color: red;">*</span></label>
                                    <input type="text" name="ciudad" id="ciudad"
                                        class="form-control form-control-sm @error('ciudad') is-invalid @enderror"
                                        value="{{ old('ciudad', $cliente->ciudad) }}" placeholder="Ej: Mérida">
                                    @error('ciudad')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>




                        {{-- Recomendacion --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="recomendacion_id">Recomendacion <span style="color: red;">*</span></label>
                                    <select name="recomendacion_id" id="recomendacion_id"
                                        class="form-control form-control-sm @error('recomendacion_id') is-invalid @enderror"
                                        required>
                                        <option value="">Selecciona una recomendacion</option>
                                        @foreach ($recomendaciones as $recomendacion)
                                            <option value="{{ $recomendacion->id }}"
                                                {{ old('recomendacion_id', $cliente->recomendacion_id) == $recomendacion->id ? 'selected' : '' }}>
                                                {{ $recomendacion->nombre_recomendacion }}
                                            </option>
                                        @endforeach
                                    </select>
                                    @error('recomendacion_id')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="observaciones">Observaciones <span style="color: red;">*</span></label>
                                    <textarea name="observaciones" id="observaciones" placeholder="Observaciones"
                                        class="form-control form-control-sm @error('observaciones') is-invalid @enderror">{{ old('observaciones', $cliente->observaciones) }}</textarea>
                                    @error('observaciones')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>



                        {{-- Botones --}}
                        <div class="text-center mt-4">
                            <a href="{{ route('admin.clientes.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </div>

                    {{-- MEDIDAS --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid rgb(225, 0, 255); padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: rgb(225, 0, 255); font-weight: 600;">
                                <i class="fas fa-ruler-vertical text-pink"></i>
                                <i class="fas fa-female fa-lg mr-2 text-pink"></i> Medidas(cm)
                            </h5>
                        </div>

                        {{-- BUSTO --}}
                        <div class="row">
                            <div class="form-group col-md-4 text-center">
                                <label for="busto" class="medida-label">BUSTO</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/busto.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="busto" id="busto"
                                        class="form-control form-control-sm medida-input @error('busto') is-invalid @enderror"
                                        value="{{ old('busto', $cliente->busto) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)">
                                    @error('busto')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- ALTO CINTURA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="alto_cintura" class="medida-label">ALTO CINTURA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/alto_cintura.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="alto_cintura" id="alto_cintura"
                                        class="form-control form-control-sm medida-input @error('alto_cintura') is-invalid @enderror"
                                        value="{{ old('alto_cintura', $cliente->alto_cintura) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)">
                                    @error('alto_cintura')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- CINTURA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="cintura" class="medida-label">CINTURA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/cintura.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="cintura" id="cintura"
                                        class="form-control form-control-sm medida-input @error('cintura') is-invalid @enderror"
                                        value="{{ old('cintura', $cliente->cintura) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)">
                                    @error('cintura')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- CADERA --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="cadera" class="medida-label">CADERA</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/cadera.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="cadera" id="cadera"
                                        class="form-control form-control-sm medida-input @error('cadera') is-invalid @enderror"
                                        value="{{ old('cadera', $cliente->cadera) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)">
                                    @error('cadera')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            {{-- LARGO --}}
                            <div class="form-group col-md-4 text-center">
                                <label for="largo" class="medida-label">LARGO</label>
                                <div class="medida-card">
                                    <img src="{{ asset('images/largo.png') }}" alt="Medidas"
                                        class="img-fluid medida-img">
                                    <input type="text" name="largo" id="largo"
                                        class="form-control form-control-sm medida-input @error('largo') is-invalid @enderror"
                                        value="{{ old('largo', $cliente->largo) }}" placeholder="Ej: 80.56"
                                        maxlength="6" inputmode="decimal" oninput="validateMedida(this)">
                                    @error('largo')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>
@stop

@section('css')
    <style>
        /* === CONTENEDOR PRINCIPAL === */
        .medida-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px 12px 14px;
            background: #ffffff;
            transition:
                box-shadow 0.25s ease,
                transform 0.25s ease,
                border-color 0.25s ease;
            cursor: pointer;
            position: relative;
        }

        /* === HOVER PREMIUM === */
        .medida-card:hover {
            transform: translateY(-4px);
            border-color: rgba(247, 0, 255, 0.779);
            box-shadow:
                0 10px 22px rgba(0, 0, 0, 0.06),
                0 4px 8px rgba(0, 0, 0, 0.04);
        }

        /* === IMAGEN === */
        .medida-img {
            width: 55%;
            margin-bottom: 10px;
            transition: transform 0.25s ease, opacity 0.25s ease;
        }

        .medida-card:hover .medida-img {
            transform: scale(1.03);
            opacity: 0.95;
        }

        /* === INPUT === */
        .medida-input {
            border-radius: 8px;
            transition:
                box-shadow 0.2s ease,
                border-color 0.2s ease;
        }

        /* FOCUS REAL (APPLE STYLE) */
        .medida-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15);
        }

        /* === LABEL === */
        .medida-label {
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
            display: block;
            color: #111827;
        }

        /* === ERROR VISUAL === */
        .medida-input.is-invalid {
            border-color: #dc3545;
            box-shadow: none;
        }

        .invalid-feedback {
            font-size: 0.75rem;
            margin-top: 6px;
        }
    </style>
@stop

@section('js')
    <script>
        function validateMedida(input) {
            let value = input.value;

            // 1. Eliminar todo excepto números y punto
            value = value.replace(/[^0-9.]/g, '');

            // 2. Evitar más de un punto
            value = value.replace(/(\..*)\./g, '$1');

            // Regex FINAL (igual al backend)
            const finalRegex = /^[1-9]\d{1,2}(\.(?:[1-9]|\d[1-9]))?$/;

            // Regex parcial permitida SOLO para escribir
            const partialRegex = /^[1-9]\d{0,2}(\.\d{0,2})?$/;

            // 3. Bloquear casos inválidos inmediatos
            if (
                value === '.' ||
                value === '0' ||
                value === '0.' ||
                value === '.0'
            ) {
                input.value = '';
                return;
            }

            // 4. Permitir escritura progresiva válida
            if (!partialRegex.test(value)) {
                input.value = value.slice(0, -1);
                return;
            }

            // 5. Validación visual final
            if (finalRegex.test(value)) {
                input.classList.remove('is-invalid');
            } else {
                input.classList.add('is-invalid');
            }

            input.value = value;
        }
    </script>

@stop
</file>

<file path="resources/views/admin/estados/edit.blade.php">
@extends('adminlte::page')

@section('title', 'ESTADO')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-12 col-md-6 col-lg-4">
        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        <div class="card card-warning " bis_skin_checked="1">
            <div class="card-header" bis_skin_checked="1">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                    EDITAR ESTADO
                </h3>
            </div>
            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.estados.update', $estado->id) }}">
                    @csrf
                    @method('PUT')

                    <div class="col-md-12">
                        <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #856404; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Estado
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Nombre <span style="color: red;">*</span></label>
                            <input type="text"
                                class="form-control form-control-sm @error('nombre_estado') is-invalid @enderror"
                                id="nombre_estado" name="nombre_estado" placeholder="Ej: MEXICO"
                                pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+" title="Solo se permiten letras y espacios"
                                value="{{ $estado->nombre_estado }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" required>
                            @error('nombre_estado')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="d-flex justify-content-end align-items-center mt-4">
                            <a href="{{ route('admin.estados.index') }}" class="btn btn-secondary mr-2">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Actualizar
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/giros/create.blade.php">
@extends('adminlte::page')

@section('title', 'GIRO')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-primary " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVO GIRO</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.giros.store') }}">
                    @csrf
                    @method('POST')
                    <div class="col-md-12">
                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Giro
                            </h5>
                        </div>
                        <div class="form-group">
                            <label for="nombre_giro">Nombre <span style="color: red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="nombre_giro" name="nombre_giro"
                                placeholder="Ej: TELAS" required pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+"
                                title="Solo se permiten letras y espacios"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')">
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-end align-items-center mt-4">
                            <a href="{{ route('admin.giros.index') }}" class="btn btn-secondary mr-2"
                                style="padding: 8px 20px;">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary" style="padding: 8px 20px;">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/giros/index.blade.php">
@extends('adminlte::page')

@section('title', 'GIROS')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary" bis_skin_checked="1">

        <div class="card-header" bis_skin_checked="1">

            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> GIROS</h3>
            <!-- /.card-tools -->
        </div>
        <!-- /.card-header -->
        <div class="card-body" bis_skin_checked="1">
            <div class="row">
                <a href="{{ route('admin.giros.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i></a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover table-condensed">
                        <thead class="thead-dark">
                            <tr style="text-align: center;">
                                <th>#</th>
                                <th>Nombre del giro</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach ($giros as $giro)
                                <tr style="text-align: center;">
                                    <td>{{ $loop->iteration }}</td>
                                    <td>{{ $giro->nombre_giro }}</td>
                                    <td style="text-align: center;">
                                        <a class="btn btn-warning" href="{{ route('admin.giros.edit', $giro->id) }}"><i
                                                class="fas fa-edit"></i></a>
                                        <a class="btn btn-danger"
                                            href="{{ route('admin.giros.confirm_delete', $giro->id) }}"><i
                                                class="fas fa-trash"></i></a>
                                    </td>
                                </tr>
                            @endforeach

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- /.card-body -->
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            /* Centrar los botones */
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Giros",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Giros",
                    "infoFiltered": "(Filtrado de _MAX_ total Giros)",
                    "lengthMenu": "Mostrar _MENU_ Giros",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/material-conversions/index.blade.php">
@extends('adminlte::page')

@section('title', 'Conversiones - ' . $material->name)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- BREADCRUMB INFO --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 bg-transparent p-0">
                            <li class="breadcrumb-item">
                                <a href="{{ route('admin.materials.index') }}">
                                    <i class="fas fa-boxes"></i> Materiales
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <span class="badge badge-primary">{{ $material->category->name ?? 'N/A' }}</span>
                            </li>
                            <li class="breadcrumb-item active">{{ $material->name }}</li>
                        </ol>
                    </nav>
                </div>
                <div class="col-md-4 text-right">
                    <span class="badge badge-success">
                        <i class="fas fa-ruler"></i>
                        Unidad de Compra: <strong>{{ $material->baseUnit->name ?? 'N/A' }}</strong>
                        ({{ $material->baseUnit->symbol ?? '' }})
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-exchange-alt"></i> CONVERSIONES DE UNIDAD: {{ $material->name }}
            </h3>
        </div>

        <div class="card-body">
            {{-- ACCIONES --}}
            <div class="row mb-3">
                <div class="col-md-6">
                    <a href="{{ route('admin.materials.index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Materiales
                    </a>
                    <a href="{{ route('admin.material-conversions.create', $material->id) }}" class="btn btn-info">
                        Nueva Conversión <i class="fas fa-plus"></i>
                    </a>
                </div>
            </div>

            {{-- EXPLICACIÓN --}}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>¿Qué son las conversiones?</strong><br>
                Permiten calcular cuántas unidades de <strong>consumo</strong> se obtienen por cada unidad de <strong>compra</strong>.
                <br>
                <small>
                    Ejemplo: <strong>1 Cono</strong> (compra) → <strong>5000 Metros</strong> (consumo) en inventario.
                </small>
            </div>

            <hr>

            {{-- TABLA --}}
            <div class="table-responsive">
                <table id="example1" class="table table-bordered table-hover text-center">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Unidad de Compra</th>
                            <th class="text-center" style="width: 80px;"><i class="fas fa-arrow-right"></i></th>
                            <th>Unidad de Inventario</th>
                            <th class="text-center">Factor</th>
                            <th>Conversión</th>
                            <th style="width: 120px; text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($conversions as $conversion)
                            <tr>
                                <td class="align-middle">{{ $loop->iteration }}</td>
                                <td class="align-middle">
                                    <span class="badge badge-secondary">
                                        {{ $conversion->fromUnit->name ?? 'N/A' }}
                                    </span>
                                    <small class="text-muted">({{ $conversion->fromUnit->symbol ?? '' }})</small>
                                </td>
                                <td class="align-middle text-center">
                                    <i class="fas fa-arrow-right text-primary"></i>
                                </td>
                                <td class="align-middle">
                                    <span class="badge badge-info">
                                        {{ $conversion->toUnit->name ?? 'N/A' }}
                                    </span>
                                    <small class="text-muted">({{ $conversion->toUnit->symbol ?? '' }})</small>
                                </td>
                                <td class="align-middle text-center">
                                    <strong>{{ number_format($conversion->conversion_factor, 4) }}</strong>
                                </td>
                                <td class="align-middle">
                                    <code>1 {{ $conversion->fromUnit->name ?? '' }} =
                                        {{ number_format($conversion->conversion_factor, 2) }}
                                        {{ $conversion->toUnit->symbol ?? '' }}</code>
                                </td>
                                <td class="align-middle">
                                    <div class="d-flex justify-content-center align-items-center gap-1">
                                        <a href="{{ route('admin.material-conversions.edit', [$material->id, $conversion->id]) }}"
                                            class="btn btn-warning btn-sm btn-action" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ route('admin.material-conversions.confirm_delete', [$material->id, $conversion->id]) }}"
                                            class="btn btn-danger btn-sm btn-action" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            var table = $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Proveedores",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Proveedores",
                    "infoFiltered": "(Filtrado de _MAX_ total Proveedores)",
                    "lengthMenu": "Mostrar _MENU_ Proveedores",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                "buttons": [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            });

            // ESTA LINEA ES CLAVE: Mueve los botones a un contenedor propio para aplicar el CSS
            table.buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
        });
    </script>
@stop

@section('css')
    <style>
        /* Contenedor de botones: Centrado y espaciado como en la Imagen 1 */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            float: none;
            /* Quita el float por defecto de AdminLTE */
        }

        /* Estilo de los botones */
        #example1_wrapper .dt-buttons .btn {
            color: #fff !important;
            border-radius: 4px;
            padding: 5px 15px;
            font-size: 14px;
            border: none;
        }

        /* Colores específicos por clase */
        .btn-danger {
            background-color: #dc3545 !important;
        }

        .btn-success {
            background-color: #28a745 !important;
        }

        .btn-info {
            background-color: #17a2b8 !important;
        }

        .btn-default {
            background-color: #6e7176 !important;
        }

        /* Ajuste para el buscador y mostrar registros para que no se amontonen */
        .dataTables_wrapper .dataTables_filter {
            text-align: right;
        }
    </style>
@stop
</file>

<file path="resources/views/admin/material-variants/index.blade.php">
@extends('adminlte::page')

@section('title', 'Variantes - ' . $material->name)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- BREADCRUMB INFO --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 bg-transparent p-0">
                            <li class="breadcrumb-item">
                                <a href="{{ route('admin.materials.index') }}">
                                    <i class="fas fa-boxes"></i> Materiales
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <span class="badge badge-primary">{{ $material->category->name ?? 'N/A' }}</span>
                            </li>
                            <li class="breadcrumb-item active">{{ $material->name }}</li>
                        </ol>
                    </nav>
                </div>
                <div class="col-md-4 text-right">
                    <span class="badge badge-secondary" style="font-size: 1rem; padding: 5px 10px;">
                        <i class="fas fa-ruler"></i>
                        {{ $material->baseUnit->name ?? 'N/A' }} ({{ $material->baseUnit->symbol ?? 'N/A' }})
                    </span>
                    @if ($material->composition)
                        <span class="badge badge-info">
                            {{ $material->composition }}
                        </span>
                    @endif
                </div>
            </div>
        </div>
    </div>

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-palette"></i> VARIANTES DE: {{ $material->name }}
            </h3>
        </div>

        <div class="card-body">
            {{-- ACCIONES --}}
            <div class="row mb-3">
                <div class="col-md-6">
                    <a href="{{ route('admin.materials.index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver a Materiales
                    </a>
                    <a href="{{ route('admin.material-variants.create', $material->id) }}" class="btn btn-info">
                        Nueva Variante <i class="fas fa-plus"></i>
                    </a>

                </div>
                <div class="col-md-6 text-right">
                    <span class="text-muted">
                        Total variantes: <strong>{{ $variants->count() }}</strong>
                    </span>
                </div>
            </div>

            <hr>

            {{-- TABLA --}}
            <div class="table-responsive">
                <table id="example1" class="table table-bordered table-hover text-center">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>SKU</th>
                            <th>Color</th>
                            <th class="text-right">Stock Actual</th>
                            <th class="text-right">Stock Mínimo</th>
                            <th class="text-right">Costo Promedio</th>
                            <th class="text-right">Valor Total</th>
                            <th style="width: 100px;">Estado</th>
                            <th style="width: 120px; text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @forelse ($variants as $variant)
                            <tr class="{{ $variant->is_low_stock ? 'table-warning' : '' }}">
                                <td>{{ $loop->iteration }}</td>
                                <td>
                                    <code class="font-weight-bold">{{ $variant->sku }}</code>
                                </td>
                                <td>
                                    @if ($variant->color)
                                        <span class="badge badge-secondary">{{ $variant->color }}</span>
                                    @else
                                        <span class="text-muted">-</span>
                                    @endif
                                </td>
                                <td class="text-right">
                                    <strong>{{ number_format($variant->current_stock, 2) }}</strong>
                                    <small class="text-muted">{{ $material->baseUnit->symbol ?? '' }}</small>
                                </td>
                                <td class="text-right">
                                    {{ number_format($variant->min_stock_alert, 2) }}
                                    <small class="text-muted">{{ $material->baseUnit->symbol ?? '' }}</small>
                                </td>
                                <td class="text-right">
                                    ${{ number_format($variant->average_cost, 2) }}
                                </td>
                                <td class="text-right">
                                    <strong>${{ number_format($variant->current_value, 2) }}</strong>
                                </td>
                                <td class="text-center">
                                    @if ($variant->is_low_stock)
                                        <span class="badge badge-warning">
                                            <i class="fas fa-exclamation-triangle"></i> Bajo
                                        </span>
                                    @else
                                        <span class="badge badge-success">
                                            <i class="fas fa-check"></i> OK
                                        </span>
                                    @endif
                                </td>
                                <td class="text-center">
                                    <div class="d-flex justify-content-center align-items-center gap-1">
                                        <a href="{{ route('admin.material-variants.edit', [$material->id, $variant->id]) }}"
                                            class="btn btn-warning btn-sm" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ route('admin.material-variants.confirm_delete', [$material->id, $variant->id]) }}"
                                            class="btn btn-danger btn-sm" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        @empty
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                    No hay variantes registradas para este material
                                    <br>
                                    <a href="{{ route('admin.material-variants.create', $material->id) }}"
                                        class="btn btn-info btn-sm mt-2">
                                        <i class="fas fa-plus"></i> Crear primera variante
                                    </a>
                                </td>
                            </tr>
                        @endforelse
                    </tbody>
                    @if ($variants->count() > 0)
                        <tfoot class="bg-light">
                            <tr>
                                <th colspan="3" class="text-right">TOTALES:</th>
                                <th class="text-right">
                                    {{ number_format($variants->sum('current_stock'), 2) }}
                                    <small>{{ $material->baseUnit->symbol ?? '' }}</small>
                                </th>
                                <th></th>
                                <th></th>
                                <th class="text-right">
                                    <strong>${{ number_format($variants->sum('current_value'), 2) }}</strong>
                                </th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    @endif
                </table>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        .gap-1 {
            gap: 5px;
        }

        .table-warning {
            background-color: #fff3cd !important;
        }

        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            /* Centrar los botones */
            flex-wrap: wrap;
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Variantes",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Variantes",
                    "infoFiltered": "(Filtrado de _MAX_ total Variantes)",
                    "lengthMenu": "Mostrar _MENU_ Variantes",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/materials/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nuevo Material')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-plus-circle"></i> NUEVO MATERIAL
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.materials.store') }}">
                @csrf

                <div class="row">
                    {{-- COLUMNA IZQUIERDA --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">
                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-box"></i> Datos del Material
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Categoría <span class="text-danger">*</span></label>
                            <select name="material_category_id" id="material_category_id"
                                class="form-control @error('material_category_id') is-invalid @enderror" required>
                                <option value="">Seleccionar categoría...</option>
                                @foreach ($categories as $category)
                                    <option value="{{ $category->id }}" data-unit="{{ $category->baseUnit->symbol ?? '' }}"
                                        data-has-color="{{ $category->has_color ? '1' : '0' }}"
                                        {{ old('material_category_id') == $category->id ? 'selected' : '' }}>
                                        {{ $category->name }}
                                    </option>
                                @endforeach
                            </select>
                            @error('material_category_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="form-group">
                            <label>Nombre <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control @error('name') is-invalid @enderror"
                                value="{{ old('name') }}" placeholder="Ej: Manta Cruda, Hilo Rayón, Cinta Satín"
                                maxlength="100" required>
                            @error('name')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="form-group">
                            <label>Composición</label>
                            <input type="text" name="composition"
                                class="form-control @error('composition') is-invalid @enderror"
                                value="{{ old('composition') }}" placeholder="Ej: 100% Algodón, 80/20 Algodón/Poliéster"
                                maxlength="100">
                            @error('composition')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">Composición del material (opcional)</small>
                        </div>
                    </div>

                    {{-- COLUMNA DERECHA --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-balance-scale"></i> Unidades y Presentación
                            </h5>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Unidad de Compra (Base) <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select name="base_unit_id" id="base_unit_id"
                                            class="form-control @error('base_unit_id') is-invalid @enderror" required
                                            disabled>
                                            <option value="">Seleccionar categoría primero...</option>
                                        </select>
                                        <div class="input-group-append">
                                            <button type="button" class="btn bg-purple" data-toggle="modal"
                                                data-target="#unitModal" title="Crear nueva unidad">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <small class="text-muted">Ej: Cono, Rollo, Pieza</small>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Opciones</label>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="has_color" name="has_color"
                                    value="1" {{ old('has_color', true) ? 'checked' : '' }}>
                                <label class="custom-control-label" for="has_color">
                                    Este material tiene variantes de color
                                </label>
                            </div>
                        </div>

                        <div class="form-group mt-3">
                            <label>Notas / Descripción</label>
                            <textarea name="description" class="form-control @error('description') is-invalid @enderror" rows="2"
                                maxlength="500">{{ old('description') }}</textarea>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="text-center">
                    <a href="{{ route('admin.materials.index') }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            var categorySelect = $('#material_category_id');
            var unitSelect = $('#base_unit_id');

            // Función para cargar unidades
            function loadUnits(categoryId, selectedUnitId = null) {
                if (!categoryId) {
                    unitSelect.html('<option value="">Seleccionar categoría primero...</option>');
                    unitSelect.prop('disabled', true);
                    return;
                }

                unitSelect.html('<option value="">Cargando unidades permitidas...</option>');
                unitSelect.prop('disabled', true);

                $.ajax({
                    url: '/admin/material-categories/' + categoryId + '/get-units',
                    type: 'GET',
                    success: function(units) {
                        unitSelect.empty();

                        if (units.length === 0) {
                            unitSelect.html(
                                '<option value="">Esta categoría no tiene unidades de compra asignadas</option>'
                                );
                        } else {
                            unitSelect.append('<option value="">Seleccionar Unidad de Compra...</option>');
                            $.each(units, function(index, unit) {
                                var symbolText = unit.symbol ? ' (' + unit.symbol + ')' : '';
                                var isSelected = (selectedUnitId == unit.id) ? 'selected' : '';
                                unitSelect.append('<option value="' + unit.id + '" ' +
                                    isSelected + '>' + unit.name + symbolText + '</option>');
                            });
                            unitSelect.prop('disabled', false);
                        }
                    },
                    error: function() {
                        unitSelect.html('<option value="">Error al cargar unidades</option>');
                    }
                });
            }

            // Evento cambio de categoría
            categorySelect.on('change', function() {
                var categoryId = $(this).val();
                loadUnits(categoryId);
            });

            // Si hay un old('category_id') por error de validación, recargar
            var oldCategory = "{{ old('material_category_id') }}";
            var oldUnit = "{{ old('base_unit_id') }}";

            if (oldCategory) {
                loadUnits(oldCategory, oldUnit);
            }
        });
    </script>
@stop
</file>

<file path="resources/views/admin/materials/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Material')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    <div class="card card-warning">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-edit"></i> EDITAR MATERIAL
            </h3>
        </div>

        <div class="card-body">
            <form method="POST" action="{{ route('admin.materials.update', $material->id) }}">
                @csrf
                @method('PUT')

                <div class="row">
                    {{-- COLUMNA IZQUIERDA --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">
                        <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #856404; font-weight: 600;">
                                <i class="fas fa-box"></i> Datos del Material
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Categoría <span class="text-danger">*</span></label>
                            <select name="material_category_id" id="material_category_id"
                                class="form-control @error('material_category_id') is-invalid @enderror" required>
                                <option value="">Seleccionar categoría...</option>
                                @foreach ($categories as $category)
                                    <option value="{{ $category->id }}" data-unit="{{ $category->baseUnit->symbol ?? '' }}"
                                        data-has-color="{{ $category->has_color ? '1' : '0' }}"
                                        {{ old('material_category_id', $material->material_category_id) == $category->id ? 'selected' : '' }}>
                                        {{ $category->name }}
                                    </option>
                                @endforeach
                            </select>
                            @error('material_category_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="form-group">
                            <label>Nombre <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control @error('name') is-invalid @enderror"
                                value="{{ old('name', $material->name) }}" maxlength="100" required>
                            @error('name')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="form-group">
                            <label>Composición</label>
                            <input type="text" name="composition"
                                class="form-control @error('composition') is-invalid @enderror"
                                value="{{ old('composition', $material->composition) }}" maxlength="100">
                            @error('composition')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>
                    </div>

                    {{-- COLUMNA DERECHA --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-balance-scale"></i> Unidades y Presentación
                            </h5>
                        </div>

                        <div class="row">
                            <div class="col-12">
                                <div class="form-group">
                                    <label>Unidad de Compra (Base) <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <select name="base_unit_id" id="base_unit_id"
                                            class="form-control @error('base_unit_id') is-invalid @enderror" required>
                                            <option value="">...</option>
                                            @foreach ($baseUnits as $unit)
                                                <option value="{{ $unit->id }}" data-symbol="{{ $unit->symbol }}"
                                                    data-id="{{ $unit->id }}"
                                                    {{ old('base_unit_id', $material->base_unit_id) == $unit->id ? 'selected' : '' }}>
                                                    {{ $unit->name }} ({{ $unit->symbol }})
                                                </option>
                                            @endforeach
                                        </select>
                                        <div class="input-group-append">
                                            <button type="button" class="btn bg-purple" data-toggle="modal"
                                                data-target="#unitModal" title="Crear nueva unidad">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Opciones</label>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="has_color" name="has_color"
                                    value="1" {{ old('has_color', $material->has_color) ? 'checked' : '' }}>
                                <label class="custom-control-label" for="has_color">
                                    Este material tiene variantes de color
                                </label>
                            </div>
                        </div>

                        <div class="form-group mt-3">
                            <label>Notas / Descripción</label>
                            <textarea name="description" class="form-control @error('description') is-invalid @enderror" rows="2"
                                maxlength="500">{{ old('description', $material->description) }}</textarea>
                        </div>

                        {{-- INFO --}}
                        <div class="card bg-light mt-3">
                            <div class="card-body py-2">
                                <small>
                                    <strong>UUID:</strong>
                                    <code>{{ $material->uuid }}</code>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="text-center">
                    <a href="{{ route('admin.materials.index') }}" class="btn btn-secondary">
                        <i class="fas fa-times-circle"></i> Regresar
                    </a>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save"></i> Actualizar
                    </button>
                </div>
            </form>
        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            var categorySelect = $('#material_category_id');
            var unitSelect = $('#base_unit_id');
            var initialCategoryId = "{{ $material->material_category_id }}";
            var initialUnitId = "{{ $material->base_unit_id }}";

            // Función para cargar unidades según categoría
            function loadUnits(categoryId, selectedUnitId = null) {
                if (!categoryId) {
                    unitSelect.html('<option value="">Seleccionar categoría primero...</option>');
                    unitSelect.prop('disabled', true);
                    return;
                }

                unitSelect.html('<option value="">Cargando unidades permitidas...</option>');
                unitSelect.prop('disabled', true);

                $.ajax({
                    url: '/admin/material-categories/' + categoryId + '/get-units',
                    type: 'GET',
                    success: function(units) {
                        unitSelect.empty();

                        if (units.length === 0) {
                            unitSelect.html(
                                '<option value="">Esta categoría no tiene unidades de compra asignadas</option>'
                            );
                        } else {
                            unitSelect.append('<option value="">Seleccionar Unidad de Compra...</option>');
                            $.each(units, function(index, unit) {
                                var symbolText = unit.symbol ? ' (' + unit.symbol + ')' : '';
                                var isSelected = (selectedUnitId == unit.id) ? 'selected' : '';
                                unitSelect.append('<option value="' + unit.id + '" ' +
                                    isSelected + '>' + unit.name + symbolText + '</option>');
                            });
                            unitSelect.prop('disabled', false);
                        }
                    },
                    error: function() {
                        unitSelect.html('<option value="">Error al cargar unidades</option>');
                    }
                });
            }

            // Evento cambio de categoría - LIMPIAR unidad previa
            categorySelect.on('change', function() {
                var categoryId = $(this).val();
                // Al cambiar categoría, NO pasamos selectedUnitId para forzar nueva selección
                loadUnits(categoryId, null);
            });

            // Si hay un old() por error de validación, usarlo
            var oldCategory = "{{ old('material_category_id', '') }}";
            var oldUnit = "{{ old('base_unit_id', '') }}";

            if (oldCategory && oldCategory !== initialCategoryId) {
                // Hubo error de validación con categoría cambiada
                loadUnits(oldCategory, oldUnit);
            }
            // Si no hay cambios, el select ya tiene las unidades correctas del servidor
        });
    </script>
@stop
</file>

<file path="resources/views/admin/product_categories/index.blade.php">
@extends('adminlte::page')

@section('title', 'Categorías de Productos')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary">

        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> CATEGORÍAS DE PRODUCTOS</h3>
        </div>

        <div class="card-body">
            <div class="row">
                <a href="{{ route('admin.product_categories.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i></a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Descripción</th>
                                <th style="text-align: center;">Productos</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach ($categories as $category)
                                <tr>
                                    <td>{{ $loop->iteration }}</td>
                                    <td>
                                        <strong>{{ $category->name }}</strong>
                                    </td>
                                    <td>{{ Str::limit($category->description, 80) ?? '-' }}</td>
                                    <td class="text-center">
                                        <span
                                            class="badge badge-{{ $category->products_count > 0 ? 'info' : 'secondary' }}">
                                            {{ $category->products_count }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center align-items-center gap-1">
                                            <a href="{{ route('admin.product_categories.edit', $category->id) }}"
                                                class="btn btn-warning btn-sm" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <a href="{{ route('admin.product_categories.confirm_delete', $category->id) }}"
                                                class="btn btn-danger btn-sm" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            @endforeach

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        #example1_wrapper .btn {
            color: #fff;
            border-radius: 4px;
            padding: 5px 15px;
            font-size: 14px;
        }

        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay información",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Categorías",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Categorías",
                    "infoFiltered": "(Filtrado de _MAX_ total Categorías)",
                    "lengthMenu": "Mostrar _MENU_ Categorías",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-info'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/product_extras/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nuevo Extra')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVO EXTRA DE PRODUCTO</h3>
            </div>

            <div class="card-body">
                <form method="post" action="{{ route('admin.product_extras.store') }}" id="formExtra">
                    @csrf
                    @method('POST')

                    <div class="row">
                        <div class="col-12">

                            <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                                <h5 style="color: #007bff; font-weight: 600;">
                                    <i class="fas fa-plus-circle"></i> Datos del Extra
                                </h5>
                            </div>

                            {{-- Nombre --}}
                            <div class="form-group">
                                <label>Nombre del Extra <span style="color: red;">*</span></label>
                                <input type="text" name="name"
                                    class="form-control form-control-sm @error('name') is-invalid @enderror"
                                    value="{{ old('name') }}" required placeholder="Ej: Empaque especial, Urgencia, etc.">
                                @error('name')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            {{-- Costo y Precio --}}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Costo Adicional <span style="color: red;">*</span></label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">$</span>
                                            </div>
                                            <input type="number" name="cost_addition"
                                                class="form-control form-control-sm @error('cost_addition') is-invalid @enderror"
                                                value="{{ old('cost_addition') }}" required step="0.01" min="0"
                                                placeholder="Ej: 25.00">
                                            @error('cost_addition')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                        <small class="text-muted">Costo real del servicio/extra</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Precio al Cliente <span style="color: red;">*</span></label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">$</span>
                                            </div>
                                            <input type="number" name="price_addition"
                                                class="form-control form-control-sm @error('price_addition') is-invalid @enderror"
                                                value="{{ old('price_addition') }}" required step="0.01" min="0"
                                                placeholder="Ej: 50.00">
                                            @error('price_addition')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                        <small class="text-muted">Precio que se cobra al cliente</small>
                                    </div>
                                </div>
                            </div>

                            {{-- Tiempo adicional --}}
                            <div class="form-group">
                                <label>Tiempo Adicional (minutos)</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" name="minutes_addition"
                                        class="form-control form-control-sm @error('minutes_addition') is-invalid @enderror"
                                        value="{{ old('minutes_addition', '0') }}" min="0" max="9999"
                                        step="1" onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="0">
                                    <div class="input-group-append">
                                        <span class="input-group-text">minutos</span>
                                    </div>
                                    @error('minutes_addition')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                                <small class="text-muted">Tiempo extra que agrega este servicio al proceso</small>
                            </div>

                            {{-- Botones --}}
                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <a href="{{ route('admin.product_extras.index') }}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Guardar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    @stop

    @section('css')
    @stop

    @section('js')
        <script>
            $(document).ready(function() {
                $('#formExtra').on('submit', function(e) {
                    var name = $('input[name="name"]').val().trim();
                    var cost = $('input[name="cost_addition"]').val();
                    var price = $('input[name="price_addition"]').val();

                    var errors = [];

                    if (!name || name === '') {
                        errors.push('El nombre del extra es obligatorio');
                    }
                    if (!cost || cost === '' || parseFloat(cost) < 0) {
                        errors.push('El costo adicional es obligatorio');
                    }
                    if (!price || price === '' || parseFloat(price) < 0) {
                        errors.push('El precio al cliente es obligatorio');
                    }

                    if (errors.length > 0) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Campos requeridos',
                            html: '<ul style="text-align:left;">' + errors.map(function(err) {
                                return '<li>' + err + '</li>';
                            }).join('') + '</ul>',
                            confirmButtonText: 'Entendido'
                        });
                        return false;
                    }

                    return true;
                });
            });
        </script>
    @stop
</file>

<file path="resources/views/admin/product_extras/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Extra')

@section('content_header')
@stop

@section('content')
    <br>

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-danger">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold; font-size: 20px;"> ELIMINAR EXTRA DE PRODUCTO</h3>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-12">

                        <div class="alert alert-danger">
                            <h5><i class="fas fa-exclamation-triangle"></i> ¡Atención!</h5>
                            <p>Está a punto de eliminar el siguiente extra:</p>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 200px;">Nombre:</th>
                                        <td><strong>{{ $extra->name }}</strong></td>
                                    </tr>
                                    <tr>
                                        <th>Costo Adicional:</th>
                                        <td>${{ number_format($extra->cost_addition, 2) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Precio al Cliente:</th>
                                        <td>${{ number_format($extra->price_addition, 2) }}</td>
                                    </tr>
                                    <tr>
                                        <th>Tiempo Adicional:</th>
                                        <td>{{ $extra->formatted_minutes }}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <p class="text-center text-muted mt-3">
                            Esta acción no se puede deshacer. ¿Está seguro que desea continuar?
                        </p>

                        <div class="d-flex justify-content-end align-items-center mt-4">
                            <a href="{{ route('admin.product_extras.index') }}" class="btn btn-secondary mr-2">
                                <i class="fas fa-times-circle"></i> Cancelar
                            </a>
                            <form id="deleteForm" action="{{ route('admin.product_extras.destroy', $extra->id) }}"
                                method="POST" class="d-inline">
                                @csrf
                                @method('DELETE')
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-trash-alt"></i> Sí, Eliminar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    @stop

    @section('css')
    @stop

    @section('js')
        <script>
            document.getElementById('deleteForm').addEventListener('submit', function(e) {
                e.preventDefault();

                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "¡Eliminarás este extra y no se podrá recuperar!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33', // Rojo
                    cancelButtonColor: '#6c757d', // Gris
                    confirmButtonText: 'Sí, confirmar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.submit();
                    }
                });
            });
        </script>
    @stop
</file>

<file path="resources/views/admin/product_extras/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Extra')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-warning">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold; font-size: 20px;"> EDITAR EXTRA DE PRODUCTO</h3>
            </div>

            <div class="card-body">
                <form method="post" action="{{ route('admin.product_extras.update', $extra->id) }}" id="formExtra">
                    @csrf
                    @method('PUT')

                    <div class="row">
                        <div class="col-12">

                            <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                                <h5 style="color: #ffc107; font-weight: 600;">
                                    <i class="fas fa-edit"></i> Datos del Extra
                                </h5>
                            </div>

                            {{-- Nombre --}}
                            <div class="form-group">
                                <label>Nombre del Extra <span style="color: red;">*</span></label>
                                <input type="text" name="name"
                                    class="form-control form-control-sm @error('name') is-invalid @enderror"
                                    value="{{ old('name', $extra->name) }}" required
                                    placeholder="Ej: Empaque especial, Urgencia, etc.">
                                @error('name')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            {{-- Costo y Precio --}}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Costo Adicional <span style="color: red;">*</span></label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">$</span>
                                            </div>
                                            <input type="number" name="cost_addition"
                                                class="form-control form-control-sm @error('cost_addition') is-invalid @enderror"
                                                value="{{ old('cost_addition', $extra->cost_addition) }}" required
                                                step="0.01" min="0" placeholder="0.00">
                                            @error('cost_addition')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                        <small class="text-muted">Costo real del servicio/extra</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Precio al Cliente <span style="color: red;">*</span></label>
                                        <div class="input-group input-group-sm">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text">$</span>
                                            </div>
                                            <input type="number" name="price_addition"
                                                class="form-control form-control-sm @error('price_addition') is-invalid @enderror"
                                                value="{{ old('price_addition', $extra->price_addition) }}" required
                                                step="0.01" min="0" placeholder="0.00">
                                            @error('price_addition')
                                                <div class="invalid-feedback">{{ $message }}</div>
                                            @enderror
                                        </div>
                                        <small class="text-muted">Precio que se cobra al cliente</small>
                                    </div>
                                </div>
                            </div>

                            {{-- Tiempo adicional --}}
                            <div class="form-group">
                                <label>Tiempo Adicional (minutos)</label>
                                <div class="input-group input-group-sm">
                                    <input type="number" name="minutes_addition"
                                        class="form-control form-control-sm @error('minutes_addition') is-invalid @enderror"
                                        value="{{ old('minutes_addition', $extra->minutes_addition) }}" min="0"
                                        max="9999" step="1"
                                        onkeypress="return event.charCode >= 48 && event.charCode <= 57"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="0">
                                    <div class="input-group-append">
                                        <span class="input-group-text">minutos</span>
                                    </div>
                                    @error('minutes_addition')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                                <small class="text-muted">Tiempo extra que agrega este servicio al proceso</small>
                            </div>

                            {{-- Botones --}}
                            <div class="d-flex justify-content-end align-items-center mt-4">
                                <a href="{{ route('admin.product_extras.index') }}" class="btn btn-secondary mr-2">
                                    <i class="fas fa-times-circle"></i> Regresar
                                </a>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-save"></i> Actualizar
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    @stop

    @section('css')
    @stop

    @section('js')
        <script>
            $(document).ready(function() {
                $('#formExtra').on('submit', function(e) {
                    var name = $('input[name="name"]').val().trim();
                    var cost = $('input[name="cost_addition"]').val();
                    var price = $('input[name="price_addition"]').val();

                    var errors = [];

                    if (!name || name === '') {
                        errors.push('El nombre del extra es obligatorio');
                    }
                    if (!cost || cost === '' || parseFloat(cost) < 0) {
                        errors.push('El costo adicional es obligatorio');
                    }
                    if (!price || price === '' || parseFloat(price) < 0) {
                        errors.push('El precio al cliente es obligatorio');
                    }

                    if (errors.length > 0) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Campos requeridos',
                            html: '<ul style="text-align:left;">' + errors.map(function(err) {
                                return '<li>' + err + '</li>';
                            }).join('') + '</ul>',
                            confirmButtonText: 'Entendido'
                        });
                        return false;
                    }

                    return true;
                });
            });
        </script>
    @stop
</file>

<file path="resources/views/admin/products/index.blade.php">
{{-- resources/views/admin/products/index.blade.php --}}
@extends('adminlte::page')

@section('title', 'Productos')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary" bis_skin_checked="1">
        <div class="card-header" bis_skin_checked="1">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">GESTIÓN DE PRODUCTOS</h3>
        </div>
        <!-- /.card-header -->
        <div class="card-body" bis_skin_checked="1">
            <div class="row">
                <a href="{{ route('admin.products.create') }}" type="button" class="btn btn-primary">
                    Nuevo Producto <i class="fas fa-plus"></i>
                </a>
            </div>
            <hr>

            <!-- Filtros -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="category_filter">Categoría</label>
                        <select class="form-control select2" id="category_filter" style="width: 100%;">
                            <option value="">Todas las categorías</option>
                            @foreach ($categories as $category)
                                <option value="{{ $category->id }}">{{ $category->name }}</option>
                            @endforeach
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="status_filter">Estado</label>
                        <select class="form-control select2" id="status_filter" style="width: 100%;">
                            <option value="">Todos los estados</option>
                            <option value="active">Activo</option>
                            <option value="draft">Borrador</option>
                            <option value="discontinued">Descontinuado</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group">
                        <label for="search_filter">Búsqueda</label>
                        <input type="text" class="form-control" id="search_filter" placeholder="Nombre, SKU...">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-group d-flex align-items-end">
                        <button type="button" id="btn_filter" class="btn btn-primary mr-2">
                            <i class="fas fa-filter mr-1"></i> Filtrar
                        </button>
                        <button type="button" id="btn_reset" class="btn btn-default">
                            <i class="fas fa-undo mr-1"></i> Limpiar
                        </button>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="table-responsive">
                    <table id="products-table" class="table table-bordered table-hover ">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Imagen</th>
                                <th>SKU</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Variantes</th>
                                <th>Estado</th>
                                <th>Precio Base</th>
                                <th>Creado</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach ($products as $product)
                                <tr>
                                    <td>{{ $loop->iteration }}</td>
                                    <td class="text-center">
                                        @if ($product->primary_image_url)
                                            <img src="{{ asset($product->primary_image_url) }}" alt="{{ $product->name }}"
                                                style="width: 60px; height: 60px; object-fit: cover; border-radius: 5px;">
                                        @else
                                            <div class="text-center">
                                                <i class="fas fa-image fa-2x text-muted"></i>
                                            </div>
                                        @endif
                                    </td>
                                    <td>
                                        <span class="badge badge-dark">{{ $product->sku }}</span>
                                    </td>
                                    <td>
                                        <strong>{{ $product->name }}</strong>
                                        @if ($product->description)
                                            <br><small
                                                class="text-muted">{{ Str::limit($product->description, 50) }}</small>
                                        @endif
                                    </td>
                                    <td>
                                        <span
                                            class="badge badge-info">{{ $product->category->name ?? 'Sin categoría' }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge badge-secondary">{{ $product->variants_count }}</span>
                                    </td>
                                    <td>
                                        @if ($product->status === 'active')
                                            <span class="badge badge-success">{{ $product->status_label }}</span>
                                        @elseif($product->status === 'draft')
                                            <span class="badge badge-warning">{{ $product->status_label }}</span>
                                        @else
                                            <span class="badge badge-danger">{{ $product->status_label }}</span>
                                        @endif
                                    </td>
                                    <td class="text-right">
                                        <span class="font-weight-bold">{{ $product->formatted_base_price }}</span>
                                    </td>
                                    <td>{{ $product->created_at->format('d/m/Y') }}</td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center align-items-center gap-1">
                                            <a href="{{ route('admin.products.show', $product->id) }}"
                                                class="btn btn-info btn-sm" title="Ver">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{{ route('admin.products.edit', $product->id) }}"
                                                class="btn btn-warning btn-sm" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            @if ($product->status === 'active')
                                                <form action="{{ route('admin.products.toggle_status', $product->id) }}"
                                                    method="POST" class="d-inline"
                                                    data-confirm="¿Cambiar a descontinuado?">
                                                    @csrf
                                                    <button type="submit" class="btn btn-secondary btn-sm"
                                                        title="Descontinuar">
                                                        <i class="fas fa-ban"></i>
                                                    </button>
                                                </form>
                                            @elseif($product->status === 'discontinued')
                                                <form action="{{ route('admin.products.toggle_status', $product->id) }}"
                                                    method="POST" class="d-inline" data-confirm="¿Activar producto?">
                                                    @csrf
                                                    <button type="submit" class="btn btn-success btn-sm" title="Activar">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </form>
                                            @endif

                                            @if ($product->canDelete())
                                                <a href="{{ route('admin.products.confirm_delete', $product->id) }}"
                                                    class="btn btn-danger btn-sm" title="Eliminar">
                                                    <i class="fas fa-trash"></i>
                                                </a>
                                            @endif
                                        </div>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- /.card-body -->

        </div>
    @stop

    @section('css')
        <style>
            /* Estilos para los botones de DataTables */
            #products-table_wrapper .dt-buttons {
                background-color: transparent;
                box-shadow: none;
                border: none;
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 15px;
            }

            #products-table_wrapper .btn {
                color: #fff;
                border-radius: 4px;
                padding: 5px 15px;
                font-size: 14px;
            }

            .btn-danger {
                background-color: #dc3545;
                border: none;
            }

            .btn-success {
                background-color: #28a745;
                border: none;
            }

            .btn-info {
                background-color: #17a2b8;
                border: none;
            }

            .btn-warning {
                background-color: #ffc107;
                color: #212529;
                border: none;
            }

            .btn-default {
                background-color: #6e7176;
                color: #fff;
                border: none;
            }

            .product-img {
                width: 60px;
                height: 60px;
                object-fit: cover;
                border-radius: 5px;
            }
        </style>
        <!-- Select2 CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/select2-bootstrap-theme/0.1.0-beta.10/select2-bootstrap.min.css">
    @stop

    @section('js')
        <!-- DataTables & Plugins -->
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.0/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.0/js/buttons.bootstrap4.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.0/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.0/js/buttons.print.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.0/js/buttons.colVis.min.js"></script>

        <!-- Select2 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/i18n/es.js"></script>

        <!-- SweetAlert2 -->
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

        <script>
            $(document).ready(function() {
                // Inicializar Select2
                $('.select2').select2({
                    theme: 'bootstrap4',
                    language: 'es'
                });

                // Inicializar DataTable
                var table = $('#products-table').DataTable({
                    "pageLength": 10,
                    "language": {
                        "emptyTable": "No hay información de productos",
                        "info": "Mostrando _START_ a _END_ de _TOTAL_ productos",
                        "infoEmpty": "Mostrando 0 a 0 de 0 productos",
                        "infoFiltered": "(Filtrado de _MAX_ total productos)",
                        "lengthMenu": "Mostrar _MENU_ productos",
                        "loadingRecords": "Cargando...",
                        "processing": "Procesando...",
                        "search": "Buscador:",
                        "zeroRecords": "Sin resultados encontrados",
                        "paginate": {
                            "first": "Primero",
                            "last": "Último",
                            "next": "Siguiente",
                            "previous": "Anterior"
                        }
                    },
                    "responsive": true,
                    "lengthChange": true,
                    "autoWidth": false,
                    "searching": true,
                    "ordering": true,
                    "info": true,
                    "paging": true,
                    buttons: [{
                            text: '<i class="fas fa-copy"></i> COPIAR',
                            extend: 'copy',
                            className: 'btn btn-default'
                        },
                        {
                            text: '<i class="fas fa-file-pdf"></i> PDF',
                            extend: 'pdf',
                            className: 'btn btn-danger'
                        },
                        {
                            text: '<i class="fas fa-file-csv"></i> CSV',
                            extend: 'csv',
                            className: 'btn btn-info'
                        },
                        {
                            text: '<i class="fas fa-file-excel"></i> EXCEL',
                            extend: 'excel',
                            className: 'btn btn-success'
                        },
                        {
                            text: '<i class="fas fa-print"></i> IMPRIMIR',
                            extend: 'print',
                            className: 'btn btn-default'
                        },
                        {
                            text: '<i class="fas fa-eye"></i> COLUMNAS',
                            extend: 'colvis',
                            className: 'btn btn-secondary'
                        }
                    ]
                });

                // Añadir los botones al contenedor
                table.buttons().container().appendTo('#products-table_wrapper .row:eq(0)');

                // Filtrar por categoría
                $('#category_filter').on('change', function() {
                    table.column(4).search(this.value).draw();
                });

                // Filtrar por estado
                $('#status_filter').on('change', function() {
                    table.column(6).search(this.value).draw();
                });

                // Búsqueda general
                $('#search_filter').on('keyup', function() {
                    table.search(this.value).draw();
                });

                // Botón de filtrar
                $('#btn_filter').on('click', function() {
                    let category = $('#category_filter').val();
                    let status = $('#status_filter').val();
                    let search = $('#search_filter').val();

                    table.column(4).search(category);
                    table.column(6).search(status);
                    table.search(search).draw();
                });

                // Botón de resetear filtros
                $('#btn_reset').on('click', function() {
                    $('#category_filter').val('').trigger('change');
                    $('#status_filter').val('').trigger('change');
                    $('#search_filter').val('');

                    table.columns().search('');
                    table.search('').draw();
                });

                // SweetAlert para confirmaciones
                $(document).on('submit', 'form[data-confirm]', function(e) {
                    e.preventDefault();
                    var form = this;

                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: $(this).data('confirm'),
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Sí, continuar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                });
            });
        </script>
    @stop
</file>

<file path="resources/views/admin/proveedores/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Proveedor')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="card card-danger">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;  font-size: 20px;"> ELIMINAR PROVEEDOR</h3>
        </div>

        <div class="card-body">
            <form id="deleteForm" method="post" action="{{ route('admin.proveedores.destroy', $proveedor->id) }}">
                @csrf
                @method('DELETE')

                <div class="row">
                    {{-- DATOS DEL PROVEEDOR --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">

                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-building"></i> Datos del Proveedor
                            </h5>
                        </div>

                        {{-- Nombre --}}
                        <div class="form-group">
                            <label>Nombre Proveedor <span style="color: red;">*</span></label>
                            <input type="text" name="nombre_proveedor"
                                class="form-control form-control-sm @error('nombre_proveedor') is-invalid @enderror"
                                value="{{ old('nombre_proveedor', $proveedor->nombre_proveedor) }}"
                                placeholder="Nombre del proveedor" disabled>
                            @error('nombre_proveedor')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        {{-- Giro --}}
                        <div class="form-group">
                            <label>Giro <span style="color: red;">*</span></label>
                            <select name="giro_id"
                                class="form-control form-control-sm @error('giro_id') is-invalid @enderror" disabled>
                                <option value="">Selecciona un Giro</option>
                                @foreach ($giros as $giro)
                                    <option value="{{ $giro->id }}"
                                        {{ old('giro_id', $proveedor->giro_id) == $giro->id ? 'selected' : '' }}>
                                        {{ $giro->nombre_giro }}
                                    </option>
                                @endforeach
                            </select>
                            @error('giro_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        {{-- Dirección --}}
                        <div class="row">
                            <div class="col-md-10">
                                <div class="form-group">
                                    <label>Dirección</label>
                                    <input type="text" name="direccion" class="form-control form-control-sm"
                                        value="{{ old('direccion', $proveedor->direccion) }}" placeholder="Dirección"
                                        disabled>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>C.P.</label>
                                    <input type="text" name="codigo_postal"
                                        class="form-control form-control-sm @error('codigo_postal') is-invalid @enderror"
                                        value="{{ old('codigo_postal', $proveedor->codigo_postal) }}" placeholder="C.P"
                                        maxlength="5" oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                                        pattern="[0-9]{5}" disabled>
                                    @error('codigo_postal')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Teléfono y correo --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Teléfono <span style="color: red;">*</span></label>
                                    <input type="tel" name="telefono"
                                        class="form-control form-control-sm @error('telefono') is-invalid @enderror"
                                        value="{{ old('telefono', $proveedor->telefono) }}" disabled
                                        placeholder="Ej: 2233445566" maxlength="10"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}">
                                    @error('telefono')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Correo <span style="color: red;" for="email">*</span></label>
                                    <input type="email" name="email"
                                        class="form-control form-control-sm @error('email') is-invalid @enderror"
                                        value="{{ old('email', $proveedor->email) }}" placeholder="Ej: correo@correo.com"
                                        disabled>
                                    @error('email')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Estado y ciudad --}}
                        <div class="row">
                            <div class="col-md-6">
                                <label>Estado <span style="color: red;">*</span></label>
                                <select name="estado_id"
                                    class="form-control form-control-sm @error('estado_id') is-invalid @enderror" disabled>
                                    <option value="">Selecciona un estado</option>
                                    @foreach ($estados as $estado)
                                        <option value="{{ $estado->id }}"
                                            {{ old('estado_id', $proveedor->estado_id) == $estado->id ? 'selected' : '' }}>
                                            {{ $estado->nombre_estado }}
                                        </option>
                                    @endforeach
                                </select>
                                @error('estado_id')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            <div class="col-md-6">
                                <label>Ciudad <span style="color: red;">*</span></label>
                                <input type="text" name="ciudad" class="form-control form-control-sm" disabled
                                    value="{{ old('ciudad', $proveedor->ciudad) }}" placeholder="Ej: Merida">
                            </div>
                        </div>
                        <div style="font-weight: bold;font-size: 25px;text-align: center;padding: 0px;margin: 0px;">
                            ¿Deseas
                            eliminar el
                            proveedor?</div>
                        {{-- Botones --}}
                        <div class="text-center mt-4">
                            <a href="{{ route('admin.proveedores.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-trash-alt"></i> Eliminar
                            </button>
                        </div>
                    </div>

                    {{-- DATOS CONTACTO --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-address-book"></i> Datos de Contacto
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Nombre del contacto</label>
                            <input type="text" name="nombre_contacto" class="form-control form-control-sm"
                                value="{{ old('nombre_contacto', $proveedor->nombre_contacto) }}"
                                placeholder="Nombre del contacto" disabled>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label>Teléfono</label>
                                <input type="tel" name="telefono_contacto" class="form-control form-control-sm"
                                    value="{{ old('telefono_contacto', $proveedor->telefono_contacto) }}"
                                    placeholder="Ej: 2233445566" maxlength="10"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}" disabled>
                            </div>
                            <div class="col-md-6">
                                <label for="email_contacto">Correo</label>
                                <input type="email" name="email_contacto" class="form-control form-control-sm"
                                    value="{{ old('email_contacto', $proveedor->email_contacto) }}"
                                    placeholder="Ej: correo@correo.com" disabled>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        // SweetAlert2 para eliminar proveedor
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();

            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡Eliminarás este proveedor y todos sus datos asociados!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33', // Rojo
                cancelButtonColor: '#6c757d', // Gris (Secondary)
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/purchases/cancel.blade.php">
@extends('adminlte::page')

@section('title', 'Cancelar OC: ' . $purchase->purchase_number)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    @endif

    {{-- MENSAJES FLASH --}}
    @if (session('error'))
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ session('error') }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    @endif

    {{-- BREADCRUMB --}}
    <div class="card bg-light mb-3">
        <div class="card-body py-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0 bg-transparent p-0">
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.purchases.index') }}">
                            <i class="fas fa-shopping-cart"></i> Órdenes de Compra
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ route('admin.purchases.show', $purchase->id) }}">
                            {{ $purchase->purchase_number }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active">Cancelar</li>
                </ol>
            </nav>
        </div>
    </div>

    <form method="POST" action="{{ route('admin.purchases.cancel.store', $purchase->id) }}" id="cancelForm">
        @csrf

        <div class="card card-danger">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold; font-size: 20px;">
                    <i class="fas fa-ban"></i> CANCELAR ORDEN DE COMPRA
                </h3>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-8 offset-md-2">
                        {{-- INFORMACIÓN DE LA COMPRA --}}
                        <div class="card border-danger mb-4">
                            <div class="card-header bg-danger text-white">
                                <i class="fas fa-file-invoice"></i>
                                <strong>Orden: {{ $purchase->purchase_number }}</strong>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 130px;"><strong>Proveedor:</strong></td>
                                                    <td>{{ $purchase->proveedor->nombre_proveedor ?? 'N/A' }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Fecha Orden:</strong></td>
                                                    <td>{{ $purchase->ordered_at ? $purchase->ordered_at->format('d/m/Y') : '-' }}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Referencia:</strong></td>
                                                    <td>{{ $purchase->reference ?? '-' }}</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <table class="table table-sm table-borderless mb-0">
                                            <tbody>
                                                <tr>
                                                    <td style="width: 130px;"><strong>Estado Actual:</strong></td>
                                                    <td>
                                                        <span class="badge badge-{{ $purchase->status_color }}">
                                                            <i class="{{ $purchase->status_icon }}"></i>
                                                            {{ $purchase->status_label }}
                                                        </span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Total Items:</strong></td>
                                                    <td>{{ $purchase->items->count() }}</td>
                                                </tr>
                                                <tr>
                                                    <td><strong>Total:</strong></td>
                                                    <td class="font-weight-bold text-primary" style="font-size: 18px;">
                                                        {{ $purchase->formatted_total }}
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{-- MOTIVO DE CANCELACIÓN --}}
                        <div class="form-group">
                            <label for="cancellation_reason">
                                Motivo de Cancelación <span class="text-danger">*</span>
                            </label>
                            <textarea name="cancellation_reason" id="cancellation_reason"
                                class="form-control @error('cancellation_reason') is-invalid @enderror" rows="4" required minlength="10"
                                maxlength="500" placeholder="Explique detalladamente el motivo de la cancelación (mínimo 10 caracteres)...">{{ old('cancellation_reason') }}</textarea>
                            @error('cancellation_reason')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">
                                <span id="charCount">0</span> / 500 caracteres (mínimo 10)
                            </small>
                        </div>

                        {{-- ADVERTENCIAS --}}
                        <div class="alert alert-warning">
                            <h5 class="alert-heading">
                                <i class="fas fa-exclamation-triangle"></i> Advertencia
                            </h5>
                            <hr>
                            <ul class="mb-0">
                                <li>Esta acción <strong>no se puede deshacer</strong>.</li>
                                <li>La orden quedará marcada como <strong>cancelada permanentemente</strong>.</li>
                                <li>No se podrá editar ni recibir mercancía de esta orden.</li>
                                <li>El motivo de cancelación quedará registrado en el sistema.</li>
                            </ul>
                        </div>


                    </div>
                </div>
            </div>

            <div class="card-footer">
                <div class="row">
                    <div class="col-md-8 offset-md-2 text-center">
                        <a href="{{ route('admin.purchases.show', $purchase->id) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver
                        </a>
                        <button type="submit" class="btn btn-danger" id="btnCancel">
                            <i class="fas fa-ban"></i> Confirmar Cancelación
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
@stop

@section('js')
    <script>
        $(function() {
            // Contador de caracteres
            const $textarea = $('#cancellation_reason');
            const $charCount = $('#charCount');
            const $btnCancel = $('#btnCancel');

            function updateCharCount() {
                const length = $textarea.val().length;
                $charCount.text(length);

                if (length < 10) {
                    $charCount.removeClass('text-success').addClass('text-danger');
                } else {
                    $charCount.removeClass('text-danger').addClass('text-success');
                }
            }

            $textarea.on('input', updateCharCount);
            updateCharCount();

            // Validación del formulario
            // Validación del formulario con SweetAlert2
            $('#cancelForm').on('submit', function(e) {
                e.preventDefault();

                if ($textarea.val().length < 10) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error de validación',
                        text: 'El motivo de cancelación debe tener al menos 10 caracteres',
                        confirmButtonText: 'Entendido'
                    });
                    $textarea.focus();
                    return false;
                }

                Swal.fire({
                    title: '¿Está seguro?',
                    text: "Esta acción marcará la orden como cancelada permanentemente y no se podrá deshacer.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33', // Rojo
                    cancelButtonColor: '#6c757d', // Gris
                    confirmButtonText: 'Sí, cancelar orden',
                    cancelButtonText: 'Volver',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.submit();
                    }
                });
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/recomendaciones/create.blade.php">
@extends('adminlte::page')

@section('title', 'RECOMENDACIÓN')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-primary " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVA RECOMENDACIÓN</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.recomendaciones.store') }}">
                    @csrf
                    @method('POST')
                    <div class="col-md-12">
                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos de la Recomendación
                            </h5>
                        </div>
                        <div class="form-group">
                            <label for="nombre_recomendacion">Nombre <span style="color: red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="nombre_recomendacion"
                                name="nombre_recomendacion" placeholder="Ej: TELAS" required
                                pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+" title="Solo se permiten letras y espacios"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')">
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-end align-items-center mt-4">
                            <a href="{{ route('admin.recomendaciones.index') }}" class="btn btn-secondary mr-2"
                                style="padding: 8px 20px;">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary" style="padding: 8px 20px;">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/recomendaciones/edit.blade.php">
@extends('adminlte::page')

@section('title', 'EDITAR RECOMENDACIÓN')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-12 col-md-6 col-lg-4">

        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        <div class="card card-warning " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                    EDITAR RECOMENDACIÓN
                </h3>
            </div>

            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.recomendaciones.update', $recomendacion->id) }}">
                    @csrf
                    @method('PUT')

                    <div class="col-md-12">

                        <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #856404; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos de la Recomendación
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>
                                Nombre <span style="color: red;">*</span>
                            </label>

                            <input type="text"
                                class="form-control form-control-sm @error('nombre_recomendacion') is-invalid @enderror"
                                id="nombre_recomendacion" name="nombre_recomendacion" placeholder="Ej: MEXICO"
                                pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+" title="Solo se permiten letras y espacios"
                                value="{{ $recomendacion->nombre_recomendacion }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" required>

                            @error('nombre_recomendacion')
                                <div class="invalid-feedback">
                                    {{ $message }}
                                </div>
                            @enderror
                        </div>

                        <div class="d-flex justify-content-end align-items-center mt-4">
                            <a href="{{ route('admin.recomendaciones.index') }}" class="btn btn-secondary mr-2">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>

                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Actualizar
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
@stop


@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/recomendaciones/index.blade.php">
@extends('adminlte::page')

@section('title', 'RECOMENDACIONES')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary" bis_skin_checked="1">

        <div class="card-header" bis_skin_checked="1">

            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> RECOMENDACIONES</h3>
            <!-- /.card-tools -->
        </div>
        <!-- /.card-header -->
        <div class="card-body" bis_skin_checked="1">
            <div class="row">
                <a href="{{ route('admin.recomendaciones.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i></a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover table-condensed">
                        <thead class="thead-dark">
                            <tr style="text-align: center;">
                                <th>#</th>
                                <th>Nombre de la recomendacion</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach ($recomendaciones as $recomendacion)
                                <tr style="text-align: center;">
                                    <td>{{ $loop->iteration }}</td>
                                    <td>{{ $recomendacion->nombre_recomendacion }}</td>
                                    <td style="text-align: center;">
                                        <a class="btn btn-warning"
                                            href="{{ route('admin.recomendaciones.edit', $recomendacion->id) }}"><i
                                                class="fas fa-edit"></i></a>
                                        <a class="btn btn-danger"
                                            href="{{ route('admin.recomendaciones.confirm_delete', $recomendacion->id) }}"><i
                                                class="fas fa-trash"></i></a>
                                    </td>
                                </tr>
                            @endforeach

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- /.card-body -->
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            /* Centrar los botones */
            flex-wrap: wrap;
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Recomendaciones",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Recomendaciones",
                    "infoFiltered": "(Filtrado de _MAX_ total Recomendaciones)",
                    "lengthMenu": "Mostrar _MENU_ Recomendaciones",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/tipos_aplicacion/index.blade.php">
@extends('adminlte::page')

 @section('title', 'TIPOS DE APLICACION')

 @section('content_header')
 @stop

 @section('content')
     <br>
     <div class="card card-primary" bis_skin_checked="1">

         <div class="card-header" bis_skin_checked="1">

             <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> TIPOS DE APLICACION</h3>
             <!-- /.card-tools -->
         </div>
         <!-- /.card-header -->
         <div class="card-body" bis_skin_checked="1">
             <div class="row">
                 <a href="{{ route('admin.tipos_aplicacion.create') }}" type="button" class="btn btn-primary">
                     Nuevo <i class="fas fa-plus"></i></a>
             </div>
             <hr>
             <div class="col-12">
                 <div class="table-responsive">
                     <table id="example1" class="table table-bordered table-hover table-condensed">
                         <thead class="thead-dark">
                             <tr style="text-align: center;">
                                 <th>#</th>
                                 <th>Nombre del tipo de aplicacion</th>
                                 <th style="text-align: center;">Acciones</th>
                             </tr>
                         </thead>
                         <tbody>

                             @foreach ($aplication_types as $aplication_type)
                                 <tr style="text-align: center;">
                                     <td>{{ $loop->iteration }}</td>
                                     <td>{{ $aplication_type->nombre_aplicacion }}</td>
                                     <td style="text-align: center;">
                                         <a class="btn btn-warning"
                                             href="{{ route('admin.tipos_aplicacion.edit', $aplication_type->id) }}"><i
                                                 class="fas fa-edit"></i></a>
                                         <a class="btn btn-danger"
                                             href="{{ route('admin.tipos_aplicacion.confirm_delete', $aplication_type->id) }}"><i
                                                 class="fas fa-trash"></i></a>
                                     </td>
                                 </tr>
                             @endforeach

                         </tbody>
                     </table>
                 </div>
             </div>
         </div>
         <!-- /.card-body -->
     </div>
 @stop

 @section('css')
     <style>
         /* Fondo transparente y sin borde en el contenedor */
         #example1_wrapper .dt-buttons {
             background-color: transparent;
             box-shadow: none;
             border: none;
             display: flex;
             justify-content: center;
             /* Centrar los botones */
             flex-wrap: wrap;
             gap: 10px;
             /* Espaciado entre botones */
             margin-bottom: 15px;
             /* Separar botones de la tabla */
         }

         /* Estilo personalizado para los botones */
         #example1_wrapper .btn {
             color: #fff;
             /* Color del texto en blanco */
             border-radius: 4px;
             /* Bordes redondeados */
             padding: 5px 15px;
             /* Espaciado interno */
             font-size: 14px;
             /* TamaÃ±o de fuente */
         }

         /* Colores por tipo de botÃ³n */
         .btn-danger {
             background-color: #dc3545;
             border: none;
         }

         .btn-success {
             background-color: #28a745;
             border: none;
         }

         .btn-info {
             background-color: #17a2b8;
             border: none;
         }

         .btn-warning {
             background-color: #ffc107;
             color: #212529;
             border: none;
         }

         .btn-default {
             background-color: #6e7176;
             color: #212529;
             border: none;
         }
     </style> {{-- Add here extra stylesheets --}}
     {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
 @stop

 @section('js')
     <script>
         $(function() {
             $("#example1").DataTable({
                 "pageLength": 10,
                 "language": {
                     "emptyTable": "No hay informacion",
                     "info": "Mostrando _START_ a _END_ de _TOTAL_ Tipos de aplicacion",
                     "infoEmpty": "Mostrando 0 a 0 de 0 Tipos de aplicacion",
                     "infoFiltered": "(Filtrado de _MAX_ total Tipos de aplicacion)",
                     "lengthMenu": "Mostrar _MENU_ Tipos de aplicacion",
                     "loadingRecords": "Cargando...",
                     "processing": "Procesando...",
                     "search": "Buscador:",
                     "zeroRecords": "Sin resultados encontrados",
                     "paginate": {
                         "first": "Primero",
                         "last": "Ultimo",
                         "next": "Siguiente",
                         "previous": "Anterior"
                     }
                 },
                 "responsive": true,
                 "lengthChange": true,
                 "autoWidth": false,
                 buttons: [{
                         text: '<i class="fas fa-copy"></i> COPIAR',
                         extend: 'copy',
                         className: 'btn btn-default'
                     },
                     {
                         text: '<i class="fas fa-file-pdf"></i> PDF',
                         extend: 'pdf',
                         className: 'btn btn-danger'
                     },
                     {
                         text: '<i class="fas fa-file-csv"></i> CSV',
                         extend: 'csv',
                         className: 'btn btn-info'
                     },
                     {
                         text: '<i class="fas fa-file-excel"></i> EXCEL',
                         extend: 'excel',
                         className: 'btn btn-success'
                     },
                     {
                         text: '<i class="fas fa-print"></i> IMPRIMIR',
                         extend: 'print',
                         className: 'btn btn-default'
                     }
                 ]
             }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
         });
     </script>
 @stop
</file>

<file path="app/Http/Controllers/DesignController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Design;
use App\Models\Category;
use App\Models\Image;
use App\Services\DesignService;
use App\Services\ImageService;
use App\Services\Search\SearchService;
use App\Http\Requests\StoreDesignRequest;
use App\Http\Requests\UpdateDesignRequest;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Session;

class DesignController extends Controller
{
    protected $designService;
    protected $imageService;
    protected $searchService;

    public function __construct(DesignService $designService, ImageService $imageService, SearchService $searchService)
    {
        $this->designService = $designService;
        $this->imageService = $imageService;
        $this->searchService = $searchService;
        $this->middleware('secure.file.upload')->only(['store', 'update']);
    }

    public function index(Request $request)
    {
        try {
            $baseQuery = Design::query()
                ->with(['categories', 'primaryImage', 'variants', 'variants.primaryImage'])
                ->where('is_active', true);

            // Variable para almacenar IDs de búsqueda (usada también en conteo de categorías)
            $matchingIds = [];

            // Búsqueda avanzada con normalización española
            if ($request->filled('search')) {
                $searchTerm = $request->search;

                // Obtener IDs que coinciden con búsqueda normalizada
                $matchingIds = $this->searchService->getMatchingIds(
                    $searchTerm,
                    Design::class,
                    ['limit' => 500]
                );

                if (!empty($matchingIds)) {
                    // Usar los IDs encontrados, mantener relevancia
                    $idsString = implode(',', $matchingIds);
                    $baseQuery->whereIn('id', $matchingIds)
                              ->orderByRaw("FIELD(id, {$idsString})");
                } else {
                    // Fallback: búsqueda LIKE tradicional si el índice no tiene resultados
                    $baseQuery->where(function ($q) use ($searchTerm) {
                        $q->where('name', 'like', "%{$searchTerm}%")
                          ->orWhere('description', 'like', "%{$searchTerm}%");
                    });
                }
            }

            $activeCategory = null;
            if ($request->filled('category')) {
                $activeCategory = Category::where('slug', $request->category)
                    ->where('is_active', true)
                    ->first();

                if ($activeCategory) {
                    $baseQuery->whereHas('categories', function ($q) use ($activeCategory) {
                        $q->where('categories.id', $activeCategory->id);
                    });
                }
            }

            $designs = (clone $baseQuery)
                ->orderByDesc('created_at')
                ->paginate(12)
                ->withQueryString();

            $categories = Category::where('is_active', true)
                ->orderBy('name')
                ->get();

            $categoryCounts = [];
            foreach ($categories as $category) {
                $countQuery = Design::query()
                    ->where('is_active', true);

                // Usar misma lógica de búsqueda avanzada para el conteo
                if ($request->filled('search') && !empty($matchingIds)) {
                    $countQuery->whereIn('id', $matchingIds);
                } elseif ($request->filled('search')) {
                    $countQuery->where(function ($q) use ($request) {
                        $q->where('name', 'like', '%' . $request->search . '%')
                          ->orWhere('description', 'like', '%' . $request->search . '%');
                    });
                }

                $categoryCounts[$category->id] = $countQuery
                    ->whereHas('categories', fn($q) => $q->where('categories.id', $category->id))
                    ->count();
            }

            return view('admin.designs.index', compact(
                'designs',
                'categories',
                'activeCategory',
                'categoryCounts'
            ));
        } catch (\Exception $e) {
            Log::error('Error al cargar listado de diseños: ' . $e->getMessage());
            return redirect()
                ->route('admin.designs.index')
                ->with('icon', 'error')
                ->with('error', 'Error al cargar los diseños: ' . $e->getMessage());
        }
    }

    /**
     * Obtener listado de diseños vía AJAX (para búsqueda sin reload).
     * Soporta filtro por categoría.
     */
    public function ajaxList(Request $request)
    {
        try {
            $query = Design::with(['primaryImage', 'categories', 'variants', 'exports'])
                ->where('is_active', true);

            // Filtro por categoría si se especifica
            if ($request->filled('category')) {
                $query->whereHas('categories', function ($q) use ($request) {
                    $q->where('slug', $request->category);
                });
            }

            $designs = $query->orderByDesc('created_at')
                ->limit(100)
                ->get();

            $formattedDesigns = $designs->map(function ($design) {
                return [
                    'id' => $design->id,
                    'name' => $design->name,
                    'slug' => $design->slug,
                    'description' => $design->description,
                    'image' => $design->primaryImage
                        ? asset('storage/' . $design->primaryImage->file_path)
                        : null,
                    'categories' => $design->categories->pluck('name')->toArray(),
                    'variants_count' => $design->variants->count(),
                    'exports_count' => $design->exports->count(),
                ];
            });

            return response()->json([
                'success' => true,
                'data' => $formattedDesigns,
                'total' => $formattedDesigns->count(),
            ]);
        } catch (\Exception $e) {
            Log::error('Error en ajaxList: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error al cargar diseños',
                'data' => [],
            ], 500);
        }
    }

    public function show(Design $design)
    {
        try {
            $design->load([
                'categories',
                'primaryImage',
                'variants.images' => function ($q) {
                    $q->orderBy('order');
                },
                'variants.attributeValues'
            ]);

            // Cargar conteos de exports (todas las exportaciones del diseño)
            $design->loadCount('exports');

            $formattedDesign = [
                'id' => $design->id,
                'name' => $design->name,
                'slug' => $design->slug,
                'description' => $design->description,
                'is_active' => $design->is_active,
                'variants_count' => $design->variants->count(),
                'exports_count' => $design->exports_count ?? 0,
                'primaryImage' => $design->primaryImage ? [
                    'id' => $design->primaryImage->id,
                    'file_path' => $design->primaryImage->file_path,
                    'thumbnail_small' => $design->primaryImage->thumbnail_small,
                    'thumbnail_medium' => $design->primaryImage->thumbnail_medium,
                    'alt_text' => $design->primaryImage->alt_text,
                    'is_primary' => $design->primaryImage->is_primary,
                    'order' => $design->primaryImage->order
                ] : null,
                'variants' => $design->variants->map(function ($variant) {
                    return [
                        'id' => $variant->id,
                        'name' => $variant->name,
                        'sku' => $variant->sku,
                        'price' => $variant->price,
                        'stock' => $variant->stock,
                        'is_active' => $variant->is_active,
                        'is_default' => $variant->is_default,
                        'images' => $variant->images->map(function ($image) {
                            return [
                                'id' => $image->id,
                                'file_path' => $image->file_path,
                                'thumbnail_small' => $image->thumbnail_small,
                                'thumbnail_medium' => $image->thumbnail_medium,
                                'alt_text' => $image->alt_text,
                                'is_primary' => $image->is_primary,
                                'order' => $image->order
                            ];
                        })
                    ];
                })
            ];

            return response()->json([
                'success' => true,
                'design' => $formattedDesign
            ]);
        } catch (\Exception $e) {
            Log::error('Error al cargar detalles del diseño: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error al cargar detalles: ' . $e->getMessage()
            ], 500);
        }
    }

    public function create()
    {
        try {
            $categories = Category::where('is_active', true)
                ->orderBy('name')
                ->get();

            // Recuperar datos temporales si existen
            $tempImageData = Session::get('temp_image_data');

            return view('admin.designs.create', compact('categories', 'tempImageData'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de creación: ' . $e->getMessage());
            return redirect()
                ->route('admin.designs.create')
                ->with('icon', 'error')
                ->with('error', 'Error al cargar el formulario: ' . $e->getMessage());
        }
    }

    public function store(StoreDesignRequest $request)
    {
        DB::beginTransaction();

        try {
            Log::info('=== INICIO CREACIÓN DE DISEÑO ===');
            Log::info('Datos recibidos:', $request->only(['name', 'description', 'categories']));
            Log::info('¿Tiene archivo?', ['hasFile' => $request->hasFile('image')]);

            // Obtener información de validación del middleware
            $detectedType = $request->input('_file_image_type', 'image');
            $detectedFormat = $request->input('_file_image_format');
            $correctExtension = $request->input('_file_image_extension');
            $uploadNote = $request->input('_file_image_note');

            if ($uploadNote) {
                Log::info('Nota del middleware: ' . $uploadNote);
            }

            // Preparar datos del diseño
            $designData = $request->validated();

            // Crear diseño usando el servicio
            $design = $this->designService->createDesign($designData);
            Log::info('Diseño creado con ID: ' . $design->id);

            // Procesar archivo temporal si existe
            $tempImageData = Session::get('temp_image_data');
            if ($tempImageData && isset($tempImageData['temp_path'])) {
                $this->processTempImage($design, $tempImageData);
            } elseif ($request->hasFile('image')) {
                // Guardar archivo si fue subido
                $file = $request->file('image');
                $originalExtension = strtolower($file->getClientOriginalExtension());

                Log::info('Información del archivo:', [
                    'nombre' => $file->getClientOriginalName(),
                    'tamaño' => $file->getSize(),
                    'tipo_mime' => $file->getMimeType(),
                    'extensión_original' => $originalExtension,
                    'extensión_correcta' => $correctExtension,
                    'tipo_detectado' => $detectedType,
                    'formato_detectado' => $detectedFormat,
                    'nota' => $uploadNote,
                    'válido' => $file->isValid(),
                ]);

                // Determinar tipo de archivo basado en detección del middleware
                if ($detectedType === 'image' || $detectedType === 'vector') {
                    // Usar el ImageService existente para imágenes/vectores
                    // [ACTUALIZACIÓN]: Se pasa 'forced_extension' para que ImageService use la corrección del middleware
                    $image = $this->imageService->uploadImage(
                        $file,
                        'App\Models\Design',
                        $design->id,
                        [
                            'design_name' => $design->name,
                            'alt_text' => $request->name,
                            'is_primary' => true,
                            'order' => 0,
                            'forced_extension' => $correctExtension // [ACTUALIZACIÓN]
                        ]
                    );

                    Log::info('Archivo guardado con ID: ' . $image->id);
                    Log::info('Ruta del archivo: ' . $image->file_path);

                    // Actualizar información adicional del archivo en el diseño
                    $design->update([
                        'file_type' => $detectedType,
                        'file_extension' => $correctExtension ?? $originalExtension,
                        'file_size' => $file->getSize(),
                        'original_filename' => $file->getClientOriginalName(),
                        'detected_format' => $detectedFormat,
                    ]);

                    // Mostrar mensaje al usuario si la extensión fue corregida
                    if ($uploadNote && Str::contains($uploadNote, 'será corregida')) {
                        session()->flash('extension_warning', $uploadNote);
                    }
                } elseif ($detectedType === 'embroidery') {
                    // Para archivos de bordado, usar el proceso existente
                    $originalName = pathinfo($file->getClientOriginalName(), PATHINFO_FILENAME);
                    // [ACTUALIZACIÓN]: Usar correctExtension si está disponible
                    $finalExt = $correctExtension ?? $originalExtension;
                    $fileName = Str::slug($originalName) . '_' . time() . '_' . Str::random(8) . '.' . $finalExt;
                    $path = $file->storeAs('designs/embroidery', $fileName, 'public');

                    // Crear registro en tabla images para mantener consistencia
                    $image = Image::create([
                        'file_path' => $path,
                        'alt_text' => $request->name . ' (Archivo de bordado)',
                        'is_primary' => true,
                        'order' => 0,
                        'imageable_type' => 'App\Models\Design',
                        'imageable_id' => $design->id,
                        'original_extension' => $originalExtension,
                        'correct_extension' => $correctExtension,
                    ]);

                    // Actualizar diseño con información del archivo
                    $design->update([
                        'file_type' => 'embroidery',
                        'file_extension' => $correctExtension ?? $originalExtension,
                        'file_size' => $file->getSize(),
                        'original_filename' => $file->getClientOriginalName(),
                        'embroidery_file_path' => $path,
                        'detected_format' => $detectedFormat,
                    ]);

                    Log::info('Archivo de bordado guardado en: ' . $path);
                }
            } else {
                Log::warning('No se recibió ningún archivo en la petición');
            }

            DB::commit();
            Log::info('=== FIN CREACIÓN DE DISEÑO EXITOSA ===');

            // Limpiar datos temporales si existen
            Session::forget('temp_image_data');

            // Si es una solicitud AJAX, responder con JSON
            if ($request->ajax() || $request->wantsJson()) {
                $successMessage = 'Diseño ' . mb_strtoupper($design->name, 'UTF-8') . ' creado exitosamente';

                // Guardar mensaje en sesión para que aparezca el SweetAlert en el index
                Session::flash('success', $successMessage);

                return response()->json([
                    'success' => true,
                    'message' => $successMessage,
                    'redirect' => route('admin.designs.index'),
                    'design' => [
                        'id' => $design->id,
                        'name' => $design->name,
                    ]
                ]);
            }

            // Preparar respuesta con posible advertencia
            $response = redirect()
                ->route('admin.designs.index')
                ->with('success', 'Diseño ' . mb_strtoupper($request->name, 'UTF-8') . ' creado exitosamente')
                ->with('icon', 'success');

            if (session()->has('extension_warning')) {
                $response->with('warning', session('extension_warning'));
            }

            return $response;
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('=== ERROR AL CREAR DISEÑO ===');
            Log::error('Mensaje: ' . $e->getMessage());
            Log::error('Archivo: ' . $e->getFile());
            Log::error('Línea: ' . $e->getLine());
            Log::error('Stack trace: ' . $e->getTraceAsString());

            // Guardar temporalmente la información del archivo si fue subido
            if ($request->hasFile('image')) {
                $file = $request->file('image');

                // Almacenar archivo temporalmente
                $tempFileName = 'temp_' . time() . '_' . Str::random(8) . '.' . $file->getClientOriginalExtension();
                $tempPath = $file->storeAs('temp', $tempFileName, 'public');

                // Guardar información del archivo en sesión
                Session::put('temp_image_data', [
                    'temp_path' => $tempPath,
                    'original_name' => $file->getClientOriginalName(),
                    'original_extension' => $file->getClientOriginalExtension(),
                    'detected_type' => $request->input('_file_image_type', 'image'),
                    'detected_format' => $request->input('_file_image_format'),
                    'correct_extension' => $request->input('_file_image_extension'),
                    'upload_note' => $request->input('_file_image_note'),
                    'file_size' => $file->getSize(),
                    'original_filename' => $file->getClientOriginalName(),
                ]);
            }

            // Si es una solicitud AJAX, responder con JSON
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error al crear el diseño: ' . $e->getMessage(),
                    'errors' => []
                ], 500);
            }

            return redirect()
                ->route('admin.designs.create')
                ->with('icon', 'error')
                ->withInput()
                ->with('error', 'Error al crear el diseño: ' . $e->getMessage());
        }
    }

    public function edit(Design $design)
    {
        try {
            $categories = Category::where('is_active', true)
                ->orderBy('name')
                ->get();

            $selectedCategories = $design->categories->pluck('id')->toArray();

            $design->load(['images' => function ($query) {
                $query->orderBy('order', 'asc');
            }]);

            return view('admin.designs.edit', compact(
                'design',
                'categories',
                'selectedCategories'
            ));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de edición: ' . $e->getMessage());
            return redirect()
                ->route('admin.designs.edit', $design)
                ->with('icon', 'error')
                ->withInput()
                ->with('error', 'Error al cargar el formulario de edición: ' . $e->getMessage());
        }
    }

    public function update(UpdateDesignRequest $request, Design $design)
    {
        DB::beginTransaction();

        try {
            Log::info('=== INICIO ACTUALIZACIÓN DE DISEÑO ===');
            Log::info('ID del diseño: ' . $design->id);

            $updatedDesign = $this->designService->updateDesign($design, $request->validated());
            Log::info('Diseño actualizado correctamente');

            // Procesar archivo temporal si existe
            $tempImageData = Session::get('temp_image_data');
            if ($tempImageData && isset($tempImageData['temp_path'])) {
                $this->processTempImage($design, $tempImageData);
            } elseif ($request->hasFile('image')) {
                // ✅ Actualizar o agregar nuevo archivo si fue subido
                Log::info('Nuevo archivo recibido');

                $file = $request->file('image');
                $extension = strtolower($file->getClientOriginalExtension());

                // [ACTUALIZACIÓN]: Capturamos todos los datos del middleware
                $correctExtension = $request->input('_file_image_extension', $extension);
                $detectedType = $request->input('_file_image_type');
                $detectedFormat = $request->input('_file_image_format');

                // Determinar tipo de archivo
                $imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'svg', 'svgz'];
                $embroideryExtensions = ['pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv', 'csd', '10o', 'bro'];

                if (in_array($extension, $imageExtensions) || in_array($correctExtension, $imageExtensions) || $detectedType === 'image') {
                    // Para imágenes/vectores, usar el ImageService
                    $design->images()->update(['is_primary' => false]);

                    // [ACTUALIZACIÓN]: Se pasa forced_extension al service
                    $image = $this->imageService->uploadImage(
                        $file,
                        'App\Models\Design',
                        $design->id,
                        [
                            'design_name' => $design->name,
                            'alt_text' => $request->name,
                            'image_context' => 'design',
                            'is_primary' => true,
                            'order' => $design->images()->max('order') + 1,
                            'forced_extension' => $correctExtension // [ACTUALIZACIÓN]
                        ]
                    );

                    Log::info('Nueva imagen/vector guardado con ID: ' . $image->id);

                    // Actualizar información del archivo
                    $design->update([
                        'file_type' => in_array($correctExtension, ['svg', 'svgz']) ? 'vector' : 'image',
                        'file_extension' => $correctExtension,
                        'file_size' => $file->getSize(),
                        'original_filename' => $file->getClientOriginalName(),
                        'detected_format' => $detectedFormat, // [ACTUALIZACIÓN]
                    ]);
                } elseif (in_array($extension, $embroideryExtensions) || $detectedType === 'embroidery') {
                    // Para archivos de bordado
                    // Eliminar archivo anterior si existe
                    if ($design->embroidery_file_path && Storage::disk('public')->exists($design->embroidery_file_path)) {
                        Storage::disk('public')->delete($design->embroidery_file_path);
                    }

                    // Eliminar imágenes anteriores relacionadas
                    $design->images()->delete();

                    // Guardar nuevo archivo
                    $originalName = pathinfo($file->getClientOriginalName(), PATHINFO_FILENAME);
                    $finalExt = $correctExtension ?? $extension;
                    $fileName = Str::slug($originalName) . '_' . time() . '_' . Str::random(8) . '.' . $finalExt;
                    $path = $file->storeAs('designs/embroidery', $fileName, 'public');

                    // Crear registro en tabla images
                    Image::create([
                        'file_path' => $path,
                        'alt_text' => $request->name . ' (Archivo de bordado)',
                        'is_primary' => true,
                        'order' => 0,
                        'imageable_type' => 'App\Models\Design',
                        'imageable_id' => $design->id,
                    ]);

                    // Actualizar información del archivo
                    $design->update([
                        'file_type' => 'embroidery',
                        'file_extension' => $finalExt,
                        'file_size' => $file->getSize(),
                        'original_filename' => $file->getClientOriginalName(),
                        'embroidery_file_path' => $path,
                        'detected_format' => $detectedFormat, // [ACTUALIZACIÓN]
                    ]);

                    Log::info('Nuevo archivo de bordado guardado en: ' . $path);
                }
            }

            DB::commit();
            Log::info('=== FIN ACTUALIZACIÓN EXITOSA ===');

            // Limpiar datos temporales
            Session::forget('temp_image_data');

            // Si es una solicitud AJAX, responder con JSON
            if ($request->ajax() || $request->wantsJson()) {
                $successMessage = 'Diseño ' . mb_strtoupper($updatedDesign->name, 'UTF-8') . ' actualizado exitosamente';

                // Guardar mensaje en sesión para que aparezca el SweetAlert en el index
                Session::flash('success', $successMessage);

                return response()->json([
                    'success' => true,
                    'message' => $successMessage,
                    'redirect' => route('admin.designs.index'),
                    'design' => [
                        'id' => $updatedDesign->id,
                        'name' => $updatedDesign->name,
                    ]
                ]);
            }

            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Diseño ' . mb_strtoupper($updatedDesign->name, 'UTF-8') . ' actualizado exitosamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('=== ERROR AL ACTUALIZAR DISEÑO ===');
            Log::error('Mensaje: ' . $e->getMessage());
            Log::error('Stack trace: ' . $e->getTraceAsString());

            // Si hay un nuevo archivo subido, guardarlo temporalmente
            if ($request->hasFile('image')) {
                $file = $request->file('image');

                // Almacenar archivo temporalmente
                $tempFileName = 'temp_' . time() . '_' . Str::random(8) . '.' . $file->getClientOriginalExtension();
                $tempPath = $file->storeAs('temp', $tempFileName, 'public');

                // Guardar información del archivo en sesión
                Session::put('temp_image_data', [
                    'temp_path' => $tempPath,
                    'original_name' => $file->getClientOriginalName(),
                    'original_extension' => $file->getClientOriginalExtension(),
                    'detected_type' => $request->input('_file_image_type', 'image'),
                    'detected_format' => $request->input('_file_image_format'),
                    'correct_extension' => $request->input('_file_image_extension'),
                    'upload_note' => $request->input('_file_image_note'),
                    'file_size' => $file->getSize(),
                ]);
            }

            // Si es una solicitud AJAX, responder con JSON
            if ($request->ajax() || $request->wantsJson()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error al actualizar el diseño: ' . $e->getMessage(),
                    'errors' => []
                ], 500);
            }

            return redirect()
                ->route('admin.designs.edit', $design)
                ->with('icon', 'error')
                ->withInput()
                ->with('error', 'Error al actualizar el diseño: ' . $e->getMessage());
        }
    }

    public function destroy(Design $design)
    {
        DB::beginTransaction();

        try {
            Log::info('=== INICIO ELIMINACIÓN DE DISEÑO ===', [
                'design_id' => $design->id,
                'design_name' => $design->name
            ]);

            if ($design->deleted_at !== null) {
                Log::warning('Intento de eliminar un diseño ya eliminado', [
                    'design_id' => $design->id
                ]);
                return redirect()
                    ->route('admin.designs.index')
                    ->with('icon', 'warning')
                    ->with('success', 'El diseño ya había sido eliminado previamente.');
            }

            if ($design->variants()->exists()) {
                Log::info('El diseño tiene variantes, desactivándolas');
                $design->variants()->update([
                    'is_active' => false,
                    'deleted_at' => now(),
                ]);
            }

            $design->update(['is_active' => false]);
            $this->designService->deleteDesign($design);

            DB::commit();
            Log::info('=== DISEÑO ELIMINADO CORRECTAMENTE ===', [
                'design_id' => $design->id
            ]);

            return redirect()
                ->route('admin.designs.index')
                ->with('success', 'Diseño ' . mb_strtoupper($design->name, 'UTF-8') . ' eliminado exitosamente')
                ->with('icon', 'success');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('=== ERROR AL ELIMINAR DISEÑO ===', [
                'design_id' => $design->id,
                'error' => $e->getMessage(),
                'file' => $e->getFile(),
                'line' => $e->getLine(),
            ]);

            return redirect()
                ->route('admin.designs.index')
                ->with('icon', 'error')
                ->with('error', 'Error al eliminar el diseño: ' . $e->getMessage());
        }
    }

    public function clearTempImage(Request $request)
    {
        try {
            $tempImageData = Session::get('temp_image_data');

            if ($tempImageData && isset($tempImageData['temp_path'])) {
                if (Storage::disk('public')->exists($tempImageData['temp_path'])) {
                    Storage::disk('public')->delete($tempImageData['temp_path']);
                }
                Session::forget('temp_image_data');
            }

            return response()->json(['success' => true]);
        } catch (\Exception $e) {
            Log::error('Error al limpiar archivo temporal: ' . $e->getMessage());
            return response()->json(['success' => false, 'message' => $e->getMessage()], 500);
        }
    }

    private function processTempImage($design, $tempImageData)
    {
        try {
            if ($tempImageData && isset($tempImageData['temp_path'])) {
                $tempPath = $tempImageData['temp_path'];

                if (Storage::disk('public')->exists($tempPath)) {
                    $originalName = $tempImageData['original_name'];
                    $detectedType = $tempImageData['detected_type'];
                    $correctExtension = $tempImageData['correct_extension'] ?? $tempImageData['original_extension'];

                    if ($detectedType === 'image' || $detectedType === 'vector') {
                        // Mover archivo a ubicación permanente
                        $fileName = Str::slug(pathinfo($originalName, PATHINFO_FILENAME)) . '_' . time() . '_' . Str::random(8) . '.' . $correctExtension;
                        $newPath = 'designs/images/' . $fileName;

                        Storage::disk('public')->move($tempPath, $newPath);

                        // Crear registro de imagen
                        Image::create([
                            'file_path' => $newPath,
                            'alt_text' => $design->name,
                            'is_primary' => true,
                            'order' => 0,
                            'imageable_type' => 'App\Models\Design',
                            'imageable_id' => $design->id,
                        ]);

                        // Actualizar diseño
                        $design->update([
                            'file_type' => $detectedType,
                            'file_extension' => $correctExtension,
                            'original_filename' => $originalName,
                        ]);

                        Log::info('Archivo temporal procesado y guardado en: ' . $newPath);
                    }
                }
            }
        } catch (\Exception $e) {
            Log::error('Error al procesar imagen temporal: ' . $e->getMessage());
        }
    }
}
</file>

<file path="app/Http/Controllers/EstadoController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Estado;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class EstadoController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $estados = Estado::all()->where('activo', true);
        return view('admin.estados.index', compact('estados'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        return view('admin.estados.create');
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'nombre_estado' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
            ],
        ]);

        try {
            $nombre = strtoupper(trim($request->nombre_estado));

            // Buscar si ya existe (activo o inactivo)
            $existingEstado = Estado::where('nombre_estado', $nombre)->first();

            if ($existingEstado) {
                if ($existingEstado->activo) {
                    return back()->withErrors(['nombre_estado' => 'El nombre del estado ya ha sido registrado.'])->withInput();
                } else {
                    // Reactivar si existía pero estaba eliminado (soft delete lógico)
                    $existingEstado->activo = true;
                    $existingEstado->save();
                    return redirect()->route('admin.estados.index')->with('success', 'Estado reactivado exitosamente');
                }
            }

            $estado = new Estado();
            $estado->nombre_estado = $nombre;
            $estado->save();

            return redirect()->route('admin.estados.index')->with('success', 'Estado creado exitosamente');
        } catch (\Exception $e) {
            return redirect()->route('admin.estados.index')->with('error', 'Error al crear el estado');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Estado $estado)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $estado = Estado::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$estado) {
            return redirect()->route('admin.estados.index')->with('error', 'Estado no encontrado');
        }
        return view('admin.estados.edit', compact('estado'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_estado' => [
                'required',
                'string',
                'max:255',
                'regex:/^[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+$/',
                'unique:estados,nombre_estado,' . $id,
            ],
        ]);
        try {
            $estado = Estado::where('id', $id)
                ->where('activo', true)
                ->firstOrFail();
            $estado->nombre_estado = strtoupper(trim($request->nombre_estado));

            //validamos si hubo algun cambio o modificacion en el valor del campo nombre_estado, si no hubo cambios, no se actualiza
            if (! $estado->isDirty()) {
                // return back()->with('info', 'No se realizaron cambios');
                return redirect()->route('admin.estados.index')->with('info', 'No se realizaron cambios');
            }

            $estado->save();
            return redirect()->route('admin.estados.index')->with('success', 'Estado actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el estado: ' . $e->getMessage());
            return redirect()->route('admin.estados.index')->with('error', 'Error al actualizar el estado');
        }
    }

    /**
     * Remove the specified resource from storage.
     */
    public function confirm_delete($id)
    {
        //validando que existe el estado
        $estado = Estado::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$estado) {
            return redirect()->route('admin.estados.index')->with('error', 'Estado no encontrado');
        }
        return view('admin.estados.delete', compact('estado'));
    }

    public function destroy($id)
    {
        $estado = Estado::where('id', $id)
            ->where('activo', true)
            ->firstOrFail();
        if (!$estado) {
            return redirect()->route('admin.estados.confirm_delete', $id)->with('error', 'Estado no encontrado');
        }
        try {
            $estado->activo = false;
            $estado->save();
            return redirect()->route('admin.estados.index')->with('success', 'Estado eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el estado: ' . $e->getMessage());
            return redirect()->route('admin.estados.index')->with('error', 'Error al eliminar el estado');
        }
    }
}
</file>

<file path="app/Models/DesignExport.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class DesignExport extends Model
{
    use HasFactory;

    /**
     * Los atributos que son asignables en masa.
     *
     * @var array<int, string>
     */
    protected $fillable = [
        'design_id',
        'design_variant_id',
        'image_id',
        'application_type',
        'application_label',
        'placement_description',
        'file_name',
        'file_path',
        'file_format',
        'file_size',
        'mime_type',
        'stitches_count',
        'width_mm',
        'height_mm',
        'colors_count',
        'colors_detected',
        'status',
        'notes',
        'created_by',
        'approved_by',
        'approved_at',
        'auto_read_success',
        'svg_content',
    ];

    /**
     * Los atributos que deben ser convertidos a tipos nativos.
     *
     * @var array<string, string>
     */
    protected $casts = [
        'approved_at' => 'datetime',
        'stitches_count' => 'integer',
        'width_mm' => 'integer',
        'height_mm' => 'integer',
        'colors_count' => 'integer',
        'file_size' => 'integer',
        'auto_read_success' => 'boolean',
        'colors_detected' => 'array',
    ];

    /**
     * Los atributos que deben ser transformados a fechas.
     *
     * @var array<int, string>
     */
    protected $dates = [
        'approved_at',
        'created_at',
        'updated_at',
    ];

    /**
     * Relación con el diseño.
     */
    public function design()
    {
        return $this->belongsTo(Design::class);
    }

    /**
     * Relación con la variante (opcional).
     */
    public function variant()
    {
        return $this->belongsTo(DesignVariant::class, 'design_variant_id');
    }

    /**
     * Relación con la imagen específica (opcional).
     * Permite vincular una producción a una imagen específica de la galería.
     */
    public function image()
    {
        return $this->belongsTo(Image::class);
    }

    /**
     * Relación con el creador.
     */
    public function creator()
    {
        return $this->belongsTo(User::class, 'created_by');
    }

    /**
     * Relación con el aprobador (opcional).
     */
    public function approver()
    {
        return $this->belongsTo(User::class, 'approved_by');
    }

    /**
     * Relación con el historial de cambios de estado.
     */
    public function statusHistory()
    {
        return $this->hasMany(DesignExportStatusHistory::class, 'design_export_id')
            ->orderBy('created_at', 'desc');
    }

    /**
     * Accesor para las dimensiones formateadas.
     * IMPORTANTE: Este accesor ya existe, pero se verifica que funcione correctamente.
     * Formato esperado por el frontend: "100x150 mm"
     */
    public function getFormattedDimensionsAttribute()
    {
        if ($this->width_mm && $this->height_mm) {
            return "{$this->width_mm}×{$this->height_mm} mm";
        }
        return 'N/A';
    }

    /**
     * Accesor para el tamaño del archivo formateado.
     */
    public function getFormattedFileSizeAttribute()
    {
        if (!$this->file_size) return 'N/A';

        $units = ['B', 'KB', 'MB', 'GB'];
        $bytes = $this->file_size;
        $i = 0;

        while ($bytes >= 1024 && $i < count($units) - 1) {
            $bytes /= 1024;
            $i++;
        }

        return round($bytes, 2) . ' ' . $units[$i];
    }

    /**
     * Accesor para el estado traducido.
     */
    public function getTranslatedStatusAttribute()
    {
        $statuses = [
            'borrador' => 'Borrador',
            'pendiente' => 'Pendiente',
            'aprobado' => 'Aprobado',
            'archivado' => 'Archivado',
        ];

        return $statuses[$this->status] ?? $this->status;
    }

    /**
     * Accesor para la clase CSS del estado.
     */
    public function getStatusClassAttribute()
    {
        $classes = [
            'borrador' => 'secondary',
            'pendiente' => 'warning',
            'aprobado' => 'success',
            'archivado' => 'dark',
        ];

        return $classes[$this->status] ?? 'secondary';
    }

    /**
     * NUEVO ACCESOR: Obtiene las dimensiones en formato compatible con el frontend.
     * Este accesor asegura que el formato sea exactamente el que espera el JavaScript.
     * Formato: "100x150 mm" (sin el símbolo × especial, usando 'x' normal)
     */
    public function getDimensionsForFrontendAttribute()
    {
        if ($this->width_mm && $this->height_mm) {
            return $this->width_mm . 'x' . $this->height_mm . ' mm';
        }
        return 'N/A';
    }
    public function productVariants()
    {
        return $this->belongsToMany(ProductVariant::class, 'product_variant_design');
    }
}
</file>

<file path="app/Models/Estado.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Estado extends Model
{
    use HasFactory;
    protected $table = 'estados';
    //protected
    protected $fillable = [
        'nombre_estado',
        'activo',
        'fecha_baja',
        'motivo_baja',
    ];
    public function clientes()
    {
        return $this->hasMany(Cliente::class);
    }
    public function proveedores()
    {
        return $this->hasMany(Proveedor::class);
    }
}
</file>

<file path="app/Models/Image.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Storage;
use Intervention\Image\ImageManager;
use Intervention\Image\Drivers\Gd\Driver;

class Image extends Model
{
    // Configuración de thumbnails
    const THUMBNAIL_SMALL = 150;
    const THUMBNAIL_MEDIUM = 400;
    const WEBP_QUALITY = 85;

    protected $fillable = [
        'imageable_type',
        'imageable_id',
        'file_name',
        'file_path',
        'thumbnail_small',
        'thumbnail_medium',
        'is_optimized',
        'original_size',
        'file_size',
        'mime_type',
        'width',
        'height',
        'alt_text',
        'order',
        'is_primary',
        'dominant_color',
        'color_palette',
    ];

    protected $casts = [
        'file_size' => 'integer',
        'original_size' => 'integer',
        'width' => 'integer',
        'height' => 'integer',
        'order' => 'integer',
        'is_primary' => 'boolean',
        'is_optimized' => 'boolean'
    ];

    // Relación polimórfica inversa
    public function imageable()
    {
        return $this->morphTo();
    }

    /**
     * Relación con las producciones/exportaciones vinculadas a esta imagen.
     */
    public function exports()
    {
        return $this->hasMany(DesignExport::class);
    }

    /**
     * Contador de producciones para esta imagen.
     */
    public function getExportsCountAttribute()
    {
        return $this->exports()->count();
    }

    /**
     * Obtiene la URL del thumbnail pequeño (para listados).
     * Si no existe el thumbnail, usa la imagen original.
     * OPTIMIZADO: No genera thumbnails on-demand para mejor performance.
     */
    public function getThumbnailSmallUrlAttribute(): ?string
    {
        if (!$this->file_path) {
            return null;
        }

        // Si ya existe el thumbnail, usarlo
        if ($this->thumbnail_small && Storage::disk('public')->exists($this->thumbnail_small)) {
            return asset('storage/' . $this->thumbnail_small);
        }

        // PERFORMANCE OPTIMIZADO: Usar imagen original en lugar de generar thumbnail
        // El browser renderiza la imagen pequeña via CSS
        return asset('storage/' . $this->file_path);
    }

    /**
     * Obtiene la URL del thumbnail mediano (para galerías).
     * Si no existe el thumbnail, usa la imagen original.
     * OPTIMIZADO: No genera thumbnails on-demand para mejor performance.
     */
    public function getThumbnailMediumUrlAttribute(): ?string
    {
        if (!$this->file_path) {
            return null;
        }

        // Si ya existe el thumbnail, usarlo
        if ($this->thumbnail_medium && Storage::disk('public')->exists($this->thumbnail_medium)) {
            return asset('storage/' . $this->thumbnail_medium);
        }

        // PERFORMANCE OPTIMIZADO: Usar imagen original en lugar de generar thumbnail
        // El browser renderiza la imagen pequeña via CSS
        return asset('storage/' . $this->file_path);
    }

    /**
     * Genera thumbnail si no existe (LAZY LOADING).
     * Solo genera una vez, luego lo cachea en BD.
     */
    protected function generateThumbnailIfNeeded(string $size): ?string
    {
        try {
            $fullPath = Storage::disk('public')->path($this->file_path);

            // Verificar que el archivo original existe
            if (!file_exists($fullPath)) {
                return null;
            }

            // Verificar que es una imagen válida
            $imageInfo = @getimagesize($fullPath);
            if ($imageInfo === false) {
                return null;
            }

            $manager = new ImageManager(new Driver());
            $img = $manager->read($fullPath);

            $directory = dirname($this->file_path);
            $baseName = pathinfo($this->file_name ?? $this->file_path, PATHINFO_FILENAME);
            $timestamp = time();
            $storagePath = Storage::disk('public')->path($directory);

            // Asegurar que el directorio existe
            if (!is_dir($storagePath)) {
                @mkdir($storagePath, 0755, true);
            }

            if ($size === 'small') {
                $fileName = "{$baseName}_{$timestamp}_thumb_sm.webp";
                $thumbPath = "{$directory}/{$fileName}";
                $thumbImage = clone $img;
                $thumbImage->scaleDown(width: self::THUMBNAIL_SMALL);
                $thumbImage->toWebp(self::WEBP_QUALITY)->save("{$storagePath}/{$fileName}");

                // Guardar en BD para no regenerar
                $this->update(['thumbnail_small' => $thumbPath, 'is_optimized' => true]);
                return $thumbPath;
            }

            if ($size === 'medium') {
                $fileName = "{$baseName}_{$timestamp}_thumb_md.webp";
                $thumbPath = "{$directory}/{$fileName}";
                $thumbImage = clone $img;
                $thumbImage->scaleDown(width: self::THUMBNAIL_MEDIUM);
                $thumbImage->toWebp(self::WEBP_QUALITY)->save("{$storagePath}/{$fileName}");

                // Guardar en BD para no regenerar
                $this->update(['thumbnail_medium' => $thumbPath, 'is_optimized' => true]);
                return $thumbPath;
            }

            return null;
        } catch (\Exception $e) {
            // Si falla, simplemente usar imagen original
            return null;
        }
    }

    /**
     * Obtiene la URL de la imagen original (para descargas).
     */
    public function getOriginalUrlAttribute(): ?string
    {
        return $this->file_path ? asset('storage/' . $this->file_path) : null;
    }

    /**
     * Obtiene la mejor imagen disponible para visualización.
     * Prioridad: thumbnail_medium > thumbnail_small > original
     */
    public function getDisplayUrlAttribute(): ?string
    {
        // Usar los accessors que hacen lazy loading
        return $this->thumbnail_medium_url ?? $this->thumbnail_small_url ?? $this->original_url;
    }
}
</file>

<file path="app/Models/Proveedor.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Factories\HasFactory;

class Proveedor extends Model
{
    use HasFactory;
    protected $table = 'proveedors';
    //protected
    protected $fillable = [
        'nombre',
        'tipo_proveedor',
        'direccion',
        'codigo_postal',
        'telefono',
        'email',
        'ciudad',
        'persona_contacto',
        'telefono_contacto',
        'correo_contacto',
        'activo',
        'fecha_baja',
        'motivo_baja',
        'estado_id',
    ];

    public function estado()
    {
        return $this->belongsTo(Estado::class);
    }

    public function giro()
    {
        return $this->belongsTo(Giro::class);
    }
}
</file>

<file path="resources/views/admin/attributes/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Atributo')

@section('content_header')
@stop

@section('content')
    <br>

    <br>
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-danger">
            <div class="card-header">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> ELIMINAR ATRIBUTO</h3>
            </div>

            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="alert alert-danger">
                            <h5><i class="icon fas fa-exclamation-triangle"></i> ¡Atención!</h5>
                            <p>Está a punto de eliminar el siguiente atributo. Esta acción no se puede deshacer.</p>
                        </div>

                        <div class="card">
                            <div class="card-body">
                                <table class="table table-bordered">
                                    <tr>
                                        <th style="width: 30%;">Nombre:</th>
                                        <td><strong>{{ $attribute->name }}</strong></td>
                                    </tr>
                                    <tr>
                                        <th>Slug:</th>
                                        <td><code>{{ $attribute->slug }}</code></td>
                                    </tr>
                                    @if ($attribute->values->count() > 0)
                                        <tr class="table-warning">
                                            <th>Valores asociados:</th>
                                            <td class="text-danger font-weight-bold">
                                                <i class="fas fa-exclamation-circle"></i> {{ $attribute->values->count() }}
                                                elementos
                                            </td>
                                        </tr>
                                    @endif
                                </table>
                            </div>
                        </div>

                        <form id="deleteForm" method="POST"
                            action="{{ route('admin.attributes.destroy', $attribute->id) }}">
                            @csrf
                            @method('DELETE')

                            <div class="row mt-4">
                                <div class="col-12">
                                    <div class="d-flex justify-content-end align-items-center mt-4">
                                        <a href="{{ route('admin.attributes.index') }}" class="btn btn-secondary mr-2">
                                            <i class="fas fa-times-circle"></i> Cancelar
                                        </a>
                                        <button type="submit" class="btn btn-danger">
                                            <i class="fas fa-trash"></i> Confirmar Eliminación
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
@stop

@section('js')
    <script>
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: '¿Está seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminarlo',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/categorias/index.blade.php">
@extends('adminlte::page')

@section('title', 'CATEGORIAS')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary" bis_skin_checked="1">

        <div class="card-header" bis_skin_checked="1">

            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> CATEGORIAS</h3>
            <!-- /.card-tools -->
        </div>
        <!-- /.card-header -->
        <div class="card-body" bis_skin_checked="1">
            <div class="row">
                <a href="{{ route('admin.categories.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i></a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover table-condensed">
                        <thead class="thead-dark">
                            <tr style="text-align: center;">
                                <th>#</th>
                                <th>Nombre de la categoria</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach ($categories as $category)
                                <tr style="text-align: center;">
                                    <td>{{ $loop->iteration }}</td>
                                    <td>{{ mb_strtoupper($category->name, 'UTF-8') }}</td>
                                    <td style="text-align: center;">
                                        <a class="btn btn-warning"
                                            href="{{ route('admin.categories.edit', $category->id) }}"><i
                                                class="fas fa-edit"></i></a>
                                        <a class="btn btn-danger"
                                            href="{{ route('admin.categories.confirm_delete', $category->id) }}"><i
                                                class="fas fa-trash"></i></a>
                                    </td>
                                </tr>
                            @endforeach

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- /.card-body -->
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            /* Centrar los botones */
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Giros",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Giros",
                    "infoFiltered": "(Filtrado de _MAX_ total Giros)",
                    "lengthMenu": "Mostrar _MENU_ Giros",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/designs/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nuevo diseño')

@section('content_header')
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h1 class="text-2xl font-weight-semibold text-gray-800">
            Crear nuevo diseño
        </h1>
        <div class="flex gap-2">
            <a id="back-btn" href="{{ route('admin.designs.index') }}" class="btn btn-secondary btn-md px-3">
                <i class="fas fa-arrow-left"></i> Regresar
            </a>
            <button id="submit-btn" form="design-form" type="submit" class="btn btn-primary btn-md px-3">
                <i class="fas fa-save"></i> Guardar diseño
            </button>
        </div>
    </div>
@stop

@section('content')
    {{-- ============================================
     SPINNER PREMIUM CON BARRA DE PROGRESO
     ============================================ --}}
    <div class="modal-loading-overlay" id="loadingOverlay">
        <div class="modal-loading-content">
            <div class="modal-loading-spinner"></div>
            <h3 class="modal-loading-title" id="loadingTitle">Guardando diseño</h3>
            <p class="modal-loading-subtitle" id="loadingSubtitle">
                Procesando tu solicitud, por favor espera...
            </p>

            {{-- CONTENEDOR DE BARRA DE PROGRESO --}}
            <div class="progress-container-premium">
                <div class="progress-bar-premium" id="progressBar">
                    <div class="progress-fill-premium" id="progressFill"></div>
                </div>
                <div class="progress-text-container">
                    <span class="progress-text" id="progressText">0%</span>
                    <span class="progress-status" id="progressStatus">Iniciando...</span>
                </div>
            </div>
        </div>
    </div>

    <form id="design-form" action="{{ route('admin.designs.store') }}" method="POST" enctype="multipart/form-data">
        @csrf

        {{-- Campo oculto para mantener la información de la imagen temporal --}}
        @if (isset($tempImageData))
            <input type="hidden" id="tempImageInfo" value='@json($tempImageData)'>
        @endif

        <div class="row">

            {{-- COLUMNA IZQUIERDA: IMAGEN --}}
            <div class="col-lg-5">
                <div class="surface">

                    <h5 class="section-title mb-3">
                        <i class="fas fa-image text-primary"></i> Imagen del diseño
                    </h5>

                    <div class="alert alert-info alert-modern mb-3">
                        <i class="fas fa-info-circle"></i>
                        <span>Sube la imagen principal del diseño. Para variaciones de color o estilo, podrás crear
                            <strong>variantes</strong> después de guardar.</span>
                    </div>

                    <div id="dropzone" class="dropzone @error('image') border-danger @enderror">
                        <input type="file" id="imageInput" name="image" accept="image/*" hidden>

                        <div id="dropzoneContent" class="dropzone-content">
                            <div class="dropzone-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="dropzone-title">
                                Subir imagen
                            </div>
                            <div class="dropzone-sub">
                                Arrastra imagen aquí o haz clic
                            </div>
                            <div class="dropzone-formats">
                                Formatos: JPEG, PNG, SVG, AVIF, WebP
                            </div>
                        </div>

                        {{-- Contenedor para la vista previa DENTRO del dropzone --}}
                        <div id="previewContainer" class="preview-grid"></div>
                    </div>

                    {{-- Contenedor para la información del archivo (debajo del dropzone) --}}
                    <div id="fileInfoContainer"></div>
                    <div id="image-error" class="text-danger small mt-1" style="display: none;"></div>
                    @error('image')
                        <small class="text-danger d-block mt-2">{{ $message }}</small>
                    @enderror

                    {{-- Contenedor para la paleta de colores detectada (al final) --}}
                    <div id="palette-container" class="mt-3" style="display: none;">
                        <label class="label mb-2" style="font-size: 13px; color: #64748b;">Colores detectados en el
                            diseño</label>
                        <div id="palette-grid" class="d-flex flex-wrap gap-2 p-2"
                            style="background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                        </div>
                    </div>

                </div>
            </div>

            {{-- COLUMNA DERECHA: FORMULARIO --}}
            <div class="col-lg-7">
                <div class="surface">

                    <h5 class="section-title mb-4">
                        <i class="fas fa-info-circle text-primary"></i> Información básica
                    </h5>

                    {{-- Nombre --}}
                    <div class="mb-4">
                        <label class="label">
                            Nombre del diseño <span class="text-danger">*</span>
                        </label>
                        <input type="text" name="name" class="input @error('name') is-invalid @enderror"
                            value="{{ old('name') }}" placeholder="Ej. Mariposa floral minimalista" required>
                        <div id="name-error" class="text-danger small mt-1" style="display: none;"></div>
                        @error('name')
                            <small class="text-danger">{{ $message }}</small>
                        @enderror
                    </div>

                    {{-- Categorías --}}
                    <div class="mb-4">
                        <label class="label">
                            Categorías <span class="text-danger">*</span>
                        </label>
                        <select name="categories[]" id="categoriesSelect"
                            class="form-control @error('categories') is-invalid @enderror" required>
                            <option value=""></option>
                            @foreach ($categories as $category)
                                <option value="{{ $category->id }}"
                                    {{ in_array($category->id, old('categories', [])) ? 'selected' : '' }}>
                                    {{ $category->name }}
                                </option>
                            @endforeach
                        </select>
                        <div id="categories-error" class="text-danger small mt-1" style="display: none;"></div>
                        <small class="hint">
                            Selecciona una categoría
                        </small>
                        @error('categories')
                            <small class="text-danger d-block">{{ $message }}</small>
                        @enderror
                    </div>

                    {{-- Descripción --}}
                    <div>
                        <label class="label">Descripción</label>
                        <textarea name="description" rows="5" class="input @error('description') is-invalid @enderror"
                            placeholder="Describe el estilo, uso y enfoque del diseño…">{{ old('description') }}</textarea>
                        <div id="description-error" class="text-danger small mt-1" style="display: none;"></div>
                        @error('description')
                            <small class="text-danger">{{ $message }}</small>
                        @enderror
                    </div>

                </div>
            </div>

        </div>
    </form>
@stop

@section('css')
    <style>
        /* ============================================
                                           MATERIAL DESIGN / APPLE HIG - BASE STYLES
                                           ============================================ */
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --font-size-xs: 11px;
            --font-size-sm: 13px;
            --font-size-base: 15px;
            --font-size-lg: 17px;
            --font-size-xl: 20px;
        }

        .surface {
            background: #fff;
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-md);
        }

        .section-title {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: var(--font-size-base);
        }

        .label {
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 6px;
            display: block;
            font-size: var(--font-size-base);
        }

        .input {
            width: 100%;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            font-size: var(--font-size-base);
            background: var(--gray-50);
            transition: all 0.2s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .is-invalid {
            border-color: var(--danger) !important;
            background: #fef2f2;
        }

        .hint {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
        }

        /* ============================================
                                           ALERTA MODERNA
                                           ============================================ */
        .alert-modern {
            font-size: var(--font-size-sm);
            padding: 12px 16px;
            border-radius: var(--radius-md);
            border: none;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .alert-modern i {
            margin-top: 2px;
        }

        /* ============================================
                                           DROPZONE - DISEÑO MODERNO
                                           ============================================ */
        .dropzone {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: var(--gray-50);
        }

        .dropzone:hover {
            border-color: var(--primary);
            background-color: var(--gray-100);
        }

        .dropzone.border-danger {
            border-color: var(--danger);
            background: #fef2f2;
        }

        /* Cuando hay imagen, cambiar estilo del dropzone */
        .dropzone.has-preview {
            min-height: 80px;
            padding: 20px;
            border: 2px solid var(--primary);
            background: #eff6ff;
        }

        .dropzone.has-preview .dropzone-content {
            display: none;
        }

        .dropzone.has-preview::after {
            content: 'Archivo seleccionado ✓';
            font-size: var(--font-size-sm);
            color: var(--primary);
            font-weight: 500;
        }

        .dropzone-content {
            color: var(--gray-500);
            text-align: center;
        }

        .dropzone-icon {
            font-size: 42px;
            color: var(--gray-400);
            margin-bottom: 12px;
        }

        .dropzone-title {
            font-weight: 600;
            font-size: var(--font-size-lg);
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .dropzone-sub {
            font-size: var(--font-size-sm);
            color: var(--gray-500);
            margin-bottom: 8px;
        }

        .dropzone-formats {
            font-size: var(--font-size-xs);
            color: var(--gray-400);
            background: var(--gray-100);
            padding: 4px 12px;
            border-radius: 20px;
            display: inline-block;
        }

        .preview-grid {
            display: none;
            justify-content: center;
            width: 100%;
        }

        .preview-grid.active {
            display: flex;
        }

        .preview-item {
            width: 150px;
            height: 150px;
            background: var(--gray-800);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .preview-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .remove {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #dc2626;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .remove:hover {
            background: #fef2f2;
            transform: scale(1.1);
        }

        /* ============================================
                                           IMAGE ANALYSIS CARD - DISEÑO DESCRIPTIVO (foto 2)
                                           ============================================ */
        .image-analysis-card {
            background: #fff;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-top: 16px;
            transition: all 0.2s ease;
        }

        .image-analysis-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        /* Preview de imagen dentro de la card */
        .image-card-preview {
            position: relative;
            width: 100%;
            height: 200px;
            background: var(--gray-50);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid var(--primary);
            border-radius: var(--radius-md) var(--radius-md) 0 0;
        }

        .image-card-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* Botón de eliminar en preview */
        .image-card-remove {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: 2px solid white;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-md);
        }

        .image-card-remove:hover {
            background: #b91c1c;
            transform: scale(1.1);
        }

        /* Info del análisis */
        .image-card-info {
            padding: 16px;
            border-top: 1px solid var(--gray-100);
            background: var(--gray-50);
        }

        .image-card-name {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 12px;
        }

        .image-card-name i {
            color: var(--primary);
        }

        .image-card-name span {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-card-details {
            display: flex;
            justify-content: space-between;
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--gray-200);
        }

        .image-card-dimensions {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: var(--font-size-sm);
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .image-card-dimensions .dim-label {
            color: var(--gray-500);
            font-weight: 500;
        }

        .image-card-format {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: var(--font-size-sm);
            color: var(--success);
            font-weight: 500;
        }

        .image-card-format i {
            font-size: var(--font-size-xs);
        }

        /* Alerta de extensión diferente */
        .image-card-warning {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: var(--radius-sm);
            padding: 10px 12px;
            margin-top: 12px;
            font-size: var(--font-size-xs);
            color: #92400e;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .image-card-warning i {
            color: var(--warning);
            margin-top: 1px;
            flex-shrink: 0;
        }

        .image-card-warning div {
            line-height: 1.4;
        }

        /* Iconos para tipos de archivo */
        .file-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* Estilos específicos para vista previa de bordados */
        .embroidery-preview {
            background: linear-gradient(45deg, #1e40af, #3b82f6);
            color: white;
            text-align: center;
            padding: 20px;
        }

        /* Para SVGs con fondo blanco */
        .svg-preview {
            background: white;
            padding: 10px;
        }

        /* Animaciones */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* Estilos para botones deshabilitados */
        .disabled-btn {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ============================================
                                                                                                                                       ESTILOS DEL SPINNER PREMIUM (AGREGADOS)
                                                                                                                                       ============================================ */
        .modal-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .modal-loading-content {
            text-align: center;
            padding: 40px;
            max-width: 320px;
        }

        .modal-loading-spinner {
            width: 64px;
            height: 64px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top-color: #2563eb;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
            letter-spacing: 0.3px;
        }

        .modal-loading-subtitle {
            font-size: 0.95rem;
            color: #6b7280;
            line-height: 1.5;
        }

        /* ============================================
                                                                                                                                       BARRA DE PROGRESO PREMIUM
                                                                                                                                       ============================================ */
        .progress-container-premium {
            width: 100%;
            max-width: 320px;
            margin: 24px auto 0;
        }

        .progress-bar-premium {
            width: 100%;
            height: 8px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 12px;
        }

        .progress-fill-premium {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg,
                    #2563eb 0%,
                    #3b82f6 25%,
                    #60a5fa 50%,
                    #93c5fd 75%,
                    #bfdbfe 100%);
            border-radius: 10px;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.3);
        }

        /* Efecto de brillo animado */
        .progress-fill-premium::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.4) 50%,
                    transparent 100%);
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Texto de progreso */
        .progress-text-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .progress-text {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2563eb;
            text-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
            min-width: 60px;
        }

        .progress-status {
            font-size: 0.95rem;
            color: #6b7280;
            font-weight: 500;
            text-align: right;
            flex: 1;
            padding-left: 16px;
        }

        /* Estados de completado */
        .progress-complete .progress-fill-premium {
            background: linear-gradient(90deg,
                    #059669 0%,
                    #10b981 25%,
                    #34d399 50%,
                    #6ee7b7 75%,
                    #a7f3d0 100%);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .progress-complete .progress-text {
            color: #059669;
        }

        /* Estados de error */
        .progress-error .progress-fill-premium {
            background: linear-gradient(90deg,
                    #dc2626 0%,
                    #ef4444 25%,
                    #f87171 50%,
                    #fca5a5 75%,
                    #fecaca 100%);
            box-shadow: 0 0 20px rgba(220, 38, 38, 0.3);
        }

        .progress-error .progress-text {
            color: #dc2626;
        }

        /* ============================================
               SELECT2 PREMIUM STYLING (Match .input design)
               ============================================ */
        .select2-container--default .select2-selection--single {
            border: 1px solid var(--gray-200) !important;
            border-radius: var(--radius-md) !important;
            height: auto !important;
            padding: 10px 14px !important;
            background: var(--gray-50) !important;
            transition: all 0.2s ease !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: var(--gray-700) !important;
            line-height: 1.5 !important;
            padding: 0 !important;
            font-size: var(--font-size-base) !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 100% !important;
            top: 0 !important;
            right: 10px !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__placeholder {
            color: var(--gray-400) !important;
        }

        .select2-container--default.select2-container--focus .select2-selection--single,
        .select2-container--default.select2-container--open .select2-selection--single {
            border-color: var(--primary) !important;
            background: #fff !important;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
        }

        .select2-dropdown {
            border: 1px solid var(--gray-200) !important;
            border-radius: var(--radius-md) !important;
            box-shadow: var(--shadow-lg) !important;
            margin-top: 4px !important;
        }

        .select2-container--default .select2-search--dropdown .select2-search__field {
            border: 1px solid var(--gray-200) !important;
            border-radius: var(--radius-sm) !important;
            padding: 10px 12px !important;
            font-size: var(--font-size-base) !important;
        }

        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable {
            background: var(--primary) !important;
            color: white !important;
        }

        .select2-container--default .select2-results__option--selected {
            background: var(--gray-100) !important;
        }

        .select2-results__option {
            padding: 10px 14px !important;
            font-size: var(--font-size-base) !important;
        }
    </style>
@stop

@section('js')
    {{-- AGREGADO: Librería Color Thief para extraer paletas de colores --}}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    {{-- Select2 para categorías --}}
    <script>
        $(document).ready(function() {
            $('#categoriesSelect').select2({
                placeholder: 'Buscar y seleccionar categorías...',
                allowClear: true,
                width: '100%'
            });
        });
    </script>

    <script>
        // ============================================
        // VALIDADOR MEJORADO DE ARCHIVOS DE DISEÑO
        // ============================================
        class DesignFileValidator {
            constructor() {
                // Extensiones permitidas (como referencia)
                this.allowedExtensions = [
                    // Imágenes
                    'jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'tiff',
                    // Vectoriales
                    'svg', 'svgz',
                    // Bordados
                    'pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv', 'csd', '10o', 'bro'
                ];
                // Tamaños máximos por tipo (en bytes)
                this.maxSizes = {
                    'image': 10 * 1024 * 1024, // 10MB para imágenes
                    'vector': 5 * 1024 * 1024, // 5MB para SVG
                    'embroidery': 50 * 1024 * 1024 // 50MB para archivos de bordado
                };
            }

            /**
             * Obtiene los primeros bytes del archivo para analizar la firma
             */
            async getFileBytes(file, bytes = 64) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = (e) => {
                        try {
                            const arr = new Uint8Array(e.target.result);
                            resolve(arr);
                        } catch (error) {
                            resolve(new Uint8Array());
                        }
                    };
                    reader.onerror = () => resolve(new Uint8Array());
                    const slice = file.slice(0, bytes);
                    reader.readAsArrayBuffer(slice);
                });
            }

            /**
             * Detecta el tipo de archivo basado en su contenido (firma)
             */
            async detectFileTypeByContent(file) {
                const bytes = await this.getFileBytes(file, 64);
                if (bytes.length === 0) return null;

                // Convertir a hexadecimal para comparación
                let hexHeader = '';
                for (let i = 0; i < bytes.length; i++) {
                    hexHeader += bytes[i].toString(16).padStart(2, '0');
                }

                // Análisis de firmas mágicas (SINCRONIZADO CON BACKEND)
                const signatures = {
                    // JPEG - múltiples variantes
                    'jpeg': [
                        'ffd8ffe0', 'ffd8ffe1', 'ffd8ffe2', 'ffd8ffe3',
                        'ffd8ffe8', 'ffd8ffdb', 'ffd8ffee'
                    ],
                    // PNG - firma única
                    'png': ['89504e470d0a1a0a'],
                    // GIF - GIF87a y GIF89a
                    'gif': ['474946383761', '474946383961'],
                    // BMP
                    'bmp': ['424d'],
                    // WebP - RIFF (requiere validación adicional)
                    'webp': ['52494646'],
                    // TIFF - Little y Big endian
                    'tiff': ['49492a00', '4d4d002a'],
                    // SVG
                    'svg': ['3c737667', '3c3f786d6c', '3c21444f4354595045'],
                    // Bordado PES
                    'pes': ['23504553', '50455330', '43455031'],
                    // Bordado DST
                    'dst': ['4154414a494d41', '4c414a494d41'],
                    // Otros formatos de bordado
                    'exp': ['45787031', '45787032'],
                    'xxx': ['585858', '53494e474552'],
                    'jef': ['4a4546', '4a454631'],
                    'vp3': ['567033', '4856534d'],
                    'hus': ['4846475631', '4846475632'],
                    'pec': ['504543', '50454330', '43455031'],
                    'phc': ['504843', '43455031'],
                    'sew': ['534557', '53455730'],
                    'shv': ['534856', '53485630'],
                    'csd': ['436865727279'],
                    '10o': ['31306f'],
                    'bro': ['42524f']
                };

                // Verificar WebP específicamente (tiene más validación)
                if (hexHeader.startsWith('52494646')) {
                    const webpBytes = await this.getFileBytes(file, 16);
                    if (webpBytes.length >= 12) {
                        const webpCheck = String.fromCharCode(webpBytes[8], webpBytes[9], webpBytes[10], webpBytes[11]);
                        if (webpCheck === 'WEBP') {
                            return 'webp';
                        }
                    }
                }

                // Verificar AVIF específicamente (debe ser exacto en la posición correcta)
                if (hexHeader.startsWith('0000001') || hexHeader.startsWith('0000002')) {
                    const avifBytes = await this.getFileBytes(file, 12);
                    if (avifBytes.length >= 12) {
                        const ftypPos = String.fromCharCode(avifBytes[4], avifBytes[5], avifBytes[6], avifBytes[7]);
                        const brand = String.fromCharCode(avifBytes[8], avifBytes[9], avifBytes[10], avifBytes[11]);
                        if (ftypPos === 'ftyp' && (brand === 'avif' || brand === 'avis' || brand === 'mif1')) {
                            return 'avif';
                        }
                    }
                }

                // Verificar otros formatos
                for (const [type, sigs] of Object.entries(signatures)) {
                    for (const sig of sigs) {
                        if (hexHeader.startsWith(sig)) {
                            // Verificación adicional para SVG
                            if (type === 'svg') {
                                const isSvg = await this.validateSVGContent(file);
                                if (isSvg) return 'svg';
                            } else {
                                return type;
                            }
                        }
                    }
                }

                return null;
            }

            /**
             * Valida que el contenido sea un SVG válido
             */
            async validateSVGContent(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = (e) => {
                        try {
                            const content = e.target.result;
                            // Verificar que contenga elementos SVG
                            const hasSvgTag = content.includes('<svg') || content.includes('<SVG');
                            resolve(hasSvgTag);
                        } catch (error) {
                            resolve(false);
                        }
                    };
                    reader.onerror = () => resolve(false);
                    // Leer solo los primeros 2KB para verificar
                    reader.readAsText(file.slice(0, 2048));
                });
            }

            /**
             * Determina la categoría del archivo (imagen, vector, bordado)
             */
            getFileCategory(fileType) {
                const imageTypes = ['jpeg', 'png', 'gif', 'bmp', 'webp', 'avif', 'tiff'];
                const vectorTypes = ['svg'];
                const embroideryTypes = ['pes', 'dst', 'exp', 'xxx', 'jef', 'vp3', 'hus', 'pec', 'phc', 'sew', 'shv',
                    'csd', '10o', 'bro'
                ];

                if (imageTypes.includes(fileType)) return 'image';
                if (vectorTypes.includes(fileType)) return 'vector';
                if (embroideryTypes.includes(fileType)) return 'embroidery';

                return 'unknown';
            }

            /**
             * Valida el archivo completo
             */
            async validateDesignFile(file) {
                // 1. Validar extensión (solo como referencia inicial)
                const fileName = file.name.toLowerCase();
                const fileExtension = fileName.split('.').pop();

                // 2. Detectar tipo real por contenido
                const detectedType = await this.detectFileTypeByContent(file);
                if (!detectedType) {
                    // Si no se pudo detectar por contenido, verificar extensión
                    if (this.allowedExtensions.includes(fileExtension)) {
                        return {
                            valid: true,
                            type: this.getFileCategory(fileExtension),
                            subtype: fileExtension,
                            detectedBy: 'extension',
                            reason: `Archivo aceptado por extensión (.${fileExtension})`
                        };
                    }
                    return {
                        valid: false,
                        reason: 'Formato de archivo no reconocido. Asegúrate de subir una imagen, SVG o archivo de bordado válido.'
                    };
                }

                // 3. Determinar categoría basada en tipo detectado
                const category = this.getFileCategory(detectedType);

                // 4. Validar tamaño según categoría
                const sizeValidation = this.validateFileSize(file, category);
                if (!sizeValidation.valid) {
                    return sizeValidation;
                }

                // 5. Para imágenes, validar dimensiones mínimas
                if (category === 'image' && detectedType !== 'svg') {
                    const dimensionValidation = await this.validateImageDimensions(file, detectedType);
                    if (!dimensionValidation.valid) {
                        return dimensionValidation;
                    }
                }

                // 6. Verificar si la extensión coincide con el tipo detectado
                let reason = '';
                if (detectedType !== fileExtension) {
                    reason =
                        `Formato detectado: ${detectedType.toUpperCase()} (archivo con extensión .${fileExtension})`;
                } else {
                    reason = `Archivo ${detectedType.toUpperCase()} válido`;
                }

                return {
                    valid: true,
                    type: category,
                    subtype: detectedType,
                    detectedBy: 'signature',
                    reason: reason,
                    actualExtension: fileExtension
                };
            }

            /**
             * Valida tamaño según la categoría del archivo
             */
            validateFileSize(file, category) {
                const maxSize = this.maxSizes[category] || 10 * 1024 * 1024;

                if (file.size > maxSize) {
                    const sizeMB = (maxSize / (1024 * 1024)).toFixed(1);
                    let fileTypeName = '';
                    switch (category) {
                        case 'image':
                            fileTypeName = 'imágenes';
                            break;
                        case 'vector':
                            fileTypeName = 'SVG';
                            break;
                        case 'embroidery':
                            fileTypeName = 'archivos de bordado';
                            break;
                        default:
                            fileTypeName = 'archivos';
                    }
                    return {
                        valid: false,
                        reason: `El archivo es demasiado grande. Máximo ${sizeMB}MB para ${fileTypeName}.`
                    };
                }
                return {
                    valid: true,
                    reason: 'Tamaño válido'
                };
            }

            /**
             * Valida dimensiones de imágenes (excepto SVG y algunos formatos especiales)
             */
            async validateImageDimensions(file, detectedType) {
                // Para SVG, AVIF y algunos formatos, no validamos dimensiones
                if (detectedType === 'svg' || detectedType === 'avif' || detectedType === 'webp') {
                    return {
                        valid: true,
                        reason: `${detectedType.toUpperCase()} (dimensiones no verificables en este navegador)`
                    };
                }

                return new Promise((resolve) => {
                    const img = new Image();
                    const url = URL.createObjectURL(file);

                    img.onload = () => {
                        URL.revokeObjectURL(url);
                        const minWidth = 100,
                            minHeight = 100;
                        const maxWidth = 10000,
                            maxHeight = 10000;

                        if (img.width < minWidth || img.height < minHeight) {
                            resolve({
                                valid: false,
                                reason: `Imagen demasiado pequeña (${img.width}x${img.height} píxeles). Mínimo ${minWidth}x${minHeight} píxeles.`
                            });
                        } else if (img.width > maxWidth || img.height > maxHeight) {
                            resolve({
                                valid: false,
                                reason: `Imagen demasiado grande (${img.width}x${img.height} píxeles). Máximo ${maxWidth}x${maxHeight} píxeles.`
                            });
                        } else {
                            resolve({
                                valid: true,
                                width: img.width,
                                height: img.height,
                                reason: `Dimensiones: ${img.width}x${img.height} píxeles`
                            });
                        }
                    };

                    img.onerror = () => {
                        URL.revokeObjectURL(url);
                        // Si falla la carga, puede ser un formato que el navegador no soporta
                        // pero que ya validamos por firma, así que lo aceptamos
                        resolve({
                            valid: true,
                            reason: 'Imagen válida (no se pudieron verificar dimensiones)'
                        });
                    };

                    img.src = url;
                });
            }

            /**
             * Obtiene un icono apropiado para el tipo de archivo
             */
            getFileIcon(fileType) {
                const icons = {
                    'image': 'image',
                    'vector': 'vector-square',
                    'embroidery': 'vest',
                    'jpeg': 'file-image',
                    'png': 'file-image',
                    'gif': 'file-image',
                    'bmp': 'file-image',
                    'webp': 'file-image',
                    'avif': 'file-image',
                    'svg': 'vector-square',
                    'pes': 'vest',
                    'dst': 'vest',
                    'default': 'file'
                };

                return icons[fileType] || icons['default'];
            }
        }

        // ============================================
        // CÓDIGO PRINCIPAL DE LA VISTA
        // ============================================

        const form = document.getElementById('design-form');
        const dropzone = document.getElementById('dropzone');
        const dropzoneContent = document.getElementById('dropzoneContent');
        const input = document.getElementById('imageInput');
        const preview = document.getElementById('previewContainer');
        const fileInfoContainer = document.getElementById('fileInfoContainer');
        const submitBtn = document.getElementById('submit-btn');
        const backBtn = document.getElementById('back-btn');
        const tempImageInfo = document.getElementById('tempImageInfo');

        let isSubmitting = false;
        let currentObjectURL = null;

        const fileValidator = new DesignFileValidator();

        // AGREGADO: Función para extraer y mostrar colores
        function extractColors(imgElement) {
            try {
                const colorThief = new ColorThief();
                const palette = colorThief.getPalette(imgElement, 20);
                const paletteGrid = document.getElementById('palette-grid');
                const paletteContainer = document.getElementById('palette-container');

                paletteGrid.innerHTML = '';
                paletteContainer.style.display = 'block';

                palette.forEach(rgb => {
                    const hex = '#' + rgb.map(x => x.toString(16).padStart(2, '0')).join('');
                    paletteGrid.insertAdjacentHTML('beforeend', `
                        <div class="d-flex align-items-center bg-white px-2 py-1 rounded shadow-sm border" style="font-size:11px; font-weight:700;">
                            <div style="width:16px; height:16px; background:${hex}; border-radius:4px; margin-right:8px; border:1px solid #ddd;"></div>
                            <span>${hex.toUpperCase()}</span>
                        </div>
                    `);
                });
            } catch (e) {
                console.error("No se pudo extraer la paleta de colores", e);
            }
        }

        // Función para deshabilitar todos los botones y preparar spinner
        function disableAllButtons() {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            submitBtn.classList.add('disabled-btn');

            backBtn.disabled = true;
            backBtn.innerHTML = '<i class="fas fa-lock me-2"></i>Bloqueado';
            backBtn.classList.add('disabled-btn');
            backBtn.style.pointerEvents = 'none';

            // Preparar spinner de carga
            showLoadingState();
        }

        // Función para habilitar todos los botones
        function enableAllButtons() {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Guardar diseño';
            submitBtn.classList.remove('disabled-btn');

            backBtn.disabled = false;
            backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Regresar';
            backBtn.classList.remove('disabled-btn');
            backBtn.style.pointerEvents = 'auto';
        }

        // Función para limpiar todo el contenido anterior
        function clearPreviousContent() {
            preview.innerHTML = '';
            fileInfoContainer.innerHTML = '';
            document.getElementById('palette-container').style.display = 'none';

            if (currentObjectURL) {
                URL.revokeObjectURL(currentObjectURL);
                currentObjectURL = null;
            }

            dropzone.classList.remove('border-danger');
            dropzone.classList.remove('has-preview');

            // Mostrar contenido original del dropzone
            dropzone.style.display = 'flex'; // RESTAURAR DROPZONE
            dropzoneContent.style.display = 'block';
            preview.classList.remove('active');

            // Eliminar todos los mensajes de error
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());
        }

        // Función para mostrar la vista previa dentro del dropzone
        function showPreviewInDropzone() {
            dropzoneContent.style.display = 'none';
            preview.classList.add('active');
            dropzone.classList.add('has-preview');
        }

        /**
         * Obtiene las dimensiones de una imagen
         */
        function getImageDimensions(file) {
            return new Promise((resolve) => {
                if (!file.type.startsWith('image/')) {
                    resolve({
                        width: null,
                        height: null
                    });
                    return;
                }

                const img = new Image();
                const url = URL.createObjectURL(file);

                img.onload = () => {
                    URL.revokeObjectURL(url);
                    resolve({
                        width: img.naturalWidth,
                        height: img.naturalHeight
                    });
                };

                img.onerror = () => {
                    URL.revokeObjectURL(url);
                    resolve({
                        width: null,
                        height: null
                    });
                };

                img.src = url;
            });
        }

        /**
         * Formatea el tamaño de archivo de forma legible
         */
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // Función para mostrar información del archivo (diseño descriptivo como foto 2)
        async function showFileInfo(file, validationResult, isTempFile = false) {
            // Obtener dimensiones de la imagen
            const dimensions = await getImageDimensions(file);

            const fileSize = formatFileSize(file.size);
            const fileExt = file.name.split('.').pop().toLowerCase();
            const detectedFormat = validationResult.subtype || fileExt;

            // Determinar tipo de archivo
            let fileTypeName = 'Imagen';
            if (validationResult.type === 'vector') fileTypeName = 'Vector';
            else if (validationResult.type === 'embroidery') fileTypeName = 'Bordado';

            // Construir HTML de dimensiones
            let dimensionsHTML = '';
            if (dimensions.width && dimensions.height) {
                dimensionsHTML = `
                    <div class="image-card-dimensions">
                        <span class="dim-label">Dimensiones:</span>
                        ${dimensions.width} × ${dimensions.height} px
                    </div>
                `;
            }

            // Alerta de extensión diferente al tipo real detectado (diseño como foto 2)
            let warningHTML = '';
            if (validationResult.detectedBy === 'signature' &&
                validationResult.subtype &&
                validationResult.actualExtension &&
                validationResult.subtype.toLowerCase() !== validationResult.actualExtension.toLowerCase()) {
                warningHTML = `
                    <div class="image-card-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <div>
                            <strong>Nota:</strong> El archivo tiene extensión .${validationResult.actualExtension} pero es un formato ${validationResult.subtype.toUpperCase()}. Se guardará con la extensión correcta (.${validationResult.subtype}).
                        </div>
                    </div>
                `;
            }

            // Crear la URL de la imagen para preview
            const previewURL = URL.createObjectURL(file);

            const fileInfoHTML = `
                <div class="image-analysis-card fade-in">
                    <div class="image-card-preview">
                        <img src="${previewURL}" alt="${file.name}">
                        <button type="button" class="image-card-remove" onclick="removeFile(${isTempFile})" title="Eliminar imagen">×</button>
                    </div>
                    <div class="image-card-info">
                        <div class="image-card-name">
                            <i class="fas fa-file-image"></i>
                            <span title="${file.name}">${file.name}</span>
                        </div>
                        <div class="image-card-details">
                            <span>${fileTypeName} (${detectedFormat.toUpperCase()})</span>
                            <span>Tamaño: ${fileSize}</span>
                        </div>
                        ${dimensionsHTML}
                        <div class="image-card-format">
                            <i class="fas fa-check-circle"></i>
                            Formato detectado: ${detectedFormat.toUpperCase()} (archivo con extensión .${fileExt})
                        </div>
                        ${warningHTML}
                    </div>
                </div>
            `;

            // OCULTAR DROPZONE Y MOSTRAR CARD
            dropzone.style.display = 'none';
            fileInfoContainer.innerHTML = fileInfoHTML;
        }

        // Función auxiliar para crear el botón de eliminar con stopPropagation
        function createRemoveButton(isTempFile) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove';
            removeBtn.innerHTML = '×';
            removeBtn.title = 'Eliminar imagen';

            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                e.preventDefault();
                removeFile(isTempFile);
            });

            return removeBtn;
        }

        // Función para crear vista previa
        function createPreview(file, validationResult, isTempFile = false) {
            const div = document.createElement('div');
            div.className = 'preview-item';

            if (validationResult.type === 'embroidery') {
                // Icono para archivos de bordado
                div.innerHTML = `
                    <div class="embroidery-preview">
                        <i class="fas fa-vest" style="font-size: 48px; margin-bottom: 10px;"></i>
                        <div style="font-size: 14px;">${validationResult.subtype.toUpperCase()}</div>
                        <div style="font-size: 12px; opacity: 0.8;">${file.name}</div>
                    </div>
                `;
                div.appendChild(createRemoveButton(isTempFile));
            } else if (validationResult.type === 'vector') {
                // Vista previa para SVG
                currentObjectURL = URL.createObjectURL(file);
                div.innerHTML = `<img src="${currentObjectURL}" alt="Vista previa SVG">`;
                div.classList.add('svg-preview');
                div.appendChild(createRemoveButton(isTempFile));
            } else {
                // Intentar crear vista previa para imágenes
                currentObjectURL = URL.createObjectURL(file);
                const img = document.createElement('img');
                img.src = currentObjectURL;
                img.alt = "Vista previa";

                img.onload = () => {
                    // MODIFICADO: Extraer colores si es una imagen real cargada
                    extractColors(img);
                };

                img.onerror = () => {
                    // Si falla la carga (ej: AVIF en navegadores antiguos)
                    div.innerHTML = `
                        <div style="text-align: center; color: white; padding: 20px;">
                            <i class="fas fa-file-image" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <div style="font-size: 14px;">${validationResult.subtype.toUpperCase()}</div>
                            <div style="font-size: 12px; opacity: 0.8;">Vista previa no disponible</div>
                        </div>
                    `;
                    div.appendChild(createRemoveButton(isTempFile));
                };

                div.appendChild(img);
                div.appendChild(createRemoveButton(isTempFile));
            }

            preview.appendChild(div);

            // Mostrar vista previa dentro del dropzone
            showPreviewInDropzone();
        }

        // Función para remover el archivo
        function removeFile(isTempFile = false) {
            clearPreviousContent();
            input.value = '';
            submitBtn.disabled = false;

            // Si es un archivo temporal, eliminar la cookie/sesión
            if (isTempFile) {
                // Enviar solicitud para limpiar el archivo temporal
                fetch('{{ route('admin.designs.clear-temp-image') }}', {
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': '{{ csrf_token() }}',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        clear: true
                    })
                });
            }
        }

        // Función para mostrar error en un campo específico
        function showFieldError(field, message) {
            field.classList.add('is-invalid');

            // Buscar si ya existe un mensaje de error para este campo
            let errorElement = field.parentElement.querySelector('.field-error');
            if (!errorElement) {
                errorElement = document.createElement('small');
                errorElement.className = 'text-danger d-block mt-1 field-error';
                field.parentElement.appendChild(errorElement);
            }
            errorElement.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${message}`;
        }

        // Función para limpiar todos los errores de validación
        function clearValidationErrors() {
            // Limpiar errores de campos (clases is-invalid)
            form.querySelectorAll('.is-invalid').forEach(field => {
                field.classList.remove('is-invalid');
            });

            // Limpiar errores dinámicos (.field-error)
            form.querySelectorAll('.field-error').forEach(error => {
                error.remove();
            });

            // Limpiar errores de los divs con ID (name-error, categories-error, etc.)
            document.querySelectorAll('[id$="-error"]').forEach(el => {
                el.style.display = 'none';
                el.innerHTML = '';
            });

            // Limpiar errores del dropzone
            dropzone.classList.remove('border-danger');
            const imageErrors = document.querySelectorAll('.image-error');
            imageErrors.forEach(error => error.remove());
        }

        // Función para mostrar error en el dropzone
        function showImageError(message) {
            // Eliminar errores anteriores de imagen
            const existingErrors = document.querySelectorAll('.image-error');
            existingErrors.forEach(error => error.remove());

            dropzone.classList.add('border-danger');

            const error = document.createElement('small');
            error.className = 'text-danger d-block mt-2 image-error';
            error.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${message}`;

            // Insertar después del dropzone
            dropzone.parentElement.insertBefore(error, dropzone.nextSibling);
        }

        // Función para mostrar errores de validación del servidor en los campos
        // Usa los divs con IDs predefinidos (igual que edit.blade.php)
        function showServerValidationErrors(errors) {
            // Limpiar errores anteriores de los divs con ID
            document.querySelectorAll('[id$="-error"]').forEach(el => {
                el.style.display = 'none';
                el.innerHTML = '';
            });

            // Remover clases de error de los inputs
            document.querySelectorAll('.input.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });

            // Limpiar errores del dropzone
            dropzone.classList.remove('border-danger');
            const imageErrors = document.querySelectorAll('.image-error');
            imageErrors.forEach(error => error.remove());

            let firstErrorField = null;

            // Mostrar nuevos errores
            Object.keys(errors).forEach(fieldName => {
                const errorMessages = errors[fieldName];
                const errorMessage = Array.isArray(errorMessages) ? errorMessages[0] : errorMessages;

                // Manejar el campo de imagen de manera especial
                if (fieldName === 'image') {
                    const imageErrorDiv = document.getElementById('image-error');
                    if (imageErrorDiv) {
                        imageErrorDiv.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${errorMessage}`;
                        imageErrorDiv.style.display = 'block';
                    }
                    dropzone.classList.add('border-danger');
                    if (!firstErrorField) {
                        firstErrorField = dropzone;
                    }
                    return;
                }

                // Para campos normales, buscar el div de error por ID
                const errorElement = document.getElementById(fieldName + '-error');
                if (errorElement) {
                    errorElement.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i>${errorMessage}`;
                    errorElement.style.display = 'block';

                    // Agregar clase de error al input correspondiente
                    let inputSelector = `[name="${fieldName}"]`;
                    if (fieldName === 'categories') {
                        inputSelector = '[name="categories[]"]';
                    }
                    const inputElement = form.querySelector(inputSelector);
                    if (inputElement) {
                        inputElement.classList.add('is-invalid');
                        if (!firstErrorField) {
                            firstErrorField = inputElement;
                        }
                    }
                }
            });

            // Hacer focus en el primer campo con error
            if (firstErrorField) {
                firstErrorField.scrollIntoView({
                    behavior: 'smooth',
                    block: 'center'
                });

                setTimeout(() => {
                    if (firstErrorField.focus && typeof firstErrorField.focus === 'function') {
                        firstErrorField.focus();
                    }
                }, 300);
            }
        }

        // Manejadores de eventos para el dropzone
        dropzone.addEventListener('click', () => {
            if (!preview.classList.contains('active')) {
                input.click();
            }
        });

        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!preview.classList.contains('active')) {
                dropzone.style.borderColor = '#2563eb';
                dropzone.style.backgroundColor = '#f0f9ff';
            }
        });

        dropzone.addEventListener('dragleave', () => {
            if (!preview.classList.contains('active')) {
                dropzone.style.borderColor = '#d1d5db';
                dropzone.style.backgroundColor = 'transparent';
            }
        });

        dropzone.addEventListener('drop', async (e) => {
            e.preventDefault();

            if (preview.classList.contains('active')) return;

            dropzone.style.borderColor = '#d1d5db';
            dropzone.style.backgroundColor = 'transparent';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];

                // Validar archivo usando el validador mejorado
                const validationResult = await fileValidator.validateDesignFile(file);

                if (validationResult.valid) {
                    clearPreviousContent();
                    createPreview(file, validationResult);
                    showFileInfo(file, validationResult);

                    // Actualizar el input file para que se envíe en el formulario
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                } else {
                    showImageError(validationResult.reason);
                }
            }
        });

        input.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const file = e.target.files[0];

                // Limpiar error del dropzone si existía
                dropzone.classList.remove('border-danger');
                const imageErrors = document.querySelectorAll('.image-error');
                imageErrors.forEach(error => error.remove());

                // Limpiar también el div con ID de error de imagen
                const imageErrorDiv = document.getElementById('image-error');
                if (imageErrorDiv) {
                    imageErrorDiv.style.display = 'none';
                    imageErrorDiv.innerHTML = '';
                }

                // Validar archivo usando el validador mejorado
                const validationResult = await fileValidator.validateDesignFile(file);

                if (validationResult.valid) {
                    clearPreviousContent();
                    createPreview(file, validationResult);
                    showFileInfo(file, validationResult);
                } else {
                    showImageError(validationResult.reason);
                    input.value = '';
                }
            }
        });

        // Cargar imagen temporal si existe
        if (tempImageInfo) {
            loadTempImage(tempImageInfo.value);
        }

        function loadTempImage(tempInfo) {
            try {
                const info = JSON.parse(tempInfo);

                // Crear un objeto File simulado
                const file = {
                    name: info.original_name,
                    size: info.file_size,
                    type: 'application/octet-stream' // Tipo genérico
                };

                const validationResult = {
                    valid: true,
                    type: info.detected_type,
                    subtype: info.detected_format || info.original_extension,
                    detectedBy: 'signature',
                    reason: 'Archivo temporal cargado desde sesión',
                    actualExtension: info.original_extension
                };

                // Crear vista previa especial para archivos temporales
                const div = document.createElement('div');
                div.className = 'preview-item';

                if (info.detected_type === 'embroidery') {
                    div.innerHTML = `
                        <div class="embroidery-preview">
                            <i class="fas fa-vest" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <div style="font-size: 14px;">${(info.detected_format || info.original_extension).toUpperCase()}</div>
                            <div style="font-size: 12px; opacity: 0.8;">${info.original_name}</div>
                        </div>
                        <button type="button" class="remove" onclick="removeFile(true)">×</button>
                    `;
                } else if (info.detected_type === 'vector') {
                    div.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: white;">
                            <i class="fas fa-vector-square" style="font-size: 48px; margin-bottom: 10px;"></i>
                            <div style="font-size: 14px;">SVG</div>
                            <div style="font-size: 12px; opacity: 0.8;">${info.original_name}</div>
                        </div>
                        <button type="button" class="remove" onclick="removeFile(true)">×</button>
                    `;
                } else {
                    // Para imágenes temporales usamos la ruta guardada en el servidor
                    const img = document.createElement('img');
                    img.src = info.temp_url;
                    img.alt = "Vista previa temporal";

                    img.onload = () => extractColors(img); // Extraer colores de imagen temporal

                    div.appendChild(img);
                    div.appendChild(createRemoveButton(true));
                }

                preview.appendChild(div);
                showPreviewInDropzone();
                showFileInfo(file, validationResult, true);

            } catch (e) {
                console.error("Error al cargar imagen temporal:", e);
            }
        }

        // ============================================
        // EVENTOS PARA LIMPIAR ERRORES AL INTERACTUAR
        // ============================================

        // Limpiar error del nombre cuando se escribe
        form.querySelector('input[name="name"]').addEventListener('input', function() {
            this.classList.remove('is-invalid');
            // Limpiar error dinámico
            const errorMsg = this.parentElement.querySelector('.field-error');
            if (errorMsg) errorMsg.remove();
            // Limpiar div con ID
            const nameError = document.getElementById('name-error');
            if (nameError) {
                nameError.style.display = 'none';
                nameError.innerHTML = '';
            }
        });

        // Limpiar error de categorías cuando se selecciona
        form.querySelector('select[name="categories[]"]').addEventListener('change', function() {
            this.classList.remove('is-invalid');
            // Limpiar error dinámico
            const errorMsg = this.parentElement.querySelector('.field-error');
            if (errorMsg) errorMsg.remove();
            // Limpiar div con ID
            const categoriesError = document.getElementById('categories-error');
            if (categoriesError) {
                categoriesError.style.display = 'none';
                categoriesError.innerHTML = '';
            }
        });

        // Limpiar error de descripción cuando se escribe
        form.querySelector('textarea[name="description"]').addEventListener('input', function() {
            this.classList.remove('is-invalid');
            const descriptionError = document.getElementById('description-error');
            if (descriptionError) {
                descriptionError.style.display = 'none';
                descriptionError.innerHTML = '';
            }
        });

        // ============================================
        // LÓGICA DEL SPINNER Y ENVÍO DEL FORMULARIO CON AJAX
        // ============================================

        let isFormSubmitting = false;

        function showLoadingState() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'flex';
        }

        function hideLoadingState() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.style.display = 'none';

            // Resetear barra de progreso
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            const status = document.getElementById('progressStatus');
            const progressBar = document.getElementById('progressBar');

            fill.style.width = '0%';
            text.innerText = '0%';
            status.innerText = 'Iniciando...';
            progressBar.classList.remove('progress-complete', 'progress-error');

            document.getElementById('loadingTitle').textContent = 'Guardando diseño';
            document.getElementById('loadingSubtitle').textContent = 'Procesando tu solicitud, por favor espera...';
        }

        /**
         * Actualiza la barra de progreso
         */
        function updateProgress(progress, statusText) {
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            const status = document.getElementById('progressStatus');

            fill.style.width = progress + '%';
            text.innerText = Math.round(progress) + '%';
            status.innerText = statusText;
        }

        /**
         * Muestra estado de error en la barra de progreso
         */
        function showProgressError(message) {
            const progressBar = document.getElementById('progressBar');
            progressBar.classList.add('progress-error');

            document.getElementById('loadingTitle').textContent = '¡Error!';
            document.getElementById('loadingSubtitle').textContent = message;

            // Ocultar después de un tiempo
            setTimeout(() => {
                hideLoadingState();
                enableAllButtons();
                isFormSubmitting = false;
                isSubmitting = false;
            }, 3000);
        }

        /**
         * Envía el formulario via AJAX con progreso REAL de subida
         */
        function submitFormWithRealProgress(formData) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();

                // Evento de progreso de subida (PROGRESO REAL)
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);

                        // Mensajes según el progreso
                        let statusMessage = 'Subiendo imagen...';
                        if (percentComplete < 30) {
                            statusMessage = 'Subiendo imagen...';
                        } else if (percentComplete < 60) {
                            statusMessage = 'Procesando archivo...';
                        } else if (percentComplete < 90) {
                            statusMessage = 'Optimizando imagen...';
                        } else {
                            statusMessage = 'Finalizando subida...';
                        }

                        updateProgress(percentComplete, statusMessage);
                    }
                });

                // Evento cuando la subida se completa (espera respuesta del servidor)
                xhr.upload.addEventListener('load', function() {
                    updateProgress(100, 'Guardando en servidor...');
                });

                // Evento cuando llega la respuesta del servidor
                xhr.addEventListener('load', function() {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.success) {
                                resolve(response);
                            } else {
                                reject({
                                    type: 'validation',
                                    errors: response.errors || {},
                                    message: response.message || 'Error de validación'
                                });
                            }
                        } catch (e) {
                            // Si no es JSON, asumir éxito
                            resolve({
                                success: true,
                                redirect: true
                            });
                        }
                    } else if (xhr.status === 422) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            reject({
                                type: 'validation',
                                errors: response.errors || {},
                                message: 'Error de validación'
                            });
                        } catch (e) {
                            reject({
                                type: 'server',
                                message: 'Error de validación del servidor'
                            });
                        }
                    } else {
                        reject({
                            type: 'server',
                            message: `Error del servidor: ${xhr.status}`
                        });
                    }
                });

                // Evento de error de red
                xhr.addEventListener('error', function() {
                    reject({
                        type: 'network',
                        message: 'Error de conexión. Verifica tu internet.'
                    });
                });

                // Evento de timeout
                xhr.addEventListener('timeout', function() {
                    reject({
                        type: 'timeout',
                        message: 'La solicitud tardó demasiado. Intenta de nuevo.'
                    });
                });

                // Configurar y enviar
                xhr.open('POST', form.action);
                xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                xhr.setRequestHeader('Accept', 'application/json');
                xhr.timeout = 120000; // 2 minutos de timeout

                xhr.send(formData);
            });
        }

        // ============================================
        // MANEJO DEL FORMULARIO CON AJAX Y PROGRESO REAL
        // ============================================
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            if (isSubmitting) {
                return;
            }

            // Limpiar errores previos
            clearValidationErrors();

            // Validaciones básicas antes de enviar
            const nameInput = form.querySelector('input[name="name"]');
            const categoriesSelect = form.querySelector('select[name="categories[]"]');
            const name = nameInput.value.trim();
            const categories = categoriesSelect.selectedOptions;
            const hasImage = input.files.length > 0 || tempImageInfo;

            let hasErrors = false;

            // Validar nombre
            if (!name) {
                showFieldError(nameInput, 'El nombre del diseño es obligatorio.');
                hasErrors = true;
            }

            // Validar categorías
            if (categories.length === 0) {
                showFieldError(categoriesSelect, 'Debes seleccionar al menos una categoría.');
                hasErrors = true;
            }

            // Validar imagen
            if (!hasImage) {
                showImageError('Debes subir un archivo para el diseño.');
                hasErrors = true;
            }

            // Si hay errores, hacer focus en el primer campo con error
            if (hasErrors) {
                const firstError = form.querySelector('.is-invalid, .border-danger');
                if (firstError) {
                    firstError.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    if (firstError.focus) firstError.focus();
                }
                return;
            }

            isSubmitting = true;
            isFormSubmitting = true;

            // 1. Deshabilitar botones y mostrar spinner
            disableAllButtons();
            showLoadingState();
            updateProgress(0, 'Preparando subida...');

            // 2. Preparar datos del formulario
            const formData = new FormData(form);

            try {
                // 3. Enviar con progreso REAL
                const response = await submitFormWithRealProgress(formData);

                // 4. Éxito - mostrar completado y redirigir rápido
                updateProgress(100, '¡Completado!');
                document.getElementById('loadingTitle').textContent = '¡Diseño Creado!';
                document.getElementById('loadingSubtitle').textContent = 'Redirigiendo...';

                const progressBar = document.getElementById('progressBar');
                if (progressBar) {
                    progressBar.classList.add('progress-complete');
                }

                // Desactivar protección de navegación
                isFormSubmitting = false;
                isSubmitting = false;

                // Redirigir rápido (500ms)
                setTimeout(() => {
                    window.location.href = response.redirect || '{{ route('admin.designs.index') }}';
                }, 500);

            } catch (error) {
                console.error('Error en submit:', error);

                // Ocultar spinner
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;

                if (error.type === 'validation') {
                    // Mostrar errores de validación
                    showServerValidationErrors(error.errors);

                    Swal.fire({
                        icon: 'error',
                        title: 'Error de validación',
                        text: 'Por favor corrige los errores marcados en el formulario.',
                        confirmButtonColor: '#2563eb'
                    });
                } else {
                    // Error de red o servidor
                    Swal.fire({
                        icon: 'error',
                        title: '¡Error!',
                        text: error.message || 'Ocurrió un error al guardar el diseño.',
                        confirmButtonColor: '#2563eb'
                    });
                }
            }
        });

        // Interceptar clicks en el botón de regreso para confirmar si se está subiendo
        backBtn.addEventListener('click', function(e) {
            if (isSubmitting) {
                e.preventDefault();

                Swal.fire({
                    title: '¿Cancelar operación?',
                    text: 'El diseño se está guardando. ¿Estás seguro de que quieres cancelar?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#2563eb',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Sí, cancelar',
                    cancelButtonText: 'Continuar guardando'
                }).then((result) => {
                    if (result.isConfirmed) {
                        isSubmitting = false;
                        isFormSubmitting = false;
                        enableAllButtons();
                        hideLoadingState();
                        window.location.href = this.href;
                    }
                });
            }
        });

        // Prevenir cierre accidental de pestaña si se está subiendo
        window.addEventListener('beforeunload', function(e) {
            if (isFormSubmitting) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Prevenir navegación por historial si se está subiendo
        window.addEventListener('popstate', function(e) {
            if (isSubmitting) {
                history.pushState(null, null, window.location.href);
                Swal.fire({
                    title: 'Guardado en progreso',
                    text: 'No puedes abandonar la página mientras se guarda el diseño.',
                    icon: 'warning',
                    confirmButtonColor: '#2563eb'
                });
            }
        });

        // Restaurar estado si hay error de validación del servidor
        window.addEventListener('pageshow', function(event) {
            if (event.persisted) {
                hideLoadingState();
                enableAllButtons();
                isSubmitting = false;
                isFormSubmitting = false;
            }
        });
    </script>

    {{-- SweetAlert para mensajes del sistema --}}
    @if (session('success'))
        <script>
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: "{{ session('success') }}",
                timer: 4000,
                showConfirmButton: false
            });
        </script>
    @endif

    @if (session('error'))
        <script>
            Swal.fire({
                icon: 'error',
                title: '¡Error!',
                text: "{{ session('error') }}",
                showConfirmButton: true,
                confirmButtonColor: '#dc2626'
            });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    @endif
@stop
</file>

<file path="resources/views/admin/estados/create.blade.php">
@extends('adminlte::page')

@section('title', 'ESTADO')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-primary " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVO ESTADO</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.estados.store') }}">
                    @csrf
                    @method('POST')
                    <div class="col-md-12">
                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Estado
                            </h5>
                        </div>
                        <div class="form-group">
                            <label for="nombre_estado">Nombre <span style="color: red;">*</span></label>
                            <input type="text" class="form-control form-control-sm" id="nombre_estado"
                                name="nombre_estado" placeholder="Ej: MEXICO" required pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+"
                                title="Solo se permiten letras y espacios"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')">
                        </div>

                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-end align-items-center mt-4">
                            <a href="{{ route('admin.estados.index') }}" class="btn btn-secondary mr-2"
                                style="padding: 8px 20px;">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary" style="padding: 8px 20px;">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/estados/delete.blade.php">
@extends('adminlte::page')

@section('title', 'ESTADO')

@section('content_header')
@stop

@section('content')
    <br>
    <br>
    <div class="col-12 col-md-6 col-lg-4">
        <div class="card card-danger " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> ELIMINAR ESTADO</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form id="deleteForm" method="post" action="{{ route('admin.estados.destroy', $estado->id) }}">
                    @csrf
                    @method('DELETE')
                    <div class="col-md-12">


                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Estado
                            </h5>
                        </div>
                        <div class="form-group">


                            <label for="nombre_estado ">

                                Nombre <span style="color: red;">*</span>
                            </label>
                            <input type="text" class="form-control form-control-sm" id="nombre_estado"
                                name="nombre_estado" placeholder="Ej: MEXICO" pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+"
                                title="Solo se permiten letras y espacios" value="{{ $estado->nombre_estado }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" disabled>
                        </div>
                        <div style="font-weight: bold;font-size: 25px;text-align: center;">¿Deseas eliminar el
                            estado?</div>
                        <!-- Botones de acción -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="text-right">
                                    <a href="{{ route('admin.estados.index') }}" class="btn btn-secondary"
                                        style="margin-right: 10px; padding: 8px 20px;">
                                        <i class="fas fa-times-circle"></i> Regresar
                                    </a>
                                    <button type="submit" class="btn btn-danger" style="padding: 8px 20px;">
                                        <i class="fas fa-save"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: '¿Está seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminarlo',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/estados/index.blade.php">
@extends('adminlte::page')

@section('title', 'ESTADOS')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary" bis_skin_checked="1">

        <div class="card-header" bis_skin_checked="1">

            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> ESTADOS</h3>
            <!-- /.card-tools -->
        </div>
        <!-- /.card-header -->
        <div class="card-body" bis_skin_checked="1">
            <div class="row">
                <a href="{{ route('admin.estados.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i></a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover table-condensed">
                        <thead class="thead-dark">
                            <tr style="text-align: center;">
                                <th>#</th>
                                <th>Nombre estado</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach ($estados as $estado)
                                <tr style="text-align: center;">
                                    <td>{{ $loop->iteration }}</td>
                                    <td>{{ $estado->nombre_estado }}</td>
                                    <td style="text-align: center;">
                                        <a class="btn btn-warning" href="{{ route('admin.estados.edit', $estado->id) }}"><i
                                                class="fas fa-edit"></i></a>
                                        <a class="btn btn-danger"
                                            href="{{ route('admin.estados.confirm_delete', $estado->id) }}"><i
                                                class="fas fa-trash"></i></a>
                                    </td>
                                </tr>
                            @endforeach

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- /.card-body -->
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            /* Centrar los botones */
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Estados",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Estados",
                    "infoFiltered": "(Filtrado de _MAX_ total Estados)",
                    "lengthMenu": "Mostrar _MENU_ Estados",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/giros/edit.blade.php">
@extends('adminlte::page')

@section('title', 'EDITAR GIRO')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="col-12 col-md-6 col-lg-4">

        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        <div class="card card-warning " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                    EDITAR GIRO
                </h3>
            </div>

            <div class="card-body" bis_skin_checked="1">
                <form method="post" action="{{ route('admin.giros.update', $giro->id) }}">
                    @csrf
                    @method('PUT')

                    <div class="col-md-12">

                        <div style="border-bottom: 3px solid #ffc107; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #856404; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Giro
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>
                                Nombre <span style="color: red;">*</span>
                            </label>

                            <input type="text"
                                class="form-control form-control-sm @error('nombre_giro') is-invalid @enderror"
                                id="nombre_giro" name="nombre_giro" placeholder="Ej: MEXICO"
                                pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+" title="Solo se permiten letras y espacios"
                                value="{{ $giro->nombre_giro }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" required>

                            @error('nombre_giro')
                                <div class="invalid-feedback">
                                    {{ $message }}
                                </div>
                            @enderror
                        </div>

                        <div class="d-flex justify-content-end align-items-center mt-4">
                            <a href="{{ route('admin.giros.index') }}" class="btn btn-secondary mr-2">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>

                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Actualizar
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
@stop


@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/produccion/show_modal_especificaciones.blade.php">
{{-- Nombre del diseño para trazabilidad --}}
<div class="d-flex align-items-center mt-2 col-12 justify-content-center">
    <br>
    <br>
    <br>
    <i class="fas fa-palette text-muted mr-1" style="font-size: 1rem;"></i>
    <span class="text-muted" style="font-size: 1.5rem; font-weight: 500;">
        Diseño: <strong style="color: #374151;">{{ $export->design->name ?? 'Sin diseño' }}</strong>
        @if ($export->variant)
            <span class="mx-1">›</span> {{ $export->variant->name }}
        @endif
    </span>
</div>

<div class="modal-header border-0 pb-0 pt-4" style="background: #fff;">

    <div class="d-flex align-items-center w-50 justify-content-between">
        <div class="d-flex align-items-center">
            <div class="icon-box bg-primary-light rounded-lg mr-3 d-flex align-items-center justify-content-center"
                style="width: 50px; height: 50px; background: #eff6ff; color: #3b82f6; border-radius: 14px;">
                <i class="fas fa-file-code" style="font-size: 1.5rem;"></i>
            </div>
            <div>
                <h3 class="modal-title font-weight-bold mb-0"
                    style="font-size: 1.2rem; color: #111827; line-height: 1.2;">{{ $export->file_name }}</h3>
                <div class="d-flex align-items-center mt-1">
                    <span class="badge badge-pill border mr-2"
                        style="background: #f3f4f6; color: #374151; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; border-color: #e5e7eb; padding: 4px 10px;">{{ strtolower($export->file_format ?? 'PES') }}</span>
                    <span class="text-muted"
                        style="font-size: 1rem; font-weight: 500;">{{ $export->formatted_file_size }}</span>
                </div>

            </div>
        </div>
        <button type="button" class="modal-close-premium" data-dismiss="modal" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<div class="modal-body pt-4 pb-3">
    <!-- Status Badge (Readable) -->
    <div class="mb-4">
        @php
            $statusStyles = [
                'borrador' => [
                    'bg' => '#f3f4f6',
                    'text' => '#4b5563',
                    'icon' => 'fa-pencil-alt',
                    'label' => 'Borrador',
                ],
                'pendiente' => ['bg' => '#fef3c7', 'text' => '#d97706', 'icon' => 'fa-clock', 'label' => 'Revisión'],
                'aprobado' => [
                    'bg' => '#d1fae5',
                    'text' => '#059669',
                    'icon' => 'fa-check-circle',
                    'label' => 'Aprobado',
                ],
                'archivado' => ['bg' => '#e5e7eb', 'text' => '#374151', 'icon' => 'fa-archive', 'label' => 'Archivado'],
            ];
            $currentStatus = $statusStyles[$export->status] ?? $statusStyles['borrador'];
        @endphp
        <span class="badge rounded-pill px-4 py-2 d-inline-flex align-items-center"
            style="background-color: {{ $currentStatus['bg'] }}; color: {{ $currentStatus['text'] }}; font-weight: 700; font-size: 0.8rem; border-radius: 50rem; border: 1px solid rgba(0,0,0,0.05);">
            <i class="fas {{ $currentStatus['icon'] }} mr-2" style="font-size: 0.85rem;"></i>
            {{ $currentStatus['label'] }}
        </span>
    </div>

    <!-- Technical Details Section -->
    <div class="detail-tech-section mb-4">
        <h6 class="section-title-sm"
            style="font-weight: 700; color: #374151; font-size: 12px; text-transform: uppercase; margin-bottom: 12px;">
            Datos Técnicos</h6>
        <div class="tech-grid-detail" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
            <div class="tech-item-detail"
                style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 12px;">
                <i class="fas fa-hashtag" style="color: #3b82f6; font-size: 18px;"></i>
                <div>
                    <span class="tech-value-lg"
                        style="display: block; font-size: 24px; font-weight: 800; color: #111827; line-height: 1;">{{ number_format($export->stitches_count) }}</span>
                    <span class="tech-label-sm" style="font-size: 12px; color: #6b7280;">Puntadas</span>
                </div>
            </div>
            <div class="tech-item-detail"
                style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 12px;">
                <i class="fas fa-palette" style="color: #3b82f6; font-size: 18px;"></i>
                <div>
                    <span class="tech-value-lg"
                        style="display: block; font-size: 24px; font-weight: 800; color: #111827; line-height: 1;">{{ $export->colors_count ?? 1 }}</span>
                    <span class="tech-label-sm" style="font-size: 12px; color: #6b7280;">Colores</span>
                </div>
            </div>
            <div class="tech-item-detail"
                style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 12px;">
                <i class="fas fa-arrows-alt-h" style="color: #3b82f6; font-size: 18px;"></i>
                <div>
                    <span class="tech-value-lg"
                        style="display: block; font-size: 24px; font-weight: 800; color: #111827; line-height: 1;">{{ $export->width_mm ?? 0 }}</span>
                    <span class="tech-label-sm" style="font-size: 12px; color: #6b7280;">Ancho mm</span>
                </div>
            </div>
            <div class="tech-item-detail"
                style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 12px;">
                <i class="fas fa-arrows-alt-v" style="color: #3b82f6; font-size: 18px;"></i>
                <div>
                    <span class="tech-value-lg"
                        style="display: block; font-size: 24px; font-weight: 800; color: #111827; line-height: 1;">{{ $export->height_mm ?? 0 }}</span>
                    <span class="tech-label-sm" style="font-size: 12px; color: #6b7280;">Alto mm</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Colors Section -->
    <div class="detail-colors-section mb-4">
        <h6 class="section-title-sm"
            style="font-weight: 700; color: #374151; font-size: 12px; text-transform: uppercase; margin-bottom: 12px;">
            Colores Detectados</h6>
        <div class="color-grid-lg" style="display: flex; flex-wrap: wrap; gap: 8px;">
            @php
                $colorsToShow = [];
                $colorSource = 'none';

                // 1. Intentar obtener de colors_detected del export
                $detectedColors = $export->colors_detected;

                // FIX: Manejar caso de doble codificación (string JSON guardado como string)
                if (is_string($detectedColors)) {
                    $decoded = json_decode($detectedColors, true);
                    if (is_array($decoded)) {
                        $detectedColors = $decoded;
                    }
                }

                if ($detectedColors && is_array($detectedColors) && count($detectedColors) > 0) {
                    // Formato 1: array de objetos con 'hex' => [['hex' => '#FF0000'], ...]
                    if (isset($detectedColors[0]) && is_array($detectedColors[0]) && isset($detectedColors[0]['hex'])) {
                        $colorsToShow = $detectedColors;
                        $colorSource = 'export';
                    }
                    // Formato 2: array simple de strings hex => ['#FF0000', '#00FF00', ...]
                    elseif (isset($detectedColors[0]) && is_string($detectedColors[0])) {
                        $colorsToShow = array_map(fn($hex) => ['hex' => $hex], $detectedColors);
                        $colorSource = 'export';
                    }
                    // Formato 3: array asociativo con nombres => ['Rojo' => '#FF0000', ...]
                    elseif (!isset($detectedColors[0])) {
                        $colorsToShow = array_map(
                            fn($hex, $name) => ['hex' => $hex, 'name' => $name],
                            $detectedColors,
                            array_keys($detectedColors),
                        );
                        $colorSource = 'export';
                    }
                }

                // 2. Fallback a image.color_palette
                if (empty($colorsToShow) && $export->image && $export->image->color_palette) {
                    $palette = is_string($export->image->color_palette)
                        ? json_decode($export->image->color_palette, true)
                        : $export->image->color_palette;
                    if (is_array($palette) && count($palette) > 0) {
                        $colorsToShow = array_map(fn($hex) => ['hex' => $hex], $palette);
                        $colorSource = 'image';
                    }
                }

                // 3. Fallback a image.dominant_color
                if (empty($colorsToShow) && $export->image && $export->image->dominant_color) {
                    $colorsToShow = [['hex' => $export->image->dominant_color]];
                    $colorSource = 'dominant';
                }
            @endphp

            @if (count($colorsToShow) > 0)
                @if ($colorSource !== 'export')
                    <div class="w-100 mb-2">
                        <small class="text-muted">
                            <i class="fas fa-info-circle mr-1"></i>
                            Colores obtenidos de la imagen
                        </small>
                    </div>
                @endif
                @foreach ($colorsToShow as $color)
                    <div class="color-swatch"
                        style="display: flex; flex-direction: column; align-items: center; gap: 6px; width: 80px; margin-bottom: 8px;">
                        <div class="color-swatch-box shadow-sm mb-1"
                            style="width: 48px; height: 48px; border-radius: 12px; background-color: {{ $color['hex'] ?? '#000' }}; border: 2px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: help; transition: transform 0.2s;"
                            title="{{ $color['name'] ?? '' }} ({{ $color['hex'] ?? '' }})"
                            onmouseover="this.style.transform='scale(1.1)'"
                            onmouseout="this.style.transform='scale(1)'">
                        </div>
                        <span
                            class="color-swatch-label text-dark font-weight-bold bg-white px-2 py-1 rounded shadow-sm border"
                            style="font-size: 0.85rem; font-family: monospace; letter-spacing: 0.5px;">{{ $color['hex'] ?? '#000000' }}</span>
                    </div>
                @endforeach
            @else
                <div class="alert alert-light border-0 w-100 py-2 px-3 mb-0"
                    style="background: #f9fafb; color: #6b7280; font-size: 0.9rem; font-weight: 500; border-radius: 12px;">
                    <i class="fas fa-info-circle mr-2 opacity-50"></i> No se detectaron colores detallados.
                </div>
            @endif
        </div>
    </div>


    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
        }

        .workflow-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            width: 100%;
            background: white;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* Punto Base (Gris en la imagen) */
        .workflow-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #cbd5e1;
            /* Color gris de la imagen */
            margin-bottom: 12px;
            transition: all 0.3s ease;
            z-index: 2;
        }

        /* Texto Base */
        .workflow-step span {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Línea Base */
        .workflow-line {
            height: 2px;
            background: #e2e8f0;
            width: 100px;
            margin-top: -26px;
            /* Alineación con el centro de los círculos */
            z-index: 1;
        }

        /* ESTADO ACTIVO (Clonando el estilo azul de la imagen) */
        .workflow-step.active .workflow-dot {
            background: #fff;
            border: 4px solid #3b82f6;
            /* Azul brillante */
            box-shadow: 0 0 0 4px #dbeafe;
            /* El halo azul claro exterior */
            width: 12px;
            height: 12px;
        }

        .workflow-step.active span {
            color: #2563eb;
        }

        /* Línea Activa (Opcional: puedes dejarla gris o azul si ya pasó el estado) */
        .workflow-line.active {
            background: #cbd5e1;
        }

        /* Ajustes de botones existentes para no romper el resto del código */
        .btn-download {

            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .btn-download {
            background-color: #f3f4f6;
            color: #262c34;
        }

        .btn-download:hover {
            background-color: #262c34;
            color: #fff;
        }

        @media (max-width: 768px) {
            .workflow-line {
                width: 40px;
            }

            .workflow-indicator {
                transform: scale(0.9);
            }
        }
    </style>
    {{-- EL SCRIPT PROBLEMÁTICO SE ELIMINA - EL BOTÓN AHORA TIENE LA URL DIRECTA EN HREF --}}
</div>
</file>

<file path="resources/views/admin/produccion/show_modal.blade.php">
{{-- Nombre del diseño para trazabilidad --}}
<div class="d-flex align-items-center mt-2 col-12 justify-content-center">
    <br><br><br>
    <i class="fas fa-palette text-muted mr-1" style="font-size: 1rem;"></i>
    <span class="text-muted" style="font-size: 1.5rem; font-weight: 500;">
        Diseño: <strong style="color: #374151;">{{ $export->design->name ?? 'Sin diseño' }}</strong>
        @if ($export->variant)
            <span class="mx-1">›</span> {{ $export->variant->name }}
        @endif
    </span>
</div>

<div class="modal-header border-0 pb-0 pt-4" style="background: #fff;">
    <div class="d-flex align-items-center w-50 justify-content-between">
        <div class="d-flex align-items-center">
            <div class="icon-box bg-primary-light rounded-lg mr-3 d-flex align-items-center justify-content-center"
                style="width: 50px; height: 50px; background: #eff6ff; color: #3b82f6; border-radius: 14px;">
                <i class="fas fa-file-code" style="font-size: 1.5rem;"></i>
            </div>
            <div>
                <h3 class="modal-title font-weight-bold mb-0"
                    style="font-size: 1.2rem; color: #111827; line-height: 1.2;">{{ $export->file_name }}</h3>
                <div class="d-flex align-items-center mt-1">
                    <span class="badge badge-pill border mr-2"
                        style="background: #f3f4f6; color: #374151; font-weight: 700; font-size: 0.85rem; text-transform: uppercase; border-color: #e5e7eb; padding: 4px 10px;">{{ strtolower($export->file_format ?? 'PES') }}</span>
                    <span class="text-muted"
                        style="font-size: 1rem; font-weight: 500;">{{ $export->formatted_file_size }}</span>
                </div>

            </div>
        </div>
        <button type="button" class="modal-close-premium" data-dismiss="modal" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<div class="modal-body pt-4 pb-3">
    <div class="mb-4">
        @php
            $statusStyles = [
                'borrador' => [
                    'bg' => '#f3f4f6',
                    'text' => '#4b5563',
                    'icon' => 'fa-pencil-alt',
                    'label' => 'Borrador',
                ],
                'pendiente' => ['bg' => '#fef3c7', 'text' => '#d97706', 'icon' => 'fa-clock', 'label' => 'Revisión'],
                'aprobado' => [
                    'bg' => '#d1fae5',
                    'text' => '#059669',
                    'icon' => 'fa-check-circle',
                    'label' => 'Aprobado',
                ],
                'archivado' => ['bg' => '#e5e7eb', 'text' => '#374151', 'icon' => 'fa-archive', 'label' => 'Archivado'],
            ];
            $currentStatus = $statusStyles[$export->status] ?? $statusStyles['borrador'];
        @endphp
        <span class="badge rounded-pill px-4 py-2 d-inline-flex align-items-center"
            style="background-color: {{ $currentStatus['bg'] }}; color: {{ $currentStatus['text'] }}; font-weight: 700; font-size: 0.8rem; border-radius: 50rem; border: 1px solid rgba(0,0,0,0.05);">
            <i class="fas {{ $currentStatus['icon'] }} mr-2" style="font-size: 0.85rem;"></i>
            {{ $currentStatus['label'] }}
        </span>
    </div>

    <ul class="nav nav-tabs border-0 mb-4" id="exportDetailTabs" role="tablist" style="gap: 20px;">
        <li class="nav-item" role="presentation">
            <a class="nav-link active p-0 pb-2 border-0 position-relative custom-tab" id="tech-tab" data-toggle="tab"
                href="#tech-content" role="tab" aria-controls="tech-content" aria-selected="true">
                Datos Técnicos
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link p-0 pb-2 border-0 position-relative custom-tab" id="history-tab" data-toggle="tab"
                href="#history-content" role="tab" aria-controls="history-content" aria-selected="false">
                Historial
            </a>
        </li>
    </ul>

    <div class="tab-content" id="exportDetailTabsContent">
        <div class="tab-pane fade show active" id="tech-content" role="tabpanel" aria-labelledby="tech-tab">
            <div class="detail-tech-section mb-4">
                <div class="tech-grid-detail" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div class="tech-item-detail"
                        style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 12px;">
                        <i class="fas fa-hashtag" style="color: #3b82f6; font-size: 18px;"></i>
                        <div>
                            <span class="tech-value-lg"
                                style="display: block; font-size: 24px; font-weight: 800; color: #111827; line-height: 1;">{{ number_format($export->stitches_count) }}</span>
                            <span class="tech-label-sm" style="font-size: 12px; color: #6b7280;">Puntadas</span>
                        </div>
                    </div>
                    <div class="tech-item-detail"
                        style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 12px;">
                        <i class="fas fa-palette" style="color: #3b82f6; font-size: 18px;"></i>
                        <div>
                            <span class="tech-value-lg"
                                style="display: block; font-size: 24px; font-weight: 800; color: #111827; line-height: 1;">{{ $export->colors_count ?? 1 }}</span>
                            <span class="tech-label-sm" style="font-size: 12px; color: #6b7280;">Colores</span>
                        </div>
                    </div>
                    <div class="tech-item-detail"
                        style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 12px;">
                        <i class="fas fa-arrows-alt-h" style="color: #3b82f6; font-size: 18px;"></i>
                        <div>
                            <span class="tech-value-lg"
                                style="display: block; font-size: 24px; font-weight: 800; color: #111827; line-height: 1;">{{ $export->width_mm ?? 0 }}</span>
                            <span class="tech-label-sm" style="font-size: 12px; color: #6b7280;">Ancho mm</span>
                        </div>
                    </div>
                    <div class="tech-item-detail"
                        style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9fafb; border-radius: 12px;">
                        <i class="fas fa-arrows-alt-v" style="color: #3b82f6; font-size: 18px;"></i>
                        <div>
                            <span class="tech-value-lg"
                                style="display: block; font-size: 24px; font-weight: 800; color: #111827; line-height: 1;">{{ $export->height_mm ?? 0 }}</span>
                            <span class="tech-label-sm" style="font-size: 12px; color: #6b7280;">Alto mm</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="detail-colors-section mb-4">
                <h6 class="section-title-sm"
                    style="font-weight: 700; color: #374151; font-size: 12px; text-transform: uppercase; margin-bottom: 12px;">
                    Colores Detectados</h6>
                <div class="color-grid-lg" style="display: flex; flex-wrap: wrap; gap: 8px;">
                    @php
                        $colorsToShow = [];
                        $colorSource = 'none';

                        // 1. Intentar obtener de colors_detected del export
                        $detectedColors = $export->colors_detected;

                        // FIX: Manejar caso de doble codificación (string JSON guardado como string)
                        if (is_string($detectedColors)) {
                            $decoded = json_decode($detectedColors, true);
                            if (is_array($decoded)) {
                                $detectedColors = $decoded;
                            }
                        }

                        if ($detectedColors && is_array($detectedColors) && count($detectedColors) > 0) {
                            // Formato 1: array de objetos con 'hex' => [['hex' => '#FF0000'], ...]
                            if (
                                isset($detectedColors[0]) &&
                                is_array($detectedColors[0]) &&
                                isset($detectedColors[0]['hex'])
                            ) {
                                $colorsToShow = $detectedColors;
                                $colorSource = 'export';
                            }
                            // Formato 2: array simple de strings hex => ['#FF0000', '#00FF00', ...]
                            elseif (isset($detectedColors[0]) && is_string($detectedColors[0])) {
                                $colorsToShow = array_map(fn($hex) => ['hex' => $hex], $detectedColors);
                                $colorSource = 'export';
                            }
                            // Formato 3: array asociativo con nombres => ['Rojo' => '#FF0000', ...]
                            elseif (!isset($detectedColors[0])) {
                                $colorsToShow = array_map(
                                    fn($hex, $name) => ['hex' => $hex, 'name' => $name],
                                    $detectedColors,
                                    array_keys($detectedColors),
                                );
                                $colorSource = 'export';
                            }
                        }

                        // 2. Fallback a image.color_palette
                        if (empty($colorsToShow) && $export->image && $export->image->color_palette) {
                            $palette = is_string($export->image->color_palette)
                                ? json_decode($export->image->color_palette, true)
                                : $export->image->color_palette;
                            if (is_array($palette) && count($palette) > 0) {
                                $colorsToShow = array_map(fn($hex) => ['hex' => $hex], $palette);
                                $colorSource = 'image';
                            }
                        }

                        // 3. Fallback a image.dominant_color
                        if (empty($colorsToShow) && $export->image && $export->image->dominant_color) {
                            $colorsToShow = [['hex' => $export->image->dominant_color]];
                            $colorSource = 'dominant';
                        }
                    @endphp

                    @if (count($colorsToShow) > 0)
                        @if ($colorSource !== 'export')
                            <div class="w-100 mb-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Colores obtenidos de la imagen
                                </small>
                            </div>
                        @endif
                        @foreach ($colorsToShow as $color)
                            <div class="color-swatch"
                                style="display: flex; flex-direction: column; align-items: center; gap: 6px; width: 80px; margin-bottom: 8px;">
                                <div class="color-swatch-box shadow-sm mb-1"
                                    style="width: 48px; height: 48px; border-radius: 12px; background-color: {{ $color['hex'] ?? '#000' }}; border: 2px solid #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: help; transition: transform 0.2s;"
                                    title="{{ $color['name'] ?? '' }} ({{ $color['hex'] ?? '' }})"
                                    onmouseover="this.style.transform='scale(1.1)'"
                                    onmouseout="this.style.transform='scale(1)'">
                                </div>
                                <span
                                    class="color-swatch-label text-dark font-weight-bold bg-white px-2 py-1 rounded shadow-sm border"
                                    style="font-size: 0.85rem; font-family: monospace; letter-spacing: 0.5px;">{{ $color['hex'] ?? '#000000' }}</span>
                            </div>
                        @endforeach
                    @else
                        <div class="alert alert-light border-0 w-100 py-2 px-3 mb-0"
                            style="background: #f9fafb; color: #6b7280; font-size: 0.9rem; font-weight: 500; border-radius: 12px;">
                            <i class="fas fa-info-circle mr-2 opacity-50"></i> No se detectaron colores detallados.
                        </div>
                    @endif
                </div>
            </div>

            <div class="detail-app-section mb-4">
                <h6 class="section-title-sm"
                    style="font-weight: 700; color: #374151; font-size: 12px; text-transform: uppercase; margin-bottom: 12px;">
                    Aplicación</h6>
                <div class="info-grid" style="background: #f9fafb; border-radius: 12px; padding: 16px;">
                    <div class="info-row"
                        style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                        <span class="info-key" style="font-size: 14px; color: #6b7280;">Tipo:</span>
                        <span class="info-val"
                            style="font-size: 14px; font-weight: 600; color: #111827;">{{ $export->application_type_label ?? ($export->application_type ?? '-') }}</span>
                    </div>
                    <div class="info-row"
                        style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                        <span class="info-key" style="font-size: 14px; color: #6b7280;">Etiqueta:</span>
                        <span class="info-val"
                            style="font-size: 14px; font-weight: 600; color: #111827;">{{ $export->application_label ?? '-' }}</span>
                    </div>
                    @if ($export->placement_description)
                        <div class="info-row"
                            style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e5e7eb;">
                            <span class="info-key" style="font-size: 14px; color: #6b7280;">Ubicación:</span>
                            <span class="info-val"
                                style="font-size: 14px; font-weight: 600; color: #111827;">{{ $export->placement_description }}</span>
                        </div>
                    @endif
                    @if ($export->notes)
                        <div class="info-row" style="display: flex; justify-content: space-between; padding: 10px 0;">
                            <span class="info-key" style="font-size: 14px; color: #6b7280;">Notas:</span>
                            <span class="info-val info-notes"
                                style="font-size: 14px; font-weight: 600; color: #111827; max-width: 200px; white-space: pre-wrap; word-break: break-word;">{{ $export->notes }}</span>
                        </div>
                    @endif
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="history-content" role="tabpanel" aria-labelledby="history-tab">
            <div class="premium-timeline py-2" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                {{-- Historial completo de cambios de estado desde la BD (MÁS RECIENTE PRIMERO) --}}
                @if ($export->statusHistory && $export->statusHistory->count() > 0)
                    @foreach ($export->statusHistory->sortByDesc('created_at') as $historyItem)
                        <div class="timeline-item d-flex mb-4" style="gap: 16px; position: relative;">
                            <div
                                style="position: absolute; left: 13px; top: 28px; bottom: -30px; width: 2px; background: #d1d5db;">
                            </div>
                            <div
                                style="width: 28px; height: 28px; background: #fff; border: 2px solid {{ $historyItem->status_color }}; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1; flex-shrink: 0;">
                                <i class="fas {{ $historyItem->status_icon }}"
                                    style="font-size: 12px; color: {{ $historyItem->status_color }};"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <span style="font-size: 16px; font-weight: 700; color: #111827;">
                                        {{ $historyItem->previous_status_label }} →
                                        {{ $historyItem->new_status_label }}
                                    </span>
                                    <span
                                        style="font-size: 13px; color: #374151; font-weight: 600;">{{ $historyItem->created_at->diffForHumans() }}</span>
                                </div>
                                <p style="font-size: 14px; color: #4b5563; margin: 4px 0 0; font-weight: 500;">Por
                                    {{ $historyItem->changedByUser->name ?? 'Sistema' }}</p>
                                @if ($historyItem->notes)
                                    <p style="font-size: 13px; color: #4b5563; margin: 4px 0 0; font-style: italic;">
                                        "{{ $historyItem->notes }}"</p>
                                @endif
                                <span
                                    style="font-size: 13px; color: #6b7280; font-weight: 500;">{{ $historyItem->created_at->translatedFormat('d M, Y - h:i A') }}</span>
                            </div>
                        </div>
                    @endforeach
                @else
                    <div class="text-center py-3">
                        <small class="text-muted"><i class="fas fa-info-circle mr-1"></i> Sin cambios de estado
                            registrados</small>
                    </div>
                @endif

                {{-- Evento de creación siempre al final (es el más antiguo) --}}
                <div class="timeline-item d-flex mb-4" style="gap: 16px; position: relative;">
                    <div
                        style="width: 28px; height: 28px; background: #fff; border: 2px solid #3b82f6; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1; flex-shrink: 0;">
                        <i class="fas fa-plus-circle" style="font-size: 12px; color: #3b82f6;"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                            <span style="font-size: 16px; font-weight: 700; color: #111827;">Archivo Creado</span>
                            <span
                                style="font-size: 13px; color: #374151; font-weight: 600;">{{ $export->created_at->diffForHumans() }}</span>
                        </div>
                        <p style="font-size: 14px; color: #4b5563; margin: 4px 0 0; font-weight: 500;">Por
                            {{ $export->creator->name ?? 'Sistema' }}</p>
                        <span
                            style="font-size: 13px; color: #6b7280; font-weight: 500;">{{ $export->created_at->translatedFormat('d M, Y - h:i A') }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="detail-meta-section mb-4">
        <div class="meta-row"
            style="display: flex; align-items: center; gap: 10px; font-size: 14px; color: #6b7280; padding: 8px 0;">
            <i class="fas fa-user" style="width: 16px; color: #9ca3af;"></i>
            <span>Creado por: <strong
                    style="color: #374151;">{{ $export->creator->name ?? 'Sistema' }}</strong></span>
        </div>
        <div class="meta-row"
            style="display: flex; align-items: center; gap: 10px; font-size: 14px; color: #6b7280; padding: 8px 0;">
            <i class="fas fa-calendar" style="width: 16px; color: #9ca3af;"></i>
            <span>Fecha: <strong
                    style="color: #374151;">{{ $export->created_at->translatedFormat('d M, Y') }}</strong></span>
        </div>
    </div>

    <div class="detail-modal-footer d-flex w-100">
        <a href="{{ route('admin.production.download', $export) }}" id="btnDetailDownload"
            class="btn-download w-100 d-flex justify-content-center align-items-center" data-id="{{ $export->id }}"
            download="{{ $export->file_name }}">
            <i class="fas fa-download"></i>
            <span>Descargar</span>
        </a>
    </div>

    <div class="workflow-indicator">
        <div class="workflow-step {{ $export->status === 'borrador' ? 'active' : '' }}">
            <div class="workflow-dot"></div>
            <span>Borrador</span>
        </div>
        <div
            class="workflow-line {{ in_array($export->status, ['pendiente', 'aprobado', 'archivado']) ? 'active' : '' }}">
        </div>

        <div class="workflow-step {{ $export->status === 'pendiente' ? 'active' : '' }}">
            <div class="workflow-dot"></div>
            <span>Revisión</span>
        </div>
        <div class="workflow-line {{ in_array($export->status, ['aprobado', 'archivado']) ? 'active' : '' }}"></div>

        <div class="workflow-step {{ $export->status === 'aprobado' ? 'active' : '' }}">
            <div class="workflow-dot"></div>
            <span>Aprobado</span>
        </div>
        <div class="workflow-line {{ $export->status === 'archivado' ? 'active' : '' }}"></div>

        <div class="workflow-step {{ $export->status === 'archivado' ? 'active' : '' }}">
            <div class="workflow-dot"></div>
            <span>Archivado</span>
        </div>
    </div>

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #dbeafe;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
        }

        /* ESTILOS PARA LAS PESTAÑAS (TABS) */
        .custom-tab {
            font-size: 13px;
            font-weight: 700;
            color: #6b7280;
            /* Color inactivo */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .custom-tab:hover {
            color: #111827;
        }

        .custom-tab.active {
            color: #3b82f6 !important;
            /* Color Azul Activo */
        }

        .custom-tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #3b82f6;
            /* Raya azul inferior */
            border-radius: 2px;
        }

        .custom-tab:not(.active) {
            color: #111827;
            /* Color negro/oscuro solicitado para inactivo */
            opacity: 0.6;
        }

        /* Personalización de scrollbar para el historial */
        .premium-timeline::-webkit-scrollbar {
            width: 4px;
        }

        .premium-timeline::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .premium-timeline::-webkit-scrollbar-thumb {
            background: #e5e7eb;
            border-radius: 10px;
        }

        /* --- TUS ESTILOS EXISTENTES (SIN MODIFICAR) --- */
        .workflow-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 0;
            width: 100%;
            background: white;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .workflow-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #cbd5e1;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            z-index: 2;
        }

        .workflow-step span {
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .workflow-line {
            height: 2px;
            background: #e2e8f0;
            width: 100px;
            margin-top: -26px;
            z-index: 1;
        }

        .workflow-step.active .workflow-dot {
            background: #fff;
            border: 4px solid #3b82f6;
            box-shadow: 0 0 0 4px #dbeafe;
            width: 12px;
            height: 12px;
        }

        .workflow-step.active span {
            color: #2563eb;
        }

        .workflow-line.active {
            background: #cbd5e1;
        }

        .btn-download {
            border-radius: 12px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            transition: all 0.2s ease;
            background-color: #f3f4f6;
            color: #262c34;
        }

        .btn-download:hover {
            background-color: #262c34;
            color: #fff;
        }

        @media (max-width: 768px) {
            .workflow-line {
                width: 40px;
            }

            .workflow-indicator {
                transform: scale(0.9);
            }
        }
    </style>
</div>
</file>

<file path="resources/views/admin/purchases/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar OC: ' . $purchase->purchase_number)

@section('content_header')
@stop

@section('content')
    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show mx-3 mt-3 mb-0" style="border-radius: 8px;">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    <form method="POST" action="{{ route('admin.purchases.update', $purchase->id) }}" id="purchaseForm">
        @csrf
        @method('PUT')

        {{-- HEADER PROFESIONAL --}}
        <div class="purchase-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="purchase-title">Editar Orden de Compra</h1>
                    <p class="purchase-subtitle">{{ $purchase->purchase_number }} - Modifique los datos y materiales</p>
                </div>
                <div class="header-actions">
                    <a href="{{ route('admin.purchases.show', $purchase->id) }}" class="btn-action btn-cancel">
                        Cancelar
                    </a>
                    <button type="submit" class="btn-action btn-save" id="btn_submit">
                        <i class="fas fa-save"></i> Actualizar Orden
                    </button>
                </div>
            </div>
        </div>

        {{-- CONTENIDO PRINCIPAL --}}
        <div class="purchase-content">
            <div class="row no-gutters">
                {{-- PANEL IZQUIERDO: DATOS DE LA ORDEN --}}
                <div class="col-12 col-xl-4">
                    <div class="panel-section">
                        <div class="section-header">
                            <span class="section-icon"><i class="fas fa-file-alt"></i></span>
                            <span class="section-title">Datos de la Orden</span>
                        </div>

                        <div class="section-body">
                            {{-- Proveedor --}}
                            <div class="field-group">
                                <label class="field-label">Proveedor <span class="required">*</span></label>
                                <select name="proveedor_id" id="proveedor_id"
                                    class="field-control @error('proveedor_id') is-invalid @enderror" required>
                                    <option value="">Seleccionar proveedor...</option>
                                    @foreach ($proveedores as $proveedor)
                                        <option value="{{ $proveedor->id }}"
                                            {{ old('proveedor_id', $purchase->proveedor_id) == $proveedor->id ? 'selected' : '' }}>
                                            {{ $proveedor->nombre_proveedor }}
                                        </option>
                                    @endforeach
                                </select>
                            </div>

                            {{-- Fechas en grid --}}
                            <div class="field-row">
                                <div class="field-group">
                                    <label class="field-label">Fecha Orden</label>
                                    <input type="date" name="ordered_at" class="field-control"
                                        value="{{ old('ordered_at', $purchase->ordered_at?->format('Y-m-d')) }}">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Fecha Esperada</label>
                                    <input type="date" name="expected_at" class="field-control"
                                        value="{{ old('expected_at', $purchase->expected_at?->format('Y-m-d')) }}">
                                </div>
                            </div>

                            {{-- IVA y Referencia --}}
                            <div class="field-row">
                                <div class="field-group">
                                    <label class="field-label">IVA</label>
                                    <div class="field-with-suffix">
                                        <input type="number" name="tax_rate" id="tax_rate" class="field-control"
                                            value="{{ old('tax_rate', $purchase->tax_rate) }}" min="0" max="100"
                                            step="0.01">
                                        <span class="field-suffix">%</span>
                                    </div>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Referencia</label>
                                    <input type="text" name="reference" class="field-control"
                                        value="{{ old('reference', $purchase->reference) }}" maxlength="100"
                                        placeholder="Factura, pedido...">
                                </div>
                            </div>

                            {{-- Descuento --}}
                            <div class="field-group">
                                <label class="field-label">Descuento Global</label>
                                <div class="field-with-prefix">
                                    <span class="field-prefix">$</span>
                                    <input type="number" name="discount_amount" id="discount_amount" class="field-control"
                                        value="{{ old('discount_amount', $purchase->discount_amount) }}" min="0"
                                        step="0.01">
                                </div>
                            </div>

                            {{-- Notas --}}
                            <div class="field-group">
                                <label class="field-label">Notas</label>
                                <textarea name="notes" class="field-control field-textarea" rows="3" maxlength="1000"
                                    placeholder="Notas internas de la orden...">{{ old('notes', $purchase->notes) }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- PANEL DERECHO: MATERIALES --}}
                <div class="col-12 col-xl-8">
                    <div class="panel-section panel-main">
                        {{-- SECCIÓN AGREGAR MATERIAL --}}
                        <div class="add-material-section">
                            <div class="section-header">
                                <span class="section-icon text-success"><i class="fas fa-plus-circle"></i></span>
                                <span class="section-title">Agregar Material</span>
                            </div>

                            <div class="add-material-grid">
                                {{-- Fila 1: Selección de producto --}}
                                <div class="material-row">
                                    <div class="material-field">
                                        <label class="field-label-sm">Categoría</label>
                                        <select id="select_category" class="field-control">
                                            <option value="">Seleccionar...</option>
                                            @foreach ($categories as $category)
                                                <option value="{{ $category->id }}"
                                                    data-base-unit="{{ $category->baseUnit->symbol ?? '' }}">
                                                    {{ $category->name }}
                                                </option>
                                            @endforeach
                                        </select>
                                    </div>
                                    <div class="material-field">
                                        <label class="field-label-sm">Material</label>
                                        <select id="select_material" class="field-control" disabled>
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                    <div class="material-field">
                                        <label class="field-label-sm">Variante</label>
                                        <select id="select_variant" class="field-control" disabled>
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                    <div class="material-field">
                                        <label class="field-label-sm">Unidad</label>
                                        <select id="select_unit" class="field-control" disabled>
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                </div>

                                {{-- Fila 2: Cantidad, precio y agregar --}}
                                <div class="material-row material-row-values">
                                    <div class="material-field field-qty">
                                        <label class="field-label-sm">Cantidad</label>
                                        <input type="number" id="input_quantity" class="field-control" min="0.0001"
                                            step="0.01" placeholder="0.00" disabled>
                                        <div id="info_conversion_text" class="conversion-hint"></div>
                                        <input type="hidden" id="info_conversion">
                                    </div>
                                    <div class="material-field field-price">
                                        <label class="field-label-sm">Precio Unit.</label>
                                        <div class="field-with-prefix">
                                            <span class="field-prefix">$</span>
                                            <input type="number" id="input_price" class="field-control" min="0.0001"
                                                step="0.01" placeholder="0.00" disabled>
                                        </div>
                                    </div>
                                    <div class="material-field field-subtotal">
                                        <label class="field-label-sm">Subtotal</label>
                                        <div class="subtotal-display" id="info_subtotal_display">$0.00</div>
                                        <input type="hidden" id="info_subtotal">
                                    </div>
                                    <div class="material-field field-action">
                                        <button type="button" id="btn_add_item" class="btn-add" disabled>
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{-- TABLA DE ITEMS --}}
                        <div class="items-section">
                            <div class="items-header">
                                <span class="items-title">Items de la Orden</span>
                                <span class="items-count" id="items_count">0 items</span>
                            </div>

                            <div class="items-table-wrapper">
                                <table class="items-table" id="items_table">
                                    <thead>
                                        <tr>
                                            <th class="th-num">#</th>
                                            <th class="th-material">Material</th>
                                            <th class="th-variant">Variante</th>
                                            <th class="th-qty">Cant.</th>
                                            <th class="th-unit">Unidad</th>
                                            <th class="th-price">Precio</th>
                                            <th class="th-total">Total</th>
                                            <th class="th-action"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="items_body">
                                        <tr id="no_items_row">
                                            <td colspan="8" class="empty-state">
                                                <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                                                <div class="empty-text">La orden está vacía</div>
                                                <div class="empty-hint">Agregue materiales usando el formulario superior
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            {{-- TOTALES --}}
                            <div class="totals-section" id="items_totals" style="display: none;">
                                <div class="totals-row">
                                    <span class="totals-label">Subtotal</span>
                                    <span class="totals-value" id="total_subtotal">$0.00</span>
                                </div>
                                <div class="totals-row">
                                    <span class="totals-label">IVA (<span id="tax_rate_display">16</span>%)</span>
                                    <span class="totals-value" id="total_tax">$0.00</span>
                                </div>
                                <div class="totals-row totals-discount" id="discount_row" style="display: none;">
                                    <span class="totals-label">Descuento</span>
                                    <span class="totals-value text-danger" id="total_discount">-$0.00</span>
                                </div>
                                <div class="totals-row totals-final">
                                    <span class="totals-label">Total</span>
                                    <span class="totals-value" id="total_final">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{-- CONTAINER DE INPUTS HIDDEN --}}
        <div id="hidden_items_container"></div>
    </form>
@stop

@section('css')
    <style>
        /* ============================================
                   SISTEMA DE DISEÑO PROFESIONAL - SaaS Style
                   ============================================ */

        /* Variables CSS */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #059669;
            --success-hover: #047857;
            --warning: #d97706;
            --warning-hover: #b45309;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* Reset del content wrapper de AdminLTE */
        .content-wrapper {
            background-color: var(--gray-50) !important;
            min-height: calc(100vh - 57px) !important;
        }

        .content {
            padding: 0 !important;
        }

        /* ============================================
                   HEADER
                   ============================================ */
        .purchase-header {
            background: #fff;
            border-bottom: 1px solid var(--gray-200);
            padding: 20px 32px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .purchase-title {
            font-family: var(--font-sans);
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
            letter-spacing: -0.025em;
        }

        .purchase-subtitle {
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-500);
            margin: 4px 0 0 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn-action {
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-cancel {
            background: #fff;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-cancel:hover {
            background: var(--gray-50);
            color: var(--gray-900);
            text-decoration: none;
        }

        .btn-save {
            background: var(--warning);
            color: #fff;
        }

        .btn-save:hover:not(:disabled) {
            background: var(--warning-hover);
        }

        .btn-save:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* ============================================
                   CONTENIDO PRINCIPAL
                   ============================================ */
        .purchase-content {
            padding: 24px 32px 32px;
        }

        .panel-section {
            background: #fff;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            margin-bottom: 0;
        }

        .panel-main {
            margin-left: 24px;
        }

        @media (max-width: 1199px) {
            .panel-main {
                margin-left: 0;
                margin-top: 24px;
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-100);
        }

        .section-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            border-radius: 8px;
            color: var(--gray-600);
            font-size: 14px;
        }

        .section-icon.text-success {
            background: #d1fae5;
            color: var(--success);
        }

        .section-title {
            font-family: var(--font-sans);
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .section-body {
            padding: 20px;
        }

        /* ============================================
                   CAMPOS DE FORMULARIO
                   ============================================ */
        .field-group {
            margin-bottom: 16px;
        }

        .field-group:last-child {
            margin-bottom: 0;
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .field-label {
            display: block;
            font-family: var(--font-sans);
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .field-label-sm {
            display: block;
            font-family: var(--font-sans);
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-500);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .required {
            color: var(--danger);
        }

        .field-control {
            width: 100%;
            height: 40px;
            padding: 0 12px;
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-900);
            background: #fff;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .field-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .field-control:disabled {
            background: var(--gray-50);
            color: var(--gray-600);
            border-color: var(--gray-200);
            cursor: not-allowed;
        }

        .field-control:disabled::placeholder {
            color: var(--gray-500);
        }

        .field-control::placeholder {
            color: var(--gray-400);
        }

        select.field-control {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background: #fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") right 8px center / 20px no-repeat !important;
            padding-right: 36px;
        }

        select.field-control:disabled {
            background: var(--gray-50) url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") right 8px center / 20px no-repeat !important;
            color: var(--gray-600);
        }

        .field-textarea {
            height: auto;
            min-height: 80px;
            padding: 10px 12px;
            resize: vertical;
        }

        .field-with-prefix,
        .field-with-suffix {
            position: relative;
            display: flex;
            align-items: center;
        }

        .field-prefix,
        .field-suffix {
            position: absolute;
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-500);
            pointer-events: none;
        }

        .field-prefix {
            left: 12px;
        }

        .field-suffix {
            right: 12px;
        }

        .field-with-prefix .field-control {
            padding-left: 28px;
        }

        .field-with-suffix .field-control {
            padding-right: 32px;
        }

        /* ============================================
                   SECCIÓN AGREGAR MATERIAL
                   ============================================ */
        .add-material-section {
            border-bottom: 1px solid var(--gray-100);
        }

        .add-material-grid {
            padding: 20px;
        }

        .material-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .material-row:last-child {
            margin-bottom: 0;
        }

        .material-row-values {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: flex-end;
        }

        @media (max-width: 991px) {
            .material-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .material-row-values {
                grid-template-columns: 1fr 1fr;
            }

            .field-action {
                grid-column: span 2;
            }
        }

        .material-field {
            min-width: 0;
        }

        .conversion-hint {
            font-family: var(--font-sans);
            font-size: 12px;
            color: var(--primary);
            margin-top: 4px;
            font-weight: 500;
            display: none;
        }

        .subtotal-display {
            font-family: var(--font-sans);
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
            height: 40px;
            display: flex;
            align-items: center;
        }

        .btn-add {
            height: 40px;
            padding: 0 24px;
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            background: var(--success);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-add:hover:not(:disabled) {
            background: var(--success-hover);
        }

        .btn-add:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* ============================================
                   TABLA DE ITEMS
                   ============================================ */
        .items-section {
            display: flex;
            flex-direction: column;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-100);
        }

        .items-title {
            font-family: var(--font-sans);
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .items-count {
            font-family: var(--font-sans);
            font-size: 13px;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .items-table-wrapper {
            overflow-x: auto;
            max-height: 320px;
            overflow-y: auto;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .items-table thead {
            position: sticky;
            top: 0;
            background: var(--gray-50);
            z-index: 10;
        }

        .items-table th {
            font-family: var(--font-sans);
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .items-table th.th-num {
            width: 50px;
            text-align: center;
        }

        .items-table th.th-qty,
        .items-table th.th-unit {
            text-align: center;
        }

        .items-table th.th-price,
        .items-table th.th-total {
            text-align: right;
        }

        .items-table th.th-action {
            width: 50px;
        }

        .items-table td {
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-700);
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        .items-table tbody tr:hover {
            background: var(--gray-50);
        }

        .item-material-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .item-category {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .item-variant-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Inputs editables en tabla */
        .input-editable {
            width: 80px;
            height: 32px;
            padding: 4px 8px;
            font-family: var(--font-sans);
            font-size: 13px;
            color: var(--gray-900);
            background: #fff;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            text-align: right;
            transition: all 0.15s ease;
        }

        .input-editable:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        }

        .input-editable:hover {
            border-color: var(--gray-400);
        }

        .input-editable-qty {
            width: 70px;
            text-align: center;
        }

        .input-editable-price {
            width: 100px;
            padding-left: 20px !important;
        }

        .input-price-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .input-price-symbol {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            color: var(--gray-500);
            pointer-events: none;
        }

        .item-conversion {
            font-size: 12px;
            color: var(--primary);
            margin-top: 2px;
        }

        .item-unit-cost {
            font-size: 11px;
            color: var(--gray-500);
        }

        .td-center {
            text-align: center;
        }

        .td-right {
            text-align: right;
        }

        .td-total {
            font-weight: 600;
            color: var(--gray-900);
        }

        .btn-remove {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--gray-400);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-remove:hover {
            background: #fef2f2;
            color: var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 20px !important;
        }

        .empty-icon {
            font-size: 48px;
            color: var(--gray-300);
            margin-bottom: 16px;
        }

        .empty-text {
            font-family: var(--font-sans);
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .empty-hint {
            font-family: var(--font-sans);
            font-size: 13px;
            color: var(--gray-400);
        }

        /* ============================================
                   TOTALES
                   ============================================ */
        .totals-section {
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            padding: 16px 20px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .totals-label {
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-600);
        }

        .totals-value {
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-800);
        }

        .totals-final {
            border-top: 1px solid var(--gray-300);
            margin-top: 8px;
            padding-top: 16px;
        }

        .totals-final .totals-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .totals-final .totals-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        /* ============================================
                   SCROLLBAR PERSONALIZADA
                   ============================================ */
        .items-table-wrapper::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .items-table-wrapper::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .items-table-wrapper::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 3px;
        }

        .items-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        /* ============================================
                   RESPONSIVE
                   ============================================ */
        @media (max-width: 768px) {
            .purchase-header {
                padding: 16px 20px;
                flex-wrap: wrap;
            }

            .purchase-header>div {
                flex-wrap: wrap;
                gap: 16px;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .purchase-content {
                padding: 16px;
            }

            .purchase-title {
                font-size: 20px;
            }

            .panel-main {
                margin-left: 0;
                margin-top: 16px;
            }

            .field-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            // Items existentes (cargados desde el servidor)
            let items = @json($itemsForJs);
            let itemIndex = items.length > 0 ? Math.max(...items.map(i => i.index || 0)) + 1 : 0;

            const csrfToken = '{{ csrf_token() }}';

            // Cache selectores
            const $selectCategory = $('#select_category');
            const $selectMaterial = $('#select_material');
            const $selectVariant = $('#select_variant');
            const $selectUnit = $('#select_unit');
            const $inputQuantity = $('#input_quantity');
            const $inputPrice = $('#input_price');
            const $infoConversion = $('#info_conversion');
            const $infoConversionText = $('#info_conversion_text');
            const $infoSubtotal = $('#info_subtotal');
            const $infoSubtotalDisplay = $('#info_subtotal_display');
            const $btnAddItem = $('#btn_add_item');
            const $btnSubmit = $('#btn_submit');
            const $itemsBody = $('#items_body');
            const $itemsTotals = $('#items_totals');
            const $itemsCount = $('#items_count');
            const $hiddenContainer = $('#hidden_items_container');
            const $taxRate = $('#tax_rate');
            const $discountAmount = $('#discount_amount');

            // Estado temporal del item
            let currentItem = {
                category_id: null,
                category_name: '',
                material_id: null,
                material_name: '',
                variant_id: null,
                variant_sku: '',
                variant_color: '',
                unit_id: null,
                unit_name: '',
                unit_symbol: '',
                conversion_factor: 1,
                base_unit_symbol: '',
                quantity: 0,
                unit_price: 0
            };

            // Agregar index a items existentes si no lo tienen
            items = items.map((item, idx) => ({
                ...item,
                index: item.index !== undefined ? item.index : idx
            }));

            // Renderizar items existentes
            renderItems();
            updateTotals();

            // Cambio de categoría
            $selectCategory.on('change', function() {
                const categoryId = $(this).val();
                currentItem.category_id = categoryId;
                currentItem.category_name = $(this).find('option:selected').text();
                currentItem.base_unit_symbol = $(this).find('option:selected').data('base-unit') || '';

                resetFromMaterial();

                if (!categoryId) {
                    $selectMaterial.prop('disabled', true).html('<option value="">Seleccionar...</option>');
                    return;
                }

                $selectMaterial.prop('disabled', true).html('<option value="">Cargando...</option>');

                $.ajax({
                    url: `/admin/purchases/ajax/materials/${categoryId}`,
                    method: 'GET',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    success: function(data) {
                        if (data.length === 0) {
                            $selectMaterial.html('<option value="">Sin materiales</option>');
                            Swal.fire({
                                icon: 'info',
                                title: 'Sin materiales',
                                text: 'No hay materiales registrados en esta categoría',
                                confirmButtonColor: '#2563eb'
                            });
                            return;
                        }
                        let options = '<option value="">Seleccionar...</option>';
                        data.forEach(function(material) {
                            const composition = material.composition ?
                                ` (${material.composition})` : '';
                            options +=
                                `<option value="${material.id}">${material.name}${composition}</option>`;
                        });
                        $selectMaterial.html(options).prop('disabled', false);
                    },
                    error: function(xhr) {
                        $selectMaterial.html('<option value="">Error</option>');
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al cargar materiales',
                            text: xhr.responseJSON?.message ||
                                'No se pudieron cargar los materiales.',
                            confirmButtonColor: '#dc2626'
                        });
                    }
                });
            });

            // Cambio de material
            $selectMaterial.on('change', function() {
                const materialId = $(this).val();
                currentItem.material_id = materialId;
                currentItem.material_name = $(this).find('option:selected').text();

                resetFromVariant();

                if (!materialId) {
                    $selectVariant.prop('disabled', true).html('<option value="">Seleccionar...</option>');
                    return;
                }

                $selectVariant.prop('disabled', true).html('<option value="">Cargando...</option>');

                $.ajax({
                    url: `/admin/purchases/ajax/variants/${materialId}`,
                    method: 'GET',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    success: function(data) {
                        if (data.length === 0) {
                            $selectVariant.html('<option value="">Sin variantes</option>');
                            Swal.fire({
                                icon: 'info',
                                title: 'Sin variantes',
                                text: 'Este material no tiene variantes (SKU/colores) registradas',
                                confirmButtonColor: '#2563eb'
                            });
                            return;
                        }
                        let options = '<option value="">Seleccionar...</option>';
                        data.forEach(function(variant) {
                            const displayName = variant.color || 'Sin color';
                            const stock = variant.current_stock ?
                                ` (Stock: ${parseFloat(variant.current_stock).toFixed(2)})` :
                                '';
                            options +=
                                `<option value="${variant.id}" data-sku="${variant.sku}" data-color="${variant.color || ''}">${displayName}${stock}</option>`;
                        });
                        $selectVariant.html(options).prop('disabled', false);
                    },
                    error: function(xhr) {
                        $selectVariant.html('<option value="">Error</option>');
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al cargar variantes',
                            text: xhr.responseJSON?.message ||
                                'No se pudieron cargar las variantes.',
                            confirmButtonColor: '#dc2626'
                        });
                    }
                });
            });

            // Cambio de variante
            $selectVariant.on('change', function() {
                const variantId = $(this).val();
                const $selected = $(this).find('option:selected');
                currentItem.variant_id = variantId;
                currentItem.variant_sku = $selected.data('sku') || '';
                currentItem.variant_color = $selected.data('color') || '';

                resetFromUnit();

                if (!variantId || !currentItem.material_id) {
                    $selectUnit.prop('disabled', true).html('<option value="">Seleccionar...</option>');
                    return;
                }

                $selectUnit.prop('disabled', true).html('<option value="">Cargando...</option>');

                $.ajax({
                    url: `/admin/purchases/ajax/units/${currentItem.material_id}`,
                    method: 'GET',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    success: function(data) {
                        if (!data.units || data.units.length === 0) {
                            $selectUnit.html('<option value="">Sin unidades</option>');
                            Swal.fire({
                                icon: 'warning',
                                title: 'Sin unidades de compra',
                                text: 'Este material no tiene unidades de compra configuradas.',
                                confirmButtonColor: '#f59e0b'
                            });
                            return;
                        }
                        let options = '<option value="">Seleccionar...</option>';
                        data.units.forEach(function(unit) {
                            const isBase = unit.is_base ? ' (Base)' : '';
                            options +=
                                `<option value="${unit.id}" data-factor="${unit.conversion_factor}" data-symbol="${unit.symbol}" data-name="${unit.name}">${unit.name} (${unit.symbol})${isBase}</option>`;
                        });
                        $selectUnit.html(options).prop('disabled', false);
                    },
                    error: function(xhr) {
                        $selectUnit.html('<option value="">Error</option>');
                        Swal.fire({
                            icon: 'error',
                            title: 'Error al cargar unidades',
                            text: xhr.responseJSON?.message ||
                                'No se pudieron cargar las unidades.',
                            confirmButtonColor: '#dc2626'
                        });
                    }
                });
            });

            // Cambio de unidad
            $selectUnit.on('change', function() {
                const unitId = $(this).val();
                const $selected = $(this).find('option:selected');

                currentItem.unit_id = unitId;
                currentItem.unit_name = $selected.data('name') || '';
                currentItem.unit_symbol = $selected.data('symbol') || '';
                currentItem.conversion_factor = parseFloat($selected.data('factor')) || 1;

                if (unitId) {
                    $inputQuantity.prop('disabled', false);
                    $inputPrice.prop('disabled', false);
                    updateConversionInfo();
                } else {
                    $inputQuantity.prop('disabled', true).val('');
                    $inputPrice.prop('disabled', true).val('');
                    $infoConversion.val('');
                    $infoConversionText.hide();
                    $infoSubtotal.val('');
                    $infoSubtotalDisplay.text('$0.00');
                }

                validateAddButton();
            });

            // Cambio de cantidad o precio
            $inputQuantity.on('input', function() {
                currentItem.quantity = parseFloat($(this).val()) || 0;
                updateConversionInfo();
                calculateItemSubtotal();
                validateAddButton();
            });

            $inputPrice.on('input', function() {
                currentItem.unit_price = parseFloat($(this).val()) || 0;
                calculateItemSubtotal();
                validateAddButton();
            });

            // Actualizar info de conversión
            function updateConversionInfo() {
                if (currentItem.conversion_factor && currentItem.conversion_factor != 1 && currentItem.quantity >
                    0) {
                    const converted = currentItem.quantity * currentItem.conversion_factor;
                    const text = `= ${converted.toFixed(2)} ${currentItem.base_unit_symbol}`;
                    $infoConversion.val(text);
                    $infoConversionText.text(text).show();
                } else {
                    $infoConversion.val('');
                    $infoConversionText.hide();
                }
            }

            // Calcular subtotal del item actual
            function calculateItemSubtotal() {
                const subtotal = currentItem.quantity * currentItem.unit_price;
                const formatted = '$' + subtotal.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                $infoSubtotal.val(subtotal);
                $infoSubtotalDisplay.text(formatted);
            }

            // Validar botón agregar
            function validateAddButton() {
                const canAdd = currentItem.variant_id &&
                    currentItem.unit_id &&
                    currentItem.quantity > 0 &&
                    currentItem.unit_price > 0;

                $btnAddItem.prop('disabled', !canAdd);
            }

            // Agregar item
            $btnAddItem.on('click', function() {
                // Verificar duplicados - si existe, sumar cantidad
                const existingIndex = items.findIndex(i =>
                    i.variant_id == currentItem.variant_id &&
                    i.unit_id == currentItem.unit_id
                );

                if (existingIndex !== -1) {
                    const existingItem = items[existingIndex];
                    const cantidadAnterior = existingItem.quantity;
                    existingItem.quantity += currentItem.quantity;
                    existingItem.subtotal = existingItem.quantity * existingItem.unit_price;
                    existingItem.converted_quantity = existingItem.quantity * existingItem
                        .conversion_factor;
                    existingItem.converted_unit_cost = existingItem.subtotal / existingItem
                        .converted_quantity;

                    renderItems();
                    resetForm();
                    updateTotals();

                    const variantInfo = existingItem.variant_color ? ` (${existingItem.variant_color})` :
                        '';
                    Swal.fire({
                        icon: 'success',
                        title: 'Cantidad actualizada',
                        html: `<strong>${existingItem.material_name}${variantInfo}</strong><br><br>` +
                            `Cantidad anterior: <strong>${cantidadAnterior.toFixed(2)} ${existingItem.unit_symbol}</strong><br>` +
                            `Se agregó: <strong>+${currentItem.quantity.toFixed(2)} ${currentItem.unit_symbol}</strong><br>` +
                            `Nueva cantidad: <strong>${existingItem.quantity.toFixed(2)} ${existingItem.unit_symbol}</strong>`,
                        confirmButtonColor: '#059669',
                        timer: 3000,
                        timerProgressBar: true
                    });
                    return;
                }

                const subtotal = currentItem.quantity * currentItem.unit_price;
                const converted_quantity = currentItem.quantity * currentItem.conversion_factor;
                const converted_unit_cost = subtotal / converted_quantity;

                const newItem = {
                    index: itemIndex,
                    category_name: currentItem.category_name,
                    material_name: currentItem.material_name,
                    variant_id: currentItem.variant_id,
                    variant_sku: currentItem.variant_sku,
                    variant_color: currentItem.variant_color,
                    unit_id: currentItem.unit_id,
                    unit_symbol: currentItem.unit_symbol,
                    quantity: currentItem.quantity,
                    unit_price: currentItem.unit_price,
                    conversion_factor: currentItem.conversion_factor,
                    converted_quantity: converted_quantity,
                    converted_unit_cost: converted_unit_cost,
                    base_unit_symbol: currentItem.base_unit_symbol,
                    subtotal: subtotal
                };

                items.push(newItem);
                itemIndex++;

                renderItems();
                resetForm();
                updateTotals();
            });

            // Renderizar tabla de items
            function renderItems() {
                if (items.length === 0) {
                    $itemsBody.html(`
                        <tr id="no_items_row">
                            <td colspan="8" class="empty-state">
                                <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                                <div class="empty-text">La orden está vacía</div>
                                <div class="empty-hint">Agregue materiales usando el formulario superior</div>
                            </td>
                        </tr>
                    `);
                    $itemsTotals.hide();
                    $btnSubmit.prop('disabled', true);
                    $itemsCount.text('0 items');
                    return;
                }

                let html = '';
                items.forEach((item, idx) => {
                    const variantDisplay = item.variant_color || 'Sin color';
                    const conversionInfo = item.conversion_factor != 1 ?
                        `<div class="item-conversion" id="conv_${item.index}">= ${item.converted_quantity.toFixed(2)} ${item.base_unit_symbol}</div>` :
                        '';
                    const unitCostInfo = item.conversion_factor != 1 ?
                        `<div class="item-unit-cost" id="ucost_${item.index}">$${item.converted_unit_cost.toFixed(4)}/${item.base_unit_symbol}</div>` :
                        '';

                    html += `
                        <tr class="item-row" data-index="${item.index}">
                            <td class="td-center">${idx + 1}</td>
                            <td>
                                <div class="item-material-name">${item.material_name}</div>
                                <div class="item-category">${item.category_name}</div>
                            </td>
                            <td>
                                <span class="item-variant-name">${variantDisplay}</span>
                            </td>
                            <td class="td-center">
                                <input type="number" class="input-editable input-editable-qty input-qty"
                                    data-index="${item.index}"
                                    value="${item.quantity}"
                                    min="0.01" step="0.01">
                                ${conversionInfo}
                            </td>
                            <td class="td-center">${item.unit_symbol}</td>
                            <td class="td-right">
                                <div class="input-price-wrapper">
                                    <span class="input-price-symbol">$</span>
                                    <input type="number" class="input-editable input-editable-price input-price"
                                        data-index="${item.index}"
                                        value="${item.unit_price}"
                                        min="0.01" step="0.01">
                                </div>
                                ${unitCostInfo}
                            </td>
                            <td class="td-right td-total" id="total_${item.index}">$${item.subtotal.toFixed(2)}</td>
                            <td class="td-center">
                                <button type="button" class="btn-remove btn-remove-item" data-index="${item.index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                $itemsBody.html(html);
                $itemsTotals.show();
                $btnSubmit.prop('disabled', false);
                $itemsCount.text(items.length + (items.length === 1 ? ' item' : ' items'));

                generateHiddenInputs();
            }

            // Generar inputs hidden para envío
            function generateHiddenInputs() {
                let html = '';
                items.forEach((item, idx) => {
                    html += `
                        <input type="hidden" name="items[${idx}][material_variant_id]" value="${item.variant_id}">
                        <input type="hidden" name="items[${idx}][unit_id]" value="${item.unit_id}">
                        <input type="hidden" name="items[${idx}][quantity]" value="${item.quantity}">
                        <input type="hidden" name="items[${idx}][unit_price]" value="${item.unit_price}">
                    `;
                });
                $hiddenContainer.html(html);
            }

            // Eliminar item
            $(document).on('click', '.btn-remove-item', function() {
                const index = $(this).data('index');
                items = items.filter(i => i.index !== index);
                renderItems();
                updateTotals();
            });

            // Editar cantidad inline
            $(document).on('input', '.input-qty', function() {
                const index = $(this).data('index');
                const newQty = parseFloat($(this).val()) || 0;

                const item = items.find(i => i.index === index);
                if (item && newQty > 0) {
                    item.quantity = newQty;
                    item.subtotal = item.quantity * item.unit_price;
                    item.converted_quantity = item.quantity * item.conversion_factor;
                    item.converted_unit_cost = item.subtotal / item.converted_quantity;

                    $(`#total_${index}`).text('$' + item.subtotal.toFixed(2));

                    if (item.conversion_factor != 1) {
                        $(`#conv_${index}`).text(
                            `= ${item.converted_quantity.toFixed(2)} ${item.base_unit_symbol}`);
                        $(`#ucost_${index}`).text(
                            `$${item.converted_unit_cost.toFixed(4)}/${item.base_unit_symbol}`);
                    }

                    generateHiddenInputs();
                    updateTotals();
                }
            });

            // Editar precio inline
            $(document).on('input', '.input-price', function() {
                const index = $(this).data('index');
                const newPrice = parseFloat($(this).val()) || 0;

                const item = items.find(i => i.index === index);
                if (item && newPrice > 0) {
                    item.unit_price = newPrice;
                    item.subtotal = item.quantity * item.unit_price;
                    item.converted_unit_cost = item.subtotal / item.converted_quantity;

                    $(`#total_${index}`).text('$' + item.subtotal.toFixed(2));

                    if (item.conversion_factor != 1) {
                        $(`#ucost_${index}`).text(
                            `$${item.converted_unit_cost.toFixed(4)}/${item.base_unit_symbol}`);
                    }

                    generateHiddenInputs();
                    updateTotals();
                }
            });

            // Actualizar totales
            function updateTotals() {
                const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
                const taxRate = parseFloat($taxRate.val()) || 0;
                const discount = parseFloat($discountAmount.val()) || 0;
                const tax = subtotal * (taxRate / 100);
                const total = subtotal + tax - discount;

                $('#total_subtotal').text('$' + subtotal.toFixed(2));
                $('#tax_rate_display').text(taxRate.toFixed(0));
                $('#total_tax').text('$' + tax.toFixed(2));

                if (discount > 0) {
                    $('#discount_row').show();
                    $('#total_discount').text('-$' + discount.toFixed(2));
                } else {
                    $('#discount_row').hide();
                }

                $('#total_final').text('$' + Math.max(0, total).toFixed(2));
            }

            // Cambio en tasa de impuesto o descuento
            $taxRate.on('input', updateTotals);
            $discountAmount.on('input', updateTotals);

            // Reset funciones
            function resetFromMaterial() {
                currentItem.material_id = null;
                currentItem.material_name = '';
                $selectMaterial.val('').prop('disabled', true);
                resetFromVariant();
            }

            function resetFromVariant() {
                currentItem.variant_id = null;
                currentItem.variant_sku = '';
                currentItem.variant_color = '';
                $selectVariant.val('').prop('disabled', true).html('<option value="">Seleccionar...</option>');
                resetFromUnit();
            }

            function resetFromUnit() {
                currentItem.unit_id = null;
                currentItem.unit_name = '';
                currentItem.unit_symbol = '';
                currentItem.conversion_factor = 1;
                $selectUnit.val('').prop('disabled', true).html('<option value="">Seleccionar...</option>');
                $inputQuantity.val('').prop('disabled', true);
                $inputPrice.val('').prop('disabled', true);
                $infoConversion.val('');
                $infoConversionText.hide();
                $infoSubtotal.val('');
                $infoSubtotalDisplay.text('$0.00');
                $btnAddItem.prop('disabled', true);
            }

            function resetForm() {
                currentItem = {
                    category_id: null,
                    category_name: '',
                    material_id: null,
                    material_name: '',
                    variant_id: null,
                    variant_sku: '',
                    variant_color: '',
                    unit_id: null,
                    unit_name: '',
                    unit_symbol: '',
                    conversion_factor: 1,
                    base_unit_symbol: '',
                    quantity: 0,
                    unit_price: 0
                };

                $selectCategory.val('');
                $selectMaterial.val('').prop('disabled', true).html('<option value="">Seleccionar...</option>');
                $selectVariant.val('').prop('disabled', true).html('<option value="">Seleccionar...</option>');
                $selectUnit.val('').prop('disabled', true).html('<option value="">Seleccionar...</option>');
                $inputQuantity.val('').prop('disabled', true);
                $inputPrice.val('').prop('disabled', true);
                $infoConversion.val('');
                $infoConversionText.hide();
                $infoSubtotal.val('');
                $infoSubtotalDisplay.text('$0.00');
                $btnAddItem.prop('disabled', true);
            }

            // Validación antes de enviar
            $('#purchaseForm').on('submit', function(e) {
                if (items.length === 0) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sin items',
                        text: 'Debe agregar al menos un item a la orden de compra',
                        confirmButtonColor: '#f59e0b'
                    });
                    return false;
                }

                if (!$('#proveedor_id').val()) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Proveedor requerido',
                        text: 'Debe seleccionar un proveedor para la orden',
                        confirmButtonColor: '#f59e0b'
                    });
                    return false;
                }

                return true;
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/purchases/show.blade.php">
@extends('adminlte::page')

@section('title', 'OC: ' . $purchase->purchase_number)

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info', 'warning'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ALERTA DE COMPRA VENCIDA --}}
    @php
        // Calcular días de atraso usando solo fechas (sin horas)
        // Solo mostrar vencida si el día esperado YA PASÓ completamente
        $isOverdue = false;
        $daysOverdue = 0;
        if ($purchase->expected_at && $purchase->can_receive) {
            $todayStart = now()->startOfDay();
            $expectedStart = $purchase->expected_at->startOfDay();
            // Solo vencida si today > expected (no el mismo día)
            if ($todayStart->gt($expectedStart)) {
                $isOverdue = true;
                $daysOverdue = (int) $todayStart->diffInDays($expectedStart);
                // Para cambiar a horas: $hoursOverdue = (int) now()->diffInHours($purchase->expected_at);
            }
        }
    @endphp
    @if ($isOverdue)
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">
                <i class="fas fa-exclamation-triangle fa-pulse"></i>
                <strong>¡COMPRA VENCIDA!</strong>
            </h5>
            <hr>
            <p class="mb-0">
                Esta orden tiene <strong>{{ $daysOverdue }} día(s) de atraso</strong>.
                Fecha esperada: <strong>{{ $purchase->expected_at->format('d/m/Y') }}</strong>.
                Por favor, contacte al proveedor.
            </p>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    {{-- CABECERA --}}
    <div class="card card-primary">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="card-title" style="font-weight: bold; font-size: 20px;">
                    <i class="fas fa-file-invoice"></i> ORDEN DE COMPRA: {{ $purchase->purchase_number }}
                </h3>
                <div>
                    {{-- BADGE DE FECHA VENCIDA --}}
                    @if ($purchase->expected_at && $purchase->status->value !== 'recibido')
                        @php
                            // Días restantes: positivo = faltan días, 0 = hoy, negativo = vencida
                            $daysRemaining = (int) now()
                                ->startOfDay()
                                ->diffInDays($purchase->expected_at->startOfDay(), false);
                        @endphp

                        @if ($daysRemaining < 0)
                            <span class="badge badge-danger mr-2" style="font-size: 12px;">
                                <i class="fas fa-exclamation-triangle"></i>
                                VENCIDA ({{ abs($daysRemaining) }} {{ abs($daysRemaining) == 1 ? 'día' : 'días' }})
                            </span>
                        @elseif ($daysRemaining == 0)
                            <span class="badge badge-warning mr-2" style="font-size: 12px;">
                                <i class="fas fa-clock"></i>
                                VENCE HOY
                            </span>
                        @elseif ($daysRemaining <= 3)
                            <span class="badge badge-warning mr-2" style="font-size: 12px;">
                                <i class="fas fa-clock"></i>
                                Vence en {{ $daysRemaining }} {{ $daysRemaining == 1 ? 'día' : 'días' }}
                            </span>
                        @else
                            <span class="badge badge-info mr-2" style="font-size: 12px;">
                                <i class="fas fa-calendar"></i>
                                {{ $purchase->expected_at->format('d/m/Y') }}
                            </span>
                        @endif
                    @endif

                    <span class="badge badge-{{ $purchase->status_color }}" style="font-size: 14px;">
                        <i class="{{ $purchase->status_icon }}"></i>
                        {{ $purchase->status_label }}
                    </span>
                </div>
            </div>
        </div>

        <div class="card-body">
            {{-- INFO GENERAL --}}
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td style="width: 150px;"><strong>Proveedor:</strong></td>
                            <td>{{ $purchase->proveedor->nombre_proveedor ?? 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Referencia:</strong></td>
                            <td>{{ $purchase->reference ?? '-' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Orden:</strong></td>
                            <td>{{ $purchase->ordered_at ? $purchase->ordered_at->format('d/m/Y') : '-' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Esperada:</strong></td>
                            <td>
                                @if ($purchase->expected_at)
                                    {{ $purchase->expected_at->format('d/m/Y') }}
                                    @if ($isOverdue)
                                        <span class="badge badge-danger">
                                            <i class="fas fa-exclamation-triangle"></i> Vencida
                                        </span>
                                    @endif
                                @else
                                    -
                                @endif
                            </td>
                        </tr>
                        @if ($purchase->received_at)
                            <tr>
                                <td><strong>Fecha Recepción:</strong></td>
                                <td>
                                    {{ $purchase->received_at->format('d/m/Y H:i') }}
                                    @if ($purchase->receiver)
                                        <small class="text-muted">({{ $purchase->receiver->name }})</small>
                                    @endif
                                </td>
                            </tr>
                        @endif
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm table-borderless">
                        <tr>
                            <td style="width: 150px;"><strong>Creado por:</strong></td>
                            <td>{{ $purchase->creator->name ?? 'N/A' }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha Creación:</strong></td>
                            <td>{{ $purchase->created_at->format('d/m/Y H:i') }}</td>
                        </tr>
                        @if ($purchase->notes)
                            <tr>
                                <td><strong>Notas:</strong></td>
                                <td>{{ $purchase->notes }}</td>
                            </tr>
                        @endif
                        @if ($purchase->cancellation_reason)
                            <tr>
                                <td><strong>Motivo Cancelación:</strong></td>
                                <td class="text-danger">{{ $purchase->cancellation_reason }}</td>
                            </tr>
                        @endif
                    </table>
                </div>
            </div>

            {{-- BARRA DE PROGRESO --}}
            @if (in_array($purchase->status->value, ['pendiente', 'parcial', 'recibido']))
                @php
                    $totalOrdered = $purchase->items->sum('quantity');
                    $totalReceived = $purchase->items->sum('quantity_received');
                    $percentage = $totalOrdered > 0 ? min(100, ($totalReceived / $totalOrdered) * 100) : 0;
                @endphp
                <div class="card bg-light mb-3">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong>Progreso de Recepción</strong>
                            <span
                                class="badge badge-{{ $percentage >= 100 ? 'success' : ($percentage > 0 ? 'warning' : 'secondary') }}">
                                {{ number_format($percentage, 1) }}%
                            </span>
                        </div>
                        <div class="progress" style="height: 20px;">
                            <div class="progress-bar bg-{{ $percentage >= 100 ? 'success' : ($percentage > 0 ? 'warning' : 'secondary') }}"
                                role="progressbar" style="width: {{ $percentage }}%;"
                                aria-valuenow="{{ $percentage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ number_format($percentage, 0) }}%
                            </div>
                        </div>
                        <small class="text-muted">
                            Recibido: {{ number_format($totalReceived, 2) }} de {{ number_format($totalOrdered, 2) }}
                            unidades
                        </small>
                    </div>
                </div>
            @endif

            {{-- ACCIONES --}}
            <div class="row mt-3 mb-3">
                <div class="col-12">
                    <a href="{{ route('admin.purchases.index') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver al Listado
                    </a>

                    @if ($purchase->can_edit)
                        <a href="{{ route('admin.purchases.edit', $purchase->id) }}" class="btn btn-warning">
                            <i class="fas fa-edit"></i> Editar
                        </a>

                        @if ($purchase->status->value === 'borrador')
                            {{-- Dropdown Confirmar Orden (hover) --}}
                            <div class="btn-group dropdown-hover">
                                <button type="button" class="btn btn-primary dropdown-toggle">
                                    <i class="fas fa-check"></i> Confirmar Orden
                                </button>
                                <div class="dropdown-menu">
                                    <button type="button" class="dropdown-item" id="btnConfirmAndReceive">
                                        <i class="fas fa-truck-loading text-success mr-2"></i> Completa/Recibido
                                        <small class="d-block text-muted">Confirmar y recibir en un paso</small>
                                    </button>
                                    <div class="dropdown-divider"></div>
                                    <button type="button" class="dropdown-item" id="btnConfirmOrder">
                                        <i class="fas fa-clipboard-check text-primary mr-2"></i> Confirmado
                                        <small class="d-block text-muted">Solo confirmar (pendiente de recibir)</small>
                                    </button>
                                </div>
                            </div>

                            {{-- Forms ocultos para las acciones --}}
                            <form action="{{ route('admin.purchases.confirm', $purchase->id) }}" method="POST"
                                class="d-none" id="formConfirmOrder">
                                @csrf
                            </form>
                            <form action="{{ route('admin.purchases.confirm_and_receive', $purchase->id) }}" method="POST"
                                class="d-none" id="formConfirmAndReceive">
                                @csrf
                            </form>

                            <a href="{{ route('admin.purchases.confirm_delete', $purchase->id) }}" class="btn btn-danger">
                                <i class="fas fa-trash"></i> Eliminar
                            </a>
                        @endif
                    @endif

                    @if ($purchase->can_receive)
                        <a href="{{ route('admin.purchases.receive', $purchase->id) }}" class="btn btn-success">
                            <i class="fas fa-truck-loading"></i> Recibir Mercancía
                        </a>
                    @endif

                    @if ($purchase->can_cancel)
                        <a href="{{ route('admin.purchases.cancel', $purchase->id) }}" class="btn btn-danger">
                            <i class="fas fa-ban"></i> Cancelar Orden
                        </a>
                    @endif
                </div>
            </div>

            <hr>

            {{-- TABS: ITEMS Y RECEPCIONES --}}
            <ul class="nav nav-tabs" id="purchaseTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="items-tab" data-toggle="tab" href="#items" role="tab">
                        <i class="fas fa-list"></i> Items ({{ $purchase->items->count() }})
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="receptions-tab" data-toggle="tab" href="#receptions" role="tab">
                        <i class="fas fa-truck-loading"></i> Historial de Recepciones
                        @if ($receptions->count() > 0)
                            <span class="badge badge-info">{{ $receptions->count() }}</span>
                        @endif
                    </a>
                </li>
            </ul>

            <div class="tab-content" id="purchaseTabsContent">
                {{-- TAB: ITEMS --}}
                <div class="tab-pane fade show active" id="items" role="tabpanel">
                    <div class="table-responsive mt-3">
                        <table class="table table-bordered table-sm">
                            <thead class="thead-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Material</th>
                                    <th>Color / SKU</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-center">Unidad</th>
                                    <th class="text-right">P. Unitario</th>
                                    <th class="text-right">Subtotal</th>
                                    @if ($purchase->status->value !== 'borrador')
                                        <th class="text-center">Recibido</th>
                                    @endif
                                </tr>
                            </thead>
                            <tbody>
                                @foreach ($purchase->items as $item)
                                    <tr class="{{ $item->is_fully_received ? 'table-success' : '' }}">
                                        <td>{{ $loop->iteration }}</td>
                                        <td>
                                            <strong>{{ $item->materialVariant->material->name ?? 'N/A' }}</strong>
                                            <br>
                                            <small class="text-muted">
                                                {{ $item->materialVariant->material->category->name ?? '' }}
                                            </small>
                                        </td>
                                        <td>
                                            @if ($item->materialVariant->color)
                                                <span
                                                    class="badge badge-secondary">{{ $item->materialVariant->color }}</span><br>
                                            @endif
                                            <code>{{ $item->materialVariant->sku ?? 'N/A' }}</code>
                                        </td>
                                        <td class="text-center">
                                            {{ number_format($item->quantity, 2) }}
                                            @if ($item->conversion_factor != 1)
                                                <br>
                                                <small class="text-info">
                                                    = {{ number_format($item->converted_quantity, 2) }}
                                                    {{ $item->materialVariant->material->category->baseUnit->symbol ?? '' }}
                                                </small>
                                            @endif
                                        </td>
                                        <td class="text-center">
                                            {{ $item->unit->symbol ?? 'N/A' }}
                                        </td>
                                        <td class="text-right">
                                            ${{ number_format($item->unit_price, 2) }}
                                            @if ($item->conversion_factor != 1 && $item->converted_quantity > 0)
                                                <br>
                                                <small class="text-muted">
                                                    ${{ number_format($item->subtotal / $item->converted_quantity, 2) }}/{{ $item->materialVariant->material->category->baseUnit->symbol ?? '' }}
                                                </small>
                                            @endif
                                        </td>
                                        <td class="text-right font-weight-bold">
                                            ${{ number_format($item->subtotal, 2) }}
                                        </td>
                                        @if ($purchase->status->value !== 'borrador')
                                            <td class="text-center">
                                                @if ($item->is_fully_received)
                                                    <span class="badge badge-success">
                                                        <i class="fas fa-check"></i> Completo
                                                    </span>
                                                @elseif ($item->quantity_received > 0)
                                                    <span class="badge badge-warning">
                                                        {{ number_format($item->quantity_received, 2) }} /
                                                        {{ number_format($item->quantity, 2) }}
                                                    </span>
                                                    <div class="progress mt-1" style="height: 5px;">
                                                        <div class="progress-bar bg-warning"
                                                            style="width: {{ $item->received_percentage }}%"></div>
                                                    </div>
                                                @else
                                                    <span class="badge badge-secondary">Pendiente</span>
                                                @endif
                                            </td>
                                        @endif
                                    </tr>
                                @endforeach
                            </tbody>
                            <tfoot class="bg-light">
                                <tr>
                                    <td colspan="{{ $purchase->status->value !== 'borrador' ? 6 : 5 }}"
                                        class="text-right">
                                        <strong>Subtotal:</strong>
                                    </td>
                                    <td class="text-right">${{ number_format($purchase->subtotal, 2) }}</td>
                                    @if ($purchase->status->value !== 'borrador')
                                        <td></td>
                                    @endif
                                </tr>
                                @if ($purchase->tax_rate > 0)
                                    <tr>
                                        <td colspan="{{ $purchase->status->value !== 'borrador' ? 6 : 5 }}"
                                            class="text-right">
                                            <strong>IVA ({{ number_format($purchase->tax_rate, 0) }}%):</strong>
                                        </td>
                                        <td class="text-right">${{ number_format($purchase->tax_amount, 2) }}</td>
                                        @if ($purchase->status->value !== 'borrador')
                                            <td></td>
                                        @endif
                                    </tr>
                                @endif
                                @if ($purchase->discount_amount > 0)
                                    <tr>
                                        <td colspan="{{ $purchase->status->value !== 'borrador' ? 6 : 5 }}"
                                            class="text-right">
                                            <strong>Descuento:</strong>
                                        </td>
                                        <td class="text-right text-danger">
                                            -${{ number_format($purchase->discount_amount, 2) }}</td>
                                        @if ($purchase->status->value !== 'borrador')
                                            <td></td>
                                        @endif
                                    </tr>
                                @endif
                                <tr class="table-primary">
                                    <td colspan="{{ $purchase->status->value !== 'borrador' ? 6 : 5 }}"
                                        class="text-right">
                                        <strong style="font-size: 16px;">TOTAL:</strong>
                                    </td>
                                    <td class="text-right">
                                        <strong
                                            style="font-size: 16px;">${{ number_format($purchase->total, 2) }}</strong>
                                    </td>
                                    @if ($purchase->status->value !== 'borrador')
                                        <td></td>
                                    @endif
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                {{-- TAB: HISTORIAL DE RECEPCIONES --}}
                <div class="tab-pane fade" id="receptions" role="tabpanel">
                    <div class="mt-3">
                        @if ($receptions->isEmpty())
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i>
                                No hay recepciones registradas para esta orden.
                            </div>
                        @else
                            {{-- TIMELINE DE RECEPCIONES --}}
                            <div class="timeline">
                                @foreach ($receptions as $reception)
                                    <div class="time-label">
                                        <span class="bg-{{ $reception->status_color }}">
                                            {{ $reception->received_at->format('d/m/y') }}
                                        </span>
                                    </div>

                                    <div>
                                        <i class="{{ $reception->status_icon }} bg-{{ $reception->status_color }}"></i>
                                        <div class="timeline-item">
                                            <span class="time">
                                                <i class="fas fa-clock"></i> {{ $reception->received_at->format('H:i') }}
                                            </span>
                                            <h3 class="timeline-header">
                                                <strong>{{ $reception->reception_number }}</strong>
                                                <span class="badge badge-{{ $reception->status_color }} ml-2">
                                                    {{ $reception->status_label }}
                                                </span>
                                                @if ($reception->delivery_note)
                                                    <small class="text-muted ml-2">
                                                        Guía: {{ $reception->delivery_note }}
                                                    </small>
                                                @endif
                                            </h3>
                                            <div class="timeline-body">
                                                <p class="mb-2">
                                                    <strong>Recibido por:</strong>
                                                    {{ $reception->receiver->name ?? 'N/A' }}
                                                </p>

                                                @if ($reception->notes)
                                                    <p class="mb-2">
                                                        <strong>Notas:</strong> {{ $reception->notes }}
                                                    </p>
                                                @endif

                                                @if ($reception->is_voided)
                                                    <div class="alert alert-danger py-1 px-2 mb-2">
                                                        <strong>Anulada por:</strong>
                                                        {{ $reception->voidedByUser->name ?? 'N/A' }}
                                                        el {{ $reception->voided_at->format('d/m/Y H:i') }}
                                                        <br>
                                                        <strong>Motivo:</strong> {{ $reception->void_reason }}
                                                    </div>
                                                @endif

                                                {{-- ITEMS DE LA RECEPCIÓN --}}
                                                <table class="table table-sm table-bordered mt-2">
                                                    <thead class="thead-light">
                                                        <tr>
                                                            <th>Material</th>
                                                            <th>SKU</th>
                                                            <th class="text-center">Cantidad</th>
                                                            <th class="text-right">Costo Unit.</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach ($reception->items as $item)
                                                            <tr class="{{ $reception->is_voided ? 'text-muted' : '' }}">
                                                                <td>{{ $item->materialVariant->material->name ?? 'N/A' }}
                                                                </td>
                                                                <td><code>{{ $item->materialVariant->sku ?? 'N/A' }}</code>
                                                                </td>
                                                                <td class="text-center">
                                                                    {{ number_format($item->quantity_received, 2) }}
                                                                    {{ $item->purchaseItem->unit->symbol ?? '' }}
                                                                    @if ($item->quantity_received != $item->converted_quantity)
                                                                        <br>
                                                                        <small class="text-info">
                                                                            =
                                                                            {{ number_format($item->converted_quantity, 2) }}
                                                                            {{ $item->materialVariant->material->category->baseUnit->symbol ?? '' }}
                                                                        </small>
                                                                    @endif
                                                                </td>
                                                                <td class="text-right">
                                                                    ${{ number_format($item->unit_cost, 4) }}
                                                                </td>
                                                            </tr>
                                                        @endforeach
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="timeline-footer">
                                                @if ($reception->can_void)
                                                    <button type="button" class="btn btn-danger btn-sm"
                                                        data-toggle="modal" data-target="#voidModal{{ $reception->id }}">
                                                        <i class="fas fa-undo"></i> Anular Recepción
                                                    </button>
                                                @endif
                                            </div>
                                        </div>
                                    </div>
                                @endforeach

                                <div>
                                    <i class="fas fa-clock bg-gray"></i>
                                </div>
                            </div>
                        @endif
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{-- MODALES DE ANULACIÓN --}}
    @foreach ($receptions->where('status', \App\Enums\ReceptionStatus::COMPLETED) as $reception)
        <div class="modal fade" id="voidModal{{ $reception->id }}" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <form method="POST"
                        action="{{ route('admin.purchases.receptions.void', [$purchase->id, $reception->id]) }}">
                        @csrf
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-undo"></i> Anular Recepción
                            </h5>
                            <button type="button" class="close text-white" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning">
                                <strong>Advertencia:</strong> Esta acción revertirá los movimientos de inventario
                                asociados a la recepción <strong>{{ $reception->reception_number }}</strong>.
                            </div>

                            <p>
                                <strong>Items afectados:</strong> {{ $reception->items->count() }}<br>
                                <strong>Fecha recepción:</strong> {{ $reception->received_at->format('d/m/Y H:i') }}
                            </p>

                            <div class="form-group">
                                <label>Motivo de Anulación <span class="text-danger">*</span></label>
                                <textarea name="void_reason" class="form-control" rows="3" required minlength="10" maxlength="500"
                                    placeholder="Explique el motivo de la anulación (mínimo 10 caracteres)..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger btn-void-reception">
                                <i class="fas fa-undo"></i> Confirmar Anulación
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    @endforeach
@stop

@section('js')
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(function() {
            // Confirmar Orden de Compra (Solo confirmar - pendiente de recibir)
            $('#btnConfirmOrder').on('click', function() {
                Swal.fire({
                    title: '¿Confirmar orden de compra?',
                    html: `
                        <div class="text-center">
                            <p>Esta acción cambiará el estado de la orden a <strong>Pendiente</strong>.</p>
                            <p class="mb-0 text-muted"><small>Una vez confirmada, no podrá eliminar la orden, solo cancelarla.</small></p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#007bff',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-check"></i> Sí, confirmar',
                    cancelButtonText: '<i class="fas fa-times"></i> Cancelar',
                    reverseButtons: true,
                    focusCancel: true,
                    customClass: {
                        popup: 'swal2-popup-custom',
                        title: 'swal2-title-custom',
                        confirmButton: 'btn btn-primary',
                        cancelButton: 'btn btn-secondary'
                    },
                    buttonsStyling: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#formConfirmOrder').submit();
                    }
                });
            });

            // Confirmar y Recibir en un solo paso
            $('#btnConfirmAndReceive').on('click', function() {
                Swal.fire({
                    title: '¿Confirmar y recibir orden completa?',
                    html: `
                        <div class="text-center">
                            <p>Esta acción realizará <strong>dos operaciones</strong>:</p>
                            <ol class="text-left pl-4">
                                <li>Confirmar la orden de compra</li>
                                <li>Recibir toda la mercancía automáticamente</li>
                            </ol>
                            <div class="alert alert-info py-2 mt-2">
                                <i class="fas fa-info-circle"></i>
                                El inventario se actualizará inmediatamente.
                            </div>
                            <p class="mb-0 text-muted"><small>Esta acción no se puede deshacer.</small></p>
                        </div>
                    `,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-truck-loading"></i> Sí, confirmar y recibir',
                    cancelButtonText: '<i class="fas fa-times"></i> Cancelar',
                    reverseButtons: true,
                    focusCancel: true,
                    customClass: {
                        popup: 'swal2-popup-custom',
                        title: 'swal2-title-custom',
                        confirmButton: 'btn btn-success',
                        cancelButton: 'btn btn-secondary'
                    },
                    buttonsStyling: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#formConfirmAndReceive').submit();
                    }
                });
            });

            // Anular Recepción
            $('.btn-void-reception').on('click', function() {
                const $form = $(this).closest('form');
                const $textarea = $form.find('textarea[name="void_reason"]');
                const reason = $textarea.val().trim();

                if (reason.length < 10) {
                    Swal.fire({
                        title: 'Motivo requerido',
                        text: 'Debe ingresar un motivo de al menos 10 caracteres.',
                        icon: 'error',
                        confirmButtonColor: '#dc3545',
                        confirmButtonText: 'Entendido'
                    });
                    $textarea.focus();
                    return;
                }

                Swal.fire({
                    title: '¿Anular esta recepción?',
                    html: `
                        <div class="text-left">
                            <div class="alert alert-danger py-2">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Advertencia:</strong> Esta acción revertirá los movimientos de inventario.
                            </div>
                            <p class="mb-0">Esta operación no se puede deshacer.</p>
                        </div>
                    `,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: '<i class="fas fa-undo"></i> Sí, anular',
                    cancelButtonText: '<i class="fas fa-times"></i> Cancelar',
                    reverseButtons: true,
                    focusCancel: true,
                    customClass: {
                        confirmButton: 'btn btn-danger',
                        cancelButton: 'btn btn-secondary'
                    },
                    buttonsStyling: false
                }).then((result) => {
                    if (result.isConfirmed) {
                        $form.submit();
                    }
                });
            });
        });
    </script>
@stop

@section('css')
    <style>
        /* SweetAlert2 Custom Styles */
        .swal2-popup {
            border-radius: 15px !important;
        }

        .swal2-title {
            font-size: 1.5rem !important;
        }

        .swal2-html-container {
            font-size: 1rem !important;
        }

        .swal2-actions {
            gap: 10px;
        }

        .swal2-actions .btn {
            margin: 0 5px;
            padding: 8px 20px;
        }

        .timeline {
            position: relative;
            margin: 0 0 30px 0;
            padding: 0;
            list-style: none;
        }

        .timeline:before {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 4px;
            background: #ddd;
            left: 31px;
            margin: 0;
            border-radius: 2px;
        }

        .timeline>div {
            position: relative;
            margin-right: 10px;
            margin-bottom: 15px;
        }

        .timeline>div>.timeline-item {
            margin-left: 60px;
            margin-right: 15px;
            margin-top: 0;
            border-radius: 3px;
            padding: 0;
            position: relative;
            background: #fff;
            border: 1px solid #ddd;
        }

        .timeline>div>.timeline-item>.time {
            color: #6c757d;
            float: right;
            padding: 10px;
            font-size: 15px;
            font-weight: bold;
        }

        .timeline>div>.timeline-item>.timeline-header {
            margin: 0;
            padding: 10px;
            border-bottom: 1px solid #f4f4f4;
            font-size: 14px;
            background: #f8f9fa;
        }

        .timeline>div>.timeline-item>.timeline-body {
            padding: 10px;
        }

        .timeline>div>.timeline-item>.timeline-footer {
            padding: 10px;
            background: #f8f9fa;
            border-top: 1px solid #f4f4f4;
        }

        .timeline>div>i {
            width: 30px;
            height: 30px;
            font-size: 15px;
            line-height: 30px;
            position: absolute;
            color: #fff;
            border-radius: 50%;
            left: 18px;
            text-align: center;
        }

        .time-label>span {
            font-weight: 600;
            padding: 5px 10px;
            display: inline-block;
            border-radius: 4px;
            color: #fff;
        }

        /* Dropdown Confirmar Orden - Hover */
        .dropdown-hover {
            position: relative;
        }

        .dropdown-hover .dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 240px;
            padding: 8px 0;
            margin-top: 2px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.18);
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            background: #fff;
            z-index: 1050;
        }

        .dropdown-hover:hover .dropdown-menu {
            display: block;
        }

        .dropdown-hover .dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.15s ease;
            white-space: nowrap;
        }

        .dropdown-hover .dropdown-item:hover {
            background-color: #f0f9ff;
        }

        .dropdown-hover .dropdown-item:active {
            background-color: #e0f2fe;
            color: inherit;
        }

        .dropdown-hover .dropdown-item small {
            font-size: 11px;
            margin-top: 2px;
        }

        .dropdown-hover .dropdown-divider {
            margin: 4px 0;
        }
    </style>
@stop
</file>

<file path="resources/views/admin/recomendaciones/delete.blade.php">
@extends('adminlte::page')

@section('title', 'ELIMINAR RECOMENDACIÓN')

@section('content_header')
@stop

@section('content')
    <br>
    <br>
    <div class="col-12 col-md-6 col-lg-4">

        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        <div class="card card-danger " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">
                <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                    ELIMINAR RECOMENDACIÓN
                </h3>
            </div>

            <div class="card-body" bis_skin_checked="1">
                <form id="deleteForm" method="post"
                    action="{{ route('admin.recomendaciones.destroy', $recomendacion->id) }}">
                    @csrf
                    @method('DELETE')

                    <div class="col-md-12">

                        <div style="border-bottom: 3px solid #dc3545; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #dc3545; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos de la Recomendación
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>
                                Nombre <span style="color: red;">*</span>
                            </label>

                            <input type="text"
                                class="form-control form-control-sm @error('nombre_recomendacion') is-invalid @enderror"
                                id="nombre_recomendacion" name="nombre_recomendacion" placeholder="Ej: MEXICO"
                                pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+" title="Solo se permiten letras y espacios"
                                value="{{ $recomendacion->nombre_recomendacion }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" disabled>

                            @error('nombre_recomendacion')
                                <div class="invalid-feedback">
                                    {{ $message }}
                                </div>
                            @enderror
                        </div>

                        <div class="d-flex justify-content-end align-items-center mt-4">
                            <a href="{{ route('admin.recomendaciones.index') }}" class="btn btn-secondary mr-2"
                                style="padding: 8px 20px;">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-danger" style="padding: 8px 20px;">
                                <i class="fas fa-save"></i> Eliminar
                            </button>
                        </div>

                    </div>
                </form>
            </div>
        </div>
    </div>
@stop


@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: '¿Está seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminarlo',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/settings/index.blade.php">
@extends('adminlte::page')

@section('title', 'Configuración del Sistema')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-cogs"></i> CONFIGURACIÓN DEL SISTEMA
            </h3>
        </div>

        <div class="card-body">
            {{-- TABS DE GRUPOS --}}
            <ul class="nav nav-tabs mb-4">
                @foreach ($groups as $group)
                    <li class="nav-item">
                        <a class="nav-link {{ $activeGroup === $group ? 'active' : '' }}"
                            href="{{ route('admin.settings.index', ['group' => $group]) }}">
                            @switch($group)
                                @case('general')
                                    <i class="fas fa-home"></i> General
                                @break

                                @case('inventario')
                                    <i class="fas fa-boxes"></i> Inventario
                                @break

                                @case('facturacion')
                                    <i class="fas fa-file-invoice-dollar"></i> Facturación
                                @break

                                @case('produccion')
                                    <i class="fas fa-industry"></i> Producción
                                @break

                                @default
                                    <i class="fas fa-cog"></i> {{ ucfirst($group) }}
                            @endswitch
                        </a>
                    </li>
                @endforeach
            </ul>

            {{-- FORMULARIO DE CONFIGURACIONES --}}
            <form method="POST" action="{{ route('admin.settings.bulk-update') }}" enctype="multipart/form-data">
                @csrf
                @method('PUT')
                <input type="hidden" name="group" value="{{ $activeGroup }}">

                <div class="row">
                    @forelse ($settings as $setting)
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="setting_{{ $setting->key }}">
                                    {{ $setting->label }}
                                </label>

                                @switch($setting->type)
                                    @case('boolean')
                                        <div class="custom-control custom-switch">
                                            <input type="hidden" name="settings[{{ $setting->key }}]" value="0">
                                            <input type="checkbox" class="custom-control-input" id="setting_{{ $setting->key }}"
                                                name="settings[{{ $setting->key }}]" value="1"
                                                {{ old('settings.' . $setting->key, $setting->value) == '1' ? 'checked' : '' }}>
                                            <label class="custom-control-label" for="setting_{{ $setting->key }}">
                                                Activado
                                            </label>
                                        </div>
                                    @break

                                    @case('select')
                                        <select class="form-control" id="setting_{{ $setting->key }}"
                                            name="settings[{{ $setting->key }}]">
                                            @foreach ($setting->options ?? [] as $optionValue => $optionLabel)
                                                <option value="{{ $optionValue }}"
                                                    {{ old('settings.' . $setting->key, $setting->value) === $optionValue ? 'selected' : '' }}>
                                                    {{ $optionLabel }}
                                                </option>
                                            @endforeach
                                        </select>
                                    @break

                                    @case('integer')
                                        <input type="number" class="form-control" id="setting_{{ $setting->key }}"
                                            name="settings[{{ $setting->key }}]"
                                            value="{{ old('settings.' . $setting->key, $setting->value) }}" min="0">
                                    @break

                                    @case('image')
                                        <div class="setting-dropzone" id="dropzone_{{ $setting->key }}">
                                            <input type="file" name="settings[{{ $setting->key }}]"
                                                id="file_{{ $setting->key }}" class="d-none file-input"
                                                accept="image/png, image/jpeg, image/jpg, image/webp"
                                                data-key="{{ $setting->key }}">

                                            <!-- Input oculto para manejar el borrado -->
                                            <!-- Si el usuario borra la imagen, este input enviará __DELETE__ -->
                                            <!-- Si no se toca, enviará el valor actual (o vacío si no hay) -->
                                            <!-- Pero como file input no retiene valor, necesitamos lógica JS para esto -->
                                            <input type="hidden" name="settings[{{ $setting->key }}]"
                                                id="hidden_{{ $setting->key }}"
                                                value="{{ old('settings.' . $setting->key, $setting->value) }}">

                                            <div class="dz-message {{ $setting->value ? 'd-none' : '' }}">
                                                <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                                <h5>Arrastra tu imagen aquí</h5>
                                                <p class="text-muted small mb-0">o haz clic para seleccionar</p>
                                                <p class="text-xs text-muted mt-1">(PNG, JPG, WEBP - Max 2MB)</p>
                                            </div>

                                            <div class="dz-preview {{ $setting->value ? '' : 'd-none' }}">
                                                <div class="preview-container">
                                                    @if ($setting->value)
                                                        <img src="{{ Storage::url($setting->value) }}" class="img-preview"
                                                            id="preview_{{ $setting->key }}">
                                                    @else
                                                        <img src="" class="img-preview" id="preview_{{ $setting->key }}">
                                                    @endif
                                                    <div class="preview-overlay">
                                                        <button type="button" class="btn btn-danger btn-circle btn-remove"
                                                            data-key="{{ $setting->key }}">
                                                            <i class="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    @break

                                    @default
                                        <input type="text" class="form-control" id="setting_{{ $setting->key }}"
                                            name="settings[{{ $setting->key }}]"
                                            value="{{ old('settings.' . $setting->key, $setting->value) }}" maxlength="255">
                                @endswitch

                                @if ($setting->description)
                                    <small class="form-text text-muted">{{ $setting->description }}</small>
                                @endif
                            </div>
                        </div>
                        @empty
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> No hay configuraciones en este grupo.
                                </div>
                            </div>
                        @endforelse
                    </div>

                    @if ($settings->count() > 0)
                        <hr>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Configuración
                            </button>
                        </div>
                    @endif
                </form>
            </div>
        </div>
    @stop

    @section('css')
        <style>
            .setting-dropzone {
                border: 2px dashed #cbd5e1;
                border-radius: 12px;
                background: #f8fafc;
                min-height: 200px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                cursor: pointer;
                transition: all 0.3s ease;
                position: relative;
                overflow: hidden;
            }

            .setting-dropzone:hover,
            .setting-dropzone.dragover {
                border-color: #3b82f6;
                background: #eff6ff;
            }

            .dz-message {
                text-align: center;
                pointer-events: none;
            }

            .preview-container {
                position: relative;
                display: inline-block;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                background: white;
                /* Para transparencias en PNG/WEBP */
            }

            .img-preview {
                max-height: 180px;
                max-width: 100%;
                display: block;
                transition: transform 0.3s ease;
            }

            .preview-container:hover .img-preview {
                transform: scale(1.05);
            }

            .preview-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.3);
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.2s ease;
            }

            .preview-container:hover .preview-overlay {
                opacity: 1;
            }

            .btn-circle {
                width: 40px;
                height: 40px;
                padding: 0;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                margin: 5px;
            }
        </style>
    @stop

    @section('js')
        <script>
            $(document).ready(function() {
                // Manejo global para todas las dropzones
                $('.setting-dropzone').each(function() {
                    const zone = $(this);
                    const key = zone.find('.file-input').data('key');
                    const fileInput = zone.find('#file_' + key);
                    const hiddenInput = zone.find('#hidden_' + key);
                    const removeBtn = zone.find('.btn-remove');

                    // Click en zona -> Click en input
                    zone.on('click', function(e) {
                        if ($(e.target).closest('.btn-remove').length)
                            return; // Si es botón eliminar, no abrir
                        if ($(e.target).is(fileInput))
                            return; // Evitar recursión si el evento viene del input
                        fileInput.trigger('click');
                    });

                    // Detener propagación del click en el input para seguridad extra
                    fileInput.on('click', function(e) {
                        e.stopPropagation();
                    });

                    // Drag & Drop events
                    zone.on('dragover dragenter', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        zone.addClass('dragover');
                    });

                    zone.on('dragleave drop', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        zone.removeClass('dragover');
                    });

                    zone.on('drop', function(e) {
                        const files = e.originalEvent.dataTransfer.files;
                        if (files.length > 0) {
                            fileInput[0].files = files; // Asignar al input
                            handleFile(files[0], zone, key);
                        }
                    });

                    // Change input
                    fileInput.on('change', function() {
                        if (this.files.length > 0) {
                            handleFile(this.files[0], zone, key);
                        }
                    });

                    // Remove image
                    removeBtn.on('click', function(e) {
                        e.stopPropagation(); // Evitar abrir file explorer
                        e.preventDefault();

                        // Limpiar preview
                        zone.find('.dz-message').removeClass('d-none');
                        zone.find('.dz-preview').addClass('d-none');
                        zone.find('.file-name').text('');
                        zone.find('.img-preview').attr('src', '');

                        // Limpiar input file
                        fileInput.val('');

                        // Marcar para borrado en backend
                        hiddenInput.val('__DELETE__');
                        // Necesitamos asegurar que el input file no se mande si está vacío, 
                        // o que el backend priorice el hiddenInput si tiene __DELETE__
                        // El controller ya tiene lógica para esto.
                    });
                });

                function handleFile(file, zone, key) {
                    // Validar imagen
                    if (!file.type.startsWith('image/')) {
                        Swal.fire('Error', 'Solo se permiten imágenes (JPG, PNG, WEBP)', 'error');
                        return;
                    }

                    if (file.size > 2 * 1024 * 1024) { // 2MB
                        Swal.fire('Error', 'La imagen no debe pesar más de 2MB', 'error');
                        return;
                    }

                    // Preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        zone.find('.img-preview').attr('src', e.target.result);
                        zone.find('.filename').text(file.name);

                        zone.find('.dz-message').addClass('d-none');
                        zone.find('.dz-preview').removeClass('d-none');

                        // Limpiar el flag de borrado si existía
                        zone.find('#hidden_' + key).val(file
                            .name); // Valor temporal, no se usa en backend si va file
                    }
                    reader.readAsDataURL(file);
                }
            });
        </script>
    @stop
</file>

<file path="resources/views/admin/units/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nueva Unidad de Medida')

@section('content_header')
@stop

@section('content')
    <br>
    <!-- Centered Card -->
    <!-- Centered Card -->
    <div class="row">
        <div class="col-12 col-md-6 col-lg-4">

            {{-- MENSAJES FLASH --}}
            @foreach (['success', 'error', 'info'] as $msg)
                @if (session($msg))
                    <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show"
                        role="alert">
                        {{ session($msg) }}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                @endif
            @endforeach

            {{-- ERRORES DE VALIDACIÓN --}}
            @if ($errors->any())
                <div class="alert alert-danger alert-dismissible fade show">
                    <strong>Se encontraron errores:</strong>
                    <ul class="mb-0 mt-2">
                        @foreach ($errors->all() as $error)
                            <li>{{ $error }}</li>
                        @endforeach
                    </ul>
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            @endif

            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-plus-circle mr-2"></i>Nueva Unidad de Medida
                    </h3>
                </div>

                <div class="card-body">
                    <form method="post" action="{{ route('admin.units.store') }}">
                        @csrf

                        <div class="form-group">
                            <label>Nombre <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control @error('name') is-invalid @enderror"
                                value="{{ old('name') }}" placeholder="Ej: Metro, Rollo, Cono" required>
                            @error('name')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="form-group">
                            <label>Símbolo <span class="text-danger">*</span></label>
                            <input type="text" name="symbol" class="form-control @error('symbol') is-invalid @enderror"
                                value="{{ old('symbol') }}" placeholder="Ej: m, pz, cono" required>
                            @error('symbol')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">Abreviación corta de la unidad</small>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold">Tipo de unidad</label>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="is_base" name="is_base"
                                    value="1" {{ old('is_base') ? 'checked' : '' }}>
                                <label class="custom-control-label" for="is_base">
                                    <strong>Unidad de Consumo</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1 text-info"></i>
                                <strong>Consumo:</strong> unidad en la que el material se gasta durante producción (metro,
                                litro, pieza, minuto)
                            </small>
                            <small class="form-text text-muted mt-1">
                                Si no marca esta opción, la unidad será de <strong>Compra</strong> (cono, saco, paquete)
                            </small>
                        </div>

                        <div class="form-group" id="compatible_unit_section"
                            style="{{ old('is_base') ? 'display: none;' : '' }}">
                            <label class="font-weight-bold">
                                <i class="fas fa-link text-info mr-1"></i>
                                Se convierte a (Unidad de Consumo)
                            </label>
                            <select name="compatible_base_unit_id" id="compatible_base_unit_id"
                                class="form-control @error('compatible_base_unit_id') is-invalid @enderror">
                                <option value="">-- Seleccionar unidad de consumo --</option>
                                @foreach ($baseUnits ?? [] as $baseUnit)
                                    <option value="{{ $baseUnit->id }}"
                                        {{ old('compatible_base_unit_id') == $baseUnit->id ? 'selected' : '' }}>
                                        {{ $baseUnit->name }} ({{ $baseUnit->symbol }})
                                    </option>
                                @endforeach
                            </select>
                            @error('compatible_base_unit_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Indica a qué unidad de consumo se puede convertir. Ej: ROLLO → METRO
                            </small>

                            <div class="mt-3">
                                <label class="font-weight-bold">Subtipo de Compra</label>
                                <select name="unit_type" id="unit_type"
                                    class="form-control @error('unit_type') is-invalid @enderror">
                                    <option value="logistic" {{ old('unit_type') == 'logistic' ? 'selected' : '' }}>
                                        Compra (Unidad estándar: Cono, Caja, Unidad)
                                    </option>
                                    <option value="metric_pack" {{ old('unit_type') == 'metric_pack' ? 'selected' : '' }}>
                                        Presentación (Paquete con cantidad fija: Rollo 25m, Caja 100pz)
                                    </option>
                                </select>
                                @error('unit_type')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <a href="{{ route('admin.units.index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left mr-1"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save mr-1"></i> Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            $('#is_base').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#compatible_unit_section').slideUp();
                    $('#compatible_base_unit_id').val('');
                } else {
                    $('#compatible_unit_section').slideDown();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/units/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Unidad de Medida')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="row">
        <div class="col-12 col-md-6 col-lg-4">

            <div class="card card-danger">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-trash mr-2"></i>Eliminar Unidad de Medida
                    </h3>
                </div>

                <div class="card-body">
                    <form method="post" action="{{ route('admin.units.destroy', $unit->id) }}">
                        @csrf
                        @method('DELETE')

                        <div class="form-group">
                            <label>Nombre</label>
                            <input type="text" class="form-control" value="{{ $unit->name }}" disabled>
                        </div>

                        <div class="form-group">
                            <label>Símbolo</label>
                            <input type="text" class="form-control" value="{{ $unit->symbol }}" disabled>
                        </div>

                        <div class="form-group">
                            <label>Tipo</label>
                            <div class="form-control bg-light">
                                @if ($unit->unit_type)
                                    <span class="badge badge-{{ $unit->unit_type->badgeColor() }}">
                                        <i class="fas {{ $unit->unit_type->icon() }} mr-1"></i>
                                        {{ $unit->unit_type->label() }}
                                    </span>
                                @else
                                    <span class="badge badge-secondary">Sin tipo</span>
                                @endif
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Se convierte a</label>
                            <input type="text" class="form-control"
                                value="{{ $unit->isCanonical() ? '-' : ($unit->compatibleBaseUnit->name ?? 'Sin configurar') }}"
                                disabled>
                        </div>

                        <hr>

                        @if ($unit->isCanonical() && $unit->purchaseUnits->count() > 0)
                            {{-- ADVERTENCIA CRÍTICA: Unidad de consumo con unidades vinculadas --}}
                            <div class="alert alert-danger mb-3">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-radiation fa-2x mr-3 text-danger"></i>
                                    <strong class="h5 mb-0">ADVERTENCIA CRÍTICA</strong>
                                </div>
                                <hr class="my-2">
                                <p class="mb-2">
                                    Esta unidad de consumo tiene <strong>{{ $unit->purchaseUnits->count() }}</strong>
                                    unidad(es) de compra/presentación vinculada(s) que <strong>también serán eliminadas</strong>:
                                </p>
                                <ul class="mb-2">
                                    @foreach ($unit->purchaseUnits as $purchaseUnit)
                                        <li><strong>{{ $purchaseUnit->name }}</strong> ({{ $purchaseUnit->symbol }})</li>
                                    @endforeach
                                </ul>
                            </div>

                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>Esto afectará la estabilidad del sistema:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Conversiones de materiales configuradas</li>
                                    <li>Registros históricos de compras</li>
                                    <li>Cálculos de inventario y stock</li>
                                    <li>Reportes y estadísticas relacionadas</li>
                                </ul>
                            </div>
                        @else
                            {{-- ADVERTENCIA NORMAL: Unidad sin dependencias --}}
                            <div class="alert alert-warning text-center mb-3">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                <strong>¿Deseas eliminar esta unidad de medida?</strong>
                                <p class="text-muted small mb-0 mt-2">Esta acción no se puede deshacer.</p>
                            </div>
                        @endif

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="text-right">
                                    <a href="{{ route('admin.units.index') }}" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left mr-1"></i> Regresar
                                    </a>
                                    <button type="button" class="btn btn-danger btn-confirm-delete">
                                        <i class="fas fa-trash mr-1"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            $('.btn-confirm-delete').on('click', function(e) {
                e.preventDefault();
                const form = $(this).closest('form');
                @if ($unit->isCanonical() && $unit->purchaseUnits->count() > 0)
                    Swal.fire({
                        title: '¿Confirmar eliminación?',
                        text: 'Se eliminará {{ $unit->name }} y {{ $unit->purchaseUnits->count() }} unidad(es) vinculada(s)',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: '<i class="fas fa-trash mr-1"></i> Sí, eliminar',
                        cancelButtonText: '<i class="fas fa-times mr-1"></i> Cancelar',
                        reverseButtons: true,
                        focusCancel: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                @else
                    Swal.fire({
                        title: '¿Confirmar eliminación?',
                        text: 'Se eliminará {{ $unit->name }}',
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6c757d',
                        confirmButtonText: '<i class="fas fa-trash mr-1"></i> Sí, eliminar',
                        cancelButtonText: '<i class="fas fa-times mr-1"></i> Cancelar',
                        reverseButtons: true,
                        focusCancel: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                @endif
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/units/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Unidad de Medida')

@section('content_header')
@stop

@section('content')
    <br>
    <!-- Centered Card -->
    <!-- Centered Card -->
    <div class="row">
        <div class="col-12 col-md-6 col-lg-4">

            {{-- MENSAJES FLASH --}}
            @foreach (['success', 'error', 'info'] as $msg)
                @if (session($msg))
                    <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show"
                        role="alert">
                        {{ session($msg) }}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                @endif
            @endforeach

            {{-- ERRORES DE VALIDACIÓN --}}
            @if ($errors->any())
                <div class="alert alert-danger alert-dismissible fade show">
                    <strong>Se encontraron errores:</strong>
                    <ul class="mb-0 mt-2">
                        @foreach ($errors->all() as $error)
                            <li>{{ $error }}</li>
                        @endforeach
                    </ul>
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
            @endif

            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-edit mr-2"></i>Editar Unidad de Medida
                    </h3>
                </div>

                <div class="card-body">
                    <form method="post" action="{{ route('admin.units.update', $unit->id) }}">
                        @csrf
                        @method('PUT')

                        <div class="form-group">
                            <label>Nombre <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control @error('name') is-invalid @enderror"
                                value="{{ old('name', $unit->name) }}" placeholder="Ej: Metro, Rollo, Cono" required>
                            @error('name')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="form-group">
                            <label>Símbolo <span class="text-danger">*</span></label>
                            <input type="text" name="symbol" class="form-control @error('symbol') is-invalid @enderror"
                                value="{{ old('symbol', $unit->symbol) }}" placeholder="Ej: m, pz, cono" required>
                            @error('symbol')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">Abreviación corta de la unidad</small>
                        </div>

                        <div class="form-group">
                            <label class="font-weight-bold">Tipo de unidad</label>
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="is_base" name="is_base"
                                    value="1" {{ old('is_base', $unit->is_base) ? 'checked' : '' }}>
                                <label class="custom-control-label" for="is_base">
                                    <strong>Unidad de Consumo</strong>
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1 text-info"></i>
                                <strong>Consumo:</strong> unidad en la que el material se gasta durante producción (metro,
                                litro, pieza, minuto)
                            </small>
                            <small class="form-text text-muted mt-1">
                                Si no marca esta opción, la unidad será de <strong>Compra</strong> (cono, saco, paquete)
                            </small>
                        </div>

                        <div class="form-group" id="compatible_unit_section"
                            style="{{ old('is_base', $unit->is_base) ? 'display: none;' : '' }}">
                            <label class="font-weight-bold">
                                <i class="fas fa-link text-info mr-1"></i>
                                Se convierte a (Unidad de Consumo)
                            </label>
                            <select name="compatible_base_unit_id" id="compatible_base_unit_id"
                                class="form-control @error('compatible_base_unit_id') is-invalid @enderror">
                                <option value="">-- Seleccionar unidad de consumo --</option>
                                @foreach ($baseUnits ?? [] as $baseUnit)
                                    <option value="{{ $baseUnit->id }}"
                                        {{ old('compatible_base_unit_id', $unit->compatible_base_unit_id) == $baseUnit->id ? 'selected' : '' }}>
                                        {{ $baseUnit->name }} ({{ $baseUnit->symbol }})
                                    </option>
                                @endforeach
                            </select>
                            @error('compatible_base_unit_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                            <small class="form-text text-muted">
                                <i class="fas fa-info-circle mr-1"></i>
                                Indica a qué unidad de consumo se puede convertir. Ej: ROLLO → METRO
                            </small>

                            <div class="mt-3">
                                <label class="font-weight-bold">Subtipo de Compra</label>
                                <select name="unit_type" id="unit_type"
                                    class="form-control @error('unit_type') is-invalid @enderror">
                                    <option value="logistic"
                                        {{ old('unit_type', $unit->unit_type->value) == 'logistic' ? 'selected' : '' }}>
                                        Compra (Unidad estándar: Cono, Caja, Unidad)
                                    </option>
                                    <option value="metric_pack"
                                        {{ old('unit_type', $unit->unit_type->value) == 'metric_pack' ? 'selected' : '' }}>
                                        Presentación (Paquete con cantidad fija: Rollo 25m, Caja 100pz)
                                    </option>
                                </select>
                                @error('unit_type')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>
                        </div>

                        <hr>

                        <div class="d-flex justify-content-between">
                            <a href="{{ route('admin.units.index') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left mr-1"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save mr-1"></i> Actualizar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>
@stop

@section('js')
    <script>
        $(function() {
            $('#is_base').on('change', function() {
                if ($(this).is(':checked')) {
                    $('#compatible_unit_section').slideUp();
                    $('#compatible_base_unit_id').val('');
                } else {
                    $('#compatible_unit_section').slideDown();
                }
            });
        });
    </script>
@stop
</file>

<file path="app/Http/Controllers/DesignExportController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Design;
use App\Models\DesignVariant;
use App\Models\DesignExport;
use App\Models\Application_types;
use App\Services\EmbroideryAnalyzerService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;


class DesignExportController extends Controller
{
    protected EmbroideryAnalyzerService $analyzer;

    public function __construct(EmbroideryAnalyzerService $analyzer)
    {
        $this->analyzer = $analyzer;
    }

    // =====================================================================
    // MÉTODOS CRUD ESTÁNDAR (MÓDULO INDEPENDIENTE)
    // =====================================================================

    public function index()
    {
        $exports = DesignExport::with(['design', 'variant', 'creator'])
            ->latest()
            ->paginate(20);
        $tipo_aplicacion = Application_types::activos()->orderBy('nombre_aplicacion')->get();

        return view('admin.production.index', compact('exports', 'tipo_aplicacion'));
    }

    public function create()
    {
        $designs = Design::where('is_active', true)->orderBy('name')->get();
        $applicationTypes = Application_types::activos()->orderBy('nombre_aplicacion')->get();
        return view('admin.production.create', compact('designs', 'applicationTypes'));
    }

    /**
     * Formulario de creación para un diseño específico
     */
    public function createForDesign(Design $design)
    {
        $applicationTypes = Application_types::activos()->orderBy('nombre_aplicacion')->get();
        return view('admin.designs.exports.create', compact('design', 'applicationTypes'));
    }

    /**
     * Formulario de creación para una variante específica
     */
    public function createForVariant(Design $design, DesignVariant $variant)
    {
        // Verificar que la variante pertenece al diseño
        if ($variant->design_id !== $design->id) {
            abort(404, 'Variante no encontrada para este diseño.');
        }

        $applicationTypes = Application_types::activos()->orderBy('nombre_aplicacion')->get();
        return view('admin.design-variants.exports.create', compact('design', 'variant', 'applicationTypes'));
    }

    /**
     * Guardar exportación para un diseño específico
     */
    public function storeForDesign(Request $request, Design $design)
    {
        $validated = $request->validate([
            'application_type' => 'required|string|max:50',
            'application_label' => 'required|string|max:100',
            'placement_description' => 'nullable|string|max:255',
            'file' => 'required|file|mimes:pes,dst,exp,jef,vip,vp3,xxx|max:10240',
            'notes' => 'nullable|string',
        ]);

        $file = $request->file('file');
        $fileName = $this->generateFileName(['design_id' => $design->id, 'application_label' => $validated['application_label']], $file);
        $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

        // Analizar archivo si es posible
        $analysisData = [];
        try {
            $result = $this->analyzer->analyzeFromUpload($file);
            if ($result['success']) {
                $analysisData = [
                    'stitches_count' => $result['total_stitches'] ?? null,
                    'width_mm' => $result['width_mm'] ?? null,
                    'height_mm' => $result['height_mm'] ?? null,
                    'colors_count' => $result['colors_count'] ?? null,
                    'colors_detected' => isset($result['colors']) ? json_encode($result['colors']) : null,
                    'auto_read_success' => true,
                ];
            }
        } catch (\Exception $e) {
            Log::warning('No se pudo analizar el archivo: ' . $e->getMessage());
        }

        DesignExport::create(array_merge([
            'design_id' => $design->id,
            'design_variant_id' => null,
            'application_type' => $validated['application_type'],
            'application_label' => $validated['application_label'],
            'placement_description' => $validated['placement_description'] ?? null,
            'file_name' => $file->getClientOriginalName(),
            'file_path' => $filePath,
            'file_format' => strtoupper($file->getClientOriginalExtension()),
            'file_size' => $file->getSize(),
            'mime_type' => $file->getMimeType(),
            'notes' => $validated['notes'] ?? null,
            'status' => 'borrador',
            'created_by' => Auth::id(),
        ], $analysisData));

        return redirect()->route('admin.designs.index')
            ->with('success', 'Exportación creada correctamente para el diseño.');
    }

    /**
     * Guardar exportación para una variante específica
     */
    public function storeForVariant(Request $request, Design $design, DesignVariant $variant)
    {
        if ($variant->design_id !== $design->id) {
            abort(404, 'Variante no encontrada para este diseño.');
        }

        $validated = $request->validate([
            'application_type' => 'required|string|max:50',
            'application_label' => 'required|string|max:100',
            'placement_description' => 'nullable|string|max:255',
            'file' => 'required|file|mimes:pes,dst,exp,jef,vip,vp3,xxx|max:10240',
            'notes' => 'nullable|string',
        ]);

        $file = $request->file('file');
        $fileName = $this->generateFileName([
            'design_id' => $design->id,
            'design_variant_id' => $variant->id,
            'application_label' => $validated['application_label']
        ], $file);
        $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

        // Analizar archivo si es posible
        $analysisData = [];
        try {
            $result = $this->analyzer->analyzeFromUpload($file);
            if ($result['success']) {
                $analysisData = [
                    'stitches_count' => $result['total_stitches'] ?? null,
                    'width_mm' => $result['width_mm'] ?? null,
                    'height_mm' => $result['height_mm'] ?? null,
                    'colors_count' => $result['colors_count'] ?? null,
                    'colors_detected' => isset($result['colors']) ? json_encode($result['colors']) : null,
                    'auto_read_success' => true,
                ];
            }
        } catch (\Exception $e) {
            Log::warning('No se pudo analizar el archivo: ' . $e->getMessage());
        }

        DesignExport::create(array_merge([
            'design_id' => $design->id,
            'design_variant_id' => $variant->id,
            'application_type' => $validated['application_type'],
            'application_label' => $validated['application_label'],
            'placement_description' => $validated['placement_description'] ?? null,
            'file_name' => $file->getClientOriginalName(),
            'file_path' => $filePath,
            'file_format' => strtoupper($file->getClientOriginalExtension()),
            'file_size' => $file->getSize(),
            'mime_type' => $file->getMimeType(),
            'notes' => $validated['notes'] ?? null,
            'status' => 'borrador',
            'created_by' => Auth::id(),
        ], $analysisData));

        return redirect()->route('admin.designs.index')
            ->with('success', 'Exportación creada correctamente para la variante.');
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'design_id' => 'required|exists:designs,id',
            'design_variant_id' => 'nullable|exists:design_variants,id',
            'application_type' => 'required|exists:application_types,id',
            'application_label' => 'required|string|max:100',
            'placement_description' => 'nullable|string|max:255',
            'file' => 'required|file|mimes:pes,dst,exp,jef,vip,vp3,xxx|max:10240',
            'stitches_count' => 'nullable|integer|min:0',
            'width_mm' => 'nullable|integer|min:0',
            'height_mm' => 'nullable|integer|min:0',
            'colors_count' => 'nullable|integer|min:0',
            'colors_detected' => 'nullable|json',
            'notes' => 'nullable|string',
        ]);

        if ($request->hasFile('file')) {
            $file = $request->file('file');
            $fileName = $this->generateFileName($validated, $file);
            $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

            $validated['file_name'] = $file->getClientOriginalName();
            $validated['file_path'] = $filePath;
            $validated['file_format'] = strtoupper($file->getClientOriginalExtension());
            $validated['file_size'] = $file->getSize();
            $validated['mime_type'] = $file->getMimeType();
        }

        $validated['created_by'] = Auth::id();
        $validated['status'] = 'borrador';

        DesignExport::create($validated);

        return redirect()->route('admin.production.index')
            ->with('success', 'Exportación creada correctamente.');
    }

    public function show(DesignExport $export)
    {
        $export->load(['design', 'variant', 'creator', 'approver']);
        return view('admin.production.show', compact('export'));
    }

    public function edit(DesignExport $export)
    {
        $export->load(['design', 'variant']);
        $designs = Design::where('is_active', true)->orderBy('name')->get();
        $variants = $export->design ? $export->design->variants : collect();

        return view('admin.production.edit', compact('export', 'designs', 'variants'));
    }

    public function update(Request $request, DesignExport $export)
    {
        $validated = $request->validate([
            'design_id' => 'required|exists:designs,id',
            'design_variant_id' => 'nullable|exists:design_variants,id',
            'application_type' => 'required|string|max:50',
            'application_label' => 'required|string|max:100',
            'placement_description' => 'nullable|string|max:255',
            'file' => 'nullable|file|mimes:pes,dst,exp,jef,vip,vp3,xxx|max:10240',
            'stitches_count' => 'nullable|integer|min:0',
            'width_mm' => 'nullable|integer|min:0',
            'height_mm' => 'nullable|integer|min:0',
            'colors_count' => 'nullable|integer|min:0',
            'colors_detected' => 'nullable|json',
            'status' => 'required|in:borrador,pendiente,aprobado,archivado',
            'notes' => 'nullable|string',
        ]);

        if ($request->hasFile('file')) {
            if ($export->file_path && Storage::disk('public')->exists($export->file_path)) {
                Storage::disk('public')->delete($export->file_path);
            }

            $file = $request->file('file');
            $fileName = $this->generateFileName($validated, $file);
            $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

            $validated['file_name'] = $file->getClientOriginalName();
            $validated['file_path'] = $filePath;
            $validated['file_format'] = strtoupper($file->getClientOriginalExtension());
            $validated['file_size'] = $file->getSize();
            $validated['mime_type'] = $file->getMimeType();
            $validated['auto_read_success'] = false;
        }

        if ($validated['status'] === 'aprobado' && $export->status !== 'aprobado') {
            $validated['approved_by'] = Auth::id();
            $validated['approved_at'] = now();
        } elseif ($validated['status'] !== 'aprobado') {
            $validated['approved_by'] = null;
            $validated['approved_at'] = null;
        }

        $export->update($validated);

        return redirect()->route('admin.production.index')
            ->with('success', 'Exportación actualizada correctamente.');
    }

    public function destroy(DesignExport $export)
    {
        if ($export->file_path && Storage::disk('public')->exists($export->file_path)) {
            Storage::disk('public')->delete($export->file_path);
        }

        $export->delete();

        return redirect()->route('admin.production.index')
            ->with('success', 'Exportación eliminada correctamente.');
    }

    public function download(DesignExport $export)
    {
        if (!$export->file_path || !Storage::disk('public')->exists($export->file_path)) {
            return back()->with('error', 'Archivo no encontrado.');
        }

        return response()->download(Storage::disk('public')->path($export->file_path), $export->file_name);
    }

    // =====================================================================
    // MÉTODOS AJAX PARA EL MODAL
    // =====================================================================

    public function analyzeFile(Request $request)
    {
        try {
            $request->validate(['file' => 'required|file|max:10240']);

            $file = $request->file('file');
            $extension = strtolower($file->getClientOriginalExtension());

            if (!$this->analyzer->isValidExtension($extension)) {
                return response()->json([
                    'success' => false,
                    'error' => "Formato no soportado: .{$extension}. Formatos permitidos: " .
                        $this->analyzer->getAllowedExtensionsString()
                ], 400);
            }

            // Copiar archivo a temporal para análisis y SVG
            $originalPath = $file->getRealPath();
            $tempPath = tempnam(sys_get_temp_dir(), 'emb_') . '.' . $extension;

            if (!copy($originalPath, $tempPath)) {
                return response()->json([
                    'success' => false,
                    'error' => 'Error al procesar el archivo.',
                    'allow_manual' => true
                ], 500);
            }

            try {
                $result = $this->analyzer->analyzeFromPath($tempPath);

                // Generar SVG para vista previa
                $svgContent = '';
                if ($result['success']) {
                    $svgContent = $this->analyzer->generateSvg($tempPath);
                }

                if ($result['success']) {
                    return response()->json([
                        'success' => true,
                        'data' => [
                            'file_name' => $file->getClientOriginalName(),
                            'file_format' => $result['file_format'] ?? strtoupper($extension),
                            'file_size' => filesize($tempPath),
                            'total_stitches' => $result['total_stitches'],
                            'stitches_count' => $result['total_stitches'],
                            'colors_count' => $result['colors_count'],
                            'width_mm' => $result['width_mm'],
                            'height_mm' => $result['height_mm'],
                            'colors' => $result['colors'],
                            'dimensions_formatted' => "{$result['width_mm']} x {$result['height_mm']} mm",
                            'stitches_formatted' => number_format($result['total_stitches'], 0, '.', ','),
                            'svg_content' => $svgContent,
                        ]
                    ]);
                } else {
                    return response()->json([
                        'success' => false,
                        'error' => $result['error'] ?? 'Error al analizar el archivo.',
                        'allow_manual' => true
                    ], 400);
                }
            } finally {
                // Cleanup temp file
                if (file_exists($tempPath)) {
                    @unlink($tempPath);
                }
            }
        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'error' => 'Archivo no válido o demasiado grande (máximo 10MB).'
            ], 400);
        } catch (\Exception $e) {
            Log::error('Error en analyzeFile: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error interno al procesar el archivo.',
                'allow_manual' => true
            ], 500);
        }
    }

    public function storeAjax(Request $request)
    {
        try {
            $validated = $request->validate([
                'design_id' => 'required|exists:designs,id',
                'design_variant_id' => 'nullable|exists:design_variants,id',
                'image_id' => 'nullable|exists:images,id',
                'application_type' => ['required', 'string', 'max:50', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_]+$/'],
                'application_label' => ['required', 'string', 'max:100', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/#]+$/'],
                'placement_description' => ['nullable', 'string', 'max:255', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/#]*$/'],
                'file' => 'required|file|max:10240',
                'stitches_count' => 'nullable|integer|min:0',
                'width_mm' => 'nullable|numeric|min:0',
                'height_mm' => 'nullable|numeric|min:0',
                'colors_count' => 'nullable|integer|min:0',
                'colors_detected' => 'nullable',
                'notes' => ['nullable', 'string', 'max:1000', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/\n\r#@!?]*$/'],
                'auto_read_success' => 'nullable|boolean',
                'svg_content' => 'nullable|string', // Validar SVG content
            ], [
                'application_type.regex' => 'El tipo de aplicación contiene caracteres no permitidos.',
                'application_label.regex' => 'La etiqueta contiene caracteres no permitidos (evita: ´¨{}|<>\\`)',
                'placement_description.regex' => 'La descripción contiene caracteres no permitidos.',
                'notes.regex' => 'Las notas contienen caracteres no permitidos.',
            ]);

            $file = $request->file('file');
            $extension = strtolower($file->getClientOriginalExtension());

            if (!$this->analyzer->isValidExtension($extension)) {
                return response()->json([
                    'success' => false,
                    'error' => "Formato no soportado: .{$extension}"
                ], 400);
            }

            $fileName = $this->generateFileName($validated, $file);
            $filePath = $file->storeAs('exports/' . date('Y') . '/' . date('m'), $fileName, 'public');

            $exportData = [
                'design_id' => $validated['design_id'],
                'design_variant_id' => $validated['design_variant_id'] ?? null,
                'image_id' => $validated['image_id'] ?? null,
                'application_type' => $this->sanitizeText($validated['application_type']),
                'application_label' => $this->sanitizeText($validated['application_label']),
                'placement_description' => $this->sanitizeText($validated['placement_description'] ?? null),
                'file_name' => $file->getClientOriginalName(),
                'file_path' => $filePath,
                'file_format' => strtoupper($extension),
                'file_size' => $file->getSize(),
                'mime_type' => $file->getMimeType(),
                'stitches_count' => $validated['stitches_count'] ?? null,
                'width_mm' => isset($validated['width_mm']) ? round($validated['width_mm']) : null,
                'height_mm' => isset($validated['height_mm']) ? round($validated['height_mm']) : null,
                'colors_count' => $validated['colors_count'] ?? null,
                'colors_detected' => isset($validated['colors_detected']) ?
                    (is_string($validated['colors_detected']) ? $validated['colors_detected'] : json_encode($validated['colors_detected'])) : null,
                'notes' => $this->sanitizeText($validated['notes'] ?? null),
                'status' => 'borrador',
                'created_by' => Auth::id(),
                'auto_read_success' => $request->boolean('auto_read_success', false),
                'svg_content' => $validated['svg_content'] ?? null, // Guardar SVG
            ];

            $export = DesignExport::create($exportData);
            $export->load(['creator:id,name']);

            return response()->json([
                'success' => true,
                'message' => 'Exportación creada correctamente.',
                'data' => $this->formatExportForJson($export)
            ]);
        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'error' => $e->errors()[array_key_first($e->errors())][0] ?? 'Datos inválidos.',
                'errors' => $e->errors()
            ], 422);
        } catch (\Exception $e) {
            Log::error('Error en storeAjax: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error al guardar: ' . $e->getMessage()
            ], 500);
        }
    }

    public function updateAjax(Request $request, DesignExport $export)
    {
        try {
            $validated = $request->validate([
                'application_type' => ['required', 'string', 'max:50', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_]+$/'],
                'application_label' => ['required', 'string', 'max:100', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/#]+$/'],
                'placement_description' => ['nullable', 'string', 'max:255', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/#]*$/'],
                'notes' => ['nullable', 'string', 'max:1000', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑüÜ\s\-_.,;:()\/\n\r#@!?]*$/'],
                'stitches_count' => 'nullable|integer|min:0',
                'width_mm' => 'nullable|numeric|min:0',
                'height_mm' => 'nullable|numeric|min:0',
                'colors_count' => 'nullable|integer|min:0',
                'svg_content' => 'nullable|string', // Validar SVG content
            ], [
                'application_type.regex' => 'El tipo de aplicación contiene caracteres no permitidos.',
                'application_label.regex' => 'La etiqueta contiene caracteres no permitidos. Evita usar: ´ ¨ { } | < > \\ `',
                'placement_description.regex' => 'La descripción contiene caracteres no permitidos.',
                'notes.regex' => 'Las notas contienen caracteres no permitidos.',
            ]);

            $export->update([
                'application_type' => $this->sanitizeText($validated['application_type']),
                'application_label' => $this->sanitizeText($validated['application_label']),
                'placement_description' => $this->sanitizeText($validated['placement_description'] ?? null),
                'notes' => $this->sanitizeText($validated['notes'] ?? null),
                'stitches_count' => $validated['stitches_count'] ?? $export->stitches_count,
                'width_mm' => $validated['width_mm'] ?? $export->width_mm,
                'height_mm' => $validated['height_mm'] ?? $export->height_mm,
                'colors_count' => $validated['colors_count'] ?? $export->colors_count,
                'svg_content' => $validated['svg_content'] ?? $export->svg_content, // Actualizar SVG
            ]);

            $export->load(['creator:id,name', 'approver:id,name']);

            return response()->json([
                'success' => true,
                'message' => 'Exportación actualizada.',
                'data' => $this->formatExportForJson($export)
            ]);
        } catch (\Illuminate\Validation\ValidationException $e) {
            return response()->json([
                'success' => false,
                'error' => $e->errors()[array_key_first($e->errors())][0] ?? 'Datos inválidos.',
                'errors' => $e->errors()
            ], 422);
        } catch (\Exception $e) {
            Log::error('Error en updateAjax: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error al actualizar.'
            ], 500);
        }
    }

    public function updateStatus(Request $request, DesignExport $export)
    {
        try {
            $validated = $request->validate([
                'status' => 'required|in:borrador,pendiente,aprobado,archivado',
            ]);

            $previousStatus = $export->status;
            $newStatus = $validated['status'];

            // Solo registrar si el estado realmente cambió
            if ($previousStatus !== $newStatus) {
                // Registrar en historial de cambios de estado
                \App\Models\DesignExportStatusHistory::create([
                    'design_export_id' => $export->id,
                    'previous_status' => $previousStatus,
                    'new_status' => $newStatus,
                    'changed_by' => Auth::id(),
                    'notes' => $request->input('notes'),
                ]);
            }

            $updateData = ['status' => $newStatus];

            if ($newStatus === 'aprobado' && $export->status !== 'aprobado') {
                $updateData['approved_by'] = Auth::id();
                $updateData['approved_at'] = now();
            } elseif ($newStatus !== 'aprobado' && $export->status === 'aprobado') {
                $updateData['approved_by'] = null;
                $updateData['approved_at'] = null;
            }

            $export->update($updateData);
            $export->load(['approver:id,name']);

            return response()->json([
                'success' => true,
                'message' => 'Estado actualizado.',
                'data' => [
                    'id' => $export->id,
                    'status' => $export->status,
                    'status_label' => $this->getStatusLabel($export->status),
                    'status_color' => $this->getStatusColor($export->status),
                    'approved_by' => $export->approver?->name,
                    'approved_at' => $export->approved_at?->format('d/m/Y H:i'),
                ]
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'error' => 'Error al actualizar estado.'], 500);
        }
    }

    public function getExportsCount(Design $design)
    {
        try {
            $count = DesignExport::where('design_id', $design->id)->count();
            return response()->json(['success' => true, 'count' => $count, 'design_id' => $design->id]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'count' => 0], 500);
        }
    }

    /**
     * Obtener contador de exportaciones del diseño que NO tienen image_id específico.
     * Esto es para mostrar en el badge de la imagen principal del diseño.
     */
    public function getExportsWithoutImageCount(Design $design)
    {
        try {
            // Contar producciones del diseño que no tienen image_id (diseño general)
            $count = DesignExport::where('design_id', $design->id)
                ->whereNull('image_id')
                ->whereNull('design_variant_id')
                ->count();

            return response()->json([
                'success' => true,
                'count' => $count,
                'design_id' => $design->id
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'count' => 0], 500);
        }
    }

    /**
     * Obtener contador de exportaciones para una imagen específica.
     */
    public function getImageExportsCount($imageId)
    {
        try {
            $count = DesignExport::where('image_id', $imageId)->count();
            return response()->json([
                'success' => true,
                'count' => $count,
                'image_id' => $imageId
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'count' => 0], 500);
        }
    }

    /**
     * Obtener contadores de exportaciones para múltiples imágenes (batch).
     * Reduce múltiples peticiones AJAX a una sola.
     */
    public function getImagesExportsCounts(Request $request)
    {
        try {
            $imageIds = $request->input('image_ids', []);

            if (empty($imageIds)) {
                return response()->json(['success' => true, 'counts' => []]);
            }

            // Una sola consulta para todos los contadores
            $counts = DesignExport::whereIn('image_id', $imageIds)
                ->selectRaw('image_id, COUNT(*) as count')
                ->groupBy('image_id')
                ->pluck('count', 'image_id')
                ->toArray();

            // Asegurar que todas las imágenes tengan un contador (0 si no hay)
            $result = [];
            foreach ($imageIds as $id) {
                $result[$id] = $counts[$id] ?? 0;
            }

            return response()->json([
                'success' => true,
                'counts' => $result
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'counts' => []], 500);
        }
    }

    /**
     * Obtener exportaciones vinculadas a una imagen específica.
     */
    public function getImageExports($imageId)
    {
        try {
            $exports = DesignExport::where('image_id', $imageId)
                ->with(['creator:id,name', 'design:id,name', 'variant:id,name'])
                ->orderByDesc('created_at')
                ->get()
                ->map(fn($e) => $this->formatExportForJson($e));

            return response()->json([
                'success' => true,
                'data' => $exports,
                'count' => $exports->count(),
                'image_id' => $imageId
            ]);
        } catch (\Exception $e) {
            Log::error('Error al obtener exportaciones de imagen: ' . $e->getMessage());
            return response()->json(['success' => false, 'data' => [], 'count' => 0], 500);
        }
    }

    public function getExport(DesignExport $export)
    {
        try {
            $export->load(['creator:id,name', 'approver:id,name', 'design:id,name', 'variant:id,name']);
            return response()->json(['success' => true, 'data' => $this->formatExportForJson($export)]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'error' => 'Error al cargar.'], 500);
        }
    }

    public function destroyAjax(DesignExport $export)
    {
        try {
            if ($export->file_path && Storage::disk('public')->exists($export->file_path)) {
                Storage::disk('public')->delete($export->file_path);
            }
            $export->delete();
            return response()->json(['success' => true, 'message' => 'Exportación eliminada.']);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'error' => 'Error al eliminar.'], 500);
        }
    }

    public function getApplicationTypes()
    {
        try {
            $tipos = Application_types::activos()
                ->orderBy('nombre_aplicacion')
                ->get()
                ->map(function ($tipo) {
                    return [
                        'value' => $tipo->slug,
                        'label' => $tipo->nombre_aplicacion,
                        'id' => $tipo->id,
                    ];
                });

            return response()->json([
                'success' => true,
                'data' => $tipos
            ]);
        } catch (\Exception $e) {
            Log::error('Error al obtener tipos de aplicación: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'error' => 'Error al cargar tipos de aplicación',
                'data' => []
            ], 500);
        }
    }

    public function getAllowedExtensions()
    {
        return response()->json([
            'success' => true,
            'data' => $this->analyzer->getAllowedExtensions(),
            'string' => $this->analyzer->getAllowedExtensionsString()
        ]);
    }

    /**
     * Obtener exportaciones de un diseño (sin variante específica)
     * Usado cuando se ve una variante específica
     */
    public function getDesignExports(Design $design)
    {
        try {
            $exports = DesignExport::where('design_id', $design->id)
                ->whereNull('design_variant_id')
                ->with(['creator:id,name', 'approver:id,name'])
                ->latest()
                ->get()
                ->map(fn($export) => $this->formatExportForJson($export));

            return response()->json(['success' => true, 'data' => $exports, 'count' => $exports->count()]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'data' => []], 500);
        }
    }

    /**
     * AJAX: Obtener contador de exportaciones de un diseño (sin incluir variantes)
     * Usado por el contador de producción en la pestaña del modal
     */
    public function getDesignExportsCount(Design $design)
    {
        try {
            // Contar exportaciones directas del diseño (sin variant_id)
            $count = DesignExport::where('design_id', $design->id)
                ->whereNull('design_variant_id')
                ->count();

            return response()->json([
                'success' => true,
                'count' => $count,
                'design_id' => $design->id
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'count' => 0], 500);
        }
    }

    /**
     * Obtener exportaciones de una variante específica
     */
    public function getVariantExports(Design $design, DesignVariant $variant)
    {
        try {
            if ($variant->design_id != $design->id) {
                return response()->json(['success' => false, 'message' => 'Variante inválida.', 'data' => []], 400);
            }

            $exports = DesignExport::where('design_variant_id', $variant->id)
                ->with(['creator:id,name', 'approver:id,name'])
                ->latest()
                ->get()
                ->map(fn($export) => $this->formatExportForJson($export));

            // Calcular resumen de estados
            $summary = [
                'borrador' => $exports->where('status', 'borrador')->count(),
                'pendiente' => $exports->where('status', 'pendiente')->count(),
                'aprobado' => $exports->where('status', 'aprobado')->count(),
                'archivado' => $exports->where('status', 'archivado')->count(),
            ];

            return response()->json([
                'success' => true,
                'data' => $exports,
                'count' => $exports->count(),
                'summary' => $summary,
                'context' => 'variant',
                'context_name' => $variant->name,
                'context_id' => $variant->id
            ]);
        } catch (\Exception $e) {
            return response()->json(['success' => false, 'data' => []], 500);
        }
    }

    /**
     * ⭐ NUEVO MÉTODO: Obtener TODAS las exportaciones de un diseño agrupadas por variante
     * Usado cuando se está en la imagen principal del diseño
     */
    public function getAllDesignExportsGrouped(Design $design)
    {
        try {
            $design->load(['variants' => function ($query) {
                $query->with(['images' => function ($q) {
                    $q->orderBy('order')->limit(1);
                }]);
            }]);

            // Obtener TODAS las exportaciones del diseño
            $allExports = DesignExport::where('design_id', $design->id)
                ->with([
                    'creator:id,name',
                    'approver:id,name',
                    'variant:id,name',
                    'variant.images',
                    'image',
                    'design.primaryImage'
                ])
                ->latest()
                ->get();

            // Calcular resumen global de estados
            $summary = [
                'borrador' => $allExports->where('status', 'borrador')->count(),
                'pendiente' => $allExports->where('status', 'pendiente')->count(),
                'aprobado' => $allExports->where('status', 'aprobado')->count(),
                'archivado' => $allExports->where('status', 'archivado')->count(),
            ];

            // Agrupar por variante
            $groups = [];

            // Grupo 1: Exportaciones del diseño principal (sin variante)
            $designExports = $allExports->whereNull('design_variant_id')->values();
            if ($designExports->count() > 0) {
                $groups[] = [
                    'type' => 'design',
                    'name' => 'Diseño Principal',
                    'variant_id' => null,
                    'thumbnail' => $design->primaryImage ? asset('storage/' . $design->primaryImage->file_path) : null,
                    'count' => $designExports->count(),
                    'exports' => $designExports->map(fn($export) => $this->formatExportForJson($export))->values()
                ];
            }

            // Grupos por cada variante
            foreach ($design->variants as $variant) {
                $variantExports = $allExports->where('design_variant_id', $variant->id)->values();
                if ($variantExports->count() > 0) {
                    $thumbnail = null;
                    if ($variant->images && $variant->images->count() > 0) {
                        $thumbnail = asset('storage/' . $variant->images->first()->file_path);
                    }

                    $groups[] = [
                        'type' => 'variant',
                        'name' => $variant->name,
                        'variant_id' => $variant->id,
                        'thumbnail' => $thumbnail,
                        'count' => $variantExports->count(),
                        'exports' => $variantExports->map(fn($export) => $this->formatExportForJson($export))->values()
                    ];
                }
            }

            // Lista de variantes para el filtro
            $variantsList = $design->variants->map(function ($v) use ($allExports) {
                return [
                    'id' => $v->id,
                    'name' => $v->name,
                    'count' => $allExports->where('design_variant_id', $v->id)->count()
                ];
            })->values();

            return response()->json([
                'success' => true,
                'context' => 'design',
                'design_id' => $design->id,
                'design_name' => $design->name,
                'total_count' => $allExports->count(),
                'summary' => $summary,
                'groups' => $groups,
                'variants_list' => $variantsList
            ]);
        } catch (\Exception $e) {
            Log::error('Error en getAllDesignExportsGrouped: ' . $e->getMessage());
            return response()->json(['success' => false, 'error' => 'Error al cargar exportaciones.'], 500);
        }
    }

    // =====================================================================
    // MÉTODOS PRIVADOS
    // =====================================================================

    private function sanitizeText(?string $text): ?string
    {
        if ($text === null) return null;

        $text = strip_tags($text);
        $dangerousChars = ['<', '>', '"', "'", '&', '\\', '`', '{', '}', '|', '´', '¨', '^', '~'];
        $text = str_replace($dangerousChars, '', $text);
        $text = preg_replace('/\s+/', ' ', $text);

        return trim($text);
    }

    private function formatExportForJson(DesignExport $export): array
    {
        $colors = [];
        if ($export->colors_detected) {
            try {
                $colors = is_string($export->colors_detected)
                    ? json_decode($export->colors_detected, true)
                    : $export->colors_detected;
            } catch (\Exception $e) {
                $colors = [];
            }
        }

        // Determinar la imagen a mostrar (vinculada, de variante o del diseño)
        $imageUrl = null;
        if ($export->image_id && $export->image) {
            // Imagen vinculada directamente
            $imageUrl = asset('storage/' . $export->image->file_path);
        } elseif ($export->variant && $export->variant->images->count() > 0) {
            // Primera imagen de la variante
            $imageUrl = asset('storage/' . $export->variant->images->first()->file_path);
        } elseif ($export->design && $export->design->primaryImage) {
            // Imagen principal del diseño
            $imageUrl = asset('storage/' . $export->design->primaryImage->file_path);
        }

        return [
            'id' => $export->id,
            'design_id' => $export->design_id,
            'design_variant_id' => $export->design_variant_id,
            'image_id' => $export->image_id,
            'image_url' => $imageUrl,
            'variant_name' => $export->variant?->name ?? null,
            'application_label' => $export->application_label ?? 'Sin nombre',
            'application_type' => $export->application_type,
            'application_type_label' => $this->getApplicationTypeLabel($export->application_type),
            'placement_description' => $export->placement_description,
            'file_name' => $export->file_name,
            'file_format' => $export->file_format,
            'file_size' => $export->file_size,
            'file_size_formatted' => $this->formatFileSize($export->file_size),
            'stitches_count' => $export->stitches_count ?? 0,
            'stitches_formatted' => $export->stitches_count ? number_format($export->stitches_count, 0, '.', ',') : '--',
            'dimensions_formatted' => ($export->width_mm && $export->height_mm)
                ? "{$export->width_mm} x {$export->height_mm} mm" : '--',
            'width_mm' => $export->width_mm,
            'height_mm' => $export->height_mm,
            'colors_count' => $export->colors_count ?? 0,
            'colors_detected' => $colors,
            'status' => $export->status ?? 'borrador',
            'status_label' => $this->getStatusLabel($export->status),
            'status_color' => $this->getStatusColor($export->status),
            'auto_read_success' => (bool) $export->auto_read_success,
            'svg_content' => $export->svg_content, // Retornar SVG content
            'notes' => $export->notes,
            'created_at' => $export->created_at->format('d/m/Y H:i'),
            'updated_at' => $export->updated_at->format('d/m/Y H:i'),
            'creator_name' => $export->creator->name ?? 'Sistema',
            'approver_name' => $export->approver->name ?? null,
            'approved_at' => $export->approved_at?->format('d/m/Y H:i'),
            'download_url' => route('admin.production.download', $export),
            'edit_url' => route('admin.production.edit', $export),
        ];
    }

    private function generateFileName(array $data, $file): string
    {
        $designId = $data['design_id'] ?? '0';
        $variantId = $data['design_variant_id'] ?? '0';
        $application = Str::slug(substr($data['application_label'] ?? 'export', 0, 30));
        $timestamp = time();
        $extension = $file->getClientOriginalExtension();
        return "d{$designId}_v{$variantId}_{$application}_{$timestamp}.{$extension}";
    }

    private function getApplicationTypeLabel(?string $type): string
    {
        $labels = [
            'pecho'           => 'Pecho',
            'espalda'         => 'Espalda',
            'manga_izquierda' => 'Manga Izquierda',
            'manga_izq'       => 'Manga Izquierda', // Alias
            'manga_derecha'   => 'Manga Derecha',
            'manga_der'       => 'Manga Derecha',   // Alias
            'gorra'           => 'Gorra',
            'bolsillo'        => 'Bolsillo',
            'cuello'          => 'Cuello',
            'nuca'            => 'Nuca (Espalda)',
            'parche'          => 'Parche',
            'otro'            => 'Otro',
        ];
        return $labels[$type] ?? ucfirst($type ?? 'Desconocido');
    }

    private function getStatusLabel(?string $status): string
    {
        $labels = ['borrador' => 'Borrador', 'pendiente' => 'Pendiente', 'aprobado' => 'Aprobado', 'archivado' => 'Archivado'];
        return $labels[$status] ?? 'Desconocido';
    }

    private function getStatusColor(?string $status): string
    {
        $colors = ['borrador' => '#6b7280', 'pendiente' => '#f59e0b', 'aprobado' => '#10b981', 'archivado' => '#1f2937'];
        return $colors[$status] ?? '#6b7280';
    }

    private function formatFileSize(?int $bytes): string
    {
        if (!$bytes) return '0 B';
        $units = ['B', 'KB', 'MB', 'GB'];
        $factor = floor((strlen($bytes) - 1) / 3);
        return sprintf("%.1f %s", $bytes / pow(1024, $factor), $units[$factor]);
    }
}
</file>

<file path="app/Http/Controllers/MaterialVariantController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\MaterialVariantRequest;
use App\Models\Material;
use App\Models\MaterialVariant;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Auth;

class MaterialVariantController extends Controller
{
    /*
    |--------------------------------------------------------------------------
    | INDEX - Listar variantes de un material
    |--------------------------------------------------------------------------
    */

    public function index($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->findOrFail((int) $materialId);

            $variants = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->ordered()
                ->get();

            return view('admin.material-variants.index', compact('material', 'variants'));
        } catch (\Exception $e) {
            Log::error('Error al listar variantes de material: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Error al cargar las variantes');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->findOrFail((int) $materialId);

            $suggestedSku = $this->generateSku($material);

            return view('admin.material-variants.create', compact('material', 'suggestedSku'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de variante: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(MaterialVariantRequest $request, $materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || $materialId > 999999999) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Material no válido');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $variant = new MaterialVariant();
            $variant->uuid = (string) Str::uuid();
            $variant->material_id = $material->id;
            $variant->color = $request->filled('color') ? mb_strtoupper(trim($request->color)) : null;
            $variant->sku = mb_strtoupper(trim($request->sku));
            $variant->current_stock = 0;
            $variant->min_stock_alert = (float) $request->min_stock_alert;
            $variant->current_value = 0;
            $variant->average_cost = 0;
            $variant->last_purchase_cost = 0;
            $variant->activo = true;
            $variant->save();

            DB::commit();

            Log::info('Variante de material creada', [
                'variant_id' => $variant->id,
                'material_id' => $material->id,
                'sku' => $variant->sku,
                'color' => $variant->color,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('admin.material-variants.index', $material->id)
                ->with('success', 'Variante creada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al crear variante de material: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.material-variants.create', $materialId)
                ->withInput()
                ->with('error', 'Error al crear la variante');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->findOrFail((int) $materialId);

            $variant = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->findOrFail((int) $id);

            return view('admin.material-variants.edit', compact('material', 'variant'));
        } catch (\Exception $e) {
            Log::error('Error al cargar variante para editar: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'variant_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Variante no encontrada');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(MaterialVariantRequest $request, $materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $variant = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->findOrFail((int) $id);

            $oldSku = $variant->sku;

            $variant->color = $request->filled('color') ? mb_strtoupper(trim($request->color)) : null;
            $variant->sku = mb_strtoupper(trim($request->sku));
            $variant->min_stock_alert = (float) $request->min_stock_alert;

            if (!$variant->isDirty()) {
                return redirect()->route('admin.material-variants.index', $material->id)
                    ->with('info', 'No se realizaron cambios');
            }

            $variant->save();

            DB::commit();

            Log::info('Variante de material actualizada', [
                'variant_id' => $variant->id,
                'material_id' => $material->id,
                'old_sku' => $oldSku,
                'new_sku' => $variant->sku,
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
            ]);

            return redirect()->route('admin.material-variants.index', $material->id)
                ->with('success', 'Variante actualizada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al actualizar variante: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'variant_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.material-variants.edit', [$materialId, $id])
                ->withInput()
                ->with('error', 'Error al actualizar la variante');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM DELETE
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)
                ->with(['category', 'baseUnit'])
                ->findOrFail((int) $materialId);

            $variant = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->findOrFail((int) $id);

            return view('admin.material-variants.delete', compact('material', 'variant'));
        } catch (\Exception $e) {
            Log::error('Error al cargar variante para eliminar: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'variant_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.materials.index')
                ->with('error', 'Variante no encontrada');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DESTROY
    |--------------------------------------------------------------------------
    */

    public function destroy($materialId, $id)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1 || !is_numeric($id) || $id < 1) {
                return redirect()->route('admin.materials.index')
                    ->with('error', 'Parámetros no válidos');
            }

            $material = Material::where('activo', true)->findOrFail((int) $materialId);

            DB::beginTransaction();

            $variant = MaterialVariant::where('material_id', $material->id)
                ->where('activo', true)
                ->findOrFail((int) $id);

            // Validar que no tenga stock
            if ($variant->current_stock > 0) {
                return redirect()->route('admin.material-variants.index', $material->id)
                    ->with('error', 'No se puede eliminar: la variante tiene stock disponible (' . number_format($variant->current_stock, 2) . ')');
            }

            $variantSku = $variant->sku;

            $variant->activo = false;
            $variant->save();

            DB::commit();

            Log::info('Variante de material eliminada', [
                'variant_id' => $variant->id,
                'material_id' => $material->id,
                'sku' => $variantSku,
                'user_id' => Auth::id(),
                'ip' => request()->ip(),
            ]);

            return redirect()->route('admin.material-variants.index', $material->id)
                ->with('success', 'Variante eliminada exitosamente');
        } catch (\Exception $e) {
            DB::rollBack();

            Log::error('Error al eliminar variante: ' . $e->getMessage(), [
                'material_id' => $materialId,
                'variant_id' => $id,
                'user_id' => Auth::id(),
                'exception' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.material-variants.index', $materialId)
                ->with('error', 'Error al eliminar la variante');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX: Obtener variantes por material
    |--------------------------------------------------------------------------
    */

    public function getByMaterial($materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1) {
                return response()->json(['error' => 'Material no válido'], 400);
            }

            $variants = MaterialVariant::where('material_id', (int) $materialId)
                ->where('activo', true)
                ->ordered()
                ->get(['id', 'color', 'sku', 'current_stock', 'average_cost']);

            return response()->json($variants);
        } catch (\Exception $e) {
            Log::error('Error AJAX getByMaterial: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener variantes'], 500);
        }
    }

    public function getByMaterial2($materialId)
    {
        try {
            $variants = MaterialVariant::where('material_id', (int) $materialId)
                ->where('activo', true)
                ->with([
                    'material.baseUnit',
                    'material.consumptionUnit'
                ])
                ->ordered()
                ->get();

            $results = $variants->map(function ($v) {
                // El material ahora tiene la info de unidades directo
                $material = $v->material;
                $baseUnit = $material->baseUnit;
                $consumoUnit = $material->consumptionUnit;

                // Factor de conversión (ej: 1 Cono = 5000 Metros)
                // Si base y consumo son diferentes, usar el factor del material
                // conversión: base_qty * factor = consumption_qty
                $factor = (float) $material->conversion_factor ?: 1.0;

                // Datos crudos
                $stockBase = (float) $v->current_stock; // Stock en unidad base (ej: Conos)
                $costBase = (float) $v->average_cost;   // Costo por unidad base

                // Calcular equivalentes en unidad de consumo si es necesario
                // OJO: La lógica de negocio depende de cómo quieran VER el stock
                // Por ahora devolvemos el stock base, y el símbolo base

                $simbolo = $baseUnit->symbol ?? 'unid';

                return [
                    'id' => $v->id,
                    'text' => "{$material->name} - {$v->color} ({$v->sku})",
                    'family_name' => $material->name,
                    'variant_name' => $v->color,
                    'sku' => $v->sku,
                    'stock_real' => number_format($stockBase, 4, '.', ''),
                    'cost_base' => number_format($costBase, 4, '.', ''),
                    'symbol' => $simbolo,
                    'factor' => $factor,
                    'consumption_symbol' => $consumoUnit->symbol ?? $simbolo,
                    'stock_display' => "Stock: " . number_format($stockBase, 2) . " {$simbolo}"
                ];
            });

            return response()->json($results);
        } catch (\Exception $e) {
            Log::error('Error en getByMaterial: ' . $e->getMessage());
            return response()->json(['error' => 'Error al procesar datos'], 500);
        }
    }

    /*
    |--------------------------------------------------------------------------
    | PRIVATE: Generar SKU sugerido
    |--------------------------------------------------------------------------
    */

    private function generateSku(Material $material): string
    {
        $categoryPrefix = mb_strtoupper(mb_substr($material->category->slug ?? 'MAT', 0, 3));
        $materialPrefix = mb_strtoupper(mb_substr(Str::slug($material->name), 0, 4));

        $lastVariant = MaterialVariant::where('material_id', $material->id)
            ->orderBy('id', 'desc')
            ->first();

        $sequence = 1;
        if ($lastVariant) {
            preg_match('/(\d+)$/', $lastVariant->sku, $matches);
            if (!empty($matches[1])) {
                $sequence = (int) $matches[1] + 1;
            }
        }

        return strtoupper("{$categoryPrefix}-{$materialPrefix}-" . str_pad($sequence, 3, '0', STR_PAD_LEFT));
    }
}
</file>

<file path="app/Http/Controllers/PurchaseController.php">
<?php

namespace App\Http\Controllers;

use App\Enums\PurchaseStatus;
use App\Exceptions\PurchaseException;
use App\Http\Requests\ReceivePurchaseRequest;
use App\Http\Requests\StorePurchaseRequest;
use App\Http\Requests\UpdatePurchaseRequest;
use App\Models\Material;
use App\Models\MaterialCategory;
use App\Models\MaterialVariant;
use App\Models\Proveedor;
use App\Models\Purchase;
use App\Models\Unit;
use App\Services\PurchaseService;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\ValidationException;
use Illuminate\Support\Facades\Auth;
use App\Models\MaterialUnitConversion;
use App\Services\ReceptionService;
use App\Exceptions\InventoryException;
use App\Models\PurchaseReception;

class PurchaseController extends Controller
{
    protected PurchaseService $purchaseService;

    public function __construct(PurchaseService $purchaseService)
    {
        $this->purchaseService = $purchaseService;
    }

    /*
    |--------------------------------------------------------------------------
    | INDEX
    |--------------------------------------------------------------------------
    */

    public function index(Request $request)
    {
        try {
            $validated = $request->validate([
                'status' => ['nullable', 'string', 'in:' . implode(',', PurchaseStatus::values())],
                'proveedor_id' => ['nullable', 'integer', 'min:1', 'max:999999999'],
                'date_from' => ['nullable', 'date', 'date_format:Y-m-d'],
                'date_to' => ['nullable', 'date', 'date_format:Y-m-d', 'after_or_equal:date_from'],
                'search' => ['nullable', 'string', 'max:100', 'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s\-\_\#]+$/u'],
            ]);

            $query = Purchase::with(['proveedor', 'creator'])
                ->where('activo', true)
                ->orderBy('created_at', 'desc');

            // Filtro por estado
            if (!empty($validated['status'])) {
                $query->where('status', $validated['status']);
            }

            // Filtro por proveedor
            if (!empty($validated['proveedor_id'])) {
                $query->where('proveedor_id', (int) $validated['proveedor_id']);
            }

            // Filtro por rango de fechas
            if (!empty($validated['date_from'])) {
                $query->whereDate('ordered_at', '>=', $validated['date_from']);
            }
            if (!empty($validated['date_to'])) {
                $query->whereDate('ordered_at', '<=', $validated['date_to']);
            }

            // Búsqueda
            if (!empty($validated['search'])) {
                $search = $validated['search'];
                $query->where(function ($q) use ($search) {
                    $q->where('purchase_number', 'like', "%{$search}%")
                        ->orWhere('reference', 'like', "%{$search}%")
                        ->orWhereHas('proveedor', function ($pq) use ($search) {
                            $pq->where('nombre_proveedor', 'like', "%{$search}%");
                        });
                });
            }

            $purchases = $query->paginate(15)->withQueryString();

            $proveedores = Proveedor::where('activo', true)
                ->orderBy('nombre_proveedor')
                ->get(['id', 'nombre_proveedor']);

            $statuses = PurchaseStatus::options();

            if ($request->ajax()) {
                return response()->json([
                    'html' => view('admin.purchases.partials.table_rows', compact('purchases'))->render(),
                    'pagination' => (string) $purchases->links()
                ]);
            }

            return view('admin.purchases.index', compact('purchases', 'proveedores', 'statuses'));
        } catch (ValidationException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Parámetros de filtro no válidos');
        } catch (\Exception $e) {
            Log::error('Error al listar compras: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'ip' => $request->ip(),
                'trace' => $e->getTraceAsString(),
            ]);

            return view('admin.purchases.index', [
                'purchases' => collect(),
                'proveedores' => collect(),
                'statuses' => [],
            ])->with('error', 'Error al cargar las compras');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create()
    {
        try {
            $proveedores = Proveedor::where('activo', true)
                ->orderBy('nombre_proveedor')
                ->get(['id', 'nombre_proveedor']);

            if ($proveedores->isEmpty()) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Debe registrar al menos un proveedor antes de crear compras');
            }

            $categories = MaterialCategory::where('activo', true)
                ->with('baseUnit')
                ->ordered()
                ->get();

            // Preparar items desde old() para recuperar después de error de validación
            $oldItemsForJs = [];
            if (old('items')) {
                foreach (old('items') as $idx => $item) {
                    $variant = MaterialVariant::with(['material.category.baseUnit'])
                        ->find($item['material_variant_id']);

                    if ($variant) {
                        $unit = Unit::find($item['unit_id']);
                        $conversion = MaterialUnitConversion::where('material_id', $variant->material_id)
                            ->where('from_unit_id', $item['unit_id'])
                            ->first();

                        $conversionFactor = $conversion ? $conversion->conversion_factor : 1;
                        $quantity = (float) $item['quantity'];
                        $unitPrice = (float) $item['unit_price'];
                        $subtotal = $quantity * $unitPrice;
                        $convertedQuantity = $quantity * $conversionFactor;

                        $oldItemsForJs[] = [
                            'variant_id' => $variant->id,
                            'variant_sku' => $variant->sku,
                            'variant_color' => $variant->color ?? '',
                            'material_name' => $variant->material->name ?? '',
                            'category_name' => $variant->material->category->name ?? '',
                            'unit_id' => $item['unit_id'],
                            'unit_symbol' => $unit->symbol ?? '',
                            'quantity' => $quantity,
                            'unit_price' => $unitPrice,
                            'conversion_factor' => $conversionFactor,
                            'converted_quantity' => $convertedQuantity,
                            'base_unit_symbol' => $variant->material->category->baseUnit->symbol ?? '',
                            'subtotal' => $subtotal,
                        ];
                    }
                }
            }

            return view('admin.purchases.create', compact('proveedores', 'categories', 'oldItemsForJs'));
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de compra: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar el formulario');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(StorePurchaseRequest $request)
    {
        try {
            $validated = $request->validated();

            $purchase = $this->purchaseService->create(
                data: [
                    'proveedor_id' => $validated['proveedor_id'],
                    'tax_rate' => $validated['tax_rate'] ?? 0,
                    'discount_amount' => $validated['discount_amount'] ?? 0,
                    'notes' => $validated['notes'] ?? null,
                    'reference' => $validated['reference'] ?? null,
                    'ordered_at' => $validated['ordered_at'] ?? null,
                    'expected_at' => $validated['expected_at'] ?? null,
                ],
                items: $validated['items']
            );

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Compra {$purchase->purchase_number} creada exitosamente");
        } catch (PurchaseException $e) {
            Log::warning('Error de negocio al crear compra: ' . $e->getMessage(), [
                'context' => $e->getContext(),
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.create')
                ->withInput()
                ->with('error', $e->getMessage());
        } catch (\Exception $e) {
            Log::error('Error al crear compra: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.purchases.create')
                ->withInput()
                ->with('error', 'Error al crear la compra. Intente nuevamente.');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | SHOW
    |--------------------------------------------------------------------------
    */

    public function show($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with([
                'proveedor',
                'items.materialVariant.material.category.baseUnit',
                'items.unit',
                'creator',
                'receiver',
            ])->where('activo', true)->findOrFail((int) $id);

            // Cargar historial de recepciones
            $receptionService = app(ReceptionService::class);
            $receptions = $receptionService->getReceptionHistory($purchase);

            return view('admin.purchases.show', compact('purchase', 'receptions'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al mostrar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with([
                'proveedor',
                'items.materialVariant.material.category.baseUnit',
                'items.unit',
            ])->where('activo', true)->findOrFail((int) $id);

            if (!$purchase->can_edit) {
                return redirect()->route('admin.purchases.show', $purchase->id)
                    ->with('error', "No se puede editar la compra en estado: {$purchase->status->label()}");
            }

            // --- NUEVA LÓGICA PARA EVITAR ParseError EN BLADE ---
            $itemsForJs = $purchase->items->map(function ($item) {
                return [
                    'variant_id'         => $item->material_variant_id,
                    'variant_sku'        => $item->materialVariant->sku ?? '',
                    'variant_color'      => $item->materialVariant->color ?? '',
                    'material_name'      => $item->materialVariant->material->name ?? '',
                    'category_name'      => $item->materialVariant->material->category->name ?? '',
                    'unit_id'            => $item->unit_id,
                    'unit_symbol'        => $item->unit->symbol ?? '',
                    'quantity'           => (float) $item->quantity,
                    'unit_price'         => (float) $item->unit_price,
                    'conversion_factor'  => (float) $item->conversion_factor,
                    'converted_quantity' => (float) $item->converted_quantity,
                    'converted_unit_cost' => $item->converted_quantity > 0 ? ((float) $item->subtotal / (float) $item->converted_quantity) : 0,
                    'base_unit_symbol'   => $item->materialVariant->material->category->baseUnit->symbol ?? '',
                    'subtotal'           => (float) $item->subtotal,
                ];
            })->values();
            // ----------------------------------------------------

            $proveedores = Proveedor::where('activo', true)
                ->orderBy('nombre_proveedor')
                ->get(['id', 'nombre_proveedor']);

            $categories = MaterialCategory::where('activo', true)
                ->with('baseUnit')
                ->ordered()
                ->get();

            // Agregamos 'itemsForJs' al compact
            return view('admin.purchases.edit', compact('purchase', 'proveedores', 'categories', 'itemsForJs'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cargar compra para editar: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id'     => Auth::id(),
                'trace'       => $e->getTraceAsString(), // Agregué el trace para mejor depuración
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la compra');
        }
    }
    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(UpdatePurchaseRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);
            $validated = $request->validated();

            $purchase = $this->purchaseService->update(
                purchase: $purchase,
                data: [
                    'proveedor_id' => $validated['proveedor_id'],
                    'tax_rate' => $validated['tax_rate'] ?? $purchase->tax_rate,
                    'discount_amount' => $validated['discount_amount'] ?? $purchase->discount_amount,
                    'notes' => $validated['notes'] ?? null,
                    'reference' => $validated['reference'] ?? null,
                    'ordered_at' => $validated['ordered_at'] ?? null,
                    'expected_at' => $validated['expected_at'] ?? null,
                ],
                items: $validated['items']
            );

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Compra {$purchase->purchase_number} actualizada exitosamente");
        } catch (PurchaseException $e) {
            Log::warning('Error de negocio al actualizar compra: ' . $e->getMessage(), [
                'context' => $e->getContext(),
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.edit', $id)
                ->withInput()
                ->with('error', $e->getMessage());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al actualizar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.purchases.edit', $id)
                ->withInput()
                ->with('error', 'Error al actualizar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM (Borrador → Pendiente)
    |--------------------------------------------------------------------------
    */

    public function confirm($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);

            $purchase = $this->purchaseService->confirm($purchase);

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Compra {$purchase->purchase_number} confirmada exitosamente");
        } catch (PurchaseException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al confirmar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al confirmar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM AND RECEIVE (Borrador → Recibido en un solo paso)
    |--------------------------------------------------------------------------
    */

    public function confirmAndReceive($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with('items')->where('activo', true)->findOrFail((int) $id);

            // Verificar que está en borrador
            if ($purchase->status !== PurchaseStatus::DRAFT) {
                return redirect()->route('admin.purchases.show', $id)
                    ->with('error', 'Solo se pueden confirmar órdenes en estado borrador');
            }

            // Verificar que tiene items
            if ($purchase->items->isEmpty()) {
                return redirect()->route('admin.purchases.show', $id)
                    ->with('error', 'La orden debe tener al menos un item');
            }

            DB::beginTransaction();

            // 1. Confirmar la orden (borrador → pendiente)
            $purchase = $this->purchaseService->confirm($purchase);

            // 2. Crear recepción completa usando ReceptionService
            $receptionService = app(ReceptionService::class);

            $itemsData = [];
            foreach ($purchase->items as $item) {
                if ($item->pending_quantity > 0) {
                    $itemsData[] = [
                        'item_id' => $item->id,
                        'quantity' => $item->pending_quantity,
                    ];
                }
            }

            if (!empty($itemsData)) {
                $reception = $receptionService->createReception(
                    purchase: $purchase,
                    itemsData: $itemsData,
                    deliveryNote: null,
                    notes: 'Recepción automática - Orden confirmada y recibida en un paso'
                );
            }

            DB::commit();

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Compra {$purchase->purchase_number} confirmada y recibida completamente");
        } catch (PurchaseException $e) {
            DB::rollBack();
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (InventoryException $e) {
            DB::rollBack();
            Log::error('Error de inventario al confirmar y recibir compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error de inventario: ' . $e->getMessage());
        } catch (ModelNotFoundException $e) {
            DB::rollBack();
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Error al confirmar y recibir compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al confirmar y recibir la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | RECEIVE
    |--------------------------------------------------------------------------
    */

    public function showReceive($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with([
                'proveedor',
                'items.materialVariant.material.category.baseUnit',
                'items.unit',
            ])->where('activo', true)->findOrFail((int) $id);

            if (!$purchase->can_receive) {
                return redirect()->route('admin.purchases.show', $purchase->id)
                    ->with('error', "No se puede recibir la compra en estado: {$purchase->status->label()}");
            }

            return view('admin.purchases.receive', compact('purchase'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cargar recepción de compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la recepción');
        }
    }

    public function receive(ReceivePurchaseRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);
            $validated = $request->validated();

            // Usar ReceptionService para crear registro de recepción con historial
            $receptionService = app(ReceptionService::class);

            // Preparar items para recepción
            $itemsData = [];

            if ($validated['receive_type'] === 'complete') {
                // Recepción completa: agregar todas las cantidades pendientes
                foreach ($purchase->items as $item) {
                    if ($item->pending_quantity > 0) {
                        $itemsData[] = [
                            'item_id' => $item->id,
                            'quantity' => $item->pending_quantity,
                        ];
                    }
                }
                $message = "Compra {$purchase->purchase_number} recibida completamente";
            } else {
                // Recepción parcial: usar las cantidades del formulario
                foreach ($validated['items'] as $itemData) {
                    if (!empty($itemData['quantity']) && $itemData['quantity'] > 0) {
                        $itemsData[] = [
                            'item_id' => $itemData['item_id'],
                            'quantity' => $itemData['quantity'],
                        ];
                    }
                }
                $message = "Recepción parcial registrada para {$purchase->purchase_number}";
            }

            // Crear la recepción si hay items
            if (!empty($itemsData)) {
                $reception = $receptionService->createReception(
                    purchase: $purchase,
                    itemsData: $itemsData,
                    deliveryNote: $validated['delivery_note'] ?? null,
                    notes: $validated['notes'] ?? null
                );
                $message = "Recepción {$reception->reception_number} registrada exitosamente";
            } else {
                return redirect()->route('admin.purchases.receive', $id)
                    ->with('error', 'Debe especificar al menos una cantidad a recibir');
            }

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', $message);
        } catch (PurchaseException $e) {
            Log::warning('Error de negocio al recibir compra: ' . $e->getMessage(), [
                'context' => $e->getContext(),
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.receive', $id)
                ->with('error', $e->getMessage());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al recibir compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.purchases.receive', $id)
                ->with('error', 'Error al procesar la recepción');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CANCEL
    |--------------------------------------------------------------------------
    */

    public function showCancel($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with(['proveedor'])
                ->where('activo', true)
                ->findOrFail((int) $id);

            if (!$purchase->can_cancel) {
                return redirect()->route('admin.purchases.show', $purchase->id)
                    ->with('error', "No se puede cancelar la compra en estado: {$purchase->status->label()}");
            }

            return view('admin.purchases.cancel', compact('purchase'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cargar cancelación de compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la cancelación');
        }
    }

    public function cancel(Request $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $validated = $request->validate([
                'cancellation_reason' => [
                    'required',
                    'string',
                    'min:10',
                    'max:500',
                    'regex:/^[a-zA-Z0-9áéíóúÁÉÍÓÚñÑ\s\.\,\-\_]+$/u',
                ],
            ], [
                'cancellation_reason.required' => 'El motivo de cancelación es obligatorio.',
                'cancellation_reason.min' => 'El motivo debe tener al menos 10 caracteres.',
                'cancellation_reason.max' => 'El motivo no puede exceder 500 caracteres.',
                'cancellation_reason.regex' => 'El motivo contiene caracteres no permitidos.',
            ]);

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);

            $purchase = $this->purchaseService->cancel(
                purchase: $purchase,
                reason: strip_tags(trim($validated['cancellation_reason']))
            );

            return redirect()->route('admin.purchases.index')
                ->with('success', "Compra {$purchase->purchase_number} cancelada");
        } catch (PurchaseException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (ValidationException $e) {
            return redirect()->route('admin.purchases.cancel', $id)
                ->withInput()
                ->withErrors($e->errors());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cancelar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al cancelar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DELETE (Solo borradores)
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::with(['proveedor', 'items'])
                ->where('activo', true)
                ->findOrFail((int) $id);

            if ($purchase->status !== PurchaseStatus::DRAFT) {
                return redirect()->route('admin.purchases.show', $purchase->id)
                    ->with('error', 'Solo se pueden eliminar compras en borrador');
            }

            return view('admin.purchases.delete', compact('purchase'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al cargar eliminación de compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al cargar la eliminación');
        }
    }

    public function destroy($id)
    {
        try {
            if (!is_numeric($id) || $id < 1 || $id > 999999999) {
                return redirect()->route('admin.purchases.index')
                    ->with('error', 'Compra no válida');
            }

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);
            $purchaseNumber = $purchase->purchase_number;

            $this->purchaseService->delete($purchase);

            return redirect()->route('admin.purchases.index')
                ->with('success', "Compra {$purchaseNumber} eliminada exitosamente");
        } catch (PurchaseException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.purchases.index')
                ->with('error', 'Compra no encontrada');
        } catch (\Exception $e) {
            Log::error('Error al eliminar compra: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.index')
                ->with('error', 'Error al eliminar la compra');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX ENDPOINTS
    |--------------------------------------------------------------------------
    */

    /**
     * Obtener materiales por categoría
     */
    public function getMaterialsByCategory(Request $request, $categoryId)
    {
        try {
            if (!is_numeric($categoryId) || $categoryId < 1) {
                return response()->json(['error' => 'Categoría no válida'], 400);
            }

            $materials = Material::where('activo', true)
                ->where('material_category_id', (int) $categoryId)
                ->with(['activeVariants:id,material_id,sku,color,current_stock'])
                ->ordered()
                ->get(['id', 'name', 'composition']);

            return response()->json($materials);
        } catch (\Exception $e) {
            Log::error('Error AJAX getMaterialsByCategory: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener materiales'], 500);
        }
    }

    /**
     * Obtener variantes por material
     */
    public function getVariantsByMaterial(Request $request, $materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1) {
                return response()->json(['error' => 'Material no válido'], 400);
            }

            $variants = MaterialVariant::where('activo', true)
                ->where('material_id', (int) $materialId)
                ->ordered()
                ->get(['id', 'sku', 'color', 'current_stock', 'average_cost']);

            return response()->json($variants);
        } catch (\Exception $e) {
            Log::error('Error AJAX getVariantsByMaterial: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener variantes'], 500);
        }
    }

    /**
     * Obtener unidades de compra para un material
     */
    public function getUnitsForMaterial(Request $request, $materialId)
    {
        try {
            if (!is_numeric($materialId) || $materialId < 1) {
                return response()->json(['error' => 'Material no válido'], 400);
            }

            $material = Material::with(['category.baseUnit'])->findOrFail((int) $materialId);
            $baseUnitId = $material->category->base_unit_id;

            // Unidad base siempre disponible
            $units = collect();
            if ($material->category->baseUnit) {
                $units->push([
                    'id' => $material->category->baseUnit->id,
                    'name' => $material->category->baseUnit->name,
                    'symbol' => $material->category->baseUnit->symbol,
                    'conversion_factor' => 1,
                    'is_base' => true,
                ]);
            }

            // Unidades de compra con conversión configurada
            $conversions = MaterialUnitConversion::where('material_id', $material->id)
                ->with('fromUnit')
                ->get();

            foreach ($conversions as $conversion) {
                $units->push([
                    'id' => $conversion->from_unit_id,
                    'name' => $conversion->fromUnit->name,
                    'symbol' => $conversion->fromUnit->symbol,
                    'conversion_factor' => $conversion->conversion_factor,
                    'is_base' => false,
                ]);
            }

            return response()->json([
                'material_id' => $material->id,
                'material_name' => $material->name,
                'base_unit_id' => $baseUnitId,
                'base_unit_symbol' => $material->category->baseUnit->symbol ?? '',
                'units' => $units,
            ]);
        } catch (ModelNotFoundException $e) {
            return response()->json(['error' => 'Material no encontrado'], 404);
        } catch (\Exception $e) {
            Log::error('Error AJAX getUnitsForMaterial: ' . $e->getMessage());
            return response()->json(['error' => 'Error al obtener unidades'], 500);
        }
    }

    /**
     * Anular una recepción
     */
    public function voidReception(Request $request, $id, $receptionId)
    {
        try {
            $validated = $request->validate([
                'void_reason' => [
                    'required',
                    'string',
                    'min:10',
                    'max:500',
                ],
            ], [
                'void_reason.required' => 'El motivo de anulación es obligatorio.',
                'void_reason.min' => 'El motivo debe tener al menos 10 caracteres.',
            ]);

            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);
            $reception = PurchaseReception::where('purchase_id', $purchase->id)
                ->findOrFail((int) $receptionId);

            $receptionService = app(ReceptionService::class);
            $receptionService->voidReception($reception, strip_tags(trim($validated['void_reason'])));

            return redirect()->route('admin.purchases.show', $purchase->id)
                ->with('success', "Recepción {$reception->reception_number} anulada exitosamente");
        } catch (InventoryException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (PurchaseException $e) {
            return redirect()->route('admin.purchases.show', $id)
                ->with('error', $e->getMessage());
        } catch (\Exception $e) {
            Log::error('Error al anular recepción: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'reception_id' => $receptionId,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al anular la recepción');
        }
    }

    /**
     * Recalcular estado de una compra (útil para corregir inconsistencias)
     */
    public function recalculateStatus($id)
    {
        try {
            $purchase = Purchase::where('activo', true)->findOrFail((int) $id);

            $receptionService = app(ReceptionService::class);
            $receptionService->recalculatePurchaseStatus($purchase);

            return redirect()->route('admin.purchases.show', $id)
                ->with('success', "Estado de {$purchase->purchase_number} recalculado: {$purchase->fresh()->status->label()}");
        } catch (\Exception $e) {
            Log::error('Error al recalcular estado: ' . $e->getMessage(), [
                'purchase_id' => $id,
                'user_id' => Auth::id(),
            ]);

            return redirect()->route('admin.purchases.show', $id)
                ->with('error', 'Error al recalcular el estado');
        }
    }
}
</file>

<file path="app/Models/Product.php">
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Support\Str;

class Product extends Model
{
    use SoftDeletes;

    protected $table = 'products';

    protected $fillable = [
        'uuid',
        'tenant_id',
        'product_category_id',
        'name',
        'sku',
        'description',
        'specifications',
        'status',
        // Pricing Fields
        'base_price',
        'production_cost',
        'profit_margin',
        'production_lead_time',
    ];

    protected $casts = [
        'specifications' => 'array',
        'tenant_id' => 'integer',
        'base_price' => 'decimal:4',
        'production_cost' => 'decimal:4',
        'profit_margin' => 'decimal:2',
        'production_lead_time' => 'integer',
    ];

    /*
    |--------------------------------------------------------------------------
    | BOOT
    |--------------------------------------------------------------------------
    */

    protected static function boot(): void
    {
        parent::boot();

        static::creating(function (self $model): void {
            if (empty($model->uuid)) {
                $model->uuid = (string) Str::uuid();
            }
            if (empty($model->tenant_id)) {
                $model->tenant_id = 1;
            }
        });
    }

    /*
    |--------------------------------------------------------------------------
    | RELACIONES
    |--------------------------------------------------------------------------
    */

    public function category()
    {
        return $this->belongsTo(ProductCategory::class, 'product_category_id');
    }

    public function variants()
    {
        return $this->hasMany(ProductVariant::class, 'product_id');
    }

    public function activeVariants()
    {
        return $this->hasMany(ProductVariant::class, 'product_id')
            ->orderBy('sku_variant');
    }

    public function extras()
    {
        return $this->belongsToMany(ProductExtra::class, 'product_extra_assignment', 'product_id', 'product_extra_id')
            ->withTimestamps();
    }

    public function designs()
    {
        return $this->belongsToMany(Design::class, 'product_design', 'product_id', 'design_id')
            ->withPivot('application_type_id')
            ->withTimestamps();
    }

    public function materials()
    {
        return $this->belongsToMany(MaterialVariant::class, 'product_materials', 'product_id', 'material_variant_id')
            ->using(ProductMaterial::class)
            ->withPivot(['id', 'quantity', 'is_primary', 'notes', 'active_for_variants'])
            ->withTimestamps();
    }

    public function images()
    {
        return $this->morphMany(Image::class, 'imageable');
    }

    public function primaryImage()
    {
        return $this->morphOne(Image::class, 'imageable')
            ->where('is_primary', true);
    }

    /*
    |--------------------------------------------------------------------------
    | SCOPES
    |--------------------------------------------------------------------------
    */

    public function scopeActive(Builder $query): Builder
    {
        return $query->where('status', 'active');
    }

    public function scopeDraft(Builder $query): Builder
    {
        return $query->where('status', 'draft');
    }

    public function scopeDiscontinued(Builder $query): Builder
    {
        return $query->where('status', 'discontinued');
    }

    public function scopeByCategory(Builder $query, int $categoryId): Builder
    {
        return $query->where('product_category_id', $categoryId);
    }

    public function scopeSearch(Builder $query, string $term): Builder
    {
        return $query->where(function ($q) use ($term) {
            $q->where('name', 'like', "%{$term}%")
                ->orWhere('sku', 'like', "%{$term}%")
                ->orWhere('description', 'like', "%{$term}%");
        });
    }

    /*
    |--------------------------------------------------------------------------
    | ACCESSORS
    |--------------------------------------------------------------------------
    */

    public function getStatusLabelAttribute(): string
    {
        return match ($this->status) {
            'active' => 'Activo',
            'draft' => 'Borrador',
            'discontinued' => 'Descontinuado',
            default => 'Desconocido',
        };
    }

    public function getStatusColorAttribute(): string
    {
        return match ($this->status) {
            'active' => 'success',
            'draft' => 'warning',
            'discontinued' => 'danger',
            default => 'secondary',
        };
    }

    public function getIsActiveAttribute(): bool
    {
        return $this->status === 'active';
    }

    public function getTotalStitchesAttribute(): int
    {
        $total = 0;
        foreach ($this->designs as $design) {
            $total += $design->stitch_count ?? 0;
        }
        return $total;
    }

    public function getBasePrice(): float
    {
        $variant = $this->variants()->orderBy('price', 'asc')->first();
        return $variant ? (float) $variant->price : 0;
    }

    public function getBasePriceAttribute(): float
    {
        return $this->getBasePrice();
    }

    public function getFormattedBasePriceAttribute(): string
    {
        return '$' . number_format($this->base_price, 2);
    }

    public function getExtrasTotal(): float
    {
        return (float) $this->extras->sum('price_addition');
    }

    public function getExtrasTotalAttribute(): float
    {
        return $this->getExtrasTotal();
    }

    public function getVariantsCountAttribute(): int
    {
        return $this->variants()->count();
    }

    public function getPrimaryImageUrlAttribute(): ?string
    {
        $image = $this->primaryImage;
        if ($image) {
            return $image->url;
        }

        $firstImage = $this->images()->first();
        return $firstImage ? $firstImage->url : null;
    }

    /*
    |--------------------------------------------------------------------------
    | MÉTODOS
    |--------------------------------------------------------------------------
    */

    public function canEdit(): bool
    {
        return in_array($this->status, ['draft', 'active']);
    }

    public function canDelete(): bool
    {
        return $this->status === 'draft' || $this->variants()->count() === 0;
    }

    public function activate(): void
    {
        $this->status = 'active';
        $this->save();
    }

    public function discontinue(): void
    {
        $this->status = 'discontinued';
        $this->save();
    }

    public function setAsDraft(): void
    {
        $this->status = 'draft';
        $this->save();
    }

    public static function generateSku(string $categoryPrefix, string $name): string
    {
        $nameSlug = Str::upper(Str::substr(Str::slug($name, ''), 0, 6));
        $random = Str::upper(Str::random(4));
        return "{$categoryPrefix}-{$nameSlug}-{$random}";
    }
}
</file>

<file path="database/migrations/2025_12_16_175802_create_proveedors_table.php">
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('proveedors', function (Blueprint $table) {
            $table->id();
            $table->string('nombre_proveedor');

            $table->string('direccion')->nullable();
            $table->string('codigo_postal')->nullable();
            $table->string('telefono')->nullable();
            $table->string('email')->nullable()->unique();
            $table->string('ciudad')->nullable();
            $table->string('nombre_contacto')->nullable();
            $table->string('telefono_contacto')->nullable();
            $table->string('email_contacto')->nullable();

            $table->boolean('activo')->default(true);
            $table->timestamp('fecha_baja')->nullable();
            $table->string('motivo_baja')->nullable();
            $table->foreignId('estado_id')->constrained('estados')->restrictOnDelete();
            $table->foreignId('giro_id')->constrained('giros')->restrictOnDelete();
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::disableForeignKeyConstraints();
        Schema::dropIfExists('proveedors');
        Schema::enableForeignKeyConstraints();
    }
};
</file>

<file path="resources/views/admin/clientes/index.blade.php">
@extends('adminlte::page')

@section('title', 'CLIENTES')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary" bis_skin_checked="1">

        <div class="card-header" bis_skin_checked="1">

            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> CLIENTES</h3>
            <!-- /.card-tools -->
        </div>
        <!-- /.card-header -->
        <div class="card-body" bis_skin_checked="1">
            <div class="row">
                <a href="{{ route('admin.clientes.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i></a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover ">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Apellidos</th>
                                <th>Telefono</th>
                                <th>Email</th>
                                <th>Direccion</th>
                                <th>Estado</th>
                                <th>Recomendacion</th>
                                <th>Fecha de Alta</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach ($clientes as $cliente)
                                <tr>
                                    <td>{{ $loop->iteration }}</td>
                                    <td>{{ $cliente->nombre }}</td>
                                    <td>{{ $cliente->apellidos }}</td>
                                    <td>{{ $cliente->telefono }}</td>
                                    <td>{{ $cliente->email }}</td>
                                    <td>{{ $cliente->direccion }}</td>
                                    <td>{{ $cliente->estado->nombre_estado }}</td>
                                    <td>{{ $cliente->recomendacion->nombre_recomendacion }}</td>
                                    <td>{{ $cliente->created_at ? $cliente->created_at->format('d/m/Y H:i') : 'N/A' }}</td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center align-items-center gap-1">
                                            <button type="button" class="btn btn-info btn-sm btn-view-measures"
                                                title="Ver Medidas" data-id="{{ $cliente->id }}"
                                                data-name="{{ $cliente->nombre }} {{ $cliente->apellidos }}">
                                                <i class="fas fa-ruler-combined"></i>
                                            </button>

                                            <a href="{{ route('admin.clientes.edit', $cliente->id) }}"
                                                class="btn btn-warning btn-sm" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <a href="{{ route('admin.clientes.confirm_delete', $cliente->id) }}"
                                                class="btn btn-danger btn-sm" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>

                                </tr>
                            @endforeach

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- /.card-body -->
    </div>
@stop

{{-- Modal de Medidas --}}
<div class="modal fade" id="measuresModal" tabindex="-1" role="dialog" aria-labelledby="measuresModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title font-weight-bold text-white w-100 text-center" id="measuresModalLabel">MEDIDAS
                    DE: </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="measuresModalBody">
                <div class="text-center py-5">
                    <i class="fas fa-spinner fa-spin fa-3x text-primary"></i>
                    <p class="mt-3 text-muted">Cargando medidas...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            /* Centrar los botones */
            flex-wrap: wrap;
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Clientes",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Clientes",
                    "infoFiltered": "(Filtrado de _MAX_ total Clientes)",
                    "lengthMenu": "Mostrar _MENU_ Clientes",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');

            // Handle View Measures Click
            $(document).on('click', '.btn-view-measures', function() {
                var clientId = $(this).data('id');
                var clientName = $(this).data('name');
                var url = "{{ route('admin.clientes.measures', ':id') }}".replace(':id', clientId);

                // Update Modal Title
                $('#measuresModalLabel').text('MEDIDAS DE: ' + clientName);

                // Show Modal
                $('#measuresModal').modal('show');

                // Show Loading
                $('#measuresModalBody').html(
                    '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-3x text-primary"></i><p class="mt-3 text-muted">Cargando medidas...</p></div>'
                );

                // Fetch Content
                $.get(url, function(data) {
                    $('#measuresModalBody').html(data);
                }).fail(function() {
                    $('#measuresModalBody').html(
                        '<div class="alert alert-danger">Error al cargar las medidas. Intente nuevamente.</div>'
                    );
                });
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/material-categories/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nueva Categoría de Material')

@section('content_header')
@stop

@section('content')
    <br>

    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    <div class="row">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card card-primary">
                <div class="card-header">
                    <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                        <i class="fas fa-plus-circle"></i> NUEVA CATEGORÍA DE MATERIAL
                    </h3>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ route('admin.material-categories.store') }}">
                        @csrf

                        <div class="form-group">
                            <label>Nombre <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control @error('name') is-invalid @enderror"
                                value="{{ old('name') }}" placeholder="Ej: Telas, Hilos, Cintas" maxlength="50" required>
                            @error('name')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        <div class="form-group">
                            <label>Descripción</label>
                            <textarea name="description" class="form-control @error('description') is-invalid @enderror" rows="3"
                                maxlength="500" placeholder="Descripción opcional...">{{ old('description') }}</textarea>
                            @error('description')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>



                        <hr>

                        <div class="text-center">
                            <a href="{{ route('admin.material-categories.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
@stop



@section('js')
    <script></script>
@stop
</file>

<file path="resources/views/admin/material-categories/delete.blade.php">
@extends('adminlte::page')

@section('title', 'Eliminar Categoría de Material')

@section('content_header')
@stop

@section('content')
    <br>

    <div class="row">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card card-danger">
                <div class="card-header">
                    <h3 class="card-title text-white" style="font-weight: 700; font-size: 18px;">
                        <i class="fas fa-exclamation-triangle mr-2"></i>ELIMINAR CATEGORÍA DE MATERIAL
                    </h3>
                </div>

                <div class="card-body pt-3 pb-2">
                    <form id="deleteForm" method="POST"
                        action="{{ route('admin.material-categories.destroy', $category->id) }}">
                        @csrf
                        @method('DELETE')

                        <div class="form-group mb-2">
                            <label class="small text-muted mb-1">Nombre</label>
                            <input type="text" class="form-control form-control-sm" value="{{ $category->name }}"
                                disabled style="font-weight: 600; color: #1f2937;">
                        </div>

                        <div class="form-group mb-2">
                            <label class="small text-muted mb-1">Descripción</label>
                            <textarea class="form-control form-control-sm" rows="2" disabled style="background-color: #f8fafc;">{{ $category->description }}</textarea>
                        </div>



                        <div class="row mt-4">
                            <div class="col-12 text-center">
                                <h4 style="font-weight: 700; color: #374151; margin-bottom: 20px;">
                                    ¿Deseas eliminar esta categoría?
                                </h4>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="text-right pb-3">
                                    <a href="{{ route('admin.material-categories.index') }}"
                                        class="btn btn-secondary shadow-sm">
                                        <i class="fas fa-times-circle"></i> Regresar
                                    </a>
                                    <button type="submit" class="btn btn-danger shadow-sm ml-2">
                                        <i class="fas fa-trash-alt"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
@stop

@section('js')
    <script>
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();

            Swal.fire({
                title: '¿Estás seguro?',
                text: "¡Eliminarás esta categoría y su contenido asociado!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d', // Gris
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/material-categories/edit.blade.php">
@extends('adminlte::page')

@section('title', 'Editar Categoría de Material')

@section('content_header')
@stop

@section('content')
    <br>

    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    <!-- Centered Card -->
    <!-- Centered Card -->
    <div class="row">
        <div class="col-12 col-md-6 col-lg-4">
            <div class="card card-warning">
                <div class="card-header">
                    <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                        <i class="fas fa-edit"></i> EDITAR CATEGORÍA DE MATERIAL
                    </h3>
                </div>

                <div class="card-body">
                    <form method="POST" action="{{ route('admin.material-categories.update', $category->id) }}">
                        @csrf
                        @method('PUT')

                        <div class="form-group">
                            <label>Nombre <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control @error('name') is-invalid @enderror"
                                value="{{ old('name', $category->name) }}" maxlength="50" required>
                            @error('name')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>



                        <div class="form-group">
                            <label>Descripción</label>
                            <textarea name="description" class="form-control @error('description') is-invalid @enderror" rows="3"
                                maxlength="500">{{ old('description', $category->description) }}</textarea>
                            @error('description')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>



                        <hr>

                        <div class="text-center">
                            <a href="{{ route('admin.material-categories.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Actualizar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
@stop
</file>

<file path="resources/views/admin/material-categories/index.blade.php">
@extends('adminlte::page')

@section('title', 'Categorías de Materiales')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-layer-group"></i> CATEGORÍAS DE MATERIALES
            </h3>
        </div>

        <div class="card-body">
            <div class="row mb-3">
                <div class="col-12 d-flex justify-content-between">
                    <a href="{{ route('admin.material-categories.create') }}" class="btn btn-primary">
                        Nuevo <i class="fas fa-plus"></i>
                    </a>
                    <a href="{{ route('admin.material-category-units.index') }}" class="btn btn-info">
                        <i class="fas fa-link"></i> Gestionar Unidades Permitidas
                    </a>
                </div>
            </div>
            <hr>

            <div class="table-responsive">
                <table id="example1" class="table table-bordered table-hover text-center">
                    <thead class="thead-dark text-center">
                        <tr>
                            <th>#</th>
                            <th>Nombre</th>
                            <th>Descripción</th>
                            <th>Unidades Permitidas</th>
                            <th>Materiales</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach ($categories as $category)
                            <tr>
                                <td>{{ $loop->iteration }}</td>
                                <td>{{ $category->name }}</td>
                                <td>{{ $category->description ?? 'N/A' }}</td>
                                <td>
                                    @foreach ($category->allowedUnits as $unit)
                                        <span class="badge badge-secondary">{{ $unit->name }}</span>
                                    @endforeach
                                    @if ($category->allowedUnits->isEmpty())
                                        <span class="text-muted small">Sin asignar</span>
                                    @endif
                                </td>
                                <td>
                                    <button class="btn btn-info btn-sm btn-show-materials" data-id="{{ $category->id }}"
                                        data-name="{{ $category->name }}" style="font-size: 1rem; font-weight: bold;">
                                        {{ $category->materials_count }}
                                    </button>
                                </td>
                                <td>
                                    <div class="d-flex justify-content-center align-items-center gap-1">
                                        <a href="{{ route('admin.material-categories.edit', $category->id) }}"
                                            class="btn btn-warning btn-sm" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{{ route('admin.material-categories.confirm_delete', $category->id) }}"
                                            class="btn btn-danger btn-sm" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        @endforeach
                    </tbody>
                </table>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            /* Centrar los botones */
            flex-wrap: wrap;
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    {{-- Modal para listar materiales --}}
    <div class="modal fade" id="materialsModal" tabindex="-1" role="dialog" aria-labelledby="materialsModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content shadow-lg" style="border-radius: 20px; border: none; overflow: hidden;">
                <div class="modal-header bg-primary text-white justify-content-center position-relative">
                    <h5 class="modal-title font-weight-bold" id="materialsModalLabel" style="font-size: 1.5rem;">NOMBRE
                        CATEGORIA</h5>
                    <button type="button" class="close position-absolute text-white" data-dismiss="modal"
                        aria-label="Close" style="right: 15px; top: 15px;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <h6 class="text-center text-muted mb-3 font-weight-bold"
                        style="text-transform: uppercase; letter-spacing: 1px;">
                        Materiales Asociados
                    </h6>
                    <div class="table-responsive d-flex justify-content-center">
                        <table class="table table-bordered table-striped table-hover text-center" id="materialsTable"
                            style="width: 80%;">
                            <thead class="thead-dark">
                                <tr>
                                    <th style="width: 10%;">#</th>
                                    <th>Nombre del Material</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{-- Contenido dinámico --}}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary px-5 rounded-pill shadow-sm" data-dismiss="modal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>



    <script>
        $(function() {
            // Lógica para abrir el modal y cargar materiales
            $('.btn-show-materials').on('click', function() {
                var categoryId = $(this).data('id');
                var categoryName = $(this).data('name');

                // Configurar titulo
                $('#materialsModalLabel').text(categoryName);

                // Limpiar tabla
                var tbody = $('#materialsTable tbody');
                tbody.html(
                    '<tr><td colspan="2"><i class="fas fa-spinner fa-spin"></i> Cargando...</td></tr>');

                // Abrir modal
                $('#materialsModal').modal('show');

                // Petición AJAX (Necesitamos una ruta para esto, la crearemos en breve)
                // Por ahora simulare la carga o usare una ruta si puedo deducirla, 
                // pero lo correcto es crear un endpoint dedicated o usar uno existente.
                // Usaremos: /admin/material-categories/{id}/materials
                $.ajax({
                    url: '/admin/material-categories/' + categoryId + '/get-materials',
                    type: 'GET',
                    success: function(response) {
                        tbody.empty();
                        if (response.length > 0) {
                            $.each(response, function(index, material) {
                                tbody.append(`
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td class="font-weight-bold text-dark">${material.name}</td>
                                    </tr>
                                `);
                            });
                        } else {
                            tbody.html(
                                '<tr><td colspan="2" class="text-muted">Sin materiales asociados</td></tr>'
                            );
                        }
                    },
                    error: function() {
                        tbody.html(
                            '<tr><td colspan="2" class="text-danger">Error al cargar datos</td></tr>'
                        );
                    }
                });
            });

            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Categorías",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Categorías",
                    "infoFiltered": "(Filtrado de _MAX_ total Categorías)",
                    "lengthMenu": "Mostrar _MENU_ Categorías",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="resources/views/admin/proveedores/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nuevo Proveedor')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    {{-- ERRORES GENERALES --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show">
            <strong>Se encontraron errores en el formulario:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert">
                <span>&times;</span>
            </button>
        </div>
    @endif

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> NUEVO PROVEEDOR</h3>
        </div>

        <div class="card-body">
            <form method="post" action="{{ route('admin.proveedores.store') }}">
                @csrf
                @method('POST')

                <div class="row">
                    {{-- DATOS DEL PROVEEDOR --}}
                    <div class="col-md-6" style="border-right: 2px solid #e0e0e0; padding-right: 30px;">

                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600;">
                                <i class="fas fa-building"></i> Datos del Proveedor
                            </h5>
                        </div>

                        {{-- Nombre --}}
                        <div class="form-group">
                            <label>Nombre Proveedor <span style="color: red;">*</span></label>
                            <input type="text" name="nombre_proveedor"
                                class="form-control form-control-sm @error('nombre_proveedor') is-invalid @enderror"
                                value="{{ old('nombre_proveedor') }}" required placeholder="Nombre del proveedor">
                            @error('nombre_proveedor')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        {{-- Giro --}}
                        <div class="form-group">
                            <label>Giro <span style="color: red;">*</span></label>
                            <select name="giro_id"
                                class="form-control form-control-sm @error('giro_id') is-invalid @enderror" required>
                                <option value="">Selecciona un Giro</option>
                                @foreach ($giros as $giro)
                                    <option value="{{ $giro->id }}" {{ old('giro_id') == $giro->id ? 'selected' : '' }}>
                                        {{ $giro->nombre_giro }}
                                    </option>
                                @endforeach
                            </select>
                            @error('giro_id')
                                <div class="invalid-feedback">{{ $message }}</div>
                            @enderror
                        </div>

                        {{-- Dirección --}}
                        <div class="row">
                            <div class="col-md-10">
                                <div class="form-group">
                                    <label>Dirección</label>
                                    <input type="text" name="direccion" class="form-control form-control-sm"
                                        value="{{ old('direccion') }}" placeholder="Dirección">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="form-group">
                                    <label>C.P.</label>
                                    <input type="text" name="codigo_postal"
                                        class="form-control form-control-sm @error('codigo_postal') is-invalid @enderror"
                                        value="{{ old('codigo_postal') }}" maxlength="5"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{5}"
                                        placeholder="Ej: 97000">
                                    @error('codigo_postal')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Teléfono y correo --}}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Teléfono <span style="color: red;">*</span></label>
                                    <input type="tel" name="telefono"
                                        class="form-control form-control-sm @error('telefono') is-invalid @enderror"
                                        value="{{ old('telefono') }}" required placeholder="Ej: 2233445566" maxlength="10"
                                        oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}">
                                    @error('telefono')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Correo <span style="color: red;" for="email">*</span></label>
                                    <input type="email" name="email"
                                        class="form-control form-control-sm @error('email') is-invalid @enderror"
                                        value="{{ old('email') }}" placeholder="Ej: correo@correo.com">
                                    @error('email')
                                        <div class="invalid-feedback">{{ $message }}</div>
                                    @enderror
                                </div>
                            </div>
                        </div>

                        {{-- Estado y ciudad --}}
                        <div class="row">
                            <div class="col-md-6">
                                <label>Estado <span style="color: red;">*</span></label>
                                <select name="estado_id"
                                    class="form-control form-control-sm @error('estado_id') is-invalid @enderror" required>
                                    <option value="">Selecciona un estado</option>
                                    @foreach ($estados as $estado)
                                        <option value="{{ $estado->id }}"
                                            {{ old('estado_id') == $estado->id ? 'selected' : '' }}>
                                            {{ $estado->nombre_estado }}
                                        </option>
                                    @endforeach
                                </select>
                                @error('estado_id')
                                    <div class="invalid-feedback">{{ $message }}</div>
                                @enderror
                            </div>

                            <div class="col-md-6">
                                <label>Ciudad <span style="color: red;">*</span></label>
                                <input type="text" name="ciudad" class="form-control form-control-sm"
                                    value="{{ old('ciudad') }}" placeholder="Ej: Mérida">
                            </div>
                        </div>

                        {{-- Botones --}}
                        <div class="text-center mt-4">
                            <a href="{{ route('admin.proveedores.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times-circle"></i> Regresar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar
                            </button>
                        </div>
                    </div>

                    {{-- DATOS CONTACTO --}}
                    <div class="col-md-6" style="padding-left: 30px;">
                        <div style="border-bottom: 3px solid #28a745; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #28a745; font-weight: 600;">
                                <i class="fas fa-address-book"></i> Datos de Contacto
                            </h5>
                        </div>

                        <div class="form-group">
                            <label>Nombre del contacto</label>
                            <input type="text" name="nombre_contacto" class="form-control form-control-sm"
                                value="{{ old('nombre_contacto') }}" placeholder="Ej: Juan Perez">
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <label>Teléfono</label>
                                <input type="tel" name="telefono_contacto" class="form-control form-control-sm"
                                    value="{{ old('telefono_contacto') }}" maxlength="10"
                                    oninput="this.value = this.value.replace(/[^0-9]/g, '')" pattern="[0-9]{10}"
                                    placeholder="Ej: 2233445566">
                            </div>
                            <div class="col-md-6">
                                <label for="email_contacto">Correo</label>
                                <input type="email" name="email_contacto" class="form-control form-control-sm"
                                    value="{{ old('email_contacto') }}" placeholder="Ej: correo@correo.com">
                            </div>
                        </div>

                    </div>
                </div>
            </form>
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        console.log("Hi, I'm using the Laravel-AdminLTE package!");
    </script>
@stop
</file>

<file path="resources/views/admin/purchases/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nueva Orden de Compra')

@section('content_header')
@stop

@section('content')
    {{-- ERRORES DE VALIDACIÓN --}}
    @if ($errors->any())
        <div class="alert alert-danger alert-dismissible fade show mx-3 mt-3 mb-0" style="border-radius: 8px;">
            <strong>Se encontraron errores:</strong>
            <ul class="mb-0 mt-2">
                @foreach ($errors->all() as $error)
                    <li>{{ $error }}</li>
                @endforeach
            </ul>
            <button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>
        </div>
    @endif

    <form method="POST" action="{{ route('admin.purchases.store') }}" id="purchaseForm">
        @csrf

        {{-- HEADER PROFESIONAL --}}
        <div class="purchase-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="purchase-title">Nueva Orden de Compra</h1>
                    <p class="purchase-subtitle">Complete los datos del proveedor y agregue los materiales</p>
                </div>
                <div class="header-actions">
                    <a href="{{ route('admin.purchases.index') }}" class="btn-action btn-cancel">
                        Cancelar
                    </a>
                    <button type="submit" class="btn-action btn-save" id="btn_submit" disabled>
                        <i class="fas fa-check"></i> Guardar Orden
                    </button>
                </div>
            </div>
        </div>

        {{-- CONTENIDO PRINCIPAL --}}
        <div class="purchase-content">
            <div class="row no-gutters">
                {{-- PANEL IZQUIERDO: DATOS DE LA ORDEN --}}
                <div class="col-12 col-xl-4">
                    <div class="panel-section">
                        <div class="section-header">
                            <span class="section-icon"><i class="fas fa-file-alt"></i></span>
                            <span class="section-title">Datos de la Orden</span>
                        </div>

                        <div class="section-body">
                            {{-- Proveedor --}}
                            <div class="field-group">
                                <label class="field-label">Proveedor <span class="required">*</span></label>
                                <select name="proveedor_id" id="proveedor_id"
                                    class="field-control @error('proveedor_id') is-invalid @enderror" required>
                                    <option value="">Seleccionar proveedor...</option>
                                    @foreach ($proveedores as $proveedor)
                                        <option value="{{ $proveedor->id }}"
                                            {{ old('proveedor_id') == $proveedor->id ? 'selected' : '' }}>
                                            {{ $proveedor->nombre_proveedor }}
                                        </option>
                                    @endforeach
                                </select>
                            </div>

                            {{-- Fechas en grid --}}
                            <div class="field-row">
                                <div class="field-group">
                                    <label class="field-label">Fecha Orden</label>
                                    <input type="date" name="ordered_at" class="field-control"
                                        value="{{ old('ordered_at', date('Y-m-d')) }}">
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Fecha Esperada</label>
                                    <input type="date" name="expected_at" class="field-control"
                                        value="{{ old('expected_at') }}">
                                </div>
                            </div>

                            {{-- IVA y Referencia --}}
                            <div class="field-row">
                                <div class="field-group">
                                    <label class="field-label">IVA</label>
                                    <div class="field-with-suffix">
                                        <input type="number" name="tax_rate" id="tax_rate" class="field-control"
                                            value="{{ old('tax_rate', 16) }}" min="0" max="100" step="0.01">
                                        <span class="field-suffix">%</span>
                                    </div>
                                </div>
                                <div class="field-group">
                                    <label class="field-label">Referencia</label>
                                    <input type="text" name="reference" class="field-control"
                                        value="{{ old('reference') }}" maxlength="100" placeholder="Factura, pedido...">
                                </div>
                            </div>

                            {{-- Descuento --}}
                            <div class="field-group">
                                <label class="field-label">Descuento Global</label>
                                <div class="field-with-prefix">
                                    <span class="field-prefix">$</span>
                                    <input type="number" name="discount_amount" id="discount_amount" class="field-control"
                                        value="{{ old('discount_amount', 0) }}" min="0" step="0.01">
                                </div>
                            </div>

                            {{-- Notas --}}
                            <div class="field-group">
                                <label class="field-label">Notas</label>
                                <textarea name="notes" class="field-control field-textarea" rows="3" maxlength="1000"
                                    placeholder="Notas internas de la orden...">{{ old('notes') }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- PANEL DERECHO: MATERIALES --}}
                <div class="col-12 col-xl-8">
                    <div class="panel-section panel-main">
                        {{-- SECCIÓN AGREGAR MATERIAL --}}
                        <div class="add-material-section">
                            <div class="section-header">
                                <span class="section-icon text-success"><i class="fas fa-plus-circle"></i></span>
                                <span class="section-title">Agregar Material</span>
                            </div>

                            <div class="add-material-grid">
                                {{-- Fila 1: Selección de producto --}}
                                <div class="material-row">
                                    <div class="material-field">
                                        <label class="field-label-sm">Categoría</label>
                                        <select id="select_category" class="field-control">
                                            <option value="">Seleccionar...</option>
                                            @foreach ($categories as $category)
                                                <option value="{{ $category->id }}"
                                                    data-base-unit="{{ $category->baseUnit->symbol ?? '' }}">
                                                    {{ $category->name }}
                                                </option>
                                            @endforeach
                                        </select>
                                    </div>
                                    <div class="material-field">
                                        <label class="field-label-sm">Material</label>
                                        <select id="select_material" class="field-control" disabled>
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                    <div class="material-field">
                                        <label class="field-label-sm">Variante</label>
                                        <select id="select_variant" class="field-control" disabled>
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                    <div class="material-field">
                                        <label class="field-label-sm">Unidad</label>
                                        <select id="select_unit" class="field-control" disabled>
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                </div>

                                {{-- Fila 2: Cantidad, precio y agregar --}}
                                <div class="material-row material-row-values">
                                    <div class="material-field field-qty">
                                        <label class="field-label-sm">Cantidad</label>
                                        <input type="number" id="input_quantity" class="field-control" min="0.0001"
                                            step="0.01" placeholder="0.00" disabled>
                                        <div id="info_conversion_text" class="conversion-hint"></div>
                                        <input type="hidden" id="info_conversion">
                                    </div>
                                    <div class="material-field field-price">
                                        <label class="field-label-sm">Precio Unit.</label>
                                        <div class="field-with-prefix">
                                            <span class="field-prefix">$</span>
                                            <input type="number" id="input_price" class="field-control" min="0.0001"
                                                step="0.01" placeholder="0.00" disabled>
                                        </div>
                                    </div>
                                    <div class="material-field field-subtotal">
                                        <label class="field-label-sm">Subtotal</label>
                                        <div class="subtotal-display" id="info_subtotal_display">$0.00</div>
                                        <input type="hidden" id="info_subtotal">
                                    </div>
                                    <div class="material-field field-action">
                                        <button type="button" id="btn_add_item" class="btn-add" disabled>
                                            <i class="fas fa-plus"></i> Agregar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{-- TABLA DE ITEMS --}}
                        <div class="items-section">
                            <div class="items-header">
                                <span class="items-title">Items de la Orden</span>
                                <span class="items-count" id="items_count">0 items</span>
                            </div>

                            <div class="items-table-wrapper">
                                <table class="items-table" id="items_table">
                                    <thead>
                                        <tr>
                                            <th class="th-num">#</th>
                                            <th class="th-material">Material</th>
                                            <th class="th-variant">Variante</th>
                                            <th class="th-qty">Cant.</th>
                                            <th class="th-unit">Unidad</th>
                                            <th class="th-price">Precio</th>
                                            <th class="th-total">Total</th>
                                            <th class="th-action"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="items_body">
                                        <tr id="no_items_row">
                                            <td colspan="8" class="empty-state">
                                                <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                                                <div class="empty-text">La orden está vacía</div>
                                                <div class="empty-hint">Agregue materiales usando el formulario superior
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            {{-- TOTALES --}}
                            <div class="totals-section" id="items_totals" style="display: none;">
                                <div class="totals-row">
                                    <span class="totals-label">Subtotal</span>
                                    <span class="totals-value" id="total_subtotal">$0.00</span>
                                </div>
                                <div class="totals-row">
                                    <span class="totals-label">IVA (<span id="tax_rate_display">16</span>%)</span>
                                    <span class="totals-value" id="total_tax">$0.00</span>
                                </div>
                                <div class="totals-row totals-discount" id="discount_row" style="display: none;">
                                    <span class="totals-label">Descuento</span>
                                    <span class="totals-value text-danger" id="total_discount">-$0.00</span>
                                </div>
                                <div class="totals-row totals-final">
                                    <span class="totals-label">Total</span>
                                    <span class="totals-value" id="total_final">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{-- CONTAINER DE INPUTS HIDDEN --}}
        <div id="hidden_items_container"></div>
    </form>
@stop

@section('css')
    <style>
        /* ============================================
                       SISTEMA DE DISEÑO PROFESIONAL - SaaS Style
                       ============================================ */

        /* Variables CSS */
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --success: #059669;
            --success-hover: #047857;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --border-radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* Reset del content wrapper de AdminLTE */
        .content-wrapper {
            background-color: var(--gray-50) !important;
            min-height: calc(100vh - 57px) !important;
        }

        .content {
            padding: 0 !important;
        }

        /* ============================================
                       HEADER
                       ============================================ */
        .purchase-header {
            background: #fff;
            border-bottom: 1px solid var(--gray-200);
            padding: 20px 32px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .purchase-title {
            font-family: var(--font-sans);
            font-size: 24px;
            font-weight: 600;
            color: var(--gray-900);
            margin: 0;
            letter-spacing: -0.025em;
        }

        .purchase-subtitle {
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-500);
            margin: 4px 0 0 0;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn-action {
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-cancel {
            background: #fff;
            color: var(--gray-700);
            border: 1px solid var(--gray-300);
        }

        .btn-cancel:hover {
            background: var(--gray-50);
            color: var(--gray-900);
            text-decoration: none;
        }

        .btn-save {
            background: var(--primary);
            color: #fff;
        }

        .btn-save:hover:not(:disabled) {
            background: var(--primary-hover);
        }

        .btn-save:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* ============================================
                       CONTENIDO PRINCIPAL
                       ============================================ */
        .purchase-content {
            padding: 24px 32px 32px;
        }

        .panel-section {
            background: #fff;
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-200);
            margin-bottom: 0;
        }

        .panel-main {
            margin-left: 24px;
        }

        @media (max-width: 1199px) {
            .panel-main {
                margin-left: 0;
                margin-top: 24px;
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-100);
        }

        .section-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-100);
            border-radius: 8px;
            color: var(--gray-600);
            font-size: 14px;
        }

        .section-icon.text-success {
            background: #d1fae5;
            color: var(--success);
        }

        .section-title {
            font-family: var(--font-sans);
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .section-body {
            padding: 20px;
        }

        /* ============================================
                       CAMPOS DE FORMULARIO
                       ============================================ */
        .field-group {
            margin-bottom: 16px;
        }

        .field-group:last-child {
            margin-bottom: 0;
        }

        .field-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .field-label {
            display: block;
            font-family: var(--font-sans);
            font-size: 13px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 6px;
        }

        .field-label-sm {
            display: block;
            font-family: var(--font-sans);
            font-size: 12px;
            font-weight: 500;
            color: var(--gray-500);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        .required {
            color: var(--danger);
        }

        .field-control {
            width: 100%;
            height: 40px;
            padding: 0 12px;
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-900);
            background: #fff;
            border: 1px solid var(--gray-300);
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .field-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .field-control:disabled {
            background: var(--gray-50);
            color: var(--gray-600);
            border-color: var(--gray-200);
            cursor: not-allowed;
        }

        .field-control:disabled::placeholder {
            color: var(--gray-500);
        }

        .field-control::placeholder {
            color: var(--gray-400);
        }

        select.field-control {
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            appearance: none !important;
            background: #fff url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") right 8px center / 20px no-repeat !important;
            padding-right: 36px;
        }

        select.field-control:disabled {
            background: var(--gray-50) url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") right 8px center / 20px no-repeat !important;
            color: var(--gray-600);
        }

        .field-textarea {
            height: auto;
            min-height: 80px;
            padding: 10px 12px;
            resize: vertical;
        }

        .field-with-prefix,
        .field-with-suffix {
            position: relative;
            display: flex;
            align-items: center;
        }

        .field-prefix,
        .field-suffix {
            position: absolute;
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-500);
            pointer-events: none;
        }

        .field-prefix {
            left: 12px;
        }

        .field-suffix {
            right: 12px;
        }

        .field-with-prefix .field-control {
            padding-left: 28px;
        }

        .field-with-suffix .field-control {
            padding-right: 32px;
        }

        /* ============================================
                       SECCIÓN AGREGAR MATERIAL
                       ============================================ */
        .add-material-section {
            border-bottom: 1px solid var(--gray-100);
        }

        .add-material-grid {
            padding: 20px;
        }

        .material-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 16px;
        }

        .material-row:last-child {
            margin-bottom: 0;
        }

        .material-row-values {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: flex-end;
        }

        @media (max-width: 991px) {
            .material-row {
                grid-template-columns: repeat(2, 1fr);
            }

            .material-row-values {
                grid-template-columns: 1fr 1fr;
            }

            .field-action {
                grid-column: span 2;
            }
        }

        .material-field {
            min-width: 0;
        }

        .conversion-hint {
            font-family: var(--font-sans);
            font-size: 12px;
            color: var(--primary);
            margin-top: 4px;
            font-weight: 500;
            display: none;
        }

        .subtotal-display {
            font-family: var(--font-sans);
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-900);
            height: 40px;
            display: flex;
            align-items: center;
        }

        .btn-add {
            height: 40px;
            padding: 0 24px;
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            background: var(--success);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-add:hover:not(:disabled) {
            background: var(--success-hover);
        }

        .btn-add:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* ============================================
                       TABLA DE ITEMS
                       ============================================ */
        .items-section {
            display: flex;
            flex-direction: column;
        }

        .items-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--gray-100);
        }

        .items-title {
            font-family: var(--font-sans);
            font-size: 15px;
            font-weight: 600;
            color: var(--gray-800);
        }

        .items-count {
            font-family: var(--font-sans);
            font-size: 13px;
            color: var(--gray-500);
            background: var(--gray-100);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .items-table-wrapper {
            overflow-x: auto;
            max-height: 320px;
            overflow-y: auto;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
        }

        .items-table thead {
            position: sticky;
            top: 0;
            background: var(--gray-50);
            z-index: 10;
        }

        .items-table th {
            font-family: var(--font-sans);
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .items-table th.th-num {
            width: 50px;
            text-align: center;
        }

        .items-table th.th-qty,
        .items-table th.th-unit {
            text-align: center;
        }

        .items-table th.th-price,
        .items-table th.th-total {
            text-align: right;
        }

        .items-table th.th-action {
            width: 50px;
        }

        .items-table td {
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-700);
            padding: 14px 16px;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: middle;
        }

        .items-table tbody tr:hover {
            background: var(--gray-50);
        }

        .item-material-name {
            font-weight: 500;
            color: var(--gray-900);
        }

        .item-category {
            font-size: 12px;
            color: var(--gray-500);
            margin-top: 2px;
        }

        .item-variant-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
        }

        /* Inputs editables en tabla */
        .input-editable {
            width: 80px;
            height: 32px;
            padding: 4px 8px;
            font-family: var(--font-sans);
            font-size: 13px;
            color: var(--gray-900);
            background: #fff;
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            text-align: right;
            transition: all 0.15s ease;
        }

        .input-editable:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        }

        .input-editable:hover {
            border-color: var(--gray-400);
        }

        .input-editable-qty {
            width: 70px;
            text-align: center;
        }

        .input-editable-price {
            width: 100px;
            padding-left: 20px !important;
        }

        .input-price-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .input-price-symbol {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 13px;
            color: var(--gray-500);
            pointer-events: none;
        }

        .item-conversion {
            font-size: 12px;
            color: var(--primary);
            margin-top: 2px;
        }

        .item-unit-cost {
            font-size: 11px;
            color: var(--gray-500);
        }

        .td-center {
            text-align: center;
        }

        .td-right {
            text-align: right;
        }

        .td-total {
            font-weight: 600;
            color: var(--gray-900);
        }

        .btn-remove {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--gray-400);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-remove:hover {
            background: #fef2f2;
            color: var(--danger);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 20px !important;
        }

        .empty-icon {
            font-size: 48px;
            color: var(--gray-300);
            margin-bottom: 16px;
        }

        .empty-text {
            font-family: var(--font-sans);
            font-size: 15px;
            font-weight: 500;
            color: var(--gray-600);
            margin-bottom: 4px;
        }

        .empty-hint {
            font-family: var(--font-sans);
            font-size: 13px;
            color: var(--gray-400);
        }

        /* ============================================
                       TOTALES
                       ============================================ */
        .totals-section {
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
            padding: 16px 20px;
        }

        .totals-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .totals-label {
            font-family: var(--font-sans);
            font-size: 14px;
            color: var(--gray-600);
        }

        .totals-value {
            font-family: var(--font-sans);
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-800);
        }

        .totals-final {
            border-top: 1px solid var(--gray-300);
            margin-top: 8px;
            padding-top: 16px;
        }

        .totals-final .totals-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--gray-900);
        }

        .totals-final .totals-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--gray-900);
        }

        /* ============================================
                       SCROLLBAR PERSONALIZADA
                       ============================================ */
        .items-table-wrapper::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .items-table-wrapper::-webkit-scrollbar-track {
            background: var(--gray-100);
        }

        .items-table-wrapper::-webkit-scrollbar-thumb {
            background: var(--gray-300);
            border-radius: 3px;
        }

        .items-table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--gray-400);
        }

        /* ============================================
                       RESPONSIVE
                       ============================================ */
        @media (max-width: 768px) {
            .purchase-header {
                padding: 16px 20px;
                flex-wrap: wrap;
            }

            .purchase-header>div {
                flex-wrap: wrap;
                gap: 16px;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .purchase-content {
                padding: 16px;
            }

            .purchase-title {
                font-size: 20px;
            }

            .panel-main {
                margin-left: 0;
                margin-top: 16px;
            }

            .field-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            // Cargar items desde old() si existen (después de error de validación)
            let items = @json($oldItemsForJs ?? []);
            let itemIndex = items.length;

            const csrfToken = '{{ csrf_token() }}';

            // Cache selectores
            const $selectCategory = $('#select_category');
            const $selectMaterial = $('#select_material');
            const $selectVariant = $('#select_variant');
            const $selectUnit = $('#select_unit');
            const $inputQuantity = $('#input_quantity');
            const $inputPrice = $('#input_price');
            const $infoConversion = $('#info_conversion');
            const $infoConversionText = $('#info_conversion_text');
            const $infoSubtotal = $('#info_subtotal');
            const $infoSubtotalDisplay = $('#info_subtotal_display');
            const $btnAddItem = $('#btn_add_item');
            const $btnSubmit = $('#btn_submit');
            const $itemsBody = $('#items_body');
            const $itemsTotals = $('#items_totals');
            const $itemsCount = $('#items_count');
            const $hiddenContainer = $('#hidden_items_container');
            const $taxRate = $('#tax_rate');
            const $discountAmount = $('#discount_amount');

            // Estado temporal del item
            let currentItem = {
                category_id: null,
                category_name: '',
                material_id: null,
                material_name: '',
                variant_id: null,
                variant_sku: '',
                variant_color: '',
                unit_id: null,
                unit_name: '',
                unit_symbol: '',
                conversion_factor: 1,
                base_unit_symbol: '',
                quantity: 0,
                unit_price: 0
            };

            // Cambio de categoría
            $selectCategory.on('change', function() {
                const categoryId = $(this).val();
                currentItem.category_id = categoryId;
                currentItem.category_name = $(this).find('option:selected').text();
                currentItem.base_unit_symbol = $(this).find('option:selected').data('base-unit') || '';

                resetFromMaterial();

                if (!categoryId) {
                    $selectMaterial.prop('disabled', true).html(
                        '<option value="">Seleccionar...</option>');
                    return;
                }

                $selectMaterial.prop('disabled', true).html('<option value="">Cargando...</option>');

                $.ajax({
                    url: `/admin/purchases/ajax/materials/${categoryId}`,
                    method: 'GET',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    success: function(data) {
                        if (data.length === 0) {
                            $selectMaterial.html('<option value="">Sin materiales</option>');
                            Swal.fire({
                                icon: 'info',
                                title: 'Sin materiales',
                                text: 'No hay materiales registrados en esta categoría',
                                confirmButtonColor: '#2563eb'
                            });
                            return;
                        }
                        let options = '<option value="">Seleccionar...</option>';
                        data.forEach(function(material) {
                            const composition = material.composition ?
                                ` (${material.composition})` : '';
                            options +=
                                `<option value="${material.id}">${material.name}${composition}</option>`;
                        });
                        $selectMaterial.html(options).prop('disabled', false);
                    },
                    error: function(xhr) {
                        $selectMaterial.html('<option value="">Error</option>');
                        let msg = 'No se pudieron cargar los materiales.';
                        if (xhr.status === 404) msg = 'Ruta no encontrada (404).';
                        if (xhr.status === 500) msg = 'Error interno del servidor (500).';

                        Swal.fire({
                            icon: 'error',
                            title: 'Error al cargar materiales',
                            text: xhr.responseJSON?.message || msg,
                            confirmButtonColor: '#dc2626'
                        });
                    }
                });
            });

            // Cambio de material
            $selectMaterial.on('change', function() {
                const materialId = $(this).val();
                currentItem.material_id = materialId;
                currentItem.material_name = $(this).find('option:selected').text();

                resetFromVariant();

                if (!materialId) {
                    $selectVariant.prop('disabled', true).html(
                        '<option value="">Seleccionar...</option>');
                    return;
                }

                $selectVariant.prop('disabled', true).html('<option value="">Cargando...</option>');

                $.ajax({
                    url: `/admin/purchases/ajax/variants/${materialId}`,
                    method: 'GET',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    success: function(data) {
                        if (data.length === 0) {
                            $selectVariant.html('<option value="">Sin variantes</option>');
                            Swal.fire({
                                icon: 'info',
                                title: 'Sin variantes',
                                text: 'Este material no tiene variantes (SKU/colores) registradas',
                                confirmButtonColor: '#2563eb'
                            });
                            return;
                        }
                        let options = '<option value="">Seleccionar...</option>';
                        data.forEach(function(variant) {
                            const displayName = variant.color || 'Sin color';
                            const stock = variant.current_stock ?
                                ` (Stock: ${parseFloat(variant.current_stock).toFixed(2)})` :
                                '';
                            options +=
                                `<option value="${variant.id}" data-sku="${variant.sku}" data-color="${variant.color || ''}">${displayName}${stock}</option>`;
                        });
                        $selectVariant.html(options).prop('disabled', false);
                    },
                    error: function(xhr) {
                        $selectVariant.html('<option value="">Error</option>');
                        let msg = 'No se pudieron cargar las variantes.';
                        if (xhr.status === 404) msg = 'Ruta no encontrada (404).';

                        Swal.fire({
                            icon: 'error',
                            title: 'Error al cargar variantes',
                            text: xhr.responseJSON?.message || msg,
                            confirmButtonColor: '#dc2626'
                        });
                    }
                });
            });

            // Cambio de variante
            $selectVariant.on('change', function() {
                const variantId = $(this).val();
                const $selected = $(this).find('option:selected');
                currentItem.variant_id = variantId;
                currentItem.variant_sku = $selected.data('sku') || '';
                currentItem.variant_color = $selected.data('color') || '';

                resetFromUnit();

                if (!variantId || !currentItem.material_id) {
                    $selectUnit.prop('disabled', true).html(
                        '<option value="">Seleccionar...</option>');
                    return;
                }

                $selectUnit.prop('disabled', true).html('<option value="">Cargando...</option>');

                $.ajax({
                    url: `/admin/purchases/ajax/units/${currentItem.material_id}`,
                    method: 'GET',
                    headers: {
                        'X-CSRF-TOKEN': csrfToken
                    },
                    success: function(data) {
                        if (!data.units || data.units.length === 0) {
                            $selectUnit.html('<option value="">Sin unidades</option>');
                            Swal.fire({
                                icon: 'warning',
                                title: 'Sin unidades de compra',
                                text: 'Este material no tiene unidades de compra configuradas. Configure las conversiones primero.',
                                confirmButtonColor: '#f59e0b'
                            });
                            return;
                        }
                        let options = '<option value="">Seleccionar...</option>';
                        data.units.forEach(function(unit) {
                            const isBase = unit.is_base ? ' (Base)' : '';
                            options +=
                                `<option value="${unit.id}" data-factor="${unit.conversion_factor}" data-symbol="${unit.symbol}" data-name="${unit.name}">${unit.name} (${unit.symbol})${isBase}</option>`;
                        });
                        $selectUnit.html(options).prop('disabled', false);
                    },
                    error: function(xhr) {
                        $selectUnit.html('<option value="">Error</option>');
                        let msg = 'No se pudieron cargar las unidades de compra.';
                        if (xhr.status === 404) msg = 'Ruta no encontrada (404).';

                        Swal.fire({
                            icon: 'error',
                            title: 'Error al cargar unidades',
                            text: xhr.responseJSON?.message || msg,
                            confirmButtonColor: '#dc2626'
                        });
                    }
                });
            });

            // Cambio de unidad
            $selectUnit.on('change', function() {
                const unitId = $(this).val();
                const $selected = $(this).find('option:selected');

                currentItem.unit_id = unitId;
                currentItem.unit_name = $selected.data('name') || '';
                currentItem.unit_symbol = $selected.data('symbol') || '';
                currentItem.conversion_factor = parseFloat($selected.data('factor')) || 1;

                if (unitId) {
                    $inputQuantity.prop('disabled', false);
                    $inputPrice.prop('disabled', false);
                    updateConversionInfo();
                } else {
                    $inputQuantity.prop('disabled', true).val('');
                    $inputPrice.prop('disabled', true).val('');
                    $infoConversion.val('');
                    $infoConversionText.hide();
                    $infoSubtotal.val('');
                    $infoSubtotalDisplay.text('$0.00');
                }

                validateAddButton();
            });

            // Cambio de cantidad o precio
            $inputQuantity.on('input', function() {
                currentItem.quantity = parseFloat($(this).val()) || 0;
                updateConversionInfo();
                calculateItemSubtotal();
                validateAddButton();
            });

            $inputPrice.on('input', function() {
                currentItem.unit_price = parseFloat($(this).val()) || 0;
                calculateItemSubtotal();
                validateAddButton();
            });

            // Actualizar info de conversión
            function updateConversionInfo() {
                if (currentItem.conversion_factor && currentItem.conversion_factor != 1 && currentItem.quantity >
                    0) {
                    const converted = currentItem.quantity * currentItem.conversion_factor;
                    const text =
                        `= ${converted.toFixed(2)} ${currentItem.base_unit_symbol}`;
                    $infoConversion.val(text);
                    $infoConversionText.text(text).show();
                } else {
                    $infoConversion.val('');
                    $infoConversionText.hide();
                }
            }

            // Calcular subtotal del item actual
            function calculateItemSubtotal() {
                const subtotal = currentItem.quantity * currentItem.unit_price;
                const formatted = '$' + subtotal.toLocaleString('en-US', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                $infoSubtotal.val(subtotal);
                $infoSubtotalDisplay.text(formatted);
            }

            // Validar botón agregar
            function validateAddButton() {
                const canAdd = currentItem.variant_id &&
                    currentItem.unit_id &&
                    currentItem.quantity > 0 &&
                    currentItem.unit_price > 0;

                $btnAddItem.prop('disabled', !canAdd);
            }

            // Agregar item
            $btnAddItem.on('click', function() {
                // Verificar duplicados - si existe, sumar cantidad
                const existingIndex = items.findIndex(i =>
                    i.variant_id == currentItem.variant_id &&
                    i.unit_id == currentItem.unit_id
                );

                if (existingIndex !== -1) {
                    // Sumar cantidad al item existente
                    const existingItem = items[existingIndex];
                    const cantidadAnterior = existingItem.quantity;
                    existingItem.quantity += currentItem.quantity;
                    existingItem.subtotal = existingItem.quantity * existingItem.unit_price;
                    existingItem.converted_quantity = existingItem.quantity * existingItem
                        .conversion_factor;
                    existingItem.converted_unit_cost = existingItem.subtotal / existingItem
                        .converted_quantity;

                    renderItems();
                    resetForm();
                    updateTotals();

                    const variantInfo = existingItem.variant_color ? ` (${existingItem.variant_color})` :
                        '';
                    Swal.fire({
                        icon: 'success',
                        title: 'Cantidad actualizada',
                        html: `<strong>${existingItem.material_name}${variantInfo}</strong><br><br>` +
                            `Cantidad anterior: <strong>${cantidadAnterior.toFixed(2)} ${existingItem.unit_symbol}</strong><br>` +
                            `Se agregó: <strong>+${currentItem.quantity.toFixed(2)} ${currentItem.unit_symbol}</strong><br>` +
                            `Nueva cantidad: <strong>${existingItem.quantity.toFixed(2)} ${existingItem.unit_symbol}</strong>`,
                        confirmButtonColor: '#059669',
                        timer: 3000,
                        timerProgressBar: true
                    });
                    return;
                }

                const subtotal = currentItem.quantity * currentItem.unit_price;
                const converted_quantity = currentItem.quantity * currentItem.conversion_factor;
                const converted_unit_cost = subtotal / converted_quantity;

                const newItem = {
                    index: itemIndex,
                    category_name: currentItem.category_name,
                    material_name: currentItem.material_name,
                    variant_id: currentItem.variant_id,
                    variant_sku: currentItem.variant_sku,
                    variant_color: currentItem.variant_color,
                    unit_id: currentItem.unit_id,
                    unit_symbol: currentItem.unit_symbol,
                    quantity: currentItem.quantity,
                    unit_price: currentItem.unit_price,
                    conversion_factor: currentItem.conversion_factor,
                    converted_quantity: converted_quantity,
                    converted_unit_cost: converted_unit_cost,
                    base_unit_symbol: currentItem.base_unit_symbol,
                    subtotal: subtotal
                };

                items.push(newItem);
                itemIndex++;

                renderItems();
                resetForm();
                updateTotals();
            });

            // Renderizar tabla de items
            function renderItems() {
                if (items.length === 0) {
                    $itemsBody.html(`
                        <tr id="no_items_row">
                            <td colspan="8" class="empty-state">
                                <div class="empty-icon"><i class="fas fa-box-open"></i></div>
                                <div class="empty-text">La orden está vacía</div>
                                <div class="empty-hint">Agregue materiales usando el formulario superior</div>
                            </td>
                        </tr>
                    `);
                    $itemsTotals.hide();
                    $btnSubmit.prop('disabled', true);
                    $itemsCount.text('0 items');
                    return;
                }

                let html = '';
                items.forEach((item, idx) => {
                    const variantDisplay = item.variant_color || 'Sin color';
                    const conversionInfo = item.conversion_factor != 1 ?
                        `<div class="item-conversion" id="conv_${item.index}">= ${item.converted_quantity.toFixed(2)} ${item.base_unit_symbol}</div>` :
                        '';
                    const unitCostInfo = item.conversion_factor != 1 ?
                        `<div class="item-unit-cost" id="ucost_${item.index}">$${item.converted_unit_cost.toFixed(4)}/${item.base_unit_symbol}</div>` :
                        '';

                    html += `
                        <tr class="item-row" data-index="${item.index}">
                            <td class="td-center">${idx + 1}</td>
                            <td>
                                <div class="item-material-name">${item.material_name}</div>
                                <div class="item-category">${item.category_name}</div>
                            </td>
                            <td>
                                <span class="item-variant-name">${variantDisplay}</span>
                            </td>
                            <td class="td-center">
                                <input type="number" class="input-editable input-editable-qty input-qty"
                                    data-index="${item.index}"
                                    value="${item.quantity}"
                                    min="0.01" step="0.01">
                                ${conversionInfo}
                            </td>
                            <td class="td-center">${item.unit_symbol}</td>
                            <td class="td-right">
                                <div class="input-price-wrapper">
                                    <span class="input-price-symbol">$</span>
                                    <input type="number" class="input-editable input-editable-price input-price"
                                        data-index="${item.index}"
                                        value="${item.unit_price}"
                                        min="0.01" step="0.01">
                                </div>
                                ${unitCostInfo}
                            </td>
                            <td class="td-right td-total" id="total_${item.index}">$${item.subtotal.toFixed(2)}</td>
                            <td class="td-center">
                                <button type="button" class="btn-remove btn-remove-item" data-index="${item.index}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                $itemsBody.html(html);
                $itemsTotals.show();
                $btnSubmit.prop('disabled', false);
                $itemsCount.text(items.length + (items.length === 1 ? ' item' : ' items'));

                // Generar inputs hidden
                generateHiddenInputs();
            }

            // Generar inputs hidden para envío
            function generateHiddenInputs() {
                let html = '';
                items.forEach((item, idx) => {
                    html += `
                        <input type="hidden" name="items[${idx}][material_variant_id]" value="${item.variant_id}">
                        <input type="hidden" name="items[${idx}][unit_id]" value="${item.unit_id}">
                        <input type="hidden" name="items[${idx}][quantity]" value="${item.quantity}">
                        <input type="hidden" name="items[${idx}][unit_price]" value="${item.unit_price}">
                    `;
                });
                $hiddenContainer.html(html);
            }

            // Eliminar item
            $(document).on('click', '.btn-remove-item', function() {
                const index = $(this).data('index');
                items = items.filter(i => i.index !== index);
                renderItems();
                updateTotals();
            });

            // Editar cantidad inline
            $(document).on('input', '.input-qty', function() {
                const index = $(this).data('index');
                const newQty = parseFloat($(this).val()) || 0;

                const item = items.find(i => i.index === index);
                if (item && newQty > 0) {
                    item.quantity = newQty;
                    item.subtotal = item.quantity * item.unit_price;
                    item.converted_quantity = item.quantity * item.conversion_factor;
                    item.converted_unit_cost = item.subtotal / item.converted_quantity;

                    // Actualizar celda de total
                    $(`#total_${index}`).text('$' + item.subtotal.toFixed(2));

                    // Actualizar conversión si existe
                    if (item.conversion_factor != 1) {
                        $(`#conv_${index}`).text(
                            `= ${item.converted_quantity.toFixed(2)} ${item.base_unit_symbol}`);
                        $(`#ucost_${index}`).text(
                            `$${item.converted_unit_cost.toFixed(4)}/${item.base_unit_symbol}`);
                    }

                    generateHiddenInputs();
                    updateTotals();
                }
            });

            // Editar precio inline
            $(document).on('input', '.input-price', function() {
                const index = $(this).data('index');
                const newPrice = parseFloat($(this).val()) || 0;

                const item = items.find(i => i.index === index);
                if (item && newPrice > 0) {
                    item.unit_price = newPrice;
                    item.subtotal = item.quantity * item.unit_price;
                    item.converted_unit_cost = item.subtotal / item.converted_quantity;

                    // Actualizar celda de total
                    $(`#total_${index}`).text('$' + item.subtotal.toFixed(2));

                    // Actualizar costo por unidad base si existe
                    if (item.conversion_factor != 1) {
                        $(`#ucost_${index}`).text(
                            `$${item.converted_unit_cost.toFixed(4)}/${item.base_unit_symbol}`);
                    }

                    generateHiddenInputs();
                    updateTotals();
                }
            });

            // Actualizar totales
            function updateTotals() {
                const subtotal = items.reduce((sum, item) => sum + item.subtotal, 0);
                const taxRate = parseFloat($taxRate.val()) || 0;
                const discount = parseFloat($discountAmount.val()) || 0;
                const tax = subtotal * (taxRate / 100);
                const total = subtotal + tax - discount;

                $('#total_subtotal').text('$' + subtotal.toFixed(2));
                $('#tax_rate_display').text(taxRate.toFixed(0));
                $('#total_tax').text('$' + tax.toFixed(2));

                if (discount > 0) {
                    $('#discount_row').show();
                    $('#total_discount').text('-$' + discount.toFixed(2));
                } else {
                    $('#discount_row').hide();
                }

                $('#total_final').text('$' + Math.max(0, total).toFixed(2));
            }

            // Cambio en tasa de impuesto o descuento
            $taxRate.on('input', updateTotals);
            $discountAmount.on('input', updateTotals);

            // Reset funciones
            function resetFromMaterial() {
                currentItem.material_id = null;
                currentItem.material_name = '';
                $selectMaterial.val('').prop('disabled', true);
                resetFromVariant();
            }

            function resetFromVariant() {
                currentItem.variant_id = null;
                currentItem.variant_sku = '';
                currentItem.variant_color = '';
                $selectVariant.val('').prop('disabled', true).html(
                    '<option value="">Seleccionar...</option>');
                resetFromUnit();
            }

            function resetFromUnit() {
                currentItem.unit_id = null;
                currentItem.unit_name = '';
                currentItem.unit_symbol = '';
                currentItem.conversion_factor = 1;
                $selectUnit.val('').prop('disabled', true).html(
                    '<option value="">Seleccionar...</option>');
                $inputQuantity.val('').prop('disabled', true);
                $inputPrice.val('').prop('disabled', true);
                $infoConversion.val('');
                $infoConversionText.hide();
                $infoSubtotal.val('');
                $infoSubtotalDisplay.text('$0.00');
                $btnAddItem.prop('disabled', true);
            }

            function resetForm() {
                currentItem = {
                    category_id: null,
                    category_name: '',
                    material_id: null,
                    material_name: '',
                    variant_id: null,
                    variant_sku: '',
                    variant_color: '',
                    unit_id: null,
                    unit_name: '',
                    unit_symbol: '',
                    conversion_factor: 1,
                    base_unit_symbol: '',
                    quantity: 0,
                    unit_price: 0
                };

                $selectCategory.val('');
                $selectMaterial.val('').prop('disabled', true).html(
                    '<option value="">Seleccionar...</option>');
                $selectVariant.val('').prop('disabled', true).html(
                    '<option value="">Seleccionar...</option>');
                $selectUnit.val('').prop('disabled', true).html(
                    '<option value="">Seleccionar...</option>');
                $inputQuantity.val('').prop('disabled', true);
                $inputPrice.val('').prop('disabled', true);
                $infoConversion.val('');
                $infoConversionText.hide();
                $infoSubtotal.val('');
                $infoSubtotalDisplay.text('$0.00');
                $btnAddItem.prop('disabled', true);
            }

            // Validación antes de enviar
            $('#purchaseForm').on('submit', function(e) {
                if (items.length === 0) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Sin items',
                        text: 'Debe agregar al menos un item a la orden de compra',
                        confirmButtonColor: '#f59e0b'
                    });
                    return false;
                }

                if (!$('#proveedor_id').val()) {
                    e.preventDefault();
                    Swal.fire({
                        icon: 'warning',
                        title: 'Proveedor requerido',
                        text: 'Debe seleccionar un proveedor para la orden',
                        confirmButtonColor: '#f59e0b'
                    });
                    return false;
                }

                return true;
            });

            // Si hay items precargados (desde old() después de error), renderizarlos
            if (items.length > 0) {
                items = items.map((item, idx) => ({
                    ...item,
                    index: idx,
                    converted_unit_cost: item.subtotal / item.converted_quantity
                }));
                itemIndex = items.length;
                renderItems();
                updateTotals();
            }
        });
    </script>
@stop
</file>

<file path="resources/views/admin/purchases/index.blade.php">
@extends('adminlte::page')

@section('title', 'Órdenes de Compra')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info', 'warning'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold; font-size: 20px;">
                <i class="fas fa-shopping-cart"></i> ÓRDENES DE COMPRA
            </h3>
        </div>

        <div class="card-body">
            {{-- ACCIONES --}}
            <div class="row mb-3">
                <div class="col-12">
                    <a href="{{ route('admin.purchases.create') }}" class="btn btn-primary mr-2">
                        <i class="fas fa-plus"></i> Nueva Orden de Compra
                    </a>
                    <a href="{{ route('admin.proveedores.create') }}" class="btn btn-secondary">
                        <i class="fas fa-truck"></i> Crear Proveedor
                    </a>
                </div>
            </div>

            {{-- FILTROS (Mantenidos por si se requiere filtrado del servidor, 
                 aunque DataTables ofrece búsqueda local en la página actual) --}}
            <form method="GET" action="{{ route('admin.purchases.index') }}" id="filterForm" class="mb-3">
                <div class="row">
                    <div class="col-md-3">
                        <label class="small text-muted">Estado</label>
                        <select name="status" class="form-control form-control-sm">
                            <option value="">Todos los estados</option>
                            @foreach ($statuses as $value => $label)
                                <option value="{{ $value }}" {{ request('status') == $value ? 'selected' : '' }}>
                                    {{ $label }}
                                </option>
                            @endforeach
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="small text-muted">Proveedor</label>
                        <select name="proveedor_id" class="form-control form-control-sm">
                            <option value="">Todos los proveedores</option>
                            @foreach ($proveedores as $proveedor)
                                <option value="{{ $proveedor->id }}"
                                    {{ request('proveedor_id') == $proveedor->id ? 'selected' : '' }}>
                                    {{ $proveedor->nombre_proveedor }}
                                </option>
                            @endforeach
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">Desde</label>
                        <input type="date" name="date_from" class="form-control form-control-sm"
                            value="{{ request('date_from') }}">
                    </div>
                    <div class="col-md-2">
                        <label class="small text-muted">Hasta</label>
                        <input type="date" name="date_to" class="form-control form-control-sm"
                            value="{{ request('date_to') }}">
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        @if (request()->hasAny(['status', 'proveedor_id', 'date_from', 'date_to']))
                            <a href="{{ route('admin.purchases.index') }}" class="btn btn-sm btn-outline-secondary"
                                title="Limpiar filtros">
                                <i class="fas fa-times"></i>
                            </a>
                        @endif
                    </div>
                </div>
            </form>

            <hr>

            {{-- TABLA --}}
            <div class="table-responsive">
                {{-- ID agregado para DataTables --}}
                <table id="example1" class="table table-bordered table-hover table-sm text-center">
                    <thead class="thead-dark text-center">
                        <tr>
                            <th style="width: 120px;"># OC</th>
                            <th>Proveedor</th>
                            <th style="width: 100px;">Fecha</th>
                            <th style="width: 120px;">Estado</th>
                            <th style="width: 100px;" class="text-center">Items</th>
                            <th style="width: 130px;" class="text-center">Total</th>
                            <th style="width: 150px;" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @include('admin.purchases.partials.table_rows')
                    </tbody>
                </table>
            </div>

            {{-- PAGINACIÓN SERVER-SIDE --}}
            <div id="pagination-container" class="d-flex justify-content-center mt-3">
                @if ($purchases->hasPages())
                    {{ $purchases->links() }}
                @endif
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            /* Centrar los botones */
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        $(function() {
            var table;

            // Helper to get DataTables options
            function getTableOptions() {
                return {
                    "pageLength": 25,
                    "language": {
                        "emptyTable": "No hay informacion",
                        "info": "Mostrando _START_ a _END_ de _TOTAL_ Compras",
                        "infoEmpty": "Mostrando 0 a 0 de 0 Compras",
                        "infoFiltered": "(Filtrado de _MAX_ total Compras)",
                        "lengthMenu": "Mostrar _MENU_ Compras",
                        "loadingRecords": "Cargando...",
                        "processing": "Procesando...",
                        "search": "Buscador:",
                        "zeroRecords": "Sin resultados encontrados",
                        "paginate": {
                            "first": "Primero",
                            "last": "Ultimo",
                            "next": "Siguiente",
                            "previous": "Anterior"
                        }
                    },
                    "responsive": true,
                    "lengthChange": true,
                    "autoWidth": false,
                    "searching": true,
                    "paging": true,
                    "info": true,
                    buttons: [{
                            text: '<i class="fas fa-copy"></i> COPIAR',
                            extend: 'copy',
                            className: 'btn btn-default'
                        },
                        {
                            text: '<i class="fas fa-file-pdf"></i> PDF',
                            extend: 'pdf',
                            className: 'btn btn-danger'
                        },
                        {
                            text: '<i class="fas fa-file-csv"></i> CSV',
                            extend: 'csv',
                            className: 'btn btn-info'
                        },
                        {
                            text: '<i class="fas fa-file-excel"></i> EXCEL',
                            extend: 'excel',
                            className: 'btn btn-success'
                        },
                        {
                            text: '<i class="fas fa-print"></i> IMPRIMIR',
                            extend: 'print',
                            className: 'btn btn-default'
                        }
                    ]
                };
            }

            // Initialize DataTable
            function initDataTable() {
                if ($.fn.DataTable.isDataTable('#example1')) {
                    table = $('#example1').DataTable();
                } else {
                    table = $("#example1").DataTable(getTableOptions());
                    table.buttons().container().appendTo('#example1_wrapper .row:eq(0)');
                }
            }

            // Initial Load
            initDataTable();

            // Function to fetch data via AJAX
            function fetchResults(url) {
                let fetchUrl = url || "{{ route('admin.purchases.index') }}?" + $('#filterForm').serialize();

                $.ajax({
                    url: fetchUrl,
                    type: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {

                        // 1. Clear the table via API
                        table.clear();

                        // 2. Convert HTML to DOM nodes
                        var newRows = $(response.html).filter('tr');

                        // 3. Smart Add: Check if the returned row is a "No records" colspan row
                        var isEmptyRow = newRows.length === 1 && newRows.find('td').attr('colspan');

                        if (!isEmptyRow) {
                            // DataTables expects an Array of nodes, not a jQuery object
                            table.rows.add(newRows.toArray());
                        }

                        // 4. Redraw
                        table.draw();

                        // 5. Update Pagination
                        $('#pagination-container').html(response.pagination);
                    },
                    error: function(xhr) {
                        console.error("Error loading data:", xhr);
                    }
                });
            }

            // Event Listeners for Filters
            $('#filterForm select, #filterForm input[type="date"]').on('change', function() {
                fetchResults();
            });

            // Debounce for Text Search
            let timeout = null;
            $('#filterForm input[name="search"]').on('keyup', function() {
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    fetchResults();
                }, 500);
            });

            // Handle Pagination Links Click
            $(document).on('click', '#pagination-container a', function(e) {
                e.preventDefault();
                let url = $(this).attr('href');
                if (url) {
                    fetchResults(url);
                }
            });

            // Prevent Form Submit (Enter key)
            $('#filterForm').on('submit', function(e) {
                e.preventDefault();
                fetchResults();
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/units/index.blade.php">
@extends('adminlte::page')

@section('title', 'Unidades de Medida')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary">

        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> UNIDADES DE MEDIDA</h3>
        </div>

        <div class="card-body">

            {{-- MENSAJES FLASH --}}
            @foreach (['success', 'error', 'info'] as $msg)
                @if (session($msg))
                    <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show"
                        role="alert">
                        {{ session($msg) }}
                        <button type="button" class="close" data-dismiss="alert">
                            <span>&times;</span>
                        </button>
                    </div>
                @endif
            @endforeach

            <div class="row">
                <a href="{{ route('admin.units.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i>
                </a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Símbolo</th>
                                <th>Tipo</th>
                                <th>Compatible con</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach ($units as $unit)
                                <tr>
                                    <td>{{ $loop->iteration }}</td>
                                    <td>{{ $unit->name }}</td>
                                    <td><code>{{ $unit->symbol }}</code></td>
                                    <td>
                                        @if ($unit->unit_type)
                                            <span class="badge badge-{{ $unit->unit_type->badgeColor() }}"
                                                title="{{ $unit->unit_type->description() }}">
                                                <i class="fas {{ $unit->unit_type->icon() }} mr-1"></i>
                                                {{ $unit->unit_type->label() }}
                                            </span>
                                        @else
                                            <span class="badge badge-secondary">Sin tipo</span>
                                        @endif
                                    </td>
                                    <td>
                                        @if ($unit->is_base)
                                            <span class="text-muted">-</span>
                                        @elseif ($unit->compatibleBaseUnit)
                                            <span class="badge badge-success">
                                                <i class="fas fa-link mr-1"></i>
                                                {{ $unit->compatibleBaseUnit->name }}
                                            </span>
                                        @else
                                            <span class="badge badge-warning">
                                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                                Sin configurar
                                            </span>
                                        @endif
                                    </td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center align-items-center gap-1">
                                            <a href="{{ route('admin.units.edit', $unit->id) }}"
                                                class="btn btn-warning btn-sm" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{{ route('admin.units.confirm_delete', $unit->id) }}"
                                                class="btn btn-danger btn-sm" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        #example1_wrapper .btn {
            color: #fff;
            border-radius: 4px;
            padding: 5px 15px;
            font-size: 14px;
        }

        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #fff;
            border: none;
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay información",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Unidades",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Unidades",
                    "infoFiltered": "(Filtrado de _MAX_ total Unidades)",
                    "lengthMenu": "Mostrar _MENU_ Unidades",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="app/Http/Controllers/ProveedorController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Proveedor;
use App\Models\Estado;
use App\Models\Giro;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class ProveedorController extends Controller
{
    /**
     * Display a listing of the resource.
     */
    public function index()
    {
        $proveedores = Proveedor::where('activo', true)->with('estado', 'giro')->get();
        return view('admin.proveedores.index', compact('proveedores'));
    }

    /**
     * Show the form for creating a new resource.
     */
    public function create()
    {
        $estados = Estado::all()->where('activo', true);
        $giros = Giro::all()->where('activo', true);
        return view('admin.proveedores.create', compact('estados', 'giros'));
    }

    /**
     * Store a newly created resource in storage.
     */
    public function store(Request $request)
    {
        // dd($request->all());
        $request->validate([
            'nombre_proveedor' => ['required', 'string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.\,]+$/'],
            'giro_id' =>  ['required', 'exists:giros,id'],
            'direccion' =>  ['string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.\#]+$/', 'nullable'],
            'codigo_postal' => ['string', 'max:255', 'regex:/^[0-9]{5}$/', 'nullable'],
            'telefono' => ['required', 'string', 'max:255', 'regex:/^[0-9]{10}$/'],
            'email' => ['email', 'string', 'max:255', 'nullable'],
            'estado_id' => ['required', 'exists:estados,id'],
            'ciudad' => ['string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.]+$/', 'nullable'],
            'nombre_contacto' => ['string', 'max:255', 'regex:/^[a-zA-Z\sñÑáéíóúÁÉÍÓÚ\.]+$/', 'nullable'],
            'telefono_contacto' => ['string', 'max:255', 'regex:/^[0-9]{10}$/', 'nullable'],
            'email_contacto' => ['email', 'string', 'max:255', 'nullable'],
        ]);
        try {
            $proveedor = new Proveedor();
            $proveedor->nombre_proveedor = mb_strtoupper(trim($request->nombre_proveedor), 'UTF-8');
            $proveedor->giro_id = $request->giro_id;
            $proveedor->direccion = mb_strtoupper(trim($request->direccion), 'UTF-8');
            $proveedor->codigo_postal = $request->codigo_postal;
            $proveedor->telefono = $request->telefono;
            $proveedor->email = $request->email;
            $proveedor->estado_id = $request->estado_id;
            $proveedor->ciudad = mb_strtoupper(trim($request->ciudad), 'UTF-8');
            $proveedor->nombre_contacto = mb_strtoupper(trim($request->nombre_contacto), 'UTF-8');
            $proveedor->telefono_contacto = $request->telefono_contacto;
            $proveedor->email_contacto = $request->email_contacto;
            $proveedor->save();
            return redirect()->route('admin.proveedores.index')->with('success', 'Proveedor creado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al crear el proveedor: ' . $e->getMessage());
            return redirect()->route('admin.proveedores.index')->with('error', 'Error al crear el proveedor');
        }
    }

    /**
     * Display the specified resource.
     */
    public function show(Proveedor $proveedor)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     */
    public function edit($id)
    {
        $proveedor = Proveedor::where('activo', true)->with('estado', 'giro')->findOrFail($id);
        $estados = Estado::all();
        $giros = Giro::all();
        return view('admin.proveedores.edit', compact('proveedor', 'estados', 'giros'));
    }

    /**
     * Update the specified resource in storage.
     */
    public function update(Request $request, $id)
    {
        $request->validate([
            'nombre_proveedor' => ['required', 'string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.\,]+$/'],
            'giro_id' =>  ['required', 'exists:giros,id'],
            'direccion' =>  ['string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.\#]+$/', 'nullable'],
            'codigo_postal' => ['string', 'max:255', 'regex:/^[0-9]{5}$/', 'nullable'],
            'telefono' => ['required', 'string', 'max:255', 'regex:/^[0-9]{10}$/'],
            'email' => ['email', 'string', 'max:255', 'nullable'],
            'estado_id' => ['required', 'exists:estados,id'],
            'ciudad' => ['string', 'max:255', 'regex:/^[a-zA-Z0-9\sñÑáéíóúÁÉÍÓÚ\.]+$/', 'nullable'],
            'nombre_contacto' => ['string', 'max:255', 'regex:/^[a-zA-Z\sñÑáéíóúÁÉÍÓÚ\.]+$/', 'nullable'],
            'telefono_contacto' => ['string', 'max:255', 'regex:/^[0-9]{10}$/', 'nullable'],
            'email_contacto' => ['email', 'string', 'max:255', 'nullable'],
        ]);

        $proveedor = Proveedor::where('activo', true)->with('estado', 'giro')->findOrFail($id);

        try {

            $proveedor->nombre_proveedor = mb_strtoupper(trim($request->nombre_proveedor), 'UTF-8');
            $proveedor->giro_id = $request->giro_id;
            $proveedor->direccion = mb_strtoupper(trim($request->direccion), 'UTF-8');
            $proveedor->codigo_postal = $request->codigo_postal;
            $proveedor->telefono = $request->telefono;
            $proveedor->email = $request->email;
            $proveedor->estado_id = $request->estado_id;
            $proveedor->ciudad = mb_strtoupper(trim($request->ciudad), 'UTF-8');
            $proveedor->nombre_contacto = mb_strtoupper(trim($request->nombre_contacto), 'UTF-8');
            $proveedor->telefono_contacto = $request->telefono_contacto;
            $proveedor->email_contacto = $request->email_contacto;

            if (!$proveedor->isDirty()) {
                return redirect()->route('admin.proveedores.index')->with('info', 'No se realizaron cambios');
            }

            $proveedor->save();
            return redirect()->route('admin.proveedores.index')->with('success', 'Proveedor actualizado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al actualizar el proveedor: ' . $e->getMessage());
            return redirect()->route('admin.proveedores.index')->with('error', 'Error al actualizar el proveedor');
        }
    }

    public function confirm_delete($id)
    {
        $proveedor = Proveedor::where('activo', true)->with('estado', 'giro')->findOrFail($id);
        $estados = Estado::all();
        $giros = Giro::all();
        return view('admin.proveedores.delete', compact('proveedor', 'estados', 'giros'));
    }

    public function destroy($id)
    {
        $proveedor = Proveedor::where('activo', true)->with('estado', 'giro')->findOrFail($id);
        try {
            $proveedor->activo = false;
            $proveedor->save();
            return redirect()->route('admin.proveedores.index')->with('success', 'Proveedor eliminado exitosamente');
        } catch (\Exception $e) {
            Log::error('Error al eliminar el proveedor: ' . $e->getMessage());
            return redirect()->route('admin.proveedores.index')->with('error', 'Error al eliminar el proveedor');
        }
    }
}
</file>

<file path="resources/views/admin/giros/delete.blade.php">
@extends('adminlte::page')

@section('title', 'ELIMINAR GIRO')

@section('content_header')
@stop

@section('content')
    <br>
    <br>
    <div class="col-12 col-md-6 col-lg-4">

        {{-- MENSAJES FLASH --}}
        @foreach (['success', 'error', 'info'] as $msg)
            @if (session($msg))
                <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }}">
                    {{ session($msg) }}
                </div>
            @endif
        @endforeach

        @if ($errors->any())
            <div class="alert alert-danger">
                <ul class="mb-0">
                    @foreach ($errors->all() as $error)
                        <li>{{ $error }}</li>
                    @endforeach
                </ul>
            </div>
        @endif

        <div class="card card-danger " bis_skin_checked="1">

            <div class="card-header" bis_skin_checked="1">

                <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> ELIMINAR GIRO</h3>
                <!-- /.card-tools -->
            </div>
            <!-- /.card-header -->
            <div class="card-body" bis_skin_checked="1">
                <form id="deleteForm" method="post" action="{{ route('admin.giros.destroy', $giro->id) }}">
                    @csrf
                    @method('DELETE')
                    <div class="col-md-12">


                        <div style="border-bottom: 3px solid #007bff; padding-bottom: 8px; margin-bottom: 20px;">
                            <h5 style="color: #007bff; font-weight: 600; margin: 0; display: flex; align-items: center;">
                                <i class="fas fa-building" style="margin-right: 10px;"></i>
                                Datos del Giro
                            </h5>
                        </div>
                        <div class="form-group">


                            <label for="nombre_giro ">

                                Nombre <span style="color: red;">*</span>
                            </label>
                            <input type="text" class="form-control form-control-sm" id="nombre_giro" name="nombre_giro"
                                placeholder="Ej: TELA" pattern="[a-zA-ZñÑáéíóúÁÉÍÓÚ\s]+"
                                title="Solo se permiten letras y espacios" value="{{ $giro->nombre_giro }}"
                                oninput="this.value = this.value.replace(/[^a-zA-ZñÑáéíóúÁÉÍÓÚ\s]/g, '')" disabled>
                            @error('nombre_giro')
                                <div class="invalid-feedback">
                                    {{ $message }}
                                </div>
                            @enderror
                        </div>
                        <div style="font-weight: bold;font-size: 25px;text-align: center;">¿Deseas eliminar el
                            giro?</div>
                        <!-- Botones de acción -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="text-right">
                                    <a href="{{ route('admin.giros.index') }}" class="btn btn-secondary"
                                        style="margin-right: 10px; padding: 8px 20px;">
                                        <i class="fas fa-times-circle"></i> Regresar
                                    </a>
                                    <button type="submit" class="btn btn-danger" style="padding: 8px 20px;">
                                        <i class="fas fa-save"></i> Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <!-- /.card-body -->
        </div>
    </div>
@stop

@section('css')
    {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        document.getElementById('deleteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            Swal.fire({
                title: '¿Está seguro?',
                text: "¡No podrás revertir esto!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, eliminarlo',
                cancelButtonText: 'Cancelar',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/materials/index.blade.php">
@extends('adminlte::page')

@section('title', 'Materiales')

@section('content_header')
@stop

@section('content')
    <br>

    {{-- MENSAJES FLASH --}}
    @foreach (['success', 'error', 'info'] as $msg)
        @if (session($msg))
            <div class="alert alert-{{ $msg == 'error' ? 'danger' : $msg }} alert-dismissible fade show" role="alert">
                {{ session($msg) }}
                <button type="button" class="close" data-dismiss="alert">
                    <span>&times;</span>
                </button>
            </div>
        @endif
    @endforeach

    <div class="card card-primary">
        <div class="card-header">
            <h3 class="card-title" style="font-weight: bold;font-size: 20px;">
                <i class="fas fa-boxes"></i> CATÁLOGO DE MATERIALES
            </h3>
        </div>

        <div class="card-body">
            {{-- FILTROS Y ACCIONES --}}
            <div class="row mb-3">
                <div class="col-md-12 d-flex align-items-center flex-wrap">
                    <a href="{{ route('admin.materials.create') }}" class="btn btn-primary mr-2 mb-2">
                        Nuevo <i class="fas fa-plus"></i>
                    </a>
                    <a href="{{ route('admin.material-categories.index') }}" class="btn btn-secondary mr-2 mb-2">
                        <i class="fas fa-layer-group"></i> Categorías
                    </a>
                    <a href="{{ route('admin.units.index') }}" class="btn btn-secondary mr-3 mb-2">
                        <i class="fas fa-ruler"></i> Unidades
                    </a>

                    <form id="filterForm" method="GET" action="{{ route('admin.materials.index') }}"
                        class="form-inline mb-2">
                        <select name="category" class="form-control form-control-sm mr-2">
                            <option value="">Todas las categorías</option>
                            @foreach ($categories as $category)
                                <option value="{{ $category->id }}"
                                    {{ request('category') == $category->id ? 'selected' : '' }}>
                                    {{ $category->name }}
                                </option>
                            @endforeach
                        </select>
                        @if (request('category'))
                            <a href="{{ route('admin.materials.index') }}" class="btn btn-sm btn-outline-secondary">
                                <i class="fas fa-times"></i>
                            </a>
                        @endif
                    </form>
                </div>
            </div>

            <hr>

            {{-- TABLA --}}
            <div class="table-responsive">
                <table id="example1" class="table table-bordered table-hover text-center">
                    <thead class="thead-dark">
                        <tr>
                            <th style="width: 50px;">#</th>
                            <th>Categoría</th>
                            <th>Nombre</th>

                            <th>Composición</th>
                            <th style="width: 100px;">Unidad</th>
                            <th style="width: 100px;">Variantes</th>
                            <th style="width: 120px; text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @include('admin.materials.partials.table_rows')
                    </tbody>
                </table>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        #example1_wrapper .btn {
            color: #fff;
            border-radius: 4px;
            padding: 5px 15px;
            font-size: 14px;
        }

        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #fff;
            border: none;
        }

        /* Ajuste para iconos blancos en botones warning */
        .btn-warning i {
            color: white !important;
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            var table;

            // Helper to get DataTables options
            function getTableOptions() {
                return {
                    "pageLength": 10,
                    "language": {
                        "emptyTable": "No hay información",
                        "info": "Mostrando _START_ a _END_ de _TOTAL_ Materiales",
                        "infoEmpty": "Mostrando 0 a 0 de 0 Materiales",
                        "infoFiltered": "(Filtrado de _MAX_ total Materiales)",
                        "lengthMenu": "Mostrar _MENU_ Materiales",
                        "loadingRecords": "Cargando...",
                        "processing": "Procesando...",
                        "search": "Buscador:",
                        "zeroRecords": "Sin resultados encontrados",
                        "paginate": {
                            "first": "Primero",
                            "last": "Ultimo",
                            "next": "Siguiente",
                            "previous": "Anterior"
                        }
                    },
                    "responsive": true,
                    "lengthChange": true,
                    "autoWidth": false,
                    "buttons": [{
                            text: '<i class="fas fa-copy"></i> COPIAR',
                            extend: 'copy',
                            className: 'btn btn-default'
                        },
                        {
                            text: '<i class="fas fa-file-pdf"></i> PDF',
                            extend: 'pdf',
                            className: 'btn btn-danger'
                        },
                        {
                            text: '<i class="fas fa-file-csv"></i> CSV',
                            extend: 'csv',
                            className: 'btn btn-info'
                        },
                        {
                            text: '<i class="fas fa-file-excel"></i> EXCEL',
                            extend: 'excel',
                            className: 'btn btn-success'
                        },
                        {
                            text: '<i class="fas fa-print"></i> IMPRIMIR',
                            extend: 'print',
                            className: 'btn btn-default'
                        }
                    ]
                };
            }

            // Initialize DataTable
            function initDataTable() {
                if ($.fn.DataTable.isDataTable('#example1')) {
                    table = $('#example1').DataTable();
                } else {
                    table = $("#example1").DataTable(getTableOptions());
                    table.buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');
                }
            }

            initDataTable();

            // Function to fetch data via AJAX
            function fetchResults() {
                let form = $('#filterForm');
                let url = form.attr('action') + '?' + form.serialize();

                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    success: function(response) {
                        table.clear();

                        var newRows = $(response.html).filter('tr');
                        // Check for empty row if applicable, otherwise simple add
                        // In this case MaterialController returns ALL matching rows or empty list.
                        if (newRows.length > 0) {
                            table.rows.add(newRows.toArray());
                        }

                        table.draw();
                    },
                    error: function(xhr) {
                        console.error("Error loading data:", xhr);
                    }
                });
            }

            // Event Listeners
            $('#filterForm select[name="category"]').on('change', function() {
                fetchResults();

                // Toggle Clear Button
                if ($(this).val()) {
                    // Ideally we would show the clear button here, but it's server-rendered.
                    // For now, simpler to just filter.
                }
            });

            // Handle Clear Button if it exists (prevent default reload if desired? No, reload is fine for clearing)
        });
    </script>
@stop
</file>

<file path="resources/views/admin/designs/index.blade.php">
@extends('adminlte::page')

@section('title', 'Diseños')

@section('content_header')
    <div class="page-header-wrapper">
        <h1 class="page-title">Diseños</h1>
        <a href="{{ route('admin.designs.create') }}" class="btn-new-design">
            <i class="fas fa-plus"></i>
            <span>Nuevo diseño</span>
        </a>
    </div>
@stop

@section('content')

    <div class="row">

        {{-- SIDEBAR --}}
        <div class="col-lg-3">

            <div class="surface mb-4">
                <form method="GET" id="searchForm">
                    {{-- Contenedor relativo para agrupar todo --}}
                    <div class="position-relative d-flex align-items-center">

                        {{-- LUPA / SPINNER (IZQUIERDA) --}}
                        <span class="position-absolute" style="left: 12px; line-height: 1; z-index: 10;">
                            <i class="fas fa-search text-primary" id="searchIcon"></i>
                            <i class="fas fa-spinner fa-spin text-primary" id="searchSpinner" style="display: none;"></i>
                        </span>

                        <input type="text" name="search" id="searchInput" value="{{ request('search') }}"
                            placeholder="Buscar diseño…" autocomplete="off" class="search-input w-100"
                            style="padding-left: 40px; padding-right: 40px;">

                        {{-- Botón clear estilo iOS/Apple --}}
                        <a href="{{ route('admin.designs.index') }}" id="searchClear" class="search-clear"
                            style="display: {{ request('search') ? 'flex' : 'none' }};"></a>

                    </div>
                </form>
            </div>


            {{-- CATEGORIES --}}
            <div class="surface">
                <div class="sidebar-title mb-2">Categorías</div>

                <div class="category-list">

                    <a href="{{ route('admin.designs.index', request()->except('category')) }}"
                        class="category-item {{ !$activeCategory ? 'active' : '' }}">
                        <span>Todas</span>
                        <span class="category-count">{{ $designs->total() }}</span>
                    </a>

                    @foreach ($categories as $category)
                        <a href="{{ route('admin.designs.index', ['category' => $category->slug] + request()->except('category')) }}"
                            class="category-item {{ optional($activeCategory)->id === $category->id ? 'active' : '' }}">
                            <span>{{ $category->name }}</span>
                            <span class="category-count">
                                {{ $categoryCounts[$category->id] ?? 0 }}
                            </span>
                        </a>
                    @endforeach

                </div>
            </div>
        </div>

        {{-- GRID --}}
        <div class="col-lg-9" id="designsContainer">

            @if ($designs->count() > 0)
                <div class="design-grid" id="designGrid">

                    @foreach ($designs as $design)
                        <div class="design-card" data-design-id="{{ $design->id }}"
                            data-description="{{ $design->description ?? 'Sin descripción' }}"
                            data-name="{{ ucfirst($design->name) }}" data-variants="{{ $design->variants->count() }}"
                            data-exports="{{ $design->exports_count ?? 0 }}"
                            data-image="{{ $design->primaryImage ? asset('storage/' . $design->primaryImage->file_path) : '' }}"
                            data-edit-url="{{ route('admin.designs.edit', $design) }}"
                            data-delete-url="{{ route('admin.designs.destroy', $design) }}">

                            <div class="design-image">
                                @if ($design->primaryImage)
                                    <img src="{{ asset('storage/' . ($design->primaryImage->thumbnail_small ?? $design->primaryImage->file_path)) }}"
                                        data-full-src="{{ asset('storage/' . $design->primaryImage->file_path) }}"
                                        alt="{{ $design->name }}" loading="lazy"
                                        onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="no-image" style="display: none;">
                                        <i class="fas fa-image fa-3x mb-2 text-gray-300"></i>
                                        <span>Sin imagen</span>
                                    </div>
                                @else
                                    <div class="no-image">
                                        <i class="fas fa-image fa-3x mb-2 text-gray-300"></i>
                                        <span>Sin imagen</span>
                                    </div>
                                @endif
                            </div>

                            <div class="design-body text-center">
                                <h6 class="design-title">{{ ucfirst($design->name) }}</h6>
                                <div class="design-variants">
                                    {{ $design->variants->count() }}
                                    variante{{ $design->variants->count() != 1 ? 's' : '' }}
                                </div>
                                {{-- Contador de exportaciones con clase para actualización --}}
                                <div class="design-exports" data-design-id="{{ $design->id }}">
                                    <i class="fas fa-industry"></i>
                                    <span class="exports-number">{{ $design->exports_count ?? 0 }}</span>
                                    <span
                                        class="exports-text">exportación{{ ($design->exports_count ?? 0) != 1 ? 'es' : '' }}</span>
                                </div>
                            </div>

                        </div>
                    @endforeach

                </div>

                <div class="mt-4">

                </div>
            @else
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    No se encontraron diseños con los filtros aplicados.
                    <a href="{{ route('admin.designs.create') }}" class="alert-link">¿Deseas crear uno?</a>
                </div>
            @endif

        </div>
    </div>

    {{-- MODAL PRINCIPAL DEL DISEÑO - CON data-backdrop="static" --}}
    <div class="modal fade" id="designModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
            <div class="modal-content modal-premium" style="overflow: visible;">

                {{-- Botón Cerrar Flotante --}}
                <button type="button" class="modal-close-premium" data-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>

                <div class="modal-body p-0 position-relative">
                    <div class="modal-content-wrapper shadow-lg" style="border-radius: 30px; overflow: hidden;">
                        <div class="row no-gutters modal-row-responsive">

                            {{-- Campos ocultos para IDs (usados por el script de producción) --}}
                            <input type="hidden" id="modalDesignId" value="">
                            <input type="hidden" id="modalVariantId" value="">

                            {{-- ============================================
                            COLUMNA IZQUIERDA: IMAGEN PRINCIPAL
                            Apple HIG: Deferencia - El contenido es protagonista
                            ============================================ --}}
                            <div class="col-lg-6 modal-left-column">

                                {{-- Loader --}}
                                <div id="modalLoader" class="modal-loader-overlay">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">Cargando...</span>
                                    </div>
                                </div>

                                {{-- ÁREA DE IMAGEN PRINCIPAL (Protagonista) --}}
                                <div class="main-image-wrapper">
                                    {{-- Botón de descarga --}}
                                    <a id="downloadImageBtn" href="#" class="btn-download-floating" download>
                                        <i class="fas fa-download"></i>
                                    </a>

                                    {{-- Thumbnail para volver --}}
                                    <button type="button" id="btnBackToMainImage" onclick="backToMainImage()"
                                        class="btn-back-thumbnail" title="Volver a imagen principal">
                                        <img id="mainImageThumbnail" src="" alt="Principal">
                                        <i class="fas fa-home"></i>
                                    </button>

                                    {{-- Badge contador de producciones --}}
                                    <span id="mainImageProductionBadge" class="production-count-badge"
                                        data-count="0"></span>

                                    {{-- Overlay para añadir producción --}}
                                    <div class="image-production-overlay" id="mainImageOverlay">
                                        <button type="button" class="btn-add-production-overlay"
                                            onclick="addProductionFromImage('main')">
                                            <i class="fas fa-plus"></i>
                                            <span>Producción</span>
                                        </button>
                                    </div>

                                    {{-- Imagen --}}
                                    <img id="mainDisplayImage" src="" alt="Diseño">

                                    {{-- Estado vacío --}}
                                    <div id="noImageLabel" class="empty-image-state">
                                        <i class="fas fa-image"></i>
                                        <span>Sin Imagen</span>
                                    </div>
                                </div>

                                {{-- INFO DEL DISEÑO (debajo de imagen - Jerarquía F) --}}
                                <div class="design-info-section">
                                    {{-- Descripción --}}
                                    <p id="modalDesignDesc" class="design-description">Sin descripción</p>

                                    {{-- Título --}}
                                    <h2 id="modalDesignTitle" class="design-title">Nombre del Diseño</h2>


                                    {{-- Navegación de fotos --}}
                                    <div class="photo-navigation">
                                        <button type="button" class="btn-nav-arrow" onclick="navigateGalleryImage(-1)">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <span id="imageDescription" class="photo-counter">Imagen principal</span>
                                        <button type="button" class="btn-nav-arrow" onclick="navigateGalleryImage(1)">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>

                                {{-- ACCIONES (Fitts's Law: Botones grandes y accesibles) --}}
                                <div class="design-actions">
                                    <a href="#" id="btnEditDesign" class="btn-action-primary">
                                        <i class="fas fa-pencil-alt"></i>
                                        Editar Diseño
                                    </a>
                                    <button type="button" id="btnDeleteDesign" class="btn-action-danger">
                                        <i class="fas fa-trash-alt"></i>
                                        Eliminar
                                    </button>
                                </div>

                            </div>

                            {{-- ============================================
                            COLUMNA DERECHA: VARIANTES Y PRODUCCIÓN
                            ============================================ --}}
                            <div class="col-lg-6 modal-right-column">

                                {{-- TABS PARA VARIANTES Y PRODUCCIÓN --}}
                                <div class="modal-tabs-container mb-3">
                                    <ul class="nav nav-tabs" id="designModalTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <a class="nav-link active" id="variants-tab" data-toggle="tab"
                                                href="#variants-content" role="tab">
                                                <i class="fas fa-layer-group mr-1"></i> Variantes
                                                <span id="variantsTotalCount" class="badge badge-light ml-1">0</span>
                                            </a>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <a class="nav-link" id="production-tab" data-toggle="tab"
                                                href="#production-content" role="tab">
                                                <i class="fas fa-industry mr-1"></i> Producción
                                                <span id="productionTotalCount" class="badge badge-light ml-1">0</span>
                                            </a>
                                        </li>
                                    </ul>
                                </div>

                                {{-- CONTENIDO DE LOS TABS --}}
                                <div class="tab-content tab-content-flex">
                                    {{-- PESTAÑA DE VARIANTES (CONTENIDO EXISTENTE) --}}
                                    <div class="tab-pane fade show active" id="variants-content" role="tabpanel">
                                        {{-- SECCIÓN VARIANTES --}}
                                        <div class="variants-section">
                                            <div class="section-header">
                                                <div class="variant-nav-arrows">
                                                    <button type="button" class="btn-nav-sm"
                                                        onclick="navigateVariant(-1)" title="Variante anterior">
                                                        <i class="fas fa-chevron-left"></i>
                                                    </button>
                                                    <button type="button" class="btn-nav-sm"
                                                        onclick="navigateVariant(1)" title="Variante siguiente">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </button>
                                                </div>
                                                <h5 class="section-title">Variantes
                                                    <span id="variantsContentCount" class="variants-total-badge">0</span>
                                                </h5>
                                            </div>

                                            {{-- Tabs de Variantes --}}
                                            <div class="variant-tabs-wrapper">
                                                <div id="variantTabs" class="variant-tabs-scroll">
                                                    {{-- Se llena dinámicamente --}}
                                                </div>
                                            </div>
                                        </div>

                                        {{-- INFO VARIANTE SELECCIONADA --}}
                                        <div class="variant-selected-info">
                                            <div class="variant-name-price">
                                                <h6 id="variantName">Selecciona una variante</h6>
                                                <span id="variantPrice" class="price-badge" hidden>$0.00</span>
                                            </div>
                                            <span id="variantSku" class="sku-text" hidden>SKU: ---</span>
                                        </div>

                                        {{-- GALERÍA --}}
                                        <div class="gallery-section">
                                            <div class="gallery-header">
                                                <span class="gallery-label">Galería</span>
                                                <span id="galleryCount" class="gallery-badge">0</span>
                                            </div>

                                            <div class="gallery-grid-container">
                                                <div id="variantGallery" class="gallery-grid">
                                                    {{-- Estado vacío inicial --}}
                                                    <div class="gallery-empty-state">
                                                        <i class="fas fa-images"></i>
                                                        <p>No hay imágenes.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {{-- ACCIONES VARIANTES --}}
                                        <div class="variant-actions">

                                            <a href="#" id="btnEditVariants" class="btn-edit-variant disabled"
                                                style="pointer-events: none; opacity: 0.5;">
                                                <i class="fas fa-pencil-alt"></i>
                                                Editar Variante
                                            </a>
                                            <a href="#" id="btnAddVariant" class="btn-add-variant">
                                                <i class="fas fa-plus"></i>
                                                Nueva Variante
                                            </a>
                                        </div>
                                    </div>

                                    {{-- PESTAÑA DE PRODUCCIÓN (NUEVA) --}}
                                    <div class="tab-pane fade" id="production-content" role="tabpanel">
                                        @include('admin.designs.partials.production-tab')
                                    </div>
                                </div>

                            </div>

                        </div>
                    </div>
                </div>

                {{-- OVERLAY DE CARGA PREMIUM --}}
                <div class="modal-loading-overlay" id="loadingOverlay">
                    <div class="modal-loading-content">
                        <div class="modal-loading-spinner"></div>
                        <h3 class="modal-loading-title">Eliminando diseño</h3>
                        <p class="modal-loading-subtitle">
                            Por favor espera mientras procesamos tu solicitud.<br>
                            Esto puede tardar unos segundos.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {{-- MODAL DE CONFIRMACIÓN ELIMINAR DISEÑO --}}
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 440px;">
            <div class="modal-content modal-delete-apple" style="overflow: visible;">

                {{-- Botón Cerrar Flotante --}}
                <button type="button" class="modal-close-premium" data-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>

                {{-- Icono de advertencia --}}
                <div class="modal-delete-icon">
                    <div class="icon-wrapper">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>

                {{-- Título --}}
                <h3 class="modal-delete-title">
                    ¿Deseas eliminar este diseño?
                </h3>

                {{-- Mensaje de variantes (condicional) --}}
                <div id="variantsWarning" class="variants-warning" style="display: none;">
                    <p class="variants-message">
                        Este diseño tiene <strong id="variantsCount">0</strong> variante(s) y se eliminarán de igual
                        manera.
                    </p>
                </div>

                {{-- Descripción --}}
                <p class="modal-delete-description">
                    Esta acción no se puede deshacer. Todos los datos asociados se perderán permanentemente.
                </p>

                {{-- Botones de acción --}}
                {{-- Botones de acción (Vertical: Eliminar Arriba) --}}
                <div class="modal-delete-actions"
                    style="display: flex; flex-direction: column-reverse; gap: 12px; padding: 0 20px 24px;">
                    <button type="button" class="btn-cancel-apple" data-dismiss="modal"
                        style="width: 100%; justify-content: center;">
                        Cancelar
                    </button>
                    <button type="button" class="btn-delete-apple" id="confirmDeleteBtn"
                        style="width: 100%; justify-content: center;">
                        Eliminar diseño
                    </button>
                </div>

            </div>
        </div>
    </div>

@stop

@section('css')
    <style>
        /* ============================================
                                                                                                                                                                        PLACEHOLDERS Y UTILIDADES
                                                                                                                                                                        ============================================ */
        .no-img-placeholder {
            width: 45px;
            height: 45px;
            border-radius: 6px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 4px;
            font-size: 14px;
        }

        /* ============================================
                                                                                                                                                                        MODAL PREMIUM - ESTRUCTURA BASE
                                                                                                                                                                        ============================================ */
        .modal-premium {
            border-radius: 30px;
            border: none;
            overflow: visible;
            box-shadow: none;
            background: transparent;
        }

        /* ============================================
                                                                                                                                                                        BOTÓN CERRAR MODAL - ARREGLADO
                                                                                                                                                                        Estilos para el botón de cerrar (X) que estaba flotando mal
                                                                                                                                                                        ============================================ */
        .modal-close-premium {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e5e7eb;
            color: #374151;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9999;
            /* Alto z-index para estar por encima de todo */
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            outline: none;
        }

        .modal-close-premium:hover {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .modal-close-premium:active {
            transform: scale(0.95);
        }

        /* ============================================
                                                                                                                                                                        APPLE HIG MODAL - SISTEMA DE DISEÑO PREMIUM
                                                                                                                                                                        8pt Grid System | Claridad | Deferencia | Profundidad
                                                                                                                                                                        ============================================ */

        /* COLUMNA IZQUIERDA */
        .modal-left-column {
            display: flex;
            flex-direction: column;
            background: #ffffff;
            padding: 24px 28px;
            position: relative;
            border-right: 1px solid #f1f5f9;
        }

        /* COLUMNA DERECHA - CON PADDING CORRECTO */
        .modal-right-column {
            display: flex;
            flex-direction: column;
            background: #f9fafb;
            overflow: hidden;
            padding: 24px 28px;
            max-height: 600px;
        }

        .modal-loader-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        /* IMAGEN PRINCIPAL - Protagonista (Deferencia) */
        .main-image-wrapper {
            position: relative;
            width: 100%;
            height: 340px;
            background: #fafafa;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .main-image-wrapper>img#mainDisplayImage {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }

        /* Botón Descarga - Flotante */
        .btn-download-floating {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            display: none;
            align-items: center;
            justify-content: center;
            color: #374151;
            font-size: 18px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            z-index: 5;
        }

        .btn-download-floating:hover {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
            text-decoration: none;
        }

        /* Thumbnail Volver */
        .btn-back-thumbnail {
            position: absolute;
            top: 16px;
            left: 16px;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            border: 2px solid #2563eb;
            background: white;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transition: all 0.2s ease;
            display: none;
            z-index: 5;
        }

        .btn-back-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-back-thumbnail i {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            background: #2563eb;
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .btn-back-thumbnail:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
        }

        /* Estado Vacío de Imagen */
        .empty-image-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .empty-image-state i {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .empty-image-state span {
            font-size: 14px;
            font-weight: 500;
        }

        /* INFO DEL DISEÑO */
        .design-info-section {
            text-align: center;
            padding: 16px 0 8px;
        }

        .design-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 4px 0;
        }

        .design-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0 0 16px 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Navegación de Fotos */
        .photo-navigation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .photo-counter {
            font-size: 13px;
            color: #6b7280;
            font-weight: 500;
            min-width: 120px;
            text-align: center;
        }

        .btn-nav-arrow {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .btn-nav-arrow:hover {
            background: #e5e7eb;
            color: #374151;
            border-color: #d1d5db;
        }

        .btn-nav-arrow:active {
            background: #d1d5db;
            transform: scale(0.95);
        }

        /* ============================================
                                                                                                                                                                        BOTONES DE ACCIÓN - SISTEMA UNIFICADO PREMIUM
                                                                                                                                                                        Ambas columnas usan el mismo sistema
                                                                                                                                                                        ============================================ */

        /* Contenedor de acciones - BASE COMÚN */
        .design-actions,
        .variant-actions {
            display: flex;
            gap: 12px;
            padding: 16px 8px 16px 8px;
            margin-top: auto;
            border-top: 1px solid #e5e7eb;
        }

        /* Botón Primario - Editar Diseño (Negro) */
        .btn-action-primary {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            background: linear-gradient(180deg, #111827 0%, #1f2937 100%);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s ease;
            min-height: 52px;
            box-shadow: 0 2px 8px rgba(17, 24, 39, 0.2);
        }

        .btn-action-primary:hover {
            background: linear-gradient(180deg, #1f2937 0%, #374151 100%);
            color: white;
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(17, 24, 39, 0.3);
        }

        /* Botón Peligro - Eliminar (Rojo outline) */
        .btn-action-danger {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            background: white;
            color: #dc2626;
            border: 2px solid #fecaca;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 52px;
        }

        .btn-action-danger:hover {
            background: #fef2f2;
            border-color: #dc2626;
            transform: translateY(-1px);
        }

        .btn-action-danger:active {
            transform: translateY(0);
            background: #fee2e2;
        }

        /* Botón Azul - Nueva Variante */
        .btn-add-variant {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            background: linear-gradient(180deg, #2563eb 0%, #1d4ed8 100%);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
            min-height: 52px;
        }

        .btn-add-variant:hover {
            background: linear-gradient(180deg, #1d4ed8 0%, #1e40af 100%);
            color: white;
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
        }

        /* Botón Negro - Editar Variante */
        .btn-edit-variant {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 20px;
            background: linear-gradient(180deg, #111827 0%, #1f2937 100%);
            color: white;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(17, 24, 39, 0.25);
            min-height: 52px;
        }

        .btn-edit-variant:hover:not(.disabled) {
            background: linear-gradient(180deg, #1f2937 0%, #374151 100%);
            color: white;
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(17, 24, 39, 0.35);
        }

        .btn-edit-variant.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* ============================================
                                                                                                                                                                        COLUMNA DERECHA - VARIANTES Y PRODUCCIÓN
                                                                                                                                                                        ============================================ */

        /* Tabs del Modal */
        .modal-tabs-container {
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .modal-tabs-container .nav-tabs {
            border-bottom: none;
        }

        .modal-tabs-container .nav-tabs .nav-item {
            margin-bottom: -1px;
        }

        .modal-tabs-container .nav-tabs .nav-link {
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            padding: 10px 15px;
            transition: all 0.2s;
        }

        .modal-tabs-container .nav-tabs .nav-link:hover {
            color: #2563eb;
            border-bottom-color: #d1d5db;
        }

        .modal-tabs-container .nav-tabs .nav-link.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background: transparent;
        }

        /* Contenedor de tabs con flexbox */
        .tab-content-flex {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 0;
        }

        .tab-content-flex>.tab-pane {
            flex: 1;
            display: none !important;
            flex-direction: column;
            min-height: 0;
            overflow-y: auto;
        }

        .tab-content-flex>.tab-pane.active.show {
            display: flex !important;
        }

        /* Pestaña Variantes */
        #variants-content {
            flex: 1;
            display: flex !important;
            flex-direction: column;
        }

        #variants-content:not(.active) {
            display: none !important;
        }

        /* Pestaña Producción */
        #production-content {
            flex: 1;
            padding: 0;
        }

        #production-content:not(.active) {
            display: none !important;
        }

        #production-content.active.show {
            display: flex !important;
            flex-direction: column;
        }

        /* Sección Variantes */
        .variants-section {
            padding: 0 0 12px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            position: relative;
        }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin: 0;
            text-align: center;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Badge para el total de variantes */
        .variants-total-badge {
            background: #6b7280;
            color: white;
            font-size: 14px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        .variant-nav-arrows {
            display: flex;
            gap: 6px;
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
        }

        .btn-nav-sm {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .btn-nav-sm:hover {
            background: #e5e7eb;
            color: #374151;
        }

        /* Tabs de Variantes */
        .variant-tabs-wrapper {
            overflow: hidden;
        }

        .variant-tabs-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .variant-tabs-scroll::-webkit-scrollbar {
            display: none;
        }

        .variant-tab {
            flex-shrink: 0;
            width: 72px;
            padding: 8px;
            background: #f9fafb;
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
        }

        .variant-tab:hover {
            background: #f3f4f6;
        }

        .variant-tab.active {
            background: white;
            border-color: #2563eb;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
        }

        .variant-tab img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 4px;
        }

        .variant-tab span {
            display: block;
            font-size: 10px;
            font-weight: 600;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-transform: uppercase;
            letter-spacing: 0.2px;
        }

        /* Info Variante Seleccionada */
        .variant-selected-info {
            padding: 12px 0;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0;
        }

        .variant-name-price {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
        }

        .variant-name-price h6 {
            font-size: 15px;
            font-weight: 700;
            color: #111827;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .price-badge {
            font-size: 14px;
            font-weight: 700;
            color: #059669;
            background: #d1fae5;
            padding: 4px 12px;
            border-radius: 20px;
        }

        .sku-text {
            font-size: 11px;
            color: #9ca3af;
            font-family: 'SF Mono', monospace;
            letter-spacing: 0.3px;
        }

        /* GALERÍA */
        .gallery-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 12px 0 0;
            min-height: 120px;
            overflow: hidden;
        }

        .gallery-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .gallery-label {
            font-size: 14px;
            font-weight: 700;
            color: grey;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .gallery-badge {
            width: 24px;
            height: 24px;
            background: #2563eb;
            color: white;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* GRID DE GALERÍA - ALTURA AUTOMÁTICA */
        .gallery-grid-container {
            flex: 1;
            width: 100%;
            min-height: 60px;
            max-height: 180px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 4px;
        }

        /* Si solo hay 1-3 items (una fila), no necesita scroll */
        .gallery-grid-container:has(.gallery-grid:not(:has(.gallery-item:nth-child(4)))) {
            max-height: none;
            overflow-y: visible;
        }

        /* Cuando la galería está vacía, centrar contenido */
        .gallery-grid-container:has(.gallery-empty-state) {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Scrollbar visible y más ancho */
        .gallery-grid-container::-webkit-scrollbar {
            width: 10px;
        }

        .gallery-grid-container::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 5px;
        }

        .gallery-grid-container::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 5px;
            border: 2px solid #e5e7eb;
        }

        .gallery-grid-container::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%;
        }

        /* Cuando la galería está vacía, centrar contenido */
        .gallery-grid:has(.gallery-empty-state) {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .gallery-item {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            background: #f8fafc;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid #e5e7eb;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            object-position: center;
            padding: 2px;
            transition: transform 0.3s ease;
        }

        .gallery-item:hover {
            border-color: #93c5fd;
            transform: scale(1.02);
        }

        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .gallery-item.active {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }

        .gallery-item.active::after {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 16px;
            height: 16px;
            background: #2563eb;
            color: white;
            border-radius: 50%;
            font-size: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        /* ================================================
                                                                                                                                           HOVER OVERLAY PARA AÑADIR PRODUCCIÓN
                                                                                                                                           ================================================ */

        /* Overlay en IMAGEN PRINCIPAL - posicionado abajo */
        .main-image-wrapper .image-production-overlay {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            top: auto;
            height: 70px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 16px;
            opacity: 0;
            transition: opacity 0.25s ease;
            z-index: 3;
            /* Por debajo de los botones de descarga/thumbnail */
            border-radius: 0 0 inherit inherit;
            pointer-events: none;
        }

        .main-image-wrapper:hover .image-production-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        /* Asegurar que descarga y thumbnail estén por encima */
        .main-image-wrapper .btn-download-floating,
        .main-image-wrapper .btn-back-thumbnail {
            z-index: 15 !important;
        }

        /* Botón de producción en imagen principal */
        .main-image-wrapper .btn-add-production-overlay {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .main-image-wrapper .btn-add-production-overlay:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.5);
        }

        /* Badge contador en imagen principal */
        .main-image-wrapper .production-count-badge {
            position: absolute;
            bottom: 12px;
            left: 12px;
            top: auto;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
        }

        /* Overlay en GALERÍA - mismo estilo que imagen principal */
        .gallery-item .image-production-overlay {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            top: auto;
            height: 50px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 3;
            border-radius: 0 0 6px 6px;
            pointer-events: none;
        }

        .gallery-item:hover .image-production-overlay {
            opacity: 1;
            pointer-events: auto;
        }

        /* Botón para galería - mismo diseño que imagen principal */
        .gallery-item .btn-add-production-overlay {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 7px 14px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(16, 185, 129, 0.4);
        }

        .gallery-item .btn-add-production-overlay:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.5);
        }

        .gallery-item .btn-add-production-overlay i {
            font-size: 10px;
        }

        /* Badge contador en galería - posicionado abajo como imagen principal */
        .gallery-item .production-count-badge {
            position: absolute;
            bottom: 6px;
            left: 6px;
            top: auto;
            min-width: 20px;
            height: 20px;
            padding: 0 5px;
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
        }

        .production-count-badge:empty,
        .production-count-badge[data-count="0"] {
            display: none;
        }

        /* Estado Vacío Galería - Diseño Premium */
        .gallery-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            min-height: 80px;
            padding: 16px;
            color: #9ca3af;
            text-align: center;
        }

        .gallery-empty-state i {
            font-size: 28px;
            margin-bottom: 8px;
            opacity: 0.4;
            color: #cbd5e1;
        }

        .gallery-empty-state p {
            font-size: 12px;
            font-weight: 500;
            margin: 0;
            color: #9ca3af;
        }

        /* ============================================
                                                                                                                                           PAGE HEADER - Enterprise/SaaS Style
                                                                                                                                           ============================================ */
        .page-header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .page-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
            line-height: 1.2;
        }

        .btn-new-design {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            text-decoration: none;
            border-radius: 10px;
            box-shadow: 0 4px 14px rgba(37, 99, 235, 0.35);
            transition: all 0.2s ease;
            white-space: nowrap;
            min-height: 44px;
        }

        .btn-new-design:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
            color: #fff;
            text-decoration: none;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn-new-design:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .btn-new-design i {
            font-size: 12px;
        }

        /* ============================================
                                                                                                                                                                        ESTILOS DEL GRID DE TARJETAS
                                                                                                                                                                        ============================================ */
        .surface {
            background: #fff;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 6px 30px rgba(0, 0, 0, .04);
        }

        .search-input {
            width: 100%;
            padding: 14px 40px 14px 16px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .category-list {
            max-height: 420px;
            overflow-y: auto;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 14px;
            border-radius: 10px;
            text-decoration: none;
            color: #374151;
            transition: all 0.2s;
        }

        .category-item:hover {
            background: #f3f4f6;
            text-decoration: none;
        }

        .category-item.active {
            background: #2563eb;
            color: white;
        }

        .design-card {
            border-radius: 18px;
            border: 1px solid #a8a7a7;
            overflow: hidden;
            cursor: pointer;
            transition: all .25s;
            background: #fff;
        }

        .design-card:hover {
            border: 1px solid #1e5de6;
            box-shadow: 0 18px 40px rgba(37, 99, 235, .15);
            transform: translateY(-6px);
        }

        .design-image {
            height: 180px;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }

        .design-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .no-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .no-image i {
            margin-bottom: 8px;
        }

        .design-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .design-body {
            padding: 16px;
        }

        .design-body .design-title {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .design-variants {
            font-size: 13px;
            color: #6b7280;
        }

        /* Badge de exportaciones en tarjeta - MEJORADO */
        .design-exports {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 12px;
            color: #6b7280;
            margin-top: 8px;
            padding: 6px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            transition: all 0.2s ease;
        }

        .design-exports i {
            font-size: 11px;
            color: #2563eb;
        }

        .design-card:hover .design-exports {
            background: #e0e7ff;
        }

        /* Animación de actualización */
        .design-exports.updated {
            animation: pulse-exports 0.4s ease;
        }

        @keyframes pulse-exports {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                background: #dbeafe;
            }

            100% {
                transform: scale(1);
            }
        }

        /* ============================================
                                                                                                                                                                        MODAL DE CONFIRMACIÓN ELIMINAR
                                                                                                                                                                        ============================================ */
        .modal-delete-apple {
            border-radius: 24px;
            border: none;
            padding: 32px 28px 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25),
                0 0 1px rgba(0, 0, 0, 0.1);
            background: #ffffff;
        }

        .modal-delete-icon {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .modal-delete-icon .icon-wrapper {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(252, 211, 77, 0.3);
        }

        .modal-delete-icon i {
            font-size: 28px;
            color: #d97706;
        }

        .modal-delete-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
            margin-bottom: 16px;
            letter-spacing: -0.5px;
            line-height: 1.3;
        }

        .variants-warning {
            background: #fef3c7;
            border: 1.5px solid #fde68a;
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 16px;
        }

        .variants-message {
            margin: 0;
            font-size: 0.95rem;
            color: #92400e;
            text-align: center;
            line-height: 1.5;
        }

        .variants-message strong {
            color: #78350f;
            font-weight: 700;
        }

        .modal-delete-description {
            font-size: 0.95rem;
            color: #6b7280;
            text-align: center;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .modal-delete-actions {
            display: flex;
            gap: 12px;
            flex-direction: column;
        }

        .btn-cancel-apple {
            background: #f3f4f6;
            border: 1.5px solid #e5e7eb;
            color: #374151;
            font-weight: 600;
            font-size: 1rem;
            padding: 14px 24px;
            border-radius: 12px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            letter-spacing: 0.2px;
        }

        .btn-cancel-apple:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
            transform: translateY(-1px);
        }

        .btn-delete-apple {
            background: linear-gradient(180deg, #dc2626 0%, #b91c1c 100%);
            border: none;
            color: #ffffff;
            font-weight: 600;
            font-size: 1rem;
            padding: 14px 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.25);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .btn-delete-apple:hover {
            background: linear-gradient(180deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(220, 38, 38, 0.3);
        }

        .btn-delete-apple.loading {
            position: relative;
            color: transparent;
        }

        .btn-delete-apple.loading::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ============================================
                                                                                                                                                                        ESTADOS DE CARGA
                                                                                                                                                                        ============================================ */
        .modal-loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 30px;
        }

        .modal-loading-content {
            text-align: center;
            padding: 40px;
            max-width: 320px;
        }

        .modal-loading-spinner {
            width: 64px;
            height: 64px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-radius: 50%;
            border-top-color: #2563eb;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .modal-loading-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .modal-loading-subtitle {
            font-size: 0.95rem;
            color: #6b7280;
            line-height: 1.5;
        }

        /* ============================================
                                                                                                                                                                        RESPONSIVE - BREAKPOINTS ESTÁNDAR
                                                                                                                                                                        xs: <576px | sm: 576-767px | md: 768-991px | lg: 992-1199px | xl: ≥1200px
                                                                                                                                                                        ============================================ */

        /* ===== XL: Pantallas grandes (≥1200px) ===== */
        @media (min-width: 1200px) {
            .design-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* ===== LG: Desktop (992px - 1199px) ===== */
        @media (min-width: 992px) and (max-width: 1199px) {
            .design-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .category-list {
                max-height: 350px;
            }
        }

        /* ===== MD: Tablets (768px - 991px) ===== */
        @media (max-width: 991px) {

            /* Modal */
            .modal-left-column {
                border-right: none;
                border-bottom: 1px solid #f1f5f9;
            }

            .modal-right-column {
                padding: 20px;
                max-height: none;
            }

            .main-image-wrapper {
                height: 280px;
            }

            /* Sidebar colapsable */
            .col-lg-3 {
                margin-bottom: 20px;
            }

            /* Categorías en horizontal scroll */
            .category-list {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                max-height: none;
                gap: 8px;
                padding-bottom: 8px;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }

            .category-item {
                flex-shrink: 0;
                white-space: nowrap;
                padding: 8px 16px;
            }

            .category-count {
                margin-left: 8px;
            }

            /* Grid 2 columnas en tablet */
            .design-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .design-image {
                height: 160px;
            }

            /* Surface más compacta */
            .surface {
                padding: 16px;
                border-radius: 12px;
            }

            .sidebar-title {
                display: none;
            }
        }

        /* ===== SM: Móviles grandes (576px - 767px) ===== */
        @media (max-width: 768px) {
            .modal-dialog.modal-xl {
                max-width: 95%;
                margin: 10px auto;
            }

            .main-image-wrapper {
                height: 240px;
            }

            .design-actions,
            .variant-actions {
                flex-direction: row;
                gap: 10px;
            }

            .btn-action-primary,
            .btn-action-danger,
            .btn-add-variant,
            .btn-edit-variant {
                padding: 12px 14px;
                font-size: 13px;
                min-height: 48px;
            }

            /* Grid responsive */
            .design-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .design-card {
                border-radius: 14px;
            }

            .design-image {
                height: 140px;
                padding: 6px;
            }

            .design-body {
                padding: 12px;
            }

            .design-body .design-title {
                font-size: 0.9rem;
            }

            .design-variants {
                font-size: 12px;
            }

            .design-exports {
                font-size: 11px;
                padding: 5px 10px;
            }

            /* Search input */
            .search-input {
                padding: 12px 36px 12px 14px;
                font-size: 14px;
            }

            /* Header responsive - Tablet */
            .page-title {
                font-size: 1.5rem;
            }

            .btn-new-design {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* ===== XS: Móviles pequeños (<576px) ===== */
        @media (max-width: 576px) {
            .modal-dialog.modal-xl {
                max-width: 100%;
                margin: 5px;
            }

            .modal-left-column,
            .modal-right-column {
                padding: 16px;
            }

            .main-image-wrapper {
                height: 200px;
            }

            .design-actions,
            .variant-actions {
                flex-direction: column;
                gap: 8px;
            }

            .btn-action-primary,
            .btn-action-danger,
            .btn-add-variant,
            .btn-edit-variant {
                width: 100%;
                flex: none;
            }

            /* Grid 1 columna en móvil pequeño - Cards más grandes */
            .design-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .design-card {
                display: flex;
                flex-direction: row;
                border-radius: 12px;
            }

            .design-image {
                width: 120px;
                min-width: 120px;
                height: 120px;
                border-radius: 12px 0 0 12px;
            }

            .design-body {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
                text-align: left;
                padding: 12px 16px;
            }

            .design-body .design-title {
                font-size: 1rem;
                margin-bottom: 4px;
            }

            .design-exports {
                justify-content: flex-start;
                margin-top: 6px;
            }

            /* Categorías scroll horizontal más compacto */
            .category-list {
                gap: 6px;
            }

            .category-item {
                padding: 6px 12px;
                font-size: 13px;
                border-radius: 8px;
            }

            /* Surface */
            .surface {
                padding: 12px;
                border-radius: 10px;
                margin-bottom: 12px !important;
            }

            /* Search */
            .search-input {
                padding: 10px 32px 10px 12px;
                border-radius: 10px;
            }

            /* Header - Mobile */
            .page-header-wrapper {
                gap: 12px;
            }

            .page-title {
                font-size: 1.35rem;
            }

            .btn-new-design {
                padding: 10px 14px;
                font-size: 13px;
                border-radius: 8px;
            }

            .btn-new-design i {
                font-size: 11px;
            }

            /* Alert info responsive */
            .alert-info {
                font-size: 13px;
                padding: 12px;
            }
        }

        /* ===== XXS: Móviles muy pequeños (<400px) ===== */
        @media (max-width: 400px) {

            /* Header - XXS: Stack vertical */
            .page-header-wrapper {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .page-title {
                font-size: 1.25rem;
                text-align: center;
            }

            .btn-new-design {
                justify-content: center;
                padding: 12px 16px;
                width: 100%;
            }

            .design-image {
                width: 100px;
                min-width: 100px;
                height: 100px;
            }

            .design-body {
                padding: 10px 12px;
            }

            .design-body .design-title {
                font-size: 0.9rem;
            }

            .design-variants {
                font-size: 11px;
            }

            .design-exports {
                font-size: 10px;
                padding: 4px 8px;
            }

            .category-item {
                padding: 5px 10px;
                font-size: 12px;
            }
        }

        /* ===== Scrollbar personalizado para categorías ===== */
        .category-list::-webkit-scrollbar {
            height: 4px;
        }

        .category-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 2px;
        }

        .category-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .category-list::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* ===== Transiciones suaves en cambios de tamaño ===== */
        .design-card,
        .design-image,
        .design-body,
        .surface,
        .category-item {
            transition: all 0.2s ease;
        }

        /* ============================================
                                                                                                                                           WEB APP / PWA - OPTIMIZACIONES TOUCH & MOBILE
                                                                                                                                           ============================================ */

        /* Touch Target mínimo 44x44px (Apple HIG / Material Design) */
        .design-card,
        .category-item,
        .btn,
        .modal-close {
            min-height: 44px;
            min-width: 44px;
        }

        /* Mejor feedback táctil */
        .design-card {
            -webkit-tap-highlight-color: rgba(37, 99, 235, 0.1);
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .design-card:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .category-item {
            -webkit-tap-highlight-color: rgba(37, 99, 235, 0.15);
            touch-action: manipulation;
        }

        .category-item:active {
            transform: scale(0.97);
        }

        /* Input optimizado para móvil */
        .search-input {
            font-size: 16px !important;
            /* Previene zoom en iOS */
            -webkit-appearance: none;
            appearance: none;
        }

        /* Botón clear - Estilo Apple/Premium */
        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0;
            /* Ocultar el × de texto */
            border-radius: 50%;
            background: #c4c4c6;
            color: #fff;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.15s ease;
            z-index: 10;
        }

        /* Icono X con pseudo-elementos (estilo iOS) */
        .search-clear::before,
        .search-clear::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 1.5px;
            background: #fff;
            border-radius: 1px;
        }

        .search-clear::before {
            transform: rotate(45deg);
        }

        .search-clear::after {
            transform: rotate(-45deg);
        }

        .search-clear:hover {
            background: #8e8e93;
            text-decoration: none;
        }

        .search-clear:active {
            background: #636366;
            transform: translateY(-50%) scale(0.92);
        }

        /* Safe Areas para iPhone X+ (notch) */
        @supports (padding: max(0px)) {
            .page-header-wrapper {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }

            .modal-body {
                padding-bottom: max(20px, env(safe-area-inset-bottom));
            }

            .surface {
                margin-left: max(0px, env(safe-area-inset-left));
                margin-right: max(0px, env(safe-area-inset-right));
            }
        }

        /* Smooth scrolling nativo */
        .category-list,
        .design-grid,
        .modal-body {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Prevenir scroll bounce en iOS */
        .designs-container {
            overscroll-behavior: contain;
        }

        /* Optimización de renderizado GPU */
        .design-card,
        .modal-dialog {
            will-change: transform;
            transform: translateZ(0);
            backface-visibility: hidden;
        }

        /* Loading state visual */
        .design-card.loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Skeleton loading placeholder */
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        /* Pull-to-refresh indicator (futuro) */
        .ptr-indicator {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%) translateY(-100%);
            transition: transform 0.2s ease;
            z-index: 9999;
        }

        /* Orientation changes */
        @media (orientation: landscape) and (max-height: 500px) {
            .design-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .design-image {
                height: 100px;
            }

            .modal-dialog.modal-xl {
                max-height: 95vh;
            }
        }

        /* Tablet landscape optimization */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
            .design-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 14px;
            }

            .design-image {
                height: 130px;
            }
        }

        /* High DPI / Retina displays */
        @media (-webkit-min-device-pixel-ratio: 2),
        (min-resolution: 192dpi) {
            .design-card {
                border-width: 0.5px;
            }
        }

        /* Reduced motion accessibility */
        @media (prefers-reduced-motion: reduce) {

            .design-card,
            .design-image,
            .design-body,
            .surface,
            .category-item,
            .modal-dialog {
                transition: none !important;
                animation: none !important;
            }

            .design-card:active {
                transform: none;
            }
        }

        /* Dark mode support (futuro) */
        @media (prefers-color-scheme: dark) {

            /* Variables preparadas para dark mode */
            :root {
                --bg-surface: #1f2937;
                --text-primary: #f9fafb;
                --text-secondary: #9ca3af;
                --border-color: #374151;
            }
        }

        /* Hover states solo para dispositivos con hover real */
        @media (hover: hover) and (pointer: fine) {
            .design-card:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 40px -12px rgba(0, 0, 0, 0.25);
            }

            .category-item:hover {
                background: rgba(37, 99, 235, 0.08);
            }
        }

        /* Touch devices - no hover effects */
        @media (hover: none) {
            .design-card:hover {
                transform: none;
                box-shadow: 0 4px 20px -8px rgba(0, 0, 0, 0.12);
            }
        }

        /* Foldable devices support */
        @media (horizontal-viewport-segments: 2) {
            .design-grid {
                gap: calc(env(viewport-segment-right 0 0) - env(viewport-segment-left 0 0) + 16px);
            }
        }
    </style>
@stop

@section('js')
    {{-- Tu código JavaScript existente se mantiene intacto --}}
    <script>
        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let currentDesign = null;
        let currentVariants = [];
        let currentVariantIndex = -1;
        let currentGalleryImages = [];
        let currentGalleryIndex = 0;
        let currentDisplayedImageId = null; // ID de la imagen actualmente mostrada
        let pendingDeleteUrl = null;
        let isProcessingDelete = false;
        let isViewingDesignImage = true;

        // ============================================
        // CACHE DE CONTADORES DE PRODUCCIÓN (ENTERPRISE-LEVEL)
        // Evita flickering al cambiar entre variantes/diseño
        // Includes AbortController for request cancellation on rapid context switches
        // ============================================
        const productionCountCache = {
            design: {}, // { designId: count }
            variant: {}, // { variantId: count }
            loading: new Set(), // Prevent duplicate fetches
            requestVersion: 0, // Tracks current context to cancel stale responses
            abortController: null // AbortController for cancelling pending requests
        };

        // ============================================
        // INICIALIZACIÓN: EVENT LISTENERS EN CARDS
        // ============================================
        document.querySelectorAll('.design-card').forEach(card => {
            card.addEventListener('click', function() {
                if (isProcessingDelete) return;

                const designId = this.dataset.designId;
                const showUrl = `/admin/designs/${designId}`;

                // Mostrar modal y loader
                $('#designModal').modal('show');
                const loader = document.getElementById('modalLoader');
                if (loader) {
                    loader.style.setProperty('display', 'flex', 'important');
                    loader.style.opacity = '1';
                }

                // Limpiar vista anterior  
                clearModal();

                // Fetch diseño completo
                fetch(showUrl)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderModal(data.design);
                        } else {
                            showErrorAlert('Error', 'No se pudo cargar el diseño');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showErrorAlert('Error de conexión',
                            'Por favor verifica tu conexión a internet');
                    })
                    .finally(() => {
                        const loaderEl = document.getElementById('modalLoader');
                        if (loaderEl) loaderEl.style.setProperty('display', 'none', 'important');
                    });
            });
        });

        // ============================================
        // CLEANUP: Limpiar cache de producción al cerrar modal
        // ============================================
        $('#designModal').on('hidden.bs.modal', function() {
            clearProductionCountCache();
            document.getElementById('productionTotalCount').innerText = '0';
        });

        // ============================================
        // FUNCIÓN: LIMPIAR MODAL
        // ============================================
        function clearModal() {
            document.getElementById('modalDesignTitle').innerText = '';
            document.getElementById('modalDesignDesc').innerText = '';
            document.getElementById('mainDisplayImage').src = '';
            document.getElementById('mainDisplayImage').style.display = 'none';
            document.getElementById('variantTabs').innerHTML = '';
            document.getElementById('variantName').innerText = 'Selecciona una variante';
            document.getElementById('variantPrice').innerText = '$0.00';
            document.getElementById('variantSku').innerText = 'SKU: ---';
            document.getElementById('galleryCount').innerText = '0';
            document.getElementById('variantsTotalCount').innerText = '0';
            document.getElementById('variantsContentCount').innerText = '0';
            // NO resetear productionTotalCount aquí para evitar flickering
            // El valor se actualizará cuando se cargue el nuevo diseño
            document.getElementById('noImageLabel').style.setProperty('display', 'none', 'important');
            document.getElementById('imageDescription').innerText = 'Imagen Principal del Diseño';

            // Limpiar campos ocultos para pestaña de producción
            document.getElementById('modalDesignId').value = '';
            document.getElementById('modalVariantId').value = '';

            // Ocultar botón de descarga
            document.getElementById('downloadImageBtn').style.display = 'none';

            // Mostrar estado vacío de galería
            document.getElementById('variantGallery').innerHTML =
                '<div class="gallery-empty-state"><i class="fas fa-images"></i><p>No hay imágenes.</p></div>';

            // Deshabilitar botón editar variante
            const btnEditVariants = document.getElementById('btnEditVariants');
            if (btnEditVariants) {
                btnEditVariants.classList.add('disabled');
                btnEditVariants.style.pointerEvents = 'none';
                btnEditVariants.style.opacity = '0.5';
                btnEditVariants.href = '#';
            }

            // RESETEAR TABS - Siempre volver a pestaña de Variantes
            const variantsTab = document.getElementById('variants-tab');
            const productionTab = document.getElementById('production-tab');
            const variantsContent = document.getElementById('variants-content');
            const productionContent = document.getElementById('production-content');

            if (variantsTab && productionTab && variantsContent && productionContent) {
                variantsTab.classList.add('active');
                productionTab.classList.remove('active');
                variantsContent.classList.add('show', 'active');
                productionContent.classList.remove('show', 'active');
            }

            // Reset índices
            currentGalleryImages = [];
            currentGalleryIndex = 0;
            isViewingDesignImage = true;
        }

        // ============================================
        // FUNCIÓN: ACTUALIZAR BOTÓN EDITAR VARIANTE
        // ============================================
        function updateEditVariantsButton() {
            const btnEditVariants = document.getElementById('btnEditVariants');

            if (!btnEditVariants || !currentDesign) return;

            if (!currentVariants.length) {
                btnEditVariants.classList.add('disabled');
                btnEditVariants.style.pointerEvents = 'none';
                btnEditVariants.style.opacity = '0.5';
                btnEditVariants.href = '#';
                return;
            }

            const activeVariant = currentVariants[currentVariantIndex];

            if (activeVariant && activeVariant.id && currentVariantIndex !== -1) {
                btnEditVariants.classList.remove('disabled');
                btnEditVariants.style.pointerEvents = 'auto';
                btnEditVariants.style.opacity = '1';
                btnEditVariants.href =
                    `/admin/designs/${currentDesign.id}/variants/${activeVariant.id}/edit`;
            } else {
                btnEditVariants.classList.add('disabled');
                btnEditVariants.style.pointerEvents = 'none';
                btnEditVariants.style.opacity = '0.5';
                btnEditVariants.href = '#';
            }
        }

        // ============================================
        // FUNCIÓN: MOSTRAR IMAGEN PRINCIPAL
        // ============================================
        function displayMainImage({
            src,
            originalSrc = null,
            title,
            subtitle,
            downloadName,
            showBackButton = false
        }) {
            const img = document.getElementById('mainDisplayImage');
            const noImg = document.getElementById('noImageLabel');
            const titleEl = document.getElementById('modalDesignTitle');
            const descEl = document.getElementById('imageDescription');
            const downloadBtn = document.getElementById('downloadImageBtn');
            const backBtn = document.getElementById('btnBackToMainImage');
            const thumbnail = document.getElementById('mainImageThumbnail');

            img.style.display = 'none';
            img.src = '';
            noImg.style.setProperty('display', 'none', 'important');
            downloadBtn.style.display = 'none';

            if (title) titleEl.innerText = title.toUpperCase();
            descEl.innerText = subtitle;

            // Usar thumbnail para el botón de volver
            if (showBackButton && currentDesign?.primaryImage?.file_path) {
                const thumbSrc = currentDesign.primaryImage.thumbnail_small || currentDesign.primaryImage.file_path;
                thumbnail.src = `/storage/${thumbSrc}`;
                backBtn.style.display = 'block';
            } else {
                backBtn.style.display = 'none';
            }

            if (!src) {
                noImg.style.setProperty('display', 'flex', 'important');
                return;
            }

            img.src = src;
            img.style.display = 'block';
            noImg.style.setProperty('display', 'none', 'important');

            // Guardar la URL original para descarga (imagen sin comprimir)
            const downloadUrl = originalSrc || src;

            img.onload = () => {
                noImg.style.setProperty('display', 'none', 'important');
                downloadBtn.style.display = 'flex';
                // IMPORTANTE: Siempre usar la imagen original para descarga
                downloadBtn.href = downloadUrl;
                downloadBtn.setAttribute('download', downloadName);
            };

            img.onerror = () => {
                img.style.display = 'none';
                noImg.style.setProperty('display', 'flex', 'important');
                downloadBtn.style.display = 'none';
            };
        }

        // ============================================
        // FUNCIÓN: VOLVER A IMAGEN PRINCIPAL
        // ============================================
        function backToMainImage() {
            if (!currentDesign) return;

            isViewingDesignImage = true;
            currentGalleryImages = [];
            currentGalleryIndex = 0;
            currentVariantIndex = -1;

            document.getElementById('modalVariantId').value = '';
            updateProductionContext();

            if (currentDesign.primaryImage?.file_path) {
                const ext = currentDesign.primaryImage.file_path.split('.').pop();
                currentDisplayedImageId = currentDesign.primaryImage.id || null; // Guardar ID de imagen principal
                // Usar thumbnail_medium para visualización, file_path para descarga
                const displaySrc = currentDesign.primaryImage.thumbnail_medium ?
                    `/storage/${currentDesign.primaryImage.thumbnail_medium}` :
                    `/storage/${currentDesign.primaryImage.file_path}`;
                const originalSrc = `/storage/${currentDesign.primaryImage.file_path}`;
                displayMainImage({
                    src: displaySrc,
                    originalSrc: originalSrc,
                    title: currentDesign.name,
                    subtitle: 'Imagen principal diseño',
                    downloadName: `${currentDesign.name.replace(/\s+/g, '_')}.${ext}`,
                    showBackButton: false
                });
            } else {
                currentDisplayedImageId = null;
                displayMainImage({
                    src: null,
                    originalSrc: null,
                    title: currentDesign.name,
                    subtitle: 'Imagen principal diseño',
                    downloadName: null,
                    showBackButton: false
                });
            }

            document.querySelectorAll('.variant-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const gallery = document.getElementById('variantGallery');
            if (gallery) {
                gallery.innerHTML =
                    '<div class="gallery-empty-state"><i class="fas fa-images"></i><p>No hay imágenes.</p></div>';
            }
            document.getElementById('galleryCount').innerText = '0';

            updateVariantInfoForDesign();
            updateEditVariantsButton();
            updateMainImageProductionBadge(); // Actualizar badge de imagen principal
            updateProductionTabCount(); // Actualizar contador de producción en pestaña

            // Si la pestaña de producción está activa, recargar los datos del diseño principal
            if ($('#production-tab').hasClass('active') || $('#production-content').hasClass('active show')) {
                // Disparar recarga de datos de producción para el nuevo contexto (diseño principal)
                if (typeof window.loadProductionData === 'function') {
                    window.loadProductionData();
                }
            }
        }

        // ============================================
        // FUNCIÓN: ACTUALIZAR CONTEXTO DE PRODUCCIÓN
        // ============================================
        function updateProductionContext() {
            const contextEl = document.getElementById('productionContext');
            if (!contextEl) return;

            const variantId = document.getElementById('modalVariantId').value;

            if (variantId && variantId !== '') {
                const variantName = document.getElementById('variantName').innerText;
                contextEl.innerHTML = 'Variante: <strong>' + variantName + '</strong>';
            } else if (currentDesign) {
                contextEl.innerHTML = 'Diseño: <strong>' + currentDesign.name.toUpperCase() + '</strong>';
            } else {
                contextEl.innerHTML = 'Cargando...';
            }
        }

        // ============================================
        // FUNCIÓN: AÑADIR PRODUCCIÓN DESDE IMAGEN
        // ============================================
        function addProductionFromImage(source, imageId = null, variantIndex = null) {
            // Determinar el image_id según el contexto
            let targetImageId = imageId;

            if (source === 'main') {
                // Imagen principal: usar el ID de la imagen actualmente mostrada
                targetImageId = currentDisplayedImageId;
            } else if (source === 'gallery' && imageId) {
                // Desde galería: cambiar la imagen principal a la imagen seleccionada
                const imgIndex = currentGalleryImages.findIndex(img => img.id === imageId);
                if (imgIndex !== -1 && currentVariants[currentVariantIndex]) {
                    showVariantImage(currentVariants[currentVariantIndex], currentGalleryImages, imgIndex);
                    // Actualizar el estado activo en la galería
                    updateGalleryActiveState(imgIndex);
                }
                targetImageId = imageId;
            }

            // Preparar para ir directo al formulario (ANTES de cambiar de pestaña)
            if (typeof window.prepareDirectFormOpen === 'function') {
                window.prepareDirectFormOpen(targetImageId);
            }

            // Cambiar a la pestaña de producción
            // El evento shown.bs.tab detectará la bandera y mostrará el formulario directo
            $('#production-tab').tab('show');
        }

        // ============================================
        // FUNCIÓN: CARGAR CONTADOR DE PRODUCCIONES POR IMAGEN (individual)
        // ============================================
        function loadImageProductionCount(imageId, badgeElementId) {
            if (!imageId) return;

            fetch(`/admin/images/${imageId}/exports-count`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const badge = document.getElementById(badgeElementId);
                        if (badge) {
                            badge.textContent = data.count;
                            badge.dataset.count = data.count;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error cargando contador de producciones:', error);
                });
        }

        // ============================================
        // FUNCIÓN: CARGAR CONTADORES BATCH (una sola petición para múltiples imágenes)
        // ============================================
        function loadGalleryProductionCounts(imageIds) {
            if (!imageIds || imageIds.length === 0) return;

            fetch('/admin/images/exports-counts-batch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').content
                    },
                    body: JSON.stringify({
                        image_ids: imageIds
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.counts) {
                        Object.entries(data.counts).forEach(([imageId, count]) => {
                            const badge = document.getElementById(`gallery-badge-${imageId}`);
                            if (badge) {
                                badge.textContent = count > 0 ? count : '';
                                badge.dataset.count = count;
                            }
                        });
                    }
                })
                .catch(error => {
                    console.error('Error cargando contadores batch:', error);
                });
        }

        // ============================================
        // FUNCIÓN: ACTUALIZAR BADGE DE IMAGEN PRINCIPAL
        // ============================================
        function updateMainImageProductionBadge() {
            const badge = document.getElementById('mainImageProductionBadge');
            if (!badge) return;

            // Si estamos viendo la imagen principal del diseño (sin variante seleccionada),
            // mostrar producciones del diseño que no tienen image_id ni variant_id
            if (isViewingDesignImage && currentDesign && currentDesign.id) {
                loadDesignMainProductionCount(currentDesign.id);
            }
            // Si hay una imagen específica de galería seleccionada (variante), cargar su contador
            else if (currentDisplayedImageId && !isViewingDesignImage) {
                loadImageProductionCount(currentDisplayedImageId, 'mainImageProductionBadge');
            } else {
                badge.textContent = '';
                badge.dataset.count = '0';
            }
        }

        // ============================================
        // FUNCIÓN: ACTUALIZAR CONTADOR DE PRODUCCIÓN EN PESTAÑA
        // Enterprise-level: Actualizaciones instantáneas con cache + AbortController
        // ============================================
        function updateProductionTabCount(forceRefresh = false) {
            const designId = currentDesign?.id;
            const variantId = document.getElementById('modalVariantId')?.value;
            const counterEl = document.getElementById('productionTotalCount');

            if (!counterEl) return;

            if (!designId) {
                counterEl.innerText = '0';
                return;
            }

            // Determinar la clave de cache
            const cacheKey = variantId && variantId !== '' ? `variant_${variantId}` : `design_${designId}`;
            const cacheType = variantId && variantId !== '' ? 'variant' : 'design';
            const cacheId = variantId && variantId !== '' ? variantId : designId;

            // ========== PASO 1: ACTUALIZACIÓN INSTANTÁNEA DESDE CACHE ==========
            if (productionCountCache[cacheType][cacheId] !== undefined && !forceRefresh) {
                counterEl.innerText = productionCountCache[cacheType][cacheId];
                return; // Cache hit - no need to fetch
            }

            // ========== PASO 2: CANCELAR REQUEST ANTERIOR SI EXISTE ==========
            if (productionCountCache.abortController) {
                productionCountCache.abortController.abort();
                console.log('[Counter] Previous request aborted - context changed');
            }

            // Crear nuevo AbortController para este request
            productionCountCache.abortController = new AbortController();
            const signal = productionCountCache.abortController.signal;

            // Incrementar versión como medida de seguridad adicional
            productionCountCache.requestVersion++;
            const myVersion = productionCountCache.requestVersion;

            // Resetear contador a 0 INMEDIATAMENTE
            counterEl.innerText = '0';

            const endpoint = variantId && variantId !== '' ?
                `/admin/designs/${designId}/variants/${variantId}/exports/ajax` :
                `/admin/designs/${designId}/exports-count`;

            fetch(endpoint, {
                    signal
                })
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    // Doble verificación: versión + request no fue abortado
                    if (myVersion !== productionCountCache.requestVersion) {
                        return; // Versión obsoleta
                    }

                    if (data.success) {
                        const count = data.count || 0;
                        // Guardar en cache
                        productionCountCache[cacheType][cacheId] = count;
                        // Actualizar UI
                        counterEl.innerText = count;
                    }
                })
                .catch(error => {
                    // Ignorar errores de abort (son intencionales)
                    if (error.name === 'AbortError') {
                        console.log('[Counter] Request aborted intentionally');
                        return;
                    }
                    console.error('Error cargando contador de producción:', error);
                    // En caso de error real, solo resetear si somos la versión actual
                    if (myVersion === productionCountCache.requestVersion) {
                        counterEl.innerText = '0';
                    }
                });
        }

        // ============================================
        // FUNCIÓN: PRELLENAR CACHE DE PRODUCCIÓN AL ABRIR MODAL
        // Se llama cuando se carga un diseño para tener los contadores listos
        // ============================================
        function prefetchProductionCounts(designId, variants) {
            if (!designId) return;

            // Prefetch contador del diseño principal
            const designCacheKey = `design_${designId}`;
            if (!productionCountCache.loading.has(designCacheKey)) {
                productionCountCache.loading.add(designCacheKey);
                fetch(`/admin/designs/${designId}/exports-count`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            productionCountCache.design[designId] = data.count || 0;
                            // Si estamos en diseño principal, actualizar UI
                            const currentVarId = document.getElementById('modalVariantId')?.value;
                            if ((!currentVarId || currentVarId === '') && currentDesign?.id == designId) {
                                document.getElementById('productionTotalCount').innerText = data.count || 0;
                            }
                        }
                    })
                    .finally(() => productionCountCache.loading.delete(designCacheKey));
            }

            // Prefetch contadores de todas las variantes
            if (variants && variants.length > 0) {
                variants.forEach(variant => {
                    const varCacheKey = `variant_${variant.id}`;
                    if (!productionCountCache.loading.has(varCacheKey)) {
                        productionCountCache.loading.add(varCacheKey);
                        fetch(`/admin/designs/${designId}/variants/${variant.id}/exports/ajax`)
                            .then(r => r.json())
                            .then(data => {
                                if (data.success) {
                                    productionCountCache.variant[variant.id] = data.count || 0;
                                }
                            })
                            .finally(() => productionCountCache.loading.delete(varCacheKey));
                    }
                });
            }
        }

        // ============================================
        // FUNCIÓN: LIMPIAR CACHE DE PRODUCCIÓN
        // Se llama cuando se cierra el modal
        // ============================================
        function clearProductionCountCache() {
            // Cancelar cualquier request pendiente
            if (productionCountCache.abortController) {
                productionCountCache.abortController.abort();
                productionCountCache.abortController = null;
            }
            productionCountCache.design = {};
            productionCountCache.variant = {};
            productionCountCache.loading.clear();
            productionCountCache.requestVersion = 0;
        }

        // ============================================
        // FUNCIÓN: CARGAR CONTADOR DE PRODUCCIONES DEL DISEÑO (SIN IMAGE_ID)
        // ============================================
        function loadDesignMainProductionCount(designId) {
            if (!designId) return;

            fetch(`/admin/designs/${designId}/exports-without-image-count`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const badge = document.getElementById('mainImageProductionBadge');
                        if (badge) {
                            badge.textContent = data.count || '';
                            badge.dataset.count = data.count || '0';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error cargando contador de producciones:', error);
                });
        }

        // ============================================
        // FUNCIÓN: INDICADOR DE IMAGEN VINCULADA EN FORMULARIO
        // ============================================
        function updateProductionImageIndicator(imageId) {
            const indicator = document.getElementById('linkedImageIndicator');
            if (!indicator) return;

            if (imageId) {
                indicator.innerHTML = `
                    <div class="alert alert-info py-2 px-3 mb-2" style="font-size: 12px;">
                        <i class="fas fa-link mr-1"></i>
                        Producción vinculada a imagen #${imageId}
                        <button type="button" class="close" onclick="clearLinkedImage()" style="font-size: 14px;">
                            <span>&times;</span>
                        </button>
                    </div>
                `;
                indicator.style.display = 'block';
            } else {
                indicator.innerHTML = '';
                indicator.style.display = 'none';
            }
        }

        // ============================================
        // FUNCIÓN: LIMPIAR IMAGEN VINCULADA
        // ============================================
        function clearLinkedImage() {
            const imageIdField = document.getElementById('exportImageId');
            if (imageIdField) {
                imageIdField.value = '';
            }
            updateProductionImageIndicator(null);
        }

        // ============================================
        // FUNCIÓN: REFRESCAR TODOS LOS BADGES DE GALERÍA
        // ============================================
        function refreshGalleryProductionBadges() {
            const galleryItems = document.querySelectorAll('.gallery-item[data-image-id]');
            galleryItems.forEach(item => {
                const imageId = item.dataset.imageId;
                if (imageId) {
                    loadImageProductionCount(imageId, `gallery-badge-${imageId}`);
                }
            });
            updateMainImageProductionBadge();
        }

        // ============================================
        // ⭐ FUNCIÓN: INCREMENTAR BADGE DE IMAGEN INMEDIATAMENTE (OPTIMISTA)
        // ============================================
        window.incrementImageBadge = function(imageId) {
            if (!imageId) return;

            // Buscar el badge de la imagen en la galería
            const badge = document.getElementById(`gallery-badge-${imageId}`);
            if (badge) {
                const currentCount = parseInt(badge.dataset.count || badge.textContent || '0');
                const newCount = currentCount + 1;
                badge.textContent = newCount;
                badge.dataset.count = newCount;

                // Efecto visual de actualización
                badge.style.transform = 'scale(1.3)';
                badge.style.transition = 'transform 0.2s ease';
                setTimeout(() => {
                    badge.style.transform = 'scale(1)';
                }, 200);
            }
        };

        // ============================================
        // ⭐ FUNCIÓN: INCREMENTAR BADGE DE IMAGEN PRINCIPAL SI COINCIDE
        // ============================================
        window.incrementMainImageBadgeIfMatches = function(imageId) {
            if (!imageId || !currentDisplayedImageId) return;

            // Solo incrementar si la imagen actual es la misma
            if (currentDisplayedImageId == imageId) {
                const badge = document.getElementById('mainImageProductionBadge');
                if (badge) {
                    const currentCount = parseInt(badge.dataset.count || badge.textContent || '0');
                    const newCount = currentCount + 1;
                    badge.textContent = newCount;
                    badge.dataset.count = newCount;

                    // Efecto visual de actualización
                    badge.style.transform = 'scale(1.3)';
                    badge.style.transition = 'transform 0.2s ease';
                    setTimeout(() => {
                        badge.style.transform = 'scale(1)';
                    }, 200);
                }
            }
        };

        // ============================================
        // FUNCIÓN: MOSTRAR IMAGEN DE VARIANTE
        // ============================================
        function showVariantImage(variant, images, index) {
            const img = images[index];
            if (!img || !img.file_path) {
                currentDisplayedImageId = null;
                displayMainImage({
                    src: null,
                    originalSrc: null,
                    title: variant.name,
                    subtitle: 'Imagen de variante',
                    downloadName: null,
                    showBackButton: true
                });
                updateMainImageProductionBadge();
                return;
            }

            const ext = img.file_path.split('.').pop();
            currentGalleryIndex = index;
            isViewingDesignImage = false;
            currentDisplayedImageId = img.id || null; // Guardar ID de imagen actual

            // Usar thumbnail_medium para visualización, file_path para descarga
            const displaySrc = img.thumbnail_medium ? `/storage/${img.thumbnail_medium}` : `/storage/${img.file_path}`;
            const originalSrc = `/storage/${img.file_path}`;

            displayMainImage({
                src: displaySrc,
                originalSrc: originalSrc,
                title: variant.name,
                subtitle: `Foto ${index + 1} de variante`,
                downloadName: `${variant.name.replace(/\s+/g, '_')}_${index + 1}.${ext}`,
                showBackButton: true
            });

            updateGalleryActiveState(index);
            scrollGalleryItemIntoView(index);
            updateMainImageProductionBadge(); // Actualizar badge
        }

        // ============================================
        // FUNCIÓN: SCROLL A ITEM DE GALERÍA
        // ============================================
        function scrollGalleryItemIntoView(index) {
            const gallery = document.getElementById('variantGallery');
            if (!gallery) return;

            const items = gallery.querySelectorAll('.gallery-item');
            if (items.length <= index) return;

            const item = items[index];
            if (item) {
                item.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            }
        }

        // ============================================
        // FUNCIÓN: ACTUALIZAR ESTADO ACTIVO EN GALERÍA
        // ============================================
        function updateGalleryActiveState(activeIndex) {
            const galleryItems = document.querySelectorAll('.gallery-item');
            galleryItems.forEach((item, idx) => {
                if (idx === activeIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        // ============================================
        // FUNCIÓN: RENDERIZAR MODAL COMPLETO
        // ============================================
        function renderModal(design) {
            currentDesign = design;
            currentVariants = design.variants || [];
            currentVariantIndex = -1;
            currentGalleryImages = [];
            currentGalleryIndex = 0;
            isViewingDesignImage = true;

            // ENTERPRISE: Prellenar cache de contadores de producción para actualizaciones instantáneas
            prefetchProductionCounts(design.id, currentVariants);

            // Datos del diseño
            document.getElementById('modalDesignTitle').innerText = design.name;
            document.getElementById('modalDesignDesc').innerText = design.description || 'Sin descripción';

            // Campos ocultos para producción
            document.getElementById('modalDesignId').value = design.id;
            document.getElementById('modalVariantId').value = '';

            updateProductionContext();

            // Botones de acción
            document.getElementById('btnEditDesign').href = `/admin/designs/${design.id}/edit`;
            const deleteBtn = document.getElementById('btnDeleteDesign');
            deleteBtn.onclick = () => confirmDeleteDesign(`/admin/designs/${design.id}`);
            document.getElementById('btnAddVariant').href = `/admin/designs/${design.id}/variants/create`;

            // Imagen principal - Usar thumbnail_medium para visualización, file_path para descarga
            if (design.primaryImage?.file_path) {
                const ext = design.primaryImage.file_path.split('.').pop();
                currentDisplayedImageId = design.primaryImage.id || null; // Guardar ID de imagen principal
                const displaySrc = design.primaryImage.thumbnail_medium ?
                    `/storage/${design.primaryImage.thumbnail_medium}` :
                    `/storage/${design.primaryImage.file_path}`;
                const originalSrc = `/storage/${design.primaryImage.file_path}`;
                displayMainImage({
                    src: displaySrc,
                    originalSrc: originalSrc,
                    title: design.name,
                    subtitle: 'Imagen principal diseño',
                    downloadName: `${design.name.replace(/\s+/g, '_')}.${ext}`
                });
                updateMainImageProductionBadge(); // Cargar contador de producciones
            } else {
                currentDisplayedImageId = null;
                displayMainImage({
                    src: null,
                    originalSrc: null,
                    title: design.name,
                    subtitle: 'Imagen principal diseño',
                    downloadName: null
                });
            }

            // Contadores
            const variantsCount = currentVariants.length;
            document.getElementById('variantsTotalCount').innerText = variantsCount;
            document.getElementById('variantsContentCount').innerText = variantsCount;

            const exportsCount = design.exports_count || 0;
            document.getElementById('productionTotalCount').innerText = exportsCount;
            // Guardar en cache para uso instantáneo
            productionCountCache.design[design.id] = exportsCount;

            // Renderizar tabs de variantes
            const tabsContainer = document.getElementById('variantTabs');

            if (currentVariants.length > 0) {
                currentVariants.forEach((variant, index) => {
                    let thumbSrc = '';
                    let hasImage = false;

                    // Usar thumbnail_small para pestañas de variantes (más rápida carga)
                    if (variant.images && variant.images.length > 0 && variant.images[0].file_path) {
                        const img = variant.images[0];
                        thumbSrc = img.thumbnail_small ?
                            `/storage/${img.thumbnail_small}` :
                            `/storage/${img.file_path}`;
                        hasImage = true;
                    } else if (design.primaryImage && design.primaryImage.file_path) {
                        thumbSrc = design.primaryImage.thumbnail_small ?
                            `/storage/${design.primaryImage.thumbnail_small}` :
                            `/storage/${design.primaryImage.file_path}`;
                        hasImage = true;
                    }

                    const tab = document.createElement('div');
                    tab.className = 'variant-tab';

                    if (hasImage) {
                        tab.innerHTML = `
                            <img src="${thumbSrc}" loading="lazy"
                                 onerror="this.onerror=null;this.parentElement.innerHTML='<div class=\\'no-img-placeholder\\'><i class=\\'fas fa-image text-muted\\'></i></div>'">
                            <span>${variant.name.toUpperCase()}</span>
                        `;
                    } else {
                        tab.innerHTML = `
                            <div class="no-img-placeholder">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                            <span>${variant.name.toUpperCase()}</span>
                        `;
                    }

                    tab.onclick = () => selectVariant(index);
                    tabsContainer.appendChild(tab);
                });

                document.getElementById('variantGallery').innerHTML =
                    '<div class="gallery-empty-state"><i class="fas fa-images"></i><p>No hay imágenes.</p></div>';

                updateVariantInfoForDesign();
            } else {
                tabsContainer.innerHTML =
                    '<div class="empty-state-minimal d-flex flex-column align-items-center justify-content-center text-center w-100" style="min-height: 100px; padding: 10px; color: #94a3b8;">' +
                    '<i class="fas fa-layer-group mb-2" style="font-size: 18px; opacity: 0.5;"></i>' +
                    '<p class="m-0" style="font-size: 13px; font-weight: 400;">Sin variantes. Añade una.</p>' +
                    '</div>';
                document.getElementById('variantGallery').innerHTML =
                    '<div class="gallery-empty-state"><i class="fas fa-images"></i><p>No hay imágenes.</p></div>';
                document.getElementById('galleryCount').innerText = '0';
                document.getElementById('variantName').innerText = 'Sin variantes';
                document.getElementById('variantPrice').innerText = '$0.00';
                document.getElementById('variantSku').innerText = 'SKU: ---';
                currentGalleryImages = [];
            }

            updateEditVariantsButton();
        }

        // ============================================
        // FUNCIÓN: ACTUALIZAR INFO VARIANTE PARA DISEÑO
        // ============================================
        function updateVariantInfoForDesign() {
            document.getElementById('variantName').innerText = 'Diseño Principal';
            document.getElementById('variantPrice').innerText = '$0.00';
            document.getElementById('variantSku').innerText = 'SKU: ---';
            document.getElementById('galleryCount').innerText = '0';
        }

        // ============================================
        // FUNCIÓN: SELECCIONAR VARIANTE
        // ============================================
        function selectVariant(index) {
            if (isProcessingDelete) return;

            const variant = currentVariants[index];
            if (!variant) return;

            currentVariantIndex = index;
            isViewingDesignImage = false;

            // Actualizar UI de Tabs
            const tabs = document.querySelectorAll('.variant-tab');
            tabs.forEach((t, i) => {
                t.classList.toggle('active', i === index);
            });

            if (tabs[index]) {
                tabs[index].scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            }

            // Actualizar info de variante
            document.getElementById('variantName').innerText = variant.name.toUpperCase();
            document.getElementById('variantPrice').innerText = variant.price ? `$${parseFloat(variant.price).toFixed(2)}` :
                '$0.00';
            document.getElementById('variantSku').innerText = `SKU: ${variant.sku || '---'}`;

            // Actualizar campo oculto para producción
            document.getElementById('modalVariantId').value = variant.id;
            updateProductionContext();

            // Actualizar galería
            const images = variant.images || [];
            currentGalleryImages = images;
            currentGalleryIndex = 0;
            document.getElementById('galleryCount').innerText = images.length;

            const gallery = document.getElementById('variantGallery');
            gallery.innerHTML = '';

            if (images.length > 0) {
                images.forEach((img, imgIndex) => {
                    if (img && img.file_path) {
                        const item = document.createElement('div');
                        item.className = 'gallery-item';
                        item.dataset.imageId = img.id || '';

                        // Badge contador de producciones
                        const badge = document.createElement('span');
                        badge.className = 'production-count-badge';
                        badge.dataset.count = '0';
                        badge.id = `gallery-badge-${img.id || imgIndex}`;
                        item.appendChild(badge);

                        // Overlay para añadir producción
                        const overlay = document.createElement('div');
                        overlay.className = 'image-production-overlay';
                        overlay.innerHTML = `
                            <button type="button" class="btn-add-production-overlay" onclick="event.stopPropagation(); addProductionFromImage('gallery', ${img.id || 0}, ${currentVariantIndex})">
                                <i class="fas fa-plus"></i>
                                <span>Producción</span>
                            </button>
                        `;
                        item.appendChild(overlay);

                        // Usar thumbnail_small para galería (carga más rápida)
                        const imgElement = document.createElement('img');
                        const imgSrc = img.thumbnail_small ?
                            `/storage/${img.thumbnail_small}` :
                            `/storage/${img.file_path}`;
                        imgElement.src = imgSrc;
                        imgElement.alt = `Imagen ${imgIndex + 1}`;
                        // Forzar carga inmediata
                        imgElement.decoding = 'async';
                        imgElement.onerror = function() {
                            console.warn('Error cargando imagen:', imgSrc);
                            this.onerror = null;
                            // Fallback al archivo original si el thumbnail falla
                            if (img.file_path && this.src.includes('_thumb_')) {
                                this.src = `/storage/${img.file_path}`;
                            } else {
                                this.src =
                                    'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23f1f5f9"/><text x="50%" y="50%" font-family="Arial" font-size="10" fill="%2394a3b8" text-anchor="middle" dy=".3em">Sin Imagen</text></svg>';
                            }
                        };

                        item.appendChild(imgElement);
                        item.onclick = () => {
                            showVariantImage(variant, images, imgIndex);
                        };
                        gallery.appendChild(item);
                    }
                });

                // Cargar contadores de producción en UNA sola petición batch
                const imageIds = images.filter(img => img && img.id).map(img => img.id);
                if (imageIds.length > 0) {
                    loadGalleryProductionCounts(imageIds);
                }

                showVariantImage(variant, images, 0);
            } else {
                gallery.innerHTML =
                    '<div class="gallery-empty-state"><i class="fas fa-images"></i><p>No hay imágenes.</p></div>';
                if (currentDesign.primaryImage?.file_path) {
                    const ext = currentDesign.primaryImage.file_path.split('.').pop();
                    // Usar thumbnail_medium para visualización, file_path para descarga
                    const displaySrc = currentDesign.primaryImage.thumbnail_medium ?
                        `/storage/${currentDesign.primaryImage.thumbnail_medium}` :
                        `/storage/${currentDesign.primaryImage.file_path}`;
                    const originalSrc = `/storage/${currentDesign.primaryImage.file_path}`;
                    displayMainImage({
                        src: displaySrc,
                        originalSrc: originalSrc,
                        title: variant.name,
                        subtitle: 'Imagen de variante',
                        downloadName: `${currentDesign.name.replace(/\s+/g, '_')}.${ext}`
                    });
                } else {
                    displayMainImage({
                        src: null,
                        originalSrc: null,
                        title: variant.name,
                        subtitle: 'Imagen de variante',
                        downloadName: null
                    });
                }
                currentGalleryImages = [];
            }

            updateEditVariantsButton();
            updateProductionTabCount(); // Actualizar contador de producción en pestaña
        }

        // ============================================
        // FUNCIÓN: NAVEGAR ENTRE VARIANTES
        // ============================================
        function navigateVariant(direction) {
            if (isProcessingDelete || currentVariants.length === 0) return;

            let newIndex;

            if (currentVariantIndex === -1) {
                newIndex = 0;
            } else {
                newIndex = currentVariantIndex + direction;

                if (newIndex < 0) {
                    newIndex = currentVariants.length - 1;
                } else if (newIndex >= currentVariants.length) {
                    newIndex = 0;
                }
            }

            selectVariant(newIndex);
        }

        // ============================================
        // FUNCIÓN: NAVEGAR ENTRE IMÁGENES
        // ============================================
        function navigateGalleryImage(direction) {
            if (isProcessingDelete) return;
            if (isViewingDesignImage) return;
            if (currentGalleryImages.length <= 1) return;

            let newIndex = currentGalleryIndex + direction;

            if (newIndex < 0) {
                newIndex = currentGalleryImages.length - 1;
            } else if (newIndex >= currentGalleryImages.length) {
                newIndex = 0;
            }

            currentGalleryIndex = newIndex;
            const variant = currentVariants[currentVariantIndex];
            showVariantImage(variant, currentGalleryImages, currentGalleryIndex);
        }

        // ============================================
        // FUNCIONES DE CARGA
        // ============================================
        function showLoadingState() {
            isProcessingDelete = true;
            const loadingOverlay = document.getElementById('loadingOverlay');
            const confirmBtn = document.getElementById('confirmDeleteBtn');

            if (loadingOverlay) {
                loadingOverlay.style.display = 'flex';
            }

            if (confirmBtn) {
                confirmBtn.classList.add('loading');
                confirmBtn.disabled = true;
            }
        }

        function hideLoadingState() {
            isProcessingDelete = false;
            const loadingOverlay = document.getElementById('loadingOverlay');
            const confirmBtn = document.getElementById('confirmDeleteBtn');

            if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
            }

            if (confirmBtn) {
                confirmBtn.classList.remove('loading');
                confirmBtn.disabled = false;
            }
        }

        // ============================================
        // FUNCIONES DE ELIMINACIÓN
        // ============================================
        function confirmDeleteDesign(url) {
            if (isProcessingDelete) return;

            pendingDeleteUrl = url;

            const variantsCount = currentVariants ? currentVariants.length : 0;
            const warningDiv = document.getElementById('variantsWarning');
            const countSpan = document.getElementById('variantsCount');

            if (variantsCount > 0) {
                countSpan.textContent = variantsCount;
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }

            $('#deleteConfirmModal').modal('show');
        }

        function executeDelete() {
            if (!pendingDeleteUrl || isProcessingDelete) return;

            $('#deleteConfirmModal').modal('hide');
            showLoadingState();

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = pendingDeleteUrl;
            form.style.display = 'none';

            const csrfToken = document.querySelector('meta[name="csrf-token"]');
            if (csrfToken) {
                const csrfInput = document.createElement('input');
                csrfInput.type = 'hidden';
                csrfInput.name = '_token';
                csrfInput.value = csrfToken.getAttribute('content');
                form.appendChild(csrfInput);
            }

            const methodInput = document.createElement('input');
            methodInput.type = 'hidden';
            methodInput.name = '_method';
            methodInput.value = 'DELETE';
            form.appendChild(methodInput);

            document.body.appendChild(form);

            setTimeout(() => {
                form.submit();
            }, 500);
        }

        function showErrorAlert(title, message) {
            Swal.fire({
                icon: 'error',
                title: title,
                text: message,
                showConfirmButton: true,
                confirmButtonColor: '#2563eb',
                confirmButtonText: 'Entendido'
            });
        }

        // ============================================
        // ⭐ INCREMENTAR CONTADOR TAB PRODUCCIÓN INMEDIATAMENTE
        // ============================================
        window.incrementProductionTabCounter = function() {
            const productionCount = document.getElementById('productionTotalCount');
            if (productionCount) {
                const current = parseInt(productionCount.innerText || '0');
                productionCount.innerText = current + 1;

                // Efecto visual
                productionCount.style.transform = 'scale(1.3)';
                productionCount.style.transition = 'transform 0.2s ease';
                setTimeout(() => {
                    productionCount.style.transform = 'scale(1)';
                }, 200);
            }

            // También incrementar en la tarjeta del grid
            if (currentDesign && currentDesign.id) {
                const card = document.querySelector(`.design-card[data-design-id="${currentDesign.id}"]`);
                if (card) {
                    const currentExports = parseInt(card.dataset.exports || '0');
                    const newCount = currentExports + 1;
                    card.dataset.exports = newCount;

                    const exportsDiv = card.querySelector('.design-exports');
                    if (exportsDiv) {
                        const numberSpan = exportsDiv.querySelector('.exports-number');
                        const textSpan = exportsDiv.querySelector('.exports-text');
                        if (numberSpan) numberSpan.textContent = newCount;
                        if (textSpan) textSpan.textContent = newCount !== 1 ? 'exportaciones' : 'exportación';

                        // Animación
                        exportsDiv.classList.add('updated');
                        setTimeout(() => exportsDiv.classList.remove('updated'), 400);
                    }
                }

                // Actualizar currentDesign
                currentDesign.exports_count = (currentDesign.exports_count || 0) + 1;
            }
        };

        // ============================================
        // ACTUALIZACIÓN EN TIEMPO REAL DE EXPORTACIONES
        // ============================================
        function updateExportsCounter(designId) {
            fetch(`/admin/designs/${designId}/exports-count`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const count = data.count || 0;

                        // Actualizar tarjeta en el grid
                        const card = document.querySelector(`.design-card[data-design-id="${designId}"]`);
                        if (card) {
                            card.dataset.exports = count;

                            const exportsDiv = card.querySelector('.design-exports');
                            if (exportsDiv) {
                                exportsDiv.querySelector('.exports-number').textContent = count;
                                exportsDiv.querySelector('.exports-text').textContent =
                                    count !== 1 ? 'exportaciones' : 'exportación';

                                // Animación
                                exportsDiv.classList.add('updated');
                                setTimeout(() => exportsDiv.classList.remove('updated'), 400);
                            }
                        }

                        // Actualizar contador en el tab de producción
                        const productionCount = document.getElementById('productionTotalCount');
                        if (productionCount) {
                            productionCount.innerText = count;
                        }

                        // Actualizar currentDesign
                        if (currentDesign && currentDesign.id == designId) {
                            currentDesign.exports_count = count;
                        }
                    }
                })
                .catch(error => {
                    console.error('Error actualizando contador:', error);
                });
        }

        // Escuchar eventos de exportación
        $(document).on('exportCreated exportDeleted exportUpdated', function(event, data) {
            if (data && data.designId) {
                updateExportsCounter(data.designId);
            }
        });

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', function() {
                    executeDelete();
                });
            }

            document.addEventListener('keydown', function(e) {
                if ($('#designModal').hasClass('show') && !isProcessingDelete) {
                    if (e.key === 'ArrowLeft') {
                        navigateGalleryImage(-1);
                    } else if (e.key === 'ArrowRight') {
                        navigateGalleryImage(1);
                    }
                }
            });

            $('#designModal').on('hide.bs.modal', function(e) {
                if (isProcessingDelete) {
                    e.preventDefault();
                    return false;
                }
            });

            $('#deleteConfirmModal').on('hidden.bs.modal', function() {
                if (!isProcessingDelete) {
                    pendingDeleteUrl = null;
                    const confirmBtn = document.getElementById('confirmDeleteBtn');
                    if (confirmBtn) {
                        confirmBtn.classList.remove('loading');
                        confirmBtn.disabled = false;
                    }
                }
            });

            $('#designModal').on('hidden.bs.modal', function() {
                hideLoadingState();
                pendingDeleteUrl = null;
            });

            // ============================================
            // CORRECCIÓN DE ACCESIBILIDAD PARA MODALES
            // ============================================
            // Prevenir el warning de accesibilidad en modales
            // Se maneja dinámicamente el atributo aria-hidden en el wrapper
            $('#designModal').on('show.bs.modal', function() {
                // Remover aria-hidden del wrapper cuando el modal se abre
                $('.wrapper').removeAttr('aria-hidden');
            });

            $('#designModal').on('hidden.bs.modal', function() {
                // Restaurar aria-hidden cuando el modal se cierra
                $('.wrapper').attr('aria-hidden', 'true');
            });

            // También aplicar al modal de confirmación de eliminación
            $('#deleteConfirmModal').on('show.bs.modal', function() {
                $('.wrapper').removeAttr('aria-hidden');
            });

            $('#deleteConfirmModal').on('hidden.bs.modal', function() {
                $('.wrapper').attr('aria-hidden', 'true');
            });
        });
    </script>

    {{-- Bloque para ÉXITO --}}
    @if (session('success'))
        <script>
            Swal.fire({
                icon: 'success',
                title: '¡Éxito!',
                text: "{{ session('success') }}",
                timer: 4000,
                showConfirmButton: false
            });
        </script>
    @endif

    {{-- Bloque para ERROR --}}
    @if (session('error'))
        <script>
            Swal.fire({
                icon: 'error',
                title: '¡Error!',
                text: "{{ session('error') }}",
                showConfirmButton: true,
                confirmButtonColor: '#2563eb'
            });
        </script>
    @endif

    {{-- ============================================
         BÚSQUEDA EN TIEMPO REAL (AJAX)
         ============================================ --}}
    <script>
        (function() {
            // ============================================
            // CONFIGURACIÓN - Web App optimizada
            // ============================================
            const DEBOUNCE_DELAY = 200; // ms - respuesta rápida
            const MIN_CHARS = 1; // Buscar desde 1 carácter
            const SEARCH_URL = '{{ route('admin.search.ajax') }}';
            const ALL_DESIGNS_URL = '{{ route('admin.designs.ajax-list') }}';
            const STORAGE_URL = '{{ asset('storage') }}';
            const DESIGNS_SHOW_URL = '/admin/designs/';
            const INDEX_URL = '{{ route('admin.designs.index') }}';

            // Elementos DOM
            const searchInput = document.getElementById('searchInput');
            const searchIcon = document.getElementById('searchIcon');
            const searchSpinner = document.getElementById('searchSpinner');
            const searchClear = document.getElementById('searchClear');
            const searchForm = document.getElementById('searchForm');
            const designsContainer = document.getElementById('designsContainer');

            let searchTimeout;
            let currentRequest = null;

            // Prevenir submit del formulario cuando hay búsqueda activa
            searchForm.addEventListener('submit', function(e) {
                const term = searchInput.value.trim();
                if (term.length >= MIN_CHARS) {
                    e.preventDefault();
                    performSearch(term);
                }
            });

            // Búsqueda en tiempo real con debounce
            searchInput.addEventListener('input', function() {
                const term = this.value.trim();

                // Mostrar/ocultar botón limpiar
                searchClear.style.display = term.length > 0 ? 'flex' : 'none';

                // Cancelar búsqueda anterior
                clearTimeout(searchTimeout);
                if (currentRequest) {
                    currentRequest.abort();
                    currentRequest = null;
                }

                // Si está vacío, cargar todos los diseños vía AJAX (sin reload)
                if (term.length === 0) {
                    loadAllDesigns();
                    return;
                }

                // Debounce - búsqueda rápida
                searchTimeout = setTimeout(() => {
                    performSearch(term);
                }, DEBOUNCE_DELAY);
            });

            // Limpiar búsqueda con botón X - AJAX sin reload
            searchClear.addEventListener('click', function(e) {
                e.preventDefault();
                searchInput.value = '';
                searchClear.style.display = 'none';
                loadAllDesigns();
            });

            // Cargar todos los diseños vía AJAX (Web App - sin reload)
            function loadAllDesigns() {
                showLoading();

                const controller = new AbortController();
                currentRequest = controller;

                // Obtener categoría activa si hay una
                const urlParams = new URLSearchParams(window.location.search);
                const category = urlParams.get('category') || '';
                const url = category ? `${ALL_DESIGNS_URL}?category=${encodeURIComponent(category)}` : ALL_DESIGNS_URL;

                fetch(url, {
                        signal: controller.signal
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderResults(data.data, '');
                            updateURL(''); // Limpiar parámetro search de la URL
                        }
                    })
                    .catch(error => {
                        if (error.name !== 'AbortError') {
                            console.error('Error al cargar diseños:', error);
                        }
                    })
                    .finally(() => {
                        hideLoading();
                        currentRequest = null;
                    });
            }

            // Mostrar spinner
            function showLoading() {
                searchIcon.style.display = 'none';
                searchSpinner.style.display = 'inline-block';
            }

            // Ocultar spinner
            function hideLoading() {
                searchIcon.style.display = 'inline-block';
                searchSpinner.style.display = 'none';
            }

            // Realizar búsqueda AJAX
            function performSearch(term) {
                showLoading();

                const controller = new AbortController();
                currentRequest = controller;

                fetch(`${SEARCH_URL}?q=${encodeURIComponent(term)}&limit=50`, {
                        signal: controller.signal
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderResults(data.data, term);
                            updateURL(term);
                        }
                    })
                    .catch(error => {
                        if (error.name !== 'AbortError') {
                            console.error('Error en búsqueda:', error);
                        }
                    })
                    .finally(() => {
                        hideLoading();
                        currentRequest = null;
                    });
            }

            // Renderizar resultados en el grid
            function renderResults(designs, searchTerm) {
                if (designs.length === 0) {
                    designsContainer.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            ${searchTerm
                                ? `No se encontraron diseños para "<strong>${escapeHtml(searchTerm)}</strong>".`
                                : 'No se encontraron diseños con los filtros aplicados.'
                            }
                            <a href="{{ route('admin.designs.create') }}" class="alert-link">¿Deseas crear uno?</a>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="design-grid" id="designGrid">';

                designs.forEach(design => {
                    const imageUrl = design.image || '';
                    const variantsCount = design.variants_count || 0;
                    // Obtener exports_count del diseño (si viene en la respuesta)
                    const exportsCount = design.exports_count || 0;

                    html += `
                        <div class="design-card" data-design-id="${design.id}"
                            data-description="${escapeHtml(design.description || 'Sin descripción')}"
                            data-name="${escapeHtml(design.name)}"
                            data-variants="${variantsCount}"
                            data-exports="${exportsCount}"
                            data-image="${imageUrl}"
                            data-edit-url="/admin/designs/${design.id}/edit"
                            data-delete-url="/admin/designs/${design.id}">

                            <div class="design-image">
                                ${imageUrl
                                    ? `<img src="${imageUrl}" alt="${escapeHtml(design.name)}" loading="lazy"
                                                                                                                                                                        onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                                                                                                                                                       <div class="no-image" style="display: none;">
                                                                                                                                                                           <i class="fas fa-image fa-3x mb-2 text-gray-300"></i>
                                                                                                                                                                           <span>Sin imagen</span>
                                                                                                                                                                       </div>`
                                    : `<div class="no-image">
                                                                                                                                                                           <i class="fas fa-image fa-3x mb-2 text-gray-300"></i>
                                                                                                                                                                           <span>Sin imagen</span>
                                                                                                                                                                       </div>`
                                }
                            </div>

                            <div class="design-body text-center">
                                <h6 class="design-title">${escapeHtml(capitalizeFirst(design.name))}</h6>
                                <div class="design-variants">
                                    ${variantsCount} variante${variantsCount !== 1 ? 's' : ''}
                                </div>
                                <div class="design-exports" data-design-id="${design.id}">
                                    <i class="fas fa-industry"></i>
                                    <span class="exports-number">${exportsCount}</span>
                                    <span class="exports-text">exportación${exportsCount !== 1 ? 'es' : ''}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                designsContainer.innerHTML = html;

                // Re-bind event listeners para las nuevas cards
                bindCardEvents();
            }

            // Re-vincular eventos a las cards después de renderizar
            function bindCardEvents() {
                document.querySelectorAll('.design-card').forEach(card => {
                    card.addEventListener('click', function() {
                        if (typeof isProcessingDelete !== 'undefined' && isProcessingDelete) return;

                        const designId = this.dataset.designId;
                        const showUrl = `${DESIGNS_SHOW_URL}${designId}`;

                        // Mostrar modal y loader
                        $('#designModal').modal('show');
                        const loader = document.getElementById('modalLoader');
                        if (loader) {
                            loader.style.setProperty('display', 'flex', 'important');
                            loader.style.opacity = '1';
                        }

                        // Limpiar vista anterior
                        if (typeof clearModal === 'function') {
                            clearModal();
                        }

                        // Fetch diseño completo
                        fetch(showUrl)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && typeof renderModal === 'function') {
                                    renderModal(data.design);
                                } else if (typeof showErrorAlert === 'function') {
                                    showErrorAlert('Error', 'No se pudo cargar el diseño');
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                if (typeof showErrorAlert === 'function') {
                                    showErrorAlert('Error de conexión',
                                        'Por favor verifica tu conexión');
                                }
                            })
                            .finally(() => {
                                const loaderEl = document.getElementById('modalLoader');
                                if (loaderEl) loaderEl.style.setProperty('display', 'none',
                                    'important');
                            });
                    });
                });
            }

            // Actualizar URL sin recargar (para compartir/bookmarks)
            function updateURL(term) {
                const url = new URL(window.location);
                if (term) {
                    url.searchParams.set('search', term);
                } else {
                    url.searchParams.delete('search');
                }
                window.history.replaceState({}, '', url);
            }

            // Helpers
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function capitalizeFirst(str) {
                if (!str) return '';
                return str.charAt(0).toUpperCase() + str.slice(1);
            }

        })();
    </script>
@stop
</file>

<file path="resources/views/admin/designs/partials/production-tab.blade.php">
{{-- ============================================= --}}
{{-- PRODUCTION TAB - V5 COMPLETO --}}
{{-- Filtros, agrupamiento por variante, acordeones --}}
{{-- ============================================= --}}

{{-- Fix z-index for SweetAlert2 to appear above Bootstrap modals --}}
<style>
    .swal2-container-high-zindex {
        z-index: 99999 !important;
    }
</style>

{{-- Header Compacto --}}
<div class="production-header-compact">
    <h5 class="production-title-compact">
        <i class="fas fa-industry"></i>
        Archivos de Producción
    </h5>
    <span class="production-context-compact" id="productionContext"></span>
</div>

{{-- Content --}}
<div class="production-content">
    {{-- Loading --}}
    <div id="productionLoading" class="production-state">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando archivos...</p>
    </div>

    {{-- Empty State - Ya no se usa, se muestra directamente el formulario --}}
    <div id="productionEmpty" class="production-state" style="display: none;">
        {{-- Este div se mantiene por compatibilidad pero el JS mostrará el formulario directamente --}}
    </div>

    {{-- Lista de Exportaciones con Filtros --}}
    <div id="productionList" class="production-list-container" style="display: none;">

        {{-- Botón Agregar Producción (ancho completo, arriba de todo) --}}
        <div class="add-production-section">
            <button type="button" class="btn-add-production-full" id="btnAddNewExport">
                <i class="fas fa-plus"></i>
                <span>Agregar archivo de producción</span>
            </button>
        </div>

        {{-- Resumen de Estados (clicables para filtrar) --}}
        <div class="summary-section" id="summarySection">
            <div class="summary-badges">
                <button type="button" class="summary-badge active" data-filter="">
                    <span class="summary-icon">📊</span>
                    <span class="summary-count" id="summaryTotal">0</span>
                    <span class="summary-label">Total</span>
                </button>
                <button type="button" class="summary-badge" data-filter="borrador">
                    <span class="summary-icon">🟤</span>
                    <span class="summary-count" id="summaryBorrador">0</span>
                    <span class="summary-label">Borrador</span>
                </button>
                <button type="button" class="summary-badge" data-filter="pendiente">
                    <span class="summary-icon">🟡</span>
                    <span class="summary-count" id="summaryPendiente">0</span>
                    <span class="summary-label">Pendiente</span>
                </button>
                <button type="button" class="summary-badge" data-filter="aprobado">
                    <span class="summary-icon">🟢</span>
                    <span class="summary-count" id="summaryAprobado">0</span>
                    <span class="summary-label">Aprobado</span>
                </button>
                <button type="button" class="summary-badge" data-filter="archivado">
                    <span class="summary-icon">⚫</span>
                    <span class="summary-count" id="summaryArchivado">0</span>
                    <span class="summary-label">Archivado</span>
                </button>
            </div>
        </div>

        {{-- Filtro de Variante (Solo en contexto diseño, debajo de estados) --}}
        <div class="variant-filter-section" id="variantFilterSection" style="display: none;">
            <div class="variant-filter-row">
                <select id="filterVariant" class="filter-select-inline">
                    <option value="">Todas las variantes</option>
                </select>
                <button type="button" id="btnClearFilters" class="btn-clear-inline" title="Limpiar filtro">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        {{-- Contenedor de grupos/lista --}}
        <div class="exports-groups-container" id="exportsGroupsContainer"></div>
    </div>

    {{-- Formulario --}}
    <div id="productionForm" class="production-form-container" style="display: none;">
        <div class="form-header-bar">
            <button type="button" id="btnBackToList" class="btn-back">
                <i class="fas fa-arrow-left"></i>
            </button>
            <span class="form-title" id="formTitle">Nueva Exportación</span>
        </div>

        <div class="form-scroll-area">
            <form id="exportForm" enctype="multipart/form-data">
                <input type="hidden" name="_token" value="{{ csrf_token() }}">
                <input type="hidden" name="_method" id="formMethod" value="POST">
                <input type="hidden" name="design_id" id="exportDesignId">
                <input type="hidden" name="design_variant_id" id="exportVariantId">
                <input type="hidden" name="image_id" id="exportImageId">
                <input type="hidden" name="export_id" id="exportEditId">
                <input type="hidden" name="colors_detected" id="hiddenColorsDetected" value="[]">
                <input type="hidden" name="auto_read_success" id="hiddenAutoRead" value="1">

                {{-- Indicador de imagen vinculada --}}
                <div id="linkedImageIndicator" style="display: none;"></div>

                {{-- Upload Zone --}}
                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="exportFile" name="file" class="upload-input"
                        accept=".pes,.dst,.exp,.jef,.vp3,.vip,.xxx,.hus,.pec,.pcs,.sew,.shv,.tap,.u01">

                    <div class="upload-content" id="uploadContent">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <p class="upload-text">Arrastra tu archivo aquí</p>
                        <p class="upload-subtext">o haz clic para seleccionar</p>
                        <div class="upload-formats">
                            PES, DST, EXP, JEF, VP3, VIP, XXX
                        </div>
                    </div>

                    <div class="upload-analyzing" id="uploadAnalyzing" style="display: none;">
                        <div class="spinner-border text-primary spinner-border-sm"></div>
                        <span class="ml-2">Analizando archivo...</span>
                    </div>

                    <div class="upload-success" id="uploadSuccess" style="display: none;">
                        <div class="upload-success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <span class="upload-filename" id="uploadFileName"></span>
                        <button type="button" class="btn-remove-file" id="btnRemoveFile">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="upload-error" id="uploadError" style="display: none;">
                        <div class="upload-error-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <span class="upload-filename" id="uploadErrorFileName"></span>
                        <button type="button" class="btn-remove-file" id="btnRemoveFileError">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                {{-- Vista Previa SVG - Thumbnail Compacto --}}
                <div class="svg-preview-section text-center" id="svgPreviewSection" style="display: none;">
                    <div class="svg-thumbnail-row">
                        <div class="svg-thumbnail-card" id="svgThumbnailCard" title="Clic para ampliar">
                            <div class="svg-thumbnail-inner" id="svgThumbnailContainer">
                                {{-- SVG thumbnail se inyecta aquí --}}
                            </div>
                            <div class="svg-thumbnail-hover">
                                <i class="fas fa-search-plus"></i>
                            </div>
                        </div>
                        <div class="svg-thumbnail-info">
                            <span class="svg-thumbnail-label">Vista Previa</span>
                            <span class="svg-thumbnail-hint">Clic para ampliar</span>
                        </div>
                    </div>
                </div>

                {{-- Alerta de entrada manual --}}
                <div class="alert-manual-entry" id="manualEntryAlert" style="display: none;">
                    <i class="fas fa-keyboard"></i>
                    <span>Error de lectura automática. Ingresa los datos manualmente.</span>
                </div>

                {{-- Datos Técnicos --}}
                <div class="technical-data-section" id="technicalData" style="display: none;">
                    <h6 class="section-label-large">DATOS TÉCNICOS</h6>
                    <div class="tech-cards">
                        <div class="tech-card" id="techCardStitches">
                            <i class="fas fa-hashtag"></i>
                            <span class="tech-card-label">Puntadas</span>
                            <input type="number" class="tech-card-input" id="inputStitches" name="stitches_count"
                                placeholder="0">
                        </div>
                        <div class="tech-card" id="techCardColors">
                            <i class="fas fa-palette"></i>
                            <span class="tech-card-label">Colores</span>
                            <input type="number" class="tech-card-input" id="inputColors" name="colors_count"
                                placeholder="0">
                        </div>
                        <div class="tech-card" id="techCardWidth">
                            <i class="fas fa-arrows-alt-h"></i>
                            <span class="tech-card-label">Ancho (mm)</span>
                            <input type="number" class="tech-card-input" id="inputWidth" name="width_mm"
                                placeholder="0" step="0.1">
                        </div>
                        <div class="tech-card" id="techCardHeight">
                            <i class="fas fa-arrows-alt-v"></i>
                            <span class="tech-card-label">Alto (mm)</span>
                            <input type="number" class="tech-card-input" id="inputHeight" name="height_mm"
                                placeholder="0" step="0.1">
                        </div>
                    </div>
                </div>

                {{-- Colores Detectados --}}
                <div class="colors-preview-section" id="colorsPreview" style="display: none;">
                    <h6 class="section-label-large">COLORES DETECTADOS</h6>
                    <div class="color-swatches" id="colorSwatches"></div>
                </div>

                {{-- Campos del Formulario --}}
                <div class="form-fields-section" id="formFields" style="display: none;">
                    <h6 class="section-label-large">INFORMACIÓN DE APLICACIÓN</h6>

                    <div class="field-row">
                        <div class="field-group">
                            <label class="field-label">
                                Tipo de Aplicación <span class="required-mark">*</span>
                            </label>
                            <select id="applicationType" name="application_type" class="field-control" required>
                                <option value="">Seleccionar...</option>
                                @php
                                    $applicationTypes = \App\Models\Application_types::activos()
                                        ->orderBy('nombre_aplicacion')
                                        ->get();
                                @endphp
                                @foreach ($applicationTypes as $tipo)
                                    <option value="{{ $tipo->slug }}">{{ $tipo->nombre_aplicacion }}</option>
                                @endforeach
                            </select>
                            <span class="field-error" id="errorApplicationType"></span>
                        </div>
                        <div class="field-group">
                            <label class="field-label">
                                Etiqueta / Nombre <span class="required-mark">*</span>
                            </label>
                            <input type="text" id="applicationLabel" name="application_label"
                                class="field-control" placeholder="Ej: Logo frontal" required maxlength="100">
                            <span class="field-error" id="errorApplicationLabel"></span>
                        </div>
                    </div>

                    <div class="field-group">
                        <label class="field-label">Descripción de Ubicación</label>
                        <input type="text" id="placementDescription" name="placement_description"
                            class="field-control" placeholder="Ej: Centrado a 5cm del cuello" maxlength="255">
                    </div>

                    <div class="field-group">
                        <label class="field-label">Notas Adicionales</label>
                        <textarea id="exportNotes" name="notes" class="field-control field-textarea" rows="2"
                            placeholder="Observaciones para producción..." maxlength="1000"></textarea>
                    </div>
                </div>

                {{-- Error General --}}
                <div class="form-error-alert" id="formError" style="display: none;"></div>

            </form>
        </div>

        {{-- Acciones --}}
        <div class="form-actions" id="formActions" style="display: none;">
            <button type="button" id="btnCancelExport" class="btn-premium btn-premium-outline">
                Cancelar
            </button>
            <button type="button" id="btnSaveExport" class="btn-premium btn-premium-primary" disabled>
                <i class="fas fa-save"></i>
                <span id="btnSaveText">Guardar</span>
            </button>
        </div>
    </div>
</div>

{{-- Modal de Vista Previa SVG --}}
<div class="svg-modal-overlay" id="svgModalOverlay" style="display: none;">
    <div class="svg-modal-container">
        <div class="svg-modal-header">
            <h5 class="svg-modal-title">
                <i class="fas fa-eye"></i>
                Vista Previa del Bordado
            </h5>
            <button type="button" class="svg-modal-close" id="btnCloseSvgModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="svg-modal-body">
            <div class="svg-modal-canvas" id="svgModalCanvas">
                {{-- SVG completo se inyecta aquí --}}
            </div>
        </div>
        <div class="svg-modal-toolbar">
            <div class="svg-modal-tools-left">
                <button type="button" class="svg-modal-btn" id="btnModalZoomOut" title="Alejar">
                    <i class="fas fa-minus"></i>
                </button>
                <span class="svg-zoom-level" id="svgZoomLabel">100%</span>
                <button type="button" class="svg-modal-btn" id="btnModalZoomIn" title="Acercar">
                    <i class="fas fa-plus"></i>
                </button>
                <button type="button" class="svg-modal-btn" id="btnModalZoomReset" title="Centrar">
                    <i class="fas fa-compress-arrows-alt"></i>
                </button>
            </div>
            <div class="svg-modal-tools-right">
                <button type="button" class="svg-modal-btn svg-modal-btn-primary" id="btnModalDownload"
                    title="Descargar SVG">
                    <i class="fas fa-download"></i>
                    <span>Descargar SVG</span>
                </button>
            </div>
        </div>
    </div>
</div>

{{-- Modal de Detalles (Overlay centrado) --}}
<div class="detail-overlay" id="exportDetailOverlay" style="display: none;">
    <div class="detail-modal-centered">
        <button type="button" class="modal-close-premium" id="btnCloseDetailOverlay" aria-label="Close">
            <i class="fas fa-times"></i>
        </button>

        <div class="detail-modal-body">
            {{-- Header del archivo --}}
            <div class="detail-file-header">
                <div class="detail-file-icon" id="detailFileIcon">
                    <i class="fas fa-file-code"></i>
                </div>
                <div class="detail-file-info">
                    <h5 class="detail-file-name" id="detailFileName">archivo.pes</h5>
                    <div class="detail-file-meta">
                        <span class="file-size" id="detailFileSize"
                            style="font-size: 16px; color: #6b7280; font-weight: 500;">125
                            KB</span>
                        <span class="file-format-tag" id="detailFileFormat" style="display:none;">PES</span>
                    </div>
                </div>
            </div>

            {{-- Status badge --}}
            <div class="detail-status-section">
                <div class="status-badge-detail" id="detailStatusBadge">
                    <span class="status-emoji" id="detailStatusEmoji">🟤</span>
                    <span class="status-text" id="detailStatusText">Borrador</span>
                </div>
            </div>

            {{-- Datos técnicos --}}
            <div class="detail-tech-section">
                <h6 class="section-title-sm">Datos Técnicos</h6>
                <div class="tech-grid-detail">
                    <div class="tech-item-detail">
                        <i class="fas fa-hashtag"></i>
                        <div>
                            <span class="tech-value-lg" id="detailStitches">0</span>
                            <span class="tech-label-sm">Puntadas</span>
                        </div>
                    </div>
                    <div class="tech-item-detail">
                        <i class="fas fa-palette"></i>
                        <div>
                            <span class="tech-value-lg" id="detailColors">0</span>
                            <span class="tech-label-sm">Colores</span>
                        </div>
                    </div>
                    <div class="tech-item-detail">
                        <i class="fas fa-arrows-alt-h"></i>
                        <div>
                            <span class="tech-value-lg" id="detailWidth">0</span>
                            <span class="tech-label-sm">Ancho mm</span>
                        </div>
                    </div>
                    <div class="tech-item-detail">
                        <i class="fas fa-arrows-alt-v"></i>
                        <div>
                            <span class="tech-value-lg" id="detailHeight">0</span>
                            <span class="tech-label-sm">Alto mm</span>
                        </div>
                    </div>
                </div>
            </div>

            {{-- Colores --}}
            <div class="detail-colors-section" id="detailColorsSection" style="display: none; margin-top: 24px;">
                <h6 class="section-title-sm">Colores Detectados</h6>
                <div id="detailColorSwatches" class="color-grid-lg"></div>
            </div>

            {{-- Información de aplicación --}}
            <div class="detail-app-section">
                <h6 class="section-title-sm">Aplicación</h6>
                <div class="info-grid">
                    <div class="info-row">
                        <span class="info-key">Tipo:</span>
                        <span class="info-val" id="detailAppType">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-key">Etiqueta:</span>
                        <span class="info-val" id="detailAppLabel">-</span>
                    </div>
                    <div class="info-row" id="detailPlacementRow" style="display: none;">
                        <span class="info-key">Ubicación:</span>
                        <span class="info-val" id="detailPlacement">-</span>
                    </div>
                    <div class="info-row" id="detailNotesRow" style="display: none;">
                        <span class="info-key">Notas:</span>
                        <span class="info-val info-notes" id="detailNotes">-</span>
                    </div>
                </div>
            </div>

            {{-- Metadata --}}
            <div class="detail-meta-section">
                <div class="meta-row">
                    <i class="fas fa-user"></i>
                    <span>Creado por: <strong id="detailCreator">-</strong></span>
                </div>
                <div class="meta-row">
                    <i class="fas fa-calendar"></i>
                    <span>Fecha: <strong id="detailDate">-</strong></span>
                </div>
                <div class="meta-row" id="detailApproverRow" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <span>Aprobado por: <strong id="detailApprover">-</strong></span>
                </div>
            </div>
        </div>

        {{-- Footer con acciones --}}
        <div class="detail-modal-footer">
            <div class="footer-actions-main">
                <a href="#" id="btnDetailDownload" class="btn-premium btn-premium-secondary" download>
                    <i class="fas fa-download"></i>
                    <span>Descargar</span>
                </a>
                <button type="button" id="btnDetailEdit" class="btn-premium btn-premium-primary">
                    <i class="fas fa-edit"></i>
                    <span>Editar</span>
                </button>
            </div>

            <div class="footer-actions-status">
                <button type="button" id="btnSendToReview" class="btn-premium btn-premium-warning"
                    style="display: none;">
                    <i class="fas fa-paper-plane"></i>
                    <span>Enviar a Revisión</span>
                </button>
                <button type="button" id="btnDetailApprove" class="btn-premium btn-premium-success"
                    style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <span>Aprobar</span>
                </button>
                <button type="button" id="btnDetailReject" class="btn-premium btn-premium-danger-outline"
                    style="display: none;">
                    <i class="fas fa-times-circle"></i>
                    <span>Rechazar</span>
                </button>
                <button type="button" id="btnDetailArchive" class="btn-premium btn-premium-dark"
                    style="display: none;">
                    <i class="fas fa-archive"></i>
                    <span>Archivar</span>
                </button>
                <button type="button" id="btnDetailRestore" class="btn-premium btn-premium-info"
                    style="display: none;">
                    <i class="fas fa-undo"></i>
                    <span>Restaurar</span>
                </button>
            </div>
        </div>

        {{-- Workflow Indicator --}}
        <div class="workflow-indicator" id="workflowIndicator">
            <div class="workflow-step" data-step="borrador">
                <div class="workflow-dot"></div>
                <span>Borrador</span>
            </div>
            <div class="workflow-line"></div>
            <div class="workflow-step" data-step="pendiente">
                <div class="workflow-dot"></div>
                <span>Revisión</span>
            </div>
            <div class="workflow-line"></div>
            <div class="workflow-step" data-step="aprobado">
                <div class="workflow-dot"></div>
                <span>Aprobado</span>
            </div>
            <div class="workflow-line"></div>
            <div class="workflow-step" data-step="archivado">
                <div class="workflow-dot"></div>
                <span>Archivado</span>
            </div>
        </div>
    </div>
</div>

{{-- Template para items --}}
<template id="exportItemTemplate">
    <div class="export-item" data-id="{id}" data-export='{export_json}'>
        <div class="export-status-indicator status-{status}"></div>
        <div class="export-item-content" role="button">
            {preview_html}
            <div class="export-item-info">
                <div class="export-item-name">{application_label}</div>
                <div class="export-item-meta">
                    <span class="meta-format">{file_format}</span>
                    <span class="meta-sep">•</span>
                    <span class="meta-stitches">{stitches_formatted} pts</span>
                    <span class="meta-sep">•</span>
                    <span class="meta-colors">{colors_count} col</span>
                    <span class="meta-sep">•</span>
                    <span class="meta-dimensions">{dimensions}</span>
                </div>
            </div>
            <div class="export-item-status">
                <span class="status-badge-emoji status-{status}">{status_emoji} {status_label}</span>
            </div>
        </div>
        <div class="export-item-actions">
            <button type="button" class="btn-action-icon btn-action-view btn-view-export" data-id="{id}"
                title="Ver detalles">
                <i class="fas fa-eye"></i>
            </button>
            <a href="{download_url}" class="btn-action-icon btn-action-download" title="Descargar" download>
                <i class="fas fa-download"></i>
            </a>
            <button type="button" class="btn-action-icon btn-action-delete btn-delete-export" data-id="{id}"
                title="Eliminar">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>
</template>

<style>
    /* ============================================= */
    /* VARIABLES CSS */
    /* ============================================= */
    .production-header,
    .production-content,
    .production-footer,
    .detail-overlay {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --primary-light: #dbeafe;
        --success: #10b981;
        --success-hover: #059669;
        --success-light: #d1fae5;
        --warning: #f59e0b;
        --warning-hover: #d97706;
        --warning-light: #fef3c7;
        --danger: #ef4444;
        --danger-hover: #dc2626;
        --danger-light: #fee2e2;
        --info: #06b6d4;
        --info-light: #cffafe;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --gray-200: #e5e7eb;
        --gray-300: #d1d5db;
        --gray-400: #9ca3af;
        --gray-500: #6b7280;
        --gray-600: #4b5563;
        --gray-700: #374151;
        --gray-800: #1f2937;
        --gray-900: #111827;
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 16px;
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    /* ============================================= */
    /* LAYOUT PRINCIPAL */
    /* ============================================= */
    .production-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        min-height: 0;
        position: relative;
    }

    /* ============================================= */
    /* HEADER COMPACTO */
    /* ============================================= */
    .production-header-compact {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 8px;
        margin-bottom: 8px;
        border-bottom: 1px solid var(--gray-200);
    }

    .production-title-compact {
        font-size: 15px;
        font-weight: 600;
        color: var(--gray-800);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .production-title-compact i {
        color: var(--primary);
        font-size: 14px;
    }

    .production-context-compact {
        font-size: 13px;
        color: var(--gray-500);
    }

    .production-context-compact strong {
        color: var(--gray-700);
    }

    /* ============================================= */
    /* FILTRO DE VARIANTE (INLINE) */
    /* ============================================= */
    .variant-filter-section {
        margin-bottom: 12px;
    }

    .variant-filter-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-select-inline {
        flex: 1;
        max-width: 200px;
        padding: 6px 10px;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-sm);
        font-size: 12px;
        color: var(--gray-700);
        background: #fff;
        cursor: pointer;
    }

    .filter-select-inline:focus {
        outline: none;
        border-color: var(--primary);
    }

    .btn-clear-inline {
        width: 28px;
        height: 28px;
        border: 1px solid var(--gray-300);
        background: #fff;
        border-radius: var(--radius-sm);
        color: var(--gray-400);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        transition: all 0.15s ease;
    }

    .btn-clear-inline:hover {
        background: var(--danger-light);
        border-color: var(--danger);
        color: var(--danger);
    }

    /* Legacy support */
    .filters-section {
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        padding: 12px;
        margin-bottom: 12px;
    }

    .filters-row {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-group {
        flex: 1;
        min-width: 120px;
    }

    .filter-label {
        display: block;
        font-size: 11px;
        font-weight: 600;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .filter-select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-sm);
        font-size: 13px;
        color: var(--gray-700);
        background: #fff;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .filter-select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn-clear-filters {
        width: 36px;
        height: 36px;
        border: 1px solid var(--gray-300);
        background: #fff;
        border-radius: var(--radius-sm);
        color: var(--gray-500);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
    }

    .btn-clear-filters:hover {
        background: var(--danger-light);
        border-color: var(--danger);
        color: var(--danger);
    }

    /* ============================================= */
    /* BOTÓN AGREGAR PRODUCCIÓN (ANCHO COMPLETO) */
    /* ============================================= */
    .add-production-section {
        margin-bottom: 12px;
    }

    .btn-add-production-full {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 12px 20px;
        background: linear-gradient(135deg, var(--primary) 0%, #1d4ed8 100%);
        color: #fff;
        border: none;
        border-radius: var(--radius-md);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .btn-add-production-full:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }

    .btn-add-production-full i {
        font-size: 12px;
    }

    /* ============================================= */
    /* RESUMEN DE ESTADOS (COMPACTO) */
    /* ============================================= */
    .summary-section {
        margin-bottom: 10px;
    }

    .summary-badges {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
        justify-content: center;
        width: 100%;
    }

    .summary-badge {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px 12px;
        background: #fff;
        border: 1.5px solid var(--gray-200);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 58px;
        flex: 1;
        max-width: 100px;
    }

    .summary-badge:hover {
        border-color: var(--primary);
        background: var(--primary-light);
    }

    .summary-badge.active {
        border-color: var(--primary);
        background: var(--primary);
    }

    .summary-badge.active .summary-count,
    .summary-badge.active .summary-label {
        color: #fff;
    }

    .summary-icon {
        font-size: 14px;
        margin-bottom: 2px;
    }

    .summary-count {
        font-size: 16px;
        font-weight: 700;
        color: var(--gray-800);
        line-height: 1;
    }

    .summary-label {
        font-size: 9px;
        font-weight: 500;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.2px;
        margin-top: 1px;
    }

    /* ============================================= */
    /* GRUPOS ACORDEÓN */
    /* ============================================= */
    .exports-groups-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .export-group {
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .export-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        background: var(--gray-50);
        cursor: pointer;
        transition: all 0.15s ease;
        user-select: none;
    }

    .export-group-header:hover {
        background: var(--gray-100);
    }

    .group-header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .group-thumbnail {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        object-fit: cover;
        border: 1px solid var(--gray-200);
    }

    .group-thumbnail-placeholder {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-sm);
        background: var(--gray-100);
        border: 1px solid var(--gray-200);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--gray-400);
    }

    .group-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .group-type-badge {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
        width: fit-content;
    }

    .group-type-badge.type-design {
        background: var(--primary-light);
        color: var(--primary);
    }

    .group-type-badge.type-variant {
        background: var(--success-light);
        color: #065f46;
    }

    .group-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--gray-800);
    }

    .group-header-right {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .group-count {
        font-size: 12px;
        color: var(--gray-500);
        font-weight: 500;
    }

    .group-toggle-icon {
        font-size: 12px;
        color: var(--gray-400);
        transition: transform 0.2s ease;
    }

    .export-group-header.collapsed .group-toggle-icon {
        transform: rotate(-90deg);
    }

    .export-group-body {
        padding: 8px;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .export-group-body.collapsed {
        display: none;
    }

    /* Botón de acción principal mini (contextual al estado) */
    .btn-action-primary-mini {
        width: 34px;
        height: 34px;
        border: none;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 14px;
    }

    .btn-action-primary-mini[data-status="borrador"] {
        background: var(--warning-light);
        color: var(--warning);
    }

    .btn-action-primary-mini[data-status="borrador"]:hover {
        background: var(--warning);
        color: #fff;
    }

    .btn-action-primary-mini[data-status="pendiente"] {
        background: var(--success-light);
        color: var(--success);
    }

    .btn-action-primary-mini[data-status="pendiente"]:hover {
        background: var(--success);
        color: #fff;
    }

    .btn-action-primary-mini[data-status="aprobado"] {
        background: var(--gray-200);
        color: var(--gray-600);
    }

    .btn-action-primary-mini[data-status="aprobado"]:hover {
        background: var(--gray-700);
        color: #fff;
    }

    .btn-action-primary-mini[data-status="archivado"] {
        background: var(--info-light);
        color: var(--info);
    }

    .btn-action-primary-mini[data-status="archivado"]:hover {
        background: var(--info);
        color: #fff;
    }

    .status-badge-mini {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
        margin-right: 4px;
    }

    .status-badge-mini.status-borrador {
        background: var(--gray-100);
        color: var(--gray-600);
    }

    .status-badge-mini.status-pendiente {
        background: var(--warning-light);
        color: #92400e;
    }

    .status-badge-mini.status-aprobado {
        background: var(--success-light);
        color: #065f46;
    }

    .status-badge-mini.status-archivado {
        background: var(--gray-800);
        color: #fff;
    }

    .export-item.filtered-out {
        display: none !important;
    }

    /* ============================================= */
    /* RESPONSIVE - WEB APP OPTIMIZADO */
    /* ============================================= */

    /* Tablet landscape y desktop pequeño */
    @media (max-width: 992px) {
        .summary-badge {
            padding: 6px 8px;
            min-width: 50px;
        }

        .summary-count {
            font-size: 14px;
        }

        .summary-label {
            font-size: 9px;
        }
    }

    /* Tablet portrait */
    @media (max-width: 768px) {
        .summary-badges {
            gap: 4px;
        }

        .summary-badge {
            padding: 6px 4px;
            min-width: 45px;
            max-width: none;
        }

        .summary-icon {
            font-size: 12px;
        }

        .summary-count {
            font-size: 13px;
        }

        .summary-label {
            font-size: 8px;
            letter-spacing: -0.3px;
        }
    }

    /* Móvil grande */
    @media (max-width: 600px) {
        .add-production-section {
            margin-bottom: 8px;
        }

        .btn-add-production-full {
            padding: 12px 16px;
            font-size: 13px;
        }

        .btn-add-production-full i {
            font-size: 14px;
        }

        .summary-badges {
            justify-content: space-between;
            gap: 3px;
        }

        .summary-badge {
            min-width: 0;
            flex: 1;
            padding: 5px 3px;
            max-width: none;
        }

        .summary-icon {
            font-size: 11px;
            margin-bottom: 1px;
        }

        .summary-count {
            font-size: 12px;
        }

        .summary-label {
            font-size: 7px;
            letter-spacing: -0.5px;
        }

        .filters-row {
            flex-direction: column;
        }

        .filter-group {
            width: 100%;
        }

        .btn-clear-filters {
            align-self: flex-end;
        }
    }

    /* Móvil pequeño */
    @media (max-width: 420px) {
        .btn-add-production-full {
            padding: 10px 12px;
            font-size: 12px;
        }

        .summary-badges {
            gap: 2px;
        }

        .summary-badge {
            padding: 4px 2px;
            border-radius: 4px;
        }

        .summary-icon {
            font-size: 10px;
        }

        .summary-count {
            font-size: 11px;
        }

        .summary-label {
            font-size: 6px;
            text-transform: uppercase;
            letter-spacing: -0.3px;
        }
    }

    /* Pantallas muy pequeñas - ocultar labels, solo iconos y números */
    @media (max-width: 340px) {
        .summary-label {
            display: none;
        }

        .summary-badge {
            padding: 6px 4px;
        }

        .summary-count {
            font-size: 12px;
        }

        .btn-add-production-full span {
            font-size: 11px;
        }
    }

    /* ============================================= */
    /* ESTADOS */
    /* ============================================= */
    .production-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 20px;
        text-align: center;
    }

    .empty-state-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, var(--primary-light) 0%, #eff6ff 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 20px;
    }

    .empty-state-icon i {
        font-size: 32px;
        color: var(--primary);
    }

    .empty-state-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--gray-800);
        margin-bottom: 8px;
    }

    .empty-state-text {
        font-size: 14px;
        color: var(--gray-500);
        margin-bottom: 24px;
    }

    /* ============================================= */
    /* BOTONES PREMIUM */
    /* ============================================= */
    .btn-premium {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px 20px;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        text-decoration: none;
        min-height: 52px;
        /* Standardize height with design-actions */
    }

    .btn-premium-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
        color: #fff;
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.25);
    }

    .btn-premium-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.35);
        color: #fff;
        text-decoration: none;
    }

    .btn-premium-secondary {
        background: var(--gray-100);
        color: var(--gray-700);
        border: 1px solid var(--gray-200);
    }

    .btn-premium-secondary:hover {
        background: var(--gray-200);
        color: var(--gray-800);
        text-decoration: none;
    }

    .btn-premium-outline {
        background: transparent;
        border: 2px solid var(--gray-300);
        /* Match thickness with danger button */
        color: var(--gray-700);
    }

    .btn-premium-outline:hover {
        background: var(--gray-100);
        border-color: var(--gray-400);
    }

    .btn-premium-success {
        background: linear-gradient(135deg, var(--success) 0%, var(--success-hover) 100%);
        color: #fff;
    }

    .btn-premium-success:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-premium-warning {
        background: linear-gradient(135deg, var(--warning) 0%, var(--warning-hover) 100%);
        color: #fff;
    }

    .btn-premium-warning:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
    }

    .btn-premium-danger-outline {
        background: transparent;
        border: 1.5px solid var(--danger);
        color: var(--danger);
    }

    .btn-premium-danger-outline:hover {
        background: var(--danger);
        color: #fff;
    }

    .btn-premium-dark {
        background: linear-gradient(135deg, var(--gray-700) 0%, var(--gray-800) 100%);
        color: #fff;
    }

    .btn-premium-dark:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(55, 65, 81, 0.3);
    }

    .btn-premium-info {
        background: linear-gradient(135deg, var(--info) 0%, #0891b2 100%);
        color: #fff;
    }

    .btn-premium-info:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
    }

    .btn-premium.btn-block {
        width: 100%;
    }

    /* ============================================= */
    /* LISTA DE EXPORTACIONES */
    /* ============================================= */
    .production-list-container {
        flex: 1;
        overflow-y: auto;
    }

    .exports-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .export-item {
        display: flex;
        align-items: stretch;
        background: #fff;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: all 0.2s ease;
    }

    .export-item:hover {
        border-color: var(--primary);
        box-shadow: var(--shadow-md);
    }

    .export-status-indicator {
        width: 5px;
        flex-shrink: 0;
        align-self: stretch;
    }

    .export-status-indicator.status-borrador {
        background: var(--gray-400);
    }

    .export-status-indicator.status-pendiente {
        background: var(--warning);
    }

    .export-status-indicator.status-aprobado {
        background: var(--success);
    }

    .export-status-indicator.status-archivado {
        background: var(--gray-800);
    }

    .export-item-content {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        cursor: pointer;
    }

    .export-item-icon {
        width: 40px;
        height: 40px;
        background: var(--primary-light);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .export-item-icon i {
        font-size: 18px;
        color: var(--primary);
    }

    /* Miniatura de imagen en el item */
    .export-item-thumbnail {
        width: 56px;
        height: 56px;
        flex-shrink: 0;
        border-radius: var(--radius-sm);
        overflow: hidden;
        background: #f1f5f9;
        border: 2px solid #e2e8f0;
    }

    .export-item-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .export-item-thumbnail.no-image {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .export-item-thumbnail.no-image i {
        font-size: 20px;
        color: #94a3b8;
    }

    .export-item-info {
        flex: 1;
        min-width: 0;
    }

    .export-item-name {
        font-size: 14px;
        font-weight: 600;
        color: var(--gray-800);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .export-item-meta {
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 6px;
        font-size: 12px;
        color: var(--gray-500);
        margin-top: 2px;
    }

    .meta-sep {
        opacity: 0.5;
    }

    .export-item-status {
        flex-shrink: 0;
        margin-right: 8px;
    }

    /* Status Badges con Emojis */
    .status-badge-emoji {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 5px 12px;
        border-radius: 14px;
        font-size: 12px;
        font-weight: 600;
        white-space: nowrap;
    }

    .status-badge-emoji.status-borrador {
        background: var(--gray-100);
        color: var(--gray-600);
    }

    .status-badge-emoji.status-pendiente {
        background: var(--warning-light);
        color: #92400e;
    }

    .status-badge-emoji.status-aprobado {
        background: var(--success-light);
        color: #065f46;
    }

    .status-badge-emoji.status-archivado {
        background: var(--gray-800);
        color: #fff;
    }

    /* Botones de acción */
    .export-item-actions {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px 8px 0;
        flex-shrink: 0;
    }

    .btn-action-icon {
        width: 34px;
        height: 34px;
        border: none;
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        font-size: 14px;
    }

    .btn-action-view {
        background: var(--primary-light);
        color: var(--primary);
    }

    .btn-action-view:hover {
        background: var(--primary);
        color: #fff;
        transform: scale(1.05);
    }

    .btn-action-download {
        background: var(--info-light);
        color: var(--info);
    }

    .btn-action-download:hover {
        background: var(--info);
        color: #fff;
        transform: scale(1.05);
    }

    .btn-action-delete {
        background: var(--danger-light);
        color: var(--danger);
    }

    .btn-action-delete:hover {
        background: var(--danger);
        color: #fff;
        transform: scale(1.05);
    }

    /* ============================================= */
    /* FORMULARIO */
    /* ============================================= */
    .production-form-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .form-header-bar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding-bottom: 14px;
        margin-bottom: 14px;
        border-bottom: 1px solid var(--gray-200);
        flex-shrink: 0;
    }

    .btn-back {
        width: 36px;
        height: 36px;
        border: none;
        background: var(--gray-100);
        color: var(--gray-600);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .btn-back:hover {
        background: var(--gray-200);
        color: var(--gray-800);
    }

    .form-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--gray-800);
    }

    .form-scroll-area {
        flex: 1;
        overflow-y: auto;
        padding: 0px 10px 0px 10px;
    }

    /* Upload Zone */
    .upload-zone {
        border: 2px dashed var(--gray-300);
        border-radius: var(--radius-md);
        padding: 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-bottom: 16px;
        position: relative;
    }

    .upload-zone:hover {
        border-color: var(--primary);
        background: rgba(37, 99, 235, 0.02);
    }

    .upload-zone.drag-over {
        border-color: var(--primary);
        background: rgba(37, 99, 235, 0.05);
    }

    .upload-zone.has-file {
        border-style: solid;
        border-color: var(--success);
        background: rgba(16, 185, 129, 0.05);
    }

    .upload-zone.has-error {
        border-style: solid;
        border-color: var(--danger);
        background: var(--danger-light);
    }

    .upload-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .upload-icon {
        width: 56px;
        height: 56px;
        background: var(--primary-light);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
    }

    .upload-icon i {
        font-size: 24px;
        color: var(--primary);
    }

    .upload-text {
        font-size: 15px;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 4px;
    }

    .upload-subtext {
        font-size: 13px;
        color: var(--gray-500);
        margin-bottom: 12px;
    }

    .upload-formats {
        font-size: 11px;
        color: var(--gray-400);
        font-family: 'SF Mono', 'Consolas', monospace;
    }

    .upload-analyzing {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .upload-success,
    .upload-error {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
    }

    .upload-success-icon {
        color: var(--success);
        font-size: 20px;
    }

    .upload-error-icon {
        color: var(--danger);
        font-size: 20px;
    }

    .upload-filename {
        flex: 1;
        font-size: 14px;
        font-weight: 500;
        color: var(--gray-700);
        text-align: left;
    }

    .btn-remove-file {
        width: 28px;
        height: 28px;
        border: none;
        background: var(--gray-200);
        color: var(--gray-600);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    .btn-remove-file:hover {
        background: var(--danger);
        color: #fff;
    }

    /* ============================================= */
    /* SVG THUMBNAIL COMPACTO */
    /* ============================================= */
    .svg-preview-section {
        margin-bottom: 16px;
    }

    .svg-thumbnail-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
    }

    .svg-thumbnail-card {
        position: relative;
        width: 250px;
        height: 250px;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-sm);
        background: #fff;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .svg-thumbnail-card:hover {
        border-color: var(--primary);
        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.15);
    }

    .svg-thumbnail-inner {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 4px;
        background-image: radial-gradient(var(--gray-200) 1px, transparent 1px);
        background-size: 8px 8px;
    }

    .svg-thumbnail-inner svg {
        max-width: 100%;
        max-height: 100%;
        width: auto;
        height: auto;
    }

    .svg-thumbnail-hover {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(37, 99, 235, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
        color: #fff;
        font-size: 18px;
    }

    .svg-thumbnail-card:hover .svg-thumbnail-hover {
        opacity: 1;
    }

    .svg-thumbnail-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
        flex: 1;
    }

    .svg-thumbnail-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--gray-700);
    }

    .svg-thumbnail-hint {
        font-size: 11px;
        color: var(--gray-400);
    }

    .svg-thumbnail-badge {
        font-size: 8px;
        font-weight: 700;
        color: #fff;
        background: linear-gradient(135deg, var(--primary) 0%, #7c3aed 100%);
        padding: 2px 6px;
        border-radius: 8px;
        letter-spacing: 0.5px;
    }

    /* ============================================= */
    /* SVG MODAL OVERLAY */
    /* ============================================= */
    .svg-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        z-index: 100000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        animation: svgModalFadeIn 0.2s ease;
    }

    @keyframes svgModalFadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .svg-modal-container {
        background: #fff;
        border-radius: 150px;
        width: 100%;
        max-width: 900px;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: svgModalSlideIn 0.25s ease;
    }

    @keyframes svgModalSlideIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-10px);
        }

        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .svg-modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        border-bottom: 1px solid var(--gray-200);
    }

    .svg-modal-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--gray-800);
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .svg-modal-title i {
        color: var(--primary);
    }

    .svg-modal-close {
        width: 36px;
        height: 36px;
        border: none;
        background: var(--gray-100);
        border-radius: 8px;
        color: var(--gray-500);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
    }

    .svg-modal-close:hover {
        background: var(--gray-200);
        color: var(--gray-700);
    }

    .svg-modal-body {
        flex: 1;
        padding: 20px;
        overflow: hidden;
        background: #f8fafc;
        background-image: radial-gradient(var(--gray-300) 1px, transparent 1px);
        background-size: 16px 16px;
        min-height: 400px;
        max-height: 60vh;
    }

    .svg-modal-canvas {
        width: 100%;
        height: 100%;
        min-height: 350px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: grab;
        overflow: hidden;
    }

    .svg-modal-canvas:active {
        cursor: grabbing;
    }

    .svg-modal-canvas svg {
        max-width: 100%;
        max-height: 100%;
        transition: transform 0.1s ease;
    }

    .svg-modal-toolbar {
        display: flex;
        align-items: center;
        justify-content: center;
        /* Centrado de herramientas */
        gap: 20px;
        /* Espacio entre grupos */
        padding: 8px 20px;
        /* Reducido espacio vertical */
        border-top: 1px solid var(--gray-200);
        background: #fff;
        border-radius: 0 0 12px 12px;
    }

    .svg-modal-tools-left,
    .svg-modal-tools-right {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .svg-modal-btn {
        height: 36px;
        padding: 0 12px;
        border: 1px solid var(--gray-200);
        background: #fff;
        border-radius: 8px;
        color: var(--gray-600);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.15s ease;
    }

    .svg-modal-btn:hover {
        background: var(--gray-100);
        border-color: var(--gray-300);
    }

    .svg-modal-btn:active {
        transform: scale(0.97);
    }

    .svg-modal-btn i {
        font-size: 14px;
    }

    .svg-modal-btn-primary {
        background: var(--primary);
        border-color: var(--primary);
        color: #fff;
    }

    .svg-modal-btn-primary:hover {
        background: var(--primary-hover);
        border-color: var(--primary-hover);
    }

    .svg-zoom-level {
        font-size: 12px;
        font-weight: 600;
        color: var(--gray-500);
        min-width: 45px;
        text-align: center;
    }

    /* Alert manual entry */
    .alert-manual-entry {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: var(--warning-light);
        border: 1px solid #fcd34d;
        border-radius: var(--radius-sm);
        margin-bottom: 16px;
        font-size: 13px;
        color: #92400e;
    }

    .alert-manual-entry i {
        font-size: 16px;
    }

    /* Technical Data */
    .technical-data-section,
    .colors-preview-section,
    .form-fields-section {
        margin-bottom: 20px;
    }

    .section-label-large {
        font-size: 12px;
        font-weight: 700;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 12px;
    }

    .tech-cards {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .tech-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 14px;
        background: var(--gray-50);
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-sm);
        text-align: center;
        transition: all 0.2s ease;
    }

    .tech-card.has-error {
        border-color: var(--danger);
        background: var(--danger-light);
    }

    .tech-card i {
        font-size: 24px;
        color: var(--primary);
        margin-bottom: 8px;
    }

    .tech-card-label {
        font-size: 14px;
        color: var(--gray-500);
        margin-bottom: 8px;
        font-weight: 600;
    }

    .tech-card-input {
        width: 100%;
        max-width: 120px;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-sm);
        padding: 8px;
        font-size: 20px;
        font-weight: 700;
        color: var(--gray-800);
        text-align: center;
        background: #fff;
        height: 48px;
    }

    .tech-card-input:focus {
        outline: none;
        border-color: var(--primary);
    }

    /* Color Swatches */
    .color-swatches {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .color-swatch {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
    }

    .color-swatch-box {
        width: 48px;
        height: 48px;
        border-radius: var(--radius-sm);
        border: 3px solid #fff;
        box-shadow: var(--shadow-md);
    }

    .color-swatch-label {
        font-size: 13px;
        font-weight: 700;
        color: var(--gray-700);
        text-align: center;
        font-family: 'SF Mono', 'Consolas', monospace;
    }

    /* Form Fields */
    .field-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
    }

    .field-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 12px;
    }

    .field-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--gray-700);
    }

    .required-mark {
        color: var(--danger);
    }

    .field-control {
        padding: 10px 12px;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-sm);
        font-size: 14px;
        color: var(--gray-800);
        transition: all 0.15s ease;
    }

    .field-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .field-control.has-error {
        border-color: var(--danger);
    }

    .field-textarea {
        resize: vertical;
        min-height: 60px;
    }

    .field-error {
        font-size: 12px;
        color: var(--danger);
    }

    /* Form Error */
    .form-error-alert {
        padding: 12px 16px;
        background: var(--danger-light);
        border: 1px solid #fecaca;
        border-radius: var(--radius-sm);
        color: var(--danger);
        font-size: 13px;
        margin-bottom: 16px;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 10px;
        padding-top: 16px;
        border-top: 1px solid var(--gray-200);
        margin-top: 16px;
    }

    .form-actions .btn-premium {
        flex: 1;
    }

    /* ============================================= */
    /* MODAL DE DETALLES */
    /* ============================================= */
    .detail-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        z-index: 99999;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: auto;
    }

    .detail-modal-centered {
        background: #fff;
        border-radius: var(--radius-lg);
        max-width: 480px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
        position: relative;
        box-shadow: var(--shadow-lg);
        overflow: visible;
    }

    .detail-modal-close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border: none;
        background: var(--gray-100);
        color: var(--gray-500);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: all 0.15s ease;
    }

    .detail-modal-close:hover {
        background: var(--gray-200);
        color: var(--gray-700);
    }

    .detail-modal-body {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    /* File Header */
    .detail-file-header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 16px;
    }

    .detail-file-icon {
        width: 50px;
        height: 50px;
        background: var(--primary-light);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .detail-file-icon i {
        font-size: 22px;
        color: var(--primary);
    }

    .detail-file-name {
        font-size: 20px;
        font-weight: 700;
        color: var(--gray-800);
        margin: 0 0 4px;
        word-break: break-all;
        text-transform: uppercase;
    }

    .detail-file-meta {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .file-format-tag {
        background: var(--primary);
        color: #fff;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }

    .file-size {
        font-size: 16px;
        color: var(--gray-500);
        font-weight: 500;
    }

    /* Status Badge Detail */
    .detail-status-section {
        margin-bottom: 16px;
    }

    .status-badge-detail {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }

    .status-badge-detail.status-borrador {
        background: var(--gray-100);
        color: var(--gray-600);
    }

    .status-badge-detail.status-pendiente {
        background: var(--warning-light);
        color: #92400e;
    }

    .status-badge-detail.status-aprobado {
        background: var(--success-light);
        color: #065f46;
    }

    .status-badge-detail.status-archivado {
        background: var(--gray-800);
        color: #fff;
    }

    .status-emoji {
        font-size: 16px;
    }

    /* Tech Grid Detail */
    .detail-tech-section {
        margin-bottom: 16px;
        margin-top: 24px;
    }

    .section-title-sm {
        font-size: 12px;
        font-weight: 700;
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 10px;
    }

    .tech-grid-detail {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }

    .tech-item-detail {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        background: var(--gray-50);
        border-radius: var(--radius-sm);
    }

    .tech-item-detail i {
        font-size: 24px;
        color: var(--primary);
    }

    .tech-value-lg {
        display: block;
        font-size: 20px;
        font-weight: 700;
        color: var(--gray-800);
    }

    .tech-label-sm {
        font-size: 14px;
        color: var(--gray-500);
        font-weight: 600;
    }

    /* Colors Grid */
    .color-grid-lg {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    /* Info Grid */
    .detail-app-section {
        margin-bottom: 16px;
        margin-top: 24px;
    }

    .info-grid {
        background: var(--gray-50);
        border-radius: var(--radius-sm);
        padding: 12px;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid var(--gray-200);
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-key {
        font-size: 13px;
        color: var(--gray-500);
    }

    .info-val {
        font-size: 13px;
        font-weight: 600;
        color: var(--gray-800);
        text-align: right;
    }

    .info-notes {
        max-width: 200px;
        white-space: pre-wrap;
        word-break: break-word;
    }

    /* Meta Section */
    .detail-meta-section {
        padding: 12px;
        background: var(--gray-50);
        border-radius: var(--radius-sm);
    }

    .meta-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: var(--gray-600);
        padding: 6px 0;
    }

    .meta-row i {
        width: 16px;
        color: var(--gray-400);
    }

    .meta-row strong {
        color: var(--gray-800);
    }

    /* Modal Footer */
    .detail-modal-footer {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 16px 20px;
        border-top: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .footer-actions-main {
        display: flex;
        gap: 10px;
    }

    .footer-actions-main .btn-premium {
        flex: 1;
    }

    .footer-actions-status {
        display: flex;
        gap: 10px;
    }

    .footer-actions-status .btn-premium {
        flex: 1;
    }

    .footer-actions-status:empty {
        display: none;
    }

    /* Workflow Indicator */
    .workflow-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 12px 20px 16px;
        background: #fff;
        border-top: 1px solid var(--gray-100);
    }

    .workflow-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
    }

    .workflow-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--gray-300);
        border: 2px solid var(--gray-300);
        transition: all 0.3s ease;
    }

    .workflow-step span {
        font-size: 10px;
        font-weight: 500;
        color: var(--gray-400);
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .workflow-line {
        flex: 1;
        height: 2px;
        background: var(--gray-200);
        margin: 0 8px;
        margin-bottom: 20px;
        min-width: 30px;
    }

    .workflow-step.completed .workflow-dot {
        background: var(--success);
        border-color: var(--success);
    }

    .workflow-step.completed span {
        color: var(--success);
    }

    .workflow-step.current .workflow-dot {
        background: #fff;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
    }

    .workflow-step.current span {
        color: var(--primary);
        font-weight: 600;
    }

    .workflow-line.completed {
        background: var(--success);
    }

    /* ============================================= */
    /* FOOTER PRODUCCIÓN */
    /* ============================================= */
    .production-footer {
        padding: 16px 0;
        border-top: 1px solid var(--gray-200);
        margin-top: auto;
    }

    /* ============================================= */
    /* RESPONSIVE - EXPORT ITEMS & FORM */
    /* ============================================= */

    /* Tablet */
    @media (max-width: 768px) {
        .export-item-meta .meta-dimensions {
            display: none;
        }

        .btn-action-icon {
            width: 30px;
            height: 30px;
            font-size: 12px;
        }

        .export-item-thumb {
            width: 40px;
            height: 40px;
        }

        .export-item-content {
            gap: 8px;
        }

        .export-item-name {
            font-size: 13px;
        }

        .export-item-meta span {
            font-size: 10px;
        }

        /* Form adjustments */
        .upload-zone {
            padding: 20px 15px;
        }

        .upload-zone i {
            font-size: 32px;
        }

        .tech-cards {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .tech-card {
            padding: 10px;
        }
    }

    /* Móvil */
    @media (max-width: 576px) {
        .tech-cards {
            grid-template-columns: 1fr 1fr;
        }

        .field-row {
            grid-template-columns: 1fr;
        }

        .tech-grid-detail {
            grid-template-columns: 1fr 1fr;
        }

        .detail-modal-centered {
            max-width: 100%;
            max-height: 100%;
            border-radius: 0;
        }

        .detail-overlay {
            padding: 0;
        }

        .export-item {
            flex-direction: column;
            align-items: stretch;
        }

        .export-status-indicator {
            width: 100%;
            height: 4px;
            position: absolute;
            top: 0;
            left: 0;
        }

        .export-item-thumb {
            width: 36px;
            height: 36px;
            flex-shrink: 0;
        }

        .export-item-content {
            flex: 1;
            min-width: 0;
        }

        .export-item-name {
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .export-item-meta {
            flex-wrap: wrap;
            gap: 4px;
        }

        .export-item-meta span {
            font-size: 9px;
        }

        .export-item-actions {
            width: 100%;
            justify-content: flex-end;
            padding: 8px 12px;
            border-top: 1px solid var(--gray-100);
            gap: 6px;
        }

        .btn-action-icon {
            width: 28px;
            height: 28px;
            font-size: 11px;
        }

        /* Upload zone mobile */
        .upload-zone {
            padding: 16px 12px;
            min-height: 100px;
        }

        .upload-zone i {
            font-size: 28px;
            margin-bottom: 6px;
        }

        .upload-zone p {
            font-size: 12px;
            margin-bottom: 4px;
        }

        .upload-zone small {
            font-size: 10px;
        }

        /* Form mobile */
        .form-group label {
            font-size: 12px;
        }

        .form-control {
            font-size: 14px;
            padding: 8px 10px;
        }

        .tech-cards {
            grid-template-columns: 1fr 1fr;
            gap: 6px;
        }

        .tech-card {
            padding: 8px;
        }

        .tech-card .value {
            font-size: 14px;
        }

        .tech-card .label {
            font-size: 9px;
        }

        .footer-actions-main,
        .footer-actions-status {
            flex-direction: column;
        }

        /* Empty state mobile */
        .production-state {
            padding: 32px 16px;
        }

        .empty-state-icon {
            width: 60px;
            height: 60px;
        }

        .empty-state-icon i {
            font-size: 24px;
        }

        .empty-state-title {
            font-size: 15px;
        }

        .empty-state-text {
            font-size: 12px;
        }
    }

    /* Móvil muy pequeño */
    @media (max-width: 380px) {
        .export-item-thumb {
            width: 32px;
            height: 32px;
        }

        .export-item-name {
            font-size: 11px;
        }

        .btn-action-icon {
            width: 26px;
            height: 26px;
            font-size: 10px;
        }

        .tech-cards {
            grid-template-columns: 1fr;
        }

        .upload-zone {
            padding: 14px 10px;
        }
    }

    /* Touch-friendly: aumentar áreas táctiles */
    @media (hover: none) and (pointer: coarse) {
        .summary-badge {
            min-height: 44px;
        }

        .btn-action-icon {
            min-width: 36px;
            min-height: 36px;
        }

        .export-item {
            min-height: 60px;
        }

        .btn-add-production-full {
            min-height: 48px;
        }
    }

    /* ============================================= */
    /* ACCIONES DEL FORMULARIO (MODIFICADO - MATCH INDEX) */
    /* ============================================= */
    .form-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: auto;
        padding-top: 17px;
        border-top: 1px solid var(--gray-200);
        margin-bottom: 12px;
        padding-bottom: 4px;
        width: 100%;
        padding-left: 16px;
        padding-right: 16px;
        box-sizing: border-box;
    }

    .form-actions button {
        flex: 1;
        /* Misma proporción */
        justify-content: center;
        height: 52px;
        /* Standard height */
        min-height: 52px;
    }

    /* ============================================= */
    /* VISTA PREVIA SVG (REDEFINED) */
    /* ============================================= */
    .svg-preview-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px dashed var(--gray-300);
        width: 100%;
    }

    .svg-thumbnail-row {
        display: flex;
        align-items: center;
        justify-content: center;
        /* Centrado solicitado */
        gap: 15px;
        position: relative;
    }

    .svg-thumbnail-card {
        width: 180px;
        height: 180px;
        border: 1px solid var(--gray-300);
        border-radius: var(--radius-sm);
        background: #fff;
        padding: 4px;
        cursor: pointer;
        position: relative;
        overflow: hidden;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .svg-thumbnail-card:hover {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px var(--primary-light);
    }

    .svg-thumbnail-inner {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .svg-thumbnail-hover {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(37, 99, 235, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .svg-thumbnail-card:hover .svg-thumbnail-hover {
        opacity: 1;
    }

    .svg-thumbnail-hover i {
        color: var(--primary);
        font-size: 20px;
    }

    .svg-thumbnail-info {
        display: flex;
        flex-direction: column;
    }

    .svg-thumbnail-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--gray-800);
    }

    .svg-thumbnail-hint {
        font-size: 12px;
        color: var(--gray-500);
    }

    /* Modal SVG */
    .svg-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        z-index: 100000;
        display: flex;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(4px);
    }

    .svg-modal-container {
        width: 95vw;
        height: 70vh;
        background: #fff;
        border-radius: 20px;
        /* Esquinas redondeadas solicitadas */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .svg-modal-header {
        height: 60px;
        padding: 0 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        /* Centrado del título */
        border-bottom: 1px solid var(--gray-200);
        background: #fff;
        z-index: 10;
        flex-shrink: 0;
        position: relative;
        /* Para botón de cierre absoluto */
    }

    .svg-modal-close {
        position: absolute;
        right: 20px;
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        border-radius: 50%;
        color: var(--gray-500);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .svg-modal-body {
        flex: 1;
        background-color: #f8fafc;
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 20px 20px;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
    }

    .svg-modal-canvas {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        cursor: grab;
    }

    .export-item-icon svg {
        width: 100%;
        height: 100%;
    }

    .export-preview-box {
        width: 40px;
        height: 40px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: transparent !important;
        padding: 0 !important;
        border-radius: var(--radius-sm);
    }

    .export-preview-box svg {
        width: 100%;
        height: 100%;
    }
</style>

<script>
    (function() {
        function initProductionTab() {
            if (typeof jQuery === 'undefined') {
                setTimeout(initProductionTab, 50);
                return;
            }

            var $ = jQuery;

            $(document).ready(function() {
                // Variables globales
                var currentDesignId = null;
                var currentVariantId = null;
                var currentContext = 'design';
                var currentFile = null;
                var analyzedData = null;
                var currentExportId = null;
                var isEditMode = false;
                var exportsData = {};
                var autoReadSuccess = true;
                var groupsData = [];
                var variantsList = [];
                var currentFilter = {
                    status: '',
                    variant: ''
                };

                var statusConfig = {
                    borrador: {
                        emoji: '🟤',
                        label: 'Borrador',
                        nextAction: 'pendiente',
                        actionIcon: 'fa-paper-plane',
                        actionTitle: 'Enviar a Revisión'
                    },
                    pendiente: {
                        emoji: '🟡',
                        label: 'Pendiente',
                        nextAction: 'aprobado',
                        actionIcon: 'fa-check-circle',
                        actionTitle: 'Aprobar'
                    },
                    aprobado: {
                        emoji: '🟢',
                        label: 'Aprobado',
                        nextAction: 'archivado',
                        actionIcon: 'fa-archive',
                        actionTitle: 'Archivar'
                    },
                    archivado: {
                        emoji: '⚫',
                        label: 'Archivado',
                        nextAction: 'borrador',
                        actionIcon: 'fa-undo',
                        actionTitle: 'Restaurar'
                    }
                };

                var baseUrl = '{{ url('/') }}';
                var csrfToken = '{{ csrf_token() }}';

                // URLs
                var urls = {
                    analyze: baseUrl + '/admin/exports/analyze',
                    storeAjax: baseUrl + '/admin/exports/store-ajax',
                    updateAjax: function(id) {
                        return baseUrl + '/admin/exports/' + id + '/update-ajax';
                    },
                    updateStatus: function(id) {
                        return baseUrl + '/admin/exports/' + id + '/status';
                    },
                    destroyAjax: function(id) {
                        return baseUrl + '/admin/exports/' + id + '/ajax';
                    },
                    getExport: function(id) {
                        return baseUrl + '/admin/exports/' + id + '/ajax';
                    },
                    designExports: function(designId) {
                        return baseUrl + '/admin/designs/' + designId + '/exports/ajax';
                    },
                    variantExports: function(designId, variantId) {
                        return baseUrl + '/admin/designs/' + designId + '/variants/' + variantId +
                            '/exports/ajax';
                    },
                    exportsGrouped: function(designId) {
                        return baseUrl + '/admin/designs/' + designId + '/exports-grouped';
                    },
                    exportsCount: function(designId) {
                        return baseUrl + '/admin/designs/' + designId + '/exports-count';
                    }
                };


                // ============================================
                // ENTERPRISE: Variables para cancelación de requests
                // ============================================
                var pendingProductionRequest = null;
                var loadRequestVersion = 0;

                // Cargar datos - V5 con agrupamiento + cancelación de requests
                function loadProductionData() {
                    // CRITICAL: Cancelar request anterior si existe
                    if (pendingProductionRequest && typeof pendingProductionRequest.abort === 'function') {
                        pendingProductionRequest.abort();
                        console.log('[ProductionTab] Previous request aborted - context changed');
                    }

                    currentDesignId = $('#modalDesignId').val();
                    currentVariantId = $('#modalVariantId').val();
                    currentContext = currentVariantId ? 'variant' : 'design';

                    // Incrementar versión para ignorar respuestas obsoletas
                    loadRequestVersion++;
                    var myVersion = loadRequestVersion;

                    if (!currentDesignId) {
                        showEmptyState();
                        $('#productionTotalCount').text('0');
                        return;
                    }

                    hideAllStates();
                    $('#productionLoading').show();

                    // Resetear filtros al cambiar contexto
                    currentFilter = {
                        status: '',
                        variant: ''
                    };
                    $('#filterVariant').val('');
                    $('.summary-badge').removeClass('active');
                    $('.summary-badge[data-filter=""]').addClass('active');

                    if (currentContext === 'design') {
                        // Vista principal: cargar agrupado
                        pendingProductionRequest = $.get(urls.exportsGrouped(currentDesignId))
                            .done(function(response) {
                                // Verificar que esta respuesta es para el request actual
                                if (myVersion !== loadRequestVersion) {
                                    console.log('[ProductionTab] Stale design response ignored');
                                    return;
                                }

                                $('#productionLoading').hide();

                                if (response.success) {
                                    groupsData = response.groups || [];
                                    variantsList = response.variants_list || [];
                                    exportsData = {};

                                    groupsData.forEach(function(g) {
                                        g.exports.forEach(function(e) {
                                            exportsData[e.id] = e;
                                        });
                                    });

                                    $('#productionContext').html('Diseño: <strong>' + response
                                        .design_name + '</strong>');
                                    $('#exportsCount').text(response.total_count + ' archivo' + (
                                        response.total_count !== 1 ? 's' : ''));

                                    updateSummary(response.summary);
                                    $('#productionTotalCount').text(response.total_count);
                                    updateFiltersSection();

                                    if (response.total_count > 0) {
                                        renderGroups(groupsData);
                                        $('#productionList').show();
                                    } else {
                                        showEmptyState();
                                    }
                                } else {
                                    showEmptyState();
                                }
                            })
                            .fail(function(jqXHR, textStatus) {
                                // Ignorar errores de abort (son intencionales)
                                if (textStatus === 'abort') {
                                    console.log('[ProductionTab] Design request aborted intentionally');
                                    return;
                                }
                                if (myVersion !== loadRequestVersion) return;
                                $('#productionLoading').hide();
                                showEmptyState();
                            });
                    } else {
                        // Vista de variante: lista simple
                        pendingProductionRequest = $.get(urls.variantExports(currentDesignId,
                                currentVariantId))
                            .done(function(response) {
                                // Verificar que esta respuesta es para el request actual
                                if (myVersion !== loadRequestVersion) {
                                    console.log('[ProductionTab] Stale variant response ignored');
                                    return;
                                }

                                $('#productionLoading').hide();

                                var displayCount = response.count || 0;

                                if (response.success && response.data && response.data.length > 0) {
                                    response.data.forEach(function(exp) {
                                        exportsData[exp.id] = exp;
                                    });

                                    updateSummary(response.summary || calculateSummary(response.data));
                                    $('#variantFilterSection').hide();

                                    renderSimpleList(response.data);
                                    $('#productionContext').html('Variante: <strong>' + (response
                                        .context_name || currentVariantId) + '</strong>');
                                    $('#exportsCount').text(displayCount + ' archivo' + (
                                        displayCount !== 1 ? 's' : ''));
                                    $('#productionList').show();
                                } else {
                                    showEmptyState();
                                    displayCount = 0;
                                }

                                $('#productionTotalCount').text(displayCount);
                            })
                            .fail(function(jqXHR, textStatus) {
                                // Ignorar errores de abort (son intencionales)
                                if (textStatus === 'abort') {
                                    console.log(
                                        '[ProductionTab] Variant request aborted intentionally');
                                    return;
                                }
                                if (myVersion !== loadRequestVersion) return;
                                $('#productionLoading').hide();
                                showEmptyState();
                                $('#productionTotalCount').text('0');
                            });
                    }
                }

                // Bandera para indicar que queremos ir directo al formulario (no cargar lista)
                var skipLoadAndShowForm = false;
                var pendingImageId = null;

                // Exponer funciones globalmente para que index.blade.php pueda llamarlas
                window.loadProductionData = loadProductionData;
                window.openExportForm = function() {
                    showForm(null);
                };

                // Función para preparar apertura directa al formulario
                // Se llama ANTES de cambiar a la pestaña de producción
                window.prepareDirectFormOpen = function(imageId) {
                    skipLoadAndShowForm = true;
                    pendingImageId = imageId || null;
                };

                // Función para limpiar imagen vinculada
                window.clearLinkedImage = function() {
                    $('#exportImageId').val('');
                    $('#linkedImageIndicator').hide().html('');
                };

                // Función interna para mostrar formulario directo
                function showFormDirect() {
                    // Establecer IDs del contexto actual
                    currentDesignId = $('#modalDesignId').val();
                    currentVariantId = $('#modalVariantId').val();

                    // Ocultar todo y mostrar solo el formulario
                    hideAllStates();
                    showForm(null);

                    // Establecer el image_id si viene de una imagen específica
                    if (pendingImageId) {
                        setTimeout(function() {
                            $('#exportImageId').val(pendingImageId);
                            // Mostrar indicador visual
                            $('#linkedImageIndicator').html(
                                '<div class="alert alert-info py-2 px-3 mb-2" style="font-size: 12px;">' +
                                '<i class="fas fa-link mr-1"></i> Producción vinculada a imagen #' +
                                pendingImageId +
                                '<button type="button" class="close" onclick="clearLinkedImage()" style="font-size: 14px; margin-left: 10px;">' +
                                '<span>&times;</span></button></div>'
                            ).show();
                            pendingImageId = null;
                        }, 50);
                    }
                }

                function calculateSummary(data) {
                    var summary = {
                        borrador: 0,
                        pendiente: 0,
                        aprobado: 0,
                        archivado: 0
                    };
                    data.forEach(function(e) {
                        if (summary.hasOwnProperty(e.status)) summary[e.status]++;
                    });
                    return summary;
                }

                function updateSummary(summary) {
                    var total = (summary.borrador || 0) + (summary.pendiente || 0) + (summary.aprobado ||
                        0) + (summary.archivado || 0);
                    $('#summaryTotal').text(total);
                    $('#summaryBorrador').text(summary.borrador || 0);
                    $('#summaryPendiente').text(summary.pendiente || 0);
                    $('#summaryAprobado').text(summary.aprobado || 0);
                    $('#summaryArchivado').text(summary.archivado || 0);
                }

                function updateFiltersSection() {
                    if (currentContext === 'design' && groupsData.length > 0) {
                        $('#variantFilterSection').show();
                        var $filter = $('#filterVariant');
                        $filter.find('option:not(:first)').remove();
                        $filter.append('<option value="design">📁 Diseño Principal</option>');
                        variantsList.forEach(function(v) {
                            $filter.append('<option value="' + v.id + '">🏷️ ' + v.name + ' (' + v
                                .count + ')</option>');
                        });
                    } else {
                        $('#variantFilterSection').hide();
                    }
                }

                function renderGroups(groups) {
                    var $container = $('#exportsGroupsContainer');
                    $container.empty();

                    if (!groups || groups.length === 0) {
                        showEmptyState();
                        return;
                    }

                    groups.forEach(function(group) {
                        var groupId = group.type + '_' + (group.variant_id || 'main');
                        var isDesign = group.type === 'design';
                        var typeClass = isDesign ? 'type-design' : 'type-variant';
                        var typeLabel = isDesign ? 'Diseño' : 'Variante';
                        var thumbnail = group.thumbnail || '';

                        var $group = $('<div class="export-group" data-group-id="' + groupId +
                            '" data-variant-id="' + (group.variant_id || '') + '">');

                        var headerHtml = '<div class="export-group-header">';
                        headerHtml += '<div class="group-header-left">';

                        if (thumbnail) {
                            headerHtml += '<img src="' + thumbnail +
                                '" class="group-thumbnail" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';">';
                            headerHtml +=
                                '<div class="group-thumbnail-placeholder" style="display: none;"><i class="fas fa-' +
                                (isDesign ? 'palette' : 'layer-group') + '"></i></div>';
                        } else {
                            headerHtml +=
                                '<div class="group-thumbnail-placeholder"><i class="fas fa-' + (
                                    isDesign ? 'palette' : 'layer-group') + '"></i></div>';
                        }

                        headerHtml += '<div class="group-info">';
                        headerHtml += '<span class="group-type-badge ' + typeClass + '">' +
                            typeLabel + '</span>';
                        headerHtml += '<span class="group-name">' + escapeHtml(group.name) +
                            '</span>';
                        headerHtml += '</div></div>';
                        headerHtml += '<div class="group-header-right">';
                        headerHtml += '<span class="group-count">' + group.count + ' archivo' + (
                            group.count !== 1 ? 's' : '') + '</span>';
                        headerHtml += '<i class="fas fa-chevron-down group-toggle-icon"></i>';
                        headerHtml += '</div></div>';

                        $group.append(headerHtml);

                        var $body = $('<div class="export-group-body">');
                        group.exports.forEach(function(exp) {
                            $body.append(renderExportItemV5(exp));
                        });

                        $group.append($body);
                        $container.append($group);
                    });

                    bindV5Events();
                }

                function renderSimpleList(exports) {
                    var $container = $('#exportsGroupsContainer');
                    $container.empty();

                    var $list = $('<div class="exports-list">');
                    exports.forEach(function(exp) {
                        $list.append(renderExportItemV5(exp));
                    });

                    $container.append($list);
                    bindV5Events();
                }

                function renderExportItemV5(exp) {
                    var status = exp.status || 'borrador';
                    var config = statusConfig[status];

                    var html = '<div class="export-item" data-id="' + exp.id + '" data-status="' + status +
                        '" data-variant="' + (exp.design_variant_id || '') + '">';
                    html += '<div class="export-status-indicator status-' + status + '"></div>';
                    html += '<div class="export-item-content" role="button">';

                    // Miniatura: Prioridad SVG -> Imagen -> Icono
                    if (exp.svg_content) {
                        html += '<div class="export-item-thumbnail export-preview-box">';
                        html += exp.svg_content;
                        html += '</div>';
                    } else if (exp.image_url) {
                        html += '<div class="export-item-thumbnail">';
                        html += '<img src="' + exp.image_url +
                            '" alt="Ref" onerror="this.parentElement.innerHTML=\'<i class=\\\'fas fa-image\\\'></i>\';this.parentElement.classList.add(\'no-image\');">';
                        html += '</div>';
                    } else {
                        html +=
                            '<div class="export-item-thumbnail no-image"><i class="fas fa-image"></i></div>';
                    }
                    html += '<div class="export-item-info">';
                    html += '<div class="export-item-name">' + escapeHtml(exp.application_label ||
                        'Sin nombre') + '</div>';
                    html += '<div class="export-item-meta">';
                    html += '<span class="meta-format">' + (exp.file_format || 'PES') + '</span>';
                    html += '<span class="meta-sep">•</span>';
                    html += '<span class="meta-stitches">' + (exp.stitches_formatted || '0') +
                        ' pts</span>';
                    html += '<span class="meta-sep">•</span>';
                    html += '<span class="meta-colors">' + (exp.colors_count || 0) + ' col</span>';
                    html += '<span class="meta-sep">•</span>';
                    html += '<span class="meta-dimensions">' + (exp.dimensions_formatted || '--') +
                        '</span>';
                    html += '</div></div></div>';

                    html += '<div class="export-item-actions">';
                    html += '<span class="status-badge-mini status-' + status + '">' + config.emoji + ' ' +
                        config.label + '</span>';
                    html +=
                        '<button type="button" class="btn-action-primary-mini btn-quick-status" data-id="' +
                        exp.id + '" data-status="' + status + '" title="' + config.actionTitle + '">';
                    html += '<i class="fas ' + config.actionIcon + '"></i></button>';
                    html += '<a href="' + exp.download_url +
                        '" class="btn-action-icon btn-action-download" title="Descargar" download>';
                    html += '<i class="fas fa-download"></i></a>';
                    html +=
                        '<button type="button" class="btn-action-icon btn-action-delete btn-delete-export" data-id="' +
                        exp.id + '" title="Eliminar">';
                    html += '<i class="fas fa-trash"></i></button>';
                    html += '</div></div>';

                    return $(html);
                }

                function bindV5Events() {
                    // Toggle acordeón
                    $('.export-group-header').off('click').on('click', function() {
                        var $header = $(this);
                        var $body = $header.next('.export-group-body');
                        var $icon = $header.find('.group-toggle-icon');

                        if ($body.is(':visible')) {
                            $body.slideUp(200);
                            $header.addClass('collapsed');
                            $icon.css('transform', 'rotate(-90deg)');
                        } else {
                            $body.slideDown(200);
                            $header.removeClass('collapsed');
                            $icon.css('transform', 'rotate(0deg)');
                        }
                    });

                    // Click en item para ver detalles
                    $('.export-item-content').off('click').on('click', function() {
                        var id = $(this).closest('.export-item').data('id');
                        openDetailPanel(id);
                    });

                    // Acción rápida de estado
                    $('.btn-quick-status').off('click').on('click', function(e) {
                        e.stopPropagation();
                        var id = $(this).data('id');
                        var currentStatus = $(this).data('status');
                        var nextStatus = statusConfig[currentStatus].nextAction;
                        confirmQuickStatusChange(id, currentStatus, nextStatus);
                    });

                    // Nota: El handler de eliminar está definido globalmente con $(document).on('click', '.btn-delete-export', ...)
                }

                function confirmQuickStatusChange(exportId, currentStatus, newStatus) {
                    var messages = {
                        'pendiente': {
                            title: '¿Enviar a Revisión?',
                            text: 'El archivo pasará a revisión.',
                            icon: 'question',
                            btn: 'Sí, enviar'
                        },
                        'aprobado': {
                            title: '¿Aprobar?',
                            text: 'El archivo quedará listo para producción.',
                            icon: 'success',
                            btn: 'Sí, aprobar'
                        },
                        'archivado': {
                            title: '¿Archivar?',
                            text: 'El archivo se moverá al histórico.',
                            icon: 'warning',
                            btn: 'Sí, archivar'
                        },
                        'borrador': {
                            title: '¿Restaurar?',
                            text: 'El archivo volverá a borrador.',
                            icon: 'info',
                            btn: 'Sí, restaurar'
                        }
                    };

                    var msg = messages[newStatus] || {
                        title: '¿Cambiar?',
                        text: '',
                        icon: 'question',
                        btn: 'Confirmar'
                    };

                    Swal.fire({
                        title: msg.title,
                        text: msg.text,
                        icon: msg.icon,
                        showCancelButton: true,
                        cancelButtonText: 'Cancelar',
                        confirmButtonText: msg.btn,
                        confirmButtonColor: '#2563eb',
                        // Fix z-index to appear above Bootstrap modal
                        customClass: {
                            container: 'swal2-container-high-zindex'
                        }
                    }).then(function(result) {
                        if (result.isConfirmed) {
                            $.ajax({
                                url: urls.updateStatus(exportId),
                                method: 'POST',
                                data: {
                                    _token: csrfToken,
                                    status: newStatus
                                },
                                success: function(response) {
                                    if (response.success) {
                                        toastSuccess('Estado actualizado');
                                        loadProductionData();
                                    } else {
                                        toastError(response.error || 'Error');
                                    }
                                },
                                error: function() {
                                    toastError('Error de conexión');
                                }
                            });
                        }
                    });
                }

                function applyFilters() {
                    var statusFilter = currentFilter.status;
                    var variantFilter = currentFilter.variant;

                    $('.summary-badge').removeClass('active');
                    $('.summary-badge[data-filter="' + statusFilter + '"]').addClass('active');

                    if (currentContext === 'design') {
                        $('.export-group').each(function() {
                            var $group = $(this);
                            var groupVariantId = $group.data('variant-id');
                            var isDesignGroup = groupVariantId === '' || groupVariantId ===
                                undefined;

                            var showGroup = true;
                            if (variantFilter) {
                                showGroup = variantFilter === 'design' ? isDesignGroup : (
                                    groupVariantId + '') === (variantFilter + '');
                            }

                            if (!showGroup) {
                                $group.hide();
                                return;
                            }
                            $group.show();

                            var visibleCount = 0;
                            $group.find('.export-item').each(function() {
                                var $item = $(this);
                                if (statusFilter && $item.data('status') !== statusFilter) {
                                    $item.addClass('filtered-out');
                                } else {
                                    $item.removeClass('filtered-out');
                                    visibleCount++;
                                }
                            });

                            if (visibleCount === 0) $group.hide();
                        });
                    } else {
                        $('.export-item').each(function() {
                            var $item = $(this);
                            if (statusFilter && $item.data('status') !== statusFilter) {
                                $item.addClass('filtered-out');
                            } else {
                                $item.removeClass('filtered-out');
                            }
                        });
                    }
                }

                function escapeHtml(text) {
                    if (!text) return '';
                    var div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                function toastSuccess(msg) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: msg,
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }
                }

                function toastError(msg) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'error',
                            title: msg,
                            showConfirmButton: false,
                            timer: 3000
                        });
                    }
                }

                function updateContextText() {
                    var contextText = currentVariantId ?
                        'Variante: <strong>' + ($('#variantName').text() || 'Seleccionada') + '</strong>' :
                        'Diseño: <strong>' + ($('#modalDesignTitle').text() || 'Principal') + '</strong>';
                    $('#productionContext').html(contextText);
                }

                function hideAllStates() {
                    $('#productionLoading, #productionEmpty, #productionList, #productionForm').hide();
                }

                function showEmptyState() {
                    hideAllStates();
                    // En lugar de mostrar el empty state, mostramos directamente el formulario
                    showForm(null);
                    // Ocultar botón de volver ya que no hay lista a donde regresar
                    $('#btnBackToList').hide();
                    $('#productionTotalCount').text('0');
                    $('#exportsCount').text('0 archivos');
                    updateSummary({
                        borrador: 0,
                        pendiente: 0,
                        aprobado: 0,
                        archivado: 0
                    });
                }

                function renderExports(exports) {
                    var container = $('#exportsGroupsContainer');
                    var template = $('#exportItemTemplate').html();
                    container.empty();

                    exports.forEach(function(item) {
                        var statusEmoji = '🟤';
                        var statusLabel = 'Borrador';
                        if (item.status === 'pendiente') {
                            statusEmoji = '🟡';
                            statusLabel = 'Pendiente';
                        } else if (item.status === 'aprobado') {
                            statusEmoji = '🟢';
                            statusLabel = 'Aprobado';
                        } else if (item.status === 'archivado') {
                            statusEmoji = '⚫';
                            statusLabel = 'Archivado';
                        }

                        var dimensions = '--';
                        if (item.width_mm && item.height_mm) {
                            dimensions = item.width_mm + '×' + item.height_mm + ' mm';
                        }

                        var previewHtml =
                            '<div class="export-item-icon"><i class="fas fa-file-code"></i></div>';
                        if (item.svg_content && item.svg_content.trim() !== '') {
                            previewHtml =
                                '<div class="export-preview-box">' +
                                item.svg_content + '</div>';
                        }

                        var html = template
                            .replace(/{id}/g, item.id)
                            .replace(/{preview_html}/g, previewHtml)
                            .replace(/{application_label}/g, escapeHtml(item.application_label ||
                                'Sin nombre'))
                            .replace(/{file_format}/g, item.file_format || 'N/A')
                            .replace(/{stitches_formatted}/g, item.stitches_formatted || '0')
                            .replace(/{colors_count}/g, item.colors_count || 0)
                            .replace(/{dimensions}/g, dimensions)
                            .replace(/{status}/g, item.status || 'borrador')
                            .replace(/{status_label}/g, statusLabel)
                            .replace(/{status_emoji}/g, statusEmoji)
                            .replace(/{download_url}/g, item.download_url || '#')
                            .replace(/{export_json}/g, escapeHtml(JSON.stringify(item)));
                        container.append(html);
                    });
                }

                function escapeHtml(text) {
                    if (!text) return '';
                    var div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                // Formulario
                function showForm(editData) {
                    editData = editData || null;
                    hideAllStates();

                    // Mostrar botón de volver por defecto
                    $('#btnBackToList').show();

                    if (editData) {
                        isEditMode = true;
                        currentExportId = editData.id;
                        $('#formTitle').text('Editar Exportación');
                        $('#btnSaveText').text('Actualizar');
                        $('#formMethod').val('PUT');
                        $('#exportEditId').val(editData.id);
                        $('#uploadZone').hide();

                        $('#applicationType').val(editData.application_type);
                        $('#applicationLabel').val(editData.application_label);
                        $('#placementDescription').val(editData.placement_description || '');
                        $('#exportNotes').val(editData.notes || '');
                        $('#inputStitches').val(editData.stitches_count || 0);
                        $('#inputColors').val(editData.colors_count || 0);
                        $('#inputWidth').val(editData.width_mm || 0);
                        $('#inputHeight').val(editData.height_mm || 0);

                        autoReadSuccess = editData.auto_read_success;
                        $('#technicalData, #formFields').show();
                        $('#formActions').css('display', 'flex');
                        $('#manualEntryAlert').hide();
                        $('#btnSaveExport').prop('disabled', false);
                    } else {
                        isEditMode = false;
                        currentExportId = null;
                        resetForm();
                        $('#formTitle').text('Nueva Exportación');
                        $('#btnSaveText').text('Guardar');
                        $('#formMethod').val('POST');
                        $('#uploadZone').show();
                    }

                    $('#exportDesignId').val(currentDesignId);
                    $('#exportVariantId').val(currentVariantId || '');
                    $('#productionForm').css('display', 'flex');
                }

                function hideForm() {
                    $('#productionForm').hide();
                    resetForm();
                }

                function resetForm() {
                    currentFile = null;
                    analyzedData = null;
                    currentExportId = null;
                    isEditMode = false;
                    autoReadSuccess = true;

                    $('#exportForm')[0].reset();
                    $('#uploadZone').removeClass('has-file has-error').show();
                    $('#uploadContent').show();
                    $('#uploadAnalyzing, #uploadSuccess, #uploadError').hide();
                    $('#technicalData, #colorsPreview, #formFields, #formActions, #manualEntryAlert, #formError')
                        .hide();
                    $('#btnSaveExport').prop('disabled', true);

                    $('.field-control').removeClass('has-error');
                    $('.tech-card').removeClass('has-error');
                    $('.field-error').text('');
                    $('#inputStitches, #inputColors, #inputWidth, #inputHeight').val('');

                    // Limpiar imagen vinculada
                    $('#exportImageId').val('');
                    $('#linkedImageIndicator').hide().html('');

                    // Reset SVG preview
                    hideSvgPreview();
                }

                // Análisis de archivo
                function analyzeFile(file) {
                    currentFile = file;
                    var fileName = file.name;

                    $('#uploadContent').hide();
                    $('#uploadAnalyzing').show();
                    $('#uploadSuccess, #uploadError').hide();
                    $('#formError, #manualEntryAlert').hide();
                    $('#uploadZone').removeClass('has-file has-error');

                    var formData = new FormData();
                    formData.append('file', file);
                    formData.append('_token', csrfToken);

                    $.ajax({
                        url: urls.analyze,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            $('#uploadAnalyzing').hide();
                            if (response.success) {
                                analyzedData = response.data;
                                autoReadSuccess = true;
                                showAnalysisSuccess(response.data, fileName);
                            } else {
                                autoReadSuccess = false;
                                showAnalysisError(fileName, response.error);
                            }
                        },
                        error: function(xhr) {
                            $('#uploadAnalyzing').hide();
                            autoReadSuccess = false;
                            var error = (xhr.responseJSON && xhr.responseJSON.error) ? xhr
                                .responseJSON.error : 'Error al analizar';
                            showAnalysisError(fileName, error);
                        }
                    });
                }

                function showAnalysisSuccess(data, fileName) {
                    $('#uploadFileName').text(fileName);
                    $('#uploadSuccess').show();
                    $('#uploadZone').addClass('has-file');
                    $('#hiddenAutoRead').val('1');

                    $('#inputStitches').val(data.stitches_count || 0);
                    $('#inputColors').val(data.colors_count || 0);
                    $('#inputWidth').val(data.width_mm || 0);
                    $('#inputHeight').val(data.height_mm || 0);

                    if (data.colors && data.colors.length > 0) {
                        $('#hiddenColorsDetected').val(JSON.stringify(data.colors));
                        renderColorSwatches(data.colors);
                        $('#colorsPreview').show();
                    }

                    // Display SVG preview if available
                    if (data.svg_content && data.svg_content.trim()) {
                        showSvgPreview(data.svg_content);
                    } else {
                        hideSvgPreview();
                    }

                    $('#technicalData, #formFields').show();
                    $('#formActions').css('display', 'flex');
                    $('#btnSaveExport').prop('disabled', false);
                }

                function showAnalysisError(fileName, errorMsg) {
                    $('#uploadErrorFileName').text(fileName);
                    $('#uploadError').show();
                    $('#uploadZone').addClass('has-error');
                    $('#manualEntryAlert').show();
                    $('#hiddenAutoRead').val('0');

                    $('#inputStitches, #inputColors, #inputWidth, #inputHeight').val('');

                    // Hide SVG preview on error
                    hideSvgPreview();

                    $('.tech-card').addClass('has-error');
                    $('#technicalData, #formFields').show();
                    $('#formActions').css('display', 'flex');
                    $('#btnSaveExport').prop('disabled', false);
                }

                function renderColorSwatches(colors) {
                    var container = $('#colorSwatches');
                    container.empty();

                    colors.forEach(function(color) {
                        var hex = color.hex || '#ccc';
                        var swatch = $('<div class="color-swatch">' +
                            '<div class="color-swatch-box" style="background-color: ' + hex +
                            '"></div>' +
                            '<span class="color-swatch-label">' + hex.toUpperCase() +
                            '</span>' +
                            '</div>');
                        container.append(swatch);
                    });
                }

                // ============================================
                // SVG PREVIEW & MODAL FUNCTIONS
                // ============================================
                var currentSvgContent = null;
                var svgZoomLevel = 1;
                var svgPanX = 0;
                var svgPanY = 0;
                var isDraggingSvg = false;
                var lastSvgMouseX = 0;
                var lastSvgMouseY = 0;

                // Mostrar thumbnail de vista previa
                function showSvgPreview(svgContent) {
                    if (!svgContent || !svgContent.trim()) {
                        hideSvgPreview();
                        return;
                    }

                    currentSvgContent = svgContent;

                    // Insertar en thumbnail
                    var $thumbnail = $('#svgThumbnailContainer');
                    $thumbnail.html(svgContent);

                    // Ajustar SVG en thumbnail
                    var $svg = $thumbnail.find('svg');
                    if ($svg.length) {
                        $svg.css({
                            'max-width': '95%',
                            'max-height': '95%',
                            'width': 'auto',
                            'height': 'auto'
                        });
                    }

                    // Mostrar sección
                    $('#svgPreviewSection').show();
                }

                // Ocultar preview
                function hideSvgPreview() {
                    currentSvgContent = null;
                    $('#svgPreviewSection').hide();
                    $('#svgThumbnailContainer').html('');
                    closeSvgModal();
                }

                // Abrir modal con SVG
                function openSvgModal() {
                    if (!currentSvgContent) return;

                    // Mover modal al body si no está
                    var $modal = $('#svgModalOverlay');
                    if (!$modal.data('moved-to-body')) {
                        $modal.appendTo('body');
                        $modal.data('moved-to-body', true);
                    }

                    // Insertar SVG en modal
                    var $canvas = $('#svgModalCanvas');
                    $canvas.html(currentSvgContent);

                    // Ajustar SVG
                    var $svg = $canvas.find('svg');
                    if ($svg.length) {
                        $svg.css({
                            'max-width': '100%',
                            'max-height': '100%',
                            'width': '100%',
                            'height': '100%'
                        });
                        // Asegurar centrado inicial con transform limpio
                        $svg.css('transform', 'translate(0, 0) scale(1)');
                    }

                    // Reset zoom y pan
                    svgZoomLevel = 1;
                    svgPanX = 0;
                    svgPanY = 0;
                    updateModalSvgTransform();

                    // Mostrar modal
                    $modal.fadeIn(200);
                    $('body').css('overflow', 'hidden');

                    // Setup eventos de pan
                    setupModalPanEvents();
                }

                // Cerrar modal
                function closeSvgModal() {
                    $('#svgModalOverlay').fadeOut(200);
                    $('body').css('overflow', '');
                    $('#svgModalCanvas').html('');
                    svgZoomLevel = 1;
                    svgPanX = 0;
                    svgPanY = 0;
                }

                // Actualizar transform del SVG en modal
                function updateModalSvgTransform() {
                    var $svg = $('#svgModalCanvas svg');
                    if ($svg.length) {
                        $svg.css('transform', 'translate(' + svgPanX + 'px, ' + svgPanY + 'px) scale(' +
                            svgZoomLevel + ')');
                    }
                    $('#svgZoomLabel').text(Math.round(svgZoomLevel * 100) + '%');
                }

                // Zoom functions
                function modalZoomIn() {
                    svgZoomLevel = Math.min(svgZoomLevel + 0.25, 5);
                    updateModalSvgTransform();
                }

                function modalZoomOut() {
                    svgZoomLevel = Math.max(svgZoomLevel - 0.25, 0.25);
                    updateModalSvgTransform();
                }

                function modalZoomReset() {
                    svgZoomLevel = 1;
                    svgPanX = 0;
                    svgPanY = 0;
                    updateModalSvgTransform();
                }

                // Descargar SVG
                function downloadSvg() {
                    if (!currentSvgContent) return;

                    var blob = new Blob([currentSvgContent], {
                        type: 'image/svg+xml'
                    });
                    var url = URL.createObjectURL(blob);
                    var fileName = (analyzedData && analyzedData.file_name) ?
                        analyzedData.file_name.replace(/\.[^/.]+$/, '') + '.svg' :
                        'embroidery-preview.svg';

                    var link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }

                // Setup eventos de pan en modal
                function setupModalPanEvents() {
                    var canvas = document.getElementById('svgModalCanvas');
                    if (!canvas) return;

                    canvas.onmousedown = function(e) {
                        if (e.button === 0) {
                            isDraggingSvg = true;
                            lastSvgMouseX = e.clientX;
                            lastSvgMouseY = e.clientY;
                            canvas.style.cursor = 'grabbing';
                        }
                    };

                    canvas.onmousemove = function(e) {
                        if (isDraggingSvg) {
                            svgPanX += e.clientX - lastSvgMouseX;
                            svgPanY += e.clientY - lastSvgMouseY;
                            lastSvgMouseX = e.clientX;
                            lastSvgMouseY = e.clientY;
                            updateModalSvgTransform();
                        }
                    };

                    canvas.onmouseup = function() {
                        isDraggingSvg = false;
                        canvas.style.cursor = 'grab';
                    };

                    canvas.onmouseleave = function() {
                        isDraggingSvg = false;
                        canvas.style.cursor = 'grab';
                    };

                    canvas.onwheel = function(e) {
                        e.preventDefault();
                        if (e.deltaY < 0) {
                            modalZoomIn();
                        } else {
                            modalZoomOut();
                        }
                    };
                }

                // Event Bindings para SVG
                $(document).on('click', '#svgThumbnailCard', openSvgModal);
                $(document).on('click', '#btnCloseSvgModal', closeSvgModal);
                $(document).on('click', '#svgModalOverlay', function(e) {
                    if (e.target === this) closeSvgModal();
                });
                $(document).on('click', '#btnModalZoomIn', modalZoomIn);
                $(document).on('click', '#btnModalZoomOut', modalZoomOut);
                $(document).on('click', '#btnModalZoomReset', modalZoomReset);
                $(document).on('click', '#btnModalDownload', downloadSvg);

                // ESC para cerrar modal
                $(document).on('keydown', function(e) {
                    if (e.key === 'Escape' && $('#svgModalOverlay').is(':visible')) {
                        closeSvgModal();
                    }
                });

                // Validación
                function validateForm() {
                    var isValid = true;

                    $('.field-control').removeClass('has-error');
                    $('.field-error').text('');

                    if (!$('#applicationType').val()) {
                        $('#applicationType').addClass('has-error');
                        $('#errorApplicationType').text('Selecciona un tipo');
                        isValid = false;
                    }

                    var label = $('#applicationLabel').val().trim();
                    if (!label) {
                        $('#applicationLabel').addClass('has-error');
                        $('#errorApplicationLabel').text('Ingresa un nombre');
                        isValid = false;
                    } else if (label.length < 2) {
                        $('#applicationLabel').addClass('has-error');
                        $('#errorApplicationLabel').text('Mínimo 2 caracteres');
                        isValid = false;
                    }

                    if (!autoReadSuccess) {
                        var stitches = parseInt($('#inputStitches').val()) || 0;
                        if (stitches <= 0) {
                            $('#techCardStitches').addClass('has-error');
                            isValid = false;
                        }
                    }

                    return isValid;
                }

                // Guardar
                function saveExport() {
                    if (!validateForm()) return;

                    if (!isEditMode && !currentFile) {
                        showErrorAlert('Archivo requerido', 'Selecciona un archivo primero');
                        return;
                    }

                    var $btn = $('#btnSaveExport');
                    $btn.prop('disabled', true).find('span').text('Guardando...');
                    $('#formError').hide();

                    var formData = new FormData();
                    formData.append('_token', csrfToken);

                    if (isEditMode) {
                        formData.append('_method', 'PUT');
                    } else {
                        formData.append('file', currentFile);
                        formData.append('design_id', currentDesignId);
                        formData.append('design_variant_id', currentVariantId || '');
                        // Incluir image_id si está vinculado a una imagen específica
                        var imageId = $('#exportImageId').val();
                        if (imageId) {
                            formData.append('image_id', imageId);
                        }
                    }

                    formData.append('application_type', $('#applicationType').val());
                    formData.append('application_label', $('#applicationLabel').val().trim());
                    formData.append('placement_description', $('#placementDescription').val().trim());
                    formData.append('notes', $('#exportNotes').val().trim());
                    formData.append('stitches_count', $('#inputStitches').val() || 0);
                    formData.append('colors_count', $('#inputColors').val() || 0);
                    formData.append('width_mm', $('#inputWidth').val() || 0);
                    formData.append('height_mm', $('#inputHeight').val() || 0);
                    formData.append('colors_detected', $('#hiddenColorsDetected').val() || '[]');
                    // ⭐ GUARDAR CONTENIDO SVG PARA PREVISUALIZACIÓN --
                    if (currentSvgContent) {
                        formData.append('svg_content', currentSvgContent);
                    }
                    formData.append('auto_read_success', autoReadSuccess ? '1' : '0');

                    var url = isEditMode ? urls.updateAjax(currentExportId) : urls.storeAjax;

                    $.ajax({
                        url: url,
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function(response) {
                            if (response.success) {
                                hideForm();
                                loadProductionData();
                                updateDesignCardCounter(isEditMode ? 'updated' : 'created');

                                // ⭐ ACTUALIZACIÓN INMEDIATA de badges y contadores (optimista)
                                if (!isEditMode) {
                                    // Incrementar contador del tab de producción y tarjeta inmediatamente
                                    if (typeof window.incrementProductionTabCounter ===
                                        'function') {
                                        window.incrementProductionTabCounter();
                                    }

                                    // Incrementar inmediatamente el badge de la imagen vinculada
                                    var linkedImageId = $('#exportImageId').val();
                                    if (linkedImageId && typeof window.incrementImageBadge ===
                                        'function') {
                                        window.incrementImageBadge(linkedImageId);
                                    }
                                    // También incrementar el badge de imagen principal si coincide
                                    if (typeof window.incrementMainImageBadgeIfMatches ===
                                        'function') {
                                        window.incrementMainImageBadgeIfMatches(linkedImageId);
                                    }
                                }

                                // Refrescar badges desde servidor (verificación en segundo plano)
                                setTimeout(function() {
                                    if (typeof refreshGalleryProductionBadges ===
                                        'function') {
                                        refreshGalleryProductionBadges();
                                    }
                                }, 500);
                                showSuccessAlert(isEditMode ? '¡Actualizado!' : '¡Guardado!',
                                    isEditMode ?
                                    'La exportación se actualizó correctamente' :
                                    'La exportación se creó correctamente');
                            } else {
                                $btn.prop('disabled', false).find('span').text(isEditMode ?
                                    'Actualizar' : 'Guardar');
                                showErrorAlert('Error', response.error || 'Error al guardar');
                            }
                        },
                        error: function(xhr) {
                            $btn.prop('disabled', false).find('span').text(isEditMode ?
                                'Actualizar' : 'Guardar');
                            var errorMsg = 'Error de conexión';
                            if (xhr.status === 404) {
                                errorMsg =
                                    'Ruta no encontrada (404). Verifica que las rutas estén registradas en web.php';
                            } else if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMsg = xhr.responseJSON.error;
                            }
                            showErrorAlert('Error', errorMsg);
                        }
                    });
                }

                // Alertas
                function showSuccessAlert(title, text) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'success',
                            title: title,
                            text: text,
                            timer: 2500,
                            showConfirmButton: false,
                            // Fix z-index to appear above Bootstrap modal
                            customClass: {
                                container: 'swal2-container-high-zindex'
                            }
                        });
                    }
                }

                function showErrorAlert(title, text) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            icon: 'error',
                            title: title,
                            text: text,
                            confirmButtonText: 'Entendido',
                            confirmButtonColor: '#2563eb',
                            // Fix z-index to appear above Bootstrap modal
                            customClass: {
                                container: 'swal2-container-high-zindex'
                            }
                        });
                    } else {
                        alert(title + '\n' + text);
                    }
                }

                // Modal de detalles
                function showDetailModal(exportData) {
                    currentExportId = exportData.id;

                    $('#detailFileName').text(exportData.file_name);
                    $('#detailFileFormat').text(exportData.file_format);
                    $('#detailFileSize').text(exportData.file_size_formatted || '');

                    // Preview Icon Logic
                    var $iconContainer = $('#detailFileIcon');
                    if (exportData.svg_content && exportData.svg_content.trim() !== '') {
                        $iconContainer.html(exportData.svg_content);
                        $iconContainer.find('svg').css({
                            'width': '100%',
                            'height': '100%'
                        });
                        $iconContainer.css({
                            'padding': '0',
                            'overflow': 'hidden',
                            'background-color': 'transparent'
                        });
                        // Force override with style attribute in case CSS specificity fights back
                        $iconContainer.attr('style', $iconContainer.attr('style') +
                            '; background-color: transparent !important;');
                    } else {
                        // Restore default icon
                        $iconContainer.html('<i class="fas fa-file-code"></i>');
                        $iconContainer.removeAttr('style'); // Remove inline styles
                    }


                    // Status - SIN duplicar emoji
                    var statusBadge = $('#detailStatusBadge');
                    statusBadge.removeClass(
                        'status-borrador status-pendiente status-aprobado status-archivado');
                    statusBadge.addClass('status-' + exportData.status);

                    var statusEmoji = '🟤';
                    var statusLabel = 'Borrador';
                    if (exportData.status === 'pendiente') {
                        statusEmoji = '🟡';
                        statusLabel = 'Pendiente';
                    } else if (exportData.status === 'aprobado') {
                        statusEmoji = '🟢';
                        statusLabel = 'Aprobado';
                    } else if (exportData.status === 'archivado') {
                        statusEmoji = '⚫';
                        statusLabel = 'Archivado';
                    }

                    $('#detailStatusEmoji').text(statusEmoji);
                    $('#detailStatusText').text(statusLabel);

                    // Botones según estado
                    $('#btnSendToReview, #btnDetailApprove, #btnDetailReject, #btnDetailArchive, #btnDetailRestore')
                        .hide();

                    switch (exportData.status) {
                        case 'borrador':
                            $('#btnSendToReview').show();
                            break;
                        case 'pendiente':
                            $('#btnDetailApprove, #btnDetailReject').show();
                            break;
                        case 'aprobado':
                            $('#btnDetailArchive').show();
                            break;
                        case 'archivado':
                            $('#btnDetailRestore').show();
                            break;
                    }

                    updateWorkflowIndicator(exportData.status);

                    // Datos técnicos
                    $('#detailStitches').text(exportData.stitches_formatted || '0');
                    $('#detailColors').text(exportData.colors_count || '0');
                    $('#detailWidth').text(exportData.width_mm || '0');
                    $('#detailHeight').text(exportData.height_mm || '0');

                    // Colores
                    if (exportData.colors_detected && exportData.colors_detected.length > 0) {
                        renderDetailColors(exportData.colors_detected);
                        $('#detailColorsSection').show();
                    } else {
                        $('#detailColorsSection').hide();
                    }

                    // Info
                    $('#detailAppType').text(exportData.application_type_label || exportData
                        .application_type);
                    $('#detailAppLabel').text(exportData.application_label);

                    if (exportData.placement_description) {
                        $('#detailPlacement').text(exportData.placement_description);
                        $('#detailPlacementRow').show();
                    } else {
                        $('#detailPlacementRow').hide();
                    }

                    if (exportData.notes) {
                        $('#detailNotes').text(exportData.notes);
                        $('#detailNotesRow').show();
                    } else {
                        $('#detailNotesRow').hide();
                    }

                    // Meta
                    // Swap: Label as title, filename as meta
                    $('#detailFileName').text(exportData.application_label || '-');
                    $('#detailFileFormat').text(exportData.file_format || '');

                    // Show filename in meta: Filename • Size • Format
                    var metaParts = [];
                    if (exportData.file_name) metaParts.push(exportData.file_name);
                    if (exportData.file_size_formatted) metaParts.push(exportData.file_size_formatted);

                    if (exportData.file_format) {
                        // User requested to remove distinct format: just Filename and Size
                        // metaParts.push(exportData.file_format); 
                    }

                    $('#detailFileSize').text(metaParts.join(' • '));
                    // Hide duplicate format tag since it's in text now, or keep it. User wants "Title"
                    $('#detailFileFormat').hide();

                    $('#detailCreator').text(exportData.creator_name || 'Sistema');
                    $('#detailDate').text(exportData.created_at || '-');

                    if (exportData.approver_name) {
                        $('#detailApprover').text(exportData.approver_name);
                        $('#detailApproverRow').show();
                    } else {
                        $('#detailApproverRow').hide();
                    }

                    $('#btnDetailDownload').attr('href', exportData.download_url || '#');
                    exportsData[exportData.id] = exportData;

                    // Mover overlay al body para que cubra toda la pantalla (escapar del modal padre)
                    var $overlay = $('#exportDetailOverlay');
                    if (!$overlay.data('moved-to-body')) {
                        $overlay.appendTo('body');
                        $overlay.data('moved-to-body', true);
                    }
                    $overlay.fadeIn(200);
                }

                function updateWorkflowIndicator(currentStatus) {
                    var $indicator = $('#workflowIndicator');
                    var steps = ['borrador', 'pendiente', 'aprobado', 'archivado'];
                    var currentIndex = steps.indexOf(currentStatus);

                    $indicator.find('.workflow-step').removeClass('completed current');
                    $indicator.find('.workflow-line').removeClass('completed');

                    steps.forEach(function(step, index) {
                        var $step = $indicator.find('.workflow-step[data-step="' + step + '"]');
                        var $line = $step.next('.workflow-line');

                        if (index < currentIndex) {
                            $step.addClass('completed');
                            if ($line.length) $line.addClass('completed');
                        } else if (index === currentIndex) {
                            $step.addClass('current');
                        }
                    });
                }

                function hideDetailModal() {
                    $('#exportDetailOverlay').fadeOut(200);
                    currentExportId = null;
                }

                function renderDetailColors(colors) {
                    var container = $('#detailColorSwatches');
                    container.empty();
                    colors.forEach(function(color) {
                        var hex = color.hex || '#ccc';
                        var swatch = $('<div class="color-swatch">' +
                            '<div class="color-swatch-box" style="background-color: ' + hex +
                            '"></div>' +
                            '<span class="color-swatch-label">' + hex.toUpperCase() +
                            '</span>' +
                            '</div>');
                        container.append(swatch);
                    });
                }

                // Cambio de estado con confirmación
                function confirmStatusChange(exportId, newStatus, options) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            title: options.title,
                            text: options.text,
                            icon: options.icon,
                            showCancelButton: true,
                            reverseButtons: true, // Cancel left, Confirm right
                            confirmButtonColor: options.confirmColor || '#2563eb',
                            cancelButtonColor: '#6b7280',
                            confirmButtonText: options.confirmText,
                            cancelButtonText: 'Cancelar',
                            // Fix z-index to appear above Bootstrap modal
                            customClass: {
                                container: 'swal2-container-high-zindex'
                            }
                        }).then(function(result) {
                            if (result.isConfirmed) {
                                changeStatusWithFeedback(exportId, newStatus, options);
                            }
                        });
                    } else {
                        if (confirm(options.title)) {
                            changeStatusWithFeedback(exportId, newStatus, options);
                        }
                    }
                }

                function changeStatusWithFeedback(exportId, newStatus, options) {
                    $('.footer-actions-status button').prop('disabled', true);

                    $.ajax({
                        url: urls.updateStatus(exportId),
                        type: 'POST',
                        data: {
                            _token: csrfToken,
                            status: newStatus
                        },
                        success: function(response) {
                            if (response.success) {
                                hideDetailModal();
                                loadProductionData();
                                showSuccessAlert(options.successTitle, options.successText);
                            } else {
                                showErrorAlert('Error', response.error ||
                                    'No se pudo cambiar el estado');
                            }
                        },
                        error: function(xhr) {
                            var error = 'Error de conexión';
                            if (xhr.status === 404) {
                                error = 'Ruta no encontrada. Verifica web.php';
                            }
                            showErrorAlert('Error', error);
                        },
                        complete: function() {
                            $('.footer-actions-status button').prop('disabled', false);
                        }
                    });
                }

                // Eliminar
                function deleteExport(id) {
                    if (typeof Swal !== 'undefined') {
                        Swal.fire({
                            title: '¿Eliminar exportación?',
                            text: 'Esta acción no se puede deshacer',
                            icon: 'warning',
                            showCancelButton: true,
                            reverseButtons: true, // Cancel left, Confirm right
                            confirmButtonColor: '#ef4444',
                            cancelButtonColor: '#6b7280',
                            confirmButtonText: 'Sí, eliminar',
                            cancelButtonText: 'Cancelar',
                            // Fix z-index to appear above Bootstrap modal
                            customClass: {
                                container: 'swal2-container-high-zindex'
                            }
                        }).then(function(result) {
                            if (result.isConfirmed) {
                                performDelete(id);
                            }
                        });
                    } else if (confirm('¿Eliminar esta exportación?')) {
                        performDelete(id);
                    }
                }

                function performDelete(id) {
                    $.ajax({
                        url: urls.destroyAjax(id),
                        type: 'DELETE',
                        data: {
                            _token: csrfToken
                        },
                        success: function(response) {
                            if (response.success) {
                                hideDetailModal();
                                loadProductionData();
                                updateDesignCardCounter('deleted');
                                showSuccessAlert('¡Eliminado!',
                                    'La exportación se eliminó correctamente');
                            } else {
                                showErrorAlert('Error', response.error || 'Error al eliminar');
                            }
                        },
                        error: function(xhr) {
                            var error = xhr.status === 404 ? 'Ruta no encontrada' :
                                'Error de conexión';
                            showErrorAlert('Error', error);
                        }
                    });
                }

                // Actualizar contador
                function updateDesignCardCounter(action) {
                    var designId = currentDesignId;
                    $(document).trigger('export' + action.charAt(0).toUpperCase() + action.slice(1), {
                        designId: designId
                    });

                    $.get(urls.exportsCount(designId))
                        .done(function(response) {
                            if (response.success && response.count !== undefined) {
                                var count = response.count;
                                var $card = $('.design-card[data-design-id="' + designId + '"]');
                                if ($card.length) {
                                    $card.attr('data-exports', count);
                                    var $exports = $card.find('.design-exports');
                                    if ($exports.length) {
                                        $exports.find('.exports-number').text(count);
                                        $exports.find('.exports-text').text(count !== 1 ?
                                            'exportaciones' : 'exportación');
                                    }
                                }
                                $('#productionTotalCount').text(count);
                            }
                        });
                }

                // Event Listeners
                $(document).on('click', '#btnAddFirstExport, #btnAddExport', function(e) {
                    e.preventDefault();
                    showForm();
                });

                $(document).on('click', '#btnBackToList, #btnCancelExport', function(e) {
                    e.preventDefault();
                    hideForm();
                    loadProductionData();
                });

                $('#exportFile').on('change', function(e) {
                    var file = e.target.files[0];
                    if (file) analyzeFile(file);
                });

                var uploadZone = document.getElementById('uploadZone');
                if (uploadZone) {
                    uploadZone.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        this.classList.add('drag-over');
                    });
                    uploadZone.addEventListener('dragleave', function(e) {
                        e.preventDefault();
                        this.classList.remove('drag-over');
                    });
                    uploadZone.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.classList.remove('drag-over');
                        var file = e.dataTransfer.files[0];
                        if (file) {
                            $('#exportFile')[0].files = e.dataTransfer.files;
                            analyzeFile(file);
                        }
                    });
                }

                // ⭐ Botón de agregar nueva producción (desde la lista)
                $(document).on('click', '#btnAddNewExport', function(e) {
                    e.preventDefault();
                    showForm(null);
                });

                $(document).on('click', '#btnRemoveFile, #btnRemoveFileError', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    resetForm();
                });

                $('#btnSaveExport').on('click', function(e) {
                    e.preventDefault();
                    saveExport();
                });

                // ⭐ V5: Event handlers para filtros (solo variante, estado por badges)
                $('#filterVariant').on('change', function() {
                    currentFilter.variant = $(this).val();
                    applyFilters();
                });

                $('#btnClearFilters').on('click', function() {
                    currentFilter = {
                        status: '',
                        variant: ''
                    };
                    $('#filterVariant').val('');
                    $('.summary-badge').removeClass('active');
                    $('.summary-badge[data-filter=""]').addClass('active');
                    applyFilters();
                });

                $(document).on('click', '.summary-badge', function() {
                    var filter = $(this).data('filter');
                    currentFilter.status = filter;
                    applyFilters();
                });

                $(document).on('click', '.export-item-content, .btn-view-export', function(e) {
                    e.preventDefault();
                    var id = $(this).closest('.export-item').data('id') || $(this).data('id');
                    var exportData = exportsData[id];
                    if (exportData) showDetailModal(exportData);
                });

                $(document).on('click', '#btnCloseDetailOverlay', function() {
                    hideDetailModal();
                });

                $(document).on('click', '#exportDetailOverlay', function(e) {
                    if (e.target === this) hideDetailModal();
                });

                $(document).on('click', '#btnDetailEdit', function() {
                    var exportData = exportsData[currentExportId];
                    if (exportData) {
                        hideDetailModal();
                        showForm(exportData);
                    }
                });

                // Botones de estado
                $(document).on('click', '#btnSendToReview', function() {
                    if (currentExportId) {
                        confirmStatusChange(currentExportId, 'pendiente', {
                            title: '¿Enviar a revisión?',
                            text: 'El archivo quedará pendiente de aprobación.',
                            icon: 'question',
                            confirmColor: '#f59e0b',
                            confirmText: 'Sí, enviar',
                            successTitle: '¡Enviado!',
                            successText: 'El archivo está pendiente de aprobación.'
                        });
                    }
                });

                $(document).on('click', '#btnDetailApprove', function() {
                    if (currentExportId) {
                        confirmStatusChange(currentExportId, 'aprobado', {
                            title: '¿Aprobar archivo?',
                            text: 'El archivo quedará listo para producción.',
                            icon: 'success',
                            confirmColor: '#10b981',
                            confirmText: 'Sí, aprobar',
                            successTitle: '¡Aprobado!',
                            successText: 'El archivo está listo para producción.'
                        });
                    }
                });

                $(document).on('click', '#btnDetailReject', function() {
                    if (currentExportId) {
                        confirmStatusChange(currentExportId, 'borrador', {
                            title: '¿Rechazar archivo?',
                            text: 'El archivo volverá a estado borrador.',
                            icon: 'warning',
                            confirmColor: '#ef4444',
                            confirmText: 'Sí, rechazar',
                            successTitle: 'Rechazado',
                            successText: 'El archivo volvió a borrador.'
                        });
                    }
                });

                $(document).on('click', '#btnDetailArchive', function() {
                    if (currentExportId) {
                        confirmStatusChange(currentExportId, 'archivado', {
                            title: '¿Archivar archivo?',
                            text: 'El archivo se moverá al histórico.',
                            icon: 'info',
                            confirmColor: '#374151',
                            confirmText: 'Sí, archivar',
                            successTitle: 'Archivado',
                            successText: 'El archivo se movió al histórico.'
                        });
                    }
                });

                $(document).on('click', '#btnDetailRestore', function() {
                    if (currentExportId) {
                        confirmStatusChange(currentExportId, 'aprobado', {
                            title: '¿Restaurar archivo?',
                            text: 'El archivo volverá a estado aprobado.',
                            icon: 'question',
                            confirmColor: '#06b6d4',
                            confirmText: 'Sí, restaurar',
                            successTitle: '¡Restaurado!',
                            successText: 'El archivo está activo nuevamente.'
                        });
                    }
                });

                $(document).on('click', '.btn-delete-export', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    deleteExport($(this).data('id'));
                });

                $(document).on('click', '#production-tab', function() {
                    // Solo cargar datos si no hay petición de ir directo al formulario
                    if (!skipLoadAndShowForm) {
                        setTimeout(loadProductionData, 100);
                    }
                });

                $('a[data-toggle="tab"]').on('shown.bs.tab', function(e) {
                    if (e.target.id === 'production-tab') {
                        // Verificar si debemos ir directo al formulario
                        if (skipLoadAndShowForm) {
                            skipLoadAndShowForm = false; // Resetear bandera
                            showFormDirect();
                        } else {
                            loadProductionData();
                        }
                    }
                });

                $(document).on('keydown', function(e) {
                    if (e.key === 'Escape' && $('#exportDetailOverlay').is(':visible')) {
                        hideDetailModal();
                    }
                });
            });
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initProductionTab);
        } else {
            initProductionTab();
        }
    })();
</script>
</file>

<file path="resources/views/admin/produccion/index.blade.php">
@extends('adminlte::page')

@section('title', 'PRODUCCIONES')

@section('content_header')
@stop

@section('content')
    <div class="container-fluid py-4">


        {{-- Card Unificada: Filtros + Tabla --}}
        <div class="card card-primary" bis_skin_checked="1">
            <div class="card-header d-flex flex-column align-items-start" bis_skin_checked="1">
                <h3 class="card-title mb-1" style="font-weight: bold; font-size: 20px;">
                    <i class="fas fa-industry text-white mr-2"></i>Gestion de Producciones
                </h3>
            </div>

            <div class="card-body ">
                {{-- Filtros --}}
                <div class="row align-items-end mb-3">
                    {{-- ACCIONES --}}
                    <div class="col-12">
                        <a href="{{ route('admin.designs.index') }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nueva Producción
                        </a>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"
                            style="font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase;">Jerarquía</label>
                        <select class="form-control" id="filtroJerarquia">
                            <option value="">Todos los niveles</option>
                            <option value="diseño">Solo Diseños</option>
                            <option value="variante">Solo Variantes</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label"
                            style="font-weight: 600; font-size: 12px; color: #6b7280; text-transform: uppercase;">Estado
                            Actual</label>
                        <select class="form-control" id="filtroEstado">
                            <option value="">Ver todos los estados</option>
                            <option value="borrador">Borrador</option>
                            <option value="pendiente">Pendiente</option>
                            <option value="aprobado">Aprobado</option>
                            <option value="archivado">Archivado</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button class="btn btn-primary" id="limpiarFiltros">
                            <i class="fas fa-times-circle mr-1"></i>Limpiar
                        </button>
                    </div>
                </div>

                {{-- Tabla --}}
                <div class="table-responsive">
                    <table id="tablaProducciones" class="table table-bordered table-hover ">
                        <thead class="thead-dark text-center">
                            <tr>
                                <th style="font-size: 13px; text-transform: uppercase;">Orden</th>
                                <th style="font-size: 13px; text-transform: uppercase;">Diseño / Linaje</th>
                                <th style="font-size: 13px; text-transform: uppercase;">Vista</th>
                                <th style="font-size: 13px; text-transform: uppercase;">Especificaciones</th>
                                <th style="font-size: 13px; text-transform: uppercase;">Estado</th>
                                <th style="font-size: 13px; text-transform: uppercase;">Última Actividad</th>
                                <th style="font-size: 13px; text-transform: uppercase;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @forelse ($exportaciones as $export)
                                <tr style="border-bottom: 1px solid #f3f4f6;">
                                    {{-- Orden --}}
                                    <td style="padding: 16px; vertical-align: middle;">
                                        <a href="#" class="orden-link"
                                            style="font-weight: 700; color: #2563eb; text-decoration: none;">
                                            #PRD-{{ str_pad($export->id, 3, '0', STR_PAD_LEFT) }}
                                        </a>
                                    </td>

                                    {{-- Diseño / Linaje --}}
                                    <td style="padding: 16px; vertical-align: middle;">
                                        @if ($export->variant)
                                            <span class="badge"
                                                style="background: #f3e8ff; color: #6b21a8; font-size: 13px; padding: 5px 10px; border-radius: 6px; font-weight: 700; margin-bottom: 6px; display: inline-block;">
                                                VARIANTE
                                            </span>
                                            <div style="font-weight: 700; color: #111827; font-size: 17px;">
                                                {{ $export->variant->name }}
                                            </div>
                                            <div style="font-size: 14px; color: #6b7280; font-weight: 500;">
                                                Padre: {{ $export->design->name ?? 'N/A' }}
                                            </div>
                                        @else
                                            <span class="badge"
                                                style="background: #dbeafe; color: #1e40af; font-size: 13px; padding: 5px 10px; border-radius: 6px; font-weight: 700; margin-bottom: 6px; display: inline-block;">
                                                DISEÑO
                                            </span>
                                            <div style="font-weight: 700; color: #111827; font-size: 17px;">
                                                {{ $export->design->name ?? 'Sin diseño' }}
                                            </div>
                                        @endif
                                    </td>

                                    {{-- Vista Previa --}}
                                    <td style="padding: 16px; vertical-align: middle; text-align: center;">
                                        <div class="preview-wrapper"
                                            style="position: relative; display: inline-block; width: 60px; height: 60px;">
                                            {{-- Skeleton Placeholder --}}
                                            <div class="skeleton-loader"
                                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; background: #f3f4f6;">
                                            </div>

                                            <img data-src="{{ route('admin.production.preview', $export->id) }}"
                                                alt="Preview" class="embroidery-thumbnail lazy-preview"
                                                data-id="{{ $export->id }}"
                                                data-name="{{ $export->variant->name ?? ($export->design->name ?? 'Diseño') }}"
                                                style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px; background: #f9fafb; padding: 4px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); opacity: 0;">
                                        </div>
                                    </td>

                                    {{-- Especificaciones --}}
                                    <td style="padding: 16px; vertical-align: middle;">
                                        <div class="specs-wrapper btn-view-details"
                                            data-url="{{ route('admin.production.show', $export->id) }}?type=specs"
                                            style="font-size: 14px; line-height: 1.6;">
                                            <span class="d-block text-dark"><strong>Puntadas:</strong>
                                                {{ number_format($export->stitches_count) }}</span>
                                            <span class="d-block text-dark"><strong>Colores:</strong>
                                                {{ $export->colors_count ?? 0 }}</span>
                                            <span class="d-block text-muted"><strong>Tamaño:</strong>
                                                {{ $export->width_mm ?? 0 }}x{{ $export->height_mm ?? 0 }}mm</span>
                                        </div>
                                    </td>

                                    {{-- Estado --}}
                                    <td style="padding: 16px; vertical-align: middle;">
                                        @php
                                            $statusColors = [
                                                'borrador' => ['bg' => '#f3f4f6', 'color' => '#4b5563'],
                                                'pendiente' => ['bg' => '#fef3c7', 'color' => '#92400e'],
                                                'aprobado' => ['bg' => '#d1fae5', 'color' => '#065f46'],
                                                'archivado' => ['bg' => '#e5e7eb', 'color' => '#374151'],
                                            ];
                                            $status = $export->status ?? 'borrador';
                                            $colors = $statusColors[$status] ?? $statusColors['borrador'];
                                        @endphp
                                        <span class="badge"
                                            style="background: {{ $colors['bg'] }}; color: {{ $colors['color'] }}; font-size: 13px; padding: 8px 14px; border-radius: 20px; font-weight: 700; text-transform: uppercase;">
                                            {{ $export->translated_status }}
                                        </span>
                                    </td>

                                    {{-- Última Actividad --}}
                                    <td style="padding: 16px; vertical-align: middle;">
                                        <div style="font-weight: 700; color: #111827; font-size: 15px;">
                                            {{ $export->creator->name ?? 'Usuario' }}
                                        </div>
                                        <div style="font-size: 14px; color: #6b7280; font-weight: 500;">
                                            @if ($status == 'pendiente')
                                                Solicitó aprobación -
                                            @elseif($status == 'aprobado')
                                                Aprobó -
                                            @else
                                                Creó {{ $status }} -
                                            @endif
                                            {{ strtoupper($export->updated_at->translatedFormat('d M Y - H:i')) }}
                                        </div>
                                    </td>

                                    {{-- Acciones --}}
                                    <td style="padding: 12px; vertical-align: middle; text-align: center;">
                                        <div class="d-flex justify-content-center align-items-center" style="gap: 8px;">
                                            {{-- 1. Ver (siempre visible - azul) --}}
                                            <a href="javascript:void(0)" class="btn-action btn-view-details"
                                                data-url="{{ route('admin.production.show', $export->id) }}?type=details"
                                                title="Ver detalles"
                                                style="width: 32px; height: 32px; border-radius: 6px; background: #fff; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                                <i class="fas fa-eye" style="color: #2563eb; font-size: 14px;"></i>
                                            </a>

                                            {{-- 2. Editar / Revertir / Restaurar --}}
                                            @if ($status == 'borrador' || $status == 'pendiente')
                                                {{-- Borrador o Pendiente: Editar disponible --}}
                                                <a href="{{ route('admin.production.edit', $export->id) }}"
                                                    class="btn-action" title="Editar"
                                                    style="width: 32px; height: 32px; border-radius: 6px; background: #fff; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                                    <i class="fas fa-pen" style="color: #374151; font-size: 13px;"></i>
                                                </a>
                                            @elseif ($status == 'aprobado')
                                                {{-- Aprobado: Revertir a pendiente --}}
                                                <form action="{{ route('admin.production.revert', $export->id) }}"
                                                    method="POST" class="d-inline">
                                                    @csrf
                                                    <button type="submit" class="btn-action"
                                                        title="Revertir a pendiente"
                                                        style="width: 32px; height: 32px; border-radius: 6px; background: #fff; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                                        <i class="fas fa-undo"
                                                            style="color: #374151; font-size: 13px;"></i>
                                                    </button>
                                                </form>
                                            @elseif ($status == 'archivado')
                                                {{-- Archivado: Restaurar a aprobado --}}
                                                <form action="{{ route('admin.production.restore', $export->id) }}"
                                                    method="POST" class="d-inline">
                                                    @csrf
                                                    <button type="submit" class="btn-action"
                                                        title="Restaurar a aprobado"
                                                        style="width: 32px; height: 32px; border-radius: 6px; background: #fff; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: 1px solid #e5e7eb; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                                        <i class="fas fa-redo"
                                                            style="color: #374151; font-size: 13px;"></i>
                                                    </button>
                                                </form>
                                            @endif

                                            {{-- 3. Botón de estado (CÍRCULO) --}}
                                            @if ($status == 'borrador')
                                                {{-- Borrador: Solicitar aprobación --}}
                                                <form action="{{ route('admin.production.request', $export->id) }}"
                                                    method="POST" class="d-inline">
                                                    @csrf
                                                    <button type="submit" class="btn-action"
                                                        title="Solicitar aprobación"
                                                        style="width: 32px; height: 32px; border-radius: 50%; background: #f59e0b; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: none; box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);">
                                                        <i class="fas fa-paper-plane"
                                                            style="color: #fff; font-size: 13px;"></i>
                                                    </button>
                                                </form>
                                            @elseif ($status == 'pendiente')
                                                {{-- Pendiente: Aprobar --}}
                                                <form action="{{ route('admin.production.approve', $export->id) }}"
                                                    method="POST" class="d-inline">
                                                    @csrf
                                                    <button type="submit" class="btn-action" title="Aprobar"
                                                        style="width: 32px; height: 32px; border-radius: 50%; background: #10b981; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: none; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);">
                                                        <i class="fas fa-check"
                                                            style="color: #ffffff; font-size: 14px;"></i>
                                                    </button>
                                                </form>
                                            @elseif ($status == 'aprobado')
                                                {{-- Aprobado: Archivar --}}
                                                <form action="{{ route('admin.production.archive', $export->id) }}"
                                                    method="POST" class="d-inline">
                                                    @csrf
                                                    <button type="submit" class="btn-action" title="Archivar"
                                                        style="width: 32px; height: 32px; border-radius: 50%; background: #666c6a; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: none; box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);">
                                                        <i class="fas fa-archive"
                                                            style="color: #fff; font-size: 13px;"></i>
                                                    </button>
                                                </form>
                                            @endif

                                            {{-- 4. Eliminar --}}
                                            <form action="{{ route('admin.production.destroy', $export->id) }}"
                                                method="POST" class="d-inline form-eliminar">
                                                @csrf
                                                @method('DELETE')
                                                <button type="submit" class="btn-action" title="Eliminar"
                                                    style="width: 32px; height: 32px; border-radius: 6px; background: #fff; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; border: 1px solid #fee2e2; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
                                                    <i class="fas fa-trash-alt"
                                                        style="color: #ef4444; font-size: 14px;"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            @empty
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div style="color: #9ca3af;">
                                            <i class="fas fa-inbox fa-3x mb-3"></i>
                                            <p class="mb-0" style="font-size: 16px;">No hay producciones registradas
                                            </p>
                                            <a href="{{ route('admin.production.create') }}"
                                                class="btn btn-primary mt-3">
                                                <i class="fas fa-plus mr-1"></i>Crear primera producción
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            @endforelse
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        {{-- Modal de Zoom Avanzado --}}
        <div class="modal fade" id="zoomModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content"
                    style="border-radius: 16px; border: none; overflow: visible; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);">
                    <button type="button" class="modal-close-premium" data-dismiss="modal" aria-label="Close">
                        <i class="fas fa-times"></i>
                    </button>
                    <div class="modal-header border-0 bg-white" style="padding: 20px 24px;">
                        <h5 class="modal-title" style="font-weight: 700; color: #111827; font-size: 1.25rem;">
                            <i class="fas fa-search-plus text-success mr-2"></i><span id="zoomModalTitle">Vista de Alta
                                Precisión</span>
                        </h5>
                    </div>
                    <div class="modal-body p-0 position-relative"
                        style="background-color: #f8fafc; height: 75vh; min-height: 500px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        {{-- Technical Canvas Background --}}
                        <div
                            style="position: absolute; top:0; left:0; width:100%; height:100%; 
                             background-image: radial-gradient(#e5e7eb 1px, transparent 1px);
                             background-size: 20px 20px; opacity: 0.5; pointer-events: none;">
                        </div>

                        <div id="zoomContainer" class="zoom-container">
                            <div id="zoomWrapper" class="zoom-wrapper">
                                <img id="zoomImage" src="" class="zoom-image shadow-lg" alt="Zoomed view">
                            </div>
                        </div>

                        {{-- Controles Flotantes --}}
                        <div id="prodToolbar" class="position-absolute d-flex gap-2 p-2 bg-white rounded shadow-sm"
                            style="bottom: 20px; z-index: 10; left: 50%; transform: translateX(-50%); border: 1px solid #e2e8f0; border-radius: 8px;">
                            <button type="button" class="btn btn-sm btn-light border" id="btnZoomOut" title="Alejar"><i
                                    class="fas fa-minus text-secondary"></i></button>
                            <button type="button" class="btn btn-sm btn-light border" id="btnZoomReset"
                                title="Resetear"><i class="fas fa-compress-arrows-alt text-secondary"></i></button>
                            <button type="button" class="btn btn-sm btn-light border" id="btnZoomIn" title="Acercar"><i
                                    class="fas fa-plus text-primary"></i></button>

                            <div class="vr mx-1 bg-secondary opacity-25"></div>

                            <button type="button" class="btn btn-sm btn-light border" id="btnFullscreen"
                                title="Pantalla Completa"><i class="fas fa-expand text-dark"></i></button>
                            <a href="#" id="btnProdDownload" download class="btn btn-sm btn-primary shadow-sm"
                                title="Descargar Imagen"><i class="fas fa-download"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {{-- Modal de Detalles de Producción (AJAX) --}}
        <div class="modal fade" id="viewProductionModal" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-md modal-dialog-centered">
                <div class="modal-content" id="viewProductionModalContent"
                    style="border-radius: 12px; border: none; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); overflow: visible;">
                    {{-- El contenido se carga vía AJAX --}}
                    <div class="modal-body text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Cargando...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #tablaProducciones_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        /* Estilo personalizado para los botones de exportación */
        #tablaProducciones_wrapper .dt-buttons .btn {
            color: #fff;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        /* Botones de acción circulares - estilo premium */
        .btn-action {
            cursor: pointer;
            text-decoration: none;
        }

        .btn-action:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Colores por tipo de botón */
        .btn-danger {
            background-color: #dc2626;
            border: none;
        }

        .btn-success {
            background-color: #10b981;
            border: none;
        }

        .btn-info {
            background-color: #0284c7;
            border: none;
        }

        .btn-warning {
            background-color: #d97706;
            color: #fff;
            border: none;
        }

        .btn-default {
            background-color: #6b7280;
            color: #fff;
            border: none;
        }

        /* Tabla premium */
        #tablaProducciones {
            border-radius: 8px;
            overflow: hidden;
        }

        #tablaProducciones thead th {
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        #tablaProducciones tbody tr {
            transition: background-color 0.15s ease;
        }

        #tablaProducciones tbody tr:hover {
            background-color: #f8fafc;
        }

        /* --- Estilos de Bordado Premium (Performance Bancaria) --- */
        .preview-wrapper {
            transition: all 0.3s ease;
        }

        .embroidery-thumbnail {
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* Hover: Marco verde + levantamiento + sombra */
        .specs-wrapper:hover,
        .embroidery-thumbnail:hover {
            border-color: #10b981 !important;
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.2), 0 4px 6px -7px rgba(16, 185, 129, 0.1);
            z-index: 10;
        }

        .specs-wrapper {
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #f3f4f6;
            background: #f9fafb;
        }

        /* Skeletons Pulsantes */
        .skeleton-loader {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: skeleton-pulse 1.5s infinite;
        }

        @keyframes skeleton-pulse {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Controles de Zoom Avanzado */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(4px);
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
            font-size: 16px;
        }

        .zoom-btn:hover {
            background: #f9fafb;
            border-color: #10b981;
            color: #10b981;
        }

        .zoom-container {
            cursor: grab;
            width: 100%;
            height: 100%;
        }

        .zoom-container:active {
            cursor: grabbing;
        }

        .zoom-wrapper {
            transition: transform 0.1s ease-out;
            transform-origin: center;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .zoom-image {
            user-select: none;
            -webkit-user-drag: none;
            max-width: 90%;
            max-height: 80vh;
            filter: drop-shadow(0 10px 15px rgba(0, 0, 0, 0.1));
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .btn-action {
                width: 32px !important;
                height: 32px !important;
            }

            .btn-action i {
                font-size: 12px !important;
            }

            #tablaProducciones_wrapper .dt-buttons .btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .card-body {
                padding: 1rem;
            }
        }
    </style>
@stop

@section('js')
    <script>
        $(function() {
            var table = $("#tablaProducciones").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay información",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Producciones",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Producciones",
                    "infoFiltered": "(Filtrado de _MAX_ total Producciones)",
                    "lengthMenu": "Mostrar _MENU_ Producciones",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            });

            table.buttons().container().appendTo('#tablaProducciones_wrapper .row:eq(0)');

            // --- Performance Optimized: Lazy Loading (DataTables Compatible) ---
            const previewObserver = ('IntersectionObserver' in window) ? new IntersectionObserver((entries,
                observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.getAttribute('data-src');
                        if (src && !img.src) {
                            img.src = src;
                            img.onload = () => {
                                img.style.opacity = '1';
                                $(img).siblings('.skeleton-loader').fadeOut(300);
                            };
                        }
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '100px'
            }) : null;

            function initLazyLoading() {
                $('.lazy-preview').each(function() {
                    if (previewObserver) {
                        previewObserver.observe(this);
                    } else {
                        const src = $(this).attr('data-src');
                        if (src) {
                            $(this).attr('src', src).css('opacity', '1');
                            $(this).siblings('.skeleton-loader').hide();
                        }
                    }
                });
            }

            // Iniciar al cargar y en cada redibujado de la tabla (paginaciÃ³n, bÃºsqueda)
            initLazyLoading();
            table.on('draw', function() {
                initLazyLoading();
            });

            // --- LÃ³gica de Zoom Avanzado (Pan & Zoom) ---
            let currentScale = 1;
            let isDragging = false;
            let startX, startY, transX = 0,
                transY = 0;

            // Delegar click al wrapper para mejorar la captura del evento
            $(document).on('click', '.preview-wrapper', function() {
                const img = $(this).find('.embroidery-thumbnail');
                const src = img.attr('src') || img.attr('data-src');
                const name = img.data('name') || 'Vista Previa';

                if (src) {
                    $('#zoomImage').attr('src', src);
                    $('#zoomModalTitle').text(name);

                    // Configurar descarga directa de la imagen (High Quality source)
                    $('#btnProdDownload').attr('href', src).attr('download', name);

                    // Resetear estado
                    currentScale = 1;
                    transX = 0;
                    transY = 0;
                    updateTransform();

                    $('#zoomModal').modal('show');
                }
            });

            function updateTransform() {
                $('#zoomWrapper').css('transform', `scale(${currentScale}) translate(${transX}px, ${transY}px)`);
            }

            $('#btnZoomIn').on('click', function(e) {
                e.preventDefault();
                currentScale = Math.min(currentScale + 0.5, 5);
                updateTransform();
            });

            $('#btnZoomOut').on('click', function(e) {
                e.preventDefault();
                currentScale = Math.max(currentScale - 0.5, 0.5);
                updateTransform();
            });

            $('#btnZoomReset').on('click', function(e) {
                e.preventDefault();
                currentScale = 1;
                transX = 0;
                transY = 0;
                updateTransform();
            });

            $('#btnFullscreen').on('click', function() {
                const elem = document.querySelector('#zoomModal .modal-content');
                if (!document.fullscreenElement) {
                    elem.requestFullscreen().catch(err => {
                        console.error(
                            `Error attempting to enable full-screen mode: ${err.message}`);
                    });
                } else {
                    document.exitFullscreen();
                }
            });

            // Descarga HD para Producción (Botón "Descargar")
            $('#btnProdDownload').on('click', function(e) {
                e.preventDefault();
                const url = $(this).attr('href');
                if (!url) return;

                const btn = $(this);
                const originalHtml = btn.html();

                // 1. Obtener nombre limpio del título del modal
                let rawTitle = $('#zoomModalTitle').text().trim();
                let filename = rawTitle.replace(/[\/\\:*?"<>|]/g, '_') || 'diseno'; // Sanitize filename
                filename += '_HD.png';

                btn.html('<i class="fas fa-spinner fa-spin"></i>').prop('disabled', true);

                fetch(url)
                    .then(response => {
                        if (!response.ok) throw new Error('Network error');
                        return response.blob();
                    })
                    .then(blob => blob.text().then(text => ({
                        blob,
                        text
                    })))
                    .then(({
                        blob,
                        text
                    }) => {
                        const isSvg = text.trim().startsWith('<svg') || url.toLowerCase().includes(
                            '.svg');

                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.crossOrigin = "Anonymous";

                        // Promesa para cargar la imagen y dibujar
                        return new Promise((resolve, reject) => {
                            img.onload = () => {
                                // Configurar canvas
                                if (isSvg) {
                                    // SVG: Usar dimensiones del viewBox escaladas 4x
                                    // (El SVG se carga en img con sus dimensiones definidas, pero para el canvas queremos forzar alta resolución)
                                    // NOTA: Renderizar SVG en <img src="data:..."> a veces no escala bien si no se define width/height en el SVG string.
                                    // Una técnica mejor es definir el tamaño del canvas grande, y dibujar la imagen.

                                    // Estrategia: Detectar tamaño base, multiplicar por 4
                                    let w = img.naturalWidth || 800;
                                    let h = img.naturalHeight || 800;
                                    const scale = 4;

                                    canvas.width = w * scale;
                                    canvas.height = h * scale;

                                    // Dibujar escalado
                                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                } else {
                                    // Raster: Usar tamaño natural (no podemos inventar resolución si no existe)
                                    canvas.width = img.naturalWidth;
                                    canvas.height = img.naturalHeight;
                                    ctx.drawImage(img, 0, 0);
                                }
                                resolve(canvas.toDataURL('image/png'));
                            };
                            img.onerror = reject;

                            if (isSvg) {
                                // Para SVGs, usamos base64 content para asegurar renderizado correcto
                                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(
                                    encodeURIComponent(text)));
                            } else {
                                img.src = URL.createObjectURL(blob);
                            }
                        });
                    })
                    .then(pngUrl => {
                        // Descargar PNG
                        const a = document.createElement('a');
                        a.href = pngUrl;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        btn.html(originalHtml).prop('disabled', false);
                    })
                    .catch(err => {
                        console.error('Error generando HD:', err);
                        // Fallback: Descarga original
                        const a = document.createElement('a');
                        a.href = url;
                        // Intentar mantener nombre si es posible, sino default
                        a.download = filename.replace('_HD.png', '');
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        btn.html(originalHtml).prop('disabled', false);
                    });
            });

            // Paneo con el mouse
            $('#zoomContainer').on('mousedown', function(e) {
                if (currentScale > 1) {
                    isDragging = true;
                    startX = e.pageX - transX;
                    startY = e.pageY - transY;
                    $(this).css('cursor', 'grabbing');
                }
            });

            $(window).on('mousemove', function(e) {
                if (isDragging) {
                    transX = e.pageX - startX;
                    transY = e.pageY - startY;
                    updateTransform();
                }
            }).on('mouseup', function() {
                isDragging = false;
                $('#zoomContainer').css('cursor', currentScale > 1 ? 'grab' : 'default');
            });

            // Zoom rueda mouse
            $('#zoomContainer').on('wheel', function(e) {
                e.preventDefault();
                const delta = e.originalEvent.deltaY;
                const oldScale = currentScale;
                currentScale = delta > 0 ? Math.max(currentScale - 0.2, 0.5) : Math.min(currentScale + 0.2,
                    5);
                updateTransform();
            });

            // Resto de la lógica (detalles AJAX, filtros, etc.)
            $(document).on('click', '.btn-view-details', function(e) {
                e.preventDefault();
                const url = $(this).data('url');
                $('#viewProductionModal').modal('show');
                $('#viewProductionModalContent').html(
                    '<div class="modal-body text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>'
                );
                $.get(url, data => $('#viewProductionModalContent').html(data));
            });

            $('#filtroJerarquia').on('change', function() {
                const val = $(this).val();
                table.column(1).search(val === 'diseño' ? 'DISEÑO' : (val === 'variante' ? 'VARIANTE' : ''))
                    .draw();
            });

            $('#filtroEstado').on('change', function() {
                table.column(4).search($(this).val()).draw();
            });
            $('#limpiarFiltros').on('click', () => {
                $('#filtroJerarquia, #filtroEstado').val('');
                table.search('').columns().search('').draw();
            });

            // SweetAlert2 para eliminar producciones
            $(document).on('submit', '.form-eliminar', function(e) {
                e.preventDefault();

                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "¡Eliminarás esta producción y no se podrá recuperar!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33', // Rojo
                    cancelButtonColor: '#6c757d', // Gris (Secondary)
                    confirmButtonText: 'Sí, confirmar',
                    cancelButtonText: 'Cancelar',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.submit();
                    }
                });
            });
        });
    </script>
@stop
</file>

<file path="resources/views/admin/proveedores/index.blade.php">
@extends('adminlte::page')

@section('title', 'Proveedores')

@section('content_header')
@stop

@section('content')
    <br>
    <div class="card card-primary" bis_skin_checked="1">

        <div class="card-header" bis_skin_checked="1">

            <h3 class="card-title" style="font-weight: bold;font-size: 20px;"> PROVEEDORES</h3>
            <!-- /.card-tools -->
        </div>
        <!-- /.card-header -->
        <div class="card-body" bis_skin_checked="1">
            <div class="row">
                <a href="{{ route('admin.proveedores.create') }}" type="button" class="btn btn-primary">
                    Nuevo <i class="fas fa-plus"></i></a>
            </div>
            <hr>
            <div class="col-12">
                <div class="table-responsive">
                    <table id="example1" class="table table-bordered table-hover ">
                        <thead class="thead-dark">
                            <tr>
                                <th>#</th>
                                <th>Nombre proveedor</th>
                                <th>Giro</th>
                                <th>Telefono</th>
                                <th>Correo</th>
                                <th>Estado</th>
                                <th style="text-align: center;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>

                            @foreach ($proveedores as $proveedor)
                                <tr>
                                    <td>{{ $loop->iteration }}</td>
                                    <td>{{ $proveedor->nombre_proveedor }}</td>
                                    <td>{{ $proveedor->giro->nombre_giro }}</td>
                                    <td>{{ $proveedor->telefono }}</td>
                                    <td>{{ $proveedor->email }}</td>
                                    <td>{{ $proveedor->estado->nombre_estado }}</td>
                                    <td class="text-center">
                                        <div class="d-flex justify-content-center align-items-center gap-1">
                                            <a href="#" class="btn btn-info btn-sm" title="Ver">
                                                <i class="fas fa-eye"></i>
                                            </a>

                                            <a href="{{ route('admin.proveedores.edit', $proveedor->id) }}"
                                                class="btn btn-warning btn-sm" title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>

                                            <a href="{{ route('admin.proveedores.confirm_delete', $proveedor->id) }}"
                                                class="btn btn-danger btn-sm" title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            @endforeach

                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- /.card-body -->
    </div>
@stop

@section('css')
    <style>
        /* Fondo transparente y sin borde en el contenedor */
        #example1_wrapper .dt-buttons {
            background-color: transparent;
            box-shadow: none;
            border: none;
            display: flex;
            justify-content: center;
            /* Centrar los botones */
            flex-wrap: wrap;
            gap: 10px;
            /* Espaciado entre botones */
            margin-bottom: 15px;
            /* Separar botones de la tabla */
        }

        /* Estilo personalizado para los botones */
        #example1_wrapper .btn {
            color: #fff;
            /* Color del texto en blanco */
            border-radius: 4px;
            /* Bordes redondeados */
            padding: 5px 15px;
            /* Espaciado interno */
            font-size: 14px;
            /* TamaÃ±o de fuente */
        }

        /* Colores por tipo de botÃ³n */
        .btn-danger {
            background-color: #dc3545;
            border: none;
        }

        .btn-success {
            background-color: #28a745;
            border: none;
        }

        .btn-info {
            background-color: #17a2b8;
            border: none;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
            border: none;
        }

        .btn-default {
            background-color: #6e7176;
            color: #212529;
            border: none;
        }
    </style> {{-- Add here extra stylesheets --}}
    {{-- <link rel="stylesheet" href="/css/admin_custom.css"> --}}
@stop

@section('js')
    <script>
        $(function() {
            $("#example1").DataTable({
                "pageLength": 10,
                "language": {
                    "emptyTable": "No hay informacion",
                    "info": "Mostrando _START_ a _END_ de _TOTAL_ Proveedores",
                    "infoEmpty": "Mostrando 0 a 0 de 0 Proveedores",
                    "infoFiltered": "(Filtrado de _MAX_ total Proveedores)",
                    "lengthMenu": "Mostrar _MENU_ Proveedores",
                    "loadingRecords": "Cargando...",
                    "processing": "Procesando...",
                    "search": "Buscador:",
                    "zeroRecords": "Sin resultados encontrados",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "responsive": true,
                "lengthChange": true,
                "autoWidth": false,
                buttons: [{
                        text: '<i class="fas fa-copy"></i> COPIAR',
                        extend: 'copy',
                        className: 'btn btn-default'
                    },
                    {
                        text: '<i class="fas fa-file-pdf"></i> PDF',
                        extend: 'pdf',
                        className: 'btn btn-danger'
                    },
                    {
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        extend: 'csv',
                        className: 'btn btn-info'
                    },
                    {
                        text: '<i class="fas fa-file-excel"></i> EXCEL',
                        extend: 'excel',
                        className: 'btn btn-success'
                    },
                    {
                        text: '<i class="fas fa-print"></i> IMPRIMIR',
                        extend: 'print',
                        className: 'btn btn-default'
                    }
                ]
            }).buttons().container().appendTo('#example1_wrapper .row:eq(0)');
        });
    </script>
@stop
</file>

<file path="app/Http/Controllers/ProductController.php">
<?php

namespace App\Http\Controllers;

use App\Http\Requests\StoreProductRequest;
use App\Http\Requests\UpdateProductRequest;
use App\Models\Attribute;
use App\Models\AttributeValue;
use App\Models\Category;
use App\Models\Design;
use App\Models\DesignExport;
use App\Models\Product;
use App\Models\ProductCategory;
use App\Models\ProductExtra;
use App\Models\ProductVariant;
use App\Services\ProductService;
use Illuminate\Database\Eloquent\ModelNotFoundException;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\ValidationException;
use Illuminate\Support\Facades\Auth;
use App\Models\Application_types;
use App\Models\MaterialVariant;
use App\Models\Material;

class ProductController extends Controller
{
    protected ProductService $productService;

    public function __construct(ProductService $productService)
    {
        $this->productService = $productService;
    }

    /*
    |--------------------------------------------------------------------------
    | INDEX
    |--------------------------------------------------------------------------
    */

    public function index(Request $request)
    {
        try {
            $validated = $request->validate([
                'category' => ['nullable', 'integer', 'min:1'],
                'status' => ['nullable', 'string', 'in:active,draft,discontinued'],
                'search' => ['nullable', 'string', 'max:100'],
            ]);

            $query = Product::with([
                'category',
                'extras',
                'variants.attributes.attribute',
                'variants.designExports',
                'designs',
            ])->orderBy('created_at', 'desc');

            // Filtro por categoría
            if (!empty($validated['category'])) {
                $query->where('product_category_id', (int) $validated['category']);
            }

            // Filtro por estado
            if (!empty($validated['status'])) {
                $query->where('status', $validated['status']);
            }

            // Búsqueda
            if (!empty($validated['search'])) {
                $search = strip_tags(trim($validated['search']));
                $query->where(function ($q) use ($search) {
                    $q->where('name', 'like', "%{$search}%")
                        ->orWhere('sku', 'like', "%{$search}%")
                        ->orWhere('description', 'like', "%{$search}%");
                });
            }

            $products = $query->paginate(10)->withQueryString();

            $categories = ProductCategory::active()->ordered()->get();

            return view('admin.products.index', compact('products', 'categories'));
        } catch (\Exception $e) {
            Log::error('Error al listar productos: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
            ]);

            return view('admin.products.index', [
                'products' => collect(),
                'categories' => collect(),
            ])->with('error', 'Error al cargar los productos');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CREATE
    |--------------------------------------------------------------------------
    */

    public function create()
    {
        try {
            // 1. Cargar categorías (sin bloquear si están vacías)
            $categories = ProductCategory::active()->ordered()->get();

            // 2. Carga de Insumos y Configuración
            $extras = ProductExtra::ordered()->get();

            // STRICT FILTERING: Only load designs/variants with APPROVED production files
            $designs = Design::where(function ($q) {
                // Design has direct approved exports (Global)
                $q->whereHas('generalExports', fn($q2) => $q2->where('status', 'aprobado'))
                    // OR Design has variants with approved exports (Specific)
                    ->orWhereHas('variants.exports', fn($q2) => $q2->where('status', 'aprobado'));
            })
                ->with([
                    'categories',
                    'primaryImage',
                    'generalExports' => fn($q) => $q->where('status', 'aprobado'),
                    // Only load variants that have approved exports
                    'variants' => fn($q) => $q->whereHas('exports', fn($q2) => $q2->where('status', 'aprobado'))
                        ->with(['primaryImage', 'exports' => fn($q2) => $q2->where('status', 'aprobado')])
                ])
                ->orderBy('name')
                ->get();
            $applicationTypes = Application_types::where('activo', true)->orderBy('nombre_aplicacion')->get();

            // NEW: Flatten all approved DesignExports for the new UI
            // This creates a single-level collection of all production files
            $designExports = DesignExport::where('status', 'aprobado')
                ->with(['design.primaryImage', 'variant.primaryImage', 'image'])
                ->orderBy('design_id')
                ->orderBy('design_variant_id')
                ->orderBy('width_mm')
                ->get()
                ->map(function ($export) {
                    // Determine the display name and image
                    $displayName = $export->design->name;
                    $variantName = null;
                    $imageUrl = null;

                    // Check for variant
                    if ($export->variant) {
                        $variantName = $export->variant->name;
                        $displayName .= ' - ' . $variantName;
                        // Variant image priority - use display_url accessor (returns full URL)
                        $imageUrl = $export->variant->primaryImage?->display_url;
                    }

                    // Fallback to design image
                    if (!$imageUrl) {
                        $imageUrl = $export->design->primaryImage?->display_url;
                    }

                    // Export-specific image (highest priority)
                    if ($export->image) {
                        $imageUrl = $export->image->display_url;
                    }

                    return [
                        'id' => $export->id,
                        'design_id' => $export->design_id,
                        'design_name' => $export->design->name,
                        'variant_id' => $export->design_variant_id,
                        'variant_name' => $variantName,
                        'display_name' => $displayName,
                        'dimensions' => $export->width_mm . 'x' . $export->height_mm,
                        'dimensions_label' => $export->width_mm . 'x' . $export->height_mm . ' mm',
                        'width_mm' => $export->width_mm,
                        'height_mm' => $export->height_mm,
                        'stitches' => $export->stitches_count ?? 0,
                        'stitches_formatted' => number_format($export->stitches_count ?? 0),
                        'colors' => $export->colors_count ?? 0,
                        'application_type' => $export->application_type ?? 'general',
                        'application_label' => $export->application_label ?? ucfirst($export->application_type ?? 'General'),
                        'image_url' => $imageUrl,
                        'svg_content' => $export->svg_content, // SVG fallback for preview
                    ];
                });

            // 3. Atributos
            $sizeAttribute = Attribute::with('values')->where('slug', 'talla')->first();
            $colorAttribute = Attribute::with('values')->where('slug', 'color')->first();

            // 4. NUEVO: Materiales para la Fase 3 (Optimizado)
            // Solo traemos lo estrictamente necesario para el selector
            /*  $materials = MaterialVariant::with(['material.category.baseUnit']) 
                ->where('activo', true)
                ->get()
                ->map(function ($variant) {
                    return [
                        'id'            => $variant->id,
                        'text'          => $variant->sku . ' - ' . ($variant->color ?? 'Sin Color'),
                        'full_name'     => $variant->display_name, // Suponiendo que tienes este accessor
                        'stock'         => (float) $variant->current_stock,
                        'unit_symbol'   => $variant->material->category->baseUnit->symbol ?? 'unid',
                        'average_cost'  => (float) $variant->average_cost,
                    ];
                });*/

            // 4. Materiales (Familias) - Esto alimenta el primer Select
            $materials = Material::with('category.baseUnit')
                ->where('activo', true)
                ->orderBy('name')
                ->get();



            return view('admin.products.create', compact(
                'categories',
                'extras',
                'designs',
                'designExports', // NEW: Flattened exports for new UI
                'applicationTypes',
                'sizeAttribute',
                'colorAttribute',
                'materials'
            ));
        } catch (\Exception $e) {
            Log::error("Product Create Error [Line {$e->getLine()}]: " . $e->getMessage(), [
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString()
            ]);
            return redirect()->route('admin.products.index')
                ->with('error', 'Error interno al cargar el formulario de creación.');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | STORE
    |--------------------------------------------------------------------------
    */

    public function store(StoreProductRequest $request)
    {
        try {
            $validated = $request->validated();

            $product = $this->productService->createProduct($validated);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Producto '{$product->name}' creado exitosamente");
        } catch (\Exception $e) {
            Log::error('Error al crear producto: ' . $e->getMessage(), [
                'user_id' => Auth::id(),
                'trace' => $e->getTraceAsString(),
            ]);

            return redirect()->route('admin.products.create')
                ->withInput()
                ->with('error', 'Error al crear el producto. Intente nuevamente.');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | SHOW
    |--------------------------------------------------------------------------
    */

    public function show($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::with([
                'category',
                'extras',
                'designs.category',
                'variants.attributes.attribute',
                'variants.designExports.designVariant',
                'images',
            ])->findOrFail((int) $id);

            return view('admin.products.show', compact('product'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al mostrar producto: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al cargar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | EDIT
    |--------------------------------------------------------------------------
    */

    public function edit($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::with([
                'category',
                'extras',
                'designs',
                'variants.attributes',
            ])->findOrFail((int) $id);

            $categories = ProductCategory::active()->ordered()->get();
            $extras = ProductExtra::ordered()->get();
            $designs = Design::with('category')->orderBy('name')->get();
            $applicationTypes = Application_types::where('activo', true)->orderBy('nombre')->get();
            $attributes = Attribute::with('values')->orderBy('name')->get();

            return view('admin.products.edit', compact(
                'product',
                'categories',
                'extras',
                'designs',
                'applicationTypes',
                'attributes'
            ));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cargar producto para editar: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al cargar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | UPDATE
    |--------------------------------------------------------------------------
    */

    public function update(UpdateProductRequest $request, $id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::findOrFail((int) $id);
            $validated = $request->validated();

            $product = $this->productService->updateProduct($product, $validated);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Producto '{$product->name}' actualizado exitosamente");
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al actualizar producto: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.edit', $id)
                ->withInput()
                ->with('error', 'Error al actualizar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | CONFIRM DELETE
    |--------------------------------------------------------------------------
    */

    public function confirmDelete($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::with(['category', 'variants', 'designs', 'extras'])
                ->findOrFail((int) $id);

            return view('admin.products.delete', compact('product'));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cargar confirmación de eliminación: ' . $e->getMessage());

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al procesar la solicitud');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DESTROY
    |--------------------------------------------------------------------------
    */

    public function destroy($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::findOrFail((int) $id);
            $productName = $product->name;

            $this->productService->deleteProduct($product);

            return redirect()->route('admin.products.index')
                ->with('success', "Producto '{$productName}' eliminado exitosamente");
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al eliminar producto: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al eliminar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | DUPLICATE
    |--------------------------------------------------------------------------
    */

    public function duplicate($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->route('admin.products.index')
                    ->with('error', 'Producto no válido');
            }

            $product = Product::findOrFail((int) $id);
            $newProduct = $this->productService->duplicateProduct($product);

            return redirect()->route('admin.products.edit', $newProduct->id)
                ->with('success', "Producto duplicado exitosamente. Modifique los datos necesarios.");
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al duplicar producto: ' . $e->getMessage(), [
                'product_id' => $id,
            ]);

            return redirect()->route('admin.products.index')
                ->with('error', 'Error al duplicar el producto');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | TOGGLE STATUS
    |--------------------------------------------------------------------------
    */

    public function toggleStatus($id)
    {
        try {
            if (!is_numeric($id) || $id < 1) {
                return redirect()->back()->with('error', 'Producto no válido');
            }

            $product = Product::findOrFail((int) $id);

            if ($product->status === 'active') {
                $product->discontinue();
                $message = "Producto '{$product->name}' marcado como descontinuado";
            } else {
                $product->activate();
                $message = "Producto '{$product->name}' activado exitosamente";
            }

            return redirect()->back()->with('success', $message);
        } catch (ModelNotFoundException $e) {
            return redirect()->back()->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cambiar estado del producto: ' . $e->getMessage());
            return redirect()->back()->with('error', 'Error al cambiar el estado');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | VARIANTES
    |--------------------------------------------------------------------------
    */

    public function createVariant($productId)
    {
        try {
            $product = Product::with(['category', 'designs'])->findOrFail((int) $productId);
            $attributes = Attribute::with('values')->orderBy('name')->get();
            $applicationTypes = Application_types::where('activo', true)->orderBy('nombre')->get();

            // Obtener design exports de los diseños asignados
            $designExports = DesignExport::whereIn('design_id', $product->designs->pluck('id'))
                ->orWhereHas('designVariant', function ($q) use ($product) {
                    $q->whereIn('design_id', $product->designs->pluck('id'));
                })
                ->with(['design', 'designVariant'])
                ->get();

            return view('admin.products.variants.create', compact(
                'product',
                'attributes',
                'applicationTypes',
                'designExports'
            ));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cargar formulario de variante: ' . $e->getMessage());
            return redirect()->route('admin.products.show', $productId)
                ->with('error', 'Error al cargar el formulario');
        }
    }

    public function storeVariant(Request $request, $productId)
    {
        try {
            $product = Product::findOrFail((int) $productId);

            $validated = $request->validate([
                'sku_variant' => [
                    'required',
                    'string',
                    'max:100',
                    'regex:/^[A-Z0-9\-\_]+$/u',
                    'unique:product_variants,sku_variant',
                ],
                'price' => ['required', 'numeric', 'min:0', 'max:9999999.99'],
                'stock_alert' => ['nullable', 'integer', 'min:0', 'max:9999'],
                'attribute_values' => ['nullable', 'array'],
                'design_exports' => ['nullable', 'array'],
            ]);

            $variant = $this->productService->createVariant($product, $validated);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Variante '{$variant->sku_variant}' creada exitosamente");
        } catch (ValidationException $e) {
            return redirect()->back()->withInput()->withErrors($e->errors());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al crear variante: ' . $e->getMessage());
            return redirect()->back()->withInput()
                ->with('error', 'Error al crear la variante');
        }
    }

    public function editVariant($productId, $variantId)
    {
        try {
            $product = Product::findOrFail((int) $productId);
            $variant = ProductVariant::with(['attributes.attribute', 'designExports'])
                ->where('product_id', $product->id)
                ->findOrFail((int) $variantId);

            $attributes = Attribute::with('values')->orderBy('name')->get();
            $applicationTypes = Application_types::where('activo', true)->orderBy('nombre')->get();

            $designExports = DesignExport::whereIn('design_id', $product->designs->pluck('id'))
                ->orWhereHas('designVariant', function ($q) use ($product) {
                    $q->whereIn('design_id', $product->designs->pluck('id'));
                })
                ->with(['design', 'designVariant'])
                ->get();

            return view('admin.products.variants.edit', compact(
                'product',
                'variant',
                'attributes',
                'applicationTypes',
                'designExports'
            ));
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto o variante no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al cargar variante para editar: ' . $e->getMessage());
            return redirect()->route('admin.products.show', $productId)
                ->with('error', 'Error al cargar la variante');
        }
    }

    public function updateVariant(Request $request, $productId, $variantId)
    {
        try {
            $product = Product::findOrFail((int) $productId);
            $variant = ProductVariant::where('product_id', $product->id)
                ->findOrFail((int) $variantId);

            $validated = $request->validate([
                'sku_variant' => [
                    'required',
                    'string',
                    'max:100',
                    'regex:/^[A-Z0-9\-\_]+$/u',
                    "unique:product_variants,sku_variant,{$variantId}",
                ],
                'price' => ['required', 'numeric', 'min:0', 'max:9999999.99'],
                'stock_alert' => ['nullable', 'integer', 'min:0', 'max:9999'],
                'attribute_values' => ['nullable', 'array'],
                'design_exports' => ['nullable', 'array'],
            ]);

            $variant = $this->productService->updateVariant($variant, $validated);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Variante '{$variant->sku_variant}' actualizada exitosamente");
        } catch (ValidationException $e) {
            return redirect()->back()->withInput()->withErrors($e->errors());
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto o variante no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al actualizar variante: ' . $e->getMessage());
            return redirect()->back()->withInput()
                ->with('error', 'Error al actualizar la variante');
        }
    }

    public function destroyVariant($productId, $variantId)
    {
        try {
            $product = Product::findOrFail((int) $productId);
            $variant = ProductVariant::where('product_id', $product->id)
                ->findOrFail((int) $variantId);

            $skuVariant = $variant->sku_variant;
            $this->productService->deleteVariant($variant);

            return redirect()->route('admin.products.show', $product->id)
                ->with('success', "Variante '{$skuVariant}' eliminada exitosamente");
        } catch (ModelNotFoundException $e) {
            return redirect()->route('admin.products.index')
                ->with('error', 'Producto o variante no encontrado');
        } catch (\Exception $e) {
            Log::error('Error al eliminar variante: ' . $e->getMessage());
            return redirect()->route('admin.products.show', $productId)
                ->with('error', 'Error al eliminar la variante');
        }
    }

    /*
    |--------------------------------------------------------------------------
    | AJAX ENDPOINTS
    |--------------------------------------------------------------------------
    */

    public function getDesignsByCategory($categoryId)
    {
        try {
            $designs = Design::whereHas('categories', function ($q) use ($categoryId) {
                $q->where('categories.id', (int) $categoryId);
            })->orderBy('name')->get(['id', 'name', 'code', 'stitch_count']);

            return response()->json($designs);
        } catch (\Exception $e) {
            return response()->json(['error' => 'Error al obtener diseños'], 500);
        }
    }

    public function getDesignExports($designId)
    {
        try {
            $exports = DesignExport::where('design_id', (int) $designId)
                ->orWhereHas('designVariant', function ($q) use ($designId) {
                    $q->where('design_id', (int) $designId);
                })
                ->with(['design', 'designVariant', 'format'])
                ->get();

            return response()->json($exports);
        } catch (\Exception $e) {
            return response()->json(['error' => 'Error al obtener exportaciones'], 500);
        }
    }

    public function getAttributes()
    {
        try {
            $attributes = Attribute::with('values')->orderBy('name')->get();
            return response()->json($attributes);
        } catch (\Exception $e) {
            return response()->json(['error' => 'Error al obtener atributos'], 500);
        }
    }

    /**
     * Buscar materiales para el selector (API)
     */
    public function searchMaterials(Request $request)
    {
        $term = $request->get('q');

        $materials = MaterialVariant::with(['material', 'material.category', 'material.category.baseUnit'])
            ->whereHas('material', function ($q) use ($term) {
                $q->where('name', 'like', "%{$term}%");
            })
            ->orWhere('sku', 'like', "%{$term}%")
            ->orWhere('color', 'like', "%{$term}%")
            ->limit(20)
            ->get();

        $results = $materials->map(function ($variant) {
            $unitSymbol = $variant->material->category->baseUnit->symbol ?? '';
            return [
                'id' => $variant->id,
                'text' => $variant->display_name . " (Stock: {$variant->current_stock} {$unitSymbol})",
                'sku' => $variant->sku,
                'unit' => $variant->material->category->baseUnit->name ?? 'Unidad',
                'symbol' => $unitSymbol,
                'cost' => $variant->average_cost > 0 ? $variant->average_cost : $variant->last_purchase_cost,
                'stock' => $variant->current_stock
            ];
        });

        return response()->json(['results' => $results]);
    }

    /**
     * Valida si los precios de los materiales han cambiado
     */
    public function validateMaterialPrices(Request $request)
    {
        try {
            $clientMaterials = $request->input('materials', []);
            $changes = [];
            $hasChanges = false;

            foreach ($clientMaterials as $m) {
                $variant = MaterialVariant::find($m['id']);
                if (!$variant) continue;

                // Determine current system cost
                $currentCost = $variant->average_cost > 0 ? $variant->average_cost : $variant->last_purchase_cost;
                $clientCost = (float) $m['price'];

                // Check for significant difference (avoid floating point issues)
                if (abs($currentCost - $clientCost) > 0.001) {
                    $changes[] = [
                        'id' => $variant->id,
                        'name' => $variant->display_name,
                        'old_price' => $clientCost,
                        'new_price' => $currentCost,
                        'diff' => $currentCost - $clientCost
                    ];
                    $hasChanges = true;
                }
            }

            return response()->json([
                'has_changes' => $hasChanges,
                'changes' => $changes
            ]);
        } catch (\Exception $e) {
            return response()->json(['error' => 'Error al validar precios'], 500);
        }
    }
}
</file>

<file path="resources/views/admin/products/create.blade.php">
@extends('adminlte::page')

@section('title', 'Nuevo Producto - Enterprise Configurator')

@section('plugins.Sweetalert2', true)
@section('plugins.Select2', true)

@section('content_header')
    <div class="module-header fade-in">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="text-white"><i class="fas fa-cube mr-2"></i> Configurador de Productos</h1>
                <p class="text-white-50 mb-0">Crea tu producto paso a paso: define, configura y publica</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="live-cost-badge d-none d-md-block">
                    <span class="label">Costo Producción Est.:</span>
                    <span class="value" id="headerCost">$0.00</span>
                </div>
                <a href="{{ route('admin.products.index') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </div>
    </div>
@stop

@section('content')
    <div class="content-wrapper-custom">
        <form id="productForm" action="{{ route('admin.products.store') }}" method="POST" enctype="multipart/form-data">
            @csrf

            <div class="stepper-nav-container">
                <button type="button" class="stepper-arrow stepper-arrow-prev" id="btnPrev" disabled
                    onclick="navigate(-1)">
                    <i class="fas fa-chevron-left"></i>
                </button>

                <div class="stepper-wrapper">
                    <div class="stepper-item active" data-step="1" onclick="navigateToStep(1)" style="cursor:pointer;">
                        <div class="step-counter">1</div>
                        <div class="step-name">Definición</div>
                    </div>
                    <div class="stepper-item" data-step="2" onclick="navigateToStep(2)" style="cursor:pointer;">
                        <div class="step-counter">2</div>
                        <div class="step-name">Presentaciones <span class="step-badge d-none" id="badgeStep2"></span></div>
                    </div>
                    <div class="stepper-item" data-step="3" onclick="navigateToStep(3)" style="cursor:pointer;">
                        <div class="step-counter">3</div>
                        <div class="step-name">Receta <span class="step-badge d-none" id="badgeStep3"></span></div>
                    </div>
                    <div class="stepper-item" data-step="4" onclick="navigateToStep(4)" style="cursor:pointer;">
                        <div class="step-counter">4</div>
                        <div class="step-name">Diseño <span class="step-badge d-none" id="badgeStep4"></span></div>
                    </div>
                    <div class="stepper-item" data-step="5" onclick="navigateToStep(5)" style="cursor:pointer;">
                        <div class="step-counter">5</div>
                        <div class="step-name">Extras</div>
                    </div>
                    <div class="stepper-item" data-step="6" onclick="navigateToStep(6)" style="cursor:pointer;">
                        <div class="step-counter">6</div>
                        <div class="step-name">Costeo</div>
                    </div>
                </div>

                <button type="button" class="stepper-arrow stepper-arrow-next" id="btnNext" onclick="navigate(1)">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>

            <div class="step-content fade-in" id="step1-content"></div>
            <div class="step-content d-none fade-in" id="step2-content"></div>
            <div class="step-content d-none fade-in" id="step3-content"></div>
            <div class="step-content d-none fade-in" id="step4-content"></div>
            <div class="step-content d-none fade-in" id="step5-content"></div>
            <div class="step-content d-none fade-in" id="step6-content"></div>

            <input type="hidden" name="variants_json" id="h_variants">
            <input type="hidden" name="materials_json" id="h_materials">
            <input type="hidden" name="embroideries_json" id="h_embroideries">
            <input type="hidden" name="extras_json" id="h_extras">
            <input type="hidden" name="financials_json" id="h_financials">
        </form>
    </div>

    {{-- MODALS --}}
    <div class="modal fade" id="materialScopeModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-bullseye mr-2"></i>Definir Alcance del Material</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted mb-4" style="font-size: 1.1rem;">¿Este material se aplica a todas las variantes o
                        solo a algunas específicas?</p>

                    {{-- ALERTA EXPLICATIVA --}}
                    <div class="bg-light border rounded p-3 mb-4">
                        <h6 class="mb-2 text-center" style="font-size: 1rem;"><i
                                class="fas fa-lightbulb text-warning mr-2"></i>¿Cómo funciona?</h6>
                        <ul class="mb-2 pl-4 text-muted text-left" style="font-size: 0.95rem;">
                            <li><strong>Global:</strong> Aplica a todas las variantes</li>
                            <li><strong>Específico:</strong> Solo aplica a las variantes seleccionadas</li>
                        </ul>
                        <small class="text-secondary"><i class="fas fa-info-circle mr-1"></i>Si agregas Global +
                            Específico
                            del mismo material, los consumos se suman.</small>
                    </div>

                    {{-- TOGGLE BUTTONS --}}
                    <div class="d-flex justify-content-center mb-4 gap-3">
                        <button type="button" class="scope-toggle-btn" id="btnScopeGlobal"
                            onclick="selectScope('global')">
                            <i class="fas fa-globe mr-2"></i>GLOBAL
                        </button>
                        <button type="button" class="scope-toggle-btn" id="btnScopeSpecific"
                            onclick="selectScope('specific')">
                            <i class="fas fa-filter mr-2"></i>ESPECÍFICO
                        </button>
                    </div>
                    <input type="hidden" name="materialScope" id="materialScopeValue" value="">

                    <div id="specificVariantsContainer" class="d-none text-left">
                        <label class="font-weight-bold">Selecciona las variantes:</label>
                        <select class="form-control select2" multiple id="targetVariantsSelect"
                            style="width:100%"></select>
                    </div>
                </div>
                <div class="modal-footer justify-content-center border-top pt-3">
                    <button type="button" class="btn btn-outline-secondary px-4 py-2" data-dismiss="modal"
                        style="border-width: 2px; font-weight: 600;">
                        <i class="fas fa-times mr-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary px-4 py-2" onclick="confirmAddMaterial()"
                        style="font-weight: 600;">
                        <i class="fas fa-plus mr-2"></i>Agregar al BOM
                    </button>
                </div>
            </div>
        </div>
    </div>

    {{-- DESIGN CONFIG MODAL - PREMIUM REDESIGN --}}
    <div class="modal fade" id="designConfigModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
                <!-- HEADER - Premium gradient -->
                <div class="modal-header border-0 text-white py-3 text-center"
                    style="background: linear-gradient(135deg, #17a2b8, #138496);">
                    <div class="w-100">
                        <h4 class="modal-title mb-1 font-weight-bold text-uppercase" id="designModalLabel"
                            style="font-size: 1.5rem; letter-spacing: 1px;">NOMBRE ETIQUETA</h4>
                        <small id="designModalOrigin" class="d-block" style="opacity: 0.85;"><i
                                class="fas fa-sitemap mr-1"></i>Origen</small>
                    </div>
                    <button type="button" class="close text-white position-absolute" data-dismiss="modal"
                        aria-label="Close" style="right: 15px; top: 15px;">
                        <span aria-hidden="true" style="font-size: 1.5rem;">&times;</span>
                    </button>
                </div>

                <!-- BODY -->
                <div class="modal-body p-4">
                    {{-- Preview Section --}}
                    <div class="text-center mb-4">
                        <img id="designModalImage" src="" class="img-fluid rounded-lg shadow mb-3"
                            style="max-height: 140px; display: none; border-radius: 12px;">

                        {{-- Position Badge - Where it will be applied --}}
                        <div class="mb-3">
                            <span class="badge px-4 py-2" id="designModalPosition"
                                style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; font-size: 1.1rem; border-radius: 20px;">
                                <i class="fas fa-map-marker-alt mr-2"></i>Posición
                            </span>
                        </div>

                        {{-- Technical Data - Clean Row --}}
                        <div class="d-flex justify-content-center">
                            <div class="text-center px-3">
                                <i class="fas fa-ruler-combined text-primary mb-1" style="font-size: 1.3rem;"></i>
                                <div class="font-weight-bold text-dark" style="font-size: 1rem;"
                                    id="designModalDimensions">-</div>
                                <small class="text-muted">Tamaño</small>
                            </div>
                            <div class="text-center px-3 border-left border-right">
                                <i class="fas fa-palette text-info mb-1" style="font-size: 1.3rem;"></i>
                                <div class="font-weight-bold text-dark" style="font-size: 1rem;" id="designModalColors">-
                                </div>
                                <small class="text-muted">Colores</small>
                            </div>
                            <div class="text-center px-3">
                                <i class="fas fa-th text-success mb-1" style="font-size: 1.3rem;"></i>
                                <div class="font-weight-bold text-dark" style="font-size: 1rem;"
                                    id="designModalStitches">-</div>
                                <small class="text-muted">Puntadas</small>
                            </div>
                        </div>
                    </div>

                    {{-- Hidden elements for compatibility --}}
                    <span id="designModalName" class="d-none"></span>
                    <span id="designModalAppType" class="d-none"></span>
                    <div id="designVariantContainer" class="d-none">
                        <select id="designVariantSelect"></select>
                    </div>
                    <div class="d-none">
                        <select id="designPositionSelect">
                            @foreach ($applicationTypes as $appType)
                                <option value="{{ $appType->id }}"
                                    data-slug="{{ Str::slug($appType->nombre_aplicacion) }}">
                                    {{ $appType->nombre_aplicacion }}
                                </option>
                            @endforeach
                        </select>
                    </div>

                    {{-- Scope Selection - Cleaner Design --}}
                    <div class="bg-light rounded p-3 mb-3" style="border-radius: 12px !important;">
                        <label class="font-weight-bold text-dark mb-2 d-block">
                            <i class="fas fa-bullseye text-info mr-2"></i>Aplicar a:
                        </label>
                        <div class="d-flex">
                            <button type="button" class="btn btn-info btn-sm flex-fill design-scope-btn active mr-2"
                                data-scope="global" onclick="selectDesignScope('global')" style="border-radius: 8px;">
                                <i class="fas fa-globe mr-1"></i> Todas las Variantes
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm flex-fill design-scope-btn"
                                data-scope="specific" onclick="selectDesignScope('specific')"
                                style="border-radius: 8px;">
                                <i class="fas fa-filter mr-1"></i> Específicas
                            </button>
                        </div>
                        <input type="hidden" id="designScopeValue" value="global">
                        <div id="designVariantsContainer" class="d-none mt-3">
                            <select class="form-control select2" multiple id="designTargetVariants"
                                data-placeholder="Seleccione variantes..."></select>
                        </div>
                    </div>

                    {{-- Configured Positions List --}}
                    <div id="designConfiguredPositions" class="d-none mb-3">
                        <label class="font-weight-bold text-dark mb-2">
                            <i class="fas fa-layer-group text-success mr-2"></i>Configuraciones:
                        </label>
                        <div id="configuredPositionsList" class="d-flex flex-wrap"></div>
                    </div>
                </div>

                {{-- FOOTER --}}
                <div class="modal-footer border-0 bg-light px-4 py-3">
                    <div id="justAddedFeedback" class="alert alert-success py-2 mb-2 d-none w-100">
                        <i class="fas fa-check mr-1"></i> <span id="justAddedText"></span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center w-100">
                        {{-- LEFT: Add Button + Count --}}
                        <div class="d-flex align-items-center">
                            <button type="button" class="btn btn-info px-4 mr-3 font-weight-bold shadow-sm"
                                onclick="confirmAddDesignDirect()" style="border-radius: 8px;">
                                <i class="fas fa-plus mr-1"></i> AGREGAR
                            </button>
                            <div class="text-dark small">
                                <i class="fas fa-check-circle text-success mr-1"></i>
                                <strong id="designsAddedCount">0</strong> agregado(s)
                            </div>
                        </div>

                        {{-- RIGHT: Close Button (Darker) --}}
                        <button type="button" class="btn btn-dark px-4 font-weight-bold shadow-sm" data-dismiss="modal"
                            style="border-radius: 8px;">
                            CERRAR
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    </div>

    {{-- ================= TEMPLATES (DATA FROM DB) ================= --}}

    {{-- STEP 1: DEFINICIÓN --}}
    <script type="text/template" id="tpl_step1">
    <div class="card shadow-sm border-0">
        <div class="card-body p-4">
            <h5 class="step-title"><i class="fas fa-fingerprint text-primary"></i> Identidad del Producto</h5>
            <p class="step-description text-muted mb-4">
                <i class="fas fa-lightbulb text-warning mr-1"></i>
                Define la información básica que identifica tu producto. El <strong>nombre comercial</strong> es como tus clientes lo conocerán.
            </p>
            <div class="row">
                {{-- LEFT COLUMN: FORM FIELDS --}}
                <div class="col-md-8">
                {{-- ROW 1: NAME + SKU --}}
                    <div class="row">
                        <div class="col-md-7">
                            <div class="form-group">
                                <label class="font-weight-bold">Nombre Comercial *</label>
                                <input type="text" class="form-control form-control-lg" name="name" id="inpName" placeholder="Ej: Guayabera Presidencial Lino" required oninput="generateSKU()">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label class="font-weight-bold">SKU Base</label>
                                <div class="input-group">
                                    <input type="text" class="form-control text-uppercase bg-light" name="sku" id="inpSku" readonly>
                                    <div class="input-group-append">
                                        <button type="button" class="btn btn-outline-secondary" onclick="toggleSkuEdit()" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                                <small class="text-muted">Auto-generado</small>
                            </div>
                        </div>
                    </div>
                    {{-- ROW 2: CATEGORY + STATUS --}}
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label class="font-weight-bold">Categoría</label>
                                <select class="form-control" name="category_id" id="inpCategory">
                                    <option value="">-- Selecciona una categoría --</option>
                                    @foreach($categories ?? [] as $cat)
                                        <option value="{{ $cat->id }}">{{ $cat->name }}</option>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 d-none">
                            <div class="form-group">
                                <label class="font-weight-bold">Estado</label>
                                <select class="form-control" name="status" id="inpStatus" >
                                    <option value="">-- Selecciona un estado --</option>
                                    <option value="draft">Borrador</option>
                                    <option value="active" selected>Activo</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    {{-- ROW 3: DESCRIPTION --}}
                    <div class="row">
                        <div class="col-12">
                            <div class="form-group">
                                <label class="font-weight-bold">Descripción</label>
                                <textarea class="form-control" name="description" id="inpDesc" rows="3" placeholder="Descripción detallada del producto..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                {{-- RIGHT COLUMN: IMAGE DROPZONE --}}
                <div class="col-md-4 d-flex flex-column">
                    <label class="font-weight-bold">Imagen del Producto</label>
                    <div class="custom-dropzone text-center p-3 flex-grow-1" id="productImageDropzone">
                        <input type="file" name="image" id="inpImage" accept="image/*" class="d-none" onchange="previewImage(this)">
                        
                        {{-- PLACEHOLDER STATE --}}
                        <div id="dropzonePlaceholder">
                            <div class="mb-2">
                                <i class="fas fa-cloud-upload-alt text-muted" style="font-size: 3rem;"></i>
                            </div>
                            <h6 class="font-weight-bold text-dark mb-1">Arrastra tu imagen aquí</h6>
                            <p class="small text-muted mb-0">o haz clic para seleccionar</p>
                            <div class="mt-2 text-muted small">PNG, JPG, WEBP (Max 2MB)</div>
                            <div class="mt-1 text-danger small d-none" id="imageErrorMsg"></div>
                        </div>

                        {{-- PREVIEW STATE --}}
                        <div id="dropzonePreview" class="d-none position-relative w-100 h-100">
                            <img id="imgPreview" src="" class="img-fluid rounded" style="max-height: 250px; max-width: 100%; object-fit: contain;">
                            <button type="button" class="btn btn-danger btn-sm rounded-circle position-absolute" 
                                    style="top: 0; right: 0; width: 30px; height: 30px; padding: 0; line-height: 30px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);"
                                    onclick="removeImage(event)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </script>


    {{-- STEP 2: VARIANTES --}}
    <script type="text/template" id="tpl_step2">
    <div class="card shadow-sm border-0">
        <div class="card-body p-4">
            <h5 class="step-title"><i class="fas fa-th text-primary"></i> Presentaciones del Producto</h5>
            <p class="step-description text-muted mb-4">
                <i class="fas fa-lightbulb text-warning mr-1"></i>
                Las <strong>presentaciones</strong> son las combinaciones de talla y color que ofrecerás. 
                Ejemplo: Si vendes en tallas S, M, L y colores Azul y Rojo, tendrás 6 presentaciones diferentes.
            </p>
            
            <div class="row">
                {{-- LEFT COLUMN: Selectors --}}
                <div class="col-md-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white font-weight-bold">Configurar Variantes</div>
                        <div class="card-body">
                            <div class="form-group">
                                <label>Tallas</label>
                                <div class="position-relative">
                                    <select class="form-control select2" multiple id="selSizes" data-placeholder="Selecciona tallas...">
                                        @foreach($sizeAttribute->values ?? [] as $val)
                                            <option value="{{ $val->id }}">{{ $val->value }}</option>
                                        @endforeach
                                    </select>
                                    <i class="fas fa-times clear-btn-internal" 
                                       onclick="$('#selSizes').val(null).trigger('change')" 
                                       title="Limpiar tallas"></i>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Colores</label>
                                <div class="position-relative">
                                    <select class="form-control select2" multiple id="selColors" data-placeholder="Selecciona colores...">
                                        @foreach($colorAttribute->values ?? [] as $val)
                                            <option value="{{ $val->id }}" data-hex="{{ $val->hex_color }}">{{ $val->value }}</option>
                                        @endforeach
                                    </select>
                                    <i class="fas fa-times clear-btn-internal" 
                                       onclick="$('#selColors').val(null).trigger('change')" 
                                       title="Limpiar colores"></i>
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary btn-block btn-lg" onclick="generateMatrix()">
                                <i class="fas fa-bolt mr-2"></i>Generar Variantes
                            </button>
                        </div>
                    </div>
                </div>
                
                {{-- RIGHT COLUMN: Variants Table --}}
                <div class="col-md-8">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-white align-items-center">
                            <span class="font-weight-bold" style="font-size: 1.1rem;">Variantes Generadas</span>
                            <span class="badge badge-primary ml-2 shadow-sm" id="variantCountBadge" style="font-size: 1.1rem; padding: 0.35em 0.6em;">0</span>
                        </div>
                        <div class="card-body p-0">
                            <div id="variantsTableContainer" class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Variante</th>
                                            <th>SKU Generado</th>
                                            <th class="text-center" style="width:80px">Acción</th>
                                        </tr>
                                    </thead>
                                    <tbody id="variantsTableBody">
                                        <tr id="noVariantsRow">
                                            <td colspan="3" class="text-center text-muted py-4">
                                                <i class="fas fa-info-circle mr-2"></i>Seleccione tallas y colores, luego presione Generar
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

    {{-- STEP 3: BOM (ENGINEERING) --}}
    <script type="text/template" id="tpl_step3">
    <div class="card shadow-sm border-0 mb-3">
        <div class="card-body p-4">
            <h5 class="step-title"><i class="fas fa-boxes text-primary"></i> Receta del Producto</h5>
            <p class="step-description text-muted mb-3">
                <i class="fas fa-lightbulb text-warning mr-1"></i>
                Lista los <strong>materiales necesarios</strong> para fabricar cada unidad. 
                Como una receta de cocina: ¿qué ingredientes necesitas y cuánto de cada uno?
            </p>

        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white font-weight-bold">Catálogo de Insumos</div>
                <div class="card-body">
                    <div class="form-group">
                        <label>Familia de Material</label>
                        <div class="position-relative">
                            <select class="form-control select2" id="bomFamilySelector" data-placeholder="Seleccione Familia...">
                                <option value=""></option>
                                @foreach($materials ?? [] as $m)
                                    <option value="{{ $m->id }}" data-unit="{{ $m->category->baseUnit->symbol ?? 'unid' }}">{{ $m->name }}</option>
                                @endforeach
                            </select>
                            <i class="fas fa-times clear-btn-internal" 
                               onclick="$('#bomFamilySelector').val(null).trigger('change')" 
                               title="Limpiar selección"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Material Específico / Color</label>
                        <div class="position-relative">
                            <select class="form-control select2" id="bomMaterialSelector" disabled data-placeholder="Seleccione Material..."></select>
                            <i class="fas fa-times clear-btn-internal" 
                               onclick="$('#bomMaterialSelector').val(null).trigger('change')" 
                               title="Limpiar selección"></i>
                        </div>
                        <div id="materialInfo" class="mt-2 small d-none p-2 bg-light rounded border">
                            <div>Stock: <b id="matStock">-</b> | Costo: <b id="matCost" class="text-success">$-</b></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Cantidad (Consumo)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="bomQty" placeholder="0.00" step="0.01" oninput="updateBomCostPreview()">
                            <div class="input-group-append">
                                <span class="input-group-text" id="bomUnit">unid</span>
                            </div>
                        </div>
                        <div id="bomCostPreview" class="mt-2 small text-success font-weight-bold d-none">
                            <i class="fas fa-calculator"></i> Costo Estimado: <span id="bomCostPreviewValue">$0.00</span>
                        </div>
                    </div>
                    
                    {{-- INLINE SCOPE SELECTION --}}
                    <div class="form-group">
                        <label>¿Aplica a todas las presentaciones?</label>
                        <div class="d-flex gap-2 mb-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm flex-fill scope-inline-btn active" data-scope="global" onclick="setInlineScope('global')">
                                <i class="fas fa-globe"></i> Todas
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm flex-fill scope-inline-btn" data-scope="specific" onclick="setInlineScope('specific')">
                                <i class="fas fa-filter"></i> Solo algunas
                            </button>
                        </div>
                        <input type="hidden" id="inlineScopeValue" value="global">
                        <div id="inlineVariantsContainer" class="d-none">
                            <select class="form-control select2" multiple id="inlineTargetVariants" data-placeholder="Seleccione presentaciones..."></select>
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                         <input class="form-check-input" type="checkbox" id="materialIsPrimary">
                         <label class="form-check-label small" for="materialIsPrimary">Material Base (Principal)</label>
                    </div>
                    <button type="button" class="btn btn-success btn-block" onclick="addMaterialDirect()">
                        <i class="fas fa-plus-circle"></i> Agregar a la Receta
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between">
                    <span class="font-weight-bold">Lista de Ingredientes</span>
                </div>
                <div class="card-body p-0 table-responsive">
                    <table class="table table-bordered table-striped mb-0" id="bomTable">
                        <thead class="bg-light">
                            <tr>
                                <th class="text-center align-middle">Insumo</th>
                                <th class="text-center align-middle">Variantes</th>
                                <th class="text-center align-middle">Consumo</th>
                                <th class="text-center align-middle">Alcance</th>
                                <th class="text-center align-middle">
                                    <div style="line-height: 1;">Costo</div>
                                    <div id="bomTotalCostBadge" class="badge badge-success mt-1" style="font-size: 0.85rem;">Total: $0.00</div>
                                </th>
                                <th class="text-center align-middle">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="bomTableBody" class="text-center" style="font-size: 0.9rem;">
                            <tr><td colspan="6" class="text-center text-muted py-4">Sin materiales asignados</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</script>

    {{-- STEP 4: DESIGN (EMBROIDERY) - NEW FLAT UI WITH FILTERS --}}
    <script type="text/template" id="tpl_step4">
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <h5 class="step-title"><i class="fas fa-vector-square text-primary"></i> Diseños de Bordado</h5>
            <p class="step-description text-muted mb-3">
                <i class="fas fa-lightbulb text-warning mr-1"></i>
                Selecciona las <strong>producciones de bordado</strong> que aplicarás a tu producto.
                Usa los filtros para encontrar rápidamente lo que necesitas.
            </p>

            {{-- Toggle + Filters Row --}}
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="custom-control custom-switch pt-2">
                        <input type="checkbox" class="custom-control-input" id="toggleNoDesign" onchange="toggleNoDesignMode()">
                        <label class="custom-control-label font-weight-bold" for="toggleNoDesign">
                            <i class="fas fa-tshirt mr-1"></i> Este producto es liso (sin bordado)
                        </label>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="row">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm" placeholder="Buscar diseño..." id="searchDesign">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control form-control-sm" id="filterDesignBase">
                                <option value="">Todos los diseños</option>
                                @foreach($designs as $design)
                                    <option value="{{ $design->id }}">{{ $design->name }}</option>
                                @endforeach
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control form-control-sm" id="filterAppType">
                                <option value="">Todas las ubicaciones</option>
                                @foreach($applicationTypes as $appType)
                                    <option value="{{ $appType->slug }}">{{ $appType->nombre_aplicacion }}</option>
                                @endforeach
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary btn-sm btn-block" onclick="clearDesignFilters()">
                                <i class="fas fa-times"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            {{-- Results Counter --}}
            <div class="d-flex justify-content-between align-items-center mb-2">
                <small class="text-muted" id="designExportCounter">
                    Mostrando <strong>{{ count($designExports) }}</strong> producciones disponibles
                </small>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-secondary active" onclick="setDesignViewMode('grid')" id="btnViewGrid">
                        <i class="fas fa-th"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setDesignViewMode('list')" id="btnViewList">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>
        </div>

        {{-- Grid of Design Exports --}}
        <div class="design-grid-container" id="designExportsContainer">
            <div class="row px-3 pb-3" id="designGrid">
                @forelse($designExports as $export)
                    <div class="col-xl-2 col-lg-3 col-md-4 col-sm-6 mb-3 design-export-item"
                         data-design-id="{{ $export['design_id'] }}"
                         data-variant-id="{{ $export['variant_id'] ?? '' }}"
                         data-app-type="{{ strtolower($export['application_type'] ?? '') }}"
                         data-label="{{ strtolower($export['application_label'] ?? '') }}"
                         data-name="{{ strtolower($export['design_name']) }}"
                         data-dimensions="{{ $export['dimensions'] }}">
                        <div class="card h-100 design-export-card"
                             onclick='selectDesignExport(this, @json($export))'
                             data-export-id="{{ $export['id'] }}">

                            {{-- Origin Badge: BLUE = Design, PURPLE = Variant --}}
                            @if($export['variant_name'])
                                <div class="origin-badge variant" title="Variante: {{ $export['variant_name'] }}">
                                    <i class="fas fa-code-branch"></i>
                                </div>
                            @else
                                <div class="origin-badge design" title="Diseño Principal">
                                    <i class="fas fa-vector-square"></i>
                                </div>
                            @endif

                            {{-- Image / SVG Preview - Use same route as production index --}}
                            <div class="card-img-top design-thumb d-flex align-items-center justify-content-center bg-white" style="height: 90px; overflow: hidden;">
                                <img src="{{ route('admin.production.preview', $export['id']) }}" 
                                     class="img-fluid" 
                                     style="max-height: 80px; max-width: 100%; object-fit: contain;">
                            </div>

                            {{-- Body --}}
                            <div class="card-body p-2">
                                {{-- Label Name (Primary - Most Important) --}}
                                <h6 class="text-truncate mb-1 font-weight-bold text-dark text-center" title="{{ $export['application_label'] }}" style="font-size: 0.95rem;">
                                    {{ Str::limit($export['application_label'], 18) }}
                                </h6>

                                {{-- Design Origin --}}
                                <div class="text-center mb-2">
                                    <small class="text-muted d-block" title="{{ $export['design_name'] }}">
                                        <i class="fas fa-sitemap mr-1"></i>{{ Str::limit($export['design_name'], 20) }}
                                    </small>
                                    @if($export['variant_name'])
                                        <small class="text-purple d-block font-weight-bold" title="{{ $export['variant_name'] }}">
                                            <i class="fas fa-code-branch mr-1"></i>{{ Str::limit($export['variant_name'], 20) }}
                                        </small>
                                    @endif
                                </div>

                                {{-- Technical Data Row --}}
                                <div class="d-flex justify-content-between align-items-center tech-data-row">
                                    <span title="Dimensiones">
                                        <i class="fas fa-ruler-combined text-primary"></i>
                                        <strong>{{ $export['dimensions_label'] }}</strong>
                                    </span>
                                    <span title="Colores">
                                        <i class="fas fa-palette text-info"></i>
                                        <strong>{{ $export['colors'] }}</strong>
                                    </span>
                                    <span title="Puntadas">
                                        <i class="fas fa-th text-success"></i>
                                        <strong>{{ number_format($export['stitches'] / 1000, 1) }}k</strong>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                @empty
                    <div class="col-12 text-center text-muted py-5">
                        <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                        No hay producciones de bordado aprobadas disponibles
                    </div>
                @endforelse
            </div>
        </div>
    </div>

    {{-- Premium Card Styles --}}
    <style>
        .design-export-card {
            position: relative;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            overflow: hidden;
            background: #fff;
        }
        .design-export-card:hover {
            border-color: #17a2b8;
            box-shadow: 0 8px 25px rgba(23, 162, 184, 0.25);
            transform: translateY(-4px);
        }
        .design-export-card.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        .design-export-card .origin-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            z-index: 10;
            color: #fff;
        }
        .design-export-card .origin-badge.design {
            background: linear-gradient(135deg, #007bff, #0056b3);
        }
        .design-export-card .origin-badge.variant {
            background: linear-gradient(135deg, #6f42c1, #5a32a3);
        }
        .design-export-card .tech-data-row {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 6px 8px;
            font-size: 0.75rem;
        }
        .design-export-card .tech-data-row span {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        .design-export-card .tech-data-row strong {
            color: #495057;
        }
        .design-export-card .svg-preview {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .design-export-card .svg-preview svg {
            max-width: 100%;
            max-height: 75px;
            width: auto;
            height: auto;
        }
        .text-purple { color: #6f42c1; }
    </style>
</script>

    {{-- BACKUP: OLD STEP 4 - Uncomment to revert to original design-based view
            <script type="text/template" id="tpl_step4_OLD">
    <div class="card shadow-sm border-0">
        <div class="card-body">
                <h5 class="step-title"><i class="fas fa-vector-square text-primary"></i> Diseños de Bordado</h5>
                <p class="step-description text-muted mb-3">
                    <i class="fas fa-lightbulb text-warning mr-1"></i>
                    Selecciona los <strong>diseños de bordado</strong> que aplicarás a tu producto.
                    Haz clic en un diseño para configurar su posición (pecho, manga, espalda, etc.).
                </p>
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="custom-control custom-switch">
                        <input type="checkbox" class="custom-control-input" id="toggleNoDesign" onchange="toggleNoDesignMode()">
                        <label class="custom-control-label font-weight-bold" for="toggleNoDesign">
                            <i class="fas fa-tshirt mr-1"></i> Este producto es liso (sin bordado)
                        </label>
                    </div>
                    <input type="text" class="form-control" style="width: 200px;" placeholder="Buscar diseño..." id="searchDesign">
                </div>
            </div>

            <div class="design-grid-container">
                <div class="row" id="designGrid">
                    @forelse($designs as $design)
                        @php
                            $export = $design->generalExports->first();
                            $stitches = $export ? number_format($export->stitches_count) : 'N/A';
                            $stitchesRaw = $export->stitches_count ?? 0;
                            $dimensions = $export ? ($export->width_mm . 'x' . $export->height_mm . ' mm') : 'N/A';
                            $colors = $export ? $export->colors_count : 0;
                            $appType = $export->application_type ?? 'General';
                            $image = $design->primaryImage ? $design->primaryImage->url : null;
                        @endphp
                        <div class="col-md-3 col-sm-6 mb-4">
                            <div class="card h-100 design-card"
                                 onclick='toggleDesign(this, {{ $design->id }}, "{{ addslashes($design->name) }}", {{ $stitchesRaw }}, "{{ $image ? addslashes(asset("storage/" . $image)) : "" }}", "{{ $dimensions }}", {{ $colors }}, @json($design->variants))'
                                 data-design-id="{{ $design->id }}"
                                 data-app-type="{{ strtolower($appType) }}">
                                <div class="card-img-top design-thumb d-flex align-items-center justify-content-center bg-light" style="height: 140px;">
                                    @if($image)
                                        <img src="{{ asset('storage/' . $image) }}" style="max-height: 120px; max-width: 100%;">
                                    @elseif($design->variants->isNotEmpty() && $design->variants->first()->primaryImage)
                                        <img src="{{ asset('storage/' . $design->variants->first()->primaryImage->url) }}" style="max-height: 120px; max-width: 100%;">
                                    @else
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                    @endif
                                </div>
                                <div class="card-body p-3 text-center">
                                    <h5 class="text-truncate mb-2 font-weight-bold" title="{{ $design->name }}" style="font-size: 1.25rem;">
                                        {{ $design->name }}
                                        @if($design->variants->isNotEmpty())
                                            <span class="badge badge-light text-muted ml-1" style="font-size: 0.7rem;">+{{ $design->variants->count() }} var</span>
                                        @endif
                                    </h5>
                                    <div class="mb-2 d-flex justify-content-center">
                                        <span class="badge badge-secondary" style="font-size: 0.95rem;">Lugar de aplicación: {{ ucfirst($appType) }}</span>
                                    </div>
                                    <div class="row text-center small">
                                        <div class="col-4">
                                            <i class="fas fa-ruler-combined text-primary d-block mb-1"></i>
                                            <strong class="d-block" style="font-size: 1rem;">{{ $dimensions }}</strong>
                                        </div>
                                        <div class="col-4">
                                            <i class="fas fa-palette text-info d-block mb-1"></i>
                                            <strong class="d-block" style="font-size: 1rem;">{{ $colors }} col</strong>
                                        </div>
                                        <div class="col-4">
                                            <i class="fas fa-th text-success d-block mb-1"></i>
                                            <strong class="d-block" style="font-size: 1rem;">{{ $stitches }}</strong>
                                        </div>
                                    </div>

                                    <div class="usage-status mt-3 badge badge-light border w-100 py-2 d-none text-left" style="font-size: 0.9rem;">
                                        <i class="fas fa-link mr-1 text-muted"></i> <span class="usage-text font-weight-bold text-dark"></span>
                                    </div>
                                </div>
                                <div class="check-overlay"><i class="fas fa-check-circle"></i></div>
                            </div>
                        </div>
                    @empty
                        <div class="col-12 text-center text-muted">No hay diseños disponibles</div>
                    @endforelse
                </div>
            </div>
        </div>
    </div>
</script>
            --}}

    {{-- STEP 5: SERVICIOS EXTRAS (DOS COLUMNAS) --}}
    <script type="text/template" id="tpl_step5">
    <div class="card shadow-sm border-0 mb-3">
        <div class="card-body p-4">
            <h5 class="step-title"><i class="fas fa-concierge-bell text-warning"></i> Servicios Adicionales</h5>
            <p class="step-description text-muted mb-0">
                <i class="fas fa-lightbulb text-warning mr-1"></i>
                Agrega servicios extras como <strong>armado</strong>, <strong>empaquetado especial</strong>, 
                <strong>etiquetado</strong>, etc. Estos costos se sumarán al precio final del producto.
            </p>
        </div>
    </div>
    <div class="row">
        {{-- LEFT COLUMN: Selector --}}
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white font-weight-bold">
                    <i class="fas fa-plus-circle text-success mr-2"></i>Agregar Servicios
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="font-weight-bold text-uppercase small">Seleccionar Servicio</label>
                        <select class="form-control select2" id="extrasSelector">
                            <option value="">Seleccionar servicio...</option>
                            @foreach($extras ?? [] as $extra)
                                <option value="{{ $extra->id }}" 
                                        data-price="{{ $extra->cost_addition }}" 
                                        data-name="{{ $extra->name }}"
                                        data-time="{{ $extra->minutes_addition ?? 0 }}">
                                    {{ $extra->name }} (+${{ number_format($extra->cost_addition, 2) }})
                                </option>
                            @endforeach
                        </select>
                    </div>
                    <button type="button" class="btn btn-success btn-block" onclick="addExtra()">
                        <i class="fas fa-plus-circle mr-2"></i> Agregar Servicio
                    </button>
                </div>
            </div>
        </div>

        {{-- RIGHT COLUMN: Table --}}
        <div class="col-md-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white font-weight-bold d-flex justify-content-between align-items-center">
                    <span>Lista de Servicios</span>
                    <span class="badge badge-pill badge-secondary" id="extrasCountBadge">0</span>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="thead-light">
                                <tr>
                                    <th>Servicio</th>
                                    <th class="text-right">Costo</th>
                                    <th class="text-center">Tiempo</th>
                                    <th class="text-center" style="width:60px;">Acción</th>
                                </tr>
                            </thead>
                            <tbody id="extrasTableBody">
                                <tr id="noExtrasRow">
                                    <td colspan="4" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                        No hay servicios agregados
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot class="bg-light font-weight-bold">
                                <tr>
                                    <td>TOTAL SERVICIOS</td>
                                    <td class="text-right" id="extrasTotalDisplay">$0.00</td>
                                    <td class="text-center" id="extrasTotalTime">0 min</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

    {{-- STEP 6: COSTEO Y CONFIRMACIÓN --}}
    <script type="text/template" id="tpl_step6">
    <div class="card shadow-sm border-0 review-premium-card">
        <div class="card-header review-premium-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-calculator mr-2"></i>Costeo Final y Confirmación</span>
            <span class="review-ready-badge"><i class="fas fa-rocket mr-1"></i> Listo para Crear</span>
        </div>
        <div class="card-body p-4">
            <p class="text-muted mb-4" style="font-size: 0.9rem;">
                Revisa el desglose de costos y define tu margen de ganancia. 
                <strong>Una vez creado</strong>, podrás editar el producto desde el catálogo.
            </p>
            
            <div class="row">
                {{-- LEFT COLUMN: CALCULADORA COMPLETA (Classic Style) --}}
                <div class="col-lg-9 pr-lg-4">
                    <div class="card calc-premium-card shadow-sm h-100">
                        <div class="card-header calc-premium-header text-center">
                            <h5 class="mb-0"><i class="fas fa-receipt mr-2"></i> Desglose de Costos</h5>
                        </div>
                        <div class="card-body p-3">
                            
                            <div class="row">
                                {{-- LEFT COLUMN: Materiales --}}
                                <div class="col-md-6">
                                    {{-- DESGLOSE DE MATERIALES --}}
                                    <div class="calc-section h-100">
                                        <div class="calc-section-header">
                                            <span class="calc-section-title"><i class="fas fa-boxes mr-2"></i>Materiales (Receta)</span>
                                            <span class="calc-section-value text-primary" id="finMatCost">$0.00</span>
                                        </div>
                                        <div id="finMaterialsList" class="calc-scroll-list" style="max-height: 380px; overflow-y: auto;">
                                            <span class="text-muted small">Sin materiales...</span>
                                        </div>
                                    </div>
                                </div>

                                {{-- RIGHT COLUMN: Bordados, Mano de Obra, Servicios --}}
                                <div class="col-md-6">
                                    {{-- BORDADOS --}}
                                    <div class="calc-section">
                                        <div class="calc-section-header">
                                            <span class="calc-section-title"><i class="fas fa-tshirt mr-2"></i>Bordados</span>
                                            <span class="calc-section-value text-primary" id="finEmbCost">$0.00</span>
                                        </div>
                                        {{-- Preview de diseños seleccionados --}}
                                        <div id="finDesignPreviews" class="d-flex flex-wrap gap-2 mb-2" style="gap: 8px;">
                                            <span class="text-muted small">Sin diseños seleccionados...</span>
                                        </div>
                                        <div class="calc-stitch-grid">
                                            <div class="calc-stitch-box">
                                                <div class="stitch-label">Total Puntadas</div>
                                                <div class="stitch-value" id="finTotalStitches">0</div>
                                            </div>
                                            <div class="calc-arrow"><i class="fas fa-arrow-right"></i></div>
                                            <div class="calc-stitch-box">
                                                <div class="stitch-label">Millares</div>
                                                <div class="stitch-value text-info" id="finMillares">0.000</div>
                                            </div>
                                            <div class="calc-arrow"><i class="fas fa-times"></i></div>
                                            <div class="calc-stitch-box calc-input-box">
                                                <div class="stitch-label">Precio / Millar</div>
                                                <div class="input-group input-group-sm">
                                                    <div class="input-group-prepend"><span class="input-group-text">$</span></div>
                                                    <input type="number" class="form-control text-center font-weight-bold" id="finStitchRate" value="1.00" step="0.01" min="0" onchange="recalcFinance()" oninput="recalcFinance()">
                                                </div>
                                            </div>
                                        </div>
                                        {{-- TIEMPO DE BORDADO --}}
                                        <div class="row mt-3">
                                            <div class="col-12 mb-2">
                                                <div class="d-flex align-items-center justify-content-between">
                                                    <span class="text-muted small mr-2 font-weight-bold" style="min-width: 80px; color: #1a252f;">Velocidad:</span>
                                                    <div class="input-group input-group-sm w-100">
                                                        <input type="number" class="form-control text-center font-weight-bold" id="finMachineSpeed" value="800" min="100" max="2000" step="50" onchange="recalcFinance()" oninput="recalcFinance()" style="font-size: 0.95rem;">
                                                        <div class="input-group-append"><span class="input-group-text small">p/min</span></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-12 text-right">
                                                <span class="text-muted small font-weight-bold" style="color: #1a252f;">Tiempo Estimado:</span>
                                                <span class="font-weight-bold text-success ml-2" id="finEmbroideryTime" style="font-size: 1.1rem;">0 min</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {{-- MANO DE OBRA --}}
                                    <div class="calc-section">
                                        <div class="calc-section-header">
                                            <span class="calc-section-title"><i class="fas fa-hand-holding-usd mr-2"></i>Mano de Obra</span>
                                            <span class="calc-section-value text-primary" id="finLaborCostDisplay">$0.00</span>
                                        </div>
                                        <div class="row align-items-center">
                                            <div class="col-8">
                                                <div class="input-group input-group-sm">
                                                    <div class="input-group-prepend"><span class="input-group-text">$</span></div>
                                                    <input type="number" class="form-control font-weight-bold" id="finLaborInput" value="" placeholder="0.00" step="0.01" min="0" onchange="recalcFinance()" oninput="recalcFinance()">
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <small class="text-muted">Corte, confección, etc.</small>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {{-- SERVICIOS EXTRAS --}}
                                    <div class="calc-section">
                                        <div class="calc-section-header">
                                            <span class="calc-section-title"><i class="fas fa-concierge-bell mr-2"></i>Servicios Extras</span>
                                            <span class="calc-section-value text-primary" id="finExtrasTotal">$0.00</span>
                                        </div>
                                        <div id="finExtrasList" class="calc-scroll-list" style="max-height: 150px; overflow-y: auto;">
                                            <span class="text-muted small">Sin servicios agregados...</span>
                                        </div>
                                        <div class="d-flex justify-content-end mt-2 pt-2 border-top">
                                            <span class="text-muted mr-2">Tiempo Estimado:</span>
                                            <span class="font-weight-bold text-info" id="finExtrasTime">0 min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>                            
                        </div>
                    </div>
                </div>
                
                {{-- RIGHT COLUMN: Financial Summary + Editable Controls --}}
                <div class="col-lg-3">
                    <div class="review-finance-card">
                        <div class="review-finance-header">
                            <i class="fas fa-calculator mr-2"></i> Resumen Financiero
                        </div>
                        <div class="review-finance-body">
                            {{-- Cost Breakdown --}}
                            <div class="review-cost-row-lg">
                                <span>Materiales</span>
                                <span id="revMatCost">$0.00</span>
                            </div>
                            <div class="review-cost-row-lg">
                                <span>Bordados</span>
                                <span id="revEmbCost">$0.00</span>
                            </div>
                            <div class="review-cost-row-lg">
                                <span>Mano de Obra</span>
                                <span id="revLaborCost">$0.00</span>
                            </div>
                            <div class="review-cost-row-lg">
                                <span>Servicios Extras</span>
                                <span id="revExtraCost">$0.00</span>
                            </div>
                            
                            {{-- Total Cost Line --}}
                            <div class="review-total-row">
                                <span>COSTO TOTAL PRODUCCIÓN</span>
                                <span id="revTotalCost">$0.00</span>
                            </div>
                        </div>
                        
                        {{-- TIEMPOS DE PRODUCCIÓN --}}
                        <div class="review-finance-header mt-3 rounded-top">
                            <span class="mb-0 font-weight-bold"><i class="fas fa-clock mr-2"></i>Tiempos Estimados</span>
                        </div>
                        <div class="review-times-section px-3 py-3 border border-top-0 rounded-bottom mb-3" style="background: white;">

                            <div class="d-flex justify-content-between mb-1" style="font-size: 0.95rem;">
                                <span>Bordado:</span>
                                <span class="font-weight-bold" id="revEmbTime">0 min</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1" style="font-size: 0.95rem;">
                                <span>Servicios Extras:</span>
                                <span class="font-weight-bold" id="revExtrasTime">0 min</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2" style="font-size: 1rem;">
                                <span class="font-weight-bold">Total Proceso:</span>
                                <span class="font-weight-bold text-success" id="revTotalTime">0 min</span>
                            </div>
                            <div class="form-group mb-0 text-center">
                                <label class="small text-uppercase mb-1 font-weight-bold text-dark">Tiempo Producción (días)</label>
                                <input type="number" class="form-control form-control-sm text-center" id="revLeadTime" name="production_lead_time" value="1" min="1" max="365" placeholder="Días">
                            </div>
                        </div>
                        
                        {{-- MARGEN Y PRECIO --}}
                        <div class="review-finance-header rounded-top">
                            <span class="mb-0 font-weight-bold"><i class="fas fa-hand-holding-usd mr-2"></i>Rentabilidad y Precio</span>
                        </div>
                        <div class="review-pricing-controls px-3 py-3 border border-top-0 rounded-bottom" style="background: white;">
                             <div class="row mb-3">
                                <div class="col-12 mb-2">
                                    <label class="small text-uppercase font-weight-bold mb-1">Margen de Ganancia</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control font-weight-bold text-center" id="revMarginInput" value="35" min="0" max="90" step="1" onchange="recalcReviewPrice()" oninput="recalcReviewPrice()" style="height: 48px; font-size: 1.1rem;">
                                        <div class="input-group-append"><span class="input-group-text font-weight-bold">%</span></div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="bg-success text-white rounded p-1 d-flex align-items-center justify-content-between shadow-sm" style="height: 48px;">
                                        <span class="small font-weight-bold px-3 text-uppercase">Precio Sugerido:</span>
                                        <span class="h3 mb-0 font-weight-bold px-3" id="revSuggestedPrice">$0.00</span>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group mb-0">
                                <label class="small text-uppercase mb-1">Precio Final (Personalizado)</label>
                                <div class="input-group">
                                    <div class="input-group-prepend"><span class="input-group-text">$</span></div>
                                    <input type="number" class="form-control" id="revFinalPrice" name="base_price" step="0.01" placeholder="Igual al sugerido" onchange="updateHeaderPrice()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

@stop

@section('css')
    <style>
        /* ESTILOS ENTERPRISE */
        :root {
            --primary-ent: #2c3e50;
            --accent-ent: #3498db;
            --success-ent: #27ae60;
        }

        /* Bootstrap 4 gap utility polyfill */
        .gap-1 {
            gap: 0.25rem;
        }

        .gap-2 {
            gap: 0.5rem;
        }

        .gap-3 {
            gap: 1rem;
        }

        /* ========================================= */
        /* PREMIUM CALCULATOR STYLES                */
        /* ========================================= */

        .calc-premium-card {
            border: none !important;
            border-radius: 16px !important;
            overflow: hidden;
        }

        .calc-premium-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: #fff;
            padding: 14px 20px;
            border: none !important;
        }

        .calc-premium-header h5 {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Calculator Section Base */
        .calc-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 14px 16px;
            margin-bottom: 10px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .calc-section-compact {
            padding: 10px 16px;
        }

        .calc-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calc-section-compact .calc-section-header {
            margin-bottom: 0;
        }

        .calc-section-title {
            font-size: 1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #1a252f;
        }

        .calc-section-title i {
            color: inherit;
        }

        .calc-section-value {
            font-size: 1.15rem;
            font-weight: 700;
        }

        /* Materials scroll list - adequate space */
        .calc-scroll-list {
            max-height: 180px;
            overflow-y: auto;
            background: #fff;
            border-radius: 8px;
            padding: 10px 12px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .calc-scroll-list::-webkit-scrollbar {
            width: 6px;
        }

        .calc-scroll-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .calc-scroll-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

        .calc-scroll-list::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }

        /* Material Item - Compact Layout */
        .calc-material-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .calc-material-item:last-child {
            border-bottom: none;
        }

        .calc-mat-name {
            font-weight: 700;
            font-size: 1rem;
            color: #1a252f;
            margin-bottom: 4px;
        }

        .calc-mat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calc-mat-qty {
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .calc-mat-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a252f;
        }

        .calc-mat-scope {
            font-size: 0.85rem;
            color: #34495e;
            margin-top: 2px;
        }

        /* Stitch Grid - Millares Display */
        .calc-stitch-grid {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            /* Allow wrapping on small screens/long text */
            gap: 12px;
            /* Increased gap */
            background: #fff;
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .calc-stitch-box {
            flex: 1 1 120px;
            /* Base width */
            text-align: center;
            padding: 10px 8px;
            background: #f8f9fa;
            border-radius: 6px;
            min-width: 0;
        }

        .calc-input-box {
            background: #e3f2fd;
        }

        .stitch-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            color: #1a252f;
            font-weight: 600;
            margin-bottom: 4px;
            white-space: nowrap;
        }

        .stitch-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1a252f;
            line-height: 1.2;
        }

        .calc-arrow {
            color: #bdc3c7;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .calc-formula-hint {
            font-size: 0.9rem;
            color: #2c3e50;
            background: rgba(52, 152, 219, 0.12);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
            font-weight: 500;
        }

        /* Total Box */
        .calc-total-box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: #fff;
            border-radius: 10px;
            padding: 14px 18px;
            margin-bottom: 10px;
        }

        .calc-total-label {
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calc-total-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        /* Pricing Row */
        .calc-pricing-row {
            display: flex;
            gap: 12px;
            margin-bottom: 10px;
        }

        .calc-margin-box {
            flex: 0 0 120px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }

        .calc-margin-label {
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #1a252f;
            margin-bottom: 6px;
            display: block;
        }

        .calc-suggested-box {
            flex: 1;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calc-suggested-label {
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .calc-suggested-value {
            font-size: 1.4rem;
            font-weight: 700;
        }

        /* Final Price Box */
        .calc-final-box {
            background: #fff;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 12px 16px;
        }

        .calc-final-label {
            font-size: 1rem;
            font-weight: 700;
            color: #1a252f;
            margin-bottom: 8px;
            display: block;
            text-align: center;
        }

        .calc-final-box .input-group {
            max-width: 200px;
            margin: 0 auto;
        }

        /* Override form heights for calculator inputs */
        .calc-section input.form-control,
        .calc-margin-box input.form-control,
        .calc-final-box input.form-control {
            height: 36px !important;
            min-height: 36px !important;
            font-size: 0.95rem !important;
        }

        .calc-stitch-box .input-group-text {
            height: 32px !important;
            padding: 0 8px !important;
            font-size: 0.85rem !important;
        }

        .calc-stitch-box input.form-control {
            height: 32px !important;
            min-height: 32px !important;
            font-size: 0.9rem !important;
        }

        /* ========================================= */
        /* PREMIUM REVIEW STEP STYLES               */
        /* ========================================= */

        .review-premium-card {
            border: none !important;
            border-radius: 16px !important;
            overflow: hidden;
        }

        .review-premium-header {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
            padding: 14px 20px;
            border: none !important;
        }

        .review-ready-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Product Section */
        .review-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 14px 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .review-section-header {
            margin-bottom: 10px;
        }

        .review-section-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #6c757d;
        }

        .review-product-card {
            background: #fff;
            border-radius: 8px;
            padding: 12px 16px;
            border: 1px solid rgba(0, 0, 0, 0.08);
        }

        .review-product-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        .review-product-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .review-meta-item {
            font-size: 0.85rem;
        }

        .review-meta-label {
            color: #6c757d;
            margin-right: 4px;
        }

        .review-meta-item code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        /* Compact 3-column sections */
        .review-compact-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
            height: 100%;
        }

        .review-compact-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #6c757d;
        }

        .review-compact-header i {
            font-size: 0.9rem;
        }

        .review-count-badge {
            background: #2c3e50;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: auto;
        }

        .review-compact-list {
            max-height: 120px;
            overflow-y: auto;
            background: #fff;
            border-radius: 6px;
            padding: 8px;
            font-size: 0.8rem;
        }

        .review-compact-list::-webkit-scrollbar {
            width: 4px;
        }

        .review-compact-list::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }

        /* Extras section */
        .review-extras-section {
            padding: 10px 16px;
        }

        .review-extras-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        /* Financial Card */
        .review-finance-card {
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .review-finance-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: #fff;
            padding: 12px 16px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .review-finance-body {
            padding: 12px 16px;
        }

        .review-cost-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.95rem;
        }

        .review-cost-row span:first-child {
            color: #495057;
        }

        .review-cost-row span:last-child {
            font-weight: 600;
            color: #2c3e50;
        }

        .review-total-row {
            display: flex;
            justify-content: space-between;
            background: #2c3e50;
            color: #fff;
            margin: 12px -16px;
            padding: 12px 16px;
            font-weight: 600;
        }

        .review-total-row span:first-child {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .review-total-row span:last-child {
            font-size: 1.1rem;
        }

        .review-margin-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 0.95rem;
            color: #495057;
        }

        .review-margin-row span:last-child {
            font-weight: 600;
            color: #2c3e50;
        }

        /* Review Cost Row - Larger Text */
        .review-cost-row-lg {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f1f1f1;
            font-size: 1rem;
        }

        .review-cost-row-lg span:first-child {
            color: #495057;
            font-weight: 500;
        }

        .review-cost-row-lg span:last-child {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.05rem;
        }

        /* Pricing Controls Section */
        .review-pricing-controls {
            padding: 16px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .pricing-row {
            margin-bottom: 16px;
        }

        .pricing-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 6px;
        }

        .pricing-input-group {
            display: flex;
            align-items: center;
        }

        .pricing-input {
            width: 80px;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            border-radius: 8px 0 0 8px !important;
        }

        .pricing-suffix {
            background: #e9ecef;
            padding: 10px 14px;
            border: 1px solid #ced4da;
            border-left: none;
            border-radius: 0 8px 8px 0;
            font-weight: 600;
            color: #495057;
        }

        .pricing-prefix {
            background: #27ae60;
            color: #fff;
            padding: 10px 14px;
            border: 1px solid #27ae60;
            border-radius: 8px 0 0 8px;
            font-weight: 600;
        }

        .pricing-input-lg {
            flex: 1;
            font-size: 1.3rem;
            font-weight: 700;
            text-align: center;
            border-radius: 0 8px 8px 0 !important;
        }

        .pricing-suggested {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .pricing-suggested-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pricing-suggested-value {
            color: #fff;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .pricing-row-final {
            margin-bottom: 0;
        }

        .pricing-input-primary {
            border: 2px solid #27ae60;
            border-radius: 8px;
            overflow: hidden;
        }

        .review-price-row {
            display: flex;
            justify-content: space-between;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: #fff;
            margin: 12px -16px -12px -16px;
            padding: 14px 16px;
            font-weight: 700;
        }

        .review-price-row span:first-child {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .review-price-row span:last-child {
            font-size: 1.4rem;
        }

        /* Review Items - Compact */
        .review-item-pill {
            display: inline-block;
            background: #e9ecef;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            margin: 2px;
            color: #495057;
        }

        .review-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .review-item-row:last-child {
            border-bottom: none;
        }

        .review-item-name {
            color: #2c3e50;
            font-weight: 500;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .review-item-qty {
            color: #6c757d;
            font-size: 0.75rem;
            margin-left: 8px;
            white-space: nowrap;
        }

        .review-item-badge {
            color: #6c757d;
            font-size: 0.7rem;
            white-space: nowrap;
        }

        /* Bordados - Design Items */
        .review-design-item {
            padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .review-design-item:last-child {
            border-bottom: none;
        }

        .review-design-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .review-design-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .review-design-info span:last-child {
            font-weight: 500;
            color: #27ae60;
        }

        /* Extras - Plain Vertical List */
        .review-extra-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.85rem;
        }

        .review-extra-item:last-child {
            border-bottom: none;
        }

        .review-extra-item span:first-child {
            color: #495057;
        }

        .review-extra-item span:last-child {
            font-weight: 600;
            color: #2c3e50;
        }

        /* INLINE SCOPE BUTTONS (NEW - for BOM form) */
        .scope-inline-btn {
            transition: all 0.2s ease;
        }

        .scope-inline-btn.active {
            background: var(--accent-ent) !important;
            border-color: var(--accent-ent) !important;
            color: #fff !important;
        }

        /* SCOPE TOGGLE BUTTONS (Modal) */
        .scope-toggle-btn {
            background: #fff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 0 8px;
        }

        .scope-toggle-btn:hover {
            border-color: var(--accent-ent, #3498db);
            color: var(--accent-ent, #3498db);
        }

        .scope-toggle-btn.active {
            background: var(--accent-ent, #3498db);
            border-color: var(--accent-ent, #3498db);
            color: #fff;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }

        /* POSITION OPTIONS (Design Modal) */
        .position-option {
            cursor: pointer;
            transition: all 0.2s ease;
            color: #6c757d;
        }

        .position-option:hover {
            border-color: var(--accent-ent) !important;
            color: var(--accent-ent);
        }

        .position-option.active {
            border-color: #17a2b8 !important;
            background: rgba(23, 162, 184, 0.1);
            color: #17a2b8;
        }

        .position-option.active i {
            color: #17a2b8;
        }

        /* Design Scope Buttons */
        .design-scope-btn.active {
            background: #17a2b8 !important;
            border-color: #17a2b8 !important;
            color: #fff !important;
        }

        /* FIX: Hide AdminLTE footer on this page to remove white space at bottom */
        .main-footer {
            display: none !important;
        }

        /* Ensure wrapper takes full height but no more */
        .content-wrapper {
            min-height: 100vh !important;
            padding-bottom: 0 !important;
        }

        .module-header {
            background: linear-gradient(135deg, var(--primary-ent), #34495e);
            padding: 2rem;
            border-radius: 0 0 15px 15px;
            margin-bottom: 2rem;
        }

        .live-cost-badge {
            background: rgba(0, 0, 0, 0.3);
            padding: 5px 15px;
            border-radius: 20px;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Select2 Customization for internal Clear Button */
        /* Select2 Customization for internal Clear Button */
        .select2-selection--multiple {
            padding-right: 30px !important;
        }

        .select2-selection--single .select2-selection__rendered {
            padding-right: 45px !important;
            /* increased to fit X + arrow */
        }

        /* PREMIUM INTERNAL CLEAR BUTTON */
        .clear-btn-internal {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 50;
            cursor: pointer;
            color: #bdc3c7;
            /* Subtle default */
            font-size: 0.95rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* For Single Selects with Arrow: Move X left */
        .clear-btn-single-offset {
            right: 30px !important;
        }

        .clear-btn-internal:hover {
            transform: translateY(-50%) scale(1.15);
            color: #c0392b;
        }

        .live-cost-badge .value {
            font-weight: 700;
            color: #2ecc71;
            margin-left: 5px;
        }

        /* STEPPER NAVIGATION CONTAINER (Carousel Style) */
        .stepper-nav-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 2rem;
            padding: 0 10px;
        }

        /* PREMIUM CAROUSEL ARROWS */
        .stepper-arrow {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #dee2e6;
            background: #fff;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            flex-shrink: 0;
        }

        .stepper-arrow:hover:not(:disabled) {
            background: var(--accent-ent, #3498db);
            border-color: var(--accent-ent, #3498db);
            color: #fff;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        }

        .stepper-arrow:active:not(:disabled) {
            transform: scale(0.95);
        }

        .stepper-arrow:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background: #f8f9fa;
        }

        .stepper-arrow i {
            font-size: 1.2rem;
        }

        .stepper-arrow-next.btn-success-mode {
            background: var(--success-ent, #27ae60) !important;
            border-color: var(--success-ent, #27ae60) !important;
            color: #fff !important;
            animation: pulse-success 1.5s infinite;
        }

        @keyframes pulse-success {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.4);
            }

            50% {
                box-shadow: 0 0 0 10px rgba(39, 174, 96, 0);
            }
        }

        /* STEPPER */
        .stepper-wrapper {
            display: flex;
            justify-content: space-between;
            position: relative;
            padding: 0 10px;
            flex: 1;
            max-width: 800px;
        }

        .stepper-wrapper::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 40px;
            right: 40px;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

        .stepper-item {
            position: relative;
            z-index: 1;
            text-align: center;
            width: 80px;
            opacity: 0.6;
            transition: all 0.3s;
        }

        .stepper-item.active {
            opacity: 1;
            transform: scale(1.1);
        }

        .stepper-item.completed .step-counter {
            background: var(--success-ent);
            border-color: var(--success-ent);
            color: white;
        }

        .step-counter {
            width: 35px;
            height: 35px;
            background: #fff;
            border: 2px solid #bdc3c7;
            border-radius: 50%;
            margin: 0 auto 5px;
            line-height: 31px;
            font-weight: bold;
            color: #7f8c8d;
            transition: all 0.3s;
        }

        .stepper-item.active .step-counter {
            border-color: var(--accent-ent);
            color: var(--accent-ent);
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.2);
        }

        .step-name {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* CARDS & COMPONENTS */
        .card-radio label {
            cursor: pointer;
            padding: 10px 20px;
            border: 2px solid #eee;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .custom-control-input:checked~.custom-control-label::before {
            background-color: var(--accent-ent);
            border-color: var(--accent-ent);
        }

        .card-radio input:checked+label {
            border-color: var(--accent-ent);
            background: rgba(52, 152, 219, 0.05);
            color: var(--accent-ent);
        }

        .fade-in {
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .badge-scope-global {
            background: #e8f6f3;
            color: #1abc9c;
            border: 1px solid #1abc9c;
        }

        .badge-scope-specific {
            background: #fef9e7;
            color: #f1c40f;
            border: 1px solid #f1c40f;
        }

        /* DESIGN GRID */
        .design-card {
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            position: relative;
        }

        .design-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .design-card.selected {
            border-color: var(--accent-ent);
            background: #f0f8ff;
        }

        .check-overlay {
            position: absolute;
            top: 5px;
            right: 5px;
            color: var(--success-ent);
            font-size: 1.2rem;
            display: none;
        }

        .design-card.selected .check-overlay {
            display: block;
        }

        .stop-propagation {
            cursor: not-allowed !important;
            pointer-events: none !important;
        }

        .opacity-50 {
            opacity: 0.5 !important;
        }

        /* --- VISUAL NORMALIZATION (FIX) --- */

        /* Define consistent height / visual variables locally if needed, or just use values */

        /* GLOBAL: Force same height for all interactive elements in forms */
        input.form-control,
        select.form-control,
        .btn-block,
        /* Target the 'Generar' button */
        .select2-container .select2-selection--single,
        .select2-container .select2-selection--multiple {
            height: 45px !important;
            /* Premium height, consistent for ALL */
            min-height: 45px !important;
            display: flex !important;
            align-items: center !important;
            font-size: 0.95rem !important;
            border-radius: 8px !important;
        }

        /* Ensure Textareas maintain their own height/rows */
        textarea.form-control {
            height: auto !important;
            min-height: 100px;
            padding: 12px !important;
            font-size: 0.95rem !important;
            align-items: flex-start !important;
        }

        /* Button specific alignment */
        .btn {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 600 !important;
            letter-spacing: 0.5px !important;
            text-transform: uppercase !important;
            font-size: 0.85rem !important;
        }

        /* --- PREMIUM SELECT2 BUTTONS (NUCLEAR FIX) --- */

        /* 1. Ensure space for the button in the text container */
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            padding-right: 40px !important;
            line-height: 45px !important;
            /* Match height */
            padding-left: 10px !important;
            color: #495057 !important;
        }

        /* 2. Hide the original 'x' text container completely */
        .select2-container--default .select2-selection--single .select2-selection__clear {
            position: absolute !important;
            right: 10px !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
            height: 24px !important;
            width: 24px !important;
            padding: 0 !important;
            margin: 0 !important;
            margin-right: 0 !important;
            font-size: 16px !important;
            line-height: 24px !important;
            color: #ccc !important;
        }

        /* --- STEP 6 UI POLISH OVERRIDES --- */

        /* Variants - Vertical List with Gray Outline */
        .review-variant-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f8f9fa;
        }

        .review-variant-text {
            font-weight: 600;
            color: #343a40;
            font-size: 1rem;
        }

        .review-variant-sku {
            font-size: 0.85rem;
            color: #6c757d;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Material Items - Compact Row */
        .review-item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .review-item-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .review-item-qty {
            font-weight: 700;
            color: #343a40;
            font-size: 1rem;
            margin-left: 10px;
        }

        /* Design Items - Larger Text */
        .review-design-item {
            padding: 10px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .review-design-name {
            font-weight: 700;
            font-size: 1.05rem;
            color: #2c3e50;
            margin-bottom: 6px;
        }

        .review-design-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.95rem;
            color: #6c757d;
        }

        /* Extras - Vertical Column Name - Price */
        .review-extra-item {
            display: flex;
            flex-direction: column;
            padding: 10px 0;
            border-bottom: 1px solid #f1f1f1;
            margin-bottom: 6px;
        }

        .review-extra-item:last-child {
            border-bottom: none;
        }

        .review-extra-name {
            font-size: 1rem;
            color: #495057;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .review-extra-price {
            font-weight: 700;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__clear {
            visibility: hidden !important;
            /* HIde the text 'x' */

            background-color: rgba(231, 76, 60, 0.1) !important;
            border-radius: 50% !important;
            z-index: 100 !important;
        }

        /* 3. Show the ICON using visibility: visible on pseudo-element */
        .select2-container--default .select2-selection--single .select2-selection__clear::after {
            content: "\f00d";

            /* Extras Grid Layout */
        }

        .review-extras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            width: 100%;
        }

        .review-extra-item {
            border-bottom: none !important;
            margin-bottom: 0 !important;
        }

        .review-extra-inline {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
            text-transform: uppercase;
        }

        /* fa-times */
        font-family: "Font Awesome 5 Free";
        font-weight: 900;
        font-size: 13px !important;
        color: #e74c3c !important;

        visibility: visible !important;
        /* FORCE VISIBILITY */
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        width: 100% !important;
        height: 100% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__clear:hover {
            background-color: #e74c3c !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__clear:hover::after {
            color: white !important;
        }

        /* Fix Arrow Position */
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 43px !important;
            /* Slightly less than container */
            top: 1px !important;
            right: 10px !important;
        }

        /* --- MULTIPLE SELECT FIXES --- */

        /* Container style */
        .select2-container--default .select2-selection--multiple {
            border: 1px solid #ced4da !important;
            /* Standard Bootstrap Border */
            background-color: #ffffff !important;
            /* White background (was gray) */
            padding-bottom: 0px !important;
            padding-top: 0px !important;
            transition: all 0.2s;
            overflow: hidden !important;
        }

        /* HIDE the container-level clear button (phantom X on left) */
        .select2-container--default .select2-selection--multiple .select2-selection__clear {
            display: none !important;
        }

        .select2-container--default.select2-container--focus .select2-selection--multiple {
            border-color: #80bdff !important;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
        }

        /* Fix Multiple rendered chips alignment */
        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            display: flex !important;
            align-items: center !important;
            flex-wrap !important;
            padding-left: 5px !important;
            min-height: 45px !important;
            /* Match container */
        }

        /* Choice (Chip) Style */
        /* Choice (Chip) Style */
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            background-color: var(--primary-ent, #2c3e50) !important;
            color: white !important;
            border: 1px solid #1a252f !important;
            border-radius: 4px !important;
            /* Standard Rouded Rect */
            padding: 2px 8px !important;
            font-size: 0.9rem !important;
            margin: 4px !important;
            display: inline-flex !important;
            align-items: center !important;
            flex-direction: row-reverse !important;
            /* Text Left, X Right */
            height: 28px !important;
            line-height: 1.5 !important;
        }

        /* Ensure inner text respects truncation */
        .select2-container--default .select2-selection--multiple .select2-selection__choice>span {
            margin-right: 8px !important;
            /* Space between text and X */
        }

        /* Clean Remove Button (X) */
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            color: rgba(255, 255, 255, 0.7) !important;
            font-weight: bold !important;
            font-size: 14px !important;
            border: none !important;
            background: transparent !important;
            /* Spacing from text */
            margin-right: 0 !important;
            margin-left: 8px !important;
            padding: 0 !important;
            cursor: pointer !important;
            transition: color 0.2s;
        }

        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove:hover {
            color: white !important;
            background: transparent !important;
        }

        /* Standardize labels */
        label {
            font-size: 0.8rem !important;
            font-weight: 700 !important;
            letter-spacing: 0.5px;
            color: #5a6268;
            margin-bottom: 6px !important;
            text-transform: uppercase;
        }



        /* Custom Dropzone Styles */
        .custom-dropzone {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background-color: #f8f9fa;
            transition: all 0.2s ease;
            height: 100% !important;
            /* Forces fill */
            min-height: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            /* Clickable area */
        }

        .custom-dropzone:hover,
        .custom-dropzone.dragover {
            border-color: #3490dc;
            background-color: #ebf8ff;
        }

        /* Prevent button clicks from triggering dropzone click */
        .custom-dropzone button {
            z-index: 10;
        }

        #dropzonePreview {
            width: 100%;
        }

        .clear-btn-internal {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            color: #bdc3c7;
            cursor: pointer;
            z-index: 10;
        }

        .clear-btn-internal:hover {
            color: #e74c3c;
        }

        /* --- RESPONSIVE STEPPER FOR MOBILE --- */
        @media (max-width: 768px) {
            .stepper-wrapper {
                padding: 15px 5px !important;
                border-radius: 12px !important;
            }

            #stepperContainer {
                display: flex !important;
                flex-wrap: nowrap !important;
                /* Fit everything on screen, no scroll needed if possible */
                overflow-x: hidden !important;
                justify-content: space-between !important;
                padding-bottom: 0px;
                width: 100% !important;
            }

            .stepper-item {
                flex: 0 0 auto !important;
                margin: 0 2px !important;
                /* Minimal margin to fit 6 items */
                width: auto !important;
                transform: scale(0.9);
                /* Slightly smaller circles if needed */
            }

            .step-name {
                display: none !important;
            }

            .stepper-arrow {
                display: none !important;
            }

            /* Hide the connector line to avoid visual clutter */
            .stepper-item::after {
                display: none !important;
            }
        }

        /* --- FIX BOTTOM SPACING --- */
        .content-wrapper {
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
        }

        .main-footer {
            display: none !important;
            height: 0 !important;
            padding: 0 !important;
            margin: 0 !important;
        }
    </style>
@stop

@section('js')
    <script>
        // Global flag to control when to re-render design previews (avoids flickering)
        let shouldRenderDesigns = false;

        // --- STATE MANAGEMENT ---
        const State = {
            step: 1,
            definition: {},
            variants: [],
            bom: [],
            designs: [], // {id, name, stitches, position}
            extras: [], // {id, name, price}
            financials: {
                material_cost: 0,
                embroidery_cost: 0,
                extras_cost: 0,
                labor_cost: 0, // NEW
                total_cost: 0,
                margin: 35,
                price: 0
            }
        };

        // Flag for async validation bypass
        let bypassBomValidation = false;

        // === STEPPER NAVIGATION SYSTEM ===
        const TOTAL_STEPS = 6;
        let maxVisitedStep = 1; // Track the furthest step visited

        // Navigate directly to a specific step (clicking on step numbers)
        window.navigateToStep = function(targetStep) {
            console.log('navigateToStep called:', targetStep, 'current:', State.step, 'maxVisited:', maxVisitedStep);

            if (targetStep < 1 || targetStep > TOTAL_STEPS) return;
            if (targetStep === State.step) return; // Already on this step

            // Going BACKWARD is always allowed
            if (targetStep < State.step) {
                goToStep(targetStep);
                return;
            }

            // Going FORWARD only if we've visited that step before
            if (targetStep <= maxVisitedStep) {
                goToStep(targetStep);
            }
        };

        // Navigate by direction (-1 = prev, +1 = next)
        window.navigate = function(direction) {
            const newStep = State.step + direction;
            if (newStep < 1 || newStep > TOTAL_STEPS) return;

            // Validate current step before moving forward
            if (direction > 0 && !validateStep(State.step)) {
                return;
            }

            goToStep(newStep);
        };

        // Core function to switch steps
        function goToStep(targetStep) {
            // Run step-specific exit logic
            onStepExit(State.step);

            // CRITICAL: Hide ALL step contents first (prevents multiple visible steps)
            for (let i = 1; i <= TOTAL_STEPS; i++) {
                $(`#step${i}-content`).addClass('d-none');
            }

            // Update state
            State.step = targetStep;

            // Track furthest step visited (for click navigation)
            if (targetStep > maxVisitedStep) {
                maxVisitedStep = targetStep;
            }

            // Show only the target step content
            $(`#step${targetStep}-content`).removeClass('d-none');

            // Run step-specific enter logic
            onStepEnter(targetStep);

            // Update visual stepper
            updateStepper();

            // Update navigation buttons
            updateButtons();

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // Update stepper visual indicators
        function updateStepper() {
            $('.stepper-item').each(function() {
                const stepNum = parseInt($(this).data('step'));
                $(this).removeClass('active completed');

                if (stepNum === State.step) {
                    $(this).addClass('active');
                } else if (stepNum < State.step) {
                    $(this).addClass('completed');
                }
            });
        }

        // Update prev/next button states
        function updateButtons() {
            // Prev button
            if (State.step === 1) {
                $('#btnPrev').prop('disabled', true);
            } else {
                $('#btnPrev').prop('disabled', false);
            }

            // Next button - on last step, change to submit mode
            if (State.step === TOTAL_STEPS) {
                $('#btnNext').addClass('btn-success-mode')
                    .html('<i class="fas fa-check"></i>');
                $('#btnNext').off('click').on('click', function() {
                    submitForm();
                });
            } else {
                $('#btnNext').removeClass('btn-success-mode')
                    .html('<i class="fas fa-chevron-right"></i>');
                $('#btnNext').off('click').on('click', function() {
                    navigate(1);
                });
            }
        }

        // Step validation
        function validateStep(step) {
            switch (step) {
                case 1:
                    // Validate product definition
                    const name = $('#inpName').val().trim();
                    const sku = $('#inpSku').val().trim();
                    if (!name) {
                        Swal.fire('Error', 'El nombre del producto es requerido', 'error');
                        return false;
                    }
                    if (!sku) {
                        Swal.fire('Error', 'El SKU es requerido', 'error');
                        return false;
                    }
                    // Save to state
                    State.definition.name = name;
                    State.definition.sku = sku;
                    State.definition.category = $('#inpCategory option:selected').text();
                    State.definition.category_id = $('#inpCategory').val();
                    return true;
                case 2:
                    // At least one variant ideally
                    if (State.variants.length === 0) {
                        Swal.fire({
                            title: '¿Continuar sin variantes?',
                            text: 'No has agregado presentaciones. ¿Deseas continuar?',
                            icon: 'question',
                            showCancelButton: true,
                            confirmButtonText: 'Sí, continuar',
                            cancelButtonText: 'Agregar variantes'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                goToStep(3);
                            }
                        });
                        return false;
                    }
                    return true;
                case 3:
                    // BOM can be optional
                    return true;
                case 4:
                    // Designs can be optional
                    return true;
                case 5:
                case 5:
                    // Validation for step 5 if needed (currently none)
                    return true;
                default:
                    return true;
            }
        }

        // Step enter logic
        function onStepEnter(step) {
            switch (step) {
                case 5:
                    recalcFinance();
                    break;
                case 6:
                    shouldRenderDesigns = true; // Ensure designs render on direct entry
                    recalcFinance();
                    renderReview();
                    validateMaterialPrices();
                    break;
            }
        }

        // Helper: Check Prices (Promise) - Enterprise JIT Validation
        window.checkMaterialPrices = function() {
            return new Promise((resolve, reject) => {
                if (State.bom.length === 0) {
                    resolve({
                        has_changes: false,
                        changes: []
                    });
                    return;
                }

                const materials = State.bom.map(m => ({
                    id: m.material_id,
                    price: m.price
                }));

                $.ajax({
                    url: '/admin/products/validate-prices',
                    method: 'POST',
                    headers: {
                        'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                    },
                    data: {
                        materials: materials
                    },
                    success: function(res) {
                        resolve(res);
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            });
        };

        // Validate Material Prices Function
        window.validateMaterialPrices = function() {
            if (State.bom.length === 0) return;

            const materials = State.bom.map(m => ({
                id: m.material_id,
                price: m.price
            }));

            $.ajax({
                url: '/admin/products/validate-prices',
                method: 'POST',
                headers: {
                    'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
                },
                data: {
                    materials: materials
                },
                success: function(res) {
                    if (res.has_changes) {
                        let html =
                            '<div class="text-left small mb-3"><div class="font-weight-bold mb-2">Han cambiado precios de materiales:</div><ul class="pl-3">';
                        res.changes.forEach(c => {
                            const diff = c.diff > 0 ? `+${c.diff.toFixed(2)}` : c.diff.toFixed(2);
                            const color = c.diff > 0 ? 'text-danger' : 'text-success';
                            html +=
                                `<li><strong>${c.name}</strong>: $${c.old_price.toFixed(2)} → $${c.new_price.toFixed(2)} <span class="${color}">(${diff})</span></li>`;
                        });
                        html += '</ul><p>¿Deseas actualizar los costos con los precios nuevos?</p></div>';

                        Swal.fire({
                            title: 'Actualización de Costos',
                            html: html,
                            icon: 'info',
                            showCancelButton: true,
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            confirmButtonText: 'Sí, actualizar costos',
                            cancelButtonText: 'Mantener mis precios'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                let updatedCount = 0;
                                res.changes.forEach(change => {
                                    // Search by material_id (check type consistency)
                                    const mat = State.bom.find(m => m.material_id == change
                                        .id);
                                    if (mat) {
                                        mat.price = parseFloat(change.new_price);
                                        // Recalculate total for this item
                                        mat.calculated_total = (mat.qty * mat.price);
                                        updatedCount++;
                                    }
                                });

                                if (updatedCount > 0) {
                                    recalcFinance();
                                    renderReview();
                                    const Toast = Swal.mixin({
                                        toast: true,
                                        position: 'top-end',
                                        showConfirmButton: false,
                                        timer: 3000
                                    });
                                    Toast.fire({
                                        icon: 'success',
                                        title: 'Costos actualizados correctamente'
                                    });
                                }
                            }
                        });
                    }
                },
                error: function(err) {
                    console.error('Price validation error:', err);
                }
            });
        };

        // Step exit logic
        function onStepExit(step) {
            // Any cleanup needed when leaving a step
        }

        // Load templates into step containers
        function loadTemplates() {
            for (let i = 1; i <= TOTAL_STEPS; i++) {
                const template = $(`#tpl_step${i}`).html();
                if (template) {
                    $(`#step${i}-content`).html(template);
                }
                // Ensure only step 1 is visible after loading
                if (i === 1) {
                    $(`#step${i}-content`).removeClass('d-none');
                } else {
                    $(`#step${i}-content`).addClass('d-none');
                }
            }
            // Initialize stepper visual state
            updateStepper();
        }

        // Initialize plugins (Select2, etc)
        function initPlugins() {
            // Initialize Select2 on all selects
            $('.select2').select2({
                width: '100%'
            });

            // Initialize Select2 for category
            $('#inpCategory').select2({
                width: '100%',
                placeholder: 'Seleccione categoría...'
            });

            // Initialize Select2 for BOM family
            if ($('#bomFamilySelector').length) {
                $('#bomFamilySelector').select2({
                    width: '100%',
                    placeholder: 'Seleccione familia...'
                });
            }
        }

        // --- SKU GENERATION (ENTERPRISE-GRADE) ---
        // Format: [NAME_INITIALS]-[CATEGORY_CODE]-[UNIQUE_ID]
        // Example: GUPR-CAM-A7K2
        window.generateSKU = function() {
            const name = $('#inpName').val().trim();
            const categoryId = $('#inpCategory').val();
            const categoryText = $('#inpCategory option:selected').text().trim();

            if (!name) {
                $('#inpSku').val('');
                return;
            }

            // STEP 1: Generate name part (first letter of first 4 words, uppercase)
            const cleanName = name.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, ''); // Remove special chars
            const words = cleanName.split(/\s+/).filter(w => w.length > 0).slice(0, 4);
            let namePart = words.map(w => {
                // Handle accented characters
                const normalized = w.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                return normalized.charAt(0).toUpperCase();
            }).join('');

            // Ensure minimum 2 characters (pad with first word letters if needed)
            if (namePart.length < 2 && words.length > 0) {
                const firstWord = words[0].normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase();
                namePart = firstWord.substring(0, Math.max(2, 4 - namePart.length));
            }

            // STEP 2: Generate category code (only if category is selected)
            let catPart = '';
            if (categoryId && categoryText && !categoryText.includes('--')) {
                // Take first 3 consonants or chars from category
                const cleanCat = categoryText.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toUpperCase();
                catPart = cleanCat.replace(/[^A-Z]/g, '').substring(0, 3);
            }

            // STEP 3: Generate unique ID (timestamp-based, alphanumeric for compactness)
            // Using last 4 chars of timestamp base36 for uniqueness + randomness
            const timestamp = Date.now().toString(36).toUpperCase();
            const uniqueId = timestamp.slice(-4);

            // STEP 4: Assemble SKU (clean format, no consecutive dashes)
            let sku;
            if (catPart) {
                sku = `${namePart}-${catPart}-${uniqueId}`;
            } else {
                sku = `${namePart}-${uniqueId}`;
            }

            $('#inpSku').val(sku);
        };

        window.toggleSkuEdit = function() {
            const input = $('#inpSku');
            const isReadonly = input.prop('readonly');

            if (isReadonly) {
                input.prop('readonly', false).removeClass('bg-light').focus();
            } else {
                input.prop('readonly', true).addClass('bg-light');
            }
        };

        // --- IMAGE DROPZONE LOGIC ---
        window.previewImage = function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                // Validation
                if (!file.type.match('image.*')) {
                    $('#imageErrorMsg').text('Solo se permiten imágenes (JPG, PNG, WEBP)').removeClass('d-none');
                    input.value = ''; // Reset
                    return;
                }

                $('#imageErrorMsg').addClass('d-none');

                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#imgPreview').attr('src', e.target.result);
                    $('#dropzonePlaceholder').addClass('d-none');
                    $('#dropzonePreview').removeClass('d-none').addClass(
                        'd-flex align-items-center justify-content-center');
                    // Stop Dropzone click bubbling when preview is active (optional, but good for UX)
                    $('#productImageDropzone').css('cursor', 'default');
                }
                reader.readAsDataURL(file);
            }
        };

        window.removeImage = function(e) {
            e.preventDefault();
            e.stopPropagation(); // Crucial: Stop click from bubbling to the dropzone container

            $('#inpImage').val(''); // Clear input
            $('#imgPreview').attr('src', '');
            $('#dropzonePreview').addClass('d-none').removeClass('d-flex align-items-center justify-content-center');
            $('#dropzonePlaceholder').removeClass('d-none');
            $('#productImageDropzone').css('cursor', 'pointer');
        };

        // Drag & Drop Handlers (Attached via JS delegate to handle template re-renders if any)
        $(document).on('dragover', '#productImageDropzone', function(e) {
            e.preventDefault();
            $(this).addClass('dragover');
        });

        $(document).on('dragleave', '#productImageDropzone', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');
        });

        $(document).on('drop', '#productImageDropzone', function(e) {
            e.preventDefault();
            $(this).removeClass('dragover');

            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                // Manually assign to input (works in modern browsers)
                $('#inpImage')[0].files = files;
                // Trigger preview
                previewImage($('#inpImage')[0]);
            }
        });

        // Trigger input file on dropzone click (unless it's the remove button)
        $(document).on('click', '#productImageDropzone', function(e) {
            // If already has preview, don't trigger (unless they want to replace? User said X to remove. Let's allow replace if they click outside text?)
            // If preview is hidden (placeholder visible), trigger click.
            if ($('#dropzonePlaceholder').is(':visible')) {
                $('#inpImage').click();
            }
        });

        // Prevent recursive loop if input is clicked inside dropzone
        $(document).on('click', '#inpImage', function(e) {
            e.stopPropagation();
        });

        // Generate SKU when category changes
        $(document).on('change', '#inpCategory', function() {
            generateSKU();
        });

        $(document).ready(function() {
            loadTemplates();
            initPlugins();
            updateButtons();

            // Listener para cambio de Familia de Material (Paso 3)
            // Usamos delegación de eventos porque el select se crea dinámicamente
            $(document).on('change', '#bomFamilySelector', function() {
                const familyId = $(this).val();
                fetchMaterialVariants(familyId);
            });

            // Listener para cambio de variante de material
            $(document).on('change', '#bomMaterialSelector', function() {
                const opt = $(this).find(':selected');
                if (opt.val()) {
                    // FIX: Smart rounding (remove decimals if .00)
                    const stockVal = parseFloat(opt.data('stock'));
                    const unit = opt.data('unit') || 'unid';

                    // Format: 1,000.5 or 1,000 (no unnecessary zeros)
                    const formattedStock = new Intl.NumberFormat('en-US', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 4
                    }).format(stockVal);

                    $('#matStock').text(`${formattedStock} ${unit}`);
                    $('#matCost').text('$' + parseFloat(opt.data('cost')).toFixed(2));
                    // Update unit label
                    $('#bomUnit').text(unit);
                    $('#materialInfo').removeClass('d-none');
                } else {
                    $('#materialInfo').addClass('d-none');
                    $('#bomUnit').text('unid');
                }
            });

            // Reset modal when opened - both buttons inactive
            $('#materialScopeModal').on('show.bs.modal', function() {
                $('.scope-toggle-btn').removeClass('active');
                $('#materialScopeValue').val('');
                $('#specificVariantsContainer').addClass('d-none');
            });

            // Inicializar Select2 en el modal
            $('#targetVariantsSelect').select2({
                dropdownParent: $('#materialScopeModal'),
                placeholder: "Seleccione variantes...",
                width: '100%'
            });
        });

        // Scope selection toggle function
        window.selectScope = function(scope) {
            // Remove active from all buttons
            $('.scope-toggle-btn').removeClass('active');

            // Add active to clicked button
            if (scope === 'global') {
                $('#btnScopeGlobal').addClass('active');
                $('#specificVariantsContainer').addClass('d-none');
            } else {
                $('#btnScopeSpecific').addClass('active');
                $('#specificVariantsContainer').removeClass('d-none');
            }

            // Set value
            $('#materialScopeValue').val(scope);
        };

        // --- INLINE SCOPE SELECTION (NEW - Replaces Modal for BOM) ---
        window.setInlineScope = function(scope) {
            $('.scope-inline-btn').removeClass('active btn-primary').addClass('btn-outline-secondary');
            $(`.scope-inline-btn[data-scope="${scope}"]`).removeClass('btn-outline-secondary').addClass(
                'active btn-primary');
            $('#inlineScopeValue').val(scope);

            if (scope === 'specific') {
                $('#inlineVariantsContainer').removeClass('d-none');
                // Populate variants selector
                const vSel = $('#inlineTargetVariants');
                vSel.empty();
                State.variants.forEach(v => {
                    vSel.append(`<option value="${v.temp_id}">${v.size} / ${v.color}</option>`);
                });
                // Initialize Select2 if not already
                if (!vSel.hasClass('select2-hidden-accessible')) {
                    vSel.select2({
                        width: '100%',
                        placeholder: 'Seleccione variantes...'
                    });
                }
            } else {
                $('#inlineVariantsContainer').addClass('d-none');
            }
        };

        // Cost Preview for BOM
        window.updateBomCostPreview = function() {
            const opt = $('#bomMaterialSelector option:selected');
            const qty = parseFloat($('#bomQty').val()) || 0;
            const cost = parseFloat(opt.data('cost')) || 0;

            if (qty > 0 && cost > 0) {
                const total = qty * cost;
                $('#bomCostPreviewValue').text(`$${total.toFixed(2)}`);
                $('#bomCostPreview').removeClass('d-none');
            } else {
                $('#bomCostPreview').addClass('d-none');
            }
        };

        // Direct Add Material (No Modal)
        window.addMaterialDirect = function() {
            let matId = $('#bomMaterialSelector').val();
            if (Array.isArray(matId)) matId = matId[0];
            const qty = parseFloat($('#bomQty').val());
            const scope = $('#inlineScopeValue').val();

            if (!matId || !qty) {
                Swal.fire('Error', 'Complete los datos del material', 'warning');
                return;
            }

            if (!scope) {
                Swal.fire('Error', 'Seleccione un alcance (Global o Específico)', 'warning');
                return;
            }

            let targets = [];
            if (scope === 'specific') {
                targets = $('#inlineTargetVariants').val() || [];
                if (targets.length === 0) {
                    Swal.fire('Error', 'Seleccione al menos una variante destino', 'warning');
                    return;
                }
                targets.sort();
            }

            const opt = $('#bomMaterialSelector option:selected');
            const material = {
                material_id: matId,
                name: opt.data('name'),
                family_name: opt.data('family'),
                variant_name: opt.data('variant'),
                sku: opt.data('sku'),
                cost: parseFloat(opt.data('cost')),
                unit: opt.data('unit'),
                qty: qty,
                is_primary: $('#materialIsPrimary').is(':checked')
            };

            // Check for existing entry
            const existingIndex = State.bom.findIndex(item => {
                if (item.material_id != material.material_id) return false;
                if (item.scope !== scope) return false;
                const itemTargets = (item.targets || []).sort().join(',');
                const newTargets = targets.join(',');
                return itemTargets === newTargets;
            });

            if (existingIndex > -1) {
                // Accumulate
                const existing = State.bom[existingIndex];
                const newQty = (parseFloat(existing.qty) * 100 + parseFloat(material.qty) * 100) / 100;
                existing.qty = newQty;
                existing.calculated_total = existing.cost * existing.qty;
                Swal.fire({
                    icon: 'info',
                    title: 'Material Actualizado',
                    text: `Nuevo total: ${existing.qty} ${existing.unit}`,
                    timer: 2000,
                    showConfirmButton: false
                });
            } else {
                // Add new
                State.bom.push({
                    ...material,
                    scope,
                    targets,
                    calculated_total: material.cost * material.qty
                });
            }

            renderBOM();
            recalcFinance();

            // Reset form
            $('#bomQty').val('');
            $('#bomMaterialSelector').val(null).trigger('change');
            $('#bomCostPreview').addClass('d-none');
            setInlineScope('global'); // Reset to global
            $('#inlineTargetVariants').val(null).trigger('change');
            $('#materialIsPrimary').prop('checked', false);
        };

        // --- DESIGN SEARCH & FILTERS (NEW FLAT UI) ---
        $(document).on('input', '#searchDesign', function() {
            filterDesignExports();
        });

        $(document).on('change', '#filterDesignBase, #filterAppType', function() {
            filterDesignExports();
        });

        // Master filter function for design exports
        function filterDesignExports() {
            const searchTerm = $('#searchDesign').val().toLowerCase().trim();
            const designFilter = $('#filterDesignBase').val();
            const appTypeFilter = $('#filterAppType').val().toLowerCase();

            let visibleCount = 0;

            $('#designGrid .design-export-item').each(function() {
                const $item = $(this);
                const name = $item.data('name') || '';
                const label = $item.data('label') || '';
                const designId = String($item.data('design-id'));
                const appType = ($item.data('app-type') || '').toLowerCase();

                let show = true;

                // Search filter - search in name (design name) AND label (production label)
                if (searchTerm) {
                    const matchesName = name.includes(searchTerm);
                    const matchesLabel = label.includes(searchTerm);
                    if (!matchesName && !matchesLabel) {
                        show = false;
                    }
                }

                // Design base filter
                if (designFilter && designId !== designFilter) {
                    show = false;
                }

                // Application type filter - compare normalized values
                if (appTypeFilter && appType !== appTypeFilter) {
                    show = false;
                }

                if (show) {
                    $item.show();
                    visibleCount++;
                } else {
                    $item.hide();
                }
            });

            // Update counter
            $('#designExportCounter').html(`Mostrando <strong>${visibleCount}</strong> producciones`);
        }

        // Clear all filters
        window.clearDesignFilters = function() {
            $('#searchDesign').val('');
            $('#filterDesignBase').val('');
            $('#filterAppType').val('');
            filterDesignExports();
        };

        // View mode toggle (grid/list)
        window.setDesignViewMode = function(mode) {
            const $container = $('#designGrid');
            const $items = $container.find('.design-export-item');

            if (mode === 'list') {
                $items.removeClass('col-xl-2 col-lg-3 col-md-4 col-sm-6').addClass('col-12');
                $items.find('.design-card').addClass('flex-row').css('max-height', '100px');
                $items.find('.design-thumb').css({
                    'width': '100px',
                    'height': '100px',
                    'min-width': '100px'
                });
                $items.find('.card-body').addClass('text-left d-flex align-items-center justify-content-between w-100');
                $('#btnViewList').addClass('active');
                $('#btnViewGrid').removeClass('active');
            } else {
                $items.removeClass('col-12').addClass('col-xl-2 col-lg-3 col-md-4 col-sm-6');
                $items.find('.design-card').removeClass('flex-row').css('max-height', '');
                $items.find('.design-thumb').css({
                    'width': '',
                    'height': '100px',
                    'min-width': ''
                });
                $items.find('.card-body').removeClass(
                    'text-left d-flex align-items-center justify-content-between w-100');
                $('#btnViewGrid').addClass('active');
                $('#btnViewList').removeClass('active');
            }
        };

        // --- DESIGN ZOOM MODAL ---
        window.showDesignZoom = function(imageUrl, title) {
            if (!imageUrl || imageUrl === 'undefined' || imageUrl === '') {
                Swal.fire({
                    title: title || 'Diseño',
                    text: 'No hay imagen disponible para este diseño.',
                    icon: 'info',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: title || 'Vista Ampliada',
                imageUrl: imageUrl,
                imageAlt: title || 'Diseño',
                width: 'auto',
                padding: '1rem',
                showCloseButton: true,
                showConfirmButton: false,
                customClass: {
                    image: 'swal2-design-zoom-image'
                }
            });
        };

        function loadTemplates() {
            try {
                $('#step1-content').html($('#tpl_step1').html());
            } catch (e) {}
            try {
                $('#step2-content').html($('#tpl_step2').html());
            } catch (e) {}
            try {
                $('#step3-content').html($('#tpl_step3').html());
            } catch (e) {}
            try {
                $('#step4-content').html($('#tpl_step4').html());
            } catch (e) {}
            try {
                $('#step5-content').html($('#tpl_step5').html());
            } catch (e) {}
            try {
                $('#step6-content').html($('#tpl_step6').html());
            } catch (e) {}
        }

        function initPlugins() {
            $('.select2').select2({
                width: '100%',
                placeholder: "Seleccione...",
                allowClear: false // Disabled to avoid double X with custom button
            });
        }

        // --- NAVIGATION ---
        window.navigate = function(direction) {
            if (direction === 1 && !validateStep(State.step)) return;
            const nextStep = State.step + direction;
            if (nextStep > 6) {
                submitForm();
                return;
            }
            if (nextStep < 1) return;

            $(`#step${State.step}-content`).addClass('d-none');

            // Visual update based on direction
            const currentStepItem = $(`.stepper-item[data-step="${State.step}"]`);
            if (direction === 1) {
                // Forward: Mark current as completed
                currentStepItem.removeClass('active').addClass('completed');
            } else {
                // Backward: Reset current to default (not completed, not active)
                currentStepItem.removeClass('active completed');
            }

            State.step = nextStep;

            $(`#step${State.step}-content`).removeClass('d-none');
            const newStepItem = $(`.stepper-item[data-step="${State.step}"]`);
            newStepItem.addClass('active');

            // When going back, the step we're returning to should NOT be green
            if (direction === -1) {
                newStepItem.removeClass('completed');
            }

            // Logic Hooks
            if (State.step === 2) updateVariantCountBadge();
            if (State.step === 4) syncDesignCardsWithState(); // FIX-3: Re-apply selected state
            if (State.step === 5) renderExtrasTable();
            if (State.step === 6) renderReview();

            updateButtons();
            window.scrollTo(0, 0);

            // Force AdminLTE layout recalculation
            setTimeout(() => {
                $(window).trigger('resize');
                if ($.fn.Layout) $('body').Layout('fix');
            }, 300);
        };

        // FIX-3: Sync design card visual state with State.designs
        // Updated for new flat UI structure using export_id
        function syncDesignCardsWithState() {
            // Reset all first - support both old and new card classes
            $('#designGrid .design-card, #designGrid .design-export-card').removeClass('selected');
            $('#designGrid .usage-status').addClass('d-none');

            // Iterate valid assignments in State
            State.designs.forEach(d => {
                let card;

                // NEW: Try to find by export_id first (new flat UI)
                if (d.export_id) {
                    card = $(
                        `.design-export-card[data-export-id="${d.export_id}"], .design-card[data-export-id="${d.export_id}"]`
                    );
                }

                // Fallback to design_id (old UI compatibility)
                if (!card || !card.length) {
                    card = $(
                        `.design-export-card[data-design-id="${d.id}"], .design-card[data-design-id="${d.id}"]`);
                }

                if (card.length) {
                    card.addClass('selected');
                }
            });
        }

        // Update variant count badge when returning to Step 2
        function updateVariantCountBadge() {
            $('#variantCountBadge').text(State.variants.length);
            if (State.variants.length > 0) {
                $('#noVariantsRow').hide();
            }
        }

        function validateStep(step) {
            if (step === 1) {
                const name = $('#inpName').val();
                const categoryId = $('#inpCategory').val();
                if (!name || !categoryId) {
                    Swal.fire('Falta información', 'Nombre y Categoría son obligatorios', 'warning');
                    return false;
                }
                State.definition = {
                    name,
                    sku: $('#inpSku').val() || '', // SKU is now optional
                    category_id: categoryId,
                    category: $('#inpCategory option:selected').text(),
                    desc: $('#inpDesc').val()
                };
            }
            if (step === 2) {
                if (State.variants.length === 0) {
                    // FIX: Allow single variant autofill if empty
                    const baseSku = $('#inpSku').val();
                    if (baseSku) {
                        State.variants.push({
                            temp_id: 'default',
                            sku: baseSku,
                            size: 'Unitalla',
                            color: 'N/A',
                            size_id: null,
                            color_id: null
                        });
                        updateVariantCountBadge();
                        return true;
                    }
                }
            }
            if (step === 3) {
                // FIX: Blocking Warning for empty BOM (Async handling)
                if (State.bom.length === 0 && !bypassBomValidation) {
                    Swal.fire({
                        title: '¿Continuar sin Materiales?',
                        text: "El costo de materiales será $0.00. Use esto solo para servicios o productos intangibles.",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, continuar',
                        cancelButtonText: 'Revisar',
                        reverseButtons: true, // Forces "Revisar" (Cancel) to Left, "Sí" (Confirm) to Right
                        confirmButtonColor: '#28a745',
                        cancelButtonColor: '#6c757d'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            bypassBomValidation = true;
                            navigate(1); // Retry navigation
                            // Reset flag after small delay or not needed if we change step
                            setTimeout(() => {
                                bypassBomValidation = false;
                            }, 500);
                        }
                    });

                    // BLOCK navigation immediately so the stepper doesn't update to "Completed"
                    return false;
                }
            }
            if (step === 4) {
                const isNoDesign = $('#toggleNoDesign').is(':checked');
                // If toggle is ON or designs are selected, proceed
                if (isNoDesign || State.designs.length > 0) {
                    return true;
                }

                // REVOLUTIONARY: Suggestive validation (not restrictive)
                // Offer user a choice instead of just blocking
                Swal.fire({
                    title: '💡 Este producto no tiene bordados',
                    html: `<p class="mb-3">No has seleccionado ningún diseño de bordado.</p>
                               <p class="text-muted">¿Es un <strong>producto liso</strong> (sin bordado) o necesitas agregar diseños?</p>`,
                    icon: 'question',
                    showCancelButton: true,
                    showDenyButton: true,
                    confirmButtonText: '<i class="fas fa-tshirt mr-1"></i> Sí, es liso',
                    denyButtonText: '<i class="fas fa-vector-square mr-1"></i> Agregar diseño',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#28a745',
                    denyButtonColor: '#17a2b8'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // User confirms it's a liso product - activate toggle and proceed
                        $('#toggleNoDesign').prop('checked', true).trigger('change');
                        navigate(1); // Retry navigation
                    } else if (result.isDenied) {
                        // User wants to add design - stay on step but don't navigate
                        // No action needed, they remain on Step 4
                    }
                    // If cancelled, also stay on step
                });

                return false; // Block immediate navigation, wait for user choice
            }
            return true;
        }

        // Feature: Toggle No Design Mode
        // Updated to disable all filter controls in new UI
        window.toggleNoDesignMode = function() {
            const isChecked = $('#toggleNoDesign').is(':checked');
            if (isChecked) {
                // CLEAR existing designs when switching to Liso mode
                if (State.designs.length > 0) {
                    State.designs = [];
                    // Deselect all cards visually
                    $('#designGrid .design-card, #designGrid .design-export-card').removeClass('selected');
                    recalcFinance();
                }

                $('#searchDesign').prop('disabled', true);
                $('#filterDesignBase').prop('disabled', true);
                $('#filterAppType').prop('disabled', true);
                $('#designGrid, #designExportsContainer').addClass('opacity-50');
                $('#designGrid .design-card, #designGrid .design-export-card').css('pointer-events', 'none');
            } else {
                $('#searchDesign').prop('disabled', false);
                $('#filterDesignBase').prop('disabled', false);
                $('#filterAppType').prop('disabled', false);
                $('#designGrid, #designExportsContainer').removeClass('opacity-50');
                $('#designGrid .design-card, #designGrid .design-export-card').css('pointer-events', 'auto');
            }
        };

        function updateButtons() {
            $('#btnPrev').prop('disabled', State.step === 1);
            if (State.step === 6) {
                $('#btnNext').html('<i class="fas fa-check"></i>').addClass('btn-success-mode');
            } else {
                $('#btnNext').html('<i class="fas fa-chevron-right"></i>').removeClass('btn-success-mode');
            }
        }

        // (navigateToStep function is defined earlier in the stepper navigation section)
        // --- REVOLUTIONARY: Dynamic badges in stepper ---
        function updateStepperBadges() {
            // Badge for Step 2 (Presentaciones/Variants count)
            const variantCount = State.variants.length;
            if (variantCount > 0) {
                $('#badgeStep2').text(variantCount).removeClass('d-none');
            } else {
                $('#badgeStep2').addClass('d-none');
            }

            // Badge for Step 3 (Receta/BOM cost)
            const bomCost = State.bom.reduce((sum, m) => sum + (m.cost || 0), 0);
            if (State.bom.length > 0) {
                $('#badgeStep3').text('$' + bomCost.toFixed(0)).removeClass('d-none');
            } else {
                $('#badgeStep3').addClass('d-none');
            }

            // Badge for Step 4 (Diseño/Designs count)
            const designCount = State.designs.length;
            const isNoDesign = $('#toggleNoDesign').is(':checked');
            if (designCount > 0) {
                $('#badgeStep4').text(designCount).removeClass('d-none');
            } else if (isNoDesign) {
                $('#badgeStep4').text('Liso').removeClass('d-none');
            } else {
                $('#badgeStep4').addClass('d-none');
            }
        }

        // --- STEP 2: VARIANTS ---
        window.generateMatrix = function() {
            const sizes = $('#selSizes').select2('data');
            const colors = $('#selColors').select2('data');
            const baseSku = $('#inpSku').val();

            if (!sizes.length || !colors.length || !baseSku) {
                Swal.fire('Error', 'Verifique SKU base, tallas y colores', 'error');
                return;
            }

            const tbody = $('#variantsTableBody');
            let addedCount = 0;
            let duplicateCount = 0;

            sizes.forEach(s => {
                colors.forEach(c => {
                    // Check if this combination already exists
                    const exists = State.variants.find(v =>
                        v.size_id == s.id && v.color_id == c.id
                    );

                    if (exists) {
                        duplicateCount++;
                        return; // Skip duplicate
                    }

                    const sku = `${baseSku}-${s.text.charAt(0)}-${c.text.substring(0,3)}`.toUpperCase();
                    const tempId = Math.random().toString(36).substr(2, 9);

                    State.variants.push({
                        temp_id: tempId,
                        sku,
                        size: s.text,
                        color: c.text,
                        size_id: s.id,
                        color_id: c.id
                    });

                    tbody.append(`<tr data-id="${tempId}">
                        <td>${s.text} / ${c.text}</td>
                        <td class="font-weight-bold text-primary">${sku}</td>
                        <td><button class="btn btn-sm btn-danger" onclick="removeVariant('${tempId}', this)"><i class="fas fa-trash"></i></button></td>
                    </tr>`);

                    addedCount++;
                });
            });

            $('#variantsTableContainer').removeClass('d-none');

            // Feedback to user
            if (duplicateCount > 0 && addedCount > 0) {
                Swal.fire({
                    icon: 'info',
                    title: 'Variantes generadas',
                    html: `<b>${addedCount}</b> variantes nuevas agregadas.<br><b>${duplicateCount}</b> duplicadas omitidas.`,
                    timer: 2500,
                    showConfirmButton: false
                });
            } else if (duplicateCount > 0 && addedCount === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Sin cambios',
                    text: 'Todas las combinaciones ya existen.',
                    timer: 2000,
                    showConfirmButton: false
                });
            } else if (addedCount > 0) {
                Swal.fire({
                    icon: 'success',
                    title: '¡Generado!',
                    text: `${addedCount} variantes agregadas.`,
                    timer: 1500,
                    showConfirmButton: false
                });
            }

            // Hide placeholder row and update count badge
            $('#noVariantsRow').hide();
            $('#variantCountBadge').text(State.variants.length);

            // Clear selections after generating
            $('#selSizes').val(null).trigger('change');
            $('#selColors').val(null).trigger('change');
        };

        window.removeVariant = function(id, btn) {
            const variantToRemove = State.variants.find(v => v.temp_id === id);

            // Remove the variant
            State.variants = State.variants.filter(v => v.temp_id !== id);
            $(btn).closest('tr').remove();

            // CASCADE DELETE: Clean BOM items that targeted this variant
            State.bom = State.bom.filter(m => {
                if (m.scope === 'global') return true;
                if (!m.targets || m.targets.length === 0) return true;

                // Remove this variant from targets
                m.targets = m.targets.filter(tid => tid !== id);

                // If no targets left, remove the material entirely
                return m.targets.length > 0;
            });

            // CASCADE DELETE: Clean Designs that targeted this variant
            State.designs = State.designs.filter(d => {
                if (d.scope === 'global') return true;
                if (!d.targets || d.targets.length === 0) return true;

                // Remove this variant from targets
                d.targets = d.targets.filter(tid => tid !== id);

                // If no targets left, remove the design entry
                return d.targets.length > 0;
            });

            // Re-render BOM table and recalculate
            renderBOM();
            recalcFinance();

            // Notify user
            if (variantToRemove) {
                Swal.fire({
                    icon: 'info',
                    title: 'Variante Eliminada',
                    text: `${variantToRemove.size}/${variantToRemove.color} y sus asignaciones específicas fueron removidas.`,
                    timer: 2000,
                    showConfirmButton: false,
                    toast: true,
                    position: 'top-end'
                });
            }
        };

        // --- STEP 3: MATERIALS (AJAX RESTORED) ---
        // Variable temporal para el modal
        let tempMaterial = null;

        window.fetchMaterialVariants = function(familyId) {
            if (Array.isArray(familyId)) familyId = familyId[0];
            if (!familyId) {
                $('#bomMaterialSelector').empty().prop('disabled', true);
                return;
            }

            // URL original que usabas para traer conversiones/variantes
            const url = '{{ route('admin.material-variants.conversiones', ['materialId' => ':id']) }}'.replace(':id',
                familyId);

            $.get(url, function(data) {
                const sel = $('#bomMaterialSelector');
                sel.empty().prop('disabled', false); // Removed dummy option for Multiple Select2 compatibility

                data.forEach(v => {
                    // Adaptar según la respuesta JSON real de tu controlador
                    // Asumiendo estructura: {id, text, cost_base, stock_real, symbol, family_name, variant_name, sku, stock_display}

                    // Construct display text to remove SKU (User Request)
                    let displayText = v.text;
                    if (v.family_name && v.variant_name) {
                        displayText = `${v.family_name} - ${v.variant_name}`;
                    }

                    sel.append(
                        `<option value="${v.id}"
                            data-cost="${v.cost_base}"
                            data-stock="${v.stock_real}"
                            data-unit="${v.symbol}"
                            data-name="${v.text}"
                            data-family="${v.family_name || ''}"
                            data-variant="${v.variant_name || ''}"
                            data-sku="${v.sku || ''}"
                            data-stock-text="${v.stock_display || ''}"
                            >${displayText}</option>`
                    );
                });
            }).fail(function() {
                Swal.fire('Error', 'No se pudieron cargar las variantes', 'error');
            });
        };

        window.prepareAddMaterial = function() {
            let matId = $('#bomMaterialSelector').val();
            if (Array.isArray(matId)) matId = matId[0];
            const qty = parseFloat($('#bomQty').val());

            if (!matId || !qty) {
                Swal.fire('Error', 'Complete los datos del material', 'warning');
                return;
            }

            const opt = $('#bomMaterialSelector option:selected');
            tempMaterial = {
                material_id: matId,
                name: opt.data('name'), // Fallback text
                family_name: opt.data('family') || opt.data('name'), // Preferred
                variant_name: opt.data('variant') || '',
                sku: opt.data('sku') || '',
                stock_text: opt.data('stock-text') || '',
                cost: parseFloat(opt.data('cost')),
                unit: opt.data('unit'),
                qty: qty,
                is_primary: $('#materialIsPrimary').is(':checked')
            };

            // Llenar selector de variantes en modal
            const vSel = $('#targetVariantsSelect');
            vSel.empty();
            State.variants.forEach(v => {
                vSel.append(`<option value="${v.temp_id}">${v.sku} (${v.size}/${v.color})</option>`);
            });

            $('#materialScopeModal').modal('show');
        };

        window.confirmAddMaterial = function() {
            const scope = $('#materialScopeValue').val();
            let targets = [];

            // Validate Scope
            if (!scope) {
                Swal.fire('Error', 'Seleccione ur alcance', 'warning');
                return;
            }

            // Validate Targets for Specific
            if (scope === 'specific') {
                targets = $('#targetVariantsSelect').val();
                if (!targets || !targets.length) {
                    Swal.fire('Error', 'Seleccione variantes destino', 'warning');
                    return;
                }
                targets.sort();
            }

            // --- SMART MERGE ALGORITHM ---
            const matId = tempMaterial.material_id;

            // CASE 1: GLOBAL ADDITION
            if (scope === 'global') {
                // Find existing global
                const existingGlobalIdx = State.bom.findIndex(m => m.material_id == matId && m.scope === 'global');

                // Remove ANY specific instances of this material (Global overrides specific)
                const specificsRemoved = State.bom.filter(m => m.material_id == matId && m.scope === 'specific').length;
                State.bom = State.bom.filter(m => !(m.material_id == matId && m.scope === 'specific'));

                if (existingGlobalIdx > -1) {
                    // Update existing Global
                    const existing = State.bom[existingGlobalIdx];
                    // Logic: If user adds global again, do we sum? Yes, usually implies adding more qty.
                    existing.qty = (parseFloat(existing.qty) * 100 + parseFloat(tempMaterial.qty) * 100) / 100;
                    existing.calculated_total = existing.cost * existing.qty;

                    Swal.fire('Info',
                        `Se actualizó la cantidad Global (Anteriores específicos removidos: ${specificsRemoved})`,
                        'info');
                } else {
                    // Create new Global
                    const costTotal = tempMaterial.cost * tempMaterial.qty;
                    State.bom.push({
                        ...tempMaterial,
                        scope: 'global',
                        targets: [],
                        calculated_total: costTotal
                    });
                    if (specificsRemoved > 0) {
                        Swal.fire('Info',
                            `Se aplicó Globalmente. (Se absorbieron ${specificsRemoved} asignaciones específicas)`,
                            'success');
                    } else {
                        Swal.fire('Agregado', 'Material agregado globalmente', 'success');
                    }
                }
            }

            // CASE 2: SPECIFIC ADDITION
            else {
                // Check if GLOBAL exists
                const hasGlobal = State.bom.some(m => m.material_id == matId && m.scope === 'global');
                if (hasGlobal) {
                    Swal.fire('Conflicto',
                        'Este material ya está asignado GLOBALMENTE. Elimínelo primero si desea asignarlo específicamente.',
                        'warning');
                    return;
                }

                // Clean Overlaps: If any existing specific entry targets the same variants, remove those targets from the old entry
                let overlapped = 0;
                State.bom.forEach((m, idx) => {
                    if (m.material_id == matId && m.scope === 'specific' && m.targets) {
                        // Find intersection
                        const intersection = m.targets.filter(t => targets.includes(t));
                        if (intersection.length > 0) {
                            // Remove intersection from OLD entry
                            m.targets = m.targets.filter(t => !intersection.includes(t));
                            overlapped += intersection.length;
                        }
                    }
                });

                // Cleanup: Remove entries that became empty
                State.bom = State.bom.filter(m => {
                    if (m.scope === 'specific' && (!m.targets || m.targets.length === 0)) return false;
                    return true;
                });

                // Now Add/Update the current request
                // Search for exact match of targets? Or just add new entry?
                // Logic: "New wins". Since we stripped overlaps, we can just add a new entry for these targets.
                // BUT, if there was an EXACT match previously (now empty), we might want to sum.
                // However, since we just stripped it, it's safer to just push a new entry.
                // Or: Check if there is an existing entry with EXACTLY these targets (that wasn't stripped)?

                // Simple approach: Always push new entry (the "Strip" phase ensures no duplicates).
                // Wait, if I add [A] Qty 1, then add [A] Qty 1 again? 
                // The strip phase would remove [A] from the first entry, making it empty. Then we add new [A] Qty 1.
                // This means valid Overwrite (Replace), not Sum.
                // The user said: "si ya esta se actualiza". Update implies SUM or REPLACE?
                // In BOM, usually you correct the value. So REPLACE is safer than obscure summing.

                const costTotal = tempMaterial.cost * tempMaterial.qty;
                State.bom.push({
                    ...tempMaterial,
                    scope: 'specific',
                    targets: targets,
                    calculated_total: costTotal
                });

                if (overlapped > 0) {
                    Swal.fire('Actualizado', `Se reasignaron ${overlapped} variantes a esta nueva regla.`, 'success');
                } else {
                    Swal.fire('Agregado', 'Material agregado a variantes seleccionadas', 'success');
                }
            }

            $('#materialScopeModal').modal('hide');

            renderBOM();
            recalcFinance();

            // Reset form
            $('#bomQty').val('');
            $('#bomMaterialSelector').val(null).trigger('change');
            $('input[name="materialScope"][value="global"]').prop('checked', true).trigger('change');
            $('#targetVariantsSelect').val(null).trigger('change');
        };

        function renderBOM() {
            const tbody = $('#bomTableBody');
            tbody.empty();
            let total = 0;

            State.bom.forEach((m, idx) => {
                total += m.calculated_total;

                let badge = '';
                let variantInfo = '';

                if (m.scope === 'global') {
                    badge = '<span class="badge badge-pill badge-secondary">Global</span>';
                    variantInfo = '<span class="text-muted small">Aplica a todas</span>';
                } else {
                    badge = '<span class="badge badge-pill badge-info">Específico</span>';

                    if (m.targets && m.targets.length > 0) {
                        const targetNames = m.targets.map(tid => {
                            const v = State.variants.find(va => va.temp_id === tid);
                            // ONLY Name/Color, NO SKU
                            return v ? `${v.size} / ${v.color}` : '';
                        }).filter(Boolean).join(', ');

                        variantInfo =
                            `<div class="font-weight-bold text-dark" style="font-size: 0.95em;">${targetNames}</div>`;
                    } else {
                        variantInfo =
                            '<span class="text-danger small"><i class="fas fa-exclamation-triangle"></i> Sin asignación</span>';
                    }
                }

                tbody.append(`<tr>
                <td class="align-middle border-right">
                    <div class="font-weight-bold text-dark" style="font-size: 1rem;">
                        ${m.family_name || m.name} ${m.variant_name ? `- ${m.variant_name}` : ''}
                    </div>
                    <div class="text-muted text-uppercase" style="font-size: 0.9rem;">
                        ${m.sku || 'N/A'}
                    </div>
                    ${m.is_primary ? '<span class="badge badge-warning text-white mt-1"><i class="fas fa-star text-white"></i> Principal</span>' : ''}
                </td>
                <td class="align-middle border-right" style="max-width: 300px;">
                    ${variantInfo}
                </td>
                <td class="align-middle text-center border-right" style="width: 150px;">
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control text-center font-weight-bold" 
                               value="${m.qty}" step="0.01" min="0.01" 
                               onchange="updateBomQty(${idx}, this.value)"
                               style="font-size: 1rem;">
                        <div class="input-group-append">
                            <span class="input-group-text small">${m.unit}</span>
                        </div>
                    </div>
                </td>
                <td class="align-middle text-center border-right">${badge}</td>
                <td class="align-middle font-weight-bold text-center border-right" style="font-size: 1.1rem;">$${m.calculated_total.toFixed(2)}</td>
                <td class="align-middle text-center"><button class="btn btn-sm btn-outline-danger btn-icon rounded-circle" onclick="removeBOM(${idx})"><i class="fas fa-trash"></i></button></td>
            </tr>`);
            });
            State.financials.material_cost = total;
            $('#bomTotalCostBadge').text(`Total: $${total.toFixed(2)}`);
        }

        window.removeBOM = function(idx) {
            State.bom.splice(idx, 1);
            renderBOM();
            recalcFinance();
        };

        window.updateBomQty = function(idx, newQty) {
            const qty = parseFloat(newQty);
            if (qty > 0 && State.bom[idx]) {
                State.bom[idx].qty = qty;
                State.bom[idx].calculated_total = (State.bom[idx].cost * qty);
                renderBOM(); // Re-render to update cost column
                recalcFinance();
            }
        };

        // --- STEP 4: DESIGNS (UPDATED with Modal Config) ---
        let tempDesign = null; // Temporary storage for design being configured

        // NEW: Select Design Export (flat structure) - Opens config modal
        window.selectDesignExport = function(el, exportData) {
            // LISO MODE CHECK: Block selection if product is marked as "Liso"
            if ($('#toggleNoDesign').is(':checked')) {
                Swal.fire({
                    title: 'Modo Liso Activo',
                    text: 'Este producto está marcado como LISO (sin bordado). Desactiva el toggle para agregar diseños.',
                    icon: 'warning',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            const card = $(el);
            const appType = exportData.application_type || 'general';
            const appLabel = exportData.application_label || 'Sin etiqueta';

            // Build origin text
            let originText = exportData.design_name;
            if (exportData.variant_name) {
                originText += ' / ' + exportData.variant_name;
            }

            // DEFINITIVE IMAGE CAPTURE V5: Get from DOM (now uses production.preview route)
            let capturedImageUrl = '';

            // Get the img src from the clicked card (production.preview route)
            const anyImg = card.find('img').first();
            if (anyImg.length > 0 && anyImg.attr('src')) {
                capturedImageUrl = anyImg.attr('src');
            }

            // Fallback: Construct preview URL from export ID
            if (!capturedImageUrl && exportData.id) {
                capturedImageUrl = "{{ route('admin.production.preview', ['export' => '__ID__']) }}".replace('__ID__',
                    exportData.id);
            }

            // Store for modal use
            tempDesign = {
                id: exportData.design_id,
                export_id: exportData.id,
                name: appLabel, // Use label as the name
                stitches: exportData.stitches || 0,
                imageUrl: capturedImageUrl,
                element: el,
                variant_id: exportData.variant_id,
                variant_name: exportData.variant_name,
                dimensions: exportData.dimensions_label,
                colors: exportData.colors,
                variants: [],
                // NEW: Store application type info for direct add
                application_type: appType,
                application_label: appLabel,
                design_name: exportData.design_name,
                origin: originText
            };

            // Populate modal - NEW STRUCTURE
            $('#designModalLabel').text(appLabel.toUpperCase()); // Title = Label name in UPPERCASE
            $('#designModalOrigin').html(`<i class="fas fa-sitemap mr-1"></i>${originText}`); // Subtitle = Origin

            // Format position name: replace underscores/hyphens with spaces and capitalize
            const positionFormatted = appType.replace(/[_-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            $('#designModalPosition').html(`<i class="fas fa-map-marker-alt mr-2"></i>${positionFormatted}`);

            // Technical data
            $('#designModalStitches').text(exportData.stitches_formatted || '0');
            $('#designModalDimensions').text(exportData.dimensions_label || '-');
            $('#designModalColors').text((exportData.colors || 0) + ' col');

            // Image
            if (tempDesign.imageUrl) {
                $('#designModalImage').attr('src', tempDesign.imageUrl).show();
            } else {
                $('#designModalImage').hide();
            }

            // Show configured positions
            showConfiguredPositions(exportData.design_id, exportData.id);

            // Reset modal state
            selectDesignScope('global');
            $('#justAddedFeedback').addClass('d-none');

            // Populate product variants selector
            const vSel = $('#designTargetVariants');
            vSel.empty();
            State.variants.forEach(v => {
                // User request: Show only variant name (Size / Color) without parentheses or SKU
                vSel.append(`<option value="${v.temp_id}">${v.size} / ${v.color}</option>`);
            });
            if (!vSel.hasClass('select2-hidden-accessible')) {
                vSel.select2({
                    dropdownParent: $('#designConfigModal'),
                    width: '100%',
                    placeholder: 'Seleccione variantes...'
                });
            }

            $('#designConfigModal').modal('show');
        };

        // NEW: Confirm add design directly (position already defined from production)
        window.confirmAddDesignDirect = function() {
            if (!tempDesign) return;

            const scope = $('#designScopeValue').val();
            let targets = [];

            if (scope === 'specific') {
                targets = $('#designTargetVariants').val() || [];
                if (targets.length === 0) {
                    Swal.fire('Error', 'Seleccione al menos una variante', 'warning');
                    return;
                }
                targets.sort();
            }

            // Use application_type as position (already defined in production)
            // Format: replace underscores/hyphens with spaces and capitalize each word
            const positionName = tempDesign.application_type ?
                tempDesign.application_type.replace(/[_-]/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) :
                'General';
            const positionSlug = tempDesign.application_type || 'general';

            // Check for duplicate
            const existingIndex = State.designs.findIndex(d => {
                if (d.export_id !== tempDesign.export_id) return false;
                if (d.scope !== scope) return false;
                const dTargets = (d.targets || []).sort().join(',');
                const newTargets = targets.join(',');
                return dTargets === newTargets;
            });

            if (existingIndex > -1) {
                Swal.fire('Atención', 'Esta producción ya está configurada con el mismo alcance', 'info');
                return;
            }

            // Add design to state
            State.designs.push({
                id: tempDesign.id,
                export_id: tempDesign.export_id,
                name: tempDesign.name,
                stitches: tempDesign.stitches,
                position_id: null, // No position ID needed - using application_type
                position_name: positionName,
                position_slug: positionSlug,
                scope,
                targets,
                variant_id: tempDesign.variant_id || null,
                variant_name: tempDesign.variant_name || null,
                dimensions: tempDesign.dimensions || null,
                design_name: tempDesign.design_name,
                application_type: tempDesign.application_type,
                image_url: tempDesign.imageUrl // Fix: Add image URL for preview
            });

            // Mark card as selected
            $(tempDesign.element).addClass('selected');

            recalcFinance();

            // Show inline feedback
            $('#justAddedText').text(`Agregado: ${tempDesign.name} → ${positionName}`);
            $('#justAddedFeedback').removeClass('d-none');

            // Update the configured positions list
            showConfiguredPositions(tempDesign.id, tempDesign.export_id);
        };

        // OLD: Toggle Design (for backup/old UI compatibility)
        window.toggleDesign = function(el, id, name, stitches, imageUrl, dimensions, colors, variants = []) {
            const card = $(el);
            const appType = card.data('app-type') || ''; // Capture Application Type

            // ROBUST IMAGE CAPTURE V2: Scan all images in card
            let robustImage = imageUrl || '';
            let foundBestImage = null;

            // 1. Prioritize image that is NOT placeholder and has substantial length
            card.find('img').each(function() {
                const src = $(this).attr('src');
                if (src && src.length > 15 && !src.includes('placeholder') && !src.includes('data:image')) {
                    foundBestImage = src;
                    return false; // Break loop
                }
            });

            // 2. If found better image, use it.
            if (foundBestImage) {
                robustImage = foundBestImage;
            } else if (!robustImage || robustImage.includes('placeholder')) {
                // FALLBACK 1: Try img src (any)
                const anyImg = card.find('img').attr('src');
                if (anyImg) robustImage = anyImg;

                // FALLBACK 2: Check for background-image (common in galleries)
                if (!robustImage || robustImage.includes('placeholder')) {
                    const bgDiv = card.find('[style*="background-image"]');
                    if (bgDiv.length > 0) {
                        const style = bgDiv.css('background-image');
                        // Extract url(...) content: url("...") or url('...')
                        if (style && style.includes('url')) {
                            const match = style.match(/url\(["']?([^"']*)["']?\)/);
                            if (match && match[1]) robustImage = match[1];
                        }
                    }
                }
            }

            // ALWAYS open config modal - whether already selected or not
            // User removes positions from INSIDE the modal using X buttons
            tempDesign = {
                id,
                name,
                stitches: stitches || 0,
                imageUrl: robustImage, // Use robust image
                element: el,
                variants: variants // Store loaded variants
            };

            // Populate modal basics
            $('#designModalName').text(name);
            $('#designModalStitches').text(stitches ? stitches.toLocaleString() : 0);
            $('#designModalDimensions').text(dimensions || '-');
            $('#designModalColors').text(colors ? colors + ' col' : '0 col');

            // Show App Type Badge
            if (appType) {
                $('#designModalAppType').text(
                    `Lugar de aplicación: ${appType.charAt(0).toUpperCase() + appType.slice(1)}`).removeClass(
                    'd-none');
            } else {
                $('#designModalAppType').addClass('d-none');
            }

            // Primary Image Logic (Default to parent, override if variant selected logic later)
            if (robustImage) {
                $('#designModalImage').attr('src', robustImage).show();
            } else {
                $('#designModalImage').hide();
            }

            // --- VARIANT SELECTOR LOGIC ---
            const variantSelect = $('#designVariantSelect');
            const variantContainer = $('#designVariantContainer');

            variantSelect.empty();

            if (variants && variants.length > 0) {
                variantSelect.append('<option value="">Seleccione Versión...</option>');
                variants.forEach(v => {
                    let vImg = v.primary_image ? "{{ asset('storage') }}/" + v.primary_image.url : imageUrl;
                    variantSelect.append(
                        `<option value="${v.id}" data-image="${vImg}" data-code="${v.sku}">${v.name}</option>`
                    );
                });
                variantContainer.removeClass('d-none');
            } else {
                variantContainer.addClass('d-none');
            }

            // Show already configured positions for THIS design
            showConfiguredPositions(id);

            // Reset modal state
            $('#designPositionSelect').val(null).trigger('change');
            selectDesignScope('global');
            $('#justAddedFeedback').addClass('d-none');

            // Initialize Select2 for Position (with search)
            if (!$('#designPositionSelect').hasClass('select2-hidden-accessible')) {
                $('#designPositionSelect').select2({
                    dropdownParent: $('#designConfigModal'),
                    width: '100%',
                    placeholder: 'Buscar posición...',
                    allowClear: true
                });
            }

            // AUTO-SELECT POSITION based on App Type (Smart Match)
            if (appType) {
                // Try to find an option that matches the App Type
                // We iterate options to match text content roughly
                let foundVal = null;
                $('#designPositionSelect option').each(function() {
                    const optText = $(this).text().toLowerCase();
                    // Loose matching: if option text contains the app type (e.g. "Pecho" in "Pecho Izquierdo")
                    // OR if app type contains the option text
                    if (optText.includes(appType) || appType.includes(optText)) {
                        foundVal = $(this).val();
                        return false; // Break loop
                    }
                });

                if (foundVal) {
                    $('#designPositionSelect').val(foundVal).trigger('change');
                }
            }

            // Populate variants selector
            const vSel = $('#designTargetVariants');
            vSel.empty();
            State.variants.forEach(v => {
                vSel.append(`<option value="${v.temp_id}">${v.sku} (${v.size}/${v.color})</option>`);
            });
            if (!vSel.hasClass('select2-hidden-accessible')) {
                vSel.select2({
                    dropdownParent: $('#designConfigModal'),
                    width: '100%',
                    placeholder: 'Seleccione variantes...'
                });
            }

            $('#designConfigModal').modal('show');
        };

        // Show already configured positions for this design WITH VARIANT TRACEABILITY + DELETE
        // Updated to support filtering by export_id for flat UI
        function showConfiguredPositions(designId, exportId = null) {
            let configured = State.designs.filter(d => d.id === designId);

            // If exportId is provided, also filter by it
            if (exportId) {
                configured = configured.filter(d => d.export_id === exportId || !d.export_id);
            }
            const container = $('#designConfiguredPositions');
            const list = $('#configuredPositionsList');

            if (configured.length > 0) {
                list.empty();
                configured.forEach((d, idx) => {
                    // Find the actual index in State.designs
                    const stateIndex = State.designs.findIndex(sd =>
                        sd.id === d.id &&
                        sd.position_id === d.position_id &&
                        sd.scope === d.scope
                    );

                    let variantInfo = '';
                    if (d.scope === 'specific' && d.targets && d.targets.length > 0) {
                        const variantNames = d.targets.map(tid => {
                            const v = State.variants.find(va => va.temp_id === tid);
                            return v ? `${v.size}/${v.color}` : '';
                        }).filter(Boolean).join(', ');
                        variantInfo = `<small class="d-block text-dark">→ ${variantNames}</small>`;
                    } else {
                        variantInfo = `<small class="d-block text-muted">→ Todas las variantes</small>`;
                    }

                    list.append(`
                        <div class="bg-light border rounded p-2 mb-1 mr-1 position-relative" style="padding-right: 30px!important;">
                            <span class="badge badge-success">${d.position_name}</span>
                            ${variantInfo}
                            <button type="button" class="btn btn-sm btn-link text-danger position-absolute" 
                                    style="top: 0; right: 0; padding: 2px 6px;"
                                    onclick="removeDesignPosition(${stateIndex})" title="Eliminar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `);
                });
                container.removeClass('d-none');
            } else {
                container.addClass('d-none');
            }

            updateDesignsAddedCount();
            updateDesignCardVisual(designId, exportId);
        }

        // Remove a specific design position
        window.removeDesignPosition = function(stateIndex) {
            if (stateIndex >= 0 && stateIndex < State.designs.length) {
                const removed = State.designs.splice(stateIndex, 1)[0];

                // Re-show the updated list
                if (tempDesign) {
                    showConfiguredPositions(tempDesign.id);
                }

                recalcFinance();

                // Show feedback
                if (removed) {
                    $('#justAddedText').html(`<span class="text-danger">Eliminado: ${removed.position_name}</span>`);
                    $('#justAddedFeedback').removeClass('d-none alert-success').addClass('alert-warning');
                }
            }
        };

        // Update visual state of design card based on whether it has configs
        // Updated for new flat UI with export_id support
        function updateDesignCardVisual(designId, exportId = null) {
            let configs = State.designs.filter(d => d.id === designId);

            // If exportId provided, further filter
            if (exportId) {
                configs = configs.filter(d => d.export_id === exportId);
            }

            const count = configs.length;

            // Find card - try export_id first, then design_id (support both card classes)
            let card;
            if (exportId) {
                card = $(`.design-export-card[data-export-id="${exportId}"], .design-card[data-export-id="${exportId}"]`);
            }
            if (!card || !card.length) {
                card = $(`.design-export-card[data-design-id="${designId}"], .design-card[data-design-id="${designId}"]`);
            }

            if (count > 0) {
                card.addClass('selected');

                // Check if badge exists, if not create it
                let badge = card.find('.position-count-badge');
                if (badge.length === 0) {
                    card.append(
                        '<div class="position-count-badge badge badge-primary shadow-sm" style="position: absolute; top: 10px; right: 10px; z-index: 10; font-size: 0.9rem;"></div>'
                    );
                    badge = card.find('.position-count-badge');
                }
                badge.html(`<i class="fas fa-layer-group mr-1"></i>${count}`).show();

            } else {
                card.removeClass('selected');
                card.find('.position-count-badge').hide();
            }
        }

        // Update count of designs added (for current design)
        function updateDesignsAddedCount() {
            if (tempDesign) {
                const count = State.designs.filter(d => d.id === tempDesign.id).length;
                $('#designsAddedCount').text(count);
            } else {
                $('#designsAddedCount').text(State.designs.length);
            }
        }

        window.selectDesignScope = function(scope) {
            $('.design-scope-btn').removeClass('active btn-info').addClass('btn-outline-secondary');
            $(`.design-scope-btn[data-scope="${scope}"]`).removeClass('btn-outline-secondary').addClass(
                'active btn-info');
            $('#designScopeValue').val(scope);

            if (scope === 'specific') {
                $('#designVariantsContainer').removeClass('d-none');
            } else {
                $('#designVariantsContainer').addClass('d-none');
            }
        };

        window.confirmAddDesign = function() {
            if (!tempDesign) return;

            const positionId = $('#designPositionSelect').val();
            const positionName = $('#designPositionSelect option:selected').text();
            const positionSlug = $('#designPositionSelect option:selected').data('slug');
            const scope = $('#designScopeValue').val();

            if (!positionId) {
                Swal.fire('Error', 'Seleccione una posición para el bordado', 'warning');
                return;
            }

            let targets = [];
            if (scope === 'specific') {
                targets = $('#designTargetVariants').val() || [];
                if (targets.length === 0) {
                    Swal.fire('Error', 'Seleccione al menos una variante', 'warning');
                    return;
                }
                targets.sort();
            }

            // Check for duplicate (same design + position + scope + targets)
            const existingIndex = State.designs.findIndex(d => {
                if (d.id !== tempDesign.id) return false;
                if (d.position_id != positionId) return false;
                if (d.scope !== scope) return false;
                const dTargets = (d.targets || []).sort().join(',');
                const newTargets = targets.join(',');
                return dTargets === newTargets;
            });

            if (existingIndex > -1) {
                Swal.fire('Atención', 'Este diseño ya está configurado con la misma posición y alcance', 'info');
                return;
            }

            // Add design to state (SEPARATE RECORD per position)
            State.designs.push({
                id: tempDesign.id,
                export_id: tempDesign.export_id || null, // NEW: Store export_id for flat UI
                name: tempDesign.name,
                stitches: tempDesign.stitches,
                position_id: positionId,
                position_name: positionName,
                position_slug: positionSlug,
                scope,
                targets,
                variant_id: tempDesign.variant_id || null, // Store if from variant
                variant_name: tempDesign.variant_name || null,
                dimensions: tempDesign.dimensions || null // Store dimensions for reference
            });

            // Mark card as selected
            $(tempDesign.element).addClass('selected');

            // Reset position select for another addition
            $('#designPositionSelect').val(null).trigger('change');
            recalcFinance();

            // Show inline feedback
            $('#justAddedText').text(`Agregado en: ${positionName.trim()}`);
            $('#justAddedFeedback').removeClass('d-none');

            // Update the configured positions list (pass export_id if available)
            showConfiguredPositions(tempDesign.id, tempDesign.export_id);
        };

        // Render designs summary (for visibility)
        function renderDesignsSummary() {
            updateDesignsAddedCount();
        }

        window.updateDesignPosition = function(id, pos) {
            const d = State.designs.find(d => d.id === id);
            if (d) d.position = pos;
        };

        // --- STEP 5: EXTRAS & FINANCE ---
        window.addExtra = function() {
            const sel = $('#extrasSelector option:selected');
            const id = $('#extrasSelector').val();

            if (!id) return;
            if (State.extras.find(e => e.id == id)) {
                Swal.fire('Ya agregado', '', 'info');
                return;
            }

            State.extras.push({
                id,
                name: sel.data('name'),
                price: parseFloat(sel.data('price')),
                time: parseInt(sel.data('time')) || 0
            });
            renderExtrasTable();
            recalcFinance();
            $('#extrasSelector').val(null).trigger('change');
        };

        function renderExtrasTable() {
            const tbody = $('#extrasTableBody');
            tbody.empty();
            let total = 0;
            let totalTime = 0;

            if (State.extras.length === 0) {
                tbody.append(`<tr id="noExtrasRow">
                    <td colspan="4" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No hay servicios agregados
                    </td>
                </tr>`);
            } else {
                State.extras.forEach((e, idx) => {
                    total += e.price;
                    totalTime += (e.time || 0);
                    tbody.append(`<tr>
                        <td class="font-weight-bold">${e.name}</td>
                        <td class="text-right">$${e.price.toFixed(2)}</td>
                        <td class="text-center text-muted">${e.time || 0} min</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExtra(${idx})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`);
                });
            }

            State.financials.extras_cost = total;
            $('#extrasTotalDisplay').text('$' + total.toFixed(2));
            $('#extrasTotalTime').text(totalTime + ' min');
            $('#extrasCountBadge').text(State.extras.length);
        }

        // Global flag moved to top of script


        // Function to render design previews in Step 6 (called only when entering the step)
        window.renderStep6Designs = function() {
            const designPreviews = $('#finDesignPreviews');
            designPreviews.empty();

            State.designs.forEach(d => {
                // Get image URL from State (already captured from DOM or preview route)
                let displayImg = d.image_url || '';

                // Fallback: Construct preview URL from export_id
                if (!displayImg && d.export_id) {
                    displayImg = "{{ route('admin.production.preview', ['export' => '__ID__']) }}".replace(
                        '__ID__', d.export_id);
                }

                // Get label from position_name
                let appLabel = d.position_name || 'N/A';

                // If no image in state, try DOM fallback
                if (!displayImg) {
                    // Find card by export_id (unique) on the inner card element
                    const step4Card = $(`.design-export-card[data-export-id="${d.export_id}"]`);
                    if (step4Card.length > 0) {
                        const imgTag = step4Card.find('.design-thumb img');
                        if (imgTag.length > 0 && imgTag.attr('src')) {
                            displayImg = imgTag.attr('src');
                        }
                    }
                }

                // Render Thumbnail - CLEAN & ROBUST (No ghost icons)
                let thumbContent;
                if (displayImg) {
                    thumbContent = `
                        <img src="${displayImg}" style="width:100%; height:100%; object-fit:contain;" 
                            onerror="this.parentNode.innerHTML='<div class=\'d-flex align-items-center justify-content-center h-100 text-muted\'><i class=\'fas fa-image fa-lg py-3\'></i></div>'">
                    `;
                } else {
                    thumbContent = `
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted bg-light">
                            <i class="fas fa-image fa-lg"></i>
                        </div>
                    `;
                }

                designPreviews.append(`
                    <div class="d-flex flex-column align-items-center text-center mr-2 mb-2" style="width: 120px;" title="${d.name}">
                        <div style="width:75px; height:75px; border-radius:10px; overflow:hidden; border:2px solid #dee2e6; cursor:pointer; background:#fff; display:flex; align-items:center; justify-content:center;" 
                             onclick="showDesignZoom('${displayImg.replace(/'/g, "\\'")}', '${d.name.replace(/'/g, "\\'")}')">
                            ${thumbContent}
                        </div>
                        <div class="mt-2 w-100">
                            <div style="font-size:0.95rem; color:#1a252f; font-weight:700; line-height:1.2; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${d.name}</div>
                            <div class="badge w-100 text-truncate mt-1 text-white border-0" style="font-size:0.85rem; background:#117a8b; font-weight:600;">${appLabel}</div>
                        </div>
                    </div>
                `);
            });
        };
        window.removeExtra = function(idx) {
            State.extras.splice(idx, 1);
            renderExtrasTable();
            recalcFinance();
        };

        window.recalcFinance = function() {
            // 1. MATERIAL COST
            let matCost = 0;
            const matList = $('#finMaterialsList');
            matList.empty();

            if (State.bom.length > 0) {
                let html = '';
                State.bom.forEach(m => {
                    let matName = m.name || (m.family_name ? `${m.family_name} - ${m.variant_name}` :
                        'Material');
                    let mainLabel = matName;
                    let scopeBadge = '';

                    // FORMATTING: Names of variants
                    if (m.scope === 'specific' && m.targets) {
                        const vNames = m.targets.map(tid => {
                            const v = State.variants.find(va => va.temp_id === tid);
                            return v ? `${v.size}/${v.color}` : '';
                        }).filter(Boolean).join(', ');

                        if (vNames.length > 50) {
                            scopeBadge =
                                `<span class="badge badge-info custom-scope-badge mr-1" style="white-space:normal; text-align:left; font-size: 0.85rem;" title="${vNames}">Specific: ${vNames.substring(0,47)}...</span>`;
                        } else {
                            if (vNames) scopeBadge =
                                `<span class="badge badge-info custom-scope-badge mr-1" style="white-space:normal; text-align:left; font-size: 0.85rem;">Specific: ${vNames}</span>`;
                        }
                    } else {
                        // GLOBAL: Visually expand
                        const allVariants = State.variants.map(v => `${v.size}/${v.color}`).join(', ');
                        const displayText = allVariants || 'Todas';
                        if (displayText.length > 80) {
                            scopeBadge =
                                `<span class="badge badge-dark custom-scope-badge mr-1" style="white-space:normal; text-align:left; font-size: 0.85rem;" title="${displayText}">Global: ${displayText.substring(0,77)}...</span>`;
                        } else {
                            scopeBadge =
                                `<span class="badge badge-dark custom-scope-badge mr-1" style="white-space:normal; text-align:left; font-size: 0.85rem;">Global: ${displayText}</span>`;
                        }
                    }

                    // Layout
                    mainLabel = scopeBadge;
                    let subLabel =
                        `<div class="font-weight-bold mt-1 text-dark" style="font-size: 1rem;">${matName}</div>`;

                    html += `<div class="calc-mat-item border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex:1;">
                                ${mainLabel}
                                ${subLabel}
                                <div class="text-muted mt-1" style="font-size: 0.9rem;">
                                    <i class="fas fa-ruler-combined mr-1"></i>${m.qty} ${m.unit}
                                </div>
                            </div>
                            <div class="font-weight-bold text-primary pl-2" style="font-size: 1rem;">$${(m.cost * m.qty).toFixed(2)}</div>
                        </div>
                    </div>`;

                    matCost += (parseFloat(m.cost) * parseFloat(m.qty));
                });
                matList.html(html);
            } else {
                matList.html(
                    '<div class="text-muted small text-center py-4">No hay materiales seleccionados.</div>');
            }
            $('#finMatCost').text('$' + matCost.toFixed(2));
            $('#revMatCost').text('$' + matCost.toFixed(2));


            // Calculate total stitches for finance
            let totalStitches = 0;
            State.designs.forEach(d => {
                totalStitches += parseInt(d.stitches);
            });

            // Update design previews:
            // 1. If flag is set (explicit update request)
            // 2. OR if we have designs but no images are shown (safety fallback)
            const previewsContainer = $('#finDesignPreviews');
            const hasImages = previewsContainer.find('img').length > 0;

            if (shouldRenderDesigns || (State.designs.length > 0 && !hasImages)) {
                renderStep6Designs();
                shouldRenderDesigns = false; // Reset flag
            }

            $('#finTotalStitches').text(totalStitches.toLocaleString());
            const millares = totalStitches / 1000;
            $('#finMillares').text(millares.toFixed(3));

            const rate = parseFloat($('#finStitchRate').val()) || 0;
            const embCost = millares * rate;

            $('#finEmbCost').text('$' + embCost.toFixed(2));
            $('#revEmbCost').text('$' + embCost.toFixed(2));


            // 3. LABOR COST
            const laborCost = parseFloat($('#finLaborInput').val()) || 0;
            $('#finLaborCostDisplay').text('$' + laborCost.toFixed(2));
            $('#revLaborCost').text('$' + laborCost.toFixed(2));


            // 4. EXTRAS COST & TIME
            let extrasCost = 0;
            let extrasTime = 0;
            const extrasList = $('#finExtrasList');
            extrasList.empty();

            if (State.extras && State.extras.length > 0) {
                let exHtml = '';
                // FIXED LOOP VARIABLE
                State.extras.forEach(ex => {
                    const thisCost = parseFloat(ex.cost || ex.price || 0);
                    extrasCost += thisCost;
                    extrasTime += parseInt(ex.time || 0);

                    exHtml += `
                        <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-2" style="font-size:0.95rem;">
                            <span class="font-weight-bold text-dark">${ex.name}</span>
                            <div class="d-flex align-items-center">
                                <span class="badge badge-dark mr-2 p-2" style="min-width:50px;">${ex.time || 0}m</span>
                                <span class="font-weight-bold text-dark" style="font-size:1rem;">$${thisCost.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
                extrasList.html(exHtml);
            } else {
                extrasList.html('<span class="text-muted small">Sin servicios extras.</span>');
            }

            $('#finExtrasTotal').text('$' + extrasCost.toFixed(2));
            $('#revExtraCost').text('$' + extrasCost.toFixed(2));
            $('#finExtrasTime').text(extrasTime + ' min');
            $('#revExtrasTime').text(extrasTime + ' min');


            // 5. TIMES
            const machineSpeed = parseInt($('#finMachineSpeed').val()) || 800;
            const embTimeMinutes = machineSpeed > 0 ? Math.ceil(totalStitches / machineSpeed) : 0;
            $('#finEmbroideryTime').text(embTimeMinutes + ' min');
            $('#revEmbTime').text(embTimeMinutes + ' min');

            const totalProcessTime = embTimeMinutes + extrasTime;
            let timeStr = totalProcessTime + ' min';
            if (totalProcessTime > 60) {
                const h = Math.floor(totalProcessTime / 60);
                const m = totalProcessTime % 60;
                timeStr = `${h}h ${m}m`;
            }
            $('#revTotalTime').text(timeStr);


            // 6. TOTALS
            const totalCost = matCost + embCost + laborCost + extrasCost;
            $('#revTotalCost').text('$' + totalCost.toFixed(2));

            State.financials = {
                material_cost: matCost,
                embroidery_cost: embCost,
                labor_cost: laborCost,
                extras_cost: extrasCost,
                total_cost: totalCost
            };

            recalcReviewPrice();
        };

        // --- STEP 6: REVIEW (PREMIUM CLEAN) ---
        window.renderReview = function() {
            const f = State.financials;

            // Product Identity
            $('#revProductName').text(State.definition.name || '-');
            $('#revProductSku').text(State.definition.sku || '-');
            $('#revProductCategory').text(State.definition.category || '-');

            // Variants - Vertical List with Gray Outline
            $('#revVarCount').text(State.variants.length);
            if (State.variants.length > 0) {
                let varHtml = '';
                State.variants.forEach(v => {
                    varHtml += `<div class="review-variant-item">
                        <span class="review-variant-text">${v.size} / ${v.color}</span>
                        <span class="review-variant-sku">SKU: ${v.sku_variant}</span>
                    </div>`;
                });
                $('#revVariants').html(varHtml);
            } else {
                $('#revVariants').html('<span class="text-muted">Sin variantes</span>');
            }

            // Materials - Clean compact list (Less separation)
            $('#revBomCount').text(State.bom.length);
            if (State.bom.length > 0) {
                let bomHtml = '';
                State.bom.forEach(m => {
                    const name = m.family_name || m.name;
                    const variant = m.variant_name ? ` - ${m.variant_name}` : '';
                    bomHtml += `<div class="review-item-row">
                        <div class="d-flex align-items-center">
                            <span class="review-item-name mr-2">${name}${variant}</span>
                        </div>
                        <span class="review-item-qty">${m.qty} ${m.unit}</span>
                    </div>`;
                });
                $('#revBomList').html(bomHtml);
            } else {
                $('#revBomList').html('<span class="text-muted">Sin materiales</span>');
            }

            // Bordados - Clean compact list  
            const isNoDesign = $('#toggleNoDesign').is(':checked');
            $('#revEmbCount').text(State.designs.length);

            if (isNoDesign) {
                $('#revDesignsList').html('<span class="text-muted">Producto liso</span>');
            } else if (State.designs.length > 0) {
                let designsHtml = '';
                State.designs.forEach(d => {
                    const stitches = d.stitches || 0;
                    const millares = (stitches / 1000).toFixed(2);
                    designsHtml += `<div class="review-design-item">
                        <div class="review-design-name">${d.name}</div>
                        <div class="review-design-info">
                            <span>${d.position_name || 'Sin posición'}</span>
                            <span class="text-success font-weight-bold">${stitches.toLocaleString()} pts (${millares} millares)</span>
                        </div>
                    </div>`;
                });
                $('#revDesignsList').html(designsHtml);
            } else {
                $('#revDesignsList').html('<span class="text-muted">Sin bordados</span>');
            }

            // Extras - Grid Layout (2 cols) - Inline Format
            $('#revExtraCount').text(State.extras.length);
            if (State.extras.length > 0) {
                let extrasHtml = '';
                State.extras.forEach(e => {
                    extrasHtml += `<div class="review-extra-item">
                        <span class="review-extra-inline">${e.name} - $${e.price.toFixed(2)}</span>
                    </div>`;
                });
                // Add class for grid layout to the container if not exists
                $('#revExtrasList').addClass('review-extras-grid').html(extrasHtml);
                $('#revExtrasContainer').show();
            } else {
                $('#revExtrasContainer').hide();
            }

            // Financial Summary
            $('#revMatCost').text(`$${f.material_cost.toFixed(2)}`);
            $('#revEmbCost').text(`$${f.embroidery_cost.toFixed(2)}`);
            $('#revLaborCost').text(`$${f.labor_cost.toFixed(2)}`);
            $('#revExtraCost').text(`$${f.extras_cost.toFixed(2)}`);
            $('#revTotalCost').text(`$${f.total_cost.toFixed(2)}`);

            // Initialize pricing controls
            $('#revMarginInput').val(f.margin || 35);
            recalcReviewPrice();
        };

        // Recalculate price in Step 6 review
        window.recalcReviewPrice = function() {
            const f = State.financials;
            const margin = parseFloat($('#revMarginInput').val()) || 0;
            f.margin = margin;

            let suggestedPrice = 0;
            if (margin < 100) {
                suggestedPrice = f.total_cost / (1 - (margin / 100));
            }
            f.price = suggestedPrice;

            $('#revSuggestedPrice').text(`$${suggestedPrice.toFixed(2)}`);
            $('#revFinalPrice').attr('placeholder', suggestedPrice.toFixed(2));
        };

        // Update header when manual price is entered
        window.updateHeaderPrice = function() {
            const customPrice = parseFloat($('#revFinalPrice').val());
            if (customPrice > 0) {
                State.financials.price = customPrice;
            }
        };

        // Design Zoom Modal
        window.showDesignZoom = function(imageUrl, designName) {
            Swal.fire({
                title: designName,
                imageUrl: imageUrl,
                imageWidth: 400,
                imageHeight: 400,
                imageAlt: designName,
                showConfirmButton: false,
                showCloseButton: true,
                customClass: {
                    image: 'design-zoom-image'
                }
            });
        };

        // --- SUBMIT ---
        window.submitForm = async function() {
            // Enterprise Concurrency Control: JIT Validation
            Swal.fire({
                title: '¿Crear Producto?',
                text: `Precio Final: $${State.financials.price.toFixed(2)}`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sí, Fabricar'
            }).then(async (res) => {
                if (res.isConfirmed) {
                    // 1. Show Blocking Loader
                    Swal.fire({
                        title: 'Verificando precios...',
                        text: 'Asegurando consistencia de datos...',
                        allowOutsideClick: false,
                        didOpen: () => Swal.showLoading()
                    });

                    try {
                        // 2. Perform Pre-flight Check
                        const check = await checkMaterialPrices();

                        if (check.has_changes) {
                            // 3. CONFLICT DETECTED: Abort and Show UI
                            Swal.close();
                            validateMaterialPrices(); // Re-use the existing UI handler
                            return; // STOP SUBMISSION
                        }

                        // 4. NO CONFLICT: Proceed to Submit
                        $('#h_variants').val(JSON.stringify(State.variants));
                        $('#h_materials').val(JSON.stringify(State.bom));
                        $('#h_embroideries').val(JSON.stringify(State.designs));
                        $('#h_extras').val(JSON.stringify(State.extras));
                        $('#h_financials').val(JSON.stringify(State.financials));

                        $('#productForm').submit();

                    } catch (e) {
                        Swal.close();
                        Swal.fire('Error',
                            'No se pudo verificar la consistencia de precios. Intente nuevamente.',
                            'error');
                        console.error(e);
                    }
                }
            });
        };


        // SEARCH FUNCTIONALITY FOR DESIGNS (UPDATED for new flat UI)
        // Note: Main search handler is now in filterDesignExports() function
        // This is kept for backward compatibility but delegates to the new function
        $(document).off('input', '#searchDesign').on('input', '#searchDesign', function() {
            // Call the new filter function which handles both old and new UI
            if (typeof filterDesignExports === 'function') {
                filterDesignExports();
            } else {
                // Fallback for old UI
                const term = $(this).val().toLowerCase();
                $('#designGrid .design-export-item, #designGrid .col-md-3').each(function() {
                    const card = $(this).find('.design-card');
                    const name = ($(this).data('name') || card.find('h5, h6').text()).toLowerCase();
                    const appType = ($(this).data('app-type') || card.data('app-type') || '')
                        .toLowerCase();

                    if (name.includes(term) || appType.includes(term) || term === '') {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            }
        });

        // SELECT2 CUSTOM FORMATTING FOR VARIANTS (Inserted Logic)
        $(function() {
            function formatDesignVariant(state) {
                if (!state.id) {
                    return state.text;
                }
                const img = $(state.element).data('image');
                const code = $(state.element).data('code') || '';

                if (!img) return state.text;

                const $state = $(
                    `<span class="d-flex align-items-center">
                                <img src="${img}" style="width: 30px; height: 30px; object-fit: cover; border-radius: 4px; margin-right: 10px;" />
                                <span>
                                    <div class="font-weight-bold" style="line-height: 1;">${state.text}</div>
                                    <small class="text-muted">${code}</small>
                                </span>
                            </span>`
                );
                return $state;
            }

            // Global Init
            $('.select2-design-variant').select2({
                dropdownParent: $('#designConfigModal'),
                width: '100%',
                templateResult: formatDesignVariant,
                templateSelection: formatDesignVariant,
                minimumResultsForSearch: Infinity
            });

            // Re-bind on modal event to ensure width is correct
            $(document).on('shown.bs.modal', '#designConfigModal', function() {
                if (!$('#designVariantSelect').data('select2')) {
                    $('#designVariantSelect').select2({
                        dropdownParent: $('#designConfigModal'),
                        width: '100%',
                        templateResult: formatDesignVariant,
                        templateSelection: formatDesignVariant,
                        minimumResultsForSearch: Infinity
                    });
                }
            });

            // FIX: Update Unit Label immediately when Family is selected
            $('#bomFamilySelector').on('change', function() {
                const selectedOption = $(this).find(':selected');
                const unit = selectedOption.data('unit');
                if (unit) {
                    $('#bomUnit').text(unit);
                } else {
                    $('#bomUnit').text('unid');
                }
            });

            // === EXIT CONFIRMATION (Unsaved Changes) ===
            let formSubmitting = false;

            function hasUnsavedData() {
                return State.variants.length > 0 ||
                    State.bom.length > 0 ||
                    State.designs.length > 0 ||
                    State.extras.length > 0 ||
                    State.definition.name;
            }

            // Native browser beforeunload (backup)
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedData() && !formSubmitting) {
                    e.preventDefault();
                    e.returnValue = '';
                    return '';
                }
            });

            // Intercept navigation links - EXCLUDE sidebar toggles, treeview, and menu headers
            $(document).on('click',
                'a[href]:not([href^="#"]):not([href^="javascript"]):not([data-widget]):not(.nav-link[data-toggle]):not(.has-treeview > a)',
                function(e) {
                    // Also skip if inside the stepper or form controls
                    if ($(this).closest('.stepper-nav, .step-content, .modal').length > 0) {
                        return; // Allow normal navigation within the form
                    }

                    if (hasUnsavedData() && !formSubmitting) {
                        e.preventDefault();
                        const targetUrl = $(this).attr('href');

                        Swal.fire({
                            title: '¿Salir sin guardar?',
                            text: 'Tienes cambios sin guardar. ¿Qué deseas hacer?',
                            icon: 'warning',
                            showDenyButton: true,
                            showCancelButton: true,
                            confirmButtonText: 'Guardar Borrador',
                            denyButtonText: 'Descartar y Salir',
                            cancelButtonText: 'Continuar Editando',
                            confirmButtonColor: '#28a745',
                            denyButtonColor: '#dc3545'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // TODO: Implement save as draft via AJAX
                                formSubmitting = true;
                                // For now, just warn and stay
                                Swal.fire('Guardado', 'Producto guardado como borrador', 'success')
                                    .then(() => {
                                        window.location.href = targetUrl;
                                    });
                            } else if (result.isDenied) {
                                formSubmitting = true;
                                window.location.href = targetUrl;
                            }
                            // Dismiss = stay on page
                        });
                    }
                });

            // Set flag when form is submitting
            $('form').on('submit', function() {
                formSubmitting = true;
            });

            // === BROWSER BACK BUTTON HANDLER ===
            // Push initial state
            if (history.state === null) {
                history.pushState({
                    page: 'product-create'
                }, '', window.location.href);
            }

            // Handle browser back button
            window.addEventListener('popstate', function(e) {
                if (hasUnsavedData() && !formSubmitting) {
                    // Push state back to prevent navigation
                    history.pushState({
                        page: 'product-create'
                    }, '', window.location.href);

                    Swal.fire({
                        title: '¿Salir sin guardar?',
                        text: 'Tienes cambios sin guardar. ¿Qué deseas hacer?',
                        icon: 'warning',
                        showDenyButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'Guardar Borrador',
                        denyButtonText: 'Descartar y Salir',
                        cancelButtonText: 'Continuar Editando',
                        confirmButtonColor: '#28a745',
                        denyButtonColor: '#dc3545'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            formSubmitting = true;
                            Swal.fire('Guardado', 'Producto guardado como borrador', 'success')
                                .then(() => {
                                    history.back();
                                });
                        } else if (result.isDenied) {
                            formSubmitting = true;
                            history.back();
                        }
                        // Dismiss = stay on page (state already pushed back)
                    });
                }
            });
        });
    </script>
@stop
</file>

<file path="routes/web.php">
<?php

use Illuminate\Support\Facades\Route;
use Illuminate\Support\Facades\Auth;


// Ruta raíz
Route::get('/', function () {
    return view('auth.login');
});

// Autenticación
Auth::routes([
    'register' => false,
]);

// Home
Route::get('/home', [App\Http\Controllers\HomeController::class, 'index'])
    ->name('home')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE DISEÑOS
|--------------------------------------------------------------------------
*/

Route::get('admin/designs', [App\Http\Controllers\DesignController::class, 'index'])
    ->name('admin.designs.index')
    ->middleware('auth');

// AJAX: Listado de diseños sin reload (para Web App)
Route::get('admin/designs/ajax-list', [App\Http\Controllers\DesignController::class, 'ajaxList'])
    ->name('admin.designs.ajax-list')
    ->middleware('auth');

Route::get('admin/designs/create', [App\Http\Controllers\DesignController::class, 'create'])
    ->name('admin.designs.create')
    ->middleware('auth');

// Ruta para limpiar imagen temporal
Route::post('admin/designs/clear-temp-image', [App\Http\Controllers\DesignController::class, 'clearTempImage'])
    ->name('admin.designs.clear-temp-image')
    ->middleware('auth');

Route::middleware(['secure.file.upload'])->group(function () {
    Route::post('admin/designs', [App\Http\Controllers\DesignController::class, 'store'])
        ->name('admin.designs.store')
        ->middleware('auth');
});

Route::get('admin/designs/{design}', [App\Http\Controllers\DesignController::class, 'show'])
    ->name('admin.designs.show')
    ->middleware('auth');

Route::get('admin/designs/{design}/edit', [App\Http\Controllers\DesignController::class, 'edit'])
    ->name('admin.designs.edit')
    ->middleware('auth');

Route::middleware(['secure.file.upload'])->group(function () {
    Route::put('admin/designs/{design}', [App\Http\Controllers\DesignController::class, 'update'])
        ->name('admin.designs.update')
        ->middleware('auth');
});

Route::delete('admin/designs/{design}', [App\Http\Controllers\DesignController::class, 'destroy'])
    ->name('admin.designs.destroy')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE VARIANTES
|--------------------------------------------------------------------------
*/

Route::get('admin/designs/{design}/variants/create', [App\Http\Controllers\DesignVariantController::class, 'create'])
    ->name('admin.designs.variants.create')
    ->middleware('auth');

Route::post('admin/designs/{design}/variants', [App\Http\Controllers\DesignVariantController::class, 'store'])
    ->name('admin.designs.variants.store')
    ->middleware('auth');

Route::get('admin/designs/{design}/variants/{variant}/edit', [App\Http\Controllers\DesignVariantController::class, 'edit'])
    ->name('admin.designs.variants.edit')
    ->middleware('auth');

Route::put('admin/designs/{design}/variants/{variant}', [App\Http\Controllers\DesignVariantController::class, 'update'])
    ->name('admin.designs.variants.update')
    ->middleware('auth');

Route::delete('admin/designs/{design}/variants/{variant}', [App\Http\Controllers\DesignVariantController::class, 'destroy'])
    ->name('admin.designs.variants.destroy')
    ->middleware('auth');

Route::delete('admin/designs/{design}/variants/{variant}/images/{image}', [App\Http\Controllers\DesignVariantController::class, 'destroyImage'])
    ->name('admin.designs.variants.images.destroy')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE PRODUCCIÓN / EXPORTACIONES
|--------------------------------------------------------------------------
*/

// Módulo Producción (Principal)
Route::group(['prefix' => 'admin/production', 'as' => 'admin.production.', 'middleware' => ['auth']], function () {
    Route::get('/', [App\Http\Controllers\ProduccionController::class, 'index'])->name('index');
    Route::get('/create', [App\Http\Controllers\ProduccionController::class, 'create'])->name('create');
    Route::post('/', [App\Http\Controllers\ProduccionController::class, 'store'])->name('store');
    Route::get('/{id}', [App\Http\Controllers\ProduccionController::class, 'show'])->name('show');
    Route::get('/{id}/edit', [App\Http\Controllers\ProduccionController::class, 'edit'])->name('edit');
    Route::put('/{id}', [App\Http\Controllers\ProduccionController::class, 'update'])->name('update');
    Route::delete('/{id}', [App\Http\Controllers\ProduccionController::class, 'destroy'])->name('destroy');
    Route::get('/{id}/download', [App\Http\Controllers\ProduccionController::class, 'download'])->name('download');

    // Acciones de estado
    Route::post('/{id}/solicitar', [App\Http\Controllers\ProduccionController::class, 'requestApproval'])->name('request');
    Route::post('/{id}/aprobar', [App\Http\Controllers\ProduccionController::class, 'approve'])->name('approve');
    Route::post('/{id}/archivar', [App\Http\Controllers\ProduccionController::class, 'archive'])->name('archive');
    Route::post('/{id}/revertir', [App\Http\Controllers\ProduccionController::class, 'revert'])->name('revert');
    Route::post('/{id}/restaurar', [App\Http\Controllers\ProduccionController::class, 'restore'])->name('restore');

    // Vista previa
    Route::get('/{export}/preview', [App\Http\Controllers\DesignPreviewController::class, 'preview'])->name('preview');
});

// Exportaciones para un diseño específico (sin variante)
Route::get('admin/designs/{design}/exports', [App\Http\Controllers\DesignExportController::class, 'forDesign'])
    ->name('admin.designs.exports.index')
    ->middleware('auth');

Route::get('admin/designs/{design}/exports/create', [App\Http\Controllers\DesignExportController::class, 'createForDesign'])
    ->name('admin.designs.exports.create')
    ->middleware('auth');

Route::post('admin/designs/{design}/exports', [App\Http\Controllers\DesignExportController::class, 'storeForDesign'])
    ->name('admin.designs.exports.store')
    ->middleware('auth');

// Exportaciones para una variante específica
Route::get('admin/designs/{design}/variants/{variant}/exports/create', [App\Http\Controllers\DesignExportController::class, 'createForVariant'])
    ->name('admin.variants.exports.create')
    ->middleware('auth');

Route::post('admin/designs/{design}/variants/{variant}/exports', [App\Http\Controllers\DesignExportController::class, 'storeForVariant'])
    ->name('admin.variants.exports.store')
    ->middleware('auth');

// AJAX: Obtener contador de exportaciones del diseño (para pestaña Producción)
Route::get('admin/designs/{design}/exports-count', [App\Http\Controllers\DesignExportController::class, 'getDesignExportsCount'])
    ->name('admin.designs.exports-count')
    ->middleware('auth');

// AJAX: Obtener exportaciones de una variante específica (para contador de producción)
Route::get('admin/designs/{design}/variants/{variant}/exports/ajax', [App\Http\Controllers\DesignExportController::class, 'getVariantExports'])
    ->name('admin.variants.exports.ajax')
    ->middleware('auth');


/*
|--------------------------------------------------------------------------
| RUTAS DE VISUALIZADOR DE BORDADOS (STANDALONE)
|--------------------------------------------------------------------------
*/
Route::get('admin/visualizer', [App\Http\Controllers\VisualizerController::class, 'index'])
    ->name('admin.visualizer.index')
    ->middleware('auth');

Route::post('admin/visualizer/analyze', [App\Http\Controllers\VisualizerController::class, 'analyze'])
    ->name('admin.visualizer.analyze')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS AJAX PARA EXPORTACIONES (MODAL)
|--------------------------------------------------------------------------
*/

// Analizar archivo de bordado (PyEmbroidery)
Route::post('admin/exports/analyze', [App\Http\Controllers\DesignExportController::class, 'analyzeFile'])
    ->name('admin.exports.analyze')
    ->middleware('auth');

// Guardar exportación via AJAX (desde modal)
Route::post('admin/exports/store-ajax', [App\Http\Controllers\DesignExportController::class, 'storeAjax'])
    ->name('admin.exports.store-ajax')
    ->middleware('auth');

// ⭐ ACTUALIZAR EXPORTACIÓN VIA AJAX - PUT
Route::put('admin/exports/{export}/update-ajax', [App\Http\Controllers\DesignExportController::class, 'updateAjax'])
    ->name('admin.exports.update-ajax')
    ->middleware('auth');

// ⭐ ACTUALIZAR EXPORTACIÓN VIA AJAX - POST (para compatibilidad con _method)
Route::post('admin/exports/{export}/update-ajax', [App\Http\Controllers\DesignExportController::class, 'updateAjax'])
    ->name('admin.exports.update-ajax-post')
    ->middleware('auth');

// ⭐ ACTUALIZAR ESTADO DE EXPORTACIÓN VIA AJAX
Route::post('admin/exports/{export}/status', [App\Http\Controllers\DesignExportController::class, 'updateStatus'])
    ->name('admin.exports.update-status')
    ->middleware('auth');

// Obtener exportación específica via AJAX
Route::get('admin/exports/{export}/ajax', [App\Http\Controllers\DesignExportController::class, 'getExport'])
    ->name('admin.exports.get-ajax')
    ->middleware('auth');

// Eliminar exportación via AJAX
Route::delete('admin/exports/{export}/ajax', [App\Http\Controllers\DesignExportController::class, 'destroyAjax'])
    ->name('admin.exports.destroy-ajax')
    ->middleware('auth');

// Obtener tipos de aplicación
Route::get('admin/exports/application-types', [App\Http\Controllers\DesignExportController::class, 'getApplicationTypes'])
    ->name('admin.exports.application-types')
    ->middleware('auth');

// Obtener extensiones permitidas
Route::get('admin/exports/allowed-extensions', [App\Http\Controllers\DesignExportController::class, 'getAllowedExtensions'])
    ->name('admin.exports.allowed-extensions')
    ->middleware('auth');

// Obtener exportaciones de diseño (AJAX para modal)
Route::get('admin/designs/{design}/exports/ajax', [App\Http\Controllers\DesignExportController::class, 'getDesignExports'])
    ->name('admin.designs.exports.ajax')
    ->middleware('auth');

// Obtener exportaciones de variante (AJAX para modal)
Route::get('admin/designs/{design}/variants/{variant}/exports/ajax', [App\Http\Controllers\DesignExportController::class, 'getVariantExports'])
    ->name('admin.designs.variants.exports.ajax')
    ->middleware('auth');

// ⭐ NUEVO: Obtener TODAS las exportaciones de un diseño agrupadas por variante
Route::get('admin/designs/{design}/exports-grouped', [App\Http\Controllers\DesignExportController::class, 'getAllDesignExportsGrouped'])
    ->name('admin.designs.exports-grouped')
    ->middleware('auth');

// ⭐ CONTADOR DE EXPORTACIONES (para actualizar cards en tiempo real)
Route::get('admin/designs/{design}/exports-count', [App\Http\Controllers\DesignExportController::class, 'getExportsCount'])
    ->name('admin.designs.exports-count')
    ->middleware('auth');

// ⭐ CONTADOR DE EXPORTACIONES SIN IMAGE_ID (para badge de imagen principal del diseño)
Route::get('admin/designs/{design}/exports-without-image-count', [App\Http\Controllers\DesignExportController::class, 'getExportsWithoutImageCount'])
    ->name('admin.designs.exports-without-image-count')
    ->middleware('auth');

// ⭐ CONTADOR DE EXPORTACIONES POR IMAGEN (para badges en galería)
Route::get('admin/images/{image}/exports-count', [App\Http\Controllers\DesignExportController::class, 'getImageExportsCount'])
    ->name('admin.images.exports-count')
    ->middleware('auth');

// ⭐ CONTADORES BATCH DE EXPORTACIONES (múltiples imágenes en una sola petición)
Route::post('admin/images/exports-counts-batch', [App\Http\Controllers\DesignExportController::class, 'getImagesExportsCounts'])
    ->name('admin.images.exports-counts-batch')
    ->middleware('auth');

// ⭐ OBTENER EXPORTACIONES POR IMAGEN
Route::get('admin/images/{image}/exports', [App\Http\Controllers\DesignExportController::class, 'getImageExports'])
    ->name('admin.images.exports')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE CATEGORÍAS
|--------------------------------------------------------------------------
*/
Route::get('admin/categories', [App\Http\Controllers\CategoryController::class, 'index'])
    ->name('admin.categories.index')
    ->middleware('auth');

Route::get('admin/categories/create', [App\Http\Controllers\CategoryController::class, 'create'])
    ->name('admin.categories.create')
    ->middleware('auth');

Route::post('admin/categories', [App\Http\Controllers\CategoryController::class, 'store'])
    ->name('admin.categories.store')
    ->middleware('auth');

Route::get('admin/categories/{category}', [App\Http\Controllers\CategoryController::class, 'show'])
    ->name('admin.categories.show')
    ->middleware('auth');

Route::get('admin/categories/{category}/edit', [App\Http\Controllers\CategoryController::class, 'edit'])
    ->name('admin.categories.edit')
    ->middleware('auth');

Route::put('admin/categories/{category}', [App\Http\Controllers\CategoryController::class, 'update'])
    ->name('admin.categories.update')
    ->middleware('auth');

Route::get('admin/categories/{category}/confirm-delete', [App\Http\Controllers\CategoryController::class, 'confirm_delete'])
    ->name('admin.categories.confirm_delete')
    ->middleware('auth');

Route::delete('admin/categories/{category}', [App\Http\Controllers\CategoryController::class, 'destroy'])
    ->name('admin.categories.destroy')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE BÚSQUEDA
|--------------------------------------------------------------------------
*/

Route::get('admin/search', [App\Http\Controllers\SearchController::class, 'index'])
    ->name('admin.search.index')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS ANTIGUAS (MANTENER SI ESTÁN EN USO)
|--------------------------------------------------------------------------
*/

// Giros
Route::get('/giros', [App\Http\Controllers\GiroController::class, 'index'])
    ->name('admin.giros.index')
    ->middleware('auth');
Route::get('/giros/nuevo', [App\Http\Controllers\GiroController::class, 'create'])
    ->name('admin.giros.create')
    ->middleware('auth');
Route::post('/giros/create', [App\Http\Controllers\GiroController::class, 'store'])
    ->name('admin.giros.store')
    ->middleware('auth');
Route::get('/giros/edit/{id}', [App\Http\Controllers\GiroController::class, 'edit'])
    ->name('admin.giros.edit')
    ->middleware('auth');
Route::put('/giros/edit/{id}', [App\Http\Controllers\GiroController::class, 'update'])
    ->name('admin.giros.update')
    ->middleware('auth');
Route::get('/giros/confirm_delete/{id}', [App\Http\Controllers\GiroController::class, 'confirm_delete'])
    ->name('admin.giros.confirm_delete')
    ->middleware('auth');
Route::delete('/giros/delete/{id}', [App\Http\Controllers\GiroController::class, 'destroy'])
    ->name('admin.giros.destroy')
    ->middleware('auth');

// Estados
Route::get('/estados', [App\Http\Controllers\EstadoController::class, 'index'])
    ->name('admin.estados.index')
    ->middleware('auth');
Route::get('/estados/nuevo', [App\Http\Controllers\EstadoController::class, 'create'])
    ->name('admin.estados.create')
    ->middleware('auth');
Route::post('/estados/create', [App\Http\Controllers\EstadoController::class, 'store'])
    ->name('admin.estados.store')
    ->middleware('auth');
Route::get('/estados/edit/{id}', [App\Http\Controllers\EstadoController::class, 'edit'])
    ->name('admin.estados.edit')
    ->middleware('auth');
Route::put('/estados/edit/{id}', [App\Http\Controllers\EstadoController::class, 'update'])
    ->name('admin.estados.update')
    ->middleware('auth');
Route::get('/estados/confirm_delete/{id}', [App\Http\Controllers\EstadoController::class, 'confirm_delete'])
    ->name('admin.estados.confirm_delete')
    ->middleware('auth');
Route::delete('/estados/delete/{id}', [App\Http\Controllers\EstadoController::class, 'destroy'])
    ->name('admin.estados.destroy')
    ->middleware('auth');



// Proveedores
Route::get('/proveedores', [App\Http\Controllers\ProveedorController::class, 'index'])
    ->name('admin.proveedores.index')
    ->middleware('auth');
Route::get('/proveedores/nuevo', [App\Http\Controllers\ProveedorController::class, 'create'])
    ->name('admin.proveedores.create')
    ->middleware('auth');
Route::post('/proveedores/create', [App\Http\Controllers\ProveedorController::class, 'store'])
    ->name('admin.proveedores.store')
    ->middleware('auth');
Route::get('/proveedores/edit/{id}', [App\Http\Controllers\ProveedorController::class, 'edit'])
    ->name('admin.proveedores.edit')
    ->middleware('auth');
Route::put('/proveedores/edit/{id}', [App\Http\Controllers\ProveedorController::class, 'update'])
    ->name('admin.proveedores.update')
    ->middleware('auth');
Route::get('/proveedores/confirm_delete/{id}', [App\Http\Controllers\ProveedorController::class, 'confirm_delete'])
    ->name('admin.proveedores.confirm_delete')
    ->middleware('auth');
Route::delete('/proveedores/delete/{id}', [App\Http\Controllers\ProveedorController::class, 'destroy'])
    ->name('admin.proveedores.destroy')
    ->middleware('auth');

// Recomendaciones
Route::get('/recomendaciones', [App\Http\Controllers\RecomendacionController::class, 'index'])
    ->name('admin.recomendaciones.index')
    ->middleware('auth');
Route::get('/recomendaciones/nuevo', [App\Http\Controllers\RecomendacionController::class, 'create'])
    ->name('admin.recomendaciones.create')
    ->middleware('auth');
Route::post('/recomendaciones/create', [App\Http\Controllers\RecomendacionController::class, 'store'])
    ->name('admin.recomendaciones.store')
    ->middleware('auth');
Route::get('/recomendaciones/edit/{id}', [App\Http\Controllers\RecomendacionController::class, 'edit'])
    ->name('admin.recomendaciones.edit')
    ->middleware('auth');
Route::put('/recomendaciones/edit/{id}', [App\Http\Controllers\RecomendacionController::class, 'update'])
    ->name('admin.recomendaciones.update')
    ->middleware('auth');
Route::get('/recomendaciones/confirm_delete/{id}', [App\Http\Controllers\RecomendacionController::class, 'confirm_delete'])
    ->name('admin.recomendaciones.confirm_delete')
    ->middleware('auth');
Route::delete('/recomendaciones/delete/{id}', [App\Http\Controllers\RecomendacionController::class, 'destroy'])
    ->name('admin.recomendaciones.destroy')
    ->middleware('auth');

// Clientes
Route::get('/clientes', [App\Http\Controllers\ClienteController::class, 'index'])
    ->name('admin.clientes.index')
    ->middleware('auth');
Route::get('/clientes/nuevo', [App\Http\Controllers\ClienteController::class, 'create'])
    ->name('admin.clientes.create')
    ->middleware('auth');
Route::post('/clientes/create', [App\Http\Controllers\ClienteController::class, 'store'])
    ->name('admin.clientes.store')
    ->middleware('auth');
Route::get('/clientes/edit/{id}', [App\Http\Controllers\ClienteController::class, 'edit'])
    ->name('admin.clientes.edit')
    ->middleware('auth');
Route::put('/clientes/edit/{id}', [App\Http\Controllers\ClienteController::class, 'update'])
    ->name('admin.clientes.update')
    ->middleware('auth');
Route::get('/clientes/confirm_delete/{id}', [App\Http\Controllers\ClienteController::class, 'confirm_delete'])
    ->name('admin.clientes.confirm_delete')
    ->middleware('auth');
Route::delete('/clientes/delete/{id}', [App\Http\Controllers\ClienteController::class, 'destroy'])
    ->name('admin.clientes.destroy')
    ->middleware('auth');

Route::get('/clientes/measures/{id}', [App\Http\Controllers\ClienteController::class, 'getMeasures'])
    ->name('admin.clientes.measures')
    ->middleware('auth');

// Tipos de aplicacion
Route::get('/tipos_aplicacion', [App\Http\Controllers\ApplicationTypesController::class, 'index'])
    ->name('admin.tipos_aplicacion.index')
    ->middleware('auth');

Route::get('/tipos_aplicacion/nuevo', [App\Http\Controllers\ApplicationTypesController::class, 'create'])
    ->name('admin.tipos_aplicacion.create')
    ->middleware('auth');

Route::post('/tipos_aplicacion/guardar', [App\Http\Controllers\ApplicationTypesController::class, 'store'])
    ->name('admin.tipos_aplicacion.store')
    ->middleware('auth');

Route::get('/tipos_aplicacion/editar/{id}', [App\Http\Controllers\ApplicationTypesController::class, 'edit'])
    ->name('admin.tipos_aplicacion.edit')
    ->middleware('auth');

Route::put('/tipos_aplicacion/actualizar/{id}', [App\Http\Controllers\ApplicationTypesController::class, 'update'])
    ->name('admin.tipos_aplicacion.update')
    ->middleware('auth');

Route::get('/tipos_aplicacion/confirmar-eliminacion/{id}', [App\Http\Controllers\ApplicationTypesController::class, 'confirm_delete'])
    ->name('admin.tipos_aplicacion.confirm_delete')
    ->middleware('auth');

Route::delete('/tipos_aplicacion/eliminar/{id}', [App\Http\Controllers\ApplicationTypesController::class, 'destroy'])
    ->name('admin.tipos_aplicacion.destroy')
    ->middleware('auth');

// Búsqueda AJAX
Route::middleware(['auth'])->prefix('admin')->group(function () {
    Route::get('search/ajax', [App\Http\Controllers\SearchController::class, 'searchAjax'])
        ->name('admin.search.ajax');

    Route::get('search/autocomplete', [App\Http\Controllers\SearchController::class, 'autocomplete'])
        ->name('admin.search.autocomplete');
});





/*
|--------------------------------------------------------------------------
| RUTAS DE SISTEMA (CONFIGURACIÓN, LOGS, UNIDADES)
|--------------------------------------------------------------------------
*/

// Settings (Configuración del Sistema)
Route::get('admin/settings', [App\Http\Controllers\SystemSettingController::class, 'index'])
    ->name('admin.settings.index')
    ->middleware('auth');

Route::get('admin/settings/create', [App\Http\Controllers\SystemSettingController::class, 'create'])
    ->name('admin.settings.create')
    ->middleware('auth');

Route::post('admin/settings', [App\Http\Controllers\SystemSettingController::class, 'store'])
    ->name('admin.settings.store')
    ->middleware('auth');

// Actualización masiva de configuraciones (formulario principal)
Route::put('admin/settings', [App\Http\Controllers\SystemSettingController::class, 'update'])
    ->name('admin.settings.bulk-update')
    ->middleware('auth');

Route::get('admin/settings/{setting}', [App\Http\Controllers\SystemSettingController::class, 'show'])
    ->name('admin.settings.show')
    ->middleware('auth');

Route::get('admin/settings/{setting}/edit', [App\Http\Controllers\SystemSettingController::class, 'edit'])
    ->name('admin.settings.edit')
    ->middleware('auth');

Route::put('admin/settings/{setting}', [App\Http\Controllers\SystemSettingController::class, 'update'])
    ->name('admin.settings.update')
    ->middleware('auth');

Route::delete('admin/settings/{setting}', [App\Http\Controllers\SystemSettingController::class, 'destroy'])
    ->name('admin.settings.destroy')
    ->middleware('auth');

// Activity Logs (Registro de Actividad)
Route::get('admin/activity-logs', [App\Http\Controllers\ActivityLogController::class, 'index'])
    ->name('admin.activity-logs.index')
    ->middleware('auth');

Route::get('admin/activity-logs/{uuid}', [App\Http\Controllers\ActivityLogController::class, 'show'])
    ->name('admin.activity-logs.show')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| Unidades de Medida
|--------------------------------------------------------------------------
| Rutas para la gestión completa de unidades de medida del sistema.
| Incluye CRUD completo, cambio de estado, restauración y eliminación permanente.
|--------------------------------------------------------------------------
*/
/*
|--------------------------------------------------------------------------
| RUTAS DE UNIDADES DE MEDIDA
|--------------------------------------------------------------------------
*/

Route::get('admin/units', [App\Http\Controllers\UnitController::class, 'index'])
    ->name('admin.units.index')
    ->middleware('auth');

Route::get('admin/units/create', [App\Http\Controllers\UnitController::class, 'create'])
    ->name('admin.units.create')
    ->middleware('auth');

Route::post('admin/units', [App\Http\Controllers\UnitController::class, 'store'])
    ->name('admin.units.store')
    ->middleware('auth');

Route::get('admin/units/{id}/edit', [App\Http\Controllers\UnitController::class, 'edit'])
    ->name('admin.units.edit')
    ->middleware('auth');

Route::put('admin/units/{id}', [App\Http\Controllers\UnitController::class, 'update'])
    ->name('admin.units.update')
    ->middleware('auth');

Route::get('admin/units/{id}/confirm-delete', [App\Http\Controllers\UnitController::class, 'confirmDelete'])
    ->name('admin.units.confirm_delete')
    ->middleware('auth');

Route::delete('admin/units/{id}', [App\Http\Controllers\UnitController::class, 'destroy'])
    ->name('admin.units.destroy')
    ->middleware('auth');



/*
|--------------------------------------------------------------------------
| RUTAS DE CATEGORÍAS DE MATERIALES
|--------------------------------------------------------------------------
*/

Route::get('admin/material-categories', [App\Http\Controllers\MaterialCategoryController::class, 'index'])
    ->name('admin.material-categories.index')
    ->middleware('auth');

Route::get('admin/material-categories/create', [App\Http\Controllers\MaterialCategoryController::class, 'create'])
    ->name('admin.material-categories.create')
    ->middleware('auth');

Route::post('admin/material-categories', [App\Http\Controllers\MaterialCategoryController::class, 'store'])
    ->name('admin.material-categories.store')
    ->middleware('auth');

Route::get('admin/material-categories/{id}/edit', [App\Http\Controllers\MaterialCategoryController::class, 'edit'])
    ->name('admin.material-categories.edit')
    ->middleware('auth');

Route::put('admin/material-categories/{id}', [App\Http\Controllers\MaterialCategoryController::class, 'update'])
    ->name('admin.material-categories.update')
    ->middleware('auth');

Route::get('admin/material-categories/{id}/confirm-delete', [App\Http\Controllers\MaterialCategoryController::class, 'confirmDelete'])
    ->name('admin.material-categories.confirm_delete')
    ->middleware('auth');

Route::delete('admin/material-categories/{id}', [App\Http\Controllers\MaterialCategoryController::class, 'destroy'])
    ->name('admin.material-categories.destroy')
    ->middleware('auth');

Route::get('admin/material-categories/{id}/get-materials', [App\Http\Controllers\MaterialCategoryController::class, 'getMaterials'])
    ->name('admin.material-categories.get-materials')
    ->middleware('auth');

Route::get('admin/material-categories/{id}/get-units', [App\Http\Controllers\MaterialCategoryController::class, 'getUnits'])
    ->name('admin.material-categories.get-units')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE GESTIÓN: CATEGORÍA ↔ UNIDADES PERMITIDAS
|--------------------------------------------------------------------------
| Módulo administrativo para configurar qué unidades de compra están
| permitidas para cada categoría de material.
|--------------------------------------------------------------------------
*/

Route::get('admin/material-categories/units', [App\Http\Controllers\MaterialCategoryUnitController::class, 'index'])
    ->name('admin.material-category-units.index')
    ->middleware('auth');

Route::post('admin/material-categories/{categoryId}/units', [App\Http\Controllers\MaterialCategoryUnitController::class, 'store'])
    ->name('admin.material-category-units.store')
    ->middleware('auth');

Route::delete('admin/material-categories/{categoryId}/units/{unitId}', [App\Http\Controllers\MaterialCategoryUnitController::class, 'destroy'])
    ->name('admin.material-category-units.destroy')
    ->middleware('auth');

Route::get('admin/material-categories/{categoryId}/assigned-units', [App\Http\Controllers\MaterialCategoryUnitController::class, 'getAssignedUnits'])
    ->name('admin.material-category-units.assigned')
    ->middleware('auth');

Route::get('admin/material-categories/{categoryId}/available-units', [App\Http\Controllers\MaterialCategoryUnitController::class, 'getAvailableUnits'])
    ->name('admin.material-category-units.available')
    ->middleware('auth');

Route::get('admin/material-categories/{categoryId}/check-integrity', [App\Http\Controllers\MaterialCategoryUnitController::class, 'checkIntegrity'])
    ->name('admin.material-category-units.check-integrity')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE MATERIALES
|--------------------------------------------------------------------------
*/

Route::get('admin/materials', [App\Http\Controllers\MaterialController::class, 'index'])
    ->name('admin.materials.index')
    ->middleware('auth');

Route::get('admin/materials/create', [App\Http\Controllers\MaterialController::class, 'create'])
    ->name('admin.materials.create')
    ->middleware('auth');

Route::post('admin/materials', [App\Http\Controllers\MaterialController::class, 'store'])
    ->name('admin.materials.store')
    ->middleware('auth');

Route::get('admin/materials/{id}/edit', [App\Http\Controllers\MaterialController::class, 'edit'])
    ->name('admin.materials.edit')
    ->middleware('auth');

Route::put('admin/materials/{id}', [App\Http\Controllers\MaterialController::class, 'update'])
    ->name('admin.materials.update')
    ->middleware('auth');

Route::get('admin/materials/{id}/confirm-delete', [App\Http\Controllers\MaterialController::class, 'confirmDelete'])
    ->name('admin.materials.confirm_delete')
    ->middleware('auth');

Route::delete('admin/materials/{id}', [App\Http\Controllers\MaterialController::class, 'destroy'])
    ->name('admin.materials.destroy')
    ->middleware('auth');

Route::get('admin/materials/category/{categoryId}', [App\Http\Controllers\MaterialController::class, 'getByCategory'])
    ->name('admin.materials.by-category')
    ->middleware('auth');

Route::post('admin/products/validate-prices', [App\Http\Controllers\ProductController::class, 'validateMaterialPrices'])
    ->name('admin.products.validate-prices')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE VARIANTES DE MATERIALES
|--------------------------------------------------------------------------
*/

Route::get('admin/materials/{materialId}/variants', [App\Http\Controllers\MaterialVariantController::class, 'index'])
    ->name('admin.material-variants.index')
    ->middleware('auth');

Route::get('admin/materials/{materialId}/variants/create', [App\Http\Controllers\MaterialVariantController::class, 'create'])
    ->name('admin.material-variants.create')
    ->middleware('auth');

Route::post('admin/materials/{materialId}/variants', [App\Http\Controllers\MaterialVariantController::class, 'store'])
    ->name('admin.material-variants.store')
    ->middleware('auth');

Route::get('admin/materials/{materialId}/variants/{id}/edit', [App\Http\Controllers\MaterialVariantController::class, 'edit'])
    ->name('admin.material-variants.edit')
    ->middleware('auth');

Route::put('admin/materials/{materialId}/variants/{id}', [App\Http\Controllers\MaterialVariantController::class, 'update'])
    ->name('admin.material-variants.update')
    ->middleware('auth');

Route::get('admin/materials/{materialId}/variants/{id}/confirm-delete', [App\Http\Controllers\MaterialVariantController::class, 'confirmDelete'])
    ->name('admin.material-variants.confirm_delete')
    ->middleware('auth');

Route::delete('admin/materials/{materialId}/variants/{id}', [App\Http\Controllers\MaterialVariantController::class, 'destroy'])
    ->name('admin.material-variants.destroy')
    ->middleware('auth');

//ajax
Route::get('admin/materials/{materialId}/variants-json', [App\Http\Controllers\MaterialVariantController::class, 'getByMaterial'])
    ->name('admin.material-variants.by-material')
    ->middleware('auth');

Route::get('admin/materials/{materialId}/variants-with-conversions', [App\Http\Controllers\MaterialVariantController::class, 'getByMaterial2'])
    ->name('admin.material-variants.conversiones')
    ->middleware('auth');
/*
|--------------------------------------------------------------------------
| RUTAS DE CONVERSIONES DE UNIDADES POR MATERIAL
|--------------------------------------------------------------------------
*/

Route::get('admin/materials/{materialId}/conversions', [App\Http\Controllers\MaterialUnitConversionController::class, 'index'])
    ->name('admin.material-conversions.index')
    ->middleware('auth');

Route::get('admin/materials/{materialId}/conversions/create', [App\Http\Controllers\MaterialUnitConversionController::class, 'create'])
    ->name('admin.material-conversions.create')
    ->middleware('auth');

Route::post('admin/materials/{materialId}/conversions', [App\Http\Controllers\MaterialUnitConversionController::class, 'store'])
    ->name('admin.material-conversions.store')
    ->middleware('auth');

Route::get('admin/materials/{materialId}/conversions/{id}/edit', [App\Http\Controllers\MaterialUnitConversionController::class, 'edit'])
    ->name('admin.material-conversions.edit')
    ->middleware('auth');

Route::put('admin/materials/{materialId}/conversions/{id}', [App\Http\Controllers\MaterialUnitConversionController::class, 'update'])
    ->name('admin.material-conversions.update')
    ->middleware('auth');

Route::get('admin/materials/{materialId}/conversions/{id}/confirm-delete', [App\Http\Controllers\MaterialUnitConversionController::class, 'confirmDelete'])
    ->name('admin.material-conversions.confirm_delete')
    ->middleware('auth');

Route::delete('admin/materials/{materialId}/conversions/{id}', [App\Http\Controllers\MaterialUnitConversionController::class, 'destroy'])
    ->name('admin.material-conversions.destroy')
    ->middleware('auth');

Route::get('admin/materials/{materialId}/conversion-factor/{fromUnitId}', [App\Http\Controllers\MaterialUnitConversionController::class, 'getConversionFactor'])
    ->name('admin.material-conversions.factor')
    ->middleware('auth');

/*
|--------------------------------------------------------------------------
| RUTAS DE COMPRAS (PURCHASES) - FORMATO EXPLÍCITO
|--------------------------------------------------------------------------
*/

// Listado
Route::get('admin/purchases', [App\Http\Controllers\PurchaseController::class, 'index'])
    ->middleware('auth')
    ->name('admin.purchases.index');

// Crear
Route::get('admin/purchases/create', [App\Http\Controllers\PurchaseController::class, 'create'])
    ->middleware('auth')
    ->name('admin.purchases.create');

Route::post('admin/purchases', [App\Http\Controllers\PurchaseController::class, 'store'])
    ->middleware('auth')
    ->name('admin.purchases.store');

// Ver detalle
Route::get('admin/purchases/{id}', [App\Http\Controllers\PurchaseController::class, 'show'])
    ->middleware('auth')
    ->name('admin.purchases.show')
    ->where('id', '[0-9]+');

// Editar
Route::get('admin/purchases/{id}/edit', [App\Http\Controllers\PurchaseController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.purchases.edit')
    ->where('id', '[0-9]+');

Route::put('admin/purchases/{id}', [App\Http\Controllers\PurchaseController::class, 'update'])
    ->middleware('auth')
    ->name('admin.purchases.update')
    ->where('id', '[0-9]+');

// Confirmar (Borrador → Pendiente)
Route::post('admin/purchases/{id}/confirm', [App\Http\Controllers\PurchaseController::class, 'confirm'])
    ->middleware('auth')
    ->name('admin.purchases.confirm')
    ->where('id', '[0-9]+');

// Confirmar y Recibir en un solo paso (Borrador → Recibido)
Route::post('admin/purchases/{id}/confirm-and-receive', [App\Http\Controllers\PurchaseController::class, 'confirmAndReceive'])
    ->middleware('auth')
    ->name('admin.purchases.confirm_and_receive')
    ->where('id', '[0-9]+');

// Recibir mercancía
Route::get('admin/purchases/{id}/receive', [App\Http\Controllers\PurchaseController::class, 'showReceive'])
    ->middleware('auth')
    ->name('admin.purchases.receive')
    ->where('id', '[0-9]+');

Route::post('admin/purchases/{id}/receive', [App\Http\Controllers\PurchaseController::class, 'receive'])
    ->middleware('auth')
    ->name('admin.purchases.receive.store')
    ->where('id', '[0-9]+');

// Cancelar
Route::get('admin/purchases/{id}/cancel', [App\Http\Controllers\PurchaseController::class, 'showCancel'])
    ->middleware('auth')
    ->name('admin.purchases.cancel')
    ->where('id', '[0-9]+');

Route::post('admin/purchases/{id}/cancel', [App\Http\Controllers\PurchaseController::class, 'cancel'])
    ->middleware('auth')
    ->name('admin.purchases.cancel.store')
    ->where('id', '[0-9]+');

// Eliminar (solo borradores)
Route::get('admin/purchases/{id}/confirm-delete', [App\Http\Controllers\PurchaseController::class, 'confirmDelete'])
    ->middleware('auth')
    ->name('admin.purchases.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('admin/purchases/{id}', [App\Http\Controllers\PurchaseController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.purchases.destroy')
    ->where('id', '[0-9]+');

// AJAX Endpoints
Route::get('admin/purchases/ajax/materials/{categoryId}', [App\Http\Controllers\PurchaseController::class, 'getMaterialsByCategory'])
    ->middleware('auth')
    ->name('admin.purchases.ajax.materials')
    ->where('categoryId', '[0-9]+');

Route::get('admin/purchases/ajax/variants/{materialId}', [App\Http\Controllers\PurchaseController::class, 'getVariantsByMaterial'])
    ->middleware('auth')
    ->name('admin.purchases.ajax.variants')
    ->where('materialId', '[0-9]+');

Route::get('admin/purchases/ajax/units/{materialId}', [App\Http\Controllers\PurchaseController::class, 'getUnitsForMaterial'])
    ->middleware('auth')
    ->name('admin.purchases.ajax.units')
    ->where('materialId', '[0-9]+');

// Anular recepción
Route::post('admin/purchases/{id}/receptions/{receptionId}/void', [App\Http\Controllers\PurchaseController::class, 'voidReception'])
    ->middleware('auth')
    ->name('admin.purchases.receptions.void')
    ->where(['id' => '[0-9]+', 'receptionId' => '[0-9]+']);

// Recalcular estado de compra
Route::post('purchases/{id}/recalculate-status', [App\Http\Controllers\PurchaseController::class, 'recalculateStatus'])
    ->middleware('auth')
    ->name('admin.purchases.recalculate')
    ->where('id', '[0-9]+');



/*
|--------------------------------------------------------------------------
| RUTAS DE PRODUCTOS
|--------------------------------------------------------------------------
*/

Route::prefix('admin/products')->name('admin.products.')->middleware('auth')->group(function () {
    // Listado principal
    Route::get('/', [App\Http\Controllers\ProductController::class, 'index'])->name('index');

    // Crear producto
    Route::get('create', [App\Http\Controllers\ProductController::class, 'create'])->name('create');
    Route::post('/', [App\Http\Controllers\ProductController::class, 'store'])->name('store');

    // Ver detalle
    Route::get('{product}', [App\Http\Controllers\ProductController::class, 'show'])->name('show');

    // Editar producto
    Route::get('{product}/edit', [App\Http\Controllers\ProductController::class, 'edit'])->name('edit');
    Route::put('{product}', [App\Http\Controllers\ProductController::class, 'update'])->name('update');

    // Eliminar producto
    Route::get('{product}/confirm-delete', [App\Http\Controllers\ProductController::class, 'confirmDelete'])->name('confirm_delete');
    Route::delete('{product}', [App\Http\Controllers\ProductController::class, 'destroy'])->name('destroy');

    // Operaciones adicionales
    Route::post('{product}/duplicate', [App\Http\Controllers\ProductController::class, 'duplicate'])->name('duplicate');
    Route::post('{product}/toggle-status', [App\Http\Controllers\ProductController::class, 'toggleStatus'])->name('toggle_status');

    // Variantes de Producto (Sub-rutas)
    Route::prefix('{product}/variants')->name('variants.')->group(function () {
        Route::get('create', [App\Http\Controllers\ProductController::class, 'createVariant'])->name('create');
        Route::post('/', [App\Http\Controllers\ProductController::class, 'storeVariant'])->name('store');
        Route::get('{variant}/edit', [App\Http\Controllers\ProductController::class, 'editVariant'])->name('edit');
        Route::put('{variant}', [App\Http\Controllers\ProductController::class, 'updateVariant'])->name('update');
        Route::delete('{variant}', [App\Http\Controllers\ProductController::class, 'destroyVariant'])->name('destroy');
    });

    // AJAX Endpoints
    Route::prefix('ajax')->name('ajax.')->group(function () {
        Route::get('designs-by-category/{categoryId}', [App\Http\Controllers\ProductController::class, 'getDesignsByCategory'])->name('designs');
        Route::get('design-exports/{designId}', [App\Http\Controllers\ProductController::class, 'getDesignExports'])->name('exports');
        Route::get('attributes', [App\Http\Controllers\ProductController::class, 'getAttributes'])->name('attributes');
        Route::get('search-materials', [App\Http\Controllers\ProductController::class, 'searchMaterials'])->name('search_materials');
    });
});


/*
|--------------------------------------------------------------------------
| RUTAS DE ATRIBUTOS
|--------------------------------------------------------------------------
*/

Route::get('attributes', [App\Http\Controllers\AttributeController::class, 'index'])
    ->middleware('auth')
    ->name('admin.attributes.index');

Route::get('attributes/create', [App\Http\Controllers\AttributeController::class, 'create'])
    ->middleware('auth')
    ->name('admin.attributes.create');

Route::post('attributes', [App\Http\Controllers\AttributeController::class, 'store'])
    ->middleware('auth')
    ->name('admin.attributes.store');

Route::get('attributes/{id}/edit', [App\Http\Controllers\AttributeController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.attributes.edit')
    ->where('id', '[0-9]+');

Route::put('attributes/{id}', [App\Http\Controllers\AttributeController::class, 'update'])
    ->middleware('auth')
    ->name('admin.attributes.update')
    ->where('id', '[0-9]+');

Route::get('attributes/{id}/confirm-delete', [App\Http\Controllers\AttributeController::class, 'confirm_delete'])
    ->middleware('auth')
    ->name('admin.attributes.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('attributes/{id}', [App\Http\Controllers\AttributeController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.attributes.destroy')
    ->where('id', '[0-9]+');

/*
|--------------------------------------------------------------------------
| RUTAS DE VALORES DE ATRIBUTOS
|--------------------------------------------------------------------------
*/

Route::get('attribute-values', [App\Http\Controllers\AttributeValueController::class, 'index'])
    ->middleware('auth')
    ->name('admin.attribute-values.index');

Route::get('attribute-values/create', [App\Http\Controllers\AttributeValueController::class, 'create'])
    ->middleware('auth')
    ->name('admin.attribute-values.create');

Route::post('attribute-values', [App\Http\Controllers\AttributeValueController::class, 'store'])
    ->middleware('auth')
    ->name('admin.attribute-values.store');

Route::get('attribute-values/{id}/edit', [App\Http\Controllers\AttributeValueController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.attribute-values.edit')
    ->where('id', '[0-9]+');

Route::put('attribute-values/{id}', [App\Http\Controllers\AttributeValueController::class, 'update'])
    ->middleware('auth')
    ->name('admin.attribute-values.update')
    ->where('id', '[0-9]+');

Route::get('attribute-values/{id}/confirm-delete', [App\Http\Controllers\AttributeValueController::class, 'confirm_delete'])
    ->middleware('auth')
    ->name('admin.attribute-values.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('attribute-values/{id}', [App\Http\Controllers\AttributeValueController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.attribute-values.destroy')
    ->where('id', '[0-9]+');

// AJAX endpoint para obtener tipo de atributo (para color picker dinámico)
Route::get('attribute-values/get-type/{attributeId}', [App\Http\Controllers\AttributeValueController::class, 'getAttributeType'])
    ->middleware('auth')
    ->name('admin.attribute-values.get-type')
    ->where('attributeId', '[0-9]+');

/*
|--------------------------------------------------------------------------
| RUTAS DE CATEGORÍAS DE PRODUCTOS (PRODUCT CATEGORIES)
|--------------------------------------------------------------------------
*/

Route::get('admin/product-categories', [App\Http\Controllers\ProductCategoryController::class, 'index'])
    ->middleware('auth')
    ->name('admin.product_categories.index');

Route::get('admin/product-categories/create', [App\Http\Controllers\ProductCategoryController::class, 'create'])
    ->middleware('auth')
    ->name('admin.product_categories.create');

Route::post('admin/product-categories', [App\Http\Controllers\ProductCategoryController::class, 'store'])
    ->middleware('auth')
    ->name('admin.product_categories.store');

Route::get('admin/product-categories/{id}', [App\Http\Controllers\ProductCategoryController::class, 'show'])
    ->middleware('auth')
    ->name('admin.product_categories.show')
    ->where('id', '[0-9]+');

Route::get('admin/product-categories/{id}/edit', [App\Http\Controllers\ProductCategoryController::class, 'edit'])
    ->middleware('auth')
    ->name('admin.product_categories.edit')
    ->where('id', '[0-9]+');

Route::put('admin/product-categories/{id}', [App\Http\Controllers\ProductCategoryController::class, 'update'])
    ->middleware('auth')
    ->name('admin.product_categories.update')
    ->where('id', '[0-9]+');

Route::get('admin/product-categories/{id}/confirm-delete', [App\Http\Controllers\ProductCategoryController::class, 'confirmDelete'])
    ->middleware('auth')
    ->name('admin.product_categories.confirm_delete')
    ->where('id', '[0-9]+');

Route::delete('admin/product-categories/{id}', [App\Http\Controllers\ProductCategoryController::class, 'destroy'])
    ->middleware('auth')
    ->name('admin.product_categories.destroy')
    ->where('id', '[0-9]+');

/*
|--------------------------------------------------------------------------
| RUTAS DE EXTRAS DE PRODUCTOS (PRODUCT EXTRAS)
|--------------------------------------------------------------------------
*/

Route::get('/product_extras', [App\Http\Controllers\ProductExtraController::class, 'index'])
    ->name('admin.product_extras.index')
    ->middleware('auth');

Route::get('/product_extras/nuevo', [App\Http\Controllers\ProductExtraController::class, 'create'])
    ->name('admin.product_extras.create')
    ->middleware('auth');

Route::post('/product_extras/create', [App\Http\Controllers\ProductExtraController::class, 'store'])
    ->name('admin.product_extras.store')
    ->middleware('auth');

Route::get('/product_extras/edit/{id}', [App\Http\Controllers\ProductExtraController::class, 'edit'])
    ->name('admin.product_extras.edit')
    ->middleware('auth');

Route::put('/product_extras/edit/{id}', [App\Http\Controllers\ProductExtraController::class, 'update'])
    ->name('admin.product_extras.update')
    ->middleware('auth');

Route::get('/product_extras/confirm_delete/{id}', [App\Http\Controllers\ProductExtraController::class, 'confirm_delete'])
    ->name('admin.product_extras.confirm_delete')
    ->middleware('auth');

Route::delete('/product_extras/delete/{id}', [App\Http\Controllers\ProductExtraController::class, 'destroy'])
    ->name('admin.product_extras.destroy')
    ->middleware('auth');
</file>

</files>
